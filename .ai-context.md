# Worktree Context: Story 21.5.1.1

## Active Story
- **ID**: 21.5.1.1
- **Title**: 修复前端canvas_name参数构建
- **Epic**: EPIC-21.5.1 - API参数格式修复与安全检查优化
- **Priority**: P0 (Critical)
- **Status**: Validated (PO Approved)

## Story Summary

修复 Obsidian 插件中的 canvas_name 参数构建错误。当前插件发送完整文件路径（如 `"笔记库/子目录/test.canvas"`）作为 canvas_name，导致后端路径遍历检查失败。

**解决方案**: 创建 `extractCanvasFileName()` 辅助函数，从完整路径中提取文件名。

## Complete Workflow (Dev + QA)

### Phase 1: Development
1. `/dev` - Activate Developer Agent
2. `*develop-story 21.5.1.1` - Implement the Story
3. `*run-tests` - Run all tests

### Phase 2: Quality Review
4. `/qa` - Activate QA Agent
5. `*review 21.5.1.1` - Code review
6. `*gate 21.5.1.1` - Quality gate decision

### Phase 3: Ready to Merge
7. If gate = PASS, Story is ready
8. Return to main repo and run `*merge 21.5.1.1`

## Story Location
`docs/stories/21.5.1.1.story.md`

## Files to Modify
- `canvas-progress-tracker/obsidian-plugin/main.ts` (9 locations)
  - Line 300: executeDecomposition
  - Line 320: executeOralExplanation
  - Line 340: executeFourLevelExplanation
  - Line 359: executeScoring
  - Line 430: executeDeepDecomposition
  - Line 450: executeClarificationPath
  - Line 470: executeExampleTeaching
  - Line 490: executeMemoryAnchor
  - Line 511: generateVerificationQuestions

## Files to Create
- `canvas-progress-tracker/obsidian-plugin/tests/utils/extractCanvasFileName.test.ts`

## Helper Function Implementation
```typescript
/**
 * Extract Canvas filename from complete file path
 * Supports both Unix (/) and Windows (\) path separators
 */
private extractCanvasFileName(filePath: string | undefined): string {
    if (!filePath) return '';
    return filePath.split(/[/\\]/).pop() || '';
}
```

## Test Cases Required
1. `undefined` input -> `""`
2. `""` (empty string) -> `""`
3. `"test.canvas"` (pure filename) -> `"test.canvas"`
4. `"笔记库/子目录/test.canvas"` (Unix path) -> `"test.canvas"`
5. `"笔记库\\子目录\\test.canvas"` (Windows path) -> `"test.canvas"`
6. `"a/b/c/d/e.canvas"` (deep path) -> `"e.canvas"`
7. `"a/b\\c/d.canvas"` (mixed separators) -> `"d.canvas"`

## Testing Framework
- **Framework**: Jest (NOT Vitest)
- **Config**: `jest.config.js`
- **Run command**: `npm test`
- **Coverage threshold**: 80%

## Important
- Complete BOTH Dev and QA before marking ready
- Update .worktree-status.yaml after each phase
- Test framework is Jest, NOT Vitest

## Automation Mode
If launched via `parallel-develop-auto.ps1`, this session runs in non-interactive mode.
The prompt will guide you through the complete Dev+QA workflow automatically.
Output is logged to: dev-qa-output.log
