# Worktree Context: Story 21.5.1.2

## Active Story
- **ID**: 21.5.1.2
- **Title**: 优化后端Path Traversal安全检查
- **Epic**: EPIC-21.5.1 - API参数格式修复与安全检查优化
- **Priority**: P1
- **Status**: Draft

## Story Summary

优化后端 `_validate_canvas_name()` 方法中的路径遍历安全检查。当前实现完全阻止 `/` 字符，导致合法的子目录路径（如 `"笔记库/子目录/test"`）被拒绝。

**解决方案**: 修改验证逻辑，允许 `/` 用于子目录，但仍然阻止危险模式（`..`, `\0`, `\\`, `//`, `/./`, 绝对路径）。

## Complete Workflow (Dev + QA)

### Phase 1: Development
1. `/dev` - Activate Developer Agent
2. `*develop-story 21.5.1.2` - Implement the Story
3. `*run-tests` - Run all tests

### Phase 2: Quality Review
4. `/qa` - Activate QA Agent
5. `*review 21.5.1.2` - Code review
6. `*gate 21.5.1.2` - Quality gate decision

### Phase 3: Ready to Merge
7. If gate = PASS, Story is ready
8. Return to main repo and run `*merge 21.5.1.2`

## Story Location
`docs/stories/21.5.1.2.story.md`

## Files to Modify
- `backend/app/services/canvas_service.py` (lines 49-62)
  - Method: `_validate_canvas_name()`
  - Remove `/` from dangerous_patterns
  - Add new patterns: `..`, `\0`, `\\`, `//`, `/./`
  - Add check for absolute paths (startswith `/`)

## Files to Create
- `backend/tests/unit/test_canvas_validation.py`

## Current Implementation (lines 49-62)
```python
def _validate_canvas_name(self, canvas_name: str) -> None:
    """Validate canvas name to prevent path traversal attacks."""
    dangerous_patterns = ['..', '/', '\\', '\0']  # <- '/' must be removed
    for pattern in dangerous_patterns:
        if pattern in canvas_name:
            raise ValidationError(f"Path traversal detected in canvas name: {canvas_name}")
```

## Required Changes
```python
def _validate_canvas_name(self, canvas_name: str) -> None:
    """
    Validate canvas name to prevent path traversal attacks.
    Allows subdirectory paths (/) but blocks dangerous patterns.
    """
    # Block absolute paths
    if canvas_name.startswith('/'):
        raise ValidationError(f"Absolute path not allowed: {canvas_name}")

    # Block dangerous patterns
    dangerous_patterns = ['..', '\\', '\0', '//', '/./']
    for pattern in dangerous_patterns:
        if pattern in canvas_name:
            raise ValidationError(f"Invalid canvas path: {canvas_name}")
```

## Test Cases Required

### Valid Paths (should NOT raise)
1. `"test"` - simple filename
2. `"test.canvas"` - filename with extension
3. `"笔记库/子目录/test"` - subdirectory path (Chinese)
4. `"学习/数学/离散数学"` - deep Chinese path
5. `"a/b/c/d/e/file"` - deep ASCII path

### Invalid Paths (should raise ValidationError)
1. `"../../../etc/passwd"` - directory traversal
2. `"test/../secret"` - embedded traversal
3. `"test\0.canvas"` - null byte injection
4. `"test\\file"` - backslash (Windows path)
5. `"test//file"` - double slash
6. `"test/./file"` - current directory reference
7. `"/etc/passwd"` - absolute path

## Testing Framework
- **Framework**: pytest
- **Async support**: pytest-asyncio
- **Run command**: `pytest backend/tests/ -v`

## Important
- Complete BOTH Dev and QA before marking ready
- Update .worktree-status.yaml after each phase
- Ensure security check still blocks real attacks

## Automation Mode
If launched via `parallel-develop-auto.ps1`, this session runs in non-interactive mode.
The prompt will guide you through the complete Dev+QA workflow automatically.
Output is logged to: dev-qa-output.log
