# ATDD Checklist - EPIC-38, Story 38.5: Canvas CRUD Graceful Degradation

**Date:** 2026-02-06
**Author:** ROG
**Primary Test Level:** Unit

---

## Story Summary

Canvas CRUD events should gracefully degrade to JSON fallback when memory system is unavailable.

**As a** learner
**I want** my Canvas editing actions recorded even when Neo4j is unavailable
**So that** my knowledge graph is eventually complete regardless of infrastructure status

---

## Acceptance Criteria

1. **AC-1 (D5: Degradation):** Memory client None → JSON fallback write + CRUD succeeds + WARNING log
2. **AC-2 (D5: Degradation):** Neo4j down → JSON fallback write + WARNING log
3. **AC-3 (D5: Degradation):** Health visibility — track degraded state
4. **AC-4 (D2: Resilience):** Log level upgrade from DEBUG to WARNING

---

## Failing Tests Created (RED Phase)

### Unit Tests (8 tests)

**File:** `backend/tests/unit/test_story_38_5_canvas_crud_degradation.py`

#### AC-1: Memory Client None → JSON Fallback

| Test | Status | Priority | Verifies |
|------|--------|----------|----------|
| `TestAC1::test_trigger_event_writes_json_when_memory_client_none` | XFAIL | P0 | JSON fallback write |
| `TestAC1::test_no_fallback_file_when_dual_write_disabled` | PASSED | P1 | Negative case |
| `TestAC1::test_crud_add_node_succeeds_when_memory_client_none` | PASSED | P0 | CRUD non-blocking |

#### AC-2: Neo4j Down → JSON Fallback

| Test | Status | Priority | Verifies |
|------|--------|----------|----------|
| `TestAC2::test_edge_sync_writes_json_when_neo4j_none` | XFAIL | P0 | Edge sync fallback |
| `TestAC2::test_trigger_event_fallback_when_record_temporal_raises` | XFAIL | P0 | Error → fallback |

#### AC-3: Health Visibility

| Test | Status | Priority | Verifies |
|------|--------|----------|----------|
| `TestAC3::test_canvas_service_tracks_fallback_active_state` | XFAIL | P1 | Degraded tracking |

#### AC-4: Log Level Upgrade

| Test | Status | Priority | Verifies |
|------|--------|----------|----------|
| `TestAC4::test_memory_client_none_emits_warning` | XFAIL | P0 | WARNING log |
| `TestAC4::test_neo4j_none_emits_warning_in_edge_sync` | XFAIL | P0 | WARNING log |

---

## Test Execution Evidence (RED Phase)

```
2 passed, 6 xfailed in 11.10s
```

---

## Implementation Checklist (GREEN Phase)

### Task 1: JSON Fallback Writer (AC-1, AC-2)
- [ ] Add `_write_canvas_event_fallback()` method to CanvasService
- [ ] Fallback writes to `backend/data/canvas_events_fallback.json`
- [ ] Event format: `{event_type, canvas_name, node_id, edge_id, timestamp}`

### Task 2: Modify _trigger_memory_event (AC-1, AC-4)
- [ ] When memory_client is None AND dual-write enabled → call fallback writer
- [ ] Upgrade `logger.debug` → `logger.warning` at L174

### Task 3: Modify _sync_edge_to_neo4j (AC-2, AC-4)
- [ ] When neo4j is None AND dual-write enabled → call fallback writer
- [ ] Upgrade `logger.debug` → `logger.warning` at L279, L285

### Task 4: Error Path Fallback (AC-2)
- [ ] In `_write_memory_event`, catch Neo4j errors → write to fallback

### Task 5: Degraded State Tracking (AC-3)
- [ ] Add `_fallback_count` counter to CanvasService
- [ ] Add `is_fallback_active` property

### Task 6: Remove xfail markers (Refactor)
- [ ] Remove all `@pytest.mark.xfail` from 6 tests
- [ ] All 8 tests pass

---

**Generated by BMad TEA Agent** - 2026-02-06
