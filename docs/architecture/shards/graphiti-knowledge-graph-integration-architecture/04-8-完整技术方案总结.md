# GRAPHITI-KNOWLEDGE-GRAPH-INTEGRATION-ARCHITECTURE - Part 4

**Source**: `GRAPHITI-KNOWLEDGE-GRAPH-INTEGRATION-ARCHITECTURE.md`
**Sections**: ğŸ 8. å®Œæ•´æŠ€æœ¯æ–¹æ¡ˆæ€»ç»“, ğŸ“š 9. å®æ–½è·¯çº¿å›¾

---

## ğŸ 8. å®Œæ•´æŠ€æœ¯æ–¹æ¡ˆæ€»ç»“

### 8.1 ç³»ç»Ÿæ¶æ„æ¦‚è§ˆ

åŸºäºGraphitiçš„Canvaså­¦ä¹ ç³»ç»ŸçŸ¥è¯†å›¾è°±é›†æˆåŒ…å«ä»¥ä¸‹æ ¸å¿ƒç»„ä»¶ï¼š

**å››å±‚æ¶æ„**:
1. **Layer 1**: CanvasJSONOperator - åŸå­åŒ–Canvasæ–‡ä»¶è¯»å†™
2. **Layer 2**: CanvasBusinessLogic - ä¸šåŠ¡é€»è¾‘å’Œå¸ƒå±€ç®—æ³•
3. **Layer 3**: CanvasOrchestrator - é«˜çº§APIå’ŒSub-agentè°ƒç”¨
4. **Layer 4**: KnowledgeGraphLayer - GraphitiçŸ¥è¯†å›¾è°±é›†æˆ

**æ ¸å¿ƒåŠŸèƒ½æ¨¡å—**:
- çŸ¥è¯†å›¾è°±æ•°æ®æ¨¡å‹å’Œæ˜ å°„
- Canvasè®°å¿†ç³»ç»Ÿ
- æ™ºèƒ½æ£€ç´¢å’Œè¿½è¸ª
- æ—¶é—´æ„ŸçŸ¥å­¦ä¹ åˆ†æ
- æ€§èƒ½ä¼˜åŒ–ç­–ç•¥
- æ•°æ®è¿ç§»å·¥å…·

### 8.2 å…³é”®æŠ€æœ¯ç‰¹æ€§

**æŒä¹…åŒ–è®°å¿†**:
- CanvasèŠ‚ç‚¹å’Œè¾¹çš„é€»è¾‘å…³ç³»æ°¸ä¹…å­˜å‚¨
- å­¦ä¹ è¿›åº¦å’ŒçŠ¶æ€å˜åŒ–çš„å®Œæ•´è®°å½•
- è·¨æ—¶é—´çš„å­¦ä¹ æ¨¡å¼åˆ†æ

**æ™ºèƒ½æ£€ç´¢**:
- åŸºäºçŸ¥è¯†å›¾è°±çš„è¯­ä¹‰æœç´¢
- å­¦ä¹ ç“¶é¢ˆè‡ªåŠ¨è¯†åˆ«
- ä¸ªæ€§åŒ–æ£€éªŒç™½æ¿ç”Ÿæˆ

**æ—¶é—´æ„ŸçŸ¥**:
- å­¦ä¹ æ—¶é—´çº¿è¿½è¸ª
- çŸ¥è¯†æŒæ¡æ›²çº¿åˆ†æ
- é—å¿˜æ›²çº¿é¢„æµ‹å’Œå¤ä¹ è®¡åˆ’

**æ€§èƒ½ä¼˜åŒ–**:
- å¤šçº§ç¼“å­˜ç³»ç»Ÿ
- å¼‚æ­¥æ‰¹å¤„ç†æ“ä½œ
- è¿æ¥æ± ç®¡ç†
- å†…å­˜ä¼˜åŒ–ç­–ç•¥

### 8.3 å®æ–½ä»·å€¼

**å­¦ä¹ æ•ˆæœæå‡**:
- çŸ¥è¯†å…³è”è®°å¿†å¢å¼ºç†è§£æ·±åº¦
- ä¸ªæ€§åŒ–å¤ä¹ è®¡åˆ’æé«˜å­¦ä¹ æ•ˆç‡
- æ™ºèƒ½æ£€éªŒç™½æ¿ä¼˜åŒ–å¤ä¹ é’ˆå¯¹æ€§

**ç³»ç»Ÿæ™ºèƒ½åŒ–**:
- è‡ªåŠ¨å­¦ä¹ æ¨¡å¼è¯†åˆ«å’Œå»ºè®®
- çŸ¥è¯†æŒæ¡åº¦é¢„æµ‹å’Œé¢„è­¦
- è·¨CanvasçŸ¥è¯†å…³è”å‘ç°

**ç”¨æˆ·ä½“éªŒä¼˜åŒ–**:
- å®æ—¶å­¦ä¹ è¿›åº¦å¯è§†åŒ–
- æ™ºèƒ½å­¦ä¹ è·¯å¾„æ¨è
- æ— ç¼çš„çŸ¥è¯†æ£€ç´¢å’Œå›é¡¾

### 8.4 ä½¿ç”¨ç¤ºä¾‹

```python
# ç³»ç»Ÿåˆå§‹åŒ–
async def main():
    system = CanvasLearningSystemWithKG(
        neo4j_uri="bolt://localhost:7687",
        neo4j_user="neo4j",
        neo4j_password="password"
    )

    await system.initialize()

    try:
        # 1. åŒæ­¥Canvasåˆ°çŸ¥è¯†å›¾è°±
        sync_result = await system.process_canvas_operation(
            "./ç¬”è®°åº“/ç¦»æ•£æ•°å­¦/ç¦»æ•£æ•°å­¦.canvas", "sync_to_kg"
        )

        # 2. è¿½è¸ªå­¦ä¹ è¿›åº¦
        progress_result = await system.process_canvas_operation(
            "./ç¬”è®°åº“/ç¦»æ•£æ•°å­¦/ç¦»æ•£æ•°å­¦.canvas", "track_progress"
        )

        # 3. ç”Ÿæˆæ™ºèƒ½æ£€éªŒç™½æ¿
        review_result = await system.process_canvas_operation(
            "./ç¬”è®°åº“/ç¦»æ•£æ•°å­¦/ç¦»æ•£æ•°å­¦.canvas",
            "generate_review_board",
            strategy="adaptive"
        )

        # 4. è·å–ç³»ç»ŸçŠ¶æ€
        status = await system.get_system_status()
        print("ç³»ç»Ÿè¿è¡ŒçŠ¶æ€:", status)

    finally:
        await system.shutdown()

# è¿è¡Œç¤ºä¾‹
if __name__ == "__main__":
    asyncio.run(main())
```

### 8.5 æ€§èƒ½æŒ‡æ ‡

**é¢„æœŸæ€§èƒ½æŒ‡æ ‡**:
- çŸ¥è¯†å›¾è°±æ“ä½œå“åº”æ—¶é—´: <200ms (ç®€å•æŸ¥è¯¢), <2s (å¤æ‚åˆ†æ)
- ç¼“å­˜å‘½ä¸­ç‡: >80%
- å†…å­˜ä½¿ç”¨: <2GB (æ­£å¸¸è´Ÿè½½)
- å¹¶å‘å¤„ç†èƒ½åŠ›: æ”¯æŒ10ä¸ªå¹¶å‘Canvasæ“ä½œ
- æ•°æ®è¿ç§»é€Ÿåº¦: ~50èŠ‚ç‚¹/ç§’

**æ‰©å±•æ€§æŒ‡æ ‡**:
- æ”¯æŒCanvasèŠ‚ç‚¹æ•°é‡: 10,000+
- æ”¯æŒçŸ¥è¯†å›¾è°±ä¸‰å…ƒç»„æ•°é‡: 100,000+
- æ”¯æŒå¹¶å‘ç”¨æˆ·æ•°: 50+
- æ•°æ®å­˜å‚¨å®¹é‡: å¯æ‰©å±•è‡³TBçº§åˆ«

### 8.6 ä¸LangGraph Checkpointerçš„èŒè´£è¾¹ç•Œ

> **æ›´æ–°æ—¥æœŸ**: 2025-11-11
> **å…³è”PRD**: v1.1.3 Section 3.6

#### èƒŒæ™¯è¯´æ˜

éšç€Epic 12å¼•å…¥LangGraphæ¡†æ¶å±‚è®°å¿†ç³»ç»Ÿï¼ˆCheckpointerï¼‰ï¼ŒCanvaså­¦ä¹ ç³»ç»Ÿç°åœ¨æ‹¥æœ‰**åŒè®°å¿†æ¶æ„**ï¼š
1. **æ¡†æ¶å±‚**: LangGraph Checkpointerï¼ˆAgent StateæŒä¹…åŒ–ï¼‰
2. **ä¸šåŠ¡å±‚**: Graphiti + Temporal + Semantic Memoryï¼ˆä¸šåŠ¡çŸ¥è¯†å›¾è°±ï¼‰

æœ¬å°èŠ‚æ˜ç¡®ä¸¤ä¸ªç³»ç»Ÿçš„èŒè´£è¾¹ç•Œï¼Œé¿å…åŠŸèƒ½é‡å å’Œæ•°æ®å†²çªã€‚

---

#### èŒè´£åˆ†å·¥çŸ©é˜µ

| ç»´åº¦ | LangGraph Checkpointer | GraphitiçŸ¥è¯†å›¾è°± | å¤‡æ³¨ |
|------|----------------------|----------------|------|
| **æ•°æ®ç±»å‹** | Agent Stateï¼ˆä¼šè¯çŠ¶æ€ï¼‰ | ä¸šåŠ¡çŸ¥è¯†å…³ç³»ï¼ˆæ¦‚å¿µã€èŠ‚ç‚¹ã€æ—¶é—´çº¿ï¼‰ | ä¸åŒå±‚æ¬¡çš„æŠ½è±¡ |
| **æ—¶é—´èŒƒå›´** | å½“å‰å­¦ä¹ ä¼šè¯ï¼ˆçŸ­æœŸï¼‰ | è·¨ä¼šè¯å†å²ï¼ˆé•¿æœŸï¼‰ | Checkpointer=çŸ­æœŸï¼ŒGraphiti=é•¿æœŸ |
| **æŸ¥è¯¢åœºæ™¯** | æ¢å¤Agentæ‰§è¡Œä¸Šä¸‹æ–‡ | è·¨CanvasçŸ¥è¯†å…³è”ã€å­¦ä¹ å†å²åˆ†æ | åŠŸèƒ½äº’è¡¥ |
| **æŒä¹…åŒ–** | PostgreSQL/InMemory | Neo4j | ä¸åŒæ•°æ®åº“ |
| **æ•°æ®é‡çº§** | MBçº§ï¼ˆå•ä¼šè¯Stateï¼‰ | GBçº§ï¼ˆå…¨å±€çŸ¥è¯†å›¾è°±ï¼‰ | è§„æ¨¡å·®å¼‚ |
| **ä¸€è‡´æ€§è¦æ±‚** | å¼ºä¸€è‡´æ€§ï¼ˆä¸Canvasæ–‡ä»¶ï¼‰ | æœ€ç»ˆä¸€è‡´æ€§ | ä¸åŒSLA |
| **æ›´æ–°é¢‘ç‡** | æ¯æ¬¡Agentæ“ä½œï¼ˆé«˜é¢‘ï¼‰ | Canvasæ“ä½œåå¼‚æ­¥ï¼ˆä½é¢‘ï¼‰ | Checkpointerå®æ—¶ï¼ŒGraphitiå¼‚æ­¥ |
| **æŸ¥è¯¢æ€§èƒ½** | <50msï¼ˆStateæ¢å¤ï¼‰ | <200msï¼ˆç®€å•æŸ¥è¯¢ï¼‰ï¼Œ<2sï¼ˆå¤æ‚å›¾æŸ¥è¯¢ï¼‰ | æ€§èƒ½ç›®æ ‡ä¸åŒ |

---

#### æ•°æ®æµåä½œæœºåˆ¶

```mermaid
graph TD
    A[Canvas Operation] --> B[LangGraph Agent Node]
    B --> C{æ“ä½œæˆåŠŸ?}
    C -->|æ˜¯| D[æ›´æ–°Canvasæ–‡ä»¶]
    C -->|å¦| E[å›æ»šState]
    D --> F[LangGraph Checkpointer æŒä¹…åŒ–State]
    D --> G[å¼‚æ­¥å­˜å‚¨åˆ°Graphiti]

    F --> H[çŸ­æœŸä¼šè¯æ¢å¤]
    G --> I[é•¿æœŸçŸ¥è¯†å›¾è°±æŸ¥è¯¢]

    style F fill:#e1f5fe
    style G fill:#fff3e0
    style H fill:#e1f5fe
    style I fill:#fff3e0
```

**å…³é”®è¦ç‚¹**:
1. **åŒæ­¥è·¯å¾„**: Canvasæ“ä½œ â†’ LangGraph Stateæ›´æ–° â†’ CheckpointeræŒä¹…åŒ–ï¼ˆå¼ºä¸€è‡´æ€§ï¼‰
2. **å¼‚æ­¥è·¯å¾„**: Canvasæ“ä½œ â†’ Graphitiå­˜å‚¨ï¼ˆæœ€ç»ˆä¸€è‡´æ€§ï¼Œå…è®¸å»¶è¿Ÿï¼‰
3. **æŸ¥è¯¢åˆ†ç¦»**:
   - éœ€è¦ä¼šè¯ä¸Šä¸‹æ–‡ â†’ æŸ¥è¯¢Checkpointer
   - éœ€è¦è·¨ä¼šè¯/è·¨Canvaså…³è” â†’ æŸ¥è¯¢Graphiti

---

#### å…¸å‹ä½¿ç”¨åœºæ™¯å¯¹æ¯”

| åœºæ™¯ | ä½¿ç”¨ç³»ç»Ÿ | åŸå›  |
|------|---------|------|
| **å¤šè½®å¯¹è¯æ¢å¤** | Checkpointer | éœ€è¦æ¢å¤å½“å‰ä¼šè¯çš„Agent Stateï¼ˆdecomposition_results, scoring_resultç­‰ï¼‰ |
| **è·¨Canvasæ¦‚å¿µæŸ¥è¯¢** | Graphiti | éœ€è¦æŸ¥è¯¢æ‰€æœ‰Canvasä¸­å…³äº"çŸ©é˜µ"çš„èŠ‚ç‚¹å’Œå…³ç³» |
| **å­¦ä¹ æ—¶é—´çº¿è¿½è¸ª** | Graphiti (Temporal Memory) | éœ€è¦æŸ¥è¯¢è·¨ä¼šè¯çš„å­¦ä¹ å†å²å’Œè¿›å±• |
| **æ£€éªŒç™½æ¿ç”Ÿæˆ** | Checkpointer + Graphiti | Checkpointeræä¾›å½“å‰ä¼šè¯ä¸Šä¸‹æ–‡ï¼ŒGraphitiæä¾›å†å²æŒæ¡åº¦æ•°æ® |
| **å›æ»šæ“ä½œ** | Checkpointerï¼ˆä¼˜å…ˆï¼‰ + Canvaså¤‡ä»½ | Stateå›æ»š + æ–‡ä»¶å›æ»šï¼ŒGraphitiæ ‡è®°ä¸ºå·²æ’¤é”€ |
| **è‰¾å®¾æµ©æ–¯å¤ä¹ ** | Graphiti (Temporal Memory) | åŸºäºé•¿æœŸå­¦ä¹ å†å²è®¡ç®—å¤ä¹ è®¡åˆ’ |
| **Agentå†³ç­–ä¾æ®** | Checkpointerï¼ˆå½“å‰Stateï¼‰ + Graphitiï¼ˆå†å²æ•°æ®ï¼‰ | ç»“åˆçŸ­æœŸå’Œé•¿æœŸæ•°æ®åšæ™ºèƒ½å†³ç­– |

---

#### æ•°æ®ç¤ºä¾‹å¯¹æ¯”

**LangGraph Checkpointerå­˜å‚¨çš„æ•°æ®**:

```python
# Checkpoint Stateç¤ºä¾‹
{
    "canvas_path": "C:/Users/ROG/æ‰˜ç¦/ç¬”è®°åº“/ç¦»æ•£æ•°å­¦/ç¦»æ•£æ•°å­¦.canvas",
    "user_id": "user_12345",
    "session_id": "a1b2c3d4-e5f6-7890-abcd-ef1234567890",
    "operation": "decomposition",
    "concept": "é€†å¦å‘½é¢˜",
    "decomposition_results": [
        "ä»€ä¹ˆæ˜¯é€†å¦å‘½é¢˜çš„å®šä¹‰?",
        "é€†å¦å‘½é¢˜ä¸åŸå‘½é¢˜æœ‰ä»€ä¹ˆå…³ç³»?",
        "å¦‚ä½•åˆ¤æ–­é€†å¦å‘½é¢˜çš„çœŸå‡?"
    ],
    "scoring_result": {
        "node_id": "yellow_123",
        "accuracy": 22,
        "imagery": 18,
        "completeness": 20,
        "originality": 15,
        "total": 75,
        "color": "3"  # ç´«è‰²
    },
    "messages": [...],  # å¯¹è¯å†å²
    "last_operation": "scoring",
    "last_timestamp": "2025-11-11T14:30:00"
}
```

**GraphitiçŸ¥è¯†å›¾è°±å­˜å‚¨çš„æ•°æ®**:

```cypher
// èŠ‚ç‚¹ç¤ºä¾‹
CREATE (c:Canvas {name: "ç¦»æ•£æ•°å­¦", path: "..."})
CREATE (concept:Concept {name: "é€†å¦å‘½é¢˜", domain: "ç¦»æ•£æ•°å­¦"})
CREATE (node:Node {
    canvas_id: "red_001",
    text: "ä»€ä¹ˆæ˜¯é€†å¦å‘½é¢˜?",
    color: "1",  // çº¢è‰²
    understanding_state: "not_understood"
})
CREATE (understanding:UnderstandingState {
    node_id: "yellow_123",
    accuracy: 22,
    imagery: 18,
    completeness: 20,
    originality: 15,
    total: 75,
    timestamp: "2025-11-11T14:30:00"
})

// å…³ç³»ç¤ºä¾‹
CREATE (c)-[:CONTAINS]->(node)
CREATE (node)-[:IS_ABOUT]->(concept)
CREATE (node)-[:HAS_UNDERSTANDING_STATE]->(understanding)
CREATE (understanding)-[:EVOLVES_TO]->(next_understanding)
```

**å¯¹æ¯”æ€»ç»“**:
- **Checkpointer**: å­˜å‚¨å®Œæ•´çš„Agentæ‰§è¡Œä¸Šä¸‹æ–‡ï¼ˆç»“æ„åŒ–Stateï¼‰ï¼Œç”¨äºä¼šè¯æ¢å¤
- **Graphiti**: å­˜å‚¨çŸ¥è¯†å›¾è°±ä¸‰å…ƒç»„ï¼ˆå®ä½“+å…³ç³»ï¼‰ï¼Œç”¨äºçŸ¥è¯†å…³è”æŸ¥è¯¢

---

#### ä¸€è‡´æ€§ä¿è¯æœºåˆ¶

**å¼ºä¸€è‡´æ€§è·¯å¾„** (Canvas â†” LangGraph State):

```python
def agent_node_with_strong_consistency(state: CanvasLearningState):
    """ç¡®ä¿Canvasæ“ä½œå’ŒStateæ›´æ–°çš„å¼ºä¸€è‡´æ€§"""
    # Step 1: å¤‡ä»½Canvas
    backup = backup_canvas(state["canvas_path"])

    try:
        # Step 2: æ‰§è¡ŒCanvasæ“ä½œ
        write_to_canvas(state["canvas_path"], new_data)

        # Step 3: è¿”å›æ–°Stateï¼ˆLangGraphè‡ªåŠ¨æŒä¹…åŒ–ï¼‰
        return {
            **state,
            "last_operation": "decomposition",
            "decomposition_results": new_data
        }
    except Exception as e:
        # Step 4: å¤±è´¥æ—¶å›æ»šCanvas
        restore_canvas(state["canvas_path"], backup)
        raise  # ä¸åˆ›å»ºæ–°checkpoint
```

**æœ€ç»ˆä¸€è‡´æ€§è·¯å¾„** (Canvas â†” Graphiti):

```python
def agent_node_with_eventual_consistency(state: CanvasLearningState):
    """Canvasæ“ä½œæˆåŠŸï¼ŒGraphitiå¼‚æ­¥å­˜å‚¨ï¼ˆå…è®¸å¤±è´¥ï¼‰"""
    # Step 1: Canvasæ“ä½œï¼ˆå…³é”®è·¯å¾„ï¼‰
    write_to_canvas(state["canvas_path"], new_data)

    # Step 2: è¿”å›æ–°Stateï¼ˆå…³é”®è·¯å¾„ï¼‰
    new_state = {
        **state,
        "decomposition_results": new_data
    }

    # Step 3: å¼‚æ­¥å­˜å‚¨åˆ°Graphitiï¼ˆéå…³é”®è·¯å¾„ï¼‰
    try:
        asyncio.create_task(store_to_graphiti(state["session_id"], new_data))
    except Exception as e:
        logger.error(f"Graphiti storage failed: {e}")
        # ä¸å½±å“Canvasæ“ä½œæˆåŠŸ

    return new_state
```

---

#### å†²çªå¤„ç†ç­–ç•¥

**åœºæ™¯1: Checkpointerä¸Graphitiæ•°æ®ä¸ä¸€è‡´**

- **æ£€æµ‹**: å®šæœŸå¯¹æ¯”Checkpointerçš„Stateå¿«ç…§ä¸Graphitiçš„èŠ‚ç‚¹çŠ¶æ€
- **è§£å†³**:
  - Canvasæ–‡ä»¶ = çœŸå®æ•°æ®æº
  - Checkpointerä¼˜å…ˆçº§ > Graphitiï¼ˆå› ä¸ºCheckpointeræ˜¯å¼ºä¸€è‡´æ€§ï¼‰
  - ä¿®å¤æ–¹å¼: ä»Canvasæ–‡ä»¶é‡æ–°åŒæ­¥åˆ°Graphiti

**åœºæ™¯2: å›æ»šæ“ä½œå¯¼è‡´çš„æ•°æ®å†²çª**

```python
def handle_rollback_conflict(
    canvas_path: str,
    session_id: str,
    checkpoint_id: str
):
    """å›æ»šæ—¶ç¡®ä¿ä¸‰ä¸ªç³»ç»Ÿä¸€è‡´"""
    # Step 1: å›æ»šCanvasæ–‡ä»¶ï¼ˆä»å¤‡ä»½ï¼‰
    restore_canvas_from_backup(canvas_path, checkpoint_id)

    # Step 2: å›æ»šLangGraph Stateï¼ˆä»checkpointï¼‰
    config = create_langgraph_config(canvas_path, "user_id", session_id)
    config["configurable"]["checkpoint_id"] = checkpoint_id
    state = graph.get_state(config)

    # Step 3: æ ‡è®°Graphitiæ“ä½œä¸ºå·²æ’¤é”€ï¼ˆä¸åˆ é™¤ï¼Œä¿ç•™å†å²ï¼‰
    mark_graphiti_operations_as_reverted(
        session_id,
        after_timestamp=state.values["last_timestamp"]
    )

    # Step 4: éªŒè¯ä¸€è‡´æ€§
    assert verify_consistency(canvas_path, state, graphiti_data)
```

---

#### æ€§èƒ½ä¼˜åŒ–å»ºè®®

**1. å‡å°‘Checkpointerå†™å…¥é¢‘ç‡**

```python
# âŒ ä½æ•ˆï¼šæ¯ä¸ªå­æ“ä½œéƒ½åˆ›å»ºcheckpoint
for question in questions:
    graph.invoke({"operation": "add_question", "question": question}, config)
    # 100ä¸ªé—®é¢˜ = 100æ¬¡checkpointå†™å…¥

# âœ… é«˜æ•ˆï¼šæ‰¹é‡æ“ä½œï¼Œ1æ¬¡checkpoint
graph.invoke({"operation": "add_questions", "questions": questions}, config)
# 100ä¸ªé—®é¢˜ = 1æ¬¡checkpointå†™å…¥
```

**2. å»¶è¿ŸGraphitiå†™å…¥**

```python
# ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—å¼‚æ­¥æ‰¹é‡å†™å…¥
graphiti_write_queue = asyncio.Queue()

async def batch_graphiti_writer():
    """åå°ä»»åŠ¡ï¼šæ‰¹é‡å†™å…¥Graphiti"""
    while True:
        batch = []
        for _ in range(10):  # æ”’10ä¸ªæ“ä½œ
            item = await graphiti_write_queue.get()
            batch.append(item)

        await graphiti_client.batch_write(batch)
        await asyncio.sleep(1)  # æ¯ç§’æ‰§è¡Œä¸€æ¬¡

# AgentèŠ‚ç‚¹ä¸­å¼‚æ­¥å…¥é˜Ÿ
await graphiti_write_queue.put({"type": "decomposition", "data": ...})
```

**3. åˆ†å±‚ç¼“å­˜ç­–ç•¥**

- **L1 ç¼“å­˜** (LangGraph State): å½“å‰ä¼šè¯æ•°æ®ï¼ˆå†…å­˜çº§ï¼Œ<10msï¼‰
- **L2 ç¼“å­˜** (Checkpointer): å†å²ä¼šè¯Stateï¼ˆæ•°æ®åº“çº§ï¼Œ<50msï¼‰
- **L3 ç¼“å­˜** (Graphiti Redis): çƒ­é—¨çŸ¥è¯†å›¾è°±æŸ¥è¯¢ï¼ˆRedisçº§ï¼Œ<20msï¼‰
- **L4 å­˜å‚¨** (Graphiti Neo4j): å®Œæ•´çŸ¥è¯†å›¾è°±ï¼ˆNeo4jçº§ï¼Œ<200msï¼‰

---

#### è¿ç§»å’Œå…¼å®¹æ€§

**ä»çº¯Graphitiç³»ç»Ÿè¿ç§»åˆ°åŒè®°å¿†æ¶æ„**:

```python
async def migrate_to_dual_memory_architecture():
    """è¿ç§»ç°æœ‰Graphitiæ•°æ®åˆ°åŒè®°å¿†æ¶æ„"""
    # Step 1: ä¿æŒGraphitiæ•°æ®ä¸å˜ï¼ˆå‘åå…¼å®¹ï¼‰
    # Graphitiä»ç„¶å­˜å‚¨æ‰€æœ‰å†å²çŸ¥è¯†å›¾è°±æ•°æ®

    # Step 2: æ–°å¢Checkpointeré…ç½®ï¼ˆå‘å‰å…¼å®¹ï¼‰
    checkpointer = PostgresSaver.from_conn_string(DB_URI)
    graph = builder.compile(checkpointer=checkpointer)

    # Step 3: æ–°ä¼šè¯ä½¿ç”¨Checkpointerï¼Œæ—§æ•°æ®ä»åœ¨Graphiti
    # æ— ç¼è¿‡æ¸¡ï¼Œä¸å½±å“ç°æœ‰åŠŸèƒ½
```

**å…¼å®¹æ€§ä¿è¯**:
- âœ… æ—§ä»£ç ä»å¯æ­£å¸¸ä½¿ç”¨Graphitiï¼ˆé›¶ç ´åæ€§ï¼‰
- âœ… æ–°ä»£ç åŒæ—¶åˆ©ç”¨Checkpointer + Graphitiï¼ˆå¢å¼ºåŠŸèƒ½ï¼‰
- âœ… æŸ¥è¯¢æ¥å£ç»Ÿä¸€å°è£…ï¼Œè‡ªåŠ¨è·¯ç”±åˆ°æ­£ç¡®ç³»ç»Ÿ

---

#### éªŒæ”¶æ ‡å‡†

**åŠŸèƒ½éªŒæ”¶**:
- âœ… **AC 1**: Checkpointerå’ŒGraphitiå¯ç‹¬ç«‹å·¥ä½œï¼Œäº’ä¸é˜»å¡
- âœ… **AC 2**: Canvasæ“ä½œå¤±è´¥æ—¶ï¼ŒCheckpointerä¸åˆ›å»ºcheckpointï¼ŒGraphitiä¸å­˜å‚¨
- âœ… **AC 3**: Checkpointerå†™å…¥å¤±è´¥æ—¶ï¼ŒCanvasæ“ä½œå¤±è´¥å¹¶å›æ»š
- âœ… **AC 4**: Graphitiå†™å…¥å¤±è´¥æ—¶ï¼ŒCanvasæ“ä½œæˆåŠŸï¼Œä»…è®°å½•æ—¥å¿—
- âœ… **AC 5**: å›æ»šæ“ä½œåŒæ­¥æ¢å¤Canvas + Stateï¼ŒGraphitiæ ‡è®°æ’¤é”€
- âœ… **AC 6**: å¤šè½®å¯¹è¯å¯æ¢å¤Checkpointerçš„Stateï¼ŒåŒæ—¶æŸ¥è¯¢Graphitiçš„å†å²
- âœ… **AC 7**: è·¨CanvasæŸ¥è¯¢ä»…ä½¿ç”¨Graphitiï¼Œä¸è®¿é—®Checkpointer

**æ€§èƒ½éªŒæ”¶**:
- âœ… **AC 8**: Checkpointerå†™å…¥ < 100msï¼ˆPostgresSaverï¼‰
- âœ… **AC 9**: Graphitiå¼‚æ­¥å†™å…¥ä¸é˜»å¡Agentæ‰§è¡Œ
- âœ… **AC 10**: æ‰¹é‡æ“ä½œå‡å°‘90% checkpointå†™å…¥æ¬¡æ•°

**ä¸€è‡´æ€§éªŒæ”¶**:
- âœ… **AC 11**: Canvasæ–‡ä»¶ â†” Checkpointer State: å¼ºä¸€è‡´æ€§
- âœ… **AC 12**: Canvasæ–‡ä»¶ â†” Graphiti: æœ€ç»ˆä¸€è‡´æ€§ï¼ˆ<5ç§’åŒæ­¥å»¶è¿Ÿï¼‰
- âœ… **AC 13**: ä¸€è‡´æ€§æ ¡éªŒè„šæœ¬å¯æ£€æµ‹å¹¶ä¿®å¤ä¸ä¸€è‡´

---

**æ€»ç»“**: åŒè®°å¿†æ¶æ„é€šè¿‡æ¸…æ™°çš„èŒè´£åˆ†å·¥å’Œåä½œæœºåˆ¶ï¼Œå®ç°äº†çŸ­æœŸä¼šè¯æ¢å¤ï¼ˆCheckpointerï¼‰å’Œé•¿æœŸçŸ¥è¯†ç®¡ç†ï¼ˆGraphitiï¼‰çš„å®Œç¾ç»“åˆï¼Œä¸ºCanvaså­¦ä¹ ç³»ç»Ÿæä¾›äº†å¼ºå¤§çš„è®°å¿†èƒ½åŠ›ã€‚

---


## ğŸ“š 9. å®æ–½è·¯çº¿å›¾

### Phase 1: åŸºç¡€æ¶æ„ (2-3å‘¨)
- [x] çŸ¥è¯†å›¾è°±æ•°æ®æ¨¡å‹è®¾è®¡
- [x] Graphitié›†æˆæ¶æ„
- [x] åŸºç¡€è®°å¿†åŠŸèƒ½
- [ ] Neo4jç¯å¢ƒæ­å»º
- [ ] åŸºç¡€APIå®ç°

### Phase 2: æ ¸å¿ƒåŠŸèƒ½ (3-4å‘¨)
- [ ] æ™ºèƒ½æ£€ç´¢åŠŸèƒ½
- [ ] å­¦ä¹ æ—¶é—´çº¿è¿½è¸ª
- [ ] çŸ¥è¯†æŒæ¡æ—¶é—´çº¿
- [ ] æ™ºèƒ½æ£€éªŒç™½æ¿ç”Ÿæˆ

### Phase 3: ä¼˜åŒ–å’Œæ‰©å±• (2-3å‘¨)
- [ ] æ€§èƒ½ä¼˜åŒ–ç­–ç•¥
- [ ] ç¼“å­˜ç³»ç»Ÿ
- [ ] å¼‚æ­¥æ“ä½œä¼˜åŒ–
- [ ] æ•°æ®è¿ç§»å·¥å…·

### Phase 4: æµ‹è¯•å’Œéƒ¨ç½² (1-2å‘¨)
- [ ] å•å…ƒæµ‹è¯•
- [ ] é›†æˆæµ‹è¯•
- [ ] æ€§èƒ½æµ‹è¯•
- [ ] ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.1
**æœ€åæ›´æ–°**: 2025-11-11
**ä½œè€…**: Claude Code
**çŠ¶æ€**: æŠ€æœ¯æ–¹æ¡ˆè®¾è®¡å®Œæˆ
