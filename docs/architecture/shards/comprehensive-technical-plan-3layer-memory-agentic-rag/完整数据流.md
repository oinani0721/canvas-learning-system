# 完整数据流

### 场景1: 检验白板生成

**输入**: Canvas原白板路径 (`笔记库/离散数学/离散数学.canvas`)

**流程**:

```
1. Canvas节点提取
   ↓
   extract_verification_nodes(canvas) → 红/紫色节点列表

2. Agentic RAG检索 (并行)
   ↓
   ┌──────────────────┐
   │  LangGraph Start │
   └────────┬─────────┘
            │
   ┌────────▼─────────┐
   │  fan_out_retrieval│ (Send模式)
   └────────┬─────────┘
            │
     ┌──────┴──────┐
     │             │
┌────▼─────┐  ┌───▼──────┐
│ Graphiti │  │ LanceDB  │
│ Retrieval│  │ Retrieval│
└────┬─────┘  └───┬──────┘
     │             │
     └──────┬──────┘
            │
   ┌────────▼─────────┐
   │  RRF Fusion      │ (k=60)
   └────────┬─────────┘
            │
   ┌────────▼─────────┐
   │  Cohere Rerank   │ (高质量)
   └────────┬─────────┘
            │
   ┌────────▼─────────┐
   │  Quality Check   │
   └────────┬─────────┘
            │
        ┌───▼───┐
        │  END  │
        └───────┘

3. 检验题生成
   ↓
   LLM.generate_questions(
       concept="逆否命题",
       context=reranked_results  # 来自Agentic RAG
   ) → 2-3个深度检验题

4. 检验白板创建
   ↓
   create_verification_canvas(
       questions=questions,
       layout="v1.1"  # 黄色节点在问题下方
   )

5. Temporal Memory记录
   ↓
   record_learning_session(
       canvas_path=original_canvas,
       concepts_learned=concepts,
       review_type="verification"
   )
```

**数据流时间线**:
```
T0:      Canvas节点提取 (50ms)
T50:     Agentic RAG并行检索开始
T50-95:  Graphiti检索 (45ms)
T50-102: LanceDB检索 (52ms)
T102:    RRF融合 (8ms)
T110:    Cohere Rerank (120ms)
T230:    质量检查 (10ms)
T240:    检验题生成 (3000ms, LLM)
T3240:   Canvas创建 (100ms)
T3340:   完成

总延迟: ~3.3秒 (其中LLM占3秒)
```

---

### 场景2: 艾宾浩斯复习推荐

**触发**: 用户连续3天未打开Canvas

**流程**:

```
1. Temporal Memory查询
   ↓
   SELECT concept_id, concept_name, due_date
   FROM concept_cards
   WHERE due_date < NOW()
   ORDER BY due_date ASC
   LIMIT 10
   ↓
   待复习概念: [逆否命题, 真值表, 德摩根定律]

2. 为每个概念构建复习上下文 (Agentic RAG)
   ↓
   Parallel:
   ├─ Graphiti.search("逆否命题", max_distance=1)
   │  → 关联概念: [真值表, 蕴含式]
   └─ LanceDB.search("逆否命题")
      → 历史解释文档: [oral-explanation.md, clarification-path.md]

3. 融合复习材料
   ↓
   weighted_fusion(
       graphiti_results,  # 权重0.3 (概念网络)
       lancedb_results,   # 权重0.7 (复习材料更重要)
   )

4. 生成复习计划
   ↓
   {
     "concept": "逆否命题",
     "overdue_days": 5,
     "priority": "high",
     "related_concepts": ["真值表", "蕴含式"],
     "review_materials": [
       "逆否命题-口语化解释-20250105.md",
       "逆否命题-澄清路径-20250108.md"
     ],
     "estimated_time": "15分钟"
   }

5. 更新FSRS卡片
   ↓
   # 用户复习后评分: Good
   review_log = fsrs_model.review_card(
       card=concept_card,
       rating=Rating.Good
   )
   UPDATE concept_cards
   SET due_date = ?, stability = ?
   WHERE concept_id = ?
```

---
