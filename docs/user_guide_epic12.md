# Canvas Learning System - Epic 12 用户指南

## 概述

Epic 12 引入了**三层记忆系统**和**Agentic RAG**，显著提升了学习体验：

- **检索质量提升**: MRR@10 从 0.25 提升到 0.38+
- **检验题相关性**: 从 70% 提升到 85%+
- **检索延迟**: P95 < 400ms

---

## 新功能介绍

### 1. 三层记忆系统

Epic 12采用三层记忆架构，协同工作以提供最佳学习体验：

#### Layer 1: Graphiti时序知识图谱
- **作用**: 记录学习历程和概念关系
- **特点**: 时间感知，自动追踪学习进度
- **存储**: 概念、关系、学习事件
- **优势**: 支持复杂的知识结构查询

#### Layer 2: LanceDB向量数据库
- **作用**: 高性能语义检索
- **特点**: 多模态支持，P95延迟<50ms
- **存储**: Canvas节点的向量嵌入
- **优势**: 支持相似度搜索和语义匹配

#### Layer 3: Temporal Memory
- **作用**: 艾宾浩斯复习调度
- **特点**: 基于FSRS算法，个性化复习间隔
- **存储**: 学习记录、复习历史、遗忘曲线参数
- **优势**: 科学的间隔重复，优化记忆保持

### 2. Agentic RAG检索增强

新的检索流程采用LangGraph编排，提供智能的多源融合检索：

```
Query → 并行检索(Graphiti + LanceDB) → 融合 → Reranking → 质量评分 → 结果
```

**融合策略**:

| 策略 | 适用场景 | 特点 |
|------|----------|------|
| RRF (Reciprocal Rank Fusion) | 通用场景 | 平衡不同来源 |
| Weighted | 检验白板生成 | 薄弱点权重70% |
| Cascade | 高精度需求 | 分层过滤 |

**Reranking策略**:

| 策略 | 场景 | 成本 |
|------|------|------|
| Cohere | 高质量场景（检验白板） | API费用 |
| Local | 日常检索 | 零成本 |

### 3. 检验白板生成改进

使用新Agentic RAG后，检验白板生成更精准：

```bash
# 生成检验白板
"@离散数学.canvas 生成检验白板"

# 新系统会：
# 1. 从Graphiti获取薄弱概念（时序分析）
# 2. 从LanceDB获取相关内容（语义匹配）
# 3. 使用Weighted融合（薄弱点权重70%）
# 4. Cohere Reranking提升质量
# 5. 生成针对性检验题
```

**质量提升**:
- 检验题与薄弱点相关性: 70% → 85%+
- 生成延迟: P95 < 400ms
- 自动质量控制循环

### 4. 艾宾浩斯复习系统

系统自动追踪学习进度，在最佳时间点提醒复习：

| 触发点 | 时间 | 说明 |
|--------|------|------|
| 触发点1 | 学习后24小时 | 初次巩固 |
| 触发点2 | 7天后 | 短期记忆转长期 |
| 触发点3 | 30天后 | 长期巩固 |
| 触发点4 | 基于FSRS动态调整 | 个性化间隔 |

**FSRS算法特点**:
- 根据个人记忆能力调整间隔
- 考虑难度和复习质量
- 持续优化预测准确性

---

## 使用方法

### 日常学习（无变化）

基础学习流程保持不变：

```bash
# 概念拆解
"@离散数学.canvas 拆解'逆否命题'这个红色节点"

# 评分黄色节点
"@离散数学.canvas 评分所有黄色节点"

# 口语化解释
"@离散数学.canvas 生成口语化解释'逆否命题'"
```

### 生成检验白板（增强）

```bash
# 标准检验白板
"@离散数学.canvas 生成检验白板"

# 针对特定概念
"@离散数学.canvas 生成检验白板 聚焦'命题逻辑'"
```

**新功能**: 系统会自动：
1. 分析Canvas中的红色/紫色节点
2. 识别薄弱概念
3. 生成针对性检验题
4. 应用质量控制

### 查看复习建议

```bash
# 显示今日复习任务
"/review"

# 查看特定Canvas的复习状态
"/review @离散数学.canvas"

# 执行复习
"/review start"
```

### 并行智能分析（新功能）

```bash
# 并行分析多个概念
"/parallel-analyze @离散数学.canvas 命题,谓词,集合"

# 查看分析进度
"/parallel-status"
```

---

## LangSmith可观测性

Epic 12集成了LangSmith，提供完整的追踪和监控：

### 查看追踪
访问: https://smith.langchain.com/

### 追踪内容
- 检索请求详情
- 每个节点的延迟
- 融合策略决策
- Reranking效果
- 成本统计

---

## 常见问题

### Q: 检索速度变慢了？
A: 新系统增加了Reranking步骤，但P95仍<400ms。如感觉慢：
1. 检查Neo4j连接状态
2. 确认网络正常
3. 查看LangSmith追踪定位瓶颈

### Q: 检验题不相关？
A: 确保Canvas中有足够的红色/紫色节点：
1. 系统需要这些作为薄弱点输入
2. 尝试先进行一轮评分
3. 检查Graphiti中是否有足够的学习历史

### Q: 复习提醒不准确？
A: FSRS需要学习数据积累：
1. 新用户需使用几周后才准确
2. 每次复习后给出准确的评分
3. 持续使用会提升预测精度

### Q: 如何查看成本？
A:
```bash
# 查看成本报告
"/costs"

# 或访问LangSmith dashboard
```

### Q: 如何降级到本地Reranking？
A: 系统自动降级：
1. Cohere API失败时自动切换
2. 可手动配置默认策略
3. 查看运维手册了解详情

---

## 性能指标

### 检索质量
| 指标 | Epic 11 | Epic 12 | 提升 |
|------|---------|---------|------|
| MRR@10 | 0.25 | 0.38+ | +52% |
| Recall@10 | 0.50 | 0.68+ | +36% |
| F1@10 | 0.60 | 0.77+ | +28% |

### 延迟
| 操作 | P50 | P95 | P99 |
|------|-----|-----|-----|
| 基础检索 | 150ms | 300ms | 450ms |
| 检验白板生成 | 250ms | 400ms | 600ms |

### 成本
| 服务 | 月度预算 | 典型用量 |
|------|----------|----------|
| Cohere | $3 | ~500次高质量检索 |
| OpenAI | $1 | ~200次Query重写 |
| 总计 | $5 | 正常使用 |

---

## 技术支持

如遇问题，请查看：
- 运维手册: `docs/operations/epic12_operations.md`
- 故障排查: `docs/operations/troubleshooting.md`
- API文档: `docs/api/agentic_rag_api.md`

或提交Issue到项目仓库。

---

## 版本信息

- **Epic**: 12 - 三层记忆系统 + Agentic RAG
- **版本**: 2.0.0
- **发布日期**: 2025-11-29
- **兼容性**: Canvas Learning System v1.x升级兼容
