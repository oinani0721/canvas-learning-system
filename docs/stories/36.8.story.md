# Story 36.8: 跨Canvas上下文自动注入

## Status

**Done**

---

## Story

**As a** Canvas Learning System user studying exercise nodes,
**I want** the system to automatically inject relevant knowledge points from associated lecture canvases into the agent context,
**so that** the AI agent has access to lecture content when helping me solve problems, providing more contextual and accurate assistance.

---

## Acceptance Criteria

1. **AC1**: When processing an exercise node, the system automatically detects associated lecture canvases using Neo4j-persisted associations (from Story 36.5)
2. **AC2**: Top 5 most relevant knowledge points are automatically extracted from the associated lecture canvas based on:
   - Relevance scoring (semantic similarity to exercise content)
   - Position in lecture (earlier concepts prioritized for foundational knowledge)
   - Color status (green/mastered concepts prioritized for reference)
3. **AC3**: Injected context uses the format: `[参见讲座: {lecture_name}] {knowledge_point_content}`
4. **AC4**: Cross-canvas context injection is triggered automatically when:
   - Canvas filename matches exercise patterns (习题, 练习, 题目, exam, exercise, etc.)
   - A valid lecture association exists with confidence >= 0.6
5. **AC5**: Performance requirement: Cross-canvas context retrieval completes within 200ms (P95)
6. **AC6**: Graceful degradation: If Neo4j is unavailable, falls back to in-memory associations (existing Story 25.3 behavior)

---

## Tasks / Subtasks

- [ ] **Task 1: Enhance Cross-Canvas Detection Logic** (AC: 1, 4)
  - [ ] 1.1 Add `is_exercise_node()` method to `ContextEnrichmentService` using `CrossCanvasService.EXERCISE_PATTERNS`
  - [ ] 1.2 Modify `enrich_with_adjacent_nodes()` to automatically trigger cross-canvas injection when exercise node detected
  - [ ] 1.3 Add confidence threshold check (>= 0.6) before injecting cross-canvas context

- [ ] **Task 2: Implement Neo4j-Backed Association Lookup** (AC: 1, 6)
  - [ ] 2.1 Add `get_lecture_for_exercise_neo4j()` method to `CrossCanvasService`
  - [ ] 2.2 Implement Cypher query: `MATCH (e:Canvas)-[:ASSOCIATED_WITH {type: 'LECTURE_FOR'}]->(l:Canvas) WHERE e.path = $exercise_path RETURN l`
  - [ ] 2.3 Implement fallback to in-memory `_associations` dict when Neo4j unavailable
  - [ ] 2.4 Add unit test for Neo4j query with mock driver

- [ ] **Task 3: Implement Top 5 Knowledge Point Extraction** (AC: 2, 3)
  - [ ] 3.1 Add `extract_top_knowledge_points()` method in `ContextEnrichmentService`
  - [ ] 3.2 Implement relevance scoring based on:
    - Semantic similarity (using node text overlap for MVP, can enhance with embeddings later)
    - Y-position sorting (earlier = more foundational)
    - Color priority: green("4") > purple("6") > yellow("3") > red("1")
  - [ ] 3.3 Limit extraction to 5 nodes with content length <= 300 chars each
  - [ ] 3.4 Format output as `[参见讲座: {name}] {content}` per AC3

- [ ] **Task 4: Update Context Formatting** (AC: 3)
  - [ ] 4.1 Modify `_format_cross_canvas_context()` to use new format: `[参见讲座: {name}] {content}`
  - [ ] 4.2 Add section header: `--- 参见讲座知识点 (Lecture References) ---`
  - [ ] 4.3 Include confidence score in header: `(置信度: {confidence:.0%})`

- [ ] **Task 5: Performance Optimization** (AC: 5)
  - [ ] 5.1 Add caching for association lookups (30s TTL using `functools.lru_cache` or similar)
  - [ ] 5.2 Implement parallel lecture node fetch using `asyncio.gather()` if multiple associations exist
  - [ ] 5.3 Add timing instrumentation using `structlog` for P95 monitoring

- [ ] **Task 6: Unit Tests** (AC: 1-6)
  - [ ] 6.1 Test automatic exercise detection with various filename patterns
  - [ ] 6.2 Test top 5 knowledge point extraction with scoring logic
  - [ ] 6.3 Test format output matches `[参见讲座: {name}] {content}` specification
  - [ ] 6.4 Test fallback behavior when Neo4j unavailable
  - [ ] 6.5 Test performance: mock 5 nodes retrieval completes < 200ms

---

## Dev Notes

### 依赖关系声明

> **⚠️ Story依赖** (2026-01-20)
>
> | 前置Story | 状态 | 依赖内容 |
> |-----------|------|----------|
> | Story 36.5 | 待完成 | Neo4j `ASSOCIATED_WITH` 关系持久化 |
> | Story 36.6 | 待完成 | 跨Canvas讲座自动发现算法 |
> | Story 36.7 | 待完成 | Agent上下文注入增强 (Neo4j数据源) |
>
> **注意**: 本Story可以在36.5-36.7完成前开始开发，但需要使用fallback逻辑（复用现有Story 25.3的内存存储）

### SDD规范参考 (必填)

**API端点** (无新增端点，增强现有逻辑):
- 本Story不新增API端点，而是增强 `POST /api/v1/agents/{agentName}/invoke` 的内部上下文注入逻辑
- 相关规范: `[Source: specs/api/agent-api.openapi.yml#L205-L260]`

**数据Schema**:
- Canvas关联Schema: `[Source: specs/data/canvas-association.schema.json]`
  - `association_type`: enum["prerequisite", "related", "extends", "references"] - 需扩展支持 "lecture_for"
  - `relevance_score`: number (0-1) - 用于置信度阈值判断
  - `shared_concepts`: array - 用于知识点提取优先级
- Agent调用请求: `[Source: specs/api/agent-api.openapi.yml#L454-L477 - AgentInvokeRequest]`

**数据模型引用**:
- CrossCanvasAssociation: `backend/app/services/cross_canvas_service.py:30-42`
  - 包含 `source_canvas_path`, `target_canvas_path`, `relationship_type`, `confidence`
- EnrichedContext: `backend/app/services/context_enrichment_service.py:132-197`
  - 包含 `cross_canvas_context`, `has_cross_canvas_refs`, `lecture_canvas_path`

### ADR决策关联 (必填)

| ADR编号 | 决策标题 | 对Story的影响 |
|---------|----------|---------------|
| 0003 | 使用Graphiti实现时序知识图谱记忆系统 | Neo4j作为关联存储后端，使用Cypher查询 |
| 0004 | 实现异步并行执行引擎提升Agent调用性能 | 跨Canvas查询使用async/await，支持并行获取 |
| ADR-009 | 错误处理与重试策略 | Neo4j查询失败时fallback到内存存储 |

**关键约束** (从0003 Consequences提取):
- Neo4j查询必须**异步执行**（使用`await`），避免阻塞学习流程
- 三级缓存策略：内存 → 磁盘 → Neo4j
- 查询失败后降级到缓存结果（如果可用）

`[Source: 0003-graphiti-memory.md]` `[Source: 0004-async-execution-engine.md]` `[Source: ADR-009]`

### 关键实现参考

**现有代码位置**:
- `backend/app/services/context_enrichment_service.py`:
  - `get_cross_canvas_context()` (L755-833) - 现有跨Canvas上下文获取
  - `_format_cross_canvas_context()` (L835-880) - 现有格式化逻辑，需修改
  - `enrich_with_adjacent_nodes()` (L238-487) - 主入口，需增强自动检测
- `backend/app/services/cross_canvas_service.py`:
  - `EXERCISE_PATTERNS` (L96-99) - 习题Canvas识别模式
  - `LECTURE_PATTERNS` (L100-103) - 讲座Canvas识别模式
  - `get_lecture_for_exercise()` (L331-356) - 现有关联查询

**Exercise Pattern Matching** (复用现有):
```python
# From cross_canvas_service.py:96-99
EXERCISE_PATTERNS = [
    r'题目', r'习题', r'练习', r'作业', r'exam', r'exercise', r'problem',
    r'quiz', r'test', r'期末', r'期中', r'复习题'
]
```

**Neo4j Cypher Query Template** (新增):
```cypher
-- 获取习题Canvas关联的讲座Canvas
MATCH (e:Canvas {path: $exercise_path})
      -[r:ASSOCIATED_WITH {type: 'LECTURE_FOR'}]->
      (l:Canvas)
WHERE r.confidence >= 0.6
RETURN l.path AS lecture_path,
       l.title AS lecture_title,
       r.confidence AS confidence,
       r.common_concepts AS common_concepts
ORDER BY r.confidence DESC
LIMIT 1
```

**Output Format Specification** (AC3):
```
--- 参见讲座知识点 (Lecture References) ---
[参见讲座: 线性代数-讲座] (置信度: 85%)
[共同概念] 矩阵乘法, 行列式, 特征值

[参见讲座: 线性代数-讲座] 矩阵乘法的定义：设A为m×n矩阵，B为n×p矩阵...
[参见讲座: 线性代数-讲座] 行列式的几何意义：表示线性变换对面积/体积的缩放...
[参见讲座: 线性代数-讲座] 特征值计算：det(A - λI) = 0 的根...
```

### Testing

**测试文件位置**: `backend/tests/integration/test_cross_canvas_injection.py` (新建)

**测试标准**:
- 使用 pytest + pytest-asyncio 进行异步测试
- 使用 unittest.mock 模拟 Neo4j 连接
- 覆盖率要求: >= 80% 对新增代码

**测试用例要求**:
1. `test_exercise_canvas_detection`: 验证习题Canvas正确识别
2. `test_top5_knowledge_point_extraction`: 验证知识点提取和排序逻辑
3. `test_format_output_specification`: 验证输出格式符合AC3
4. `test_neo4j_fallback_to_memory`: 验证Neo4j不可用时回退到内存
5. `test_confidence_threshold`: 验证置信度<0.6时不注入
6. `test_performance_under_200ms`: 验证P95延迟<200ms (使用mock)

**测试数据**:
```python
# 测试用Canvas名称
EXERCISE_CANVASES = [
    "线性代数-习题.canvas",
    "期末复习题-离散数学.canvas",
    "exam-calculus.canvas"
]
LECTURE_CANVASES = [
    "线性代数-讲座.canvas",
    "离散数学-笔记.canvas",
    "calculus-lecture.canvas"
]
```

### 技术约束

1. **性能**: P95 < 200ms（使用缓存和并行查询）
2. **兼容性**: 保持与现有Story 25.3实现的向后兼容
3. **降级**: Neo4j不可用时必须能正常工作（使用内存fallback）
4. **日志**: 使用structlog记录关键操作，便于性能分析

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-20 | 0.1 | Initial draft created | SM Agent (Bob) |
| 2026-01-20 | 0.2 | Fixed ADR references: ADR-003→0003, ADR-004→0004 (anti-hallucination fix) | PO Agent (Sarah) |

---

## Dev Agent Record

### Agent Model Used
*(To be filled by Dev Agent)*

### Debug Log References
*(To be filled by Dev Agent)*

### Completion Notes List
*(To be filled by Dev Agent)*

### File List
*(To be filled by Dev Agent)*

---

## QA Results

### Review Date: 2026-01-31

### Reviewed By: Quinn (Test Architect)

### ⚠️ Status Anomaly Alert

> **发现**: Story 状态为 "Ready"，但代码实现已完成！
> - `context_enrichment_service.py` 包含完整的 Task 1-5 实现
> - `test_cross_canvas_injection.py` 包含 654 行测试代码覆盖所有 6 个 AC
> - **建议**: 更新状态为 "Review" → "Done"

### Code Quality Assessment

**整体评分: 90/100 (优秀)**

实现质量非常高，代码结构清晰，符合 ADR 决策和项目规范。主要优点：

1. **完整的 AC 覆盖**: 所有 6 个验收标准都已实现并测试
2. **健壮的错误处理**: Neo4j fallback 机制完善 (AC6)
3. **性能优化到位**: 30s TTL 缓存 + 并行获取 + structlog 监控 (AC5)
4. **清晰的代码组织**: 单一职责原则，方法职责明确

### Requirements Traceability

| AC | 描述 | 实现位置 | 测试覆盖 | 状态 |
|----|------|----------|----------|------|
| AC1 | Neo4j 关联检测 | `_should_inject_cross_canvas_context()` | `TestExerciseCanvasDetection` | ✅ |
| AC2 | Top 5 知识点提取 | `extract_top_knowledge_points()` | `TestKnowledgePointExtraction` | ✅ |
| AC3 | 输出格式规范 | `_format_cross_canvas_context()` | `TestFormatOutputSpecification` | ✅ |
| AC4 | 自动触发条件 | `is_exercise_canvas()` + 置信度检查 | `TestConfidenceThreshold` | ✅ |
| AC5 | P95 < 200ms | 缓存 + asyncio.gather | `TestPerformance` | ✅ |
| AC6 | 优雅降级 | fallback 逻辑 | `TestNeo4jFallback` | ✅ |

### Refactoring Performed

无需重构 - 代码质量已达标准。

### Compliance Check

- Coding Standards: ✓ 符合 Python 最佳实践，使用 structlog 日志
- Project Structure: ✓ 服务层正确分离，测试文件位置正确
- Testing Strategy: ✓ 单元测试 + 集成测试，覆盖边界条件
- All ACs Met: ✓ 6/6 AC 全部实现并测试

### Improvements Checklist

- [x] Exercise pattern 检测逻辑完整 (14 种模式)
- [x] 知识点评分公式实现 (40% 语义 + 30% 位置 + 30% 颜色)
- [x] 30s TTL 缓存实现
- [x] structlog 性能监控
- [x] Neo4j fallback 降级逻辑
- [x] 654 行测试代码覆盖所有场景
- [ ] (建议) 考虑添加 embedding-based 语义相似度提升 AC2 准确性 (MVP 后优化)

### Security Review

无安全风险 - 无用户输入直接执行，无敏感数据暴露。

### Performance Considerations

- ✅ 30s TTL 缓存避免重复 Neo4j 查询
- ✅ asyncio.gather 并行获取多个关联
- ✅ structlog 计时可用于 P95 监控
- 测试验证: mock 场景下 5 节点提取 < 200ms

### Files Modified During Review

无文件修改。

### Gate Status

Gate: **PASS** → docs/qa/gates/36.8-cross-canvas-context-auto-injection.yml

### Recommended Status

✓ **Ready for Done** - 所有 AC 已实现并测试，代码质量优秀。
(注意: Story 状态需从 "Ready" 更正为实际状态)
