# Story 21.5.1: 500é”™è¯¯CORSå“åº”å¤´ä¿®å¤

## Status
âœ… Validated (PO Approved)

## Epic Context & Background

**æ‰€å±Epic**: EPIC-21.5 - Agentç«¯ç‚¹å¯é æ€§ä¿®å¤
**Epicæ–‡æ¡£**: [docs/prd/EPIC-21.5-AGENT-RELIABILITY-FIX.md](../prd/EPIC-21.5-AGENT-RELIABILITY-FIX.md)

**æœ¬Storyåœ¨Epicä¸­çš„å®šä½**:
- Epic 21.5çš„ç¬¬ä¸€ä¸ªStoryï¼Œä¼˜å…ˆçº§P0
- è§£å†³Agentç«¯ç‚¹500é”™è¯¯æ—¶CORSå¤´ç¼ºå¤±çš„æ ¸å¿ƒé—®é¢˜
- **ä¾èµ–**: æ— å‰ç½®ä¾èµ–ï¼Œå¯ç«‹å³å¼€å‘

**Epicæ ¸å¿ƒé—®é¢˜å›é¡¾**:

### ğŸ”´ Problem: 500é”™è¯¯æ—¶CORSå¤´ç¼ºå¤±
- **ç°è±¡**: ç”¨æˆ·å³é”®ç‚¹å‡»CanvasèŠ‚ç‚¹è°ƒç”¨Agentæ—¶ï¼Œæ˜¾ç¤º`net::ERR_FAILED 500`å’Œ`CORS policy: No 'Access-Control-Allow-Origin' header`
- **æ ¹å› **: FastAPIåœ¨æœªå¤„ç†å¼‚å¸¸æ—¶ï¼ŒCORSMiddlewareä¸ä¼šè¢«æ‰§è¡Œï¼Œå¯¼è‡´500å“åº”æ²¡æœ‰CORSå¤´
- **ä¿®å¤**: æ·»åŠ CORSExceptionMiddlewareåœ¨CORSMiddlewareä¹‹å‰æ•è·å¼‚å¸¸ï¼Œç¡®ä¿å¼‚å¸¸å“åº”ä¹ŸåŒ…å«CORSå¤´
- **æœ¬StoryéªŒè¯**: 500é”™è¯¯å“åº”å¿…é¡»åŒ…å«`Access-Control-Allow-Origin: app://obsidian.md`å¤´

---

## Story

**As a** Obsidian Canvas Learning Systemç”¨æˆ·,
**I want** å½“Agentç«¯ç‚¹å‘ç”Ÿ500é”™è¯¯æ—¶ä¹Ÿèƒ½çœ‹åˆ°å…·ä½“é”™è¯¯ä¿¡æ¯,
**so that** æˆ‘å¯ä»¥ç†è§£é—®é¢˜åŸå› å¹¶æŠ¥å‘ŠBugï¼Œè€Œä¸æ˜¯çœ‹åˆ°æ¨¡ç³Šçš„"ç½‘ç»œé”™è¯¯"ã€‚

---

## Acceptance Criteria

### AC 1: 500é”™è¯¯å“åº”åŒ…å«CORSå¤´ (éªŒè¯æ ¸å¿ƒé—®é¢˜ä¿®å¤)
- å½“ä»»ä½•Agentç«¯ç‚¹æŠ›å‡ºæœªå¤„ç†å¼‚å¸¸æ—¶ï¼Œå“åº”å¿…é¡»åŒ…å«:
  - `Access-Control-Allow-Origin: app://obsidian.md`
  - `Access-Control-Allow-Credentials: true`
- **Epicå…³è”**: ç›´æ¥éªŒè¯CORSå¤´ç¼ºå¤±é—®é¢˜çš„ä¿®å¤

### AC 2: é”™è¯¯å“åº”åŒ…å«ç»“æ„åŒ–é”™è¯¯ä¿¡æ¯
- 500é”™è¯¯å“åº”ä½“å¿…é¡»åŒ…å«:
  - `code`: HTTPçŠ¶æ€ç  (500)
  - `message`: é”™è¯¯æè¿°å­—ç¬¦ä¸²
  - `error_type`: å¼‚å¸¸ç±»å‹åç§° (å¦‚ `ValueError`, `KeyError`) - å¯é€‰æ‰©å±•å­—æ®µ
- å“åº”æ ¼å¼ç¬¦åˆ `specs/data/error-response.schema.json`
- **Epicå…³è”**: æ”¯æŒStory 21.5.5æ’ä»¶æ˜¾ç¤ºå…·ä½“é”™è¯¯
- **SDDå¯¹é½**: å­—æ®µåç§°ä¸ JSON Schema ä¿æŒä¸€è‡´ (POéªŒè¯ä¿®å¤)

### AC 3: ä¸­é—´ä»¶é¡ºåºæ­£ç¡®
- `CORSExceptionMiddleware` å¿…é¡»åœ¨ `CORSMiddleware` ä¹‹å‰æ³¨å†Œ
- æ­£å¸¸å“åº”çš„CORSå¤„ç†ä¸å—å½±å“
- **Epicå…³è”**: ç¡®ä¿ä¸ç ´åç°æœ‰CORSåŠŸèƒ½

---

## Tasks / Subtasks

### ä»»åŠ¡1: åˆ›å»ºCORSExceptionMiddlewareç±» (AC: 1, 2)
- [ ] 1.1: åœ¨ `backend/app/main.py` ä¸­åˆ›å»º `CORSExceptionMiddleware` ç±»
  - ç»§æ‰¿è‡ª `starlette.middleware.base.BaseHTTPMiddleware`
  - å®ç° `dispatch` æ–¹æ³•æ•è·æ‰€æœ‰å¼‚å¸¸
- [ ] 1.2: å¼‚å¸¸å¤„ç†è¿”å›JSONResponse
  - çŠ¶æ€ç : 500
  - Content: `{"code": 500, "message": str(e), "error_type": type(e).__name__}`
  - Headers: åŒ…å«CORSå…è®¸å¤´

### ä»»åŠ¡2: é›†æˆä¸­é—´ä»¶åˆ°FastAPIåº”ç”¨ (AC: 3)
- [ ] 2.1: åœ¨ `CORSMiddleware` ä¹‹å‰æ·»åŠ  `CORSExceptionMiddleware`
  - ä¸­é—´ä»¶æ³¨å†Œé¡ºåº: CORSExceptionMiddleware â†’ CORSMiddleware â†’ MetricsMiddleware
- [ ] 2.2: ä½¿ç”¨ `settings.cors_origins_list` è·å–å…è®¸çš„æº
  - åŒ…å« `app://obsidian.md`

### ä»»åŠ¡3: ç¼–å†™å•å…ƒæµ‹è¯• (AC: 1, 2, 3)
- [ ] 3.1: åˆ›å»ºæµ‹è¯•æ–‡ä»¶ `backend/tests/test_cors_exception.py`
- [ ] 3.2: æµ‹è¯•åœºæ™¯:
  - æ­£å¸¸è¯·æ±‚ä»æœ‰CORSå¤´
  - 500é”™è¯¯è¯·æ±‚æœ‰CORSå¤´
  - é”™è¯¯å“åº”åŒ…å« `code`, `message` å’Œ `error_type`
- [ ] 3.3: æµ‹è¯•ä¸­é—´ä»¶é¡ºåº

### ä»»åŠ¡4: é›†æˆæµ‹è¯•éªŒè¯ (AC: 1)
- [ ] 4.1: æ‰‹åŠ¨æµ‹è¯•: å¯åŠ¨åç«¯ï¼Œè§¦å‘500é”™è¯¯
- [ ] 4.2: ä½¿ç”¨curléªŒè¯å“åº”å¤´:
  ```bash
  curl -v http://localhost:8002/api/v1/agents/explain/memory \
    -H "Origin: app://obsidian.md" \
    -H "Content-Type: application/json" \
    -d '{"canvas_name": "nonexistent.canvas", "node_id": "test"}'
  ```
- [ ] 4.3: éªŒè¯å“åº”åŒ…å« `Access-Control-Allow-Origin` å¤´

---

## Dev Notes

### æ¶æ„ä¸Šä¸‹æ–‡

**é”™è¯¯å¤„ç†æµç¨‹** [Source: docs/prd/EPIC-21.5-AGENT-RELIABILITY-FIX.md#æŠ€æœ¯æ¶æ„]

å½“å‰é—®é¢˜: FastAPIçš„å¼‚å¸¸å¤„ç†åœ¨CORSMiddlewareä¹‹å¤–ï¼Œå¯¼è‡´500é”™è¯¯ä¸ç»è¿‡CORSå¤„ç†ã€‚

ä¿®å¤åæµç¨‹:
```
è¯·æ±‚ â†’ CORSExceptionMiddleware â†’ CORSMiddleware â†’ ä¸šåŠ¡é€»è¾‘
                â†“ (æ•è·å¼‚å¸¸)
          JSONResponse + CORSå¤´ â† è¿”å›
```

### å®ç°å‚è€ƒ

**CORSExceptionMiddlewareå®ç°** [Source: docs/prd/EPIC-21.5-AGENT-RELIABILITY-FIX.md:166-188]

```python
# âœ… Verified from Context7:/websites/fastapi_tiangolo (topic: BaseHTTPMiddleware)
from starlette.middleware.base import BaseHTTPMiddleware
from fastapi import Request
from fastapi.responses import JSONResponse

class CORSExceptionMiddleware(BaseHTTPMiddleware):
    """ç¡®ä¿500é”™è¯¯ä¹Ÿè¿”å›CORSå¤´çš„ä¸­é—´ä»¶"""

    async def dispatch(self, request: Request, call_next):
        try:
            response = await call_next(request)
            return response
        except Exception as e:
            # âœ… Verified from Context7:/websites/fastapi_tiangolo (topic: JSONResponse)
            # âœ… SDD Aligned: specs/data/error-response.schema.json (POéªŒè¯ä¿®å¤)
            return JSONResponse(
                status_code=500,
                content={
                    "code": 500,                    # Required by JSON Schema
                    "message": str(e),              # Required by JSON Schema
                    "error_type": type(e).__name__  # Extension field
                },
                headers={
                    "Access-Control-Allow-Origin": "app://obsidian.md",
                    "Access-Control-Allow-Credentials": "true",
                }
            )
```

**ä¸­é—´ä»¶æ³¨å†Œé¡ºåº** [Source: backend/app/main.py:137-149]

å½“å‰ `main.py` ä¸­é—´ä»¶é¡ºåº:
```python
app.add_middleware(CORSMiddleware, ...)
app.add_middleware(MetricsMiddleware)
```

ä¿®æ”¹å:
```python
# å¼‚å¸¸å¤„ç†ä¸­é—´ä»¶å¿…é¡»åœ¨CORSä¹‹å‰
app.add_middleware(CORSExceptionMiddleware)
app.add_middleware(CORSMiddleware, ...)
app.add_middleware(MetricsMiddleware)
```

**CORSé…ç½®å¼•ç”¨** [Source: backend/app/config.py:83-86]

```python
CORS_ORIGINS: str = Field(
    default="http://localhost:3000,http://127.0.0.1:3000,app://obsidian.md",
    description="Allowed CORS origins (comma-separated)"
)
```

### Dependencies Verification

**å‰ç½®ä¾èµ–éªŒè¯**:
- [x] `backend/app/main.py` å·²éªŒè¯å­˜åœ¨ - FastAPIåº”ç”¨å…¥å£
- [x] `backend/app/config.py` å·²éªŒè¯å­˜åœ¨ - Settingsç±»åŒ…å«CORSé…ç½®
- [x] `starlette.middleware.base.BaseHTTPMiddleware` - Starletteå†…ç½®ç±»
- [x] `fastapi.responses.JSONResponse` - FastAPIå†…ç½®å“åº”ç±»
- [x] æ— Storyä¾èµ– - è¿™æ˜¯Epic 21.5çš„ç¬¬ä¸€ä¸ªStory

**æŠ€æœ¯æ ˆéªŒè¯**:
- [x] FastAPI >= 0.100.0 - æ”¯æŒBaseHTTPMiddleware
- [x] Starlette >= 0.27.0 - ä¸­é—´ä»¶åŸºç±»

### Testing Standards

**æµ‹è¯•æ–‡ä»¶ä½ç½®**: `backend/tests/test_cors_exception.py`

**æµ‹è¯•æ¡†æ¶** [Source: docs/architecture/coding-standards.md]:
- pytest + pytest-asyncio
- httpx.AsyncClient ç”¨äºæµ‹è¯•HTTPè¯·æ±‚

**æµ‹è¯•ç”¨ä¾‹è§„æ ¼**:
```python
import pytest
from httpx import AsyncClient
from app.main import app

@pytest.mark.asyncio
async def test_500_error_has_cors_headers():
    """éªŒè¯500é”™è¯¯å“åº”åŒ…å«CORSå¤´"""
    async with AsyncClient(app=app, base_url="http://test") as client:
        # è§¦å‘ä¸€ä¸ªä¼šå¯¼è‡´500çš„è¯·æ±‚
        response = await client.post(
            "/api/v1/agents/explain/memory",
            json={"canvas_name": "nonexistent", "node_id": "test"},
            headers={"Origin": "app://obsidian.md"}
        )
        # å³ä½¿æ˜¯500ï¼Œä¹Ÿåº”æœ‰CORSå¤´
        assert "access-control-allow-origin" in response.headers
        assert response.headers["access-control-allow-origin"] == "app://obsidian.md"

@pytest.mark.asyncio
async def test_error_response_structure():
    """éªŒè¯é”™è¯¯å“åº”åŒ…å«code, messageå’Œerror_type (SDDå¯¹é½)"""
    async with AsyncClient(app=app, base_url="http://test") as client:
        response = await client.post(
            "/api/v1/agents/explain/memory",
            json={"canvas_name": "nonexistent", "node_id": "test"}
        )
        if response.status_code == 500:
            data = response.json()
            # SDD Aligned: specs/data/error-response.schema.json
            assert "code" in data
            assert data["code"] == 500
            assert "message" in data
            assert "error_type" in data  # Extension field
```

### Related Documentation

**Epicå’ŒStoryæ–‡æ¡£**:
- [Epic 21.5 PRD](../prd/EPIC-21.5-AGENT-RELIABILITY-FIX.md) - å®Œæ•´é—®é¢˜åˆ†æå’Œè§£å†³æ–¹æ¡ˆ

**æ¶æ„æ–‡æ¡£** [Source: docs/architecture/]:
- [coding-standards.md](../architecture/coding-standards.md) - ç¼–ç è§„èŒƒ
- [ADR-009-ERROR-HANDLING-RETRY-STRATEGY.md](../architecture/decisions/ADR-009-ERROR-HANDLING-RETRY-STRATEGY.md) - é”™è¯¯å¤„ç†ç­–ç•¥

**SDDè§„èŒƒ**:
- [error-response.schema.json](../../specs/data/error-response.schema.json) - é”™è¯¯å“åº”ç»“æ„
- [agent-api.openapi.yml](../../specs/api/agent-api.openapi.yml) - Agent APIè§„èŒƒ

**æºä»£ç ä½ç½®**:
- `backend/app/main.py` - éœ€è¦ä¿®æ”¹ï¼Œæ·»åŠ CORSExceptionMiddleware
- `backend/app/config.py` - åªè¯»å¼•ç”¨ï¼Œè·å–CORSé…ç½®

---

## SDDè§„èŒƒå¼•ç”¨

- **OpenAPI Spec**: `specs/api/agent-api.openapi.yml#/components/schemas/Error`
- **JSON Schema**: `specs/data/error-response.schema.json`
- **æ¶æ„æ–‡æ¡£**: `docs/prd/EPIC-21.5-AGENT-RELIABILITY-FIX.md`

## ADRå…³è”

- **ADR-009**: Error Handling and Retry Strategy - é”™è¯¯å“åº”æ ¼å¼å‚è€ƒ

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-14 | 1.0 | åˆå§‹Storyåˆ›å»º (from Epic 21.5) | SM Agent (Bob) |
| 2025-12-14 | 1.1 | SDDå¯¹é½ä¿®å¤: é”™è¯¯å“åº”å­—æ®µå `detail`â†’`message`, æ·»åŠ `code` | PO Agent (Sarah) |
| 2025-12-14 | 1.2 | QA Reviewå®Œæˆ, Gate: CONCERNS | QA Agent (Quinn) |
| 2025-12-14 | 1.3 | æµ‹è¯•æ–‡ä»¶åˆ›å»ºå®Œæˆ, Schemaä¿®å¤, Gate: PASS | QA Agent (Quinn) |

---

## QA Results

**Review Date**: 2025-12-14
**Reviewer**: Quinn (Test Architect)
**Gate Decision**: âœ… PASS
**Quality Score**: 95/100

### Gate Summary

All acceptance criteria verified with **comprehensive test coverage**. The `CORSExceptionMiddleware` is properly implemented in `backend/app/main.py:140-198` with correct middleware ordering. Test file `backend/tests/test_cors_exception.py` created with 24 test cases. JSON Schema updated to include `error_type` field.

### Resolved Issues

| ID | Original Issue | Resolution |
|----|----------------|------------|
| ISSUE-001 | Missing test file | âœ… Created `backend/tests/test_cors_exception.py` with 24 tests |
| ISSUE-002 | SDD Schema violation | âœ… Updated `specs/data/error-response.schema.json` with `error_type` field |

### AC Traceability

| AC | Status | Evidence |
|----|--------|----------|
| AC-1: 500é”™è¯¯å“åº”åŒ…å«CORSå¤´ | âœ… Verified | `main.py:181-192` + `test_cors_exception.py::TestAC1_500ErrorCORSHeaders` (7 tests) |
| AC-2: é”™è¯¯å“åº”åŒ…å«ç»“æ„åŒ–ä¿¡æ¯ | âœ… Verified | `main.py:183-187` + `test_cors_exception.py::TestAC2_ErrorResponseStructure` (7 tests) |
| AC-3: ä¸­é—´ä»¶é¡ºåºæ­£ç¡® | âœ… Verified | `main.py:195-215` + `test_cors_exception.py::TestAC3_MiddlewareOrder` (4 tests) |

### Test Coverage

| æµ‹è¯•ç±» | æµ‹è¯•æ•° | çŠ¶æ€ |
|--------|--------|------|
| `TestAC1_500ErrorCORSHeaders` | 7 | âœ… PASS |
| `TestAC2_ErrorResponseStructure` | 7 | âœ… PASS |
| `TestAC3_MiddlewareOrder` | 4 | âœ… PASS |
| `TestMainAppCORSException` | 2 | âœ… PASS |
| `TestCORSExceptionEdgeCases` | 4 | âœ… PASS |
| **Total** | **24** | **âœ… ALL PASS** |

### NFR Assessment

| Aspect | Status | Notes |
|--------|--------|-------|
| Security | âœ… PASS | Origin validation prevents arbitrary CORS access |
| Performance | âœ… PASS | Minimal overhead on success path |
| Reliability | âœ… PASS | Exception logging ensures visibility |
| Maintainability | âœ… PASS | Comprehensive test coverage ensures safe refactoring |

### Completed Actions

1. âœ… Created `backend/tests/test_cors_exception.py` with 24 test cases
2. âœ… Updated `specs/data/error-response.schema.json` to include `error_type` field

### Future Recommendations

1. Add integration test triggering real 500 error from Agent endpoint
2. Add contract test to validate error response against schema

### Gate File

`docs/qa/gates/21.5.1-cors-exception-fix.yml`
