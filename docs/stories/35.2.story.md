# Story 35.2: 多模态查询/搜索API端点

**Status**: Done

---

## Epic Context & Background

**所属Epic**: EPIC-35 - 多模态功能完整激活 (Multimodal Activation)
**Epic文档**: [EPIC-35-MULTIMODAL-ACTIVATION.md](../epics/EPIC-35-MULTIMODAL-ACTIVATION.md)

**本Story在Epic中的定位**:
- Epic 35 Phase 1 (P0 基础层) 的第二个Story
- 与Story 35.1并行开发，提供查询和搜索API端点
- **依赖**: 无前置Story依赖 (与35.1可并行，共用multimodal路由模块)
- **被依赖**: Story 35.3 (ApiClient集成)需要本Story的API端点

**Epic核心问题回顾**:

### 问题: 多模态查询功能无法通过API暴露

- **现象**: MultimodalStore已有`get_by_concept()`, `search()`, `list_by_type()`方法，但无REST API端点
- **根因**: 缺少查询/搜索端点连接前端和后端存储层
- **修复**: 创建查询端点，响应格式匹配前端MediaItem接口，支持向量相似度搜索
- **本Story验证**: 通过API测试验证按概念查询、向量搜索、分页列表操作

---

## Story

**As a** Canvas Learning System用户,
**I want** 通过API查询和搜索与概念关联的多模态内容,
**so that** 我可以快速找到与学习主题相关的图片、PDF、音频和视频资源。

---

## Acceptance Criteria

### AC 35.2.1: GET /api/v1/multimodal/by-concept/{concept_id} 按概念查询 (验证Epic核心问题)

- 接受路径参数 `concept_id` (必填)
- 支持查询参数:
  - `media_type`: 可选，过滤媒体类型 (image/pdf/audio/video)
  - `limit`: 可选，默认100，最大200
- 响应格式匹配前端 `MediaItem[]` 接口:
  ```json
  {
    "items": [
      {
        "id": "uuid",
        "type": "image",
        "path": "/vault/images/xxx.png",
        "title": "公式截图",
        "relevanceScore": 1.0,
        "conceptId": "concept-123",
        "metadata": {...},
        "thumbnail": "base64..."
      }
    ],
    "total": 5
  }
  ```
- 调用已有 `MultimodalStore.get_by_concept()` 方法
- **返回200 OK成功**
- 返回404如果概念不存在
- **Epic关联**: 支持MediaPanel按概念显示内容

### AC 35.2.2: POST /api/v1/multimodal/search 向量搜索 (验证Epic核心问题)

- 接受 `application/json` 请求
- 请求体:
  ```json
  {
    "query": "逆否命题相关的图表",
    "media_types": ["image", "pdf"],
    "top_k": 10,
    "min_score": 0.5
  }
  ```
- 内部流程:
  1. 使用embedding模型将query转换为768维向量
  2. 调用 `MultimodalStore.search()` 进行向量相似度搜索
  3. 按相似度分数排序返回结果
- 响应格式:
  ```json
  {
    "items": [
      {
        "id": "uuid",
        "type": "image",
        "path": "/vault/images/xxx.png",
        "title": "逻辑关系图",
        "relevanceScore": 0.89,
        "conceptId": "concept-123",
        "metadata": {...},
        "thumbnail": "base64..."
      }
    ],
    "total": 3,
    "query_processed": true
  }
  ```
- **返回200 OK成功**
- 返回400如果query为空或无效
- **Epic关联**: 支持语义搜索找到相关学习材料

### AC 35.2.3: GET /api/v1/multimodal/list 分页列表 (验证Epic核心问题)

- 支持查询参数:
  - `media_type`: 可选，过滤媒体类型
  - `page`: 可选，默认1
  - `page_size`: 可选，默认20，最大100
  - `sort_by`: 可选，排序字段 (created_at/updated_at)，默认created_at
  - `sort_order`: 可选，排序方向 (asc/desc)，默认desc
- 响应格式匹配前端分页标准:
  ```json
  {
    "items": [...],
    "pagination": {
      "total": 150,
      "page": 1,
      "page_size": 20,
      "total_pages": 8,
      "has_next": true,
      "has_prev": false
    }
  }
  ```
- **返回200 OK成功**
- **Epic关联**: 支持MediaPanel分页浏览

### AC 35.2.4: 响应格式匹配前端MediaItem接口 (验证Epic核心问题)

- 所有查询端点的响应必须匹配前端TypeScript接口:
  ```typescript
  interface MediaItem {
    id: string;
    type: 'image' | 'pdf' | 'audio' | 'video';
    path: string;
    title?: string;
    relevanceScore: number;
    conceptId?: string;
    metadata?: Record<string, any>;
    thumbnail?: string;  // base64 encoded
  }
  ```
- 字段映射规则:
  - `id` ← `MultimodalContent.id`
  - `type` ← `MultimodalContent.media_type.value`
  - `path` ← `MultimodalContent.file_path`
  - `title` ← `MultimodalContent.description` (截取前50字符)
  - `relevanceScore` ← 向量搜索分数 (0-1) 或 1.0 (精确查询)
  - `conceptId` ← `MultimodalContent.related_concept_id`
  - `metadata` ← `MultimodalContent.metadata`
  - `thumbnail` ← 从 `thumbnail_path` 读取并base64编码 (可选)
- **Epic关联**: 确保前后端数据格式一致

---

## Tasks / Subtasks

### 任务1: 扩展multimodal路由模块 - 查询端点 (AC: 1, 3, 4)

- [ ] 1.1: 在 `backend/app/api/v1/endpoints/multimodal.py` 添加查询端点
      - 实现 `get_by_concept()` 端点
      - 实现 `list_all()` 端点
      - 使用依赖注入获取MultimodalStore
- [ ] 1.2: 实现 `to_media_item()` 转换函数
      - MultimodalContent → MediaItem 字段映射
      - thumbnail base64编码 (可选加载)
      - relevanceScore 默认值处理
- [ ] 1.3: 实现分页逻辑
      - 计算total_pages, has_next, has_prev
      - 支持offset/limit转换
      - 复用已有 `pagination-meta.schema.json` 定义

### 任务2: 实现向量搜索端点 (AC: 2, 4)

- [ ] 2.1: 创建搜索端点 `search_multimodal()`
      - 接受SearchRequest模型
      - 调用embedding服务生成query向量
      - 调用MultimodalStore.search()
- [ ] 2.2: 集成embedding服务
      - 复用已有 `text-embedding-3-small` 配置
      - 处理embedding生成失败的fallback
- [ ] 2.3: 实现搜索结果处理
      - 按relevanceScore排序
      - 应用min_score过滤
      - 转换为MediaItem格式

### 任务3: Pydantic请求/响应模型 (AC: 1, 2, 3, 4)

- [ ] 3.1: 创建 `MediaItemResponse` 模型
      - 匹配前端MediaItem接口
      - 添加字段验证器
      - 支持thumbnail可选加载
- [ ] 3.2: 创建 `MultimodalSearchRequest` 模型
      - query: str (必填)
      - media_types: Optional[List[MediaType]]
      - top_k: int = 10
      - min_score: float = 0.5
- [ ] 3.3: 创建 `MultimodalListResponse` 模型
      - items: List[MediaItemResponse]
      - pagination: PaginationMeta
- [ ] 3.4: 创建 `MultimodalByConceptResponse` 模型
      - items: List[MediaItemResponse]
      - total: int
- [ ] 3.5: 更新 `backend/app/models/__init__.py` 导出新模型

### 任务4: 业务服务层扩展 (AC: 1, 2, 3)

- [ ] 4.1: 扩展 `MultimodalService` 类
      - 添加 `get_by_concept()` 方法
      - 添加 `search()` 方法
      - 添加 `list_all()` 方法
      - **注意**: 现有 `MultimodalStore.list_by_type()` 仅支持单一类型过滤，不支持排序。
        `list_all()` 服务方法需要：
        1. 当 `media_type=None` 时，聚合所有类型的结果
        2. 实现内存排序 (sort_by: created_at/updated_at, sort_order: asc/desc)
        3. 使用 `MultimodalStore.count()` 获取总数用于分页计算
- [ ] 4.2: 实现thumbnail加载逻辑
      - 按需从文件系统读取
      - Base64编码
      - 缓存策略 (可选)
- [ ] 4.3: 实现embedding生成服务调用
      - 复用 `src/agentic_rag/embedding/` 模块
      - 错误处理和重试

### 任务5: 错误处理和测试 (AC: 1, 2, 3, 4)

- [ ] 5.1: 实现错误处理
      - 概念不存在 (404)
      - 无效搜索参数 (400)
      - embedding服务失败 (503)
      - 使用ADR-009错误码体系
      - **错误码映射**:
        - Embedding服务超时/失败使用 `ErrorCode.NETWORK_TIMEOUT (4001)`
        - 文件系统错误 (thumbnail读取) 使用 `ErrorCode.FILE_NOT_FOUND (3001)`
        - 参考ADR-009: EMBEDDING重试配置 (2次重试，2秒间隔)
- [ ] 5.2: 创建单元测试 `backend/tests/unit/test_multimodal_query_service.py`
      - 测试get_by_concept逻辑
      - 测试search逻辑
      - 测试分页计算
- [ ] 5.3: 创建API测试 `backend/tests/api/v1/endpoints/test_multimodal_query.py`
      - 测试3个查询端点
      - 测试响应格式符合MediaItem
      - 测试分页和过滤
      - 测试错误响应

### 任务6: OpenAPI规范更新 (AC: 1, 2, 3, 4)

- [ ] 6.1: 更新 `specs/api/fastapi-backend-api.openapi.yml`
      - 添加3个查询端点定义
      - 添加请求/响应schema
      - 添加Multimodal tag描述
- [ ] 6.2: 创建/更新 `specs/data/multimodal-query.schema.json`
      - MediaItemResponse schema
      - MultimodalSearchRequest schema
      - MultimodalListResponse schema
- [ ] 6.3: 验证生成的Swagger文档与规范匹配

---

## Dev Notes

### SDD规范参考 (必填)

**API端点** (需在OpenAPI中新增):

| 端点 | 方法 | 规范位置 (待添加) |
|------|------|-------------------|
| `/api/v1/multimodal/by-concept/{concept_id}` | GET | `specs/api/fastapi-backend-api.openapi.yml` |
| `/api/v1/multimodal/search` | POST | `specs/api/fastapi-backend-api.openapi.yml` |
| `/api/v1/multimodal/list` | GET | `specs/api/fastapi-backend-api.openapi.yml` |

**数据Schema引用**:

| Schema | 来源 | 用途 |
|--------|------|------|
| MultimodalContent | `specs/data/multimodal-content.schema.json` | 后端数据模型 |
| PaginationMeta | `specs/data/pagination-meta.schema.json` | 分页元数据 |
| MediaItem | `canvas-progress-tracker/obsidian-plugin/src/components/MediaPanel.ts:30` | 前端接口定义 |

**MultimodalContent Schema关键字段** [Source: specs/data/multimodal-content.schema.json]:
```json
{
  "required": ["id", "media_type", "file_path", "related_concept_id", "created_at"],
  "properties": {
    "id": {"type": "string", "format": "uuid"},
    "media_type": {"enum": ["image", "pdf", "audio", "video"]},
    "file_path": {"type": "string"},
    "thumbnail_path": {"type": ["string", "null"]},
    "description": {"type": ["string", "null"]},
    "vector": {"type": ["array", "null"], "items": {"type": "number"}, "minItems": 768, "maxItems": 768},
    "related_concept_id": {"type": "string"},
    "metadata": {"type": "object"}
  }
}
```

**前端MediaItem接口** [Source: MediaPanel.ts:30-45]:
```typescript
export interface MediaItem {
    id: string;
    type: Exclude<MediaType, 'all'>;  // 'image' | 'pdf' | 'audio' | 'video'
    path: string;
    title?: string;
    relevanceScore: number;           // 0-1
    conceptId?: string;
    metadata?: Record<string, any>;
    thumbnail?: string;               // base64 encoded
}
```

### ADR决策关联 (必填)

| ADR编号 | 决策标题 | 对Story的影响 |
|---------|----------|---------------|
| ADR-008 | 测试框架选型 - pytest生态系统 | 使用pytest-asyncio测试异步端点 |
| ADR-009 | 错误处理与重试策略 | 搜索端点需使用ErrorCode体系 |

**关键约束** (从ADR Consequences提取):

- **ADR-008**: 测试需使用`@pytest.mark.asyncio`装饰器，API测试使用httpx AsyncClient [Source: ADR-008]
- **ADR-009**: 错误码使用3xxx (文件相关)、4xxx (网络相关)，搜索失败使用503状态码 [Source: ADR-009]
- **ADR-009**: Embedding服务调用需使用tenacity重试策略 (EMBEDDING配置: 2次重试，2秒间隔) [Source: ADR-009]

### MultimodalStore API参考

**已有方法签名** [Source: src/agentic_rag/storage/multimodal_store.py]:

```python
class MultimodalStore:
    async def get_by_concept(
        self,
        concept_id: str,
        media_type: Optional[MediaType] = None,
    ) -> list[MultimodalContent]:
        """Get all content associated with a concept."""

    async def search(
        self,
        query_vector: list[float],
        media_types: Optional[list[MediaType]] = None,
        top_k: int = 10,
        min_score: float = 0.5,
    ) -> list[tuple[MultimodalContent, float]]:
        """Search content by vector similarity. Returns (content, score) tuples."""

    async def list_by_type(
        self,
        media_type: MediaType,
        limit: int = 100,
        offset: int = 0,
    ) -> list[MultimodalContent]:
        """List content by media type."""

    async def count(
        self,
        media_type: Optional[MediaType] = None,
        concept_id: Optional[str] = None,
    ) -> int:
        """Count content items."""
```

### API端点模式参考

**端点实现模式** [Source: backend/app/api/v1/endpoints/agents.py]:
```python
from fastapi import APIRouter, Depends, HTTPException, Query
from typing import Annotated, Optional, List

router = APIRouter(
    prefix="/multimodal",
    tags=["Multimodal"],
)

# 依赖注入
MultimodalStoreDep = Annotated[MultimodalStore, Depends(get_multimodal_store)]
MultimodalServiceDep = Annotated[MultimodalService, Depends(get_multimodal_service)]

@router.get("/by-concept/{concept_id}")
async def get_by_concept(
    concept_id: str,
    store: MultimodalStoreDep,
    media_type: Optional[str] = Query(None),
    limit: int = Query(100, ge=1, le=200),
) -> MultimodalByConceptResponse:
    ...
```

### 字段映射实现参考

**MultimodalContent → MediaItem 转换** (Task 1.2):
```python
def to_media_item(
    content: MultimodalContent,
    score: float = 1.0,
    include_thumbnail: bool = False
) -> MediaItemResponse:
    """Convert MultimodalContent to frontend MediaItem format."""
    thumbnail = None
    if include_thumbnail and content.thumbnail_path:
        thumbnail = load_thumbnail_base64(content.thumbnail_path)

    return MediaItemResponse(
        id=content.id,
        type=content.media_type.value,
        path=content.file_path,
        title=content.description[:50] if content.description else None,
        relevanceScore=score,
        conceptId=content.related_concept_id,
        metadata=content.metadata,
        thumbnail=thumbnail,
    )
```

### Security Considerations

**读取端点安全策略**:
- 所有查询端点为只读操作，无数据修改风险
- 依据现有API模式，无需身份验证 (与agents、health等端点一致)
- **注意**: search端点调用embedding服务产生API成本，建议考虑:
  - 速率限制 (rate limiting) 防止滥用
  - 请求队列或节流机制
  - 监控embedding调用频率

### Testing Standards

**测试文件位置**:
- 单元测试: `backend/tests/unit/test_multimodal_query_service.py`
- API测试: `backend/tests/api/v1/endpoints/test_multimodal_query.py`

**测试模式** [Source: ADR-008]:
```python
import pytest
from httpx import AsyncClient
from unittest.mock import AsyncMock, patch

@pytest.fixture
def mock_multimodal_store():
    store = AsyncMock(spec=MultimodalStore)
    store.get_by_concept.return_value = [mock_content]
    store.search.return_value = [(mock_content, 0.89)]
    return store

@pytest.mark.asyncio
async def test_get_by_concept(client: AsyncClient, mock_multimodal_store):
    response = await client.get(
        "/api/v1/multimodal/by-concept/concept-123"
    )
    assert response.status_code == 200
    data = response.json()
    assert "items" in data
    assert all(item["type"] in ["image", "pdf", "audio", "video"] for item in data["items"])

@pytest.mark.asyncio
async def test_search_multimodal(client: AsyncClient, mock_multimodal_store):
    response = await client.post(
        "/api/v1/multimodal/search",
        json={"query": "逆否命题图表", "top_k": 5}
    )
    assert response.status_code == 200
    data = response.json()
    assert "items" in data
    assert all(0 <= item["relevanceScore"] <= 1 for item in data["items"])
```

**测试覆盖要求**:
- 覆盖率目标: ≥80%
- 必须测试: 成功响应、错误响应、边界条件、分页逻辑
- 使用pytest-cov生成覆盖率报告

### Related Documentation

**Epic和Story文档**:
- [Epic 35文档](../epics/EPIC-35-MULTIMODAL-ACTIVATION.md) - Epic背景和问题定义
- [Story 35.1](./35.1.story.md) - 上传/管理API端点 (并行开发)

**架构文档** [Source: docs/architecture/]:
- [coding-standards.md](../architecture/coding-standards.md) - 编码标准
- [project-structure.md](../architecture/project-structure.md) - 项目结构

**SDD规范**:
- [multimodal-content.schema.json](../../specs/data/multimodal-content.schema.json) - 数据模型Schema
- [pagination-meta.schema.json](../../specs/data/pagination-meta.schema.json) - 分页Schema
- [fastapi-backend-api.openapi.yml](../../specs/api/fastapi-backend-api.openapi.yml) - API规范 (待更新)

**源代码位置**:
- `src/agentic_rag/storage/multimodal_store.py:233-313` - get_by_concept, search方法
- `canvas-progress-tracker/obsidian-plugin/src/components/MediaPanel.ts:30-45` - MediaItem接口
- `backend/app/api/v1/endpoints/multimodal.py` - 端点实现 (Story 35.1创建)

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-20 | 1.0 | 初始创建 - 基于Epic 35和Story Template v2 | Bob (SM Agent) |
| 2026-01-20 | 1.1 | 验证后改进: Task 4.1添加list_all()实现细节, 新增Security Considerations, Task 5.1补充错误码映射 | Sarah (PO Agent) |

---

## Dev Agent Record

### Agent Model Used
(待Dev Agent填写)

### Debug Log References
(待Dev Agent填写)

### Completion Notes List
(待Dev Agent填写)

### File List
(待Dev Agent填写)

---

## QA Results

### Review Date: 2026-01-27

### Reviewer: Quinn (Test Architect & Quality Advisor)

### Gate Decision: ✅ PASS

### Acceptance Criteria Verification

| AC | Description | Status | Evidence |
|----|-------------|--------|----------|
| 35.2.1 | GET /by-concept/{concept_id} | ✅ PASS | Endpoint in multimodal.py, response model MultimodalByConceptResponse |
| 35.2.2 | POST /search (vector similarity) | ✅ PASS | MultimodalSearchRequest with validation, E2E tests verify relevance |
| 35.2.3 | GET /list (paginated) | ✅ PASS | PaginationMeta schema with all fields, MultimodalPaginatedListResponse |
| 35.2.4 | MediaItem interface match | ✅ PASS | MediaItemResponse matches TypeScript interface (MediaPanel.ts:30-45) |

### Test Coverage

| Test Type | File | Status |
|-----------|------|--------|
| Unit Tests | `backend/tests/api/v1/endpoints/test_multimodal.py` | ✅ ~679 lines |
| E2E Tests | `backend/tests/e2e/test_multimodal_workflow.py` | ✅ ~941 lines |

### Code Quality Assessment

**Strengths**:
- ✅ All Pydantic models have docstrings with source references
- ✅ Proper field validation with `Field()` constraints (ge, le, min_length, max_length)
- ✅ ConfigDict(from_attributes=True) for ORM compatibility
- ✅ OpenAPI spec complete at `specs/api/multimodal-api.openapi.yml` (843 lines)
- ✅ Router registered with appropriate error responses (413, 415, 500)

**Implementation Files Verified**:
- `backend/app/models/multimodal_schemas.py` - Lines 218-346 (Query/Search schemas)
- `backend/app/api/v1/endpoints/multimodal.py` - Query endpoints
- `backend/app/api/v1/router.py:183-192` - Router registration

### Risk Assessment: LOW

No blocking issues identified. Implementation follows project patterns and ADR decisions.

### Gate File

`docs/qa/gates/35.2-multimodal-query-search-api.yml`
