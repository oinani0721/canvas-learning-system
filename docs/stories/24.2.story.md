# Story 24.2: Multi-Review Trend Analysis & History Query Integration

## Status
- [x] Draft
- [ ] Ready for Dev
- [ ] In Progress
- [ ] QA Review
- [ ] Done

---

## Epic Context & Background

**Epic ID**: EPIC-24
**Epic Title**: Verification Canvas Redesign
**Story Priority**: P0 (Critical)
**Estimated Points**: 5

**Epic Objective**: Redesign the verification canvas (检验白板) generation system to support dual review modes (fresh/targeted), integrate with Graphiti for history tracking, and improve the overall generation workflow.

**This Story's Role**: Story 24.2 implements the multi-review trend analysis feature and the `query_review_history_from_graphiti` tool, enabling users to track progress across multiple verification canvas sessions for the same original canvas.

**Dependencies**:
- Story 24.1 (Mode Parameter Support) - Must be completed first
- Epic 22 (Memory System) - Completed
- Epic 23 (RAG Intelligent Inference) - Completed

---

## Story Overview

**As a** Canvas Learning System user,
**I want** to view trend analysis across multiple verification sessions for the same canvas,
**So that** I can understand my learning progress over time, identify persistent weak concepts, and see my overall improvement trajectory.

---

## Acceptance Criteria

### AC1: Multi-Review Progress Endpoint Implementation
- **Given**: Multiple verification canvases have been generated from the same original canvas
- **When**: A request is made to `GET /review/progress/multi/{original_canvas_path}`
- **Then**: The system returns aggregated progress data for all review sessions
- **Verification**: API returns MultiReviewProgressResponse per specs/api/review-api.openapi.yml#L346-378

### AC2: Review History Query from Graphiti
- **Given**: The system has stored review canvas relationships in Graphiti (Story 24.1)
- **When**: The `query_review_history_from_graphiti()` method is called with an original canvas path
- **Then**:
  - System queries Neo4j for all `(ReviewCanvas)-[:GENERATED_FROM]->(OriginalCanvas)` relationships
  - Results are ordered by generation date (newest first)
  - Each result includes: review_canvas_path, date, mode, pass_rate
- **Verification**: Cypher query executes successfully and returns correct relationship data

### AC3: Pass Rate Trend Calculation
- **Given**: Multiple review sessions exist with scored answer nodes
- **When**: Trend analysis is requested
- **Then**:
  - System calculates pass_rate for each session (passed_concepts / total_concepts)
  - Returns pass_rate_trend array with date and pass_rate for each session
  - Trend direction (up/stable/down) is computed based on last 3 sessions
- **Verification**: Pass rate values are between 0 and 1; trend direction is correctly calculated

### AC4: Weak Concepts Improvement Tracking
- **Given**: Historical weak concepts have been identified across review sessions
- **When**: Trend analysis includes weak concept data
- **Then**:
  - System identifies concepts that scored < 60 in any previous session
  - Calculates improvement_rate = (current_score - first_score) / first_score
  - Assigns status: "weak" (< 60), "improving" (60-79), "mastered" (≥ 80)
- **Verification**: weak_concepts_improvement array contains correct concept data

### AC5: Empty History Handling
- **Given**: An original canvas has no verification canvas history
- **When**: Multi-review progress is requested
- **Then**: System returns HTTP 404 with message "No review history found for this canvas"
- **Verification**: Correct error response for canvases without review history

### AC6: Overall Progress Calculation
- **Given**: Multiple review sessions with pass rates
- **When**: Overall progress is calculated
- **Then**:
  - progress_rate = (latest_pass_rate - first_pass_rate) / first_pass_rate
  - trend_direction is "up" if progress_rate > 0.1, "down" if < -0.1, else "stable"
- **Verification**: Overall progress object contains correct progress_rate and trend_direction

---

## Dev Notes (CRITICAL - Self-Contained)

### Technical Context

This story extends the review system from Story 24.1 to support multi-session trend analysis. The key addition is the `GET /review/progress/multi/{original_canvas_path}` endpoint and the `query_review_history_from_graphiti()` method.

**Current State** (after Story 24.1):
- `ReviewService` exists with `generate_verification_canvas(mode: str)`
- Graphiti stores `(ReviewCanvas)-[:GENERATED_FROM {mode: str}]->(OriginalCanvas)` relationships
- No multi-review aggregation exists

**Target State**:
- `ReviewService.get_multi_review_progress(original_canvas_path: str)` method
- `ReviewService._query_review_history_from_graphiti(canvas_name: str)` method
- `ReviewService._calculate_trends(reviews: List[dict])` method
- New endpoint at `/review/progress/multi/{original_canvas_path}`

### API Endpoints

**Primary Endpoint**: `GET /review/progress/multi/{original_canvas_path}`
- **File**: `backend/app/api/v1/endpoints/review.py`
- **OpenAPI Spec**: `specs/api/review-api.openapi.yml#L346-378`

**Response Schema**: `MultiReviewProgressResponse` defined in OpenAPI spec at L725-805

### Data Models

**Response Structure** (from specs/api/review-api.openapi.yml#L725-805):
```json
{
  "original_canvas_path": "string",
  "review_count": "integer",
  "reviews": [
    {
      "review_canvas_path": "string",
      "date": "datetime",
      "mode": "fresh|targeted",
      "pass_rate": "number",
      "total_concepts": "integer",
      "passed_concepts": "integer"
    }
  ],
  "trends": {
    "pass_rate_trend": [
      {"date": "date", "pass_rate": "number"}
    ],
    "weak_concepts_improvement": [
      {
        "concept_name": "string",
        "improvement_rate": "number",
        "current_status": "weak|improving|mastered"
      }
    ],
    "overall_progress": {
      "progress_rate": "number",
      "trend_direction": "up|stable|down"
    }
  }
}
```

### SDD References

| Type | File | Lines | Description |
|------|------|-------|-------------|
| OpenAPI | specs/api/review-api.openapi.yml | L346-378 | multi-review endpoint definition |
| OpenAPI | specs/api/review-api.openapi.yml | L725-805 | MultiReviewProgressResponse schema |
| Schema | specs/data/review-progress-response.schema.json | Full | Single review progress |
| Behavior | specs/behavior/verification-canvas.feature | L96-105 | Historical review data scenario |

### ADR References

| ADR | Description | Relevance |
|-----|-------------|-----------|
| docs/architecture/decisions/0003-graphiti-memory.md | Graphiti integration | Neo4j queries for history |
| docs/architecture/decisions/0004-async-execution-engine.md | Async patterns | Service implementation |
| docs/architecture/ebbinghaus-review-system-architecture.md | Review system design | Progress tracking patterns |

### Implementation Guidelines

**Step 1: Create Response Model**
```python
# backend/app/models/schemas.py
from pydantic import BaseModel
from typing import List, Optional
from datetime import datetime

class ReviewSessionSummary(BaseModel):
    """Single review session summary"""
    review_canvas_path: str
    date: datetime
    mode: str  # "fresh" or "targeted"
    pass_rate: float
    total_concepts: int
    passed_concepts: int

class PassRateTrendPoint(BaseModel):
    """Single point in pass rate trend"""
    date: str  # date format
    pass_rate: float

class WeakConceptImprovement(BaseModel):
    """Weak concept improvement tracking"""
    concept_name: str
    improvement_rate: float
    current_status: str  # "weak", "improving", "mastered"

class OverallProgress(BaseModel):
    """Overall progress metrics"""
    progress_rate: float
    trend_direction: str  # "up", "stable", "down"

class TrendsData(BaseModel):
    """Trend analysis data"""
    pass_rate_trend: List[PassRateTrendPoint]
    weak_concepts_improvement: List[WeakConceptImprovement]
    overall_progress: OverallProgress

class MultiReviewProgressResponse(BaseModel):
    """Full multi-review progress response"""
    original_canvas_path: str
    review_count: int
    reviews: List[ReviewSessionSummary]
    trends: Optional[TrendsData] = None
```

**Step 2: Implement Query Method**
```python
# backend/app/services/review_service.py
async def _query_review_history_from_graphiti(
    self,
    original_canvas_path: str
) -> List[dict]:
    """
    Query all review canvas history from Graphiti for a given original canvas.

    AC2: Review History Query from Graphiti
    ✅ Verified from Graphiti Skill (SKILL.md - Section: Neo4j Cypher Queries)

    Args:
        original_canvas_path: Path to original canvas file

    Returns:
        List of review session records sorted by date (newest first)
    """
    # Cypher query to find all review canvases generated from this original
    query = """
    MATCH (review:ReviewCanvas)-[r:GENERATED_FROM]->(original:Canvas {path: $canvas_path})
    RETURN review.path AS review_canvas_path,
           r.generated_at AS date,
           r.mode AS mode,
           review.pass_rate AS pass_rate,
           review.total_concepts AS total_concepts,
           review.passed_concepts AS passed_concepts
    ORDER BY r.generated_at DESC
    """

    results = await self.graphiti_client.execute_query(
        query,
        {"canvas_path": original_canvas_path}
    )

    return results
```

**Step 3: Implement Trend Calculation**
```python
# backend/app/services/review_service.py
def _calculate_trends(
    self,
    reviews: List[dict]
) -> TrendsData:
    """
    Calculate trend analysis from review history.

    AC3: Pass Rate Trend Calculation
    AC4: Weak Concepts Improvement Tracking
    AC6: Overall Progress Calculation

    Args:
        reviews: List of review session data

    Returns:
        TrendsData with pass_rate_trend, weak_concepts_improvement, overall_progress
    """
    # Build pass_rate_trend
    pass_rate_trend = [
        PassRateTrendPoint(
            date=review["date"].strftime("%Y-%m-%d") if hasattr(review["date"], "strftime") else review["date"],
            pass_rate=review["pass_rate"]
        )
        for review in reviews
    ]

    # Calculate overall progress
    if len(reviews) >= 2:
        first_rate = reviews[-1]["pass_rate"]  # Oldest
        latest_rate = reviews[0]["pass_rate"]   # Newest

        if first_rate > 0:
            progress_rate = (latest_rate - first_rate) / first_rate
        else:
            progress_rate = latest_rate  # If started from 0

        # Determine trend direction
        if progress_rate > 0.1:
            trend_direction = "up"
        elif progress_rate < -0.1:
            trend_direction = "down"
        else:
            trend_direction = "stable"
    else:
        progress_rate = 0.0
        trend_direction = "stable"

    overall_progress = OverallProgress(
        progress_rate=progress_rate,
        trend_direction=trend_direction
    )

    # Weak concepts improvement (requires additional query for concept-level data)
    weak_concepts_improvement = await self._calculate_weak_concept_improvements(
        reviews
    )

    return TrendsData(
        pass_rate_trend=pass_rate_trend,
        weak_concepts_improvement=weak_concepts_improvement,
        overall_progress=overall_progress
    )

async def _calculate_weak_concept_improvements(
    self,
    reviews: List[dict]
) -> List[WeakConceptImprovement]:
    """
    Calculate improvement tracking for weak concepts.

    AC4: Weak Concepts Improvement Tracking
    """
    if not reviews:
        return []

    # Get oldest review canvas path
    oldest_review = reviews[-1]["review_canvas_path"]
    latest_review = reviews[0]["review_canvas_path"]

    # Query concept scores from oldest and latest reviews
    query = """
    MATCH (concept:Concept)-[scored:SCORED_IN]->(review:ReviewCanvas)
    WHERE review.path IN [$oldest_path, $latest_path]
    RETURN concept.name AS concept_name,
           scored.score AS score,
           review.path AS review_path
    ORDER BY concept.name, scored.scored_at
    """

    results = await self.graphiti_client.execute_query(
        query,
        {"oldest_path": oldest_review, "latest_path": latest_review}
    )

    # Build improvement tracking
    concept_scores = {}
    for result in results:
        name = result["concept_name"]
        if name not in concept_scores:
            concept_scores[name] = {"first": None, "current": None}

        if result["review_path"] == oldest_review:
            concept_scores[name]["first"] = result["score"]
        elif result["review_path"] == latest_review:
            concept_scores[name]["current"] = result["score"]

    improvements = []
    for concept_name, scores in concept_scores.items():
        first_score = scores.get("first", 0) or 0
        current_score = scores.get("current", 0) or 0

        # Only track concepts that were weak at some point
        if first_score < 60 or current_score < 60:
            if first_score > 0:
                improvement_rate = (current_score - first_score) / first_score
            else:
                improvement_rate = current_score / 100.0

            # Determine status
            if current_score < 60:
                status = "weak"
            elif current_score < 80:
                status = "improving"
            else:
                status = "mastered"

            improvements.append(WeakConceptImprovement(
                concept_name=concept_name,
                improvement_rate=improvement_rate,
                current_status=status
            ))

    return improvements
```

**Step 4: Implement Main Service Method**
```python
# backend/app/services/review_service.py
async def get_multi_review_progress(
    self,
    original_canvas_path: str
) -> MultiReviewProgressResponse:
    """
    Get multi-review progress analysis for an original canvas.

    AC1: Multi-Review Progress Endpoint Implementation
    AC5: Empty History Handling

    Args:
        original_canvas_path: Path to original canvas file

    Returns:
        MultiReviewProgressResponse with reviews and trends

    Raises:
        CanvasNotFoundException: If no review history exists
    """
    # Query review history
    reviews = await self._query_review_history_from_graphiti(original_canvas_path)

    # AC5: Handle empty history
    if not reviews:
        raise CanvasNotFoundException(
            f"No review history found for canvas: {original_canvas_path}"
        )

    # Build review session summaries
    review_summaries = [
        ReviewSessionSummary(
            review_canvas_path=r["review_canvas_path"],
            date=r["date"],
            mode=r["mode"],
            pass_rate=r["pass_rate"],
            total_concepts=r["total_concepts"],
            passed_concepts=r["passed_concepts"]
        )
        for r in reviews
    ]

    # Calculate trends (only if 2+ reviews)
    trends = None
    if len(reviews) >= 2:
        trends = await self._calculate_trends(reviews)

    return MultiReviewProgressResponse(
        original_canvas_path=original_canvas_path,
        review_count=len(reviews),
        reviews=review_summaries,
        trends=trends
    )
```

**Step 5: Implement API Endpoint**
```python
# backend/app/api/v1/endpoints/review.py
from fastapi import APIRouter, HTTPException

@router.get(
    "/progress/multi/{original_canvas_path:path}",
    response_model=MultiReviewProgressResponse,
    summary="多次检验趋势分析",
    description="获取同一原白板的多次检验进度趋势。"
)
async def get_multi_review_progress(
    original_canvas_path: str,
    review_service: ReviewService = Depends(get_review_service)
):
    """
    Get multi-review progress analysis.

    AC1: Multi-Review Progress Endpoint Implementation

    ✅ Verified from specs/api/review-api.openapi.yml#L346-378
    """
    try:
        result = await review_service.get_multi_review_progress(original_canvas_path)
        return result
    except CanvasNotFoundException as e:
        raise HTTPException(status_code=404, detail=str(e))
```

### Key Files to Modify

| File Path | Change Type | Description |
|-----------|-------------|-------------|
| `backend/app/models/schemas.py` | Modify | Add MultiReviewProgressResponse and related models |
| `backend/app/services/review_service.py` | Modify | Add get_multi_review_progress, _query_review_history_from_graphiti, _calculate_trends methods |
| `backend/app/api/v1/endpoints/review.py` | Modify | Add GET /progress/multi/{path} endpoint |
| `src/tests/test_multi_review_progress.py` | Create | Test cases for multi-review functionality |

### Existing Code References

| Location | Line Range | Purpose |
|----------|------------|---------|
| backend/app/services/review_service.py | 90-120 | ReviewService class definition |
| backend/app/services/review_service.py | 37-88 | ReviewProgress dataclass |
| src/agentic_rag/clients/graphiti_client.py | 1-100 | GraphitiClient class |
| specs/api/review-api.openapi.yml | 346-378 | Endpoint specification |
| specs/api/review-api.openapi.yml | 725-805 | Response schema |

---

## Testing Requirements

### Unit Tests

**Test File**: `src/tests/test_multi_review_progress.py`

```python
import pytest
from unittest.mock import AsyncMock, MagicMock
from backend.app.services.review_service import ReviewService

class TestMultiReviewProgress:

    @pytest.mark.asyncio
    async def test_query_review_history_returns_ordered_results(
        self, review_service, mock_graphiti
    ):
        """AC2: Query returns results ordered by date (newest first)."""
        mock_graphiti.execute_query.return_value = [
            {"review_canvas_path": "review3.canvas", "date": "2025-12-13", "pass_rate": 0.85},
            {"review_canvas_path": "review2.canvas", "date": "2025-12-06", "pass_rate": 0.75},
            {"review_canvas_path": "review1.canvas", "date": "2025-11-29", "pass_rate": 0.65},
        ]

        result = await review_service._query_review_history_from_graphiti("original.canvas")

        assert len(result) == 3
        assert result[0]["date"] == "2025-12-13"  # Newest first
        assert result[2]["date"] == "2025-11-29"  # Oldest last

    @pytest.mark.asyncio
    async def test_pass_rate_trend_calculation(self, review_service):
        """AC3: Pass rate trend is correctly calculated."""
        reviews = [
            {"date": "2025-12-13", "pass_rate": 0.85},
            {"date": "2025-12-06", "pass_rate": 0.75},
            {"date": "2025-11-29", "pass_rate": 0.65},
        ]

        trends = await review_service._calculate_trends(reviews)

        assert len(trends.pass_rate_trend) == 3
        assert trends.overall_progress.trend_direction == "up"
        # (0.85 - 0.65) / 0.65 = 0.307 > 0.1, so "up"

    @pytest.mark.asyncio
    async def test_empty_history_returns_404(
        self, review_service, mock_graphiti
    ):
        """AC5: Empty history returns appropriate error."""
        mock_graphiti.execute_query.return_value = []

        with pytest.raises(CanvasNotFoundException) as exc:
            await review_service.get_multi_review_progress("no_reviews.canvas")

        assert "No review history found" in str(exc.value)

    @pytest.mark.asyncio
    async def test_weak_concept_improvement_status(self, review_service):
        """AC4: Weak concept status correctly assigned."""
        # Score < 60 -> weak
        # Score 60-79 -> improving
        # Score >= 80 -> mastered

        improvement = WeakConceptImprovement(
            concept_name="test",
            improvement_rate=0.5,
            current_status="improving"
        )
        assert improvement.current_status == "improving"

    @pytest.mark.asyncio
    async def test_overall_progress_trend_direction(self, review_service):
        """AC6: Trend direction correctly determined."""
        # progress_rate > 0.1 -> up
        # progress_rate < -0.1 -> down
        # else -> stable

        reviews_improving = [
            {"date": "2025-12-13", "pass_rate": 0.90},
            {"date": "2025-11-29", "pass_rate": 0.60},
        ]
        trends = await review_service._calculate_trends(reviews_improving)
        assert trends.overall_progress.trend_direction == "up"

        reviews_declining = [
            {"date": "2025-12-13", "pass_rate": 0.50},
            {"date": "2025-11-29", "pass_rate": 0.80},
        ]
        trends = await review_service._calculate_trends(reviews_declining)
        assert trends.overall_progress.trend_direction == "down"
```

### Integration Tests

**Test File**: `src/tests/integration/test_multi_review_integration.py`

```python
@pytest.mark.integration
async def test_full_multi_review_flow():
    """E2E test for multi-review trend analysis."""
    # Setup: Create multiple review canvases for same original
    # Execute: Call API endpoint
    # Verify: Response contains correct trends
    pass
```

### API Contract Tests

**Test with Schemathesis**:
```bash
schemathesis run specs/api/review-api.openapi.yml --endpoint "/review/progress/multi/*"
```

---

## Dependencies

### Story Dependencies
- Story 24.1 (Mode Parameter Support) - Must be completed first
  - Provides the Graphiti relationship storage that this story queries

### Technical Dependencies
- Neo4j running for Graphiti queries
- Graphiti client available (`src/agentic_rag/clients/graphiti_client.py`)
- Existing ReviewService (`backend/app/services/review_service.py`)
- Story 24.1 must have stored review canvas relationships in Graphiti

### External Dependencies
- `neo4j>=5.0.0` - Graph database
- `graphiti-core>=0.6.0` - Knowledge graph SDK

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-13 | 1.0 | Initial draft - SM Agent automated batch mode | Bob (SM Agent) |

---

## Dev Agent Record

### Agent Model Used
*To be filled by Dev Agent*

### Debug Log References
*To be filled by Dev Agent*

### Completion Notes List
*To be filled by Dev Agent*

### File List
*To be filled by Dev Agent*

---

## QA Results

*Pending QA Agent review*

---

## Related Documentation

**Epic Documentation**:
- Epic 24: Verification Canvas Redesign

**PRD References**:
- docs/prd/v118-检验白板历史关联与可选复习模式-2025-11-14-必读.md - Core requirements (FR4扩展: 多次对比分析)

**Architecture Documentation**:
- docs/architecture/decisions/0003-graphiti-memory.md - Graphiti ADR
- docs/architecture/ebbinghaus-review-system-architecture.md - Review system design

**API Specifications**:
- specs/api/review-api.openapi.yml - Review API OpenAPI spec (L346-378, L725-805)
- specs/data/review-progress-response.schema.json - Progress response schema

**Skills References**:
- .claude/skills/graphiti/SKILL.md - Graphiti documentation (Neo4j Cypher queries)
