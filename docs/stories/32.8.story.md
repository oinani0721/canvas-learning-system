# Story 32.8: EPIC-32 å¯¹æŠ—æ€§å®¡æ ¸ä¿®å¤

## Status

**Review**

---

## Story

**As a** Canvas Learning System maintainer,
**I want** to fix the 4 blocking issues found in the EPIC-32 adversarial review,
**so that** the EPIC documentation is accurate, the FSRS rollback mechanism actually exists, and the ReviewService has a single consistent FSRSManager initialization path.

---

## Background

EPIC-32 å¯¹æŠ—æ€§å®¡æ ¸å‘ç° 4 ä¸ª blocking çº§é—®é¢˜ï¼š
1. Story æ–‡æ¡£çŠ¶æ€è…çƒ‚ï¼ˆ32.2 = Draft, 32.3 = Readyï¼Œå®é™…å·²å®ç°ï¼‰
2. EPIC æ–‡æ¡£è¿‡æ—¶ï¼ˆè¡Œæ•°è¡¨ä¸å‡†ç¡® + Story Manager Handoff å¼•ç”¨å·²åˆ é™¤çš„ 32.5ï¼‰
3. `USE_FSRS` å›æ»šå¼€å…³ä¸å­˜åœ¨ï¼ˆEPIC å£°ç§°å¯ç”¨ä½† config.py æ— æ­¤é…ç½®ï¼‰
4. review.py å•ä¾‹ vs dependencies.py é‡å¤åˆ›å»º FSRSManager

---

## Acceptance Criteria

### AC-32.8.1: Story æ–‡æ¡£çŠ¶æ€ä¿®æ­£
- `docs/stories/32.2.story.md` çŠ¶æ€ä» "Draft" æ”¹ä¸º "Done"ï¼Œè¡¥å…… Dev Agent Record
- `docs/stories/32.3.story.md` çŠ¶æ€ä» "Ready" æ”¹ä¸º "Done"ï¼Œè¡¥å…… Dev Agent Record

### AC-32.8.2: EPIC æ–‡æ¡£ä¿®æ­£
- `docs/epics/EPIC-32-EBBINGHAUS-REVIEW-SYSTEM-ENHANCEMENT.md` Key File Locations è¡¨è¡Œæ•°æ›´æ–°ä¸ºå®é™…å€¼ï¼š
  - `review_service.py`: 1099 â†’ 1895
  - `review.py`: 522 â†’ 1469
  - `memory_service.py`: 684 â†’ 1338
  - `TodayReviewListService.ts`: 790 â†’ 910
- Story Manager Handoff åŒºæ®µç§»é™¤å¯¹ Story 32.5 çš„å¼•ç”¨ï¼Œæ›´æ–°ä¸ºï¼š
  - Week 3: Story 32.6 + Story 32.7 (å¯å¹¶è¡Œ)ï¼ˆä¸å†å¼•ç”¨ 32.5ï¼‰

### AC-32.8.3: USE_FSRS å›æ»šå¼€å…³
- `backend/app/config.py` æ·»åŠ  `USE_FSRS: bool = True` é…ç½®é¡¹ï¼ˆFSRS Settings åŒºæ®µå†…ï¼‰
- `backend/app/services/review_service.py` çš„ `__init__` åœ¨ `USE_FSRS=False` æ—¶è·³è¿‡ FSRSManager åˆå§‹åŒ–ï¼Œä½¿ `self._fsrs_manager = None`
- `backend/app/dependencies.py` çš„ `get_review_service()` åœ¨ `USE_FSRS=False` æ—¶ä¸åˆ›å»º FSRSManager
- `backend/app/api/v1/endpoints/review.py` çš„ `_get_review_service_singleton()` åœ¨ `USE_FSRS=False` æ—¶ä¸åˆ›å»º FSRSManager

### AC-32.8.4: FSRSManager å•ä¾‹ç»Ÿä¸€
- `review.py:_get_review_service_singleton()` ä¸å†ç‹¬ç«‹åˆ›å»º FSRSManagerï¼Œæ”¹ä¸ºå§”æ‰˜ç»™ `dependencies.py` çš„é€»è¾‘æˆ–å…±äº«åŒä¸€ä¸ªå·¥å‚å‡½æ•°
- ç¡®ä¿å…¨ç³»ç»Ÿåªæœ‰ä¸€æ¡ FSRSManager åˆ›å»ºè·¯å¾„
- å¤‡é€‰æ–¹æ¡ˆï¼šæå– `_create_fsrs_manager(settings)` å…¬å…±å‡½æ•°ï¼Œä¸¤å¤„å‡è°ƒç”¨

---

## Tasks / Subtasks

### Task 1: æ–‡æ¡£ä¿®å¤ (AC-32.8.1, AC-32.8.2)
- [x] T1.1: æ›´æ–° 32.2.story.md çŠ¶æ€ â†’ Done + Dev Agent Record
- [x] T1.2: æ›´æ–° 32.3.story.md çŠ¶æ€ â†’ Done + Dev Agent Record
- [x] T1.3: æ›´æ–° EPIC-32 Key File Locations è¡Œæ•°
- [x] T1.4: æ›´æ–° EPIC-32 Story Manager Handoff ç§»é™¤ 32.5 å¼•ç”¨

### Task 2: USE_FSRS å›æ»šå¼€å…³ (AC-32.8.3)
- [x] T2.1: config.py æ·»åŠ  `USE_FSRS: bool = True`
- [x] T2.2: review_service.py `__init__` è¯»å–é…ç½®ï¼Œ`USE_FSRS=False` æ—¶ skip FSRSManager
- [x] T2.3: dependencies.py `get_review_service()` è¯»å–é…ç½®
- [x] T2.4: review.py `_get_review_service_singleton()` è¯»å–é…ç½®

### Task 3: FSRSManager å•ä¾‹ç»Ÿä¸€ (AC-32.8.4)
- [x] T3.1: æå– `create_fsrs_manager(settings)` å·¥å‚å‡½æ•°åˆ° review_service.py
- [x] T3.2: dependencies.py è°ƒç”¨è¯¥å·¥å‚å‡½æ•°
- [x] T3.3: review.py singleton è°ƒç”¨è¯¥å·¥å‚å‡½æ•°
- [x] T3.4: å·¥å‚å‡½æ•°å†…éƒ¨æ£€æŸ¥ `settings.USE_FSRS`

### Task 4: æµ‹è¯•éªŒè¯
- [x] T4.1: è¿è¡Œ `pytest backend/tests/unit/test_fsrs_manager.py -v` â€” 37/37 PASSED
- [x] T4.2: è¿è¡Œ `pytest backend/tests/unit/test_review_service_fsrs.py -v` â€” 20/20 PASSED
- [x] T4.3: è¿è¡Œ `pytest backend/tests/unit/test_story_38_3_fsrs_init_guarantee.py -v` â€” 21/21 PASSED (ä¿®å¤æ–­è¨€å­—ç¬¦ä¸²åŒ¹é…)
- [x] T4.4: éªŒè¯ `USE_FSRS=false` æ—¶ ReviewService æ­£å¸¸å·¥ä½œ â€” create_fsrs_manager è¿”å› None âœ…

---

## Technical Design

### USE_FSRS é…ç½®é¡¹ (config.py)
```python
# FSRS Spaced Repetition Settings (Story 32.2)
USE_FSRS: bool = Field(
    default=True,
    description="Enable FSRS algorithm. Set False to disable FSRS and use fallback scheduling. Story 32.8."
)
```

### FSRSManager å·¥å‚å‡½æ•° (review_service.py)
```python
def create_fsrs_manager(settings) -> Optional[FSRSManager]:
    """Unified FSRSManager factory. Used by both DI and singleton paths."""
    if not settings.USE_FSRS:
        logger.info("FSRS disabled via USE_FSRS=False")
        return None
    if not FSRS_AVAILABLE or FSRSManager is None:
        logger.warning("FSRS not available (py-fsrs not installed)")
        return None
    try:
        mgr = FSRSManager(desired_retention=settings.FSRS_DESIRED_RETENTION)
        logger.info(f"FSRSManager created (desired_retention={settings.FSRS_DESIRED_RETENTION})")
        return mgr
    except Exception as e:
        logger.warning(f"FSRSManager creation failed: {e}")
        return None
```

### è°ƒç”¨ç»Ÿä¸€ (dependencies.py + review.py)
```python
# dependencies.py
from .services.review_service import create_fsrs_manager
fsrs_manager = create_fsrs_manager(settings)

# review.py
from app.services.review_service import create_fsrs_manager
fsrs_manager = create_fsrs_manager(settings)
```

---

## Code Reality Check

| å£°ç§°çš„åŠŸèƒ½ | ä»£ç ä½ç½® | çŠ¶æ€ |
|-----------|---------|------|
| config.py FSRS åŒºæ®µ | `backend/app/config.py:L438-445` | å­˜åœ¨ï¼Œå¯åœ¨æ­¤æ·»åŠ  USE_FSRS |
| review.py singleton | `backend/app/api/v1/endpoints/review.py:L80-109` | å­˜åœ¨ï¼Œéœ€é‡æ„ |
| dependencies.py FSRSManager | `backend/app/dependencies.py:L298-314` | å­˜åœ¨ï¼Œéœ€é‡æ„ |
| FSRS_AVAILABLE flag | `backend/app/services/review_service.py` é¡¶éƒ¨ | å­˜åœ¨ |
| FSRSManager import | `src/memory/temporal/fsrs_manager.py` (396è¡Œ) | å­˜åœ¨ |

---

## Estimated Effort

2-3 å°æ—¶

---

## Dependencies

- æ— å‰ç½®ä¾èµ–ï¼ˆä¿®å¤ç°æœ‰ä»£ç ï¼‰
- Story 32.1, 32.2, 32.3 å·²å®ç°

---

## Dev Agent Record

- **Agent Model**: Claude Opus 4.6
- **Completion Date**: 2026-02-09
- **Debug Log**: ä¿®å¤ `test_fsrs_init_reason_set_when_unavailable` æ–­è¨€å­—ç¬¦ä¸²ä¸åŒ¹é… â€” é‡æ„åçš„ `__init__` è®¾ç½® `_fsrs_init_reason = "FSRS disabled or unavailable"`ï¼Œæ—§æµ‹è¯•æœŸæœ› `"not available"`ã€‚æ›´æ–°æ–­è¨€ä¸º `"unavailable" or "disabled"`ã€‚
- **Completion Notes**: æ‰€æœ‰ 4 ä¸ª AC å·²å®ç°ã€‚æå– `create_fsrs_manager()` å·¥å‚å‡½æ•°ç»Ÿä¸€ FSRSManager åˆ›å»ºè·¯å¾„ï¼ŒåŒæ—¶é›†æˆ `USE_FSRS` å›æ»šå¼€å…³ã€‚88 ä¸ªç›¸å…³æµ‹è¯•å…¨éƒ¨é€šè¿‡ (37 + 20 + 21 + 10)ã€‚
- **Code Review Fix (2026-02-09)**:
  - ğŸ”´ æ–°å¢ `test_create_fsrs_manager.py` â€” 10 ä¸ªæµ‹è¯•è¦†ç›–å·¥å‚å‡½æ•° + USE_FSRS å¼€å…³
  - ğŸŸ¡ ä¿®å¤ `getattr` â†’ ç›´æ¥å±æ€§è®¿é—® (`settings.USE_FSRS`, `settings.FSRS_DESIRED_RETENTION`)
  - ğŸŸ¡ æ›´æ–° EPIC-32 è¡Œæ•°è¡¨: review_service.py=1924, review.py=1640
- **File List**:
  - `docs/stories/32.2.story.md` â€” çŠ¶æ€ Draft â†’ Done
  - `docs/stories/32.3.story.md` â€” çŠ¶æ€ Ready â†’ Done
  - `docs/epics/EPIC-32-EBBINGHAUS-REVIEW-SYSTEM-ENHANCEMENT.md` â€” è¡Œæ•°è¡¨ + Handoff æ›´æ–°
  - `backend/app/config.py` â€” æ·»åŠ  `USE_FSRS: bool = True`
  - `backend/app/services/review_service.py` â€” æ·»åŠ  `create_fsrs_manager()` å·¥å‚å‡½æ•° + é‡æ„ `__init__` + getattrâ†’ç›´æ¥è®¿é—®
  - `backend/app/dependencies.py` â€” ä½¿ç”¨ `create_fsrs_manager(settings)`
  - `backend/app/api/v1/endpoints/review.py` â€” ä½¿ç”¨ `create_fsrs_manager(settings)`
  - `backend/tests/unit/test_story_38_3_fsrs_init_guarantee.py` â€” ä¿®å¤æ–­è¨€å­—ç¬¦ä¸²
  - `backend/tests/unit/test_create_fsrs_manager.py` â€” æ–°å¢ 10 ä¸ªæµ‹è¯•
