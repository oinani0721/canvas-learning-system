# Story 30.11: 批量端点真批量改造

**Epic**: [EPIC-30: Memory System Complete Activation](../epics/EPIC-30-MEMORY-SYSTEM-COMPLETE-ACTIVATION.md)
**Priority**: P0
**Estimated Hours**: 8
**Dependencies**: Story 30.10 (幂等性修复必须先完成)

---

## Status

**Done**

---

## Story

**As a** Canvas Learning System user,
**I want** the batch learning event endpoint to process events in true parallel,
**so that** batch writes complete within 500ms instead of the current ~10s for 50 events.

---

## Problem Statement

对抗性审查 (2026-02-09) 发现 `record_batch_learning_events()` (memory_service.py:L953-991) 是伪批量：

```python
for idx, event in enumerate(events):  # ← 顺序循环
    ...
    await self.neo4j.record_episode(...)  # ← 每个事件逐个 await
```

50 个事件 × ~200ms/次 = ~10s，远超 AC-30.3.10 要求的 <500ms。

---

## Acceptance Criteria

1. **AC-30.11.1**: 真并行写入
   - `record_batch_learning_events()` 使用 `asyncio.gather()` 并行处理所有事件
   - 50 个事件的 P95 延迟 < 500ms
   - 并行度可配置 (默认 semaphore=10 并发)

2. **AC-30.11.2**: 部分失败隔离
   - 使用 `asyncio.gather(return_exceptions=True)` 隔离单个事件失败
   - 成功的事件已持久化，不受失败事件影响
   - 返回结果准确区分成功/失败数量和错误详情

3. **AC-30.11.3**: Neo4j 连接保护
   - 使用 `asyncio.Semaphore` 限制并发 Neo4j 连接数
   - 默认并发 10，通过 `settings.BATCH_NEO4J_CONCURRENCY` 配置
   - Neo4j 不可用时所有事件降级到内存存储

4. **AC-30.11.4**: 幂等性兼容
   - 依赖 Story 30.10 的确定性 episode_id 生成
   - 并行写入不产生竞态条件导致的重复

5. **AC-30.11.5**: 性能指标
   - 记录 batch 处理总时长到 stats
   - 记录并行 vs 顺序的性能对比日志 (DEBUG 级别)
   - stats 中新增 `batch_avg_latency_ms` 字段

---

## Tasks / Subtasks

### Task 1: 并行化核心逻辑
- [x] 1.1 三阶段架构: 同步预处理 → 并行 Neo4j → 结果聚合 (避免 _episodes 竞态)
- [x] 1.2 使用 `asyncio.gather(*tasks, return_exceptions=True)` 并行执行
- [x] 1.3 添加 `asyncio.Semaphore(concurrency)` 限制并发
- [x] 1.4 在 config.py 添加 `BATCH_NEO4J_CONCURRENCY: int = 10`

### Task 2: 结果聚合与错误处理
- [x] 2.1 遍历 gather 结果区分成功/失败/异常
- [x] 2.2 失败事件记录详细错误 (index, error)
- [x] 2.3 返回结果包含 `episode_ids` 列表 (仅成功事件)

### Task 3: 性能指标
- [x] 3.1 time.monotonic() 记录开始/结束
- [x] 3.2 计算 `batch_avg_latency_ms` 并写入 `_batch_stats` + 返回值
- [x] 3.3 DEBUG 日志: `"Batch processed {n} events in {ms}ms (parallel, concurrency={c})"`

### Task 4: 单元测试
- [x] 4.1 test_50_events_all_processed — 50 事件并行
- [x] 4.2 test_validation_failure_isolated / test_neo4j_failure_does_not_block_processing — 部分失败隔离
- [x] 4.3 test_concurrency_limited_by_semaphore — Semaphore 验证
- [x] 4.4 test_neo4j_unavailable_still_processes_to_memory — Neo4j 降级
- [x] 4.5 test_duplicate_batch_no_duplicates — 幂等兼容性

---

## Dev Notes

### 关键代码位置

| 文件 | 行号 | 修改内容 |
|------|------|---------|
| `backend/app/services/memory_service.py` | L953-1006 | 重构为并行 gather |
| `backend/app/config.py` | 新增 | `BATCH_NEO4J_CONCURRENCY` |

### 架构参考

```python
# 目标实现模式
async def record_batch_learning_events(self, events):
    semaphore = asyncio.Semaphore(settings.BATCH_NEO4J_CONCURRENCY)

    async def _process_single(idx, event):
        async with semaphore:
            return await self._process_single_batch_event(idx, event)

    tasks = [_process_single(i, e) for i, e in enumerate(events)]
    results = await asyncio.gather(*tasks, return_exceptions=True)
    # ... aggregate results
```

### 基础设施 AC 检查

| 维度 | 检查 | 状态 |
|------|------|------|
| D1 持久化 | 并行写入每个事件独立持久化 | AC-30.11.2 |
| D2 弹性 | 部分失败隔离 | AC-30.11.2 |
| D3 输入验证 | 复用现有验证逻辑 | 已有 |
| D4 配置 | BATCH_NEO4J_CONCURRENCY 默认 10 | AC-30.11.3 |
| D5 降级 | Neo4j 不可用降级内存 | AC-30.11.3 |
| D6 集成 | 依赖 30.10 幂等键 | AC-30.11.4 |

---

## Dev Agent Record

### Implementation
1. 三阶段架构:
   - Phase 1 (同步): 验证 + deterministic ID + dedup + append _episodes
   - Phase 2 (并行): asyncio.gather + Semaphore 限制 Neo4j 并发
   - Phase 3 (同步): 性能指标计算 + DEBUG 日志
2. config.py: 新增 `BATCH_NEO4J_CONCURRENCY = 10`
3. Neo4j 写入失败为 non-blocking (仅 WARNING 日志)

### Tests
11 tests in `test_story_30_11_batch_parallel.py` — all pass
6 existing tests in `test_memory_service_batch.py` — all pass (regression)

---

## File List
- `backend/app/services/memory_service.py` — record_batch_learning_events 三阶段并行
- `backend/app/config.py` — BATCH_NEO4J_CONCURRENCY 配置项
- `backend/tests/unit/test_story_30_11_batch_parallel.py` — 11 tests (NEW)

---

## Change Log

| Date | Change | Author |
|------|--------|--------|
| 2026-02-09 | Story 创建 (PM Agent: John) | ROG |
| 2026-02-09 | 实现完成，11 测试全部通过 | Dev Agent (Amelia) |

---

## 代码现实检查

| 声称的功能 | 代码位置 | 状态 |
|-----------|----------|------|
| 伪批量 for 循环 | memory_service.py:L953 | ✅ 确认 |
| 逐个 await neo4j.record_episode | memory_service.py:L978 | ✅ 确认 |
| AC-30.3.10 要求 <500ms | 30.3.story.md:L76 | ✅ 确认 |
