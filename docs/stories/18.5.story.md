# Story 18.5: Rollback API和配置 - 完整REST API和配置

## Status
Draft

## Story

**As a** Canvas Learning System开发者,
**I want** 完整的回滚REST API和集中配置,
**so that** 回滚系统生产就绪且可配置。

## Acceptance Criteria

1. GET `/api/v1/rollback/diff/{snapshot_id}` 返回快照与当前Canvas的差异
2. 5个回滚端点在router注册并有OpenAPI文档
3. `rollback_config.yaml`定义所有配置项
4. 配置通过`backend/app/config.py` Settings类加载
5. `RollbackServiceDep`在`backend/app/dependencies.py`
6. 所有request/response的Pydantic schemas
7. Contract tests验证API符合OpenAPI规范
8. E2E集成测试覆盖完整回滚工作流

## Tasks / Subtasks

- [ ] Task 1: 实现Diff端点 (AC: 1)
  - [ ] 实现 `GET /api/v1/rollback/diff/{snapshot_id}` 端点
  - [ ] 实现 `calculate_diff(snapshot, current_canvas)` 方法
  - [ ] 返回节点差异 (added, removed, modified)
  - [ ] 返回边差异 (added, removed)

- [ ] Task 2: 完成所有5个端点 (AC: 2)
  - [ ] 验证 `GET /history/{canvas_path}` (Story 18.1)
  - [ ] 验证 `GET /snapshots/{canvas_path}` (Story 18.2)
  - [ ] 验证 `POST /snapshot` (Story 18.2)
  - [ ] 验证 `POST /rollback` (Story 18.3)
  - [ ] 新增 `GET /diff/{snapshot_id}` (本Task)
  - [ ] 添加OpenAPI文档注释

- [ ] Task 3: 创建配置文件 (AC: 3)
  - [ ] 创建 `rollback_config.yaml` 配置文件
  - [ ] 定义所有配置项:
    - [ ] max_history_per_canvas (default: 100)
    - [ ] max_snapshots_per_canvas (default: 50)
    - [ ] auto_snapshot_interval (default: 300)
    - [ ] create_backup_before_rollback (default: true)
    - [ ] graph_sync_timeout_ms (default: 200)
    - [ ] storage_root (default: .canvas-learning)

- [ ] Task 4: 扩展Settings类 (AC: 4)
  - [ ] 在 `backend/app/config.py` 添加 `RollbackSettings` 类
  - [ ] 实现YAML配置加载
  - [ ] 支持环境变量覆盖

- [ ] Task 5: 添加依赖注入 (AC: 5)
  - [ ] 在 `backend/app/dependencies.py` 添加 `get_rollback_service()`
  - [ ] 添加 `get_operation_tracker()`
  - [ ] 添加 `get_snapshot_manager()`
  - [ ] 添加 `get_rollback_engine()`

- [ ] Task 6: 完善Pydantic Schemas (AC: 6)
  - [ ] 在 `backend/app/models/rollback.py` 添加所有schemas
  - [ ] CreateSnapshotRequest
  - [ ] RollbackRequest
  - [ ] RollbackResult
  - [ ] DiffResponse (nodes_diff, edges_diff)
  - [ ] 验证schemas符合OpenAPI规范

- [ ] Task 7: Contract Tests (AC: 7)
  - [ ] 创建 `src/tests/contract/test_rollback_contracts.py`
  - [ ] 使用Schemathesis验证API
  - [ ] 测试所有5个端点
  - [ ] 验证请求/响应Schema

- [ ] Task 8: E2E集成测试 (AC: 8)
  - [ ] 创建 `src/tests/integration/test_rollback_e2e.py`
  - [ ] 测试完整工作流: 操作 → 快照 → 回滚 → 验证
  - [ ] 测试图谱同步集成
  - [ ] 测试配置生效

## Dev Notes

### 技术验证报告 (Step 3.6)

**验证完成时间**: 2025-12-04
**验证执行人**: SM Agent (Bob)
**Quality Gate状态**: Pending

#### 技术栈清单

| 技术栈 | 查询方式 | 验证状态 | 文档位置 |
|--------|---------|---------|----------|
| Pydantic Settings | Context7 | 待验证 | /pydantic/pydantic |
| PyYAML | Context7 | 待验证 | /yaml/pyyaml |
| Schemathesis | Context7 | 待验证 | /schemathesis/schemathesis |
| FastAPI Depends | Context7 | 待验证 | /fastapi/fastapi |

#### 核心API验证待办

**开发前必须验证**:
- [ ] pydantic_settings.BaseSettings → Context7: /pydantic/pydantic
- [ ] yaml.safe_load() → Context7: /yaml/pyyaml
- [ ] schemathesis.from_uri() → Context7: /schemathesis/schemathesis
- [ ] FastAPI Depends() → Context7: /fastapi/fastapi

### SDD规范引用 (必填)

**API端点规范** (完整5个端点):

1. `GET /api/v1/rollback/history/{canvas_path}` - 获取操作历史
   - [Source: docs/architecture/rollback-recovery-architecture.md:296-310]

2. `GET /api/v1/rollback/snapshots/{canvas_path}` - 列出快照
   - [Source: docs/architecture/rollback-recovery-architecture.md:312-326]

3. `POST /api/v1/rollback/snapshot` - 创建快照
   - [Source: docs/architecture/rollback-recovery-architecture.md:328-342]

4. `POST /api/v1/rollback/rollback` - 执行回滚
   - [Source: docs/architecture/rollback-recovery-architecture.md:344-380]

5. `GET /api/v1/rollback/diff/{snapshot_id}` - 获取差异
   - [Source: docs/architecture/rollback-recovery-architecture.md:382-400]

**DiffResponse Schema** (Source: docs/architecture/rollback-recovery-architecture.md:382-400):
```typescript
interface DiffResponse {
    snapshot_id: string;
    canvas_path: string;
    timestamp: Date;
    nodes_diff: {
        added: NodeInfo[];
        removed: NodeInfo[];
        modified: NodeModification[];
    };
    edges_diff: {
        added: EdgeInfo[];
        removed: EdgeInfo[];
    };
}
```

### ADR决策关联 (必填)

| ADR编号 | 决策标题 | 对Story的影响 |
|---------|----------|---------------|
| ADR-0007 | Caching Strategy | 配置缓存策略 |
| ADR-0009 | Error Handling | API错误响应格式 |

### 架构设计参考

**架构文档引用**:
- 配置管理: [Source: docs/architecture/rollback-recovery-architecture.md:562-600]
- 依赖注入: [Source: docs/architecture/rollback-recovery-architecture.md:602-640]
- API文档: [Source: docs/architecture/rollback-recovery-architecture.md:296-400]

### 代码示例库

**配置文件** (Source: docs/architecture/rollback-recovery-architecture.md:562-600):
```yaml
# rollback_config.yaml
# ✅ Verified from Architecture Doc (rollback-recovery-architecture.md:562-600)
rollback:
  # 操作历史配置
  max_history_per_canvas: 100

  # 快照配置
  max_snapshots_per_canvas: 50
  auto_snapshot_interval: 300  # seconds

  # 回滚配置
  create_backup_before_rollback: true

  # 图谱同步配置
  graph_sync:
    enabled: true
    timeout_ms: 200

  # 存储配置
  storage:
    root: ".canvas-learning"
    compress_snapshots: true
```

**Settings类** (Source: docs/architecture/rollback-recovery-architecture.md:580-600):
```python
# backend/app/config.py (扩展)
# ✅ Verified from Architecture Doc (rollback-recovery-architecture.md:580-600)
from pydantic import BaseModel
from pydantic_settings import BaseSettings
import yaml
from pathlib import Path

class GraphSyncSettings(BaseModel):
    enabled: bool = True
    timeout_ms: int = 200

class StorageSettings(BaseModel):
    root: str = ".canvas-learning"
    compress_snapshots: bool = True

class RollbackSettings(BaseModel):
    max_history_per_canvas: int = 100
    max_snapshots_per_canvas: int = 50
    auto_snapshot_interval: int = 300
    create_backup_before_rollback: bool = True
    graph_sync: GraphSyncSettings = GraphSyncSettings()
    storage: StorageSettings = StorageSettings()

    @classmethod
    def from_yaml(cls, path: Path = Path("rollback_config.yaml")) -> "RollbackSettings":
        if path.exists():
            with open(path) as f:
                data = yaml.safe_load(f)
                return cls(**data.get("rollback", {}))
        return cls()
```

**依赖注入** (Source: docs/architecture/rollback-recovery-architecture.md:602-640):
```python
# backend/app/dependencies.py (扩展)
# ✅ Verified from Architecture Doc (rollback-recovery-architecture.md:602-640)
from functools import lru_cache
from fastapi import Depends

from src.rollback.operation_tracker import OperationTracker
from src.rollback.snapshot_manager import SnapshotManager
from src.rollback.rollback_engine import RollbackEngine
from src.rollback.graph_sync_service import GraphSyncService
from backend.app.config import RollbackSettings

@lru_cache()
def get_rollback_settings() -> RollbackSettings:
    return RollbackSettings.from_yaml()

def get_operation_tracker(
    settings: RollbackSettings = Depends(get_rollback_settings)
) -> OperationTracker:
    return OperationTracker(
        max_history_per_canvas=settings.max_history_per_canvas
    )

def get_snapshot_manager(
    settings: RollbackSettings = Depends(get_rollback_settings)
) -> SnapshotManager:
    return SnapshotManager(
        auto_interval=settings.auto_snapshot_interval,
        max_snapshots=settings.max_snapshots_per_canvas
    )

def get_rollback_engine(
    tracker: OperationTracker = Depends(get_operation_tracker),
    snapshot_manager: SnapshotManager = Depends(get_snapshot_manager),
    settings: RollbackSettings = Depends(get_rollback_settings)
) -> RollbackEngine:
    return RollbackEngine(
        tracker=tracker,
        snapshot_manager=snapshot_manager,
        create_backup=settings.create_backup_before_rollback
    )
```

### 文件路径参考

**需要新增的文件**:
- 新增: `rollback_config.yaml` - 配置文件
- 新增: `src/tests/contract/test_rollback_contracts.py` - Contract测试
- 新增: `src/tests/integration/test_rollback_e2e.py` - E2E测试

**需要修改的文件**:
- 修改: `backend/app/config.py` - 添加RollbackSettings
- 修改: `backend/app/dependencies.py` - 添加依赖注入
- 修改: `backend/app/api/v1/endpoints/rollback.py` - 添加diff端点
- 修改: `backend/app/models/rollback.py` - 完善所有schemas
- 修改: `specs/api/canvas-api.openapi.yml` - 添加回滚端点定义

### 依赖关系

**前置Story**:
- Story 18.3: Rollback Engine（提供核心回滚功能）
- Story 18.4: Graph Sync Service（提供图谱同步）

**后续影响**:
- Epic 18完成后，回滚系统生产就绪

### Definition of Done

- [ ] 所有AC通过验收测试
- [ ] 5个REST API端点完整可用
- [ ] 配置文件正确加载
- [ ] 依赖注入正确配置
- [ ] Contract tests全部通过
- [ ] E2E集成测试全部通过
- [ ] OpenAPI文档更新
- [ ] 代码Review通过
- [ ] 所有代码有文档来源标注

### 风险和缓解

| 风险 | 概率 | 影响 | 缓解措施 |
|------|------|------|---------|
| OpenAPI Schema不一致 | 中 | 中 | Contract tests自动验证 |
| 配置加载失败 | 低 | 中 | 提供默认值 |
| 依赖注入循环 | 低 | 高 | 使用lru_cache避免 |

### 估算

- **Story Points**: 5
- **预估工时**: 2天
- **复杂度**: 中（主要是集成和测试）

---

**文档版本**: v1.0.0
**创建时间**: 2025-12-04
**创建者**: SM Agent (Bob)
**Epic**: Epic 18 - 数据迁移和回滚
