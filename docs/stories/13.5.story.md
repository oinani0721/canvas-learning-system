# Story 13.5 - å³é”®èœå•å’Œå¿«æ·é”®å®ç°

**Epic**: Epic 13 - Obsidian Pluginæ ¸å¿ƒåŠŸèƒ½
**Story ID**: Story 13.5
**åˆ›å»ºæ—¥æœŸ**: 2025-11-30
**Storyç‚¹æ•°**: 5 Points
**é¢„ä¼°æ—¶é—´**: 4å¤©
**ä¼˜å…ˆçº§**: P1
**ä¾èµ–**: Story 13.1 (Pluginé¡¹ç›®åˆå§‹åŒ–), Story 13.2 (Canvas APIé›†æˆ), Story 13.3 (APIå®¢æˆ·ç«¯å®ç°), Story 13.4 (æ ¸å¿ƒå‘½ä»¤)

---

## ğŸ“‹ Storyæè¿°

å®ç°CanvasèŠ‚ç‚¹å³é”®èœå•å’Œå¿«æ·é”®ç³»ç»Ÿï¼Œä¸ºç”¨æˆ·æä¾›ä¾¿æ·çš„æ“ä½œå…¥å£ã€‚åŒ…æ‹¬èŠ‚ç‚¹åˆ†æèœå•ã€è¯„åˆ†èœå•ã€å„ç±»è§£é‡Šå‘½ä»¤èœå•ï¼Œä»¥åŠ[SCP-003]ä¸­å®šä¹‰çš„"ä¿æŠ¤æ­¤å¤‡ä»½ ğŸ”’"åŠŸèƒ½ã€‚åŒæ—¶æ”¯æŒç”¨æˆ·è‡ªå®šä¹‰å¿«æ·é”®é…ç½®ã€‚

**æ ¸å¿ƒç›®æ ‡**:
- CanvasèŠ‚ç‚¹å³é”®èœå•æ³¨å†Œï¼Œæä¾›å­¦ä¹ ç³»ç»Ÿæ‰€æœ‰æ ¸å¿ƒå‘½ä»¤å…¥å£
- å®ç°åˆ†å±‚èœå•ç»“æ„ï¼ˆæ‹†è§£ã€è§£é‡Šã€è¯„åˆ†ã€éªŒè¯ç­‰åˆ†ç±»ï¼‰
- [SCP-003] å®ç°"ä¿æŠ¤æ­¤å¤‡ä»½ ğŸ”’"å³é”®èœå•é€‰é¡¹
- å¿«æ·é”®é…ç½®ï¼Œæ”¯æŒç”¨æˆ·è‡ªå®šä¹‰
- ä¸Story 13.4æ ¸å¿ƒå‘½ä»¤çš„é›†æˆ

---

## ğŸ¯ ç”¨æˆ·æ•…äº‹ (User Story)

```
ä½œä¸ºObsidian Canvasç”¨æˆ·
å½“æˆ‘å³é”®ç‚¹å‡»Canvasä¸Šçš„ä»»æ„èŠ‚ç‚¹æ—¶
æˆ‘å¸Œæœ›çœ‹åˆ°ä¸€ä¸ªç»“æ„æ¸…æ™°çš„èœå•
åŒ…å«"æ‹†è§£"ã€"è§£é‡Š"ã€"è¯„åˆ†"ç­‰å­¦ä¹ ç³»ç»Ÿå‘½ä»¤
ä»¥åŠ"ä¿æŠ¤æ­¤å¤‡ä»½"é€‰é¡¹
è¿™æ ·æˆ‘å¯ä»¥å¿«é€Ÿå¯¹èŠ‚ç‚¹è¿›è¡Œåˆ†ææ“ä½œ
è€Œä¸éœ€è¦è®°ä½å¤æ‚çš„å‘½ä»¤è¡ŒæŒ‡ä»¤

åŒæ—¶ï¼Œå½“æˆ‘æƒ³è¦åŠ å¿«æ“ä½œé€Ÿåº¦æ—¶
æˆ‘å¸Œæœ›èƒ½ä½¿ç”¨å¿«æ·é”®ç›´æ¥è§¦å‘å¸¸ç”¨å‘½ä»¤
å¹¶ä¸”èƒ½åœ¨è®¾ç½®ä¸­è‡ªå®šä¹‰è¿™äº›å¿«æ·é”®
```

---

## ğŸ›  æŠ€æœ¯èƒŒæ™¯

### å·²æœ‰å®ç° (Story 13.1-13.4)

**Story 13.1** - Pluginé¡¹ç›®åˆå§‹åŒ–:
- Obsidian PluginåŸºç¡€ç»“æ„å·²åˆ›å»º
- TypeScripté…ç½®å®Œæˆ
- æ„å»ºè„šæœ¬é…ç½®å®Œæˆ

**Story 13.2** - Canvas APIé›†æˆ:
- CanvasOperatorç±»å·²å®ç°
- Canvasæ–‡ä»¶è¯»å†™å°è£…å®Œæˆ
- [SCP-003] `.canvas_backups/`æ–‡ä»¶å¤¹é…ç½®ä¸ºéšè—

**Story 13.3** - APIå®¢æˆ·ç«¯å®ç°:
- FastAPIåç«¯HTTPå®¢æˆ·ç«¯å·²å®ç°
- è¯·æ±‚/å“åº”ç±»å‹å®šä¹‰å®Œæˆ
- é”™è¯¯å¤„ç†å°è£…å®Œæˆ

**Story 13.4** - æ ¸å¿ƒå‘½ä»¤å®ç°:
- å‘½ä»¤æ³¨å†Œç³»ç»Ÿå·²å®ç°
- åŸºç¡€æ‹†è§£å‘½ä»¤ã€æ·±åº¦æ‹†è§£å‘½ä»¤ã€è¯„åˆ†å‘½ä»¤å·²å®ç°
- å„ç±»è§£é‡Šå‘½ä»¤å·²å®ç°

### Obsidian Plugin APIå‚è€ƒ

**å³é”®èœå•æ³¨å†Œ**:
```typescript
// âœ… Verified from Obsidian Canvas Skill (SKILL.md - Section: Events)
// âœ… Verified from obsidian-plugin-architecture.md (Section 5.1)
this.registerEvent(
    this.app.workspace.on('canvas:node-menu', (menu, node) => {
        // æ·»åŠ èœå•é¡¹
        menu.addItem((item) => {
            item.setTitle('Analyze Node')
                .setIcon('search')
                .onClick(() => this.analyzeNode(node));
        });
    })
);
```

**å¿«æ·é”®æ³¨å†Œ**:
```typescript
// âœ… Verified from Obsidian Canvas Skill (references/README.md - Line 49)
this.addCommand({
    id: 'canvas-decompose-basic',
    name: 'åŸºç¡€æ‹†è§£',
    hotkeys: [{ modifiers: ['Mod', 'Shift'], key: 'd' }],
    checkCallback: (checking: boolean) => {
        const canvasView = this.app.workspace.getActiveViewOfType(ItemView);
        if (canvasView?.getViewType() === 'canvas') {
            if (!checking) {
                this.executeCommand('basic-decomposition');
            }
            return true;
        }
        return false;
    }
});
```

---

## âœ… éªŒæ”¶æ ‡å‡† (Acceptance Criteria)

### åŠŸèƒ½éªŒæ”¶

**AC1**: CanvasèŠ‚ç‚¹å³é”®èœå•æ˜¾ç¤º
- [ ] å³é”®ç‚¹å‡»CanvasèŠ‚ç‚¹æ˜¾ç¤ºè‡ªå®šä¹‰èœå•
- [ ] èœå•ä½¿ç”¨åˆ†å±‚ç»“æ„ï¼Œä¸»è¦åˆ†ç±»åŒ…æ‹¬ï¼š
  - ğŸ“– æ‹†è§£ (Decompose) â†’
    - åŸºç¡€æ‹†è§£
    - æ·±åº¦æ‹†è§£
    - é—®é¢˜æ‹†è§£
  - ğŸ“ è§£é‡Š (Explain) â†’
    - å£è¯­åŒ–è§£é‡Š
    - æ¾„æ¸…è·¯å¾„
    - å¯¹æ¯”è¡¨
    - è®°å¿†é”šç‚¹
    - å››å±‚æ¬¡è§£é‡Š
    - ç¤ºä¾‹æ•™å­¦
  - â­ è¯„åˆ† (Score)
  - âœ… éªŒè¯é—®é¢˜ (Verify)
  - ---ï¼ˆåˆ†éš”çº¿ï¼‰
  - ğŸ”’ ä¿æŠ¤æ­¤å¤‡ä»½ [SCP-003]
- [ ] æ¯ä¸ªèœå•é¡¹æ˜¾ç¤ºæ­£ç¡®çš„å›¾æ ‡å’Œåç§°

**AC2**: èœå•å‘½ä»¤æ­£ç¡®è§¦å‘
- [ ] ç‚¹å‡»"åŸºç¡€æ‹†è§£"è°ƒç”¨`POST /agents/invoke`ï¼Œagent_type=`basic-decomposition`
- [ ] ç‚¹å‡»"æ·±åº¦æ‹†è§£"è°ƒç”¨agent_type=`deep-decomposition`
- [ ] ç‚¹å‡»"é—®é¢˜æ‹†è§£"è°ƒç”¨agent_type=`question-decomposition`
- [ ] ç‚¹å‡»å„ç±»è§£é‡Šå‘½ä»¤è°ƒç”¨å¯¹åº”çš„agent_type
- [ ] ç‚¹å‡»"è¯„åˆ†"è°ƒç”¨agent_type=`scoring-agent`
- [ ] ç‚¹å‡»"éªŒè¯é—®é¢˜"è°ƒç”¨agent_type=`verification-question-agent`

**AC3**: [SCP-003] ä¿æŠ¤æ­¤å¤‡ä»½åŠŸèƒ½
- [ ] å³é”®èœå•æ˜¾ç¤º"ğŸ”’ ä¿æŠ¤æ­¤å¤‡ä»½"é€‰é¡¹
- [ ] ä»…åœ¨å¤‡ä»½æ–‡ä»¶ï¼ˆ`.canvas_backups/`å†…çš„æ–‡ä»¶ï¼‰ä¸Šæ˜¾ç¤ºæ­¤é€‰é¡¹
- [ ] ç‚¹å‡»ååˆ›å»º`.protected`æ ‡è®°æ–‡ä»¶
- [ ] æ˜¾ç¤ºToasté€šçŸ¥ï¼š"å¤‡ä»½å·²ä¿æŠ¤ï¼Œå°†ä¸ä¼šè¢«è‡ªåŠ¨æ¸…ç†åˆ é™¤"
- [ ] å·²ä¿æŠ¤çš„å¤‡ä»½æ˜¾ç¤º"ğŸ”“ å–æ¶ˆä¿æŠ¤"é€‰é¡¹

**AC4**: å¿«æ·é”®é…ç½®
- [ ] é»˜è®¤å¿«æ·é”®é…ç½®ï¼š
  - `Ctrl+Shift+D`: åŸºç¡€æ‹†è§£
  - `Ctrl+Shift+E`: å£è¯­åŒ–è§£é‡Š
  - `Ctrl+Shift+S`: è¯„åˆ†
  - `Ctrl+Shift+V`: éªŒè¯é—®é¢˜
- [ ] å¿«æ·é”®ä»…åœ¨Canvasè§†å›¾æ¿€æ´»æ—¶æœ‰æ•ˆ
- [ ] å¿«æ·é”®å†²çªæ—¶æ˜¾ç¤ºè­¦å‘Šæç¤º

**AC5**: ç”¨æˆ·è‡ªå®šä¹‰å¿«æ·é”®
- [ ] ç”¨æˆ·å¯åœ¨Obsidian Hotkeysè®¾ç½®ä¸­æŸ¥çœ‹å’Œä¿®æ”¹å¿«æ·é”®
- [ ] è‡ªå®šä¹‰å¿«æ·é”®åœ¨æ’ä»¶é‡è½½åä¿æŒ
- [ ] å¿«æ·é”®ä¿®æ”¹åç«‹å³ç”Ÿæ•ˆï¼ˆæ— éœ€é‡å¯Obsidianï¼‰

**AC6**: å¤šé€‰èŠ‚ç‚¹æ”¯æŒ
- [ ] å¤šé€‰CanvasèŠ‚ç‚¹æ—¶ï¼Œå³é”®èœå•æ˜¾ç¤º"æ‰¹é‡æ“ä½œ"å­èœå•
- [ ] æ‰¹é‡æ“ä½œä»…æ˜¾ç¤ºæ”¯æŒæ‰¹é‡çš„å‘½ä»¤ï¼ˆè¯„åˆ†ã€åŸºç¡€æ‹†è§£ï¼‰
- [ ] æ‰¹é‡æ“ä½œè°ƒç”¨å¯¹åº”çš„æ‰¹é‡API

**AC7**: èœå•çŠ¶æ€ç®¡ç†
- [ ] æ ¹æ®èŠ‚ç‚¹é¢œè‰²åŠ¨æ€æ˜¾ç¤º/éšè—èœå•é¡¹ï¼š
  - çº¢è‰²èŠ‚ç‚¹("1"): æ˜¾ç¤º"æ‹†è§£"é€‰é¡¹
  - é»„è‰²èŠ‚ç‚¹("3"): æ˜¾ç¤º"è¯„åˆ†"é€‰é¡¹
  - ç´«è‰²èŠ‚ç‚¹("6"): æ˜¾ç¤º"æ·±åº¦æ‹†è§£"é€‰é¡¹
- [ ] å‘½ä»¤æ‰§è¡ŒæœŸé—´èœå•é¡¹æ˜¾ç¤ºä¸ºç¦ç”¨çŠ¶æ€ï¼ˆé˜²æ­¢é‡å¤è§¦å‘ï¼‰

**AC8**: é”™è¯¯å¤„ç†
- [ ] APIè°ƒç”¨å¤±è´¥æ—¶æ˜¾ç¤ºå‹å¥½Toastæç¤º
- [ ] ç½‘ç»œé”™è¯¯æ—¶æ˜¾ç¤º"æ— æ³•è¿æ¥åç«¯æœåŠ¡"æç¤º
- [ ] æ‰€æœ‰é”™è¯¯è®°å½•åˆ°æ’ä»¶æ—¥å¿—ç³»ç»Ÿ

### æ€§èƒ½éªŒæ”¶

**AC9**: æ€§èƒ½è¦æ±‚
- [ ] å³é”®èœå•å“åº”æ—¶é—´<50ms
- [ ] å¿«æ·é”®å“åº”æ—¶é—´<30ms
- [ ] èœå•æ¸²æŸ“ä¸é˜»å¡UIä¸»çº¿ç¨‹

### å¯è®¿é—®æ€§éªŒæ”¶

**AC10**: Accessibility
- [ ] æ‰€æœ‰èœå•é¡¹æ”¯æŒé”®ç›˜å¯¼èˆªï¼ˆâ†‘â†“é€‰æ‹©ï¼ŒEnterç¡®è®¤ï¼‰
- [ ] èœå•é¡¹æœ‰ARIAæ ‡ç­¾
- [ ] åˆ†éš”çº¿ä½¿ç”¨`role="separator"`

---

## ğŸ“ ä»»åŠ¡æ¸…å• (Task Checklist)

### Task 1: å³é”®èœå•åŸºç¡€æ¶æ„ â±ï¸ 1å¤©

**æè¿°**: æ³¨å†ŒCanvasèŠ‚ç‚¹å³é”®èœå•äº‹ä»¶ï¼Œå®ç°åˆ†å±‚èœå•ç»“æ„

**æŠ€æœ¯ç»†èŠ‚**:
- ä½¿ç”¨Obsidiançš„`canvas:node-menu`äº‹ä»¶
- å®ç°`MenuBuilder`è¾…åŠ©ç±»ç®¡ç†èœå•ç»“æ„
- ä½¿ç”¨`Menu.addItem()`å’Œ`Menu.addSeparator()`æ„å»ºèœå•

**å®ç°æ­¥éª¤**:
1. [ ] åœ¨`main.ts`çš„`onload()`ä¸­æ³¨å†Œ`canvas:node-menu`äº‹ä»¶
2. [ ] åˆ›å»º`MenuBuilder.ts`è¾…åŠ©ç±»
3. [ ] å®ç°ä¸€çº§èœå•é¡¹ï¼ˆæ‹†è§£ã€è§£é‡Šã€è¯„åˆ†ã€éªŒè¯ï¼‰
4. [ ] å®ç°å­èœå•ï¼ˆæ‹†è§£å­èœå•ã€è§£é‡Šå­èœå•ï¼‰
5. [ ] æ·»åŠ èœå•å›¾æ ‡ï¼ˆä½¿ç”¨Lucide iconsï¼‰
6. [ ] æ·»åŠ åˆ†éš”çº¿å’Œ"ä¿æŠ¤æ­¤å¤‡ä»½"é€‰é¡¹

**ä»£ç ç¤ºä¾‹**:
```typescript
// âœ… Verified from Obsidian Canvas Skill (SKILL.md - Section: Events)
// src/menu/CanvasNodeMenu.ts

export class CanvasNodeMenu {
    constructor(private plugin: CanvasLearningPlugin) {}

    register(): void {
        this.plugin.registerEvent(
            this.plugin.app.workspace.on('canvas:node-menu', (menu, node) => {
                this.buildMenu(menu, node);
            })
        );
    }

    private buildMenu(menu: Menu, node: CanvasNode): void {
        // æ‹†è§£å­èœå•
        menu.addItem((item) => {
            item.setTitle('ğŸ“– æ‹†è§£')
                .setIcon('layers')
                .onClick(() => {}); // å±•å¼€å­èœå•

            const submenu = (item as any).setSubmenu();
            this.addDecomposeSubmenu(submenu, node);
        });

        // è§£é‡Šå­èœå•
        menu.addItem((item) => {
            item.setTitle('ğŸ“ è§£é‡Š')
                .setIcon('book-open')
                .onClick(() => {});

            const submenu = (item as any).setSubmenu();
            this.addExplainSubmenu(submenu, node);
        });

        // è¯„åˆ†
        menu.addItem((item) => {
            item.setTitle('â­ è¯„åˆ†')
                .setIcon('star')
                .onClick(() => this.plugin.invokeAgent('scoring-agent', node));
        });

        // éªŒè¯é—®é¢˜
        menu.addItem((item) => {
            item.setTitle('âœ… éªŒè¯é—®é¢˜')
                .setIcon('check-circle')
                .onClick(() => this.plugin.invokeAgent('verification-question-agent', node));
        });

        // åˆ†éš”çº¿
        menu.addSeparator();

        // [SCP-003] ä¿æŠ¤æ­¤å¤‡ä»½
        if (this.isBackupFile(node)) {
            this.addBackupProtectionItem(menu, node);
        }
    }
}
```

**éªŒæ”¶**:
- [ ] å³é”®èœå•æ­£ç¡®æ˜¾ç¤º
- [ ] å­èœå•æ­£ç¡®å±•å¼€
- [ ] å›¾æ ‡æ­£ç¡®æ˜¾ç¤º

---

### Task 2: å‘½ä»¤ä¸APIé›†æˆ â±ï¸ 1å¤©

**æè¿°**: å°†èœå•å‘½ä»¤ä¸Story 13.4çš„æ ¸å¿ƒå‘½ä»¤å’Œåç«¯APIé›†æˆ

**æŠ€æœ¯ç»†èŠ‚**:
- å¤ç”¨Story 13.3çš„APIå®¢æˆ·ç«¯
- è°ƒç”¨`POST /agents/invoke`ç«¯ç‚¹
- å¤„ç†APIå“åº”å¹¶æ›´æ–°Canvas

**å®ç°æ­¥éª¤**:
1. [ ] åˆ›å»º`CommandExecutor.ts`ç»Ÿä¸€å‘½ä»¤æ‰§è¡Œå…¥å£
2. [ ] å®ç°`invokeAgent(agentType, node)`æ–¹æ³•
3. [ ] å¤„ç†APIå“åº”ï¼Œæ›´æ–°CanvasèŠ‚ç‚¹
4. [ ] æ˜¾ç¤ºæ‰§è¡Œç»“æœToast
5. [ ] å¤„ç†é”™è¯¯æƒ…å†µ

**APIè°ƒç”¨ç¤ºä¾‹**:
```typescript
// âœ… Verified from specs/api/canvas-api.openapi.yml (Line 247-265)
// POST /agents/invoke

async invokeAgent(agentType: AgentType, node: CanvasNode): Promise<AgentResponse> {
    const request: AgentInvocationRequest = {
        agent_type: agentType,  // âœ… Verified: enum from AgentInvocationRequest schema
        canvas_path: this.getActiveCanvasPath(),
        target_node_id: node.id,
        parameters: {}
    };

    const response = await this.apiClient.post('/agents/invoke', request);
    return response.data as AgentResponse;
}
```

**éªŒæ”¶**:
- [ ] èœå•å‘½ä»¤æ­£ç¡®è°ƒç”¨API
- [ ] APIå“åº”æ­£ç¡®å¤„ç†
- [ ] Canvasæ­£ç¡®æ›´æ–°

---

### Task 3: å¿«æ·é”®æ³¨å†Œå’Œé…ç½® â±ï¸ 1å¤©

**æè¿°**: æ³¨å†Œé»˜è®¤å¿«æ·é”®ï¼Œæ”¯æŒObsidian Hotkeysè®¾ç½®ä¸­çš„è‡ªå®šä¹‰

**æŠ€æœ¯ç»†èŠ‚**:
- ä½¿ç”¨`this.addCommand()`æ³¨å†Œå¸¦å¿«æ·é”®çš„å‘½ä»¤
- ä½¿ç”¨`checkCallback`ç¡®ä¿ä»…åœ¨Canvasè§†å›¾æœ‰æ•ˆ
- å¿«æ·é”®ä½¿ç”¨`Mod`ä¿®é¥°ç¬¦æ”¯æŒè·¨å¹³å°ï¼ˆCtrl/Cmdï¼‰

**å®ç°æ­¥éª¤**:
1. [ ] åœ¨`main.ts`ä¸­æ³¨å†Œæ‰€æœ‰å‘½ä»¤
2. [ ] ä¸ºæ¯ä¸ªå‘½ä»¤å®šä¹‰é»˜è®¤å¿«æ·é”®
3. [ ] å®ç°`checkCallback`éªŒè¯Canvasè§†å›¾
4. [ ] æµ‹è¯•å¿«æ·é”®åœ¨Obsidianè®¾ç½®ä¸­çš„æ˜¾ç¤º
5. [ ] æµ‹è¯•ç”¨æˆ·è‡ªå®šä¹‰å¿«æ·é”®åŠŸèƒ½

**ä»£ç ç¤ºä¾‹**:
```typescript
// âœ… Verified from Obsidian Canvas Skill (references/README.md - Line 49)
// src/commands/HotkeyRegistration.ts

export function registerHotkeys(plugin: CanvasLearningPlugin): void {
    // åŸºç¡€æ‹†è§£
    plugin.addCommand({
        id: 'canvas-learning-decompose-basic',
        name: 'åŸºç¡€æ‹†è§£ (Canvas Learning)',
        icon: 'layers',
        hotkeys: [{ modifiers: ['Mod', 'Shift'], key: 'd' }],
        checkCallback: (checking: boolean) => {
            return checkCanvasViewAndExecute(plugin, checking, () => {
                plugin.executeCommand('basic-decomposition');
            });
        }
    });

    // å£è¯­åŒ–è§£é‡Š
    plugin.addCommand({
        id: 'canvas-learning-explain-oral',
        name: 'å£è¯­åŒ–è§£é‡Š (Canvas Learning)',
        icon: 'mic',
        hotkeys: [{ modifiers: ['Mod', 'Shift'], key: 'e' }],
        checkCallback: (checking: boolean) => {
            return checkCanvasViewAndExecute(plugin, checking, () => {
                plugin.executeCommand('oral-explanation');
            });
        }
    });

    // è¯„åˆ†
    plugin.addCommand({
        id: 'canvas-learning-score',
        name: 'è¯„åˆ† (Canvas Learning)',
        icon: 'star',
        hotkeys: [{ modifiers: ['Mod', 'Shift'], key: 's' }],
        checkCallback: (checking: boolean) => {
            return checkCanvasViewAndExecute(plugin, checking, () => {
                plugin.executeCommand('scoring-agent');
            });
        }
    });

    // éªŒè¯é—®é¢˜
    plugin.addCommand({
        id: 'canvas-learning-verify',
        name: 'éªŒè¯é—®é¢˜ (Canvas Learning)',
        icon: 'check-circle',
        hotkeys: [{ modifiers: ['Mod', 'Shift'], key: 'v' }],
        checkCallback: (checking: boolean) => {
            return checkCanvasViewAndExecute(plugin, checking, () => {
                plugin.executeCommand('verification-question-agent');
            });
        }
    });
}

function checkCanvasViewAndExecute(
    plugin: CanvasLearningPlugin,
    checking: boolean,
    execute: () => void
): boolean {
    const canvasView = plugin.app.workspace.getActiveViewOfType(ItemView);
    if (canvasView?.getViewType() === 'canvas') {
        if (!checking) {
            execute();
        }
        return true;
    }
    return false;
}
```

**éªŒæ”¶**:
- [ ] é»˜è®¤å¿«æ·é”®æ­£ç¡®æ³¨å†Œ
- [ ] å¿«æ·é”®ä»…åœ¨Canvasè§†å›¾æœ‰æ•ˆ
- [ ] ç”¨æˆ·å¯åœ¨è®¾ç½®ä¸­è‡ªå®šä¹‰

---

### Task 4: [SCP-003] å¤‡ä»½ä¿æŠ¤åŠŸèƒ½ â±ï¸ 0.5å¤©

**æè¿°**: å®ç°å³é”®èœå•çš„"ä¿æŠ¤æ­¤å¤‡ä»½"åŠŸèƒ½

**æŠ€æœ¯ç»†èŠ‚**:
- æ£€æµ‹æ–‡ä»¶æ˜¯å¦åœ¨`.canvas_backups/`ç›®å½•
- åˆ›å»º`.protected`æ ‡è®°æ–‡ä»¶
- æ˜¾ç¤ºä¿æŠ¤çŠ¶æ€ï¼ˆå·²ä¿æŠ¤/æœªä¿æŠ¤ï¼‰

**å®ç°æ­¥éª¤**:
1. [ ] å®ç°`isBackupFile(node)`æ£€æµ‹æ–¹æ³•
2. [ ] å®ç°`isProtectedBackup()`æ£€æŸ¥æ–¹æ³•
3. [ ] å®ç°`protectBackup()`åˆ›å»ºæ ‡è®°æ–‡ä»¶
4. [ ] å®ç°`unprotectBackup()`åˆ é™¤æ ‡è®°æ–‡ä»¶
5. [ ] æ ¹æ®çŠ¶æ€æ˜¾ç¤º"ä¿æŠ¤"æˆ–"å–æ¶ˆä¿æŠ¤"èœå•é¡¹
6. [ ] æ˜¾ç¤ºæ“ä½œç»“æœToast

**ä»£ç ç¤ºä¾‹**:
```typescript
// âœ… Verified from SCP-003 (Section 4.3 - Obsidian Plugin Integration)
// src/backup/BackupProtection.ts

export class BackupProtection {
    constructor(private app: App) {}

    isBackupFile(filePath: string): boolean {
        return filePath.includes('.canvas_backups/');
    }

    async isProtected(backupPath: string): Promise<boolean> {
        const protectedPath = backupPath + '.protected';
        return await this.app.vault.adapter.exists(protectedPath);
    }

    async protect(backupPath: string): Promise<void> {
        const protectedPath = backupPath + '.protected';
        await this.app.vault.adapter.write(protectedPath,
            JSON.stringify({ protected_at: new Date().toISOString() })
        );
        new Notice('ğŸ”’ å¤‡ä»½å·²ä¿æŠ¤ï¼Œå°†ä¸ä¼šè¢«è‡ªåŠ¨æ¸…ç†åˆ é™¤');
    }

    async unprotect(backupPath: string): Promise<void> {
        const protectedPath = backupPath + '.protected';
        if (await this.app.vault.adapter.exists(protectedPath)) {
            await this.app.vault.adapter.remove(protectedPath);
            new Notice('ğŸ”“ å¤‡ä»½ä¿æŠ¤å·²å–æ¶ˆ');
        }
    }
}
```

**éªŒæ”¶**:
- [ ] "ä¿æŠ¤æ­¤å¤‡ä»½"é€‰é¡¹æ­£ç¡®æ˜¾ç¤º
- [ ] `.protected`æ–‡ä»¶æ­£ç¡®åˆ›å»º
- [ ] Toasté€šçŸ¥æ­£ç¡®æ˜¾ç¤º
- [ ] å·²ä¿æŠ¤å¤‡ä»½æ˜¾ç¤º"å–æ¶ˆä¿æŠ¤"é€‰é¡¹

---

### Task 5: èœå•çŠ¶æ€å’Œå¤šé€‰æ”¯æŒ â±ï¸ 0.5å¤©

**æè¿°**: æ ¹æ®èŠ‚ç‚¹çŠ¶æ€åŠ¨æ€è°ƒæ•´èœå•ï¼Œæ”¯æŒå¤šé€‰æ‰¹é‡æ“ä½œ

**æŠ€æœ¯ç»†èŠ‚**:
- æ ¹æ®èŠ‚ç‚¹é¢œè‰²è¿‡æ»¤èœå•é¡¹
- æ£€æµ‹å¤šé€‰çŠ¶æ€å¹¶æ˜¾ç¤ºæ‰¹é‡èœå•
- å‘½ä»¤æ‰§è¡ŒæœŸé—´ç¦ç”¨èœå•é¡¹

**å®ç°æ­¥éª¤**:
1. [ ] å®ç°`getNodeColor(node)`è·å–èŠ‚ç‚¹é¢œè‰²
2. [ ] å®ç°èœå•é¡¹è¿‡æ»¤é€»è¾‘
3. [ ] æ£€æµ‹Canvaså¤šé€‰çŠ¶æ€
4. [ ] å®ç°æ‰¹é‡æ“ä½œèœå•
5. [ ] å®ç°å‘½ä»¤æ‰§è¡ŒçŠ¶æ€ç®¡ç†

**éªŒæ”¶**:
- [ ] èœå•æ ¹æ®èŠ‚ç‚¹é¢œè‰²æ­£ç¡®æ˜¾ç¤º
- [ ] å¤šé€‰æ—¶æ˜¾ç¤ºæ‰¹é‡æ“ä½œèœå•
- [ ] æ‰§è¡ŒæœŸé—´èœå•é¡¹ç¦ç”¨

---

## ğŸ”— ä¾èµ–å…³ç³»

### ä¾èµ–çš„Story

**Story 13.1**: Pluginé¡¹ç›®åˆå§‹åŒ–
- æä¾›Obsidian PluginåŸºç¡€ç»“æ„

**Story 13.2**: Canvas APIé›†æˆ
- æä¾›CanvasOperatorç±»
- [SCP-003] `.canvas_backups/`æ–‡ä»¶å¤¹éšè—é…ç½®

**Story 13.3**: APIå®¢æˆ·ç«¯å®ç°
- æä¾›`ApiClient`ç±»
- é”™è¯¯å¤„ç†å°è£…

**Story 13.4**: æ ¸å¿ƒå‘½ä»¤å®ç°
- æä¾›å‘½ä»¤æ‰§è¡Œé€»è¾‘
- Agentè°ƒç”¨å°è£…

### ä¾èµ–çš„Epic

**Epic 11**: FastAPIåç«¯
- æä¾›`POST /agents/invoke`ç«¯ç‚¹
- æä¾›Agentå“åº”å¤„ç†

---

## ğŸ“Š æµ‹è¯•è®¡åˆ’

### å•å…ƒæµ‹è¯•

**Test 1**: CanvasNodeMenu
- [ ] `buildMenu()`æ­£ç¡®æ„å»ºèœå•ç»“æ„
- [ ] å­èœå•æ­£ç¡®å±•å¼€
- [ ] å›¾æ ‡å’Œæ ‡é¢˜æ­£ç¡®è®¾ç½®

**Test 2**: BackupProtection
- [ ] `isBackupFile()`æ­£ç¡®æ£€æµ‹å¤‡ä»½æ–‡ä»¶
- [ ] `protect()`æ­£ç¡®åˆ›å»ºæ ‡è®°æ–‡ä»¶
- [ ] `unprotect()`æ­£ç¡®åˆ é™¤æ ‡è®°æ–‡ä»¶

**Test 3**: HotkeyRegistration
- [ ] å‘½ä»¤æ­£ç¡®æ³¨å†Œ
- [ ] `checkCallback`æ­£ç¡®éªŒè¯Canvasè§†å›¾
- [ ] å¿«æ·é”®æ­£ç¡®è§¦å‘å‘½ä»¤

**Test 4**: CommandExecutor
- [ ] `invokeAgent()`æ­£ç¡®è°ƒç”¨API
- [ ] å“åº”æ­£ç¡®å¤„ç†
- [ ] é”™è¯¯æ­£ç¡®æ•è·

### é›†æˆæµ‹è¯•

**Test 5**: E2Eæµ‹è¯•åœºæ™¯1 - å³é”®èœå•æ­£å¸¸æµç¨‹
1. æ‰“å¼€åŒ…å«èŠ‚ç‚¹çš„Canvas
2. å³é”®ç‚¹å‡»çº¢è‰²èŠ‚ç‚¹
3. éªŒè¯æ˜¾ç¤º"æ‹†è§£"èœå•é¡¹
4. ç‚¹å‡»"åŸºç¡€æ‹†è§£"
5. éªŒè¯APIè°ƒç”¨æˆåŠŸ
6. éªŒè¯Canvasæ›´æ–°

**Test 6**: E2Eæµ‹è¯•åœºæ™¯2 - å¿«æ·é”®
1. æ‰“å¼€Canvaså¹¶é€‰ä¸­èŠ‚ç‚¹
2. æŒ‰`Ctrl+Shift+D`
3. éªŒè¯è§¦å‘åŸºç¡€æ‹†è§£å‘½ä»¤

**Test 7**: E2Eæµ‹è¯•åœºæ™¯3 - å¤‡ä»½ä¿æŠ¤
1. åœ¨`.canvas_backups/`ç›®å½•åˆ›å»ºæµ‹è¯•å¤‡ä»½
2. å³é”®ç‚¹å‡»å¤‡ä»½æ–‡ä»¶
3. ç‚¹å‡»"ä¿æŠ¤æ­¤å¤‡ä»½"
4. éªŒè¯`.protected`æ–‡ä»¶åˆ›å»º
5. éªŒè¯Toastæ˜¾ç¤º

---

## ğŸ“š Dev Notes - æŠ€æœ¯è§„æ ¼å¼•ç”¨

### SDDè§„èŒƒå¼•ç”¨

**OpenAPIè§„èŒƒ**:
- `specs/api/canvas-api.openapi.yml`:
  - Line 247-265: `POST /agents/invoke` - Agentè°ƒç”¨ç«¯ç‚¹
  - Line 794-823: `AgentInvocationRequest` schema
  - Line 825-842: `AgentResponse` schema
  - Line 799-812: `agent_type` enum (12ä¸ªå­¦ä¹ å‹Agent)

**JSON Schema**:
- `specs/data/canvas-node.schema.json`:
  - å®šä¹‰CanvasèŠ‚ç‚¹ç»“æ„
  - `color`å­—æ®µ: "1"(çº¢), "2"(æ©™), "3"(é»„), "5"(ç»¿), "6"(ç´«)

- `specs/data/agent-response.schema.json`:
  - å®šä¹‰Agentå“åº”ç»“æ„
  - `success`, `agent_type`, `result`, `error`, `execution_time_ms`

### ADRå…³è”

**ADR-0001**: use-obsidian-canvas.md
- é€‰æ‹©Obsidian Canvasä½œä¸ºå‰ç«¯å¹³å°çš„å†³ç­–
- å½±å“æœ¬Storyçš„UIå®ç°æ–¹å¼

**ADR-0002**: langgraph-agents.md
- 14ä¸ªAgentçš„æ¶æ„è®¾è®¡
- è‡ªç„¶è¯­è¨€è°ƒç”¨åè®®
- å½±å“æœ¬Storyçš„APIè°ƒç”¨æ–¹å¼

### SCPå…³è”

**SCP-003**: Canvaså¤‡ä»½æ–‡ä»¶å¤¹ç»„ç»‡è§„èŒƒ
- Section 4.3: Obsidian Pluginé›†æˆè¦æ±‚
- å®šä¹‰"ä¿æŠ¤æ­¤å¤‡ä»½"åŠŸèƒ½è§„èŒƒ
- å®šä¹‰`.protected`æ ‡è®°æ–‡ä»¶æ ¼å¼

### æŠ€æœ¯æ–‡æ¡£æ¥æº

**Obsidian Canvas Skill**:
- SKILL.md - Section: Events (å³é”®èœå•æ³¨å†Œ)
- references/README.md - Line 49 (å¿«æ·é”®æ³¨å†Œ)
- references/CHANGELOG.md - Line 266 (å³é”®èœå•CSSç±»)

**Architecture Docs**:
- `docs/architecture/obsidian-plugin-architecture.md`:
  - Section 5.1: Canvasäº‹ä»¶ç›‘å¬
  - Section 7.1: å…¨å±€å‘½ä»¤æ³¨å†Œ

---

## âš ï¸ é£é™©å’Œç¼“è§£ç­–ç•¥

### é£é™©1: Obsidian APIç‰ˆæœ¬å…¼å®¹æ€§ âš ï¸ ä¸­é£é™©

**æè¿°**: Obsidian Canvas APIå¯èƒ½åœ¨æ–°ç‰ˆæœ¬ä¸­å˜åŒ–

**ç¼“è§£ç­–ç•¥**:
- é”å®šæœ€ä½Obsidianç‰ˆæœ¬: `minAppVersion: "1.4.0"`
- ç›‘æ§Obsidianå¼€å‘è€…æ—¥å¿—
- ç¼–å†™APIå…¼å®¹æ€§æµ‹è¯•

### é£é™©2: å¿«æ·é”®å†²çª âš ï¸ ä½é£é™©

**æè¿°**: é»˜è®¤å¿«æ·é”®å¯èƒ½ä¸ç”¨æˆ·å·²æœ‰å¿«æ·é”®å†²çª

**ç¼“è§£ç­–ç•¥**:
- ä½¿ç”¨ä¸å¤ªå¸¸ç”¨çš„å¿«æ·é”®ç»„åˆ
- æä¾›æ¸…æ™°çš„å†²çªæç¤º
- æ”¯æŒç”¨æˆ·è‡ªå®šä¹‰

### é£é™©3: èœå•æ€§èƒ½ âš ï¸ ä½é£é™©

**æè¿°**: å¤§é‡èœå•é¡¹å¯èƒ½å½±å“å“åº”é€Ÿåº¦

**ç¼“è§£ç­–ç•¥**:
- ä½¿ç”¨æ‡’åŠ è½½å­èœå•
- ä¼˜åŒ–èœå•æ„å»ºé€»è¾‘
- å“åº”æ—¶é—´ç›®æ ‡<50ms

---

## ğŸ“ Storyå®Œæˆå®šä¹‰ (Definition of Done)

- [ ] æ‰€æœ‰5ä¸ªTaskå®Œæˆå¹¶é€šè¿‡Code Review
- [ ] æ‰€æœ‰10ä¸ªéªŒæ”¶æ ‡å‡†é€šè¿‡
- [ ] å•å…ƒæµ‹è¯•è¦†ç›–ç‡â‰¥80%
- [ ] é›†æˆæµ‹è¯•é€šè¿‡ï¼ˆè‡³å°‘3ä¸ªE2Eåœºæ™¯ï¼‰
- [ ] æ€§èƒ½æµ‹è¯•è¾¾æ ‡ï¼ˆèœå•<50msï¼Œå¿«æ·é”®<30msï¼‰
- [ ] Accessibilityæµ‹è¯•é€šè¿‡
- [ ] æŠ€æœ¯æ–‡æ¡£æ›´æ–°ï¼ˆREADMEã€APIæ–‡æ¡£ï¼‰
- [ ] ç”¨æˆ·æ‰‹å†Œå¢åŠ "å³é”®èœå•å’Œå¿«æ·é”®"ç« èŠ‚
- [ ] Code Reviewé€šè¿‡ï¼ˆè‡³å°‘2ä¸ªå®¡é˜…è€…æ‰¹å‡†ï¼‰
- [ ] [SCP-003] å¤‡ä»½ä¿æŠ¤åŠŸèƒ½éªŒæ”¶é€šè¿‡

---

## ğŸ‰ Storyä»·å€¼

**ç”¨æˆ·ä»·å€¼**:
- æä¾›ä¾¿æ·çš„æ“ä½œå…¥å£ï¼Œé™ä½å­¦ä¹ ç³»ç»Ÿä½¿ç”¨é—¨æ§›
- æ”¯æŒè‡ªå®šä¹‰å¿«æ·é”®ï¼Œæ»¡è¶³é«˜çº§ç”¨æˆ·éœ€æ±‚
- [SCP-003] ä¿æŠ¤é‡è¦å¤‡ä»½ï¼Œé˜²æ­¢è¯¯åˆ 

**æŠ€æœ¯ä»·å€¼**:
- å»ºç«‹ç»Ÿä¸€çš„èœå•å’Œå¿«æ·é”®æ¶æ„
- ä¸ºåç»­åŠŸèƒ½æä¾›å¯å¤ç”¨çš„UIç»„ä»¶
- é›†æˆSCP-003å¤‡ä»½ä¿æŠ¤è§„èŒƒ

**å•†ä¸šä»·å€¼**:
- æå‡ç”¨æˆ·ä½“éªŒï¼Œå¢åŠ ç”¨æˆ·ç²˜æ€§
- æ»¡è¶³ç”¨æˆ·æ ¸å¿ƒéœ€æ±‚ï¼ˆå¿«æ·æ“ä½œï¼‰
- å±•ç¤ºäº§å“ä¸“ä¸šæ€§

---

**Storyåˆ›å»ºæ—¥æœŸ**: 2025-11-30
**Storyä½œè€…**: SM Agent (Bob)
**å®¡æ‰¹çŠ¶æ€**: â³ å¾…å®¡æ‰¹
