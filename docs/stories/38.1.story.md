# Story 38.1: LanceDB Auto-Index Trigger

## Story
As a learner,
I want my Canvas node changes to be automatically indexed in LanceDB,
So that RAG context retrieval always has up-to-date content without manual API calls.

## Status
done

## Acceptance Criteria

**AC-1 (D1: Persistence — Write Trigger)**
Given a Canvas node is created or updated via the API
When the backend processes the CRUD request
Then a LanceDB index update is triggered automatically (async, non-blocking)
And the index update completes within 5 seconds of the CRUD operation
And no manual POST `/metadata/index` call is required

**AC-2 (D2: Resilience — Failure Handling)**
Given the automatic LanceDB index update fails (connection error, timeout)
When the error occurs
Then the CRUD operation still succeeds (index failure must not block CRUD)
And the failed index update is queued for retry (max 3 attempts, exponential backoff)
And a WARNING log is emitted: `"LanceDB index update failed for node {id}, queued for retry"`

**AC-3 (D1: Persistence — Startup Recovery)**
Given the application restarts with pending index updates in the queue
When the application starts
Then pending updates are retried during startup
And a startup log shows: `"LanceDB: {N} pending index updates recovered"`

## Tasks/Subtasks

- [x] Task 1: Create `LanceDBIndexService` with debounced scheduling
  - [x] 1.1: Implement `schedule_index()` with per-canvas debounce (500ms default)
  - [x] 1.2: Add `ENABLE_LANCEDB_AUTO_INDEX`, `LANCEDB_INDEX_DEBOUNCE_MS`, `LANCEDB_INDEX_TIMEOUT` config fields
  - [x] 1.3: Implement `_debounced_index()` with `asyncio.sleep` + cancel logic
  - [x] 1.4: Implement lazy `_get_or_init_client()` for LanceDB client
- [x] Task 2: Implement retry and failure handling
  - [x] 2.1: Add `_do_index_with_retry()` with tenacity (3 attempts, exponential backoff)
  - [x] 2.2: Implement `_do_index()` — read canvas file, resolve subject, call `client.index_canvas()`
  - [x] 2.3: Implement `_persist_pending()` — write failed operations to JSONL
  - [x] 2.4: Add `_client_unavailable` fast-fail flag for missing `agentic_rag` module
- [x] Task 3: Implement startup recovery (AC-3)
  - [x] 3.1: Implement `recover_pending()` — read JSONL, deduplicate, retry, rewrite
  - [x] 3.2: Call `recover_pending()` in `main.py` lifespan startup
  - [x] 3.3: Implement `cleanup()` for shutdown — cancel pending debounce tasks
- [x] Task 4: Hook into CanvasService CRUD
  - [x] 4.1: Add `_trigger_lancedb_index()` to CanvasService (lazy import, try/except)
  - [x] 4.2: Call from `add_node()`, `update_node()`, `delete_node()`
- [x] Task 5: Write unit tests (27 tests across 4 files)
  - [x] 5.1: AC-1 tests — config defaults, schedule_index, debounce, CRUD hooks (9 tests)
  - [x] 5.2: AC-2 tests — retry 3x, WARNING log, JSONL persist, CRUD isolation (4 tests)
  - [x] 5.3: AC-3 tests — empty file, recovery, partial failure, dedup, log (5 tests)
  - [x] 5.4: Singleton + cleanup tests (3 tests)
  - [x] 5.5: Review fix tests — _do_index coverage, concurrency guard, fast-fail, delete trigger (6 tests)

### Review Follow-ups (AI)
- [x] [AI-Review][HIGH] H2: Add `threading.Lock` to `_persist_pending()` and `recover_pending()` for JSONL concurrent write safety (Windows platform risk) — fixed: `self._file_lock` guards all JSONL file operations
- [x] [AI-Review][HIGH] H3: Thread `trigger_node_id` through full call chain for AC-2 node-level logging — fixed: `canvas_service._trigger_lancedb_index(node_id=)` → `schedule_index(trigger_node_id=)` → `_debounced_index()` → WARNING/INFO logs include `(triggered by node {id})`
- [x] [AI-Review][MEDIUM] M1: Use `_do_index_with_retry()` instead of `_do_index()` in `recover_pending()` for consistency (3 retries vs 1) — fixed: `recover_pending()` now calls `_do_index_with_retry()` with 3x exponential backoff
- [x] [AI-Review][MEDIUM] M2: Clean up completed tasks from `_pending_tasks` dict to prevent memory leak — fixed: `task.add_done_callback()` with identity check auto-removes completed tasks
- [x] [AI-Review][MEDIUM] M3: Replace `except Exception: pass` with `logger.debug()` in `_do_index()` initialize block — fixed: now logs `"LanceDB client.initialize() skipped: {e}"` at DEBUG level
- [x] [AI-Review][MEDIUM] M4: `recover_pending()` uses `write_text()` which could overwrite concurrent appends — fixed: `self._file_lock` guards `recover_pending()` file write/unlink [`lancedb_index_service.py:150-164`]
- [x] [AI-Review][MEDIUM] M5: Edge operations do not trigger LanceDB re-index — **N/A**: `index_canvas()` only indexes text nodes (L331-334 in `lancedb_client.py`), edge data is not stored in LanceDB index, no re-index needed
- [x] [AI-Review][LOW] L1: `test_schedule_index_creates_async_task` uses manual `asyncio.new_event_loop()` — fixed: converted to `@pytest.mark.asyncio` async test, removed helper method
- [x] [AI-Review][LOW] L2: `table_name="canvas_nodes"` hardcoded — fixed: added `LANCEDB_INDEX_TABLE_NAME` config field (default `"canvas_nodes"`), used `settings.LANCEDB_INDEX_TABLE_NAME` in `_do_index()`

## Dev Notes

### Code References
| File | Line | Description |
|------|------|-------------|
| `backend/app/services/lancedb_index_service.py` | L1-318 | Core service: schedule, debounce, retry, persist, recover |
| `backend/app/services/canvas_service.py` | L338-354 | `_trigger_lancedb_index()` — fire-and-forget hook |
| `backend/app/services/canvas_service.py` | L691,739,778 | CRUD methods calling `_trigger_lancedb_index()` |
| `backend/app/config.py` | L418-431 | `ENABLE_LANCEDB_AUTO_INDEX`, `LANCEDB_INDEX_DEBOUNCE_MS`, `LANCEDB_INDEX_TIMEOUT` |
| `backend/app/main.py` | L137-153 | Startup: `recover_pending()` call |
| `backend/app/main.py` | L168-176 | Shutdown: `cleanup()` call |

### Architecture
- `LanceDBIndexService` is a module-level singleton (`get_lancedb_index_service()`)
- Per-canvas debounce (500ms) coalesces rapid CRUD updates
- Tenacity retry: 3 attempts, exponential backoff (1s, 2s, 4s)
- Failed operations persisted to `backend/data/lancedb_pending_index.jsonl`
- Startup recovery reads JSONL, deduplicates by canvas_name, retries
- Lazy LanceDB client initialization via `agentic_rag.clients.lancedb_client`
- `_client_unavailable` flag prevents repeated import attempts when module missing

## Dev Agent Record

### Implementation Plan
1. Create `LanceDBIndexService` class with debounce, retry, JSONL persistence
2. Add 3 config fields to Settings (auto_index, debounce_ms, timeout)
3. Add `_trigger_lancedb_index()` hook to CanvasService
4. Wire into `add_node()`, `update_node()`, `delete_node()`
5. Add startup recovery in `main.py` lifespan
6. Add shutdown cleanup in `main.py` lifespan
7. Write 27 unit tests across 4 files

### Debug Log
- All 27 tests pass on first run
- Regression tests pass (no breakage)

### Completion Notes
- AC-1: `add_node()`, `update_node()`, `delete_node()` all call `_trigger_lancedb_index()` which uses `schedule_index()` for debounced async index. Config `ENABLE_LANCEDB_AUTO_INDEX=True` by default. Timeout 5s.
- AC-2: `_debounced_index()` catches all exceptions from `_do_index_with_retry()`. CRUD never blocked. Failed ops persisted to JSONL via `_persist_pending()`. WARNING log emitted.
- AC-3: `recover_pending()` called in `main.py` startup. Reads JSONL, deduplicates, retries. Cleanup on shutdown cancels pending debounce tasks.
- Review fixes applied: H1 (hasattr check), H2 (_do_index coverage), M1 (concurrency guard), M2 (fast-fail flag), M4 (delete_node trigger), L1 (log wording)

## File List
- `backend/app/services/lancedb_index_service.py` (new) — Core auto-index service with debounce, retry, JSONL persistence
- `backend/app/services/canvas_service.py` (modified) — Added `_trigger_lancedb_index()` hook, called from add/update/delete_node
- `backend/app/config.py` (modified) — Added `ENABLE_LANCEDB_AUTO_INDEX`, `LANCEDB_INDEX_DEBOUNCE_MS`, `LANCEDB_INDEX_TIMEOUT`
- `backend/app/main.py` (modified) — Added startup `recover_pending()` and shutdown `cleanup()`
- `backend/tests/unit/test_story_38_1_ac1_auto_trigger.py` (new) — 9 AC-1 tests
- `backend/tests/unit/test_story_38_1_ac2_failure_handling.py` (new) — 4 AC-2 tests
- `backend/tests/unit/test_story_38_1_ac3_startup_recovery.py` (new) — 8 AC-3 + lifecycle tests
- `backend/tests/unit/test_story_38_1_review_fixes.py` (new) — 6 review fix tests

## Change Log
- 2026-02-08: Fixed L1 (async test pattern), L2 (configurable table name) — all 9/9 review items resolved, 27/27 tests pass
- 2026-02-08: Fixed M1 (recover_pending retry consistency), M2 (task auto-cleanup callback), M3 (debug log instead of bare pass), M5 (N/A — edges not indexed) — 27/27 tests pass
- 2026-02-08: Fixed H2 (threading.Lock for JSONL safety), H3 (node_id propagation for AC-2 logging), M4 (recover_pending file lock) — 27/27 tests pass
- 2026-02-08: Created story file retroactively (was missing from initial implementation)
- 2026-02-08: Code Review — 3 HIGH, 5 MEDIUM, 2 LOW issues recorded as action items
- 2026-02-07: Initial implementation in commit `14f0412` (clean release) — all 3 ACs implemented, 27 tests passing
