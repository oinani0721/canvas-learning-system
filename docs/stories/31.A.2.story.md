# Story 31.A.2: å­¦ä¹ å†å²è¯»å–ä¿®å¤

## å…ƒæ•°æ®

| å±æ€§ | å€¼ |
|------|------|
| Story ID | 31.A.2 |
| EPIC | 31.A - è®°å¿†ç³»ç»Ÿç®¡é“ä¿®å¤ |
| ä¼˜å…ˆçº§ | P1 - High |
| çŠ¶æ€ | Draft |
| ä¿®å¤æ–­ç‚¹ | æ–­ç‚¹3: get_learning_history() åªè¯»å†…å­˜ä¸è¯» Neo4j |
| éªŒè¯æ—¥æœŸ | 2026-02-05 |
| éªŒè¯çŠ¶æ€ | âœ… ä»£ç ç°å®æ£€æŸ¥é€šè¿‡ |

---

## User Story

**As a** ç³»ç»Ÿç”¨æˆ·,
**I want** å­¦ä¹ å†å²åœ¨æœåŠ¡é‡å¯åä»èƒ½æ­£ç¡®è¿”å›,
**so that** æˆ‘çš„å­¦ä¹ è¿›åº¦æ•°æ®ä¸ä¼šå› æœåŠ¡é‡å¯è€Œä¸¢å¤±ã€‚

---

## 1. é—®é¢˜æè¿°

### 1.1 å½“å‰çŠ¶æ€

`memory_service.py:320-405` çš„ `get_learning_history()` åªä»å†…å­˜è¯»å–ï¼š

```python
# å½“å‰ä»£ç  - memory_service.py:360
episodes = [e for e in self._episodes if e.get("user_id") == user_id]
# âŒ åªè¯» self._episodesï¼ˆå†…å­˜ï¼‰ï¼Œä¸è¯» Neo4j
```

### 1.2 å½±å“

- é‡å¯æœåŠ¡åï¼Œ`self._episodes` è¢«æ¸…ç©º
- `GET /api/v1/memory/episodes` è¿”å›ç©ºåˆ—è¡¨
- å†å²å­¦ä¹ æ•°æ®"ä¸¢å¤±"ï¼ˆå®é™…åœ¨ Neo4j ä¸­ï¼Œä½†æœªè¢«è¯»å–ï¼‰
- ä¸ `get_review_suggestions()` è¡Œä¸ºä¸ä¸€è‡´ï¼ˆåè€…æ­£ç¡®è¯»å– Neo4jï¼‰

### 1.3 å¯¹æ¯”ï¼šæ­£ç¡®å®ç°

```python
# get_review_suggestions() - memory_service.py:558-601
async def get_review_suggestions(self, ...):
    # âœ… æ­£ç¡®ï¼šä» Neo4j è¯»å–
    suggestions = await self.neo4j.get_review_suggestions(
        user_id=user_id,
        limit=limit,
        group_id=group_id
    )
    return suggestions
```

---

## 2. éªŒæ”¶æ ‡å‡†

### AC-31.A.2.1: ä» Neo4j è¯»å–å­¦ä¹ å†å²

**æ–‡ä»¶**: `backend/app/services/memory_service.py`
**è¡Œå·**: 320-405

**ä¿®æ”¹å†…å®¹**:
```python
async def get_learning_history(
    self,
    user_id: str,
    start_date: Optional[datetime] = None,
    end_date: Optional[datetime] = None,
    concept: Optional[str] = None,
    subject: Optional[str] = None,
    page: int = 1,
    page_size: int = 50
) -> Dict[str, Any]:
    if not self._initialized:
        await self.initialize()

    # âœ… ä» Neo4j æŸ¥è¯¢ï¼ˆæ›¿ä»£åªè¯»å†…å­˜ï¼‰
    group_id = build_group_id(subject) if subject else None
    try:
        episodes = await self.neo4j.get_learning_history(
            user_id=user_id,
            start_date=start_date,
            end_date=end_date,
            concept=concept,
            group_id=group_id,
            limit=page_size * page  # è·å–è¶³å¤Ÿæ•°æ®ç”¨äºåˆ†é¡µ
        )
    except Exception as e:
        logger.warning(f"Neo4j query failed, falling back to memory: {e}")
        episodes = []

    # å›é€€åˆ°å†…å­˜ï¼ˆå¦‚æœ Neo4j ä¸å¯ç”¨æˆ–è¿”å›ç©ºï¼‰
    if not episodes:
        episodes = [e for e in self._episodes if e.get("user_id") == user_id]

    # ... åº”ç”¨è¿‡æ»¤ã€åˆ†é¡µé€»è¾‘ï¼ˆä¿æŒä¸å˜ï¼‰
```

**éªŒæ”¶æ¡ä»¶**:
- [ ] ä¼˜å…ˆä» Neo4j æŸ¥è¯¢å­¦ä¹ å†å²
- [ ] Neo4j ä¸å¯ç”¨æ—¶å›é€€åˆ°å†…å­˜
- [ ] å›é€€æ—¶è®°å½•è­¦å‘Šæ—¥å¿—

---

### AC-31.A.2.2: Neo4jClient æ–¹æ³•å®ç°

**æ–‡ä»¶**: `backend/app/clients/neo4j_client.py`

**éªŒæ”¶æ¡ä»¶**:
- [ ] ç¡®è®¤ `Neo4jClient.get_learning_history()` æ–¹æ³•å­˜åœ¨
- [ ] å¦‚æœä¸å­˜åœ¨ï¼Œå®ç°è¯¥æ–¹æ³•ï¼ˆå‚è€ƒ `get_review_suggestions()`ï¼‰
- [ ] æ”¯æŒ `user_id`, `start_date`, `end_date`, `concept`, `group_id`, `limit` å‚æ•°

---

### AC-31.A.2.3: è·¨ä¼šè¯æ•°æ®æŒä¹…åŒ–

**éªŒæ”¶æ¡ä»¶**:
- [ ] Session 1: è°ƒç”¨ `record_learning_event()` å†™å…¥æ•°æ®
- [ ] é‡å¯æœåŠ¡ï¼ˆæ¸…ç©ºå†…å­˜ï¼‰
- [ ] Session 2: è°ƒç”¨ `get_learning_history()` èƒ½è¿”å› Session 1 çš„æ•°æ®
- [ ] æ•°æ®å­—æ®µå®Œæ•´ï¼ˆconcept, score, timestamp, subjectï¼‰

---

### AC-31.A.2.4: åˆ†é¡µå’Œè¿‡æ»¤åŠŸèƒ½

**éªŒæ”¶æ¡ä»¶**:
- [ ] `page` å’Œ `page_size` å‚æ•°æ­£ç¡®å·¥ä½œ
- [ ] `concept` è¿‡æ»¤æ­£ç¡®å·¥ä½œ
- [ ] `subject` è¿‡æ»¤æ­£ç¡®å·¥ä½œï¼ˆé€šè¿‡ group_idï¼‰
- [ ] `start_date` å’Œ `end_date` è¿‡æ»¤æ­£ç¡®å·¥ä½œ

---

### AC-31.A.2.5: API ç«¯ç‚¹ä¾èµ–æ³¨å…¥ä¿®å¤ (ä»£ç ç°å®æ£€æŸ¥å‘ç°)

**é—®é¢˜**: `memory.py` ä¸­ GET ç«¯ç‚¹çš„ `MemoryServiceDep` å‚æ•°ä½¿ç”¨äº† `= None` é»˜è®¤å€¼ï¼Œå¯¼è‡´è¿è¡Œæ—¶ `NoneType` é”™è¯¯ã€‚

**æ–‡ä»¶**: `backend/app/api/v1/endpoints/memory.py`

**ä¿®æ”¹å†…å®¹**:
```python
# é”™è¯¯å†™æ³• (å½“å‰ä»£ç )
memory_service: MemoryServiceDep = None  # âŒ

# æ­£ç¡®å†™æ³•
memory_service: MemoryServiceDep  # âœ… ç§»é™¤ = None
```

**å½±å“è¡Œå·**:
- L174: `get_learning_history()` ç«¯ç‚¹
- L248: `get_concept_history()` ç«¯ç‚¹
- L292: `get_review_suggestions()` ç«¯ç‚¹

**éªŒæ”¶æ¡ä»¶**:
- [ ] ç§»é™¤ L174 çš„ `= None` é»˜è®¤å€¼
- [ ] ç§»é™¤ L248 çš„ `= None` é»˜è®¤å€¼
- [ ] ç§»é™¤ L292 çš„ `= None` é»˜è®¤å€¼
- [ ] æ‰€æœ‰ GET ç«¯ç‚¹èƒ½æ­£å¸¸è°ƒç”¨ï¼ˆæ—  NoneType é”™è¯¯ï¼‰

---

## 3. æŠ€æœ¯å®ç°

### 3.1 ä¿®æ”¹æ–‡ä»¶æ¸…å•

| æ–‡ä»¶ | ä¿®æ”¹ç±»å‹ | è¯´æ˜ |
|------|---------|------|
| `backend/app/services/memory_service.py` | ä¿®æ”¹ | ä» Neo4j è¯»å–å†å² (AC-1) |
| `backend/app/clients/neo4j_client.py` | æ–°å¢æ–¹æ³• | å®ç° get_learning_history() (AC-2) |
| `backend/app/api/v1/endpoints/memory.py` | ä¿®å¤ | ç§»é™¤ `= None` é»˜è®¤å€¼ (AC-5) |
| `backend/tests/integration/test_memory_persistence.py` | æ–°å»º | è·¨ä¼šè¯æŒä¹…åŒ–æµ‹è¯• (AC-3) |
| `backend/tests/unit/test_memory_service.py` | æ–°å¢ç”¨ä¾‹ | Neo4j æŸ¥è¯¢éªŒè¯æµ‹è¯• |

---

### 3.2 Tasks æ¸…å•

**Phase 1: åŸºç¡€è®¾æ–½ (é˜»å¡å…¶ä»–ä»»åŠ¡)**

- [ ] **Task 1.1** (AC-2): åœ¨ `neo4j_client.py` å®ç° `get_learning_history()` æ–¹æ³•
  - å‚è€ƒ `get_review_suggestions()` (L721-780)
  - å¤ç”¨ `_handle_query_history()` (L643) å¤„ç† JSON å›é€€
  - æ”¯æŒå‚æ•°: `user_id`, `start_date`, `end_date`, `concept`, `group_id`, `limit`

- [ ] **Task 1.2** (AC-5): ä¿®å¤ `memory.py` ä¾èµ–æ³¨å…¥é”™è¯¯
  - ç§»é™¤ L174, L248, L292 çš„ `= None` é»˜è®¤å€¼

**Phase 2: æ ¸å¿ƒé€»è¾‘**

- [ ] **Task 2.1** (AC-1): ä¿®æ”¹ `memory_service.py` çš„ `get_learning_history()`
  - ä¼˜å…ˆä» Neo4j æŸ¥è¯¢
  - æ·»åŠ  try/except å›é€€åˆ°å†…å­˜
  - ä¿ç•™ç°æœ‰åˆ†é¡µ/è¿‡æ»¤é€»è¾‘

**Phase 3: æµ‹è¯•éªŒè¯**

- [ ] **Task 3.1** (AC-3): ç¼–å†™è·¨ä¼šè¯æŒä¹…åŒ–é›†æˆæµ‹è¯•
- [ ] **Task 3.2** (AC-4): éªŒè¯åˆ†é¡µå’Œè¿‡æ»¤åŠŸèƒ½
- [ ] **Task 3.3**: è¿è¡Œç°æœ‰æµ‹è¯•ç¡®ä¿æ— å›å½’

### 3.3 Neo4j æŸ¥è¯¢ç¤ºä¾‹

```cypher
MATCH (u:User {id: $user_id})-[r:LEARNED]->(c:Concept)
WHERE ($start_date IS NULL OR r.timestamp >= $start_date)
  AND ($end_date IS NULL OR r.timestamp <= $end_date)
  AND ($concept IS NULL OR c.name CONTAINS $concept)
  AND ($group_id IS NULL OR r.group_id = $group_id)
RETURN c.name as concept, r.score as score, r.timestamp as timestamp,
       r.group_id as group_id, r.agent_type as agent_type
ORDER BY r.timestamp DESC
LIMIT $limit
```

---

## 4. æµ‹è¯•è®¡åˆ’

### 4.1 å•å…ƒæµ‹è¯•

```python
@pytest.mark.asyncio
async def test_get_learning_history_queries_neo4j():
    """éªŒè¯ get_learning_history ä» Neo4j æŸ¥è¯¢"""
    mock_neo4j = AsyncMock()
    mock_neo4j.get_learning_history = AsyncMock(return_value=[
        {"concept": "çŸ©é˜µ", "score": 85, "timestamp": "2026-02-05T10:00:00"}
    ])
    service = MemoryService(neo4j_client=mock_neo4j)
    await service.initialize()

    result = await service.get_learning_history(user_id="user1")

    mock_neo4j.get_learning_history.assert_called_once()
    assert len(result["items"]) == 1
    assert result["items"][0]["concept"] == "çŸ©é˜µ"
```

### 4.2 é›†æˆæµ‹è¯•

```python
@pytest.mark.asyncio
async def test_cross_session_persistence():
    """éªŒè¯è·¨ä¼šè¯æ•°æ®æŒä¹…åŒ–"""
    # Session 1: å†™å…¥
    service1 = MemoryService(neo4j_client=real_neo4j)
    await service1.initialize()
    await service1.record_learning_event(
        user_id="user1", concept="çº¿æ€§ä»£æ•°", score=90
    )
    await service1.close()

    # Session 2: è¯»å–
    service2 = MemoryService(neo4j_client=real_neo4j)
    await service2.initialize()
    result = await service2.get_learning_history(user_id="user1")

    assert len(result["items"]) > 0
    assert any(item["concept"] == "çº¿æ€§ä»£æ•°" for item in result["items"])
```

---

## 5. é£é™©ä¸ç¼“è§£

| é£é™© | ç¼“è§£æªæ–½ |
|------|---------|
| `Neo4jClient.get_learning_history()` ä¸å­˜åœ¨ | å…ˆæ£€æŸ¥ï¼Œå¿…è¦æ—¶å®ç° |
| Neo4j æŸ¥è¯¢æ€§èƒ½é—®é¢˜ | æ·»åŠ é€‚å½“ç´¢å¼•ï¼Œé™åˆ¶è¿”å›æ•°é‡ |
| ç°æœ‰æµ‹è¯•ä¾èµ–å†…å­˜è¡Œä¸º | æ›´æ–°æµ‹è¯•æˆ–æ·»åŠ å›é€€é€»è¾‘ |

---

## 6. Definition of Done

- [ ] æ‰€æœ‰ AC å®Œæˆå¹¶é€šè¿‡éªŒè¯
- [ ] æ–°å¢æµ‹è¯•é€šè¿‡
- [ ] ç°æœ‰æµ‹è¯•ä¸å›å½’
- [ ] è·¨ä¼šè¯æŒä¹…åŒ–éªŒè¯é€šè¿‡
- [ ] ä»£ç  review é€šè¿‡

---

## ç‰ˆæœ¬å†å²

| ç‰ˆæœ¬ | æ—¥æœŸ | å˜æ›´ |
|------|------|------|
| 1.0 | 2026-02-05 | åˆå§‹åˆ›å»º |
| 1.1 | 2026-02-05 | PO Agent éªŒè¯ï¼šæ·»åŠ  User Story æ ¼å¼ã€AC-31.A.2.5 (API ä¾èµ–æ³¨å…¥ä¿®å¤)ã€Tasks æ¸…å• |

---

## Dev Notes

### ä»£ç ç°å®æ£€æŸ¥ç»“æœ (2026-02-05)

é€šè¿‡ 4 ä¸ªå¹¶è¡Œ Explore Agent éªŒè¯ï¼š

| æ£€æŸ¥é¡¹ | ç»“æœ |
|--------|------|
| `get_learning_history()` åªè¯»å†…å­˜ | âœ… ç¡®è®¤ (L360) |
| `Neo4jClient.get_learning_history()` ä¸å­˜åœ¨ | âœ… ç¡®è®¤ (éœ€å®ç°) |
| `get_review_suggestions()` æ­£ç¡®è¯» Neo4j | âœ… ç¡®è®¤ (L594) |
| API ç«¯ç‚¹ä¾èµ–æ³¨å…¥é”™è¯¯ | ğŸ”´ æ–°å‘ç° (L174, L248, L292) |

### å¯å¤ç”¨ä»£ç å‚è€ƒ

- `Neo4jClient._handle_query_history()` (L643): JSON å›é€€æ¨¡å¼ä¸‹çš„å†å²æŸ¥è¯¢å®ç°
- `Neo4jClient.get_review_suggestions()` (L721-780): Cypher æŸ¥è¯¢æ¨¡å¼å‚è€ƒ
- `build_group_id()`: å­¦ç§‘è¿‡æ»¤çš„ group_id æ„å»ºå‡½æ•°
