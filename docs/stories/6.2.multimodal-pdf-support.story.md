# Story 6.2: PDF节点类型支持

## Status
Completed

## Story

**As a** Canvas学习用户,
**I want** 在概念节点上附加PDF文档,
**so that** 我可以关联教材章节和论文

## Epic Context

**Epic**: SCP-006 多模态文件关联
**Phase**: Phase 1 - 基础多模态支持
**Priority**: P1
**Estimated Time**: 2天

## Dependencies

- ✅ Epic 12 (Agentic RAG) - 已完成
- ✅ Story 6.1 (图片支持) - 同Phase可并行
- ⏳ Epic 13.1 (Obsidian Plugin Core) - 推荐先完成

## Acceptance Criteria

### AC 6.2.1: Canvas节点可附加PDF文件
- [x] 支持.pdf格式
- [x] 文件大小限制: 50MB
- [x] 错误提示：不支持的格式/文件过大

### AC 6.2.2: 显示PDF首页缩略图
- [x] 自动生成首页缩略图(150x200px)
- [x] 点击打开PDF预览
- [x] 加载时显示占位符

### AC 6.2.3: 支持指定页码范围
- [x] 可选择附加特定页码范围
- [x] 格式: "1-10" 或 "1,3,5-8"
- [x] 默认: 全部页面

### AC 6.2.4: PDF元数据存储到Neo4j
- [x] 存储: 文件路径、标题、作者、页数
- [x] 建立: (Concept)-[:HAS_MEDIA]->(Media:PDF) 关系
- [x] 支持: 一个概念多个PDF
- [x] 支持: 删除关联

## Tasks / Subtasks

- [x] Task 1: 创建PDFProcessor类 (AC: 6.2.1, 6.2.2)
  - [x] 实现格式验证
  - [x] 实现首页缩略图生成 (PyMuPDF)
  - [x] 实现元数据提取 (标题、作者)
  - [x] 编写单元测试

- [x] Task 2: 实现页码范围解析 (AC: 6.2.3)
  - [x] 解析 "1-10" 格式
  - [x] 解析 "1,3,5-8" 混合格式
  - [x] 验证页码有效性

- [x] Task 3: 扩展MultimodalNode数据模型 (AC: 6.2.4)
  - [x] 添加PDF特有字段 (page_count, page_range)
  - [x] 更新Neo4j Cypher脚本

- [x] Task 4: 实现Canvas节点PDF附加功能 (AC: 6.2.1)
  - [x] 修改canvas_utils.py添加attach_pdf()
  - [x] 实现Canvas JSON更新

## Dev Notes

### 技术栈

```yaml
PDF处理:
  库: PyMuPDF (fitz)
  缩略图: page.get_pixmap()
  元数据: doc.metadata

存储:
  元数据: Neo4j (Media:PDF节点)
  原始文件: Obsidian Vault (不移动)
  缩略图: .obsidian/plugins/canvas-review/cache/pdf/

Canvas集成:
  节点扩展: 添加 "attachments" 字段 (复用6.1)
```

### 代码位置

```
创建文件:
- src/agentic_rag/processors/pdf_processor.py

修改文件:
- src/agentic_rag/models/multimodal_node.py (添加PDF字段)
- src/canvas_utils.py (添加 attach_pdf)
- scripts/init_multimodal_schema.cypher (添加PDF约束)

测试文件:
- src/tests/test_pdf_processor.py
```

### API设计

```python
# PDFProcessor API
class PDFProcessor:
    MAX_SIZE_MB = 50
    THUMBNAIL_SIZE = (150, 200)

    async def process(self, pdf_path: Path, page_range: str = None) -> PDFMetadata
    async def generate_thumbnail(self, pdf_path: Path) -> str  # base64
    def parse_page_range(self, range_str: str, total_pages: int) -> list[int]
    def extract_metadata(self, pdf_path: Path) -> dict
```

### Neo4j Schema扩展

```cypher
// PDF节点属性
// - id: UUID
// - type: "pdf"
// - path: 文件路径
// - title: PDF标题
// - author: 作者
// - page_count: 总页数
// - page_range: 选择的页码范围 (可选)
// - created_at: datetime
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-30 | 1.0 | Initial Story Creation | SM Agent (Bob) |

## QA Results

### Review Date: 待开发

### Reviewed By: 待开发

### Test Results
待开发

---

**关联文档**:
- SCP-006-MULTIMODAL-ASSOCIATION.md
- SCP-006-IMPLEMENTATION-PLAN.md
- Story 6.1 (图片支持)
