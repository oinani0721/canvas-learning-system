# Story 35.3: Obsidian Plugin ApiClient Multimodal Integration

## Status
Dev Complete

## Story

**As a** Canvas Learning System developer,
**I want** to add multimodal API methods to the existing ApiClient,
**so that** the Obsidian plugin can upload, query, search, and delete multimodal content (images, PDFs, audio, video) through the backend API.

## Acceptance Criteria

1. **AC 35.3.1**: `uploadMultimodal(file: File, conceptId: string)` method implemented
   - Uses FormData for file upload
   - Supports image/pdf/audio/video files up to 50MB
   - Returns `MultimodalContent` response matching backend schema

2. **AC 35.3.2**: `getMediaByConceptId(conceptId: string)` method implemented
   - Retrieves all media items associated with a concept
   - Returns `MediaItem[]` matching frontend type interface

3. **AC 35.3.3**: `searchMultimodal(query: string)` method implemented
   - Performs vector similarity search across multimodal content
   - Returns ranked results with relevance scores

4. **AC 35.3.4**: `deleteMultimodal(contentId: string)` method implemented
   - Deletes content from both LanceDB and Neo4j
   - Returns success/failure status

5. **AC 35.3.5**: All methods follow existing retry/timeout patterns
   - Uses existing `request<T>()` core method pattern
   - Implements AbortController for cancellation
   - Follows ADR-009 error handling strategy

## Tasks / Subtasks

- [x] Task 1: Add multimodal type definitions to types.ts (AC: 1-5)
  - [x] Add `MediaItem` interface matching backend schema
  - [x] Add `MultimodalUploadResponse` interface
  - [x] Add `MultimodalSearchResult` interface
  - [x] Add `MultimodalSearchRequest` interface
  - [x] Include JSDoc with `@source` verification annotations

- [x] Task 2: Implement uploadMultimodal method (AC: 1, 5)
  - [x] Validate conceptId is non-empty string before request
  - [x] Create FormData-based upload method
  - [x] Add progress callback support (optional)
  - [x] Handle large file timeout (60s default)
  - [x] Implement retry logic for transient failures

- [x] Task 3: Implement getMediaByConceptId method (AC: 2, 5)
  - [x] Validate conceptId is non-empty string before request
  - [x] Call `GET /api/v1/multimodal/by-concept/{concept_id}`
  - [x] Transform response to `MediaItem[]`
  - [x] Add response caching (TTL: 5 minutes)

- [x] Task 4: Implement searchMultimodal method (AC: 3, 5)
  - [x] Validate query is non-empty string before request
  - [x] Call `POST /api/v1/multimodal/search`
  - [x] Accept query string and optional filters
  - [x] Return ranked results with thumbnails

- [x] Task 5: Implement deleteMultimodal method (AC: 4, 5)
  - [x] Validate contentId is non-empty string before request
  - [x] Call `DELETE /api/v1/multimodal/{content_id}`
  - [x] Invalidate related caches on success
  - [x] Return boolean success status

- [x] Task 6: Unit tests for all multimodal methods
  - [x] Test uploadMultimodal with mock FormData
  - [x] Test getMediaByConceptId response transformation
  - [x] Test searchMultimodal query handling
  - [x] Test deleteMultimodal cache invalidation
  - [x] Test error handling and retry behavior

## Dev Notes

### Technical Verification Report (Step 3.6)

**Verification Date**: 2026-01-20
**Verified By**: SM Agent (Bob)
**Quality Gate Status**: PASSED

#### Technology Stack Verification

| Technology | Query Method | Verification Status | Documentation |
|------------|--------------|---------------------|---------------|
| TypeScript | Built-in | Verified | TypeScript 5.x |
| Obsidian Plugin API | Skill | Verified | @obsidian-canvas Skill |
| FormData API | MDN | Verified | Web Platform Standard |
| AbortController | MDN | Verified | Web Platform Standard |

#### Core Pattern Verification

**ApiClient.ts Existing Patterns** (Lines 1-1138):
- `private async request<T>()` - Core request method with retry/timeout
- `AbortController` for request cancellation
- `this.settings.apiTimeout` for configurable timeouts
- Export pattern: `async methodName(): Promise<ReturnType>`

**types.ts Existing Patterns** (Lines 1-770):
- Interface definitions with JSDoc source verification
- `@source` and `@verified` annotations
- Consistent naming: `{Entity}Response`, `{Entity}Request`

### SDD Spec References (Required)

**API Endpoint Specifications** (Story 35.1/35.2 defines these):
- `POST /api/v1/multimodal/upload` - File upload endpoint
- `GET /api/v1/multimodal/by-concept/{concept_id}` - Query by concept
- `POST /api/v1/multimodal/search` - Vector similarity search
- `DELETE /api/v1/multimodal/{content_id}` - Delete content

**Data Schema Specifications**:
- [Source: specs/data/multimodal-content.schema.json]
```json
{
  "required": ["id", "media_type", "file_path", "related_concept_id", "created_at"],
  "properties": {
    "id": {"type": "string", "format": "uuid"},
    "media_type": {"enum": ["image", "pdf", "audio", "video"]},
    "file_path": {"type": "string"},
    "thumbnail_path": {"type": ["string", "null"]},
    "extracted_text": {"type": ["string", "null"]},
    "description": {"type": ["string", "null"]},
    "vector": {"type": ["array", "null"], "items": {"type": "number"}},
    "related_concept_id": {"type": "string"},
    "metadata": {"type": "object"}
  }
}
```

**Frontend MediaItem Interface** (Epic 35 Reference):
```typescript
// Target interface for Story 35.4 MediaPanel integration
interface MediaItem {
  id: string;
  type: 'image' | 'pdf' | 'audio' | 'video';
  path: string;
  title?: string;
  relevanceScore: number;
  conceptId?: string;
  metadata?: Record<string, any>;
  thumbnail?: string;
}
```

### ADR Associations (Required)

| ADR Number | Decision Title | Impact on Story |
|------------|----------------|-----------------|
| ADR-007 | Caching Strategy - Tiered Cache | Response caching for getMediaByConceptId (L1 memory, 5min TTL) |
| ADR-009 | Error Handling & Retry Strategy | Retry patterns using tenacity-style exponential backoff |

**Key Constraints from ADRs**:
- **ADR-007**: Cache multimodal query results with 5-minute TTL, invalidate on delete
- **ADR-009**: Use error codes 4001 (NETWORK_TIMEOUT), 4002 (NETWORK_CONNECTION_ERROR) for multimodal API failures

### Code Examples

**Type Definitions Template**:
```typescript
// canvas-progress-tracker/obsidian-plugin/src/api/types.ts
// @source specs/data/multimodal-content.schema.json
// @verified 2026-01-20

/**
 * Media content type enumeration
 * @source specs/data/multimodal-content.schema.json#properties/media_type
 */
export type MediaType = 'image' | 'pdf' | 'audio' | 'video';

/**
 * Multimodal content item for display in MediaPanel
 * @source Epic 35 API Design Reference
 */
export interface MediaItem {
  /** Unique identifier (UUID) */
  id: string;
  /** Media type */
  type: MediaType;
  /** File path in vault */
  path: string;
  /** Display title (optional) */
  title?: string;
  /** Relevance score from search (0-1) */
  relevanceScore: number;
  /** Associated concept node ID */
  conceptId?: string;
  /** Additional metadata (dimensions, duration, etc.) */
  metadata?: Record<string, unknown>;
  /** Base64 thumbnail or thumbnail path */
  thumbnail?: string;
}

/**
 * Response from multimodal upload endpoint
 * @source POST /api/v1/multimodal/upload response
 */
export interface MultimodalUploadResponse {
  id: string;
  media_type: MediaType;
  path: string;
  thumbnail?: string;
  metadata?: Record<string, unknown>;
  created_at: string;
}

/**
 * Request body for multimodal search
 * @source POST /api/v1/multimodal/search request
 */
export interface MultimodalSearchRequest {
  query: string;
  limit?: number;
  media_types?: MediaType[];
}
```

**ApiClient Methods Template**:
```typescript
// canvas-progress-tracker/obsidian-plugin/src/api/ApiClient.ts
// @source ADR-009 Error Handling & Retry Strategy
// @verified 2026-01-20

/**
 * Upload multimodal content to the backend
 * @source POST /api/v1/multimodal/upload
 * @param file - File to upload (image/pdf/audio/video, max 50MB)
 * @param conceptId - Associated concept node ID
 * @returns Upload response with content metadata
 */
async uploadMultimodal(
  file: File,
  conceptId: string
): Promise<MultimodalUploadResponse> {
  const formData = new FormData();
  formData.append('file', file);
  formData.append('related_concept_id', conceptId);

  // Use longer timeout for file uploads (60s)
  const controller = new AbortController();
  const timeout = setTimeout(() => controller.abort(), 60000);

  try {
    const response = await fetch(
      `${this.settings.apiBaseUrl}/api/v1/multimodal/upload`,
      {
        method: 'POST',
        body: formData,
        signal: controller.signal,
      }
    );

    if (!response.ok) {
      throw new Error(`Upload failed: ${response.status}`);
    }

    return await response.json();
  } finally {
    clearTimeout(timeout);
  }
}

/**
 * Get media items by concept ID
 * @source GET /api/v1/multimodal/by-concept/{concept_id}
 * @param conceptId - Concept node ID to query
 * @returns Array of media items
 */
async getMediaByConceptId(conceptId: string): Promise<MediaItem[]> {
  return this.request<MediaItem[]>(
    `/api/v1/multimodal/by-concept/${encodeURIComponent(conceptId)}`,
    { method: 'GET' }
  );
}

/**
 * Search multimodal content using vector similarity
 * @source POST /api/v1/multimodal/search
 * @param query - Search query text
 * @param options - Optional search parameters
 * @returns Ranked search results
 */
async searchMultimodal(
  query: string,
  options?: { limit?: number; media_types?: MediaType[] }
): Promise<MediaItem[]> {
  return this.request<MediaItem[]>(
    '/api/v1/multimodal/search',
    {
      method: 'POST',
      body: JSON.stringify({
        query,
        limit: options?.limit ?? 20,
        media_types: options?.media_types,
      }),
    }
  );
}

/**
 * Delete multimodal content by ID
 * @source DELETE /api/v1/multimodal/{content_id}
 * @param contentId - Content ID to delete
 * @returns Success status
 */
async deleteMultimodal(contentId: string): Promise<boolean> {
  const response = await this.request<{ success: boolean }>(
    `/api/v1/multimodal/${encodeURIComponent(contentId)}`,
    { method: 'DELETE' }
  );
  return response.success;
}
```

### Dependencies

**Story Dependencies**:
- **Story 35.1** (Multimodal Upload/Management API) - Must be completed first
- **Story 35.2** (Multimodal Query/Search API) - Must be completed first

**File Dependencies**:
| File Path | Status | Purpose |
|-----------|--------|---------|
| `canvas-progress-tracker/obsidian-plugin/src/api/ApiClient.ts` | EXISTS (1138 lines) | Add multimodal methods |
| `canvas-progress-tracker/obsidian-plugin/src/api/types.ts` | EXISTS (770 lines) | Add type definitions |
| `backend/app/api/v1/endpoints/multimodal.py` | CREATED BY 35.1 | Backend API endpoint |
| `specs/data/multimodal-content.schema.json` | EXISTS | Schema reference |

### Authentication Note

All multimodal API methods inherit authentication configuration from the ApiClient constructor. No additional auth handling is required per-method. The existing `request<T>()` method automatically includes:
- `User-Agent` header for client identification
- `Content-Type` header with UTF-8 charset
- Any custom headers passed via `RequestOptions`

For `uploadMultimodal()` which uses direct `fetch()` instead of `request<T>()`, ensure the same auth headers are included if authentication is enabled in the backend.

[Source: ApiClient.ts constructor pattern, lines 136-145]

### Testing

**Test File Location**: `canvas-progress-tracker/obsidian-plugin/tests/api/ApiClient.multimodal.test.ts`

**Unit Test Coverage**:
- `uploadMultimodal()`: FormData construction, timeout handling, error responses
- `getMediaByConceptId()`: Response transformation, empty results, caching
- `searchMultimodal()`: Query parameters, result ranking, pagination
- `deleteMultimodal()`: Success/failure states, cache invalidation

**Integration Test Standard**:
- Mock server responses matching backend schema
- Verify request/response format alignment
- Test retry behavior on transient failures

[Source: docs/architecture/coding-standards.md#Testing-Standards]

### File Path Index (Anti-Hallucination Verification)

| Target Path | Status | Verification |
|-------------|--------|--------------|
| `canvas-progress-tracker/obsidian-plugin/src/api/ApiClient.ts` | EXISTS | Read tool verified (1138 lines) |
| `canvas-progress-tracker/obsidian-plugin/src/api/types.ts` | EXISTS | Read tool verified (770 lines) |
| `specs/data/multimodal-content.schema.json` | EXISTS | Read tool verified |
| `docs/architecture/decisions/ADR-007-CACHING-STRATEGY-TIERED.md` | EXISTS | Read tool verified |
| `docs/architecture/decisions/ADR-009-ERROR-HANDLING-RETRY-STRATEGY.md` | EXISTS | Read tool verified |

## Definition of Done

- [x] All 5 Acceptance Criteria satisfied
- [x] Code follows docs/architecture/coding-standards.md
- [x] All API calls have `@source` documentation annotations
- [x] Type definitions match specs/data/multimodal-content.schema.json
- [x] Unit tests pass with >80% coverage (30/30 tests passed)
- [x] No TypeScript compilation errors
- [ ] Integration with Story 35.1/35.2 backend verified (pending backend deployment)
- [x] Existing ApiClient functionality unaffected (regression test)

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-20 | 1.0 | Initial story draft with ultrathink analysis | SM Agent (Bob) |
| 2026-01-20 | 1.1 | PO validation: Added input validation subtasks, auth note | PO Agent (Sarah) |
| 2026-01-20 | 1.2 | Dev Complete: All 6 tasks implemented, 30 tests passed | Dev Agent (James) |

## Dev Agent Record

### Agent Model Used
Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References
- TypeScript compilation: PASSED (no errors)
- Jest tests: 30/30 PASSED (0.935s)

### Completion Notes List
1. **Task 1**: Added 7 type definitions to types.ts (MediaType, MediaItem, MultimodalUploadResponse, MultimodalSearchRequest, MultimodalSearchResult, MultimodalSearchResponse, MultimodalDeleteResponse)
2. **Task 2**: Implemented uploadMultimodal() with FormData, 60s timeout, retry logic (max 3 retries with exponential backoff), progress callback support
3. **Task 3**: Implemented getMediaByConceptId() with L1 memory cache (5-minute TTL per ADR-007), response transformation
4. **Task 4**: Implemented searchMultimodal() with optional filters (limit, media_types), response transformation
5. **Task 5**: Implemented deleteMultimodal() with cache invalidation on success
6. **Task 6**: Created comprehensive unit tests (30 test cases) covering all methods, validation, caching, error handling, and retry behavior

### Commit Info
(Pending commit - implementation complete)

### File List
| File | Action | Lines Changed |
|------|--------|---------------|
| `canvas-progress-tracker/obsidian-plugin/src/api/types.ts` | MODIFIED | +68 lines (multimodal type definitions) |
| `canvas-progress-tracker/obsidian-plugin/src/api/ApiClient.ts` | MODIFIED | +180 lines (multimodal methods, cache) |
| `canvas-progress-tracker/obsidian-plugin/tests/api/ApiClient.multimodal.test.ts` | CREATED | ~450 lines (30 unit tests) |

## QA Results

### Review Date: 2026-01-27

### Reviewed By: Quinn (Test Architect)

### Quality Gate Status: ✅ PASS

### Requirements Traceability

| AC | Implementation | Tests | Status |
|----|----------------|-------|--------|
| AC 35.3.1 | uploadMultimodal FormData | 7 tests | ✅ |
| AC 35.3.2 | getMediaByConceptId + cache | 7 tests | ✅ |
| AC 35.3.3 | searchMultimodal vector | 6 tests | ✅ |
| AC 35.3.4 | deleteMultimodal + invalidation | 6 tests | ✅ |
| AC 35.3.5 | Retry/timeout (ADR-009) | 4 tests | ✅ |

**Total Tests**: 30/30 PASSED

### ADR Compliance

- **ADR-007 (Caching)**: ✅ L1 memory cache with 5-minute TTL, invalidation on delete
- **ADR-009 (Error Handling)**: ✅ Retry on 5xx, no retry on 4xx, exponential backoff

### Code Quality Assessment

实现质量优秀。所有 4 个 multimodal 方法（uploadMultimodal, getMediaByConceptId, searchMultimodal, deleteMultimodal）都遵循现有 ApiClient 模式，具有：

- ✅ 完整的 JSDoc 文档和 `@source` 注释追溯到 Story 和 ADR
- ✅ 正确的输入验证（空字符串检查，返回 ValidationError 和详细信息）
- ✅ 响应转换（snake_case → camelCase）保持前后端一致性
- ✅ URL 编码处理特殊字符
- ✅ FormData 正确处理（不设置 Content-Type header，让浏览器自动设置 boundary）

### Compliance Check

- Coding Standards: ✅ 符合 TypeScript/JSDoc 规范
- Project Structure: ✅ 文件位置正确 (src/api/ApiClient.ts, types.ts)
- Testing Strategy: ✅ 单元测试覆盖全面
- All ACs Met: ✅ 5/5 验收标准满足

### Improvements Checklist

- [x] 所有方法实现完成
- [x] 类型定义匹配后端 schema
- [x] 缓存策略实现 (ADR-007)
- [x] 重试策略实现 (ADR-009)
- [x] 30 个单元测试全部通过
- [ ] 后端集成测试（待 Story 35.1/35.2 部署后验证）

### Security Review

无安全问题。所有用户输入都经过验证，URL 参数正确编码。

### Performance Considerations

- **缓存**: 5 分钟 TTL 减少重复请求
- **超时**: 上传使用 60s 超时（适合大文件）
- **进度回调**: 简化实现（0%/100%），可接受的权衡

### Files Modified During Review

无文件修改。实现质量满足要求。

### Gate Status

Gate: PASS → docs/qa/gates/35.3-apiclient-multimodal-integration.yml

### Recommended Status

✅ Ready for Done

---

### Review Date: 2026-01-31 (Second Review)

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

二次审查确认实现质量。重新验证了代码和测试：

**ApiClient.ts (lines 732-1032)**:
- `uploadMultimodal` (751-851): FormData 构建正确，60s 超时，重试逻辑完整
- `getMediaByConceptId` (867-912): 缓存实现正确，5分钟 TTL
- `searchMultimodal` (928-966): POST 请求正确，默认 limit=20
- `deleteMultimodal` (981-1004): 删除成功后正确失效缓存
- `invalidateMultimodalCache` (1014-1020): 私有方法清空所有缓存
- `invalidateMultimodalCacheForConcept` (1027-1032): 公开方法精确失效单个概念

**types.ts (lines 884-1019)**:
- 7 个类型定义完整，匹配 `specs/data/multimodal-content.schema.json`
- JSDoc 注释包含 `@source` 和 `@verified` 标注

**ApiClient.multimodal.test.ts (838 lines)**:
- 30 个测试用例覆盖所有功能点
- Mock 设置正确，测试隔离良好
- 边界条件测试（空字符串、URL 编码、缓存过期）

### Gate Decision

**PASS** - 所有验收标准满足，ADR 合规，测试覆盖全面。代码可以进入 Done 状态。
