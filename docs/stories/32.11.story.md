# Story 32.11: E2E é™çº§æµ‹è¯• + å¹¶å‘å®‰å…¨éªŒè¯

## Status

**Done**

---

## Story

**As a** Canvas Learning System developer,
**I want** to add E2E degradation tests and concurrent card state write safety tests,
**so that** the FSRSâ†’Ebbinghaus fallback path is end-to-end verified via HTTP, the TTL cache behavior is validated, and concurrent `_save_card_states()` calls don't corrupt the JSON file.

---

## Background

EPIC-32 å¯¹æŠ—æ€§ç»¼åˆå®¡æ ¸ (2026-02-10) å‘ç°ä»¥ä¸‹ P2 çº§è¦†ç›–ç‡ç¼ºå£ï¼š

1. **E2E é™çº§æµ‹è¯•ç¼ºå¤± (AC-32.3.5)**: P1 è¦†ç›–ç‡é—¨æ§ 89% (< 90% é˜ˆå€¼)ã€‚ç¼ºå°‘ `USE_FSRS=False` æ—¶å®Œæ•´ HTTP â†’ ReviewService â†’ Ebbinghaus fallback â†’ æ­£ç¡® JSON response çš„ç«¯åˆ°ç«¯éªŒè¯ã€‚å½“å‰åªæœ‰ unit çº§ fallback æµ‹è¯•ã€‚

2. **TTL cache è¿‡æœŸæµ‹è¯•ç¼ºå¤±**: `ReviewService.get_fsrs_state()` å¯èƒ½æœ‰ cache è¡Œä¸ºï¼Œä½† cache è¶…æ—¶åæ˜¯å¦æ­£ç¡®é‡æ–°åŠ è½½æœªè¢«éªŒè¯ã€‚**æ³¨æ„ï¼šç»åˆ†æï¼ŒReviewService ä½¿ç”¨ `_card_states` å­—å…¸ä½œä¸ºå†…å­˜ç¼“å­˜ï¼Œæ— æ˜¾å¼ TTL è¿‡æœŸæœºåˆ¶ï¼ˆEPIC-31 å¯¹æŠ—æ€§å®¡æ ¸å·²å°† TTLCache éæŒä¹…åŒ–è®°å½•ä¸ºå·²çŸ¥é™åˆ¶ï¼‰ã€‚æ­¤é¡¹ä¸åœ¨æœ¬ Story èŒƒå›´å†…ï¼Œå¦‚éœ€ TTL æµ‹è¯•åº”åœ¨ EPIC-31 åç»­ Story ä¸­å¤„ç†ã€‚**

3. **å¹¶å‘å†™å…¥å®‰å…¨æµ‹è¯•ç¼ºå¤±**: `_save_card_states()` ä½¿ç”¨ `asyncio.Lock` ä¿æŠ¤ JSON æ–‡ä»¶åŸå­å†™å…¥ï¼Œä½†ä»æœªæœ‰æµ‹è¯•éªŒè¯å¤šä¸ªå¹¶å‘ `asyncio.create_task` åŒæ—¶å†™åŒä¸€ concept æ—¶æ•°æ®ä¸ä¼šæŸåã€‚

**æ¥æº**: `_bmad-output/test-artifacts/epic-32-adversarial-comprehensive-20260210.md` Section 7 + Section 9

---

## Acceptance Criteria

### AC-32.11.1: E2E Ebbinghaus é™çº§æµ‹è¯•

- **Given** åç«¯é…ç½® `USE_FSRS=False`ï¼ˆæˆ– `FSRS_AVAILABLE=False` æ¨¡æ‹Ÿ py-fsrs æœªå®‰è£…ï¼‰
- **When** å®¢æˆ·ç«¯å‘é€ä»¥ä¸‹ HTTP è¯·æ±‚ï¼š
  1. `PUT /api/v1/review/record` (è®°å½•å¤ä¹ ç»“æœ)
  2. `GET /api/v1/review/schedule` (è·å–è°ƒåº¦)
  3. `GET /api/v1/review/fsrs-state/{concept_id}` (æŸ¥è¯¢ FSRS çŠ¶æ€)
- **Then**:
  - `record` è¿”å› `algorithm: "ebbinghaus-fallback"` + åˆç†çš„ `interval_days` + future `next_review`
  - `schedule` è¿”å› Ebbinghaus å›ºå®šé—´éš”
  - `fsrs-state` è¿”å› `found: false, reason: "fsrs_not_initialized"`
  - æ‰€æœ‰ response çš„ HTTP status ä¸º 200ï¼ˆä¸æ˜¯ 500ï¼‰

### AC-32.11.2: Health endpoint FSRS é™çº§çŠ¶æ€

- **Given** åç«¯ FSRS æœªåˆå§‹åŒ–ï¼ˆ`FSRS_RUNTIME_OK=False`ï¼‰
- **When** å®¢æˆ·ç«¯å‘é€ `GET /api/v1/health`
- **Then** response åŒ…å« `components.fsrs: "degraded"`ï¼ˆä¸æ˜¯ "ok"ï¼‰

### AC-32.11.3: å¹¶å‘ card state å†™å…¥å®‰å…¨

- **Given** ReviewService å®ä¾‹å·²åˆå§‹åŒ–
- **When** 10 ä¸ª `asyncio.create_task` åŒæ—¶è°ƒç”¨ `record_review_result()` å¯¹åŒä¸€ä¸ª concept
- **Then**:
  - æ‰€æœ‰ 10 ä¸ªè°ƒç”¨å‡è¿”å›æˆåŠŸï¼ˆæ— å¼‚å¸¸ï¼‰
  - card states JSON æ–‡ä»¶ä¸æŸåï¼ˆå¯æ­£å¸¸ `json.loads`ï¼‰
  - æœ€ç»ˆ card state åæ˜ æœ€åä¸€æ¬¡å†™å…¥çš„å€¼ï¼ˆæœ€ç»ˆä¸€è‡´æ€§ï¼‰

### AC-32.11.4: Ebbinghaus fallback next_review æ—¶é—´æ­£ç¡®æ€§

- **Given** `USE_FSRS=False` ä¸” score=50ï¼ˆåº”æ˜ å°„ä¸º interval=3 å¤©ï¼‰
- **When** è°ƒç”¨ `record_review_result(score=50)`
- **Then** `next_review` æ—¶é—´ä¸º `now + 3 days`ï¼ˆUTCï¼Œè¯¯å·® < 5 ç§’ï¼‰

### AC-32.11.5: è¦†ç›–ç‡é—¨æ§æå‡

- **Given** æ‰€æœ‰æ–°æµ‹è¯•å·²æ·»åŠ 
- **When** è¿è¡Œ EPIC-32 å…¨éƒ¨æµ‹è¯•
- **Then** P1 è¦†ç›–ç‡ä» 89% æå‡åˆ° â‰¥ 100% (9/9 criteria)

---

## Tasks / Subtasks

### Task 1: E2E é™çº§æµ‹è¯• (AC-32.11.1, AC-32.11.2, AC-32.11.4)
- [x] T1.1: åˆ›å»º `tests/e2e/test_review_fsrs_degradation.py`
- [x] T1.2: å®ç° `test_record_review_ebbinghaus_fallback_e2e` â€” PUT /record with USE_FSRS=False
- [x] T1.3: å®ç° `test_schedule_review_ebbinghaus_fallback_e2e` â€” GET /schedule with USE_FSRS=False
- [x] T1.4: å®ç° `test_fsrs_state_not_initialized_e2e` â€” GET /fsrs-state returns reason code
- [x] T1.5: å®ç° `test_health_fsrs_degraded_e2e` â€” GET /health shows degraded
- [x] T1.6: å®ç° `test_ebbinghaus_next_review_timing` â€” scoreâ†’intervalâ†’next_review æ—¶é—´å‡†ç¡®

### Task 2: å¹¶å‘å†™å…¥å®‰å…¨æµ‹è¯• (AC-32.11.3)
- [x] T2.1: åˆ›å»º `tests/unit/test_card_state_concurrent_write.py`
- [x] T2.2: å®ç° `test_concurrent_record_review_no_exception` â€” 10 å¹¶å‘è°ƒç”¨æ— å¼‚å¸¸
- [x] T2.3: å®ç° `test_concurrent_write_json_integrity` â€” å¹¶å‘å†™å…¥å JSON å¯è§£æ
- [x] T2.4: å®ç° `test_concurrent_write_eventual_consistency` â€” æœ€ç»ˆçŠ¶æ€åæ˜ æœ€åå†™å…¥

### Task 3: å›å½’ + è¦†ç›–ç‡éªŒè¯ (AC-32.11.5)
- [x] T3.1: è¿è¡Œå…¨éƒ¨ EPIC-32 æµ‹è¯•ç¡®è®¤ 0 regression (84 passed, 0 failed)
- [x] T3.2: æ›´æ–° traceability-matrix-epic32.md P1 è¦†ç›–ç‡
- [x] T3.3: ç¡®è®¤ P1 â‰¥ 100%

---

## Technical Design

### E2E é™çº§æµ‹è¯•æ¶æ„

```python
# tests/e2e/test_review_fsrs_degradation.py

import pytest
from unittest.mock import patch
from fastapi.testclient import TestClient
from app.main import app
from app.config import get_settings, Settings


def _degraded_settings() -> Settings:
    return Settings(
        PROJECT_NAME="Canvas Test",
        VERSION="1.0.0-test",
        USE_FSRS=False,  # Force Ebbinghaus fallback
        CANVAS_BASE_PATH="./test_canvas",
    )


@pytest.fixture(autouse=True)
def override_to_degraded():
    app.dependency_overrides[get_settings] = _degraded_settings
    try:
        yield
    finally:
        app.dependency_overrides.pop(get_settings, None)


@pytest.fixture
def client():
    with TestClient(app) as c:
        yield c


class TestEbbinghausFallbackE2E:
    """E2E: Full HTTP request â†’ Ebbinghaus fallback response."""

    def test_record_review_uses_ebbinghaus(self, client):
        resp = client.put("/api/v1/review/record", json={
            "canvas_name": "test",
            "concept_id": "e2e-concept",
            "score": 50,
        })
        assert resp.status_code == 200
        data = resp.json()
        assert data["algorithm"] == "ebbinghaus-fallback"
        assert data["interval_days"] == 3

    def test_fsrs_state_returns_not_initialized(self, client):
        resp = client.get("/api/v1/review/fsrs-state/e2e-concept")
        assert resp.status_code == 200
        data = resp.json()
        assert data["found"] is False
        assert data["reason"] == "fsrs_not_initialized"
```

### å¹¶å‘å†™å…¥å®‰å…¨æµ‹è¯•æ¶æ„

```python
# tests/unit/test_card_state_concurrent_write.py

import asyncio
import pytest


@pytest.mark.asyncio
async def test_concurrent_record_review_no_exception(review_service):
    """10 concurrent record_review_result calls should all succeed."""
    tasks = [
        review_service.record_review_result(
            canvas_name="test",
            concept_id="concurrent-concept",
            rating=3,
        )
        for _ in range(10)
    ]
    results = await asyncio.gather(*tasks, return_exceptions=True)
    exceptions = [r for r in results if isinstance(r, Exception)]
    assert len(exceptions) == 0, f"Concurrent writes raised: {exceptions}"


@pytest.mark.asyncio
async def test_concurrent_write_json_integrity(review_service):
    """After concurrent writes, card states JSON should be parseable."""
    tasks = [
        review_service.record_review_result(
            canvas_name="test",
            concept_id=f"concept-{i}",
            rating=(i % 4) + 1,
        )
        for i in range(10)
    ]
    await asyncio.gather(*tasks)
    # Verify JSON integrity
    states = review_service._card_states
    assert isinstance(states, dict)
```

---

## Code Reality Check

| å£°ç§°çš„åŠŸèƒ½ | ä»£ç ä½ç½® | çŠ¶æ€ |
|-----------|---------|------|
| _save_card_states() async lock | `review_service.py:1622-1691` | âœ… å­˜åœ¨ â€” asyncio.Lock + atomic write |
| USE_FSRS é…ç½®å¼€å…³ | `config.py:452` | âœ… å­˜åœ¨ â€” Story 32.8 å·²æ·»åŠ  |
| Ebbinghaus fallback interval æ˜ å°„ | `review_service.py:745-762` | âœ… å­˜åœ¨ â€” scoreâ†’interval å›ºå®šæ˜ å°„ |
| fsrs-state endpoint | `review.py:1318-1391` | âœ… å­˜åœ¨ |
| health endpoint FSRS çŠ¶æ€ | `health.py` + `review_service.FSRS_RUNTIME_OK` | âœ… å­˜åœ¨ |
| record_review_result æ¥å£ | `review_service.py:805-933` | âœ… å­˜åœ¨ â€” æ¥å— score æˆ– rating |

---

## Estimated Effort

3-4 å°æ—¶

---

## Dependencies

- Story 32.10 (æµ‹è¯•å¯é æ€§ä¿®å¤) â€” å»ºè®®å…ˆå®Œæˆï¼Œç¡®ä¿æµ‹è¯•åŸºç¡€è®¾æ–½å¯é 
- Story 32.8 (USE_FSRS å¼€å…³) â€” å·²å®Œæˆ âœ…
- ä¸ä¿®æ”¹äº§å“ä»£ç ï¼Œä»…æ–°å¢æµ‹è¯•æ–‡ä»¶

---

## Infrastructure AC Checklist (D6: é›†æˆ)

- [x] D6.1: E2E æµ‹è¯•è¦†ç›–å®Œæ•´ HTTP è¯·æ±‚â†’å“åº”è·¯å¾„
- [x] D6.2: é™çº§åœºæ™¯é€šè¿‡ USE_FSRS=False é…ç½®è§¦å‘ï¼ˆé mock å†…éƒ¨æ–¹æ³•ï¼‰
- [x] D6.3: å¹¶å‘æµ‹è¯•éªŒè¯ asyncio.Lock åœ¨çœŸå®å¼‚æ­¥ç¯å¢ƒä¸‹çš„è¡Œä¸º
- [x] D6.4: æµ‹è¯•è¿è¡Œåæ— æ®‹ç•™æ–‡ä»¶ï¼ˆcard_states.json æ¸…ç† â€” tmp_path fixture è‡ªåŠ¨æ¸…ç†ï¼‰

---

## Dev Agent Record

### File List

| æ–‡ä»¶ | æ“ä½œ | è¯´æ˜ |
|------|------|------|
| `backend/tests/e2e/test_review_fsrs_degradation.py` | æ–°å¢ | E2E é™çº§æµ‹è¯• (AC-32.11.1, AC-32.11.2, AC-32.11.4) |
| `backend/tests/unit/test_card_state_concurrent_write.py` | æ–°å¢ | å¹¶å‘å†™å…¥å®‰å…¨æµ‹è¯• (AC-32.11.3) |
| `backend/app/api/v1/endpoints/review.py` | ä¿®æ”¹ | Code Review Fix: ä¿®å¤ record endpoint key mapping bug (next_reviewâ†’next_review_date, interval_daysâ†’new_interval) |

### Change Log

| æ—¥æœŸ | å˜æ›´ |
|------|------|
| 2026-02-10 | åˆå§‹å®ç°: E2E é™çº§æµ‹è¯• + å¹¶å‘å®‰å…¨æµ‹è¯• |
| 2026-02-10 | Code Review: å‘ç°å¹¶ä¿®å¤ record endpoint key mapping bug â€” service è¿”å› "next_review"/"interval_days" ä½† endpoint ç”¨ "next_review_date"/"new_interval" æ˜ å°„ï¼Œå¯¼è‡´å“åº”æ°¸è¿œè¿”å›é»˜è®¤å€¼ |
| 2026-02-10 | Code Review: å¼ºåŒ– E2E æµ‹è¯•æ–­è¨€ (new_interval, next_review_date), æ¸…ç†æœªä½¿ç”¨ import, å¼ºåŒ–å¹¶å‘ä¸€è‡´æ€§æµ‹è¯• (json.loads éªŒè¯) |

### Senior Developer Review (AI)

**æ—¥æœŸ:** 2026-02-10
**ç»“æœ:** æœ‰æ¡ä»¶é€šè¿‡ (Changes Applied)

**å‘ç° (ä¿®å¤å‰):**
- ğŸ”´ H1: E2E record æµ‹è¯•ç¼ºå°‘ interval/next_review æ–­è¨€ï¼Œéšè— endpoint key mapping bug
- ğŸ”´ H2: timing æµ‹è¯•æœ‰æ„ç»•å¼€å·²çŸ¥ endpoint bugï¼Œé™çº§ä¸º service-level
- ğŸ”´ H3: Story æ ‡è®° Done ä½†æ—  Dev Agent Record
- ğŸŸ¡ M1: TTL cache æµ‹è¯•åœ¨ Background ä¸­æåˆ°ä½†åœ¨ AC ä¸­æ¶ˆå¤±ï¼Œæ— è§£é‡Š
- ğŸŸ¡ M2: schedule æµ‹è¯•æ–­è¨€å¤ªå¼±
- ğŸŸ¡ M3: å¹¶å‘ä¸€è‡´æ€§æµ‹è¯•æœªéªŒè¯ JSON å®Œæ•´æ€§
- ğŸŸ¡ M4: service-level æµ‹è¯•æ··å…¥ E2E ç›®å½•

**ä¿®å¤:**
- review.py: ä¿®å¤ key mapping (next_reviewâ†’next_review_date, interval_daysâ†’new_interval)
- E2E æµ‹è¯•: æ·»åŠ  new_interval å’Œ next_review_date æ–­è¨€
- timing æµ‹è¯•: è½¬ä¸ºçœŸæ­£çš„ E2E æµ‹è¯• (é€šè¿‡ HTTP)
- å¹¶å‘æµ‹è¯•: æ·»åŠ  json.loads éªŒè¯, ç§»é™¤æœªä½¿ç”¨ import
- Story: æ·»åŠ  TTL cache å»¶è¿Ÿè¯´æ˜, Dev Agent Record
