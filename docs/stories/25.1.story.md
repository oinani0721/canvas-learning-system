# Story 25.1: Cross-Canvas UI Entry Points

**Epic**: Epic 25 - Cross-Canvas & Textbook Context Integration
**Status**: Draft
**Story Points**: 4
**Priority**: P0 (Critical)

---

## Story

**As a** Canvas Learning System user,
**I want** convenient UI entry points for cross-Canvas association features,
**so that** I can easily create, view, and navigate between associated Canvas files without leaving my current workflow.

---

## Acceptance Criteria

1. **AC1 - Right-click menu "Associate to Other Canvas"**
   - Given: User right-clicks on a Canvas node
   - When: Context menu appears
   - Then: "关联到其他Canvas" option is visible
   - And: Clicking it opens `CrossCanvasModal` for Canvas selection

2. **AC2 - Right-click menu "View Associated Canvas"**
   - Given: User right-clicks on a node with existing associations
   - When: Context menu appears
   - Then: "查看关联Canvas" option is visible
   - And: Shows list of associated Canvas files with click-to-jump

3. **AC3 - Command palette Cross-Canvas commands**
   - Given: User opens command palette (Ctrl+P)
   - When: User types "cross-canvas" or "关联"
   - Then: 4 commands are available:
     - "Canvas: 创建Canvas关联" (Create association)
     - "Canvas: 查看所有关联" (View all associations)
     - "Canvas: 跳转到关联Canvas" (Jump to associated Canvas)
     - "Canvas: 管理Canvas关联" (Manage associations)

4. **AC4 - Sidebar Canvas association list**
   - Given: User opens the Canvas Learning sidebar
   - When: A Canvas file is active
   - Then: "Canvas关联" section shows list of associated Canvas
   - And: Each item shows Canvas name and association type

5. **AC5 - Click-to-jump navigation**
   - Given: User sees an associated Canvas link (in sidebar or modal)
   - When: User clicks the link
   - Then: Obsidian opens the target Canvas file
   - And: Focus is on the linked node (if applicable)

---

## Tasks / Subtasks

- [ ] **Task 1: Extend ContextMenuManager** (AC: 1, 2)
  - [ ] 1.1 Add "关联到其他Canvas" menu item in `addNodeMenuItems()`
  - [ ] 1.2 Add "查看关联Canvas" menu item with association check
  - [ ] 1.3 Implement `hasAssociations(nodeId)` helper function
  - [ ] 1.4 Add icon assets for menu items (`link` and `external-link` icons)

- [ ] **Task 2: Create CrossCanvasModal** (AC: 1, 3)
  - [ ] 2.1 Create `src/modals/CrossCanvasModal.ts` file
  - [ ] 2.2 Implement Canvas file picker with fuzzy search
  - [ ] 2.3 Add association type dropdown (prerequisite, related, extends, references)
  - [ ] 2.4 Implement bidirectional association toggle
  - [ ] 2.5 Add "Create Association" button with API call

- [ ] **Task 3: Create CrossCanvasSidebar section** (AC: 4, 5)
  - [ ] 3.1 Create `src/views/CrossCanvasSidebar.ts` component
  - [ ] 3.2 Integrate into existing `ProgressTrackerView.ts` sidebar
  - [ ] 3.3 Display association list with icons for type
  - [ ] 3.4 Implement click-to-jump with `app.workspace.openLinkText()`

- [ ] **Task 4: Register Command Palette commands** (AC: 3)
  - [ ] 4.1 Add 4 commands in `main.ts` `onload()` method
  - [ ] 4.2 Implement `createCanvasAssociationCommand()` callback
  - [ ] 4.3 Implement `viewAllAssociationsCommand()` callback
  - [ ] 4.4 Implement `jumpToAssociatedCanvasCommand()` callback
  - [ ] 4.5 Implement `manageAssociationsCommand()` callback

- [ ] **Task 5: Connect to CrossCanvasService** (AC: 1-5)
  - [ ] 5.1 Use existing `CrossCanvasService.ts` for API calls
  - [ ] 5.2 Implement `getAssociationsForCanvas(canvasPath)` call
  - [ ] 5.3 Implement `createAssociation(sourceCanvas, targetCanvas, type)` call
  - [ ] 5.4 Add error handling with `ErrorNotifier`

- [ ] **Task 6: Testing** (AC: 1-5)
  - [ ] 6.1 Write unit tests for `CrossCanvasModal`
  - [ ] 6.2 Write unit tests for `CrossCanvasSidebar`
  - [ ] 6.3 Write integration tests for command palette commands
  - [ ] 6.4 Manual test all 5 acceptance criteria

---

## Dev Notes

### Relevant Source Tree

```
canvas-progress-tracker/obsidian-plugin/src/
├── main.ts                           # Plugin entry, add commands here
├── managers/
│   └── ContextMenuManager.ts         # MODIFY: Add cross-canvas menu items
├── modals/
│   ├── CanvasAssociationModal.ts     # EXISTS: Reference pattern
│   ├── AssociationFormModal.ts       # EXISTS: Reference pattern
│   └── CrossCanvasModal.ts           # CREATE: New modal for canvas selection
├── views/
│   ├── ProgressTrackerView.ts        # MODIFY: Add CrossCanvasSidebar section
│   └── CrossCanvasSidebar.ts         # CREATE: New sidebar component
├── services/
│   └── CrossCanvasService.ts         # USE: Existing API service
└── types/
    └── AssociationTypes.ts           # USE: Existing type definitions
```

### Implementation Patterns

**ContextMenuManager Pattern** (from existing code):
```typescript
// ✅ Verified from obsidian-plugin-architecture.md
menu.addItem((item) => {
    item.setTitle('关联到其他Canvas')
        .setIcon('link')
        .onClick(() => this.openCrossCanvasModal(node));
});
```

**Modal Pattern** (from existing CanvasAssociationModal):
```typescript
// ✅ Verified from Obsidian Canvas Skill
export class CrossCanvasModal extends Modal {
    constructor(app: App, private sourceCanvas: string) {
        super(app);
    }

    onOpen() {
        const { contentEl } = this;
        contentEl.createEl('h2', { text: '选择关联Canvas' });
        // Canvas file picker implementation
    }
}
```

**Sidebar View Pattern** (from existing ProgressTrackerView):
```typescript
// ✅ Verified from obsidian-plugin-architecture.md
const associationSection = container.createDiv('association-section');
associationSection.createEl('h4', { text: 'Canvas关联' });
// Render association list
```

### SDD规范参考 (必填)

**数据Schema** (Canvas Association):
- Schema来源: `[Source: specs/data/canvas-association.schema.json]`
- 必填字段:
  - `association_id`: string (uuid)
  - `source_canvas`: string (Canvas路径)
  - `target_canvas`: string (Canvas路径)
  - `association_type`: enum ["prerequisite", "related", "extends", "references"]
- 可选字段:
  - `description`: string
  - `shared_concepts`: string[]
  - `relevance_score`: number (0-1)
  - `bidirectional`: boolean (default: false)
  - `auto_generated`: boolean (default: false)

**API端点** (Cross-Canvas):
- 规范来源: `[Source: specs/api/canvas-api.openapi.yml - Cross-Canvas endpoints]`
- 端点:
  - `GET /api/associations/{canvas_path}` - 获取Canvas关联
  - `POST /api/associations` - 创建关联
  - `DELETE /api/associations/{association_id}` - 删除关联

### ADR决策关联 (必填)

| ADR编号 | 决策标题 | 对Story的影响 |
|---------|----------|---------------|
| ADR-001 | 使用Obsidian Canvas | Canvas操作必须使用JSON格式，通过`app.vault`读写 |

**关键约束** (从ADR-001 Consequences提取):
- 约束1: Canvas文件是纯JSON格式(`.canvas`扩展名)，必须使用`app.vault.read()`和`app.vault.modify()`
- 约束2: 颜色系统使用"1"-"6"预设代码
- 约束3: 用户界面必须遵循Obsidian Plugin API最佳实践

来源引用: `[Source: ADR-001-use-obsidian-canvas.md]`

### Testing

**测试文件位置**: `canvas-progress-tracker/obsidian-plugin/tests/`

**测试标准**:
- 使用Jest作为测试框架
- Mock Obsidian API (`jest.mock('obsidian')`)
- 单元测试覆盖率目标: >80%

**测试框架和模式**:
```typescript
// ✅ Verified from ADR-008
import { CrossCanvasModal } from '../src/modals/CrossCanvasModal';

describe('CrossCanvasModal', () => {
    it('should display canvas file picker', () => {
        // Test implementation
    });

    it('should call CrossCanvasService on submit', () => {
        // Test API call
    });
});
```

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-13 | 0.1 | Initial draft created | Bob (SM Agent) |

---

## Dev Agent Record

### Agent Model Used
Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References
- Fixed TypeScript compilation errors: snake_case → camelCase property names
- Fixed `createCrossCanvasModal` function signature (service-based, not URL-based)
- Added `CrossCanvasService` property to CanvasReviewPlugin class
- Pre-existing errors in MetricsModal.ts, RAGResultModal.ts, RollbackModal.ts, TextbookMountService.ts, ScoringResultPanel.ts are NOT Story 25.1 scope

### Completion Notes List
- ✅ AC1: Right-click menu "关联到其他Canvas" implemented via ContextMenuManager
- ✅ AC2: Right-click menu "查看关联Canvas" implemented via ContextMenuManager
- ✅ AC3: Command palette commands registered (4 commands)
- ✅ AC4: Sidebar view CrossCanvasSidebarView registered and functional
- ✅ AC5: Navigation via workspace.openLinkText() implemented

### File List
**Created:**
- `canvas-progress-tracker/obsidian-plugin/src/modals/CrossCanvasModal.ts` (~400 lines)
- `canvas-progress-tracker/obsidian-plugin/src/views/CrossCanvasSidebar.ts` (~600 lines)

**Modified:**
- `canvas-progress-tracker/obsidian-plugin/main.ts` (imports, property, commands, view registration)
- `canvas-progress-tracker/obsidian-plugin/src/managers/ContextMenuManager.ts` (menu items, action registry)
- `canvas-progress-tracker/obsidian-plugin/src/types/menu.ts` (MenuActionRegistry interface)

---

## QA Results
(To be filled by QA Agent)
