# Story 17.6: 监控系统文档和生产就绪

## Status
Completed (QA-PASS 2025-12-04, 8/8 docs)

## Story

**As a** Canvas Learning System运维工程师和开发团队,
**I want** 完整的监控系统操作文档、部署指南和生产就绪检查清单,
**so that** 我可以将监控系统安全部署到生产环境、进行日常运维操作、快速响应告警，确保系统长期稳定运行。

## Acceptance Criteria

1. 操作文档：创建完整的监控系统操作手册，包含日常运维流程和故障排查指南
2. 部署指南：创建生产环境部署文档，包含配置说明、依赖要求和部署步骤
3. 告警响应手册：创建告警响应Runbook，定义每种告警的处理流程和升级路径
4. Dashboard使用指南：创建Dashboard使用文档，说明各面板含义和解读方法
5. 生产就绪检查清单：创建pre-production checklist，确保上线前所有检查通过
6. API文档更新：更新OpenAPI规范文档，确保监控端点文档完整准确
7. 故障演练计划：创建故障演练文档，定义定期演练的场景和流程
8. 所有代码包含文档来源标注(Context7/Skill/ADR验证)

## Tasks / Subtasks

- [ ] Task 1: 监控系统操作手册 (AC: 1)
  - [ ] 创建 `docs/operations/monitoring-operations-guide.md`
  - [ ] 文档：系统架构概述（引用 performance-monitoring-architecture.md）
  - [ ] 文档：日常运维任务清单（指标检查、日志轮转、存储管理）
  - [ ] 文档：常见故障排查步骤（连接失败、指标丢失、告警误报）
  - [ ] 文档：维护窗口操作流程
  - [ ] 文档：监控系统升级流程

- [ ] Task 2: 生产环境部署指南 (AC: 2)
  - [ ] 创建 `docs/deployment/monitoring-deployment-guide.md`
  - [ ] 文档：系统要求（Python版本、依赖包版本、硬件需求）
  - [ ] 文档：环境变量配置清单
  - [ ] 文档：Prometheus配置示例
  - [ ] 文档：日志系统配置（引用 ADR-010 structlog）
  - [ ] 文档：健康检查端点验证步骤
  - [ ] 文档：回滚流程

- [ ] Task 3: 告警响应手册 (Runbook) (AC: 3)
  - [ ] 创建 `docs/operations/alert-runbook.md`
  - [ ] Runbook: HighAPILatency (P95延迟>1s)
    - 症状描述、可能原因、排查步骤、缓解措施、升级路径
  - [ ] Runbook: HighErrorRate (错误率>5%)
    - 症状描述、可能原因、排查步骤、缓解措施、升级路径
  - [ ] Runbook: AgentExecutionSlow (Agent P95执行>10s)
    - 症状描述、可能原因、排查步骤、缓解措施、升级路径
  - [ ] Runbook: MemorySystemDown (记忆系统连接失败)
    - 症状描述、可能原因、排查步骤、缓解措施、升级路径
  - [ ] Runbook: HighConcurrentTasks (并发任务>100)
    - 症状描述、可能原因、排查步骤、缓解措施、升级路径
  - [ ] 告警升级矩阵和On-Call流程

- [ ] Task 4: Dashboard使用指南 (AC: 4)
  - [ ] 创建 `docs/operations/dashboard-user-guide.md`
  - [ ] 指南：概览面板解读（请求量、延迟、错误率）
  - [ ] 指南：API性能面板解读（各端点响应时间分布）
  - [ ] 指南：Agent性能面板解读（各Agent执行时间对比）
  - [ ] 指南：记忆系统面板解读（各层查询延迟）
  - [ ] 指南：资源监控面板解读（CPU、内存、磁盘IO）
  - [ ] 指南：自定义查询示例（PromQL语法）

- [ ] Task 5: 生产就绪检查清单 (AC: 5)
  - [ ] 创建 `docs/deployment/production-readiness-checklist.md`
  - [ ] 检查清单：功能完整性验证（所有监控端点可访问）
  - [ ] 检查清单：性能达标验证（参考Story 17.5测试报告）
  - [ ] 检查清单：告警配置验证（所有告警规则已配置）
  - [ ] 检查清单：日志配置验证（日志轮转、存储配额）
  - [ ] 检查清单：安全配置验证（认证、授权、敏感数据脱敏）
  - [ ] 检查清单：备份恢复验证（配置备份、数据备份）
  - [ ] 检查清单：文档完整性验证（所有文档已更新）
  - [ ] 检查清单：团队准备度验证（培训完成、On-Call就绪）

- [ ] Task 6: API文档更新 (AC: 6)
  - [ ] 更新 `specs/api/canvas-api.openapi.yml` 监控端点描述
  - [ ] 添加详细的请求/响应示例
  - [ ] 添加错误码说明
  - [ ] 验证Swagger UI展示正确
  - [ ] 生成静态API文档（如有需要）

- [ ] Task 7: 故障演练计划 (AC: 7)
  - [ ] 创建 `docs/operations/chaos-engineering-plan.md`
  - [ ] 演练场景：API高延迟模拟
  - [ ] 演练场景：高错误率模拟
  - [ ] 演练场景：Agent执行超时模拟
  - [ ] 演练场景：记忆系统断连模拟
  - [ ] 演练场景：高并发压力模拟
  - [ ] 演练计划：季度演练日程
  - [ ] 演练记录：模板和复盘流程

- [ ] Task 8: 文档完整性验证 (AC: 8)
  - [ ] 验证所有代码示例可运行
  - [ ] 验证所有配置示例正确
  - [ ] 验证所有文档链接有效
  - [ ] 确认所有API调用有文档来源标注
  - [ ] 创建文档变更日志 `docs/CHANGELOG-MONITORING.md`

## Dev Notes

### 技术验证报告 (Step 3.6)

**验证完成时间**: 2025-12-03
**验证执行人**: SM Agent (Bob)
**Quality Gate状态**: Pending

#### 技术栈清单

| 技术栈 | 查询方式 | 验证状态 | 文档位置 |
|--------|---------|---------|----------|
| structlog | Local ADR | 已验证 | ADR-010-LOGGING-AGGREGATION-STRUCTLOG.md |
| prometheus_client | Context7 | 已验证 | /prometheus/client_python |
| pytest | Local ADR | 已验证 | ADR-008-TESTING-FRAMEWORK-PYTEST-ECOSYSTEM.md |
| FastAPI | Context7 | 已验证 | /websites/fastapi_tiangolo |
| OpenAPI 3.0 | SDD Spec | 已验证 | specs/api/canvas-api.openapi.yml |

#### 核心文档验证待办

**开发前必须验证**:
- [ ] structlog配置和使用模式 → ADR-010:75-187
- [ ] PerformanceTracker实现 → ADR-010:228-299
- [ ] 请求上下文管理 → ADR-010:301-342
- [ ] 告警规则配置格式 → Architecture Doc:281-323
- [ ] MetricsSummary Schema结构 → OpenAPI:987-1059

### SDD规范参考 (必填)

**API端点规范** (Epic 17 Monitoring):
- `GET /metrics` - 获取Prometheus格式指标
  - [Source: specs/api/canvas-api.openapi.yml:605-628]
  - 响应格式: `text/plain` (Prometheus格式)
  - 包含指标: `canvas_api_requests_total`, `canvas_api_request_latency_seconds`, `canvas_agent_execution_seconds`, `canvas_memory_query_seconds`
- `GET /metrics/summary` - 获取JSON格式指标摘要
  - [Source: specs/api/canvas-api.openapi.yml:630-642]
  - 响应Schema: `MetricsSummary`
- `GET /metrics/alerts` - 获取当前活跃告警
  - [Source: specs/api/canvas-api.openapi.yml:644-662]
  - 响应Schema: `{ alerts: Alert[], total: integer }`
- `GET /health` - 健康检查端点
  - [Source: specs/api/canvas-api.openapi.yml:665-691]
  - 响应Schema: `HealthCheckResponse`

**MetricsSummary Schema** (文档参考):
- [Source: specs/api/canvas-api.openapi.yml:987-1059]
- 字段:
  - `timestamp`: ISO 8601格式时间戳
  - `api.requests_total`: 总请求数 (integer)
  - `api.requests_per_second`: 每秒请求数 (number)
  - `api.avg_latency_ms`: 平均延迟毫秒 (number)
  - `api.p95_latency_ms`: 95分位延迟毫秒 (number)
  - `api.error_rate`: 错误率 (number)
  - `agents.invocations_total`: Agent调用总数 (integer)
  - `agents.avg_execution_time_s`: Agent平均执行时间秒 (number)
  - `agents.by_type`: 按Agent类型统计 (object)
  - `memory_system.graphiti`: Graphiti查询统计 (object)
  - `memory_system.temporal`: Temporal记忆统计 (object)
  - `memory_system.semantic`: Semantic搜索统计 (object)
  - `resources.cpu_usage_percent`: CPU使用率 (number)
  - `resources.memory_usage_percent`: 内存使用率 (number)

**Alert Schema** (告警手册参考):
- [Source: specs/api/canvas-api.openapi.yml - 待确认具体行号]
- 字段:
  - `name`: 告警名称 (string)
  - `severity`: 严重级别 (enum: critical, warning, info)
  - `message`: 告警消息 (string)
  - `timestamp`: 触发时间 (datetime)
  - `labels`: 标签键值对 (object)

### ADR决策关联 (必填)

| ADR编号 | 决策标题 | 对Story的影响 |
|---------|----------|---------------|
| ADR-0008 | Testing Framework (pytest) | 文档需说明如何运行监控相关测试，引用pytest配置 |
| ADR-0009 | Error Handling & Retry | Runbook需覆盖错误处理机制和重试策略 |
| ADR-0010 | Logging Aggregation (structlog) | 部署指南需包含日志系统配置，操作手册需说明日志查询方法 |
| ADR-0007 | Caching Strategy (Tiered) | 操作手册需说明缓存监控和清理流程 |
| ADR-0004 | Async Execution Engine | Runbook需覆盖并发任务监控和调优 |

**关键约束**:
- 日志配置必须遵循ADR-010定义的structlog配置模式，见 `ADR-010:75-187`
- 日志目录结构: `.canvas-learning/logs/` 包含4个日志文件，见 `ADR-010:64-73`
- 性能日志追踪器使用示例见 `ADR-010:228-299`
- 请求上下文绑定模式见 `ADR-010:301-342`

### 架构设计参考

**架构文档引用**:
- 监控架构总览: [Source: docs/architecture/performance-monitoring-architecture.md:87-124]
- 技术选型: [Source: docs/architecture/performance-monitoring-architecture.md:126-135]
- 指标采集实现: [Source: docs/architecture/performance-monitoring-architecture.md:138-265]
- 告警策略和规则: [Source: docs/architecture/performance-monitoring-architecture.md:269-333]
- 性能优化策略: [Source: docs/architecture/performance-monitoring-architecture.md:336-398]
- Dashboard布局: [Source: docs/architecture/performance-monitoring-architecture.md:401-440]
- 成功标准: [Source: docs/architecture/performance-monitoring-architecture.md:516-524]

**告警规则配置** (Runbook核心参考):
- [Source: docs/architecture/performance-monitoring-architecture.md:281-323]

| 告警名称 | 触发条件 | 持续时间 | 严重级别 |
|----------|---------|---------|---------|
| HighAPILatency | P95延迟>1s | 5分钟 | Warning |
| HighErrorRate | 5分钟错误率>5% | 2分钟 | Critical |
| AgentExecutionSlow | Agent P95执行>10s | 5分钟 | Warning |
| MemorySystemDown | 记忆系统连接失败 | 1分钟 | Critical |
| HighConcurrentTasks | 并发任务>100 | 2分钟 | Warning |

**性能目标** (生产就绪检查参考):
- [Source: docs/architecture/performance-monitoring-architecture.md:516-524]

| 指标 | 目标 | 验收条件 |
|------|------|---------|
| API响应时间 | P95 <500ms | 95%请求在500ms内完成 |
| 错误率 | <1% | 每日错误率低于1% |
| Agent执行 | P95 <5s | 95%Agent调用在5秒内完成 |
| 告警准确率 | >95% | 误报率低于5% |
| Dashboard可用性 | 99.9% | 监控系统稳定运行 |

### 代码示例库

**日志系统配置参考** (部署指南使用):
```python
# 基于ADR-010 structlog配置
# ✅ Verified from ADR-010:75-114
import structlog
from logging.handlers import RotatingFileHandler

def setup_logging(vault_path: str, debug: bool = False):
    """配置structlog日志系统"""
    log_dir = Path(vault_path) / ".canvas-learning" / "logs"
    log_dir.mkdir(parents=True, exist_ok=True)

    timestamper = structlog.processors.TimeStamper(fmt="iso")
    shared_processors = [
        structlog.contextvars.merge_contextvars,
        structlog.stdlib.add_log_level,
        structlog.stdlib.add_logger_name,
        timestamper,
        structlog.processors.StackInfoRenderer(),
        structlog.processors.format_exc_info,
    ]
    # ... 完整配置见ADR-010
```

**健康检查端点验证** (部署指南使用):
```python
# ✅ Verified from OpenAPI Spec (canvas-api.openapi.yml:665-691)
import httpx

async def verify_health_endpoint(base_url: str) -> bool:
    """验证健康检查端点"""
    async with httpx.AsyncClient() as client:
        response = await client.get(f"{base_url}/health")

        if response.status_code == 200:
            data = response.json()
            # 验证响应结构
            assert "status" in data
            assert "components" in data
            return data["status"] == "healthy"
        return False
```

**告警查询示例** (Runbook使用):
```python
# ✅ Verified from OpenAPI Spec (canvas-api.openapi.yml:644-662)
import httpx

async def get_active_alerts(base_url: str) -> list[dict]:
    """获取活跃告警"""
    async with httpx.AsyncClient() as client:
        response = await client.get(f"{base_url}/metrics/alerts")
        data = response.json()
        return data.get("alerts", [])

async def filter_alerts_by_severity(alerts: list, severity: str) -> list:
    """按严重级别过滤告警"""
    return [a for a in alerts if a.get("severity") == severity]
```

**指标摘要获取** (Dashboard指南使用):
```python
# ✅ Verified from OpenAPI Spec (canvas-api.openapi.yml:630-642)
import httpx

async def get_metrics_summary(base_url: str) -> dict:
    """获取指标摘要"""
    async with httpx.AsyncClient() as client:
        response = await client.get(f"{base_url}/metrics/summary")
        return response.json()

# 解析示例
def parse_api_metrics(summary: dict) -> dict:
    """解析API性能指标"""
    api = summary.get("api", {})
    return {
        "total_requests": api.get("requests_total", 0),
        "rps": api.get("requests_per_second", 0),
        "avg_latency_ms": api.get("avg_latency_ms", 0),
        "p95_latency_ms": api.get("p95_latency_ms", 0),
        "error_rate": api.get("error_rate", 0),
    }
```

### 文件路径参考

**现有文档**:
- 监控架构文档: `docs/architecture/performance-monitoring-architecture.md`
- 日志系统ADR: `docs/architecture/decisions/ADR-010-LOGGING-AGGREGATION-STRUCTLOG.md`
- 测试框架ADR: `docs/architecture/decisions/ADR-008-TESTING-FRAMEWORK-PYTEST-ECOSYSTEM.md`
- OpenAPI规范: `specs/api/canvas-api.openapi.yml`
- Story 17.5测试报告: `docs/reports/story-17.5-test-report.md` (待生成)

**需要新增的文件**:
- 新增: `docs/operations/monitoring-operations-guide.md`
- 新增: `docs/deployment/monitoring-deployment-guide.md`
- 新增: `docs/operations/alert-runbook.md`
- 新增: `docs/operations/dashboard-user-guide.md`
- 新增: `docs/deployment/production-readiness-checklist.md`
- 新增: `docs/operations/chaos-engineering-plan.md`
- 新增: `docs/CHANGELOG-MONITORING.md`

**目录结构** (需创建):
```
docs/
├── operations/           # 运维文档目录 (新建)
│   ├── monitoring-operations-guide.md
│   ├── alert-runbook.md
│   ├── dashboard-user-guide.md
│   └── chaos-engineering-plan.md
├── deployment/           # 部署文档目录 (新建)
│   ├── monitoring-deployment-guide.md
│   └── production-readiness-checklist.md
└── CHANGELOG-MONITORING.md
```

### 依赖关系

**前置Story**:
- Story 17.1: 基础监控 (提供metrics_middleware)
- Story 17.2: 深度监控 (提供Agent/Memory监控)
- Story 17.3: 告警和Dashboard (提供告警规则和Dashboard)
- Story 17.4: 性能优化策略实施 (提供优化后的代码)
- Story 17.5: 端到端集成测试 (提供测试报告作为验证依据)

**后续影响**:
- Epic 17完成，监控系统可正式上线
- 为后续Epic提供监控基础设施
- 运维团队可依据文档进行日常运维

### 文档模板参考

**Runbook模板结构**:
```markdown
## [告警名称]

### 告警信息
- **名称**: [AlertName]
- **严重级别**: [Critical/Warning/Info]
- **触发条件**: [expr]
- **持续时间**: [for]

### 症状描述
[描述用户可观察到的症状]

### 可能原因
1. [原因1]
2. [原因2]
3. [原因3]

### 排查步骤
1. [步骤1 - 检查什么]
2. [步骤2 - 检查什么]
3. [步骤3 - 检查什么]

### 缓解措施
- **临时措施**: [快速恢复服务]
- **永久措施**: [根本解决问题]

### 升级路径
- **15分钟未解决**: 通知 [角色]
- **30分钟未解决**: 升级至 [角色]
- **1小时未解决**: 启动 [流程]

### 相关资源
- Dashboard: [链接]
- 日志查询: [查询语句]
- 相关文档: [链接]
```

**生产就绪检查清单模板**:
```markdown
## 生产就绪检查清单

### 1. 功能完整性 ☐
- [ ] /metrics 端点返回Prometheus格式指标
- [ ] /metrics/summary 端点返回JSON摘要
- [ ] /metrics/alerts 端点返回告警列表
- [ ] /health 端点返回健康状态

### 2. 性能达标 ☐
- [ ] API P95延迟 < 500ms (参考Story 17.5报告)
- [ ] 错误率 < 1%
- [ ] Agent P95执行 < 5s
- [ ] 监控开销 < 5%

### 3. 告警配置 ☐
- [ ] HighAPILatency 告警已配置并测试
- [ ] HighErrorRate 告警已配置并测试
- [ ] AgentExecutionSlow 告警已配置并测试
- [ ] MemorySystemDown 告警已配置并测试
- [ ] HighConcurrentTasks 告警已配置并测试

### 4. 日志系统 ☐
- [ ] structlog配置正确
- [ ] 日志轮转已配置 (10MB/5份)
- [ ] 性能日志独立记录
- [ ] 错误日志独立记录

### 5. 安全配置 ☐
- [ ] /metrics 端点已配置访问控制 (如需要)
- [ ] 敏感信息已从日志中脱敏
- [ ] API认证机制已启用

### 6. 备份恢复 ☐
- [ ] 监控配置已备份
- [ ] 告警规则已版本控制
- [ ] 恢复流程已文档化并测试

### 7. 文档完整性 ☐
- [ ] 操作手册已完成
- [ ] 部署指南已完成
- [ ] 告警Runbook已完成
- [ ] Dashboard指南已完成

### 8. 团队准备度 ☐
- [ ] 运维培训已完成
- [ ] On-Call排班已确定
- [ ] 升级流程已明确
```

### Definition of Done

- [ ] 所有AC通过验收测试
- [ ] `docs/operations/monitoring-operations-guide.md` 已创建且内容完整
- [ ] `docs/deployment/monitoring-deployment-guide.md` 已创建且内容完整
- [ ] `docs/operations/alert-runbook.md` 已创建，覆盖所有5种告警
- [ ] `docs/operations/dashboard-user-guide.md` 已创建且内容完整
- [ ] `docs/deployment/production-readiness-checklist.md` 已创建且所有检查项清晰
- [ ] `docs/operations/chaos-engineering-plan.md` 已创建，包含5种演练场景
- [ ] OpenAPI规范监控端点描述已更新
- [ ] 所有文档代码示例可运行
- [ ] 所有文档有文档来源标注 (ADR/OpenAPI/Architecture引用)
- [ ] 文档Review通过
- [ ] Epic 17所有Story均已完成

### 风险和缓解

| 风险 | 概率 | 影响 | 缓解措施 |
|------|------|------|---------|
| 文档与实现不一致 | 中 | 高 | 基于Story 17.1-17.5实际代码编写文档 |
| Runbook流程未验证 | 中 | 中 | 结合故障演练验证Runbook有效性 |
| 文档维护滞后 | 高 | 中 | 建立文档变更与代码变更同步机制 |
| 团队培训不足 | 中 | 中 | 安排专门培训会议，提供实操演练 |

### 估算

- **Story Points**: 3
- **预估工时**: 1-2天
- **复杂度**: 低-中 (主要是文档编写，无代码开发)

---

**文档版本**: v1.0.0
**创建时间**: 2025-12-03
**创建者**: SM Agent (Bob)
**Epic**: Epic 17 - 性能优化和监控
