# Story 10.11 ä¿®æ­£åçš„ç« èŠ‚å†…å®¹

**ä¿®æ­£æ—¥æœŸ**: 2025-10-30
**ä¿®æ­£ä¾æ®**: `docs/stories/10.10-10.12-technical-supplement.md`
**ä¿®æ­£èŒƒå›´**: Dev Notes -> Technical Context -> ç³»ç»Ÿå¯ç”¨æ€§æ£€æµ‹å®ç°

---

## ğŸ“ ä½¿ç”¨è¯´æ˜

è¯·å°†ä»¥ä¸‹å†…å®¹æ›¿æ¢åˆ° `docs/stories/10.11.story.md` ä¸­å¯¹åº”çš„ç« èŠ‚ã€‚

**æ›¿æ¢ä½ç½®**:
1. æ‰¾åˆ° `#### ç³»ç»Ÿå¯ç”¨æ€§æ£€æµ‹å®ç°` - æ›¿æ¢æ•´ä¸ªå°èŠ‚
2. æ‰¾åˆ° `**MCPæœåŠ¡å™¨å¥åº·æ£€æŸ¥**:` - æ›¿æ¢æ­¤ä»£ç å—

---

## âœ… ä¿®æ­£åçš„å†…å®¹

### æ›¿æ¢1: Neo4jè¿æ¥æ£€æµ‹ï¼ˆWindowså…¼å®¹ç‰ˆï¼‰

```markdown
#### ç³»ç»Ÿå¯ç”¨æ€§æ£€æµ‹å®ç°

**Neo4jè¿æ¥æ£€æµ‹** (è·¨å¹³å°å…¼å®¹):
```python
import socket
import platform
from typing import Dict, Any

def check_neo4j_connection(
    uri: str = "bolt://localhost:7687",
    username: str = "neo4j",
    password: str = "password",
    timeout: int = 2
) -> Dict[str, Any]:
    """
    æ£€æµ‹Neo4jæ•°æ®åº“è¿æ¥çŠ¶æ€ï¼ˆWindowså…¼å®¹ï¼‰

    Args:
        uri: Neo4jè¿æ¥URI
        username: ç”¨æˆ·å
        password: å¯†ç 
        timeout: è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰

    Returns:
        Dict: {'available': bool, 'error': str|None, 'version': str|None}
    """
    try:
        # 1. è§£æURI
        if "://" in uri:
            host_port = uri.split("//")[1]
            host = host_port.split(":")[0]
            port_str = host_port.split(":")[1].split("/")[0] if ":" in host_port else "7687"
            port = int(port_str)
        else:
            host = "localhost"
            port = 7687

        # 2. å¿«é€Ÿæ£€æŸ¥ç«¯å£æ˜¯å¦å¯è¾¾ï¼ˆWindowså…¼å®¹ï¼‰
        sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        sock.settimeout(timeout)

        try:
            result = sock.connect_ex((host, port))
            sock.close()

            if result != 0:
                # æ ¹æ®æ“ä½œç³»ç»Ÿæä¾›ä¸åŒçš„å»ºè®®
                suggestion = (
                    'Windows: è¿è¡Œ "neo4j.bat console" æˆ– "neo4j.bat start" å¯åŠ¨æ•°æ®åº“\n'
                    if platform.system() == 'Windows' else
                    'Unix/Linux: è¿è¡Œ "neo4j start" å¯åŠ¨æ•°æ®åº“'
                )
                return {
                    'available': False,
                    'error': f'Neo4jç«¯å£{port}ä¸å¯è¾¾ï¼ˆConnection refusedï¼‰',
                    'suggestion': suggestion
                }
        except socket.error as e:
            sock.close()
            return {
                'available': False,
                'error': f'Socketé”™è¯¯: {str(e)}',
                'suggestion': 'æ£€æŸ¥é˜²ç«å¢™è®¾ç½®æˆ–Neo4jé…ç½®æ–‡ä»¶'
            }

        # 3. å°è¯•å»ºç«‹çœŸå®è¿æ¥ï¼ˆéªŒè¯è®¤è¯ï¼‰
        try:
            from neo4j import GraphDatabase
        except ImportError:
            return {
                'available': False,
                'error': 'neo4j Pythonåº“æœªå®‰è£…',
                'suggestion': 'è¿è¡Œ "pip install neo4j" å®‰è£…ä¾èµ–'
            }

        driver = GraphDatabase.driver(uri, auth=(username, password))

        try:
            with driver.session() as session:
                result = session.run("RETURN 1 AS num")
                _ = result.single()

            driver.close()

            return {
                'available': True,
                'error': None,
                'version': 'Neo4j 5.x'  # å¯ä»¥é€šè¿‡ CALL dbms.components() è·å–ç²¾ç¡®ç‰ˆæœ¬
            }
        except Exception as e:
            driver.close()
            return {
                'available': False,
                'error': f'Neo4jè®¤è¯æˆ–æŸ¥è¯¢å¤±è´¥: {str(e)}',
                'suggestion': 'æ£€æŸ¥ç”¨æˆ·åã€å¯†ç æ˜¯å¦æ­£ç¡®ï¼Œæˆ–Neo4jæ•°æ®åº“æ˜¯å¦æ­£å¸¸è¿è¡Œ'
            }

    except Exception as e:
        return {
            'available': False,
            'error': f'è¿æ¥æ£€æµ‹å¤±è´¥: {str(e)}',
            'suggestion': 'æ£€æŸ¥Neo4jæœåŠ¡çŠ¶æ€å’Œç½‘ç»œè¿æ¥'
        }
```
```

---

### æ›¿æ¢2: MCPæœåŠ¡å™¨å¥åº·æ£€æŸ¥ï¼ˆä¿®æ­£ç‰ˆï¼‰

```markdown
**MCPæœåŠ¡å™¨å¥åº·æ£€æŸ¥** [Source: canvas_utils/session_monitor.py:816-831]:
```python
import asyncio
from typing import Dict, Any

def check_mcp_server_health(timeout: int = 2) -> Dict[str, Any]:
    """
    æ£€æµ‹MCPæœåŠ¡å™¨å¥åº·çŠ¶æ€

    âš ï¸ æ³¨æ„ï¼šæ­¤æ£€æµ‹åœ¨åŒæ­¥ä¸Šä¸‹æ–‡ä¸­è¿è¡Œå¼‚æ­¥MCPå·¥å…·è°ƒç”¨

    Args:
        timeout: è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰

    Returns:
        Dict: {'available': bool, 'error': str|None, 'services': List[str]}
    """
    try:
        # 1. å°è¯•å¯¼å…¥MCPå·¥å…·
        try:
            from claude_tools import mcp__graphiti_memory__list_memories
        except ImportError as e:
            return {
                'available': False,
                'error': f'MCPå·¥å…·æœªå¯¼å…¥: {str(e)}',
                'suggestion': 'æ£€æŸ¥Claude Codeæ˜¯å¦æ­£ç¡®è¿æ¥MCPæœåŠ¡å™¨'
            }
        except NameError as e:
            return {
                'available': False,
                'error': f'MCPå·¥å…·æœªå®šä¹‰: {str(e)}',
                'suggestion': 'æ£€æŸ¥.claude/settings.local.jsonä¸­çš„MCPé…ç½®'
            }

        # 2. å®šä¹‰å¼‚æ­¥æµ‹è¯•å‡½æ•°
        async def _test_mcp_call():
            """æµ‹è¯•MCPå·¥å…·è°ƒç”¨"""
            return await mcp__graphiti_memory__list_memories()

        # 3. åœ¨åŒæ­¥ä¸Šä¸‹æ–‡ä¸­è¿è¡Œå¼‚æ­¥è°ƒç”¨ï¼ˆè®¾ç½®è¶…æ—¶ï¼‰
        try:
            result = asyncio.wait_for(
                _test_mcp_call(),
                timeout=timeout
            )

            # å¦‚æœæˆåŠŸï¼ŒMCPæœåŠ¡å™¨å¯ç”¨
            return {
                'available': True,
                'error': None,
                'services': ['graphiti-memory']
            }

        except asyncio.TimeoutError:
            return {
                'available': False,
                'error': f'MCPæœåŠ¡å™¨å“åº”è¶…æ—¶ï¼ˆ>{timeout}ç§’ï¼‰',
                'suggestion': 'æ£€æŸ¥MCPæœåŠ¡å™¨è´Ÿè½½æˆ–ç½‘ç»œè¿æ¥'
            }
        except Exception as e:
            return {
                'available': False,
                'error': f'MCPå·¥å…·è°ƒç”¨å¤±è´¥: {str(e)}',
                'suggestion': 'é‡å¯MCPæœåŠ¡å™¨æˆ–æ£€æŸ¥GraphitiæœåŠ¡çŠ¶æ€'
            }

    except Exception as e:
        return {
            'available': False,
            'error': f'MCPå¥åº·æ£€æŸ¥å¤±è´¥: {str(e)}',
            'suggestion': 'æ£€æŸ¥Claude Codeå’ŒMCPæœåŠ¡å™¨é…ç½®'
        }
```

**å…³é”®æ”¹è¿›**:
1. âœ… æ·»åŠ äº† `ImportError` å’Œ `NameError` æ£€æµ‹
2. âœ… ä½¿ç”¨ `asyncio.wait_for()` å®ç°è¶…æ—¶æ§åˆ¶
3. âœ… æ›´è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯å’Œå»ºè®®
4. âœ… åŸºäºå®é™…ä»£ç åº“ä¸­çš„MCPè°ƒç”¨æ¨¡å¼ï¼ˆsession_monitor.pyï¼‰
```

---

### æ›¿æ¢3: çŠ¶æ€æŠ¥å‘Šç”Ÿæˆå™¨ï¼ˆç”¨æˆ·äº¤äº’è¯´æ˜ï¼‰

```markdown
#### çŠ¶æ€æŠ¥å‘Šç”Ÿæˆå™¨å®ç°

**æ‰©å±•è¯´æ˜ï¼šç”¨æˆ·äº¤äº’æœºåˆ¶** (é’ˆå¯¹"åŸºç¡€åŠŸèƒ½æ¨¡å¼"é€‰æ‹©):

```python
# command_handlers/learning_commands.py

class LearningSessionManager:
    """æ‰©å±•ï¼šæ·»åŠ ç”¨æˆ·äº¤äº’æ”¯æŒ"""

    async def start_session(
        self,
        canvas_path: str,
        user_id: str = "default",
        session_name: Optional[str] = None,
        allow_partial_start: bool = True,
        interactive: bool = True  # æ–°å‚æ•°ï¼šæ˜¯å¦å¯ç”¨äº¤äº’å¼æç¤º
    ) -> Dict[str, Any]:
        """å¯åŠ¨å­¦ä¹ ä¼šè¯ï¼ˆæ”¯æŒäº¤äº’å¼ç”¨æˆ·ç¡®è®¤ï¼‰"""

        # ... å‰é¢çš„å¯åŠ¨é€»è¾‘ ...

        # 7. åˆ¤æ–­æ˜¯å¦æˆåŠŸå¯åŠ¨
        running_count = sum(
            1 for system_data in results.values()
            if system_data.get('status') == 'running'
        )

        if running_count == 0:
            # æ‰€æœ‰ç³»ç»Ÿéƒ½ä¸å¯ç”¨
            logger.warning("âš ï¸ æ‰€æœ‰è®°å¿†ç³»ç»Ÿä¸å¯ç”¨")

            if interactive:
                # äº¤äº’å¼æ¨¡å¼ï¼šè¯¢é—®ç”¨æˆ·æ˜¯å¦ç»§ç»­
                print("\n" + status_report)
                print("\nğŸ’¡ æ‰€æœ‰è®°å¿†ç³»ç»Ÿä¸å¯ç”¨ï¼Œä½†æ‚¨ä»å¯ä½¿ç”¨åŸºç¡€Canvaså­¦ä¹ åŠŸèƒ½ã€‚")
                print("   åŸºç¡€åŠŸèƒ½åŒ…æ‹¬ï¼šé—®é¢˜æ‹†è§£ã€AIè§£é‡Šç”Ÿæˆã€è¯„åˆ†ç­‰ã€‚")
                print("   é™åˆ¶ï¼šæ— æ³•è®°å½•å­¦ä¹ å†ç¨‹ã€æ— æ³•ç”Ÿæˆå­¦ä¹ æŠ¥å‘Šã€‚")
                print()

                # åœ¨Claude Code CLIç¯å¢ƒä¸­ï¼Œä½¿ç”¨æ‰“å°æç¤º
                # å®é™…çš„ç”¨æˆ·ç¡®è®¤é€šè¿‡å‘½ä»¤å‚æ•°å®ç°
                user_choice = input("æ˜¯å¦ç»§ç»­ä½¿ç”¨åŸºç¡€åŠŸèƒ½æ¨¡å¼ï¼Ÿ(y/n): ").strip().lower()

                if user_choice != 'y':
                    logger.info("ç”¨æˆ·é€‰æ‹©é€€å‡º")
                    return {
                        'success': False,
                        'error': 'ç”¨æˆ·å–æ¶ˆå¯åŠ¨',
                        'status_report': status_report
                    }

            # å¦‚æœå…è®¸éƒ¨åˆ†å¯åŠ¨æˆ–ç”¨æˆ·ç¡®è®¤ç»§ç»­
            if allow_partial_start:
                logger.info("ä½¿ç”¨åŸºç¡€åŠŸèƒ½æ¨¡å¼ç»§ç»­")
                # åˆ›å»ºä¸€ä¸ª"é™çº§"ä¼šè¯JSON
                session_data['mode'] = 'basic_mode'
                session_data['limitations'] = [
                    'æ— æ³•è®°å½•å­¦ä¹ å†ç¨‹',
                    'æ— æ³•ç”Ÿæˆå­¦ä¹ æŠ¥å‘Š',
                    'æ— æ³•è·¨CanvasçŸ¥è¯†å…³è”'
                ]

        # ä¿å­˜ä¼šè¯JSON
        # ...
```

**äº¤äº’æ–¹å¼é€‰æ‹©**:

1. **CLIç¯å¢ƒï¼ˆå½“å‰å®ç°ï¼‰**:
   - ä½¿ç”¨ `input()` å‡½æ•°è·å–ç”¨æˆ·è¾“å…¥
   - æ‰“å°æç¤ºä¿¡æ¯åˆ°stdout

2. **è‡ªåŠ¨åŒ–/è„šæœ¬ç¯å¢ƒ**:
   - è®¾ç½® `interactive=False`
   - é€šè¿‡ `allow_partial_start` å‚æ•°æ§åˆ¶è¡Œä¸º

3. **æœªæ¥æ‰©å±•**:
   - é€šè¿‡å‘½ä»¤è¡Œå‚æ•°ä¼ é€’: `/learning start --mode=basic`
   - é€šè¿‡é…ç½®æ–‡ä»¶é¢„è®¾: `.learning_config.json`
```

---

## âœ… ä¿®æ­£å®Œæˆ

**ä¿®æ­£çš„å…³é”®ç‚¹**:
1. âœ… Neo4jè¿æ¥æ£€æµ‹ - æ·»åŠ Windowså…¼å®¹æ€§å’Œè·¨å¹³å°å»ºè®®
2. âœ… MCPå¥åº·æ£€æŸ¥ - ä¿®æ­£å¼‚æ­¥è°ƒç”¨æ–¹å¼ï¼Œæ·»åŠ è¶…æ—¶æ§åˆ¶
3. âœ… ç”¨æˆ·äº¤äº’æœºåˆ¶ - æ˜ç¡®CLIç¯å¢ƒä¸­çš„å®ç°æ–¹å¼

**ä¸‹ä¸€æ­¥**:
è¯·å®¡é˜…ä»¥ä¸Šå†…å®¹ï¼Œç¡®è®¤åæˆ‘å°†ç»§ç»­ç”ŸæˆStory 10.12çš„ä¿®æ­£å†…å®¹ã€‚
