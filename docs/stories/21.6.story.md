# Story 21.6: Edgeè¿æ¥é€»è¾‘ä¿®å¤

## Status
ğŸ”„ In Development

## Story

**As a** Canvasç³»ç»Ÿ,
**I want** æ‰€æœ‰æ–°åˆ›å»ºçš„èŠ‚ç‚¹éƒ½æœ‰æ­£ç¡®çš„Edgeè¿æ¥,
**so that** ç”¨æˆ·èƒ½å¤Ÿæ¸…æ™°çœ‹åˆ°èŠ‚ç‚¹ä¹‹é—´çš„å…³ç³»ã€‚

## Acceptance Criteria

1. AC-21.6.1: æºèŠ‚ç‚¹ â†’ è§£é‡ŠèŠ‚ç‚¹ Edgeåˆ›å»ºæˆåŠŸ
2. AC-21.6.2: è§£é‡ŠèŠ‚ç‚¹ â†’ ä¸ªäººç†è§£èŠ‚ç‚¹ Edgeåˆ›å»ºæˆåŠŸ
3. AC-21.6.3: EdgeåŒ…å«æ­£ç¡®çš„æ ‡ç­¾ (å¦‚"åŸºç¡€æ‹†è§£"ã€"ä¸ªäººç†è§£")
4. AC-21.6.4: Edgeæ ·å¼æ­£ç¡® (é¢œè‰²ã€ç®­å¤´)
5. AC-21.6.5: ä¸åˆ›å»ºé‡å¤Edge

## Tasks / Subtasks

- [ ] Task 1: ç»Ÿä¸€Edgeåˆ›å»ºå‡½æ•° (AC: 1, 2, 4)
  - [ ] å®šä¹‰create_edgeå‡½æ•°
  - [ ] æ”¯æŒè‡ªå®šä¹‰æ ‡ç­¾
  - [ ] æ”¯æŒè‡ªå®šä¹‰é¢œè‰²
  - [ ] æ”¯æŒè‡ªå®šä¹‰è¿æ¥ç‚¹

- [ ] Task 2: å®ç°é‡å¤Edgeæ£€æŸ¥ (AC: 5)
  - [ ] æ£€æŸ¥åŒæºåŒç›®æ ‡çš„Edge
  - [ ] æ£€æŸ¥ç›¸åŒæ ‡ç­¾çš„Edge
  - [ ] è·³è¿‡å·²å­˜åœ¨çš„Edge

- [ ] Task 3: å®šä¹‰Edgeæ ‡ç­¾å¸¸é‡ (AC: 3)
  - [ ] å®šä¹‰"åŸºç¡€æ‹†è§£"æ ‡ç­¾
  - [ ] å®šä¹‰"æ·±åº¦æ‹†è§£"æ ‡ç­¾
  - [ ] å®šä¹‰"ä¸ªäººç†è§£"æ ‡ç­¾
  - [ ] å®šä¹‰"å£è¯­è§£é‡Š"æ ‡ç­¾

- [ ] Task 4: æ›´æ–°æ‰€æœ‰Agentçš„Edgeåˆ›å»º (AC: 1-4)
  - [ ] æ›´æ–°decompose_basic
  - [ ] æ›´æ–°decompose_deep
  - [ ] æ›´æ–°explain_oral
  - [ ] æ›´æ–°å…¶ä»–Agent

- [ ] Task 5: ç¼–å†™æµ‹è¯•
  - [ ] æµ‹è¯•Edgeåˆ›å»ºæˆåŠŸ
  - [ ] æµ‹è¯•é‡å¤æ£€æŸ¥
  - [ ] æµ‹è¯•æ ‡ç­¾æ­£ç¡®æ€§
  - [ ] æµ‹è¯•æ ·å¼æ­£ç¡®æ€§

## Dev Notes

### æ¶æ„ä¸Šä¸‹æ–‡

**é—®é¢˜æ ¹å› ** [Source: docs/prd/EPIC-21-AGENT-E2E-FLOW-FIX.md#é—®é¢˜åˆ†æ]

å››å±‚çº§è§£é‡Šæ­£å¸¸å·¥ä½œçš„åŸå› ä¹‹ä¸€æ˜¯Edgeè¿æ¥æ­£ç¡®åˆ›å»ºï¼Œè€Œå…¶ä»–Agentçš„Edgeåˆ›å»ºå¤±è´¥æˆ–è·³è¿‡ã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç»Ÿä¸€Agentç«¯åˆ°ç«¯æµç¨‹ - Step 5: èŠ‚ç‚¹å’ŒEdgeåˆ›å»º             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ # åˆ›å»ºè§£é‡ŠèŠ‚ç‚¹                                           â”‚
â”‚ explanation_node = create_node(...)                     â”‚
â”‚                                                         â”‚
â”‚ # åˆ›å»ºä¸ªäººç†è§£èŠ‚ç‚¹                                       â”‚
â”‚ personal_node = create_node(...)                        â”‚
â”‚                                                         â”‚
â”‚ # åˆ›å»ºEdgeè¿æ¥ â­ å…³é”®æ­¥éª¤                               â”‚
â”‚ edges = create_edges(                                   â”‚
â”‚     source_node, explanation_node, personal_node        â”‚
â”‚ )                                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å®ç°å‚è€ƒ

**ç»Ÿä¸€Edgeåˆ›å»ºå‡½æ•°** [Source: docs/prd/EPIC-21-AGENT-E2E-FLOW-FIX.md#story-21-6]

```python
# backend/app/services/agent_service.py

import uuid
from typing import Dict, Any, Optional, Literal

# Edgeæ ‡ç­¾å¸¸é‡
class EdgeLabels:
    BASIC_DECOMPOSE = "åŸºç¡€æ‹†è§£"
    DEEP_DECOMPOSE = "æ·±åº¦æ‹†è§£"
    ORAL_EXPLANATION = "å£è¯­è§£é‡Š"
    FOUR_LEVEL = "å››å±‚è§£é‡Š"
    CLARIFICATION = "æ¾„æ¸…è·¯å¾„"
    COMPARISON = "å¯¹æ¯”è¡¨æ ¼"
    MEMORY_ANCHOR = "è®°å¿†é”šç‚¹"
    EXAMPLE = "ä¾‹é¢˜æ•™å­¦"
    PERSONAL_UNDERSTANDING = "ä¸ªäººç†è§£"
    QUESTION = "é—®é¢˜æ‹†è§£"
    VERIFICATION = "æ£€éªŒé—®é¢˜"

# Edgeé¢œè‰²å¸¸é‡
class EdgeColors:
    DEFAULT = "5"       # ç°è‰²
    EXPLANATION = "3"   # ç»¿è‰²
    PERSONAL = "4"      # é»„è‰²
    ERROR = "1"         # çº¢è‰²

def create_edge(
    from_node_id: str,
    to_node_id: str,
    label: str = "",
    color: str = EdgeColors.DEFAULT,
    from_side: Literal["top", "bottom", "left", "right"] = "right",
    to_side: Literal["top", "bottom", "left", "right"] = "left"
) -> Dict[str, Any]:
    """
    ç»Ÿä¸€çš„Edgeåˆ›å»ºå‡½æ•°

    Args:
        from_node_id: æºèŠ‚ç‚¹ID
        to_node_id: ç›®æ ‡èŠ‚ç‚¹ID
        label: Edgeæ ‡ç­¾
        color: Edgeé¢œè‰²
        from_side: æºèŠ‚ç‚¹è¿æ¥ç‚¹
        to_side: ç›®æ ‡èŠ‚ç‚¹è¿æ¥ç‚¹

    Returns:
        Edgeæ•°æ®å­—å…¸
    """
    return {
        "id": str(uuid.uuid4()),
        "fromNode": from_node_id,
        "toNode": to_node_id,
        "fromSide": from_side,
        "toSide": to_side,
        "label": label,
        "color": color
    }
```

**é‡å¤Edgeæ£€æŸ¥**:

```python
def edge_exists(
    edges: List[Dict[str, Any]],
    from_node_id: str,
    to_node_id: str,
    label: Optional[str] = None
) -> bool:
    """
    æ£€æŸ¥Edgeæ˜¯å¦å·²å­˜åœ¨

    Args:
        edges: ç°æœ‰Edgeåˆ—è¡¨
        from_node_id: æºèŠ‚ç‚¹ID
        to_node_id: ç›®æ ‡èŠ‚ç‚¹ID
        label: Edgeæ ‡ç­¾ (å¯é€‰ï¼Œå¦‚æœæä¾›åˆ™åŒæ—¶æ£€æŸ¥æ ‡ç­¾)

    Returns:
        Trueå¦‚æœEdgeå·²å­˜åœ¨
    """
    for edge in edges:
        if (edge.get("fromNode") == from_node_id and
            edge.get("toNode") == to_node_id):
            if label is None or edge.get("label") == label:
                return True
    return False

def create_edge_if_not_exists(
    existing_edges: List[Dict[str, Any]],
    from_node_id: str,
    to_node_id: str,
    label: str = "",
    **kwargs
) -> Optional[Dict[str, Any]]:
    """
    å¦‚æœEdgeä¸å­˜åœ¨åˆ™åˆ›å»º

    Returns:
        æ–°åˆ›å»ºçš„Edgeï¼Œå¦‚æœå·²å­˜åœ¨åˆ™è¿”å›None
    """
    if edge_exists(existing_edges, from_node_id, to_node_id, label):
        logger.debug(f"Edge already exists: {from_node_id} -> {to_node_id} ({label})")
        return None

    return create_edge(from_node_id, to_node_id, label=label, **kwargs)
```

**å®Œæ•´åˆ›å»ºæµç¨‹**:

```python
async def create_agent_output(
    self,
    source_node_id: str,
    source_x: int,
    source_y: int,
    source_width: int,
    source_height: int,
    explanation_text: str,
    agent_type: str,
    existing_edges: List[Dict[str, Any]]
) -> Dict[str, Any]:
    """åˆ›å»ºAgentè¾“å‡ºèŠ‚ç‚¹å’ŒEdge"""

    created_nodes = []
    created_edges = []

    # 1. åˆ›å»ºè§£é‡ŠèŠ‚ç‚¹
    explanation_node_id = str(uuid.uuid4())
    explanation_x = source_x + source_width + 50
    explanation_y = source_y
    explanation_height = 200

    explanation_node = {
        "id": explanation_node_id,
        "type": "text",
        "text": explanation_text,
        "x": explanation_x,
        "y": explanation_y,
        "width": 400,
        "height": explanation_height,
        "color": "3"
    }
    created_nodes.append(explanation_node)

    # 2. åˆ›å»ºæº â†’ è§£é‡Š Edge (å¸¦é‡å¤æ£€æŸ¥)
    edge_label = getattr(EdgeLabels, agent_type.upper(), EdgeLabels.BASIC_DECOMPOSE)
    source_edge = create_edge_if_not_exists(
        existing_edges,
        source_node_id,
        explanation_node_id,
        label=edge_label,
        color=EdgeColors.EXPLANATION
    )
    if source_edge:
        created_edges.append(source_edge)

    # 3. åˆ›å»ºä¸ªäººç†è§£èŠ‚ç‚¹
    if settings.AUTO_CREATE_PERSONAL_NODE:
        personal_node_id = str(uuid.uuid4())
        personal_node = {
            "id": personal_node_id,
            "type": "text",
            "text": "åœ¨æ­¤å¡«å†™ä½ çš„ä¸ªäººç†è§£...",
            "x": explanation_x,
            "y": explanation_y + explanation_height + 50,
            "width": 400,
            "height": 150,
            "color": "4"
        }
        created_nodes.append(personal_node)

        # 4. åˆ›å»ºè§£é‡Š â†’ ä¸ªäººç†è§£ Edge
        personal_edge = create_edge(
            explanation_node_id,
            personal_node_id,
            label=EdgeLabels.PERSONAL_UNDERSTANDING,
            color=EdgeColors.PERSONAL,
            from_side="bottom",
            to_side="top"
        )
        created_edges.append(personal_edge)

    return {
        "created_nodes": created_nodes,
        "created_edges": created_edges
    }
```

### å…³é”®æ–‡ä»¶

- `backend/app/services/agent_service.py` - ä¸»è¦ä¿®æ”¹
- `backend/app/services/canvas_service.py` - Edgeå·¥å…·å‡½æ•°

### æµ‹è¯•è¦æ±‚

**å•å…ƒæµ‹è¯•è¦†ç›–**:
- æµ‹è¯•Edgeåˆ›å»ºçš„å­—æ®µå®Œæ•´æ€§
- æµ‹è¯•Edgeé‡å¤æ£€æŸ¥åŠŸèƒ½
- æµ‹è¯•ä¸åŒAgentç±»å‹çš„æ ‡ç­¾
- æµ‹è¯•Edgeé¢œè‰²è®¾ç½®
- æµ‹è¯•è¿æ¥ç‚¹æ–¹å‘

## SDDè§„èŒƒå¼•ç”¨

- **OpenAPI Spec**: `specs/api/canvas-api.openapi.yml#/components/schemas/CanvasEdge`
- **æ¶æ„æ–‡æ¡£**: `docs/prd/EPIC-21-AGENT-E2E-FLOW-FIX.md#story-21-6`

## ADRå…³è”

æ— ç›´æ¥å…³è”çš„ADRã€‚æ­¤ Story ä¸º Bug Fixï¼Œä¸æ¶‰åŠæ¶æ„å†³ç­–å˜æ›´ã€‚

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-12 | 1.0 | åˆå§‹Storyåˆ›å»º | SM Agent (Bob) |
