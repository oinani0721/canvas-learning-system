# Story 20.6: é›†æˆæµ‹è¯•ä¸ç«¯åˆ°ç«¯éªŒè¯

---
document_type: "Story"
version: "1.0.0"
last_modified: "2025-12-12"
status: "draft"
epic_id: "20"
story_id: "20.6"
priority: "P0"
estimated_hours: 6

authors:
  - name: "SM Agent"
    role: "Scrum Master"

reviewers:
  - name: "PO Agent"
    role: "Product Owner"
    approved: false

compatible_with:
  epic: "20"
  architecture: "v1.0"
  api_spec: "v1.0"

changes_from_previous:
  - "Initial Story created from Epic 20 Test Plan"
---

## Status

- [x] Draft
- [ ] Ready for Dev
- [ ] In Progress
- [ ] QA Review
- [ ] Done

## Story Overview

**ç”¨æˆ·æ•…äº‹**:
```
ä½œä¸ºQAå·¥ç¨‹å¸ˆ
æˆ‘å¸Œæœ›æœ‰å®Œæ•´çš„é›†æˆæµ‹è¯•å’Œç«¯åˆ°ç«¯æµ‹è¯•è¦†ç›–
ä»¥ä¾¿éªŒè¯å¤šProvideræ¶æ„åœ¨å„ç§åœºæ™¯ä¸‹éƒ½èƒ½æ­£å¸¸å·¥ä½œ
```

**ä¸šåŠ¡ä»·å€¼**:
- éªŒè¯Stories 20.1-20.5æ‰€æœ‰åŠŸèƒ½æ­£ç¡®é›†æˆ
- ç¡®ä¿Epic 20æ‰€æœ‰éªŒæ”¶æ ‡å‡†é€šè¿‡
- æä¾›ç³»ç»Ÿå¯é æ€§çš„è´¨é‡ä¿è¯
- å»ºç«‹æŒç»­é›†æˆæµ‹è¯•åŸºç¡€

**âš ï¸ Storyæ¥æºè¯´æ˜**:
æ­¤StoryåŸºäºEpic 20çš„æµ‹è¯•è®¡åˆ’å’ŒEpicçº§åˆ«éªŒæ”¶æ ‡å‡†(AC-20.E1~AC-20.E5)åˆ›å»ºã€‚
è™½ç„¶Epicæ–‡æ¡£ä¸­æœªæ˜¾å¼å®šä¹‰Story 20.6ï¼Œä½†æµ‹è¯•è®¡åˆ’æ˜ç¡®è¦æ±‚å•å…ƒæµ‹è¯•ã€é›†æˆæµ‹è¯•å’Œæ€§èƒ½æµ‹è¯•ã€‚
æ­¤Storyæ•´åˆè¿™äº›æµ‹è¯•éœ€æ±‚ï¼Œç¡®ä¿Epic 20çš„å®Œæ•´äº¤ä»˜ã€‚

## Acceptance Criteria

### Epicçº§åˆ«éªŒæ”¶æ ‡å‡†éªŒè¯

- [ ] **AC-20.6.1**: éªŒè¯AC-20.E1 - è‡³å°‘æ”¯æŒ3ä¸ªAI Provideré…ç½®
  - Given: ç³»ç»Ÿå·²éƒ¨ç½²
  - When: æŸ¥çœ‹Provideré…ç½®
  - Then: åº”èƒ½é…ç½®Googleã€OpenAIã€Anthropicä¸‰ä¸ªProvider

- [ ] **AC-20.6.2**: éªŒè¯AC-20.E2 - Provideræ•…éšœå2ç§’å†…è‡ªåŠ¨åˆ‡æ¢
  - Given: Primary Provideræ­£åœ¨ä½¿ç”¨
  - When: Primary Providerå˜ä¸ºä¸å¥åº·çŠ¶æ€
  - Then: ç³»ç»Ÿåº”åœ¨2ç§’å†…è‡ªåŠ¨åˆ‡æ¢åˆ°å¤‡ç”¨Provider

- [ ] **AC-20.6.3**: éªŒè¯AC-20.E3 - APIå¯†é’¥ä¸åœ¨gitå†å²ä¸­å‡ºç°
  - Given: ä»£ç ä»“åº“
  - When: è¿è¡Œ `git log -p | grep -i api_key`
  - Then: ä¸åº”è¿”å›ä»»ä½•å®é™…APIå¯†é’¥å€¼

- [ ] **AC-20.6.4**: éªŒè¯AC-20.E4 - å¥åº·æ£€æŸ¥ç«¯ç‚¹å“åº”æ—¶é—´<500ms
  - Given: åç«¯æœåŠ¡è¿è¡Œä¸­
  - When: è°ƒç”¨ `GET /api/v1/health/providers`
  - Then: å“åº”æ—¶é—´åº”<500ms

- [ ] **AC-20.6.5**: éªŒè¯AC-20.E5 - æ‰€æœ‰Provideråˆ‡æ¢æœ‰æ—¥å¿—è®°å½•
  - Given: å‘ç”ŸProvideråˆ‡æ¢
  - When: æ£€æŸ¥åº”ç”¨æ—¥å¿—
  - Then: åº”åŒ…å«åˆ‡æ¢æ—¶é—´ã€æºProviderã€ç›®æ ‡Providerã€åˆ‡æ¢åŸå› 

### é›†æˆæµ‹è¯•è¦†ç›–

- [ ] **AC-20.6.6**: å¤šProvideråˆ‡æ¢é›†æˆæµ‹è¯•é€šè¿‡
  - æµ‹è¯•åœºæ™¯: Primaryå¤±è´¥ â†’ Backup1 â†’ Backup2
  - éªŒè¯: åˆ‡æ¢è¿‡ç¨‹ä¸­è¯·æ±‚ä¸ä¸¢å¤±

- [ ] **AC-20.6.7**: æ•…éšœè½¬ç§»é›†æˆæµ‹è¯•é€šè¿‡
  - æµ‹è¯•åœºæ™¯: æ¨¡æ‹Ÿè¿ç»­3æ¬¡Providerå¤±è´¥
  - éªŒè¯: ç³»ç»Ÿæ ‡è®°Providerä¸ºä¸å¥åº·å¹¶åˆ‡æ¢

- [ ] **AC-20.6.8**: Provideræ¢å¤é›†æˆæµ‹è¯•é€šè¿‡
  - æµ‹è¯•åœºæ™¯: ä¸å¥åº·Provideræ¢å¤
  - éªŒè¯: ç³»ç»Ÿè‡ªåŠ¨å°†Provideré‡æ–°åŠ å…¥é€‰æ‹©æ± 

### ç«¯åˆ°ç«¯æµ‹è¯•è¦†ç›–

- [ ] **AC-20.6.9**: Agentè°ƒç”¨E2Eæµ‹è¯•é€šè¿‡
  - æµ‹è¯•åœºæ™¯: ä»APIç«¯ç‚¹åˆ°AI Providerçš„å®Œæ•´è°ƒç”¨é“¾
  - éªŒè¯: è¯·æ±‚æˆåŠŸè¿”å›AIç”Ÿæˆçš„å“åº”

- [ ] **AC-20.6.10**: é…ç½®çƒ­æ›´æ–°E2Eæµ‹è¯•é€šè¿‡
  - æµ‹è¯•åœºæ™¯: è¿è¡Œæ—¶ä¿®æ”¹Provideré…ç½®
  - éªŒè¯: æ–°è¯·æ±‚ä½¿ç”¨æ–°é…ç½®ï¼Œæ— éœ€é‡å¯

## Dev Notes (CRITICAL - Must be complete)

### Technical Context

**æµ‹è¯•ç›®æ ‡**:
æœ¬Storyè´Ÿè´£ä¸ºEpic 20æ‰€æœ‰åŠŸèƒ½æä¾›å…¨é¢çš„æµ‹è¯•è¦†ç›–ï¼ŒåŒ…æ‹¬ï¼š
1. **å•å…ƒæµ‹è¯•è¡¥å……** - ç¡®ä¿æ‰€æœ‰Providerç±»çš„æµ‹è¯•è¦†ç›–ç‡â‰¥85%
2. **é›†æˆæµ‹è¯•** - éªŒè¯Provideråˆ‡æ¢ã€æ•…éšœè½¬ç§»ã€æ¢å¤æ£€æµ‹çš„ç«¯åˆ°ç«¯æµç¨‹
3. **æ€§èƒ½æµ‹è¯•** - éªŒè¯å“åº”æ—¶é—´ã€åˆ‡æ¢å»¶è¿Ÿç­‰æ€§èƒ½æŒ‡æ ‡
4. **å®‰å…¨æµ‹è¯•** - éªŒè¯APIå¯†é’¥ä¸æ³„éœ²

**æµ‹è¯•æ¡†æ¶**:
- âœ… Verified from ADR-008: Testing Framework - pytest ecosystem
- pytest + pytest-asyncio (å¼‚æ­¥æµ‹è¯•)
- pytest-cov (è¦†ç›–ç‡)
- httpx (APIæµ‹è¯•)
- respx (Mock HTTPå“åº”)

### ç°æœ‰ä»£ç åˆ†æ

**æµ‹è¯•ç›®å½•ç»“æ„** (éœ€è¦åˆ›å»º/æ‰©å±•):
```
backend/tests/
â”œâ”€â”€ __init__.py
â”œâ”€â”€ conftest.py                      # å…±äº«fixtures
â”œâ”€â”€ unit/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ test_base_provider.py        # Story 20.1 å•å…ƒæµ‹è¯•
â”‚   â”œâ”€â”€ test_google_provider.py      # Story 20.1 å•å…ƒæµ‹è¯•
â”‚   â”œâ”€â”€ test_openai_provider.py      # Story 20.1 å•å…ƒæµ‹è¯•
â”‚   â”œâ”€â”€ test_anthropic_provider.py   # Story 20.1 å•å…ƒæµ‹è¯•
â”‚   â”œâ”€â”€ test_provider_factory.py     # Story 20.2 å•å…ƒæµ‹è¯•
â”‚   â””â”€â”€ test_health_check_service.py # Story 20.4 å•å…ƒæµ‹è¯•
â”œâ”€â”€ integration/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ test_multi_provider_switch.py    # å¤šProvideråˆ‡æ¢
â”‚   â”œâ”€â”€ test_failover.py                  # æ•…éšœè½¬ç§»
â”‚   â”œâ”€â”€ test_provider_recovery.py         # Provideræ¢å¤
â”‚   â””â”€â”€ test_config_hot_reload.py         # é…ç½®çƒ­æ›´æ–°
â”œâ”€â”€ e2e/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ test_agent_call_flow.py           # Agentè°ƒç”¨E2E
â”‚   â””â”€â”€ test_health_endpoint.py           # å¥åº·æ£€æŸ¥ç«¯ç‚¹E2E
â””â”€â”€ performance/
    â”œâ”€â”€ __init__.py
    â”œâ”€â”€ test_switch_latency.py            # åˆ‡æ¢å»¶è¿Ÿæµ‹è¯•
    â””â”€â”€ test_health_check_latency.py      # å¥åº·æ£€æŸ¥å“åº”æ—¶é—´æµ‹è¯•
```

**å·²å­˜åœ¨çš„æµ‹è¯•æ–‡ä»¶** (éœ€è¦éªŒè¯):
- `backend/tests/` ç›®å½•å·²å­˜åœ¨ (GlobéªŒè¯)

### API Endpoints Under Test

**å¥åº·æ£€æŸ¥ç«¯ç‚¹** (specs/api/fastapi-backend-api.openapi.yml#L49-L73):
```yaml
GET /api/v1/health:
  summary: å¥åº·æ£€æŸ¥
  responses:
    '200':
      description: åº”ç”¨å¥åº·
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/HealthCheckResponse'
```

**Providerå¥åº·æ£€æŸ¥ç«¯ç‚¹** (Epic 20å®šä¹‰ï¼Œéœ€åœ¨Story 20.4å®ç°åæµ‹è¯•):
```yaml
GET /api/v1/health/providers:
  summary: è·å–æ‰€æœ‰Providerå¥åº·çŠ¶æ€
  responses:
    '200':
      content:
        application/json:
          schema:
            type: object
            properties:
              providers:
                type: array
                items:
                  $ref: '#/components/schemas/ProviderHealth'
              active_provider:
                type: string
```

### Data Models Under Test

**ProviderHealth Schema** (å‚è€ƒStory 20.1 base_provider.py):
```python
@dataclass
class ProviderHealth:
    status: ProviderStatus  # healthy/unhealthy/unknown
    latency_ms: Optional[float]
    last_check: Optional[datetime]
    error: Optional[str]
    consecutive_failures: int
```

### SDD References

**OpenAPI Specs**:
- `specs/api/fastapi-backend-api.openapi.yml#L49-L73` - å¥åº·æ£€æŸ¥ç«¯ç‚¹
- Epic 20é™„å½•Bå®šä¹‰çš„ `/api/v1/health/providers` ç«¯ç‚¹

**JSON Schemas**:
- `specs/data/health-check-response.schema.json` - å¥åº·æ£€æŸ¥å“åº”
- éœ€æ–°å¢: `specs/data/provider-health.schema.json`

### ADR References

**ç›¸å…³ADR**:
- `docs/architecture/decisions/ADR-008-TESTING-FRAMEWORK-PYTEST-ECOSYSTEM.md` - æµ‹è¯•æ¡†æ¶é€‰æ‹©
- `docs/architecture/decisions/ADR-009-ERROR-HANDLING-RETRY-STRATEGY.md` - é”™è¯¯å¤„ç†ä¸é‡è¯•ç­–ç•¥

### Implementation Guidelines

#### æ­¥éª¤1: åˆ›å»ºæµ‹è¯•ç›®å½•ç»“æ„

```bash
# åˆ›å»ºæµ‹è¯•ç›®å½•
mkdir -p backend/tests/unit
mkdir -p backend/tests/integration
mkdir -p backend/tests/e2e
mkdir -p backend/tests/performance
```

#### æ­¥éª¤2: åˆ›å»ºå…±äº«Fixtures (conftest.py)

**æ–‡ä»¶**: `backend/tests/conftest.py`
```python
# âœ… Verified from ADR-008 (pytest fixtures pattern)
import pytest
import asyncio
from typing import AsyncGenerator
from unittest.mock import AsyncMock, MagicMock
from httpx import AsyncClient, ASGITransport

from backend.app.main import app
from backend.app.config import Settings
from backend.app.clients.base_provider import AIProvider, ProviderHealth, ProviderStatus


@pytest.fixture(scope="session")
def event_loop():
    """Create event loop for async tests"""
    loop = asyncio.get_event_loop_policy().new_event_loop()
    yield loop
    loop.close()


@pytest.fixture
def mock_settings():
    """Mock settings with test Provider configuration"""
    settings = MagicMock(spec=Settings)
    settings.AI_PROVIDER_1_NAME = "test-google"
    settings.AI_PROVIDER_1_TYPE = "google"
    settings.AI_PROVIDER_1_API_KEY = "test-api-key-1"
    settings.AI_PROVIDER_1_MODEL = "gemini-2.0-flash-exp"
    settings.AI_PROVIDER_1_PRIORITY = 1

    settings.AI_PROVIDER_2_NAME = "test-openai"
    settings.AI_PROVIDER_2_TYPE = "openai"
    settings.AI_PROVIDER_2_API_KEY = "test-api-key-2"
    settings.AI_PROVIDER_2_MODEL = "gpt-4o"
    settings.AI_PROVIDER_2_PRIORITY = 2

    settings.AI_PROVIDER_3_NAME = "test-anthropic"
    settings.AI_PROVIDER_3_TYPE = "anthropic"
    settings.AI_PROVIDER_3_API_KEY = "test-api-key-3"
    settings.AI_PROVIDER_3_MODEL = "claude-3-5-sonnet-20241022"
    settings.AI_PROVIDER_3_PRIORITY = 3

    return settings


@pytest.fixture
def mock_healthy_provider():
    """Mock healthy Provider"""
    provider = AsyncMock(spec=AIProvider)
    provider.name = "test-provider"
    provider.priority = 1
    provider.health = ProviderHealth(
        status=ProviderStatus.HEALTHY,
        latency_ms=100.0,
        consecutive_failures=0
    )
    provider.health_check.return_value = provider.health
    return provider


@pytest.fixture
def mock_unhealthy_provider():
    """Mock unhealthy Provider"""
    provider = AsyncMock(spec=AIProvider)
    provider.name = "test-provider-unhealthy"
    provider.priority = 2
    provider.health = ProviderHealth(
        status=ProviderStatus.UNHEALTHY,
        latency_ms=None,
        error="Connection timeout",
        consecutive_failures=3
    )
    provider.health_check.return_value = provider.health
    return provider


@pytest.fixture
async def async_client() -> AsyncGenerator[AsyncClient, None]:
    """Async HTTP client for API testing"""
    transport = ASGITransport(app=app)
    async with AsyncClient(transport=transport, base_url="http://test") as client:
        yield client
```

#### æ­¥éª¤3: å®ç°é›†æˆæµ‹è¯• - å¤šProvideråˆ‡æ¢

**æ–‡ä»¶**: `backend/tests/integration/test_multi_provider_switch.py`
```python
# âœ… Verified from ADR-008 (pytest-asyncio pattern)
import pytest
from unittest.mock import AsyncMock, patch
from datetime import datetime

from backend.app.clients.provider_factory import ProviderFactory
from backend.app.clients.base_provider import ProviderStatus, ProviderHealth


@pytest.mark.asyncio
class TestMultiProviderSwitch:
    """å¤šProvideråˆ‡æ¢é›†æˆæµ‹è¯• - AC-20.6.6"""

    async def test_switch_to_backup_on_primary_failure(
        self,
        mock_settings,
        mock_healthy_provider,
        mock_unhealthy_provider
    ):
        """AC-20.6.2: Primaryå¤±è´¥ååˆ‡æ¢åˆ°å¤‡ç”¨Provider"""
        # Arrange
        primary = mock_unhealthy_provider
        primary.name = "google"
        primary.priority = 1

        backup = mock_healthy_provider
        backup.name = "openai"
        backup.priority = 2

        with patch.object(ProviderFactory, '_providers', {'google': primary, 'openai': backup}):
            with patch.object(ProviderFactory, '_health_status', {
                'google': primary.health,
                'openai': backup.health
            }):
                with patch.object(ProviderFactory, '_priority_order', ['google', 'openai']):
                    # Act
                    provider = ProviderFactory.get_provider()

                    # Assert - should get backup since primary is unhealthy
                    assert provider.name == "openai"

    async def test_fallback_chain_google_openai_anthropic(
        self,
        mock_settings
    ):
        """AC-20.6.6: æµ‹è¯•å®Œæ•´æ•…éšœè½¬ç§»é“¾ Google â†’ OpenAI â†’ Anthropic"""
        # æ¨¡æ‹ŸGoogleå’ŒOpenAIéƒ½å¤±è´¥ï¼Œåªæœ‰Anthropicå¥åº·
        google = AsyncMock()
        google.name = "google"
        google.priority = 1
        google.health = ProviderHealth(status=ProviderStatus.UNHEALTHY, consecutive_failures=3)

        openai = AsyncMock()
        openai.name = "openai"
        openai.priority = 2
        openai.health = ProviderHealth(status=ProviderStatus.UNHEALTHY, consecutive_failures=3)

        anthropic = AsyncMock()
        anthropic.name = "anthropic"
        anthropic.priority = 3
        anthropic.health = ProviderHealth(status=ProviderStatus.HEALTHY, latency_ms=150.0)

        providers = {'google': google, 'openai': openai, 'anthropic': anthropic}
        health_status = {
            'google': google.health,
            'openai': openai.health,
            'anthropic': anthropic.health
        }

        with patch.object(ProviderFactory, '_providers', providers):
            with patch.object(ProviderFactory, '_health_status', health_status):
                with patch.object(ProviderFactory, '_priority_order', ['google', 'openai', 'anthropic']):
                    provider = ProviderFactory.get_provider()
                    assert provider.name == "anthropic"

    async def test_switch_latency_under_100ms(self):
        """AC-20.2.3 (from Story 20.2): Provideråˆ‡æ¢æ—¶é—´ < 100ms"""
        import time

        # æ¨¡æ‹Ÿåˆ‡æ¢åœºæ™¯
        start = time.time()

        # ProviderFactory.get_provider() åº”è¯¥æ˜¯O(n)å¤æ‚åº¦ï¼Œn=Provideræ•°é‡
        # å¯¹äº3ä¸ªProviderï¼Œåˆ‡æ¢åº”åœ¨æ¯«ç§’çº§å®Œæˆ

        elapsed_ms = (time.time() - start) * 1000

        # æ–­è¨€åˆ‡æ¢æ—¶é—´è¿œä½äº100ms (ç•™å‡ºmargin)
        assert elapsed_ms < 100, f"Switch latency {elapsed_ms}ms exceeds 100ms"
```

#### æ­¥éª¤4: å®ç°é›†æˆæµ‹è¯• - æ•…éšœè½¬ç§»

**æ–‡ä»¶**: `backend/tests/integration/test_failover.py`
```python
# âœ… Verified from ADR-009 (Circuit Breaker pattern)
import pytest
from unittest.mock import AsyncMock, patch
from datetime import datetime

from backend.app.services.health_check_service import HealthCheckService
from backend.app.clients.base_provider import ProviderStatus, ProviderHealth


@pytest.mark.asyncio
class TestFailover:
    """æ•…éšœè½¬ç§»é›†æˆæµ‹è¯• - AC-20.6.7"""

    async def test_mark_unhealthy_after_3_failures(self):
        """AC-20.4.3: è¿ç»­3æ¬¡å¤±è´¥åæ ‡è®°ä¸ºä¸å¥åº·"""
        # Arrange
        provider = AsyncMock()
        provider.name = "test-provider"
        provider.health_check.side_effect = Exception("Connection failed")

        health_service = HealthCheckService()

        # Act - æ¨¡æ‹Ÿ3æ¬¡å¤±è´¥
        for _ in range(3):
            await health_service.check_provider(provider)

        # Assert
        status = health_service.get_provider_status(provider.name)
        assert status.status == ProviderStatus.UNHEALTHY
        assert status.consecutive_failures >= 3

    async def test_remove_unhealthy_from_selection_pool(self):
        """AC-20.4.4: ä¸å¥åº·Providerä»é€‰æ‹©æ± ç§»é™¤"""
        # æ­¤æµ‹è¯•éªŒè¯ProviderFactoryä¸ä¼šé€‰æ‹©unhealthyçš„Provider
        pass  # è¯¦ç»†å®ç°å‚è€ƒtest_multi_provider_switch.py

    async def test_failover_time_under_2_seconds(self):
        """AC-20.E2: Provideræ•…éšœå2ç§’å†…è‡ªåŠ¨åˆ‡æ¢"""
        import time

        start = time.time()

        # æ¨¡æ‹Ÿæ•…éšœæ£€æµ‹å’Œåˆ‡æ¢
        # å¥åº·æ£€æŸ¥é—´éš” + åˆ‡æ¢æ—¶é—´ åº” < 2ç§’

        elapsed = time.time() - start
        assert elapsed < 2.0, f"Failover time {elapsed}s exceeds 2s"
```

#### æ­¥éª¤5: å®ç°é›†æˆæµ‹è¯• - Provideræ¢å¤

**æ–‡ä»¶**: `backend/tests/integration/test_provider_recovery.py`
```python
# âœ… Verified from ADR-009 (Recovery pattern)
import pytest
from unittest.mock import AsyncMock, patch
from datetime import datetime, timedelta

from backend.app.services.health_check_service import HealthCheckService
from backend.app.clients.base_provider import ProviderStatus, ProviderHealth


@pytest.mark.asyncio
class TestProviderRecovery:
    """Provideræ¢å¤é›†æˆæµ‹è¯• - AC-20.6.8"""

    async def test_rejoin_after_recovery(self):
        """AC-20.4.5: Provideræ¢å¤åè‡ªåŠ¨é‡æ–°åŠ å…¥é€‰æ‹©æ± """
        # Arrange
        provider = AsyncMock()
        provider.name = "recovered-provider"

        # åˆå§‹çŠ¶æ€: unhealthy
        provider.health = ProviderHealth(
            status=ProviderStatus.UNHEALTHY,
            consecutive_failures=5
        )

        # Act: æ¨¡æ‹Ÿæ¢å¤ - health_checkè¿”å›æˆåŠŸ
        provider.health_check.return_value = ProviderHealth(
            status=ProviderStatus.HEALTHY,
            latency_ms=120.0,
            consecutive_failures=0
        )

        health_service = HealthCheckService()
        await health_service.check_provider(provider)

        # Assert
        status = health_service.get_provider_status(provider.name)
        assert status.status == ProviderStatus.HEALTHY
        assert status.consecutive_failures == 0

    async def test_periodic_retry_unhealthy_providers(self):
        """éªŒè¯ç³»ç»Ÿå®šæœŸé‡è¯•ä¸å¥åº·çš„Provider"""
        # æ­¤æµ‹è¯•éªŒè¯HealthCheckServiceçš„åå°ä»»åŠ¡
        pass
```

#### æ­¥éª¤6: å®ç°E2Eæµ‹è¯•

**æ–‡ä»¶**: `backend/tests/e2e/test_health_endpoint.py`
```python
# âœ… Verified from specs/api/fastapi-backend-api.openapi.yml#L49
import pytest
import time
from httpx import AsyncClient


@pytest.mark.asyncio
class TestHealthEndpointE2E:
    """å¥åº·æ£€æŸ¥ç«¯ç‚¹E2Eæµ‹è¯•"""

    async def test_health_endpoint_response_time(self, async_client: AsyncClient):
        """AC-20.E4: å¥åº·æ£€æŸ¥ç«¯ç‚¹å“åº”æ—¶é—´<500ms"""
        start = time.time()

        response = await async_client.get("/api/v1/health")

        elapsed_ms = (time.time() - start) * 1000

        assert response.status_code == 200
        assert elapsed_ms < 500, f"Health check latency {elapsed_ms}ms exceeds 500ms"

        data = response.json()
        assert data["status"] == "healthy"

    async def test_providers_health_endpoint_structure(self, async_client: AsyncClient):
        """éªŒè¯/api/v1/health/providersç«¯ç‚¹è¿”å›ç»“æ„"""
        response = await async_client.get("/api/v1/health/providers")

        # æ³¨æ„: æ­¤ç«¯ç‚¹åœ¨Story 20.4å®ç°ï¼Œå¯èƒ½è¿”å›404
        if response.status_code == 200:
            data = response.json()
            assert "providers" in data
            assert "active_provider" in data

            for provider in data["providers"]:
                assert "name" in provider
                assert "status" in provider
                assert "latency_ms" in provider or provider["status"] == "unhealthy"
```

#### æ­¥éª¤7: å®ç°å®‰å…¨æµ‹è¯•

**æ–‡ä»¶**: `backend/tests/security/test_api_key_security.py`
```python
# âœ… Verified from AC-20.E3 requirement
import pytest
import subprocess
import os


class TestAPIKeySecurity:
    """APIå¯†é’¥å®‰å…¨æµ‹è¯• - AC-20.6.3"""

    def test_no_api_keys_in_git_history(self):
        """AC-20.E3: APIå¯†é’¥ä¸åœ¨gitå†å²ä¸­å‡ºç°"""
        # è·³è¿‡å¦‚æœä¸åœ¨gitä»“åº“ä¸­
        if not os.path.exists(".git"):
            pytest.skip("Not in a git repository")

        # æ£€æŸ¥gitå†å²ä¸­æ˜¯å¦æœ‰APIå¯†é’¥æ³„éœ²
        result = subprocess.run(
            ["git", "log", "-p", "--all"],
            capture_output=True,
            text=True
        )

        # æ£€æŸ¥å¸¸è§çš„APIå¯†é’¥æ¨¡å¼
        sensitive_patterns = [
            "sk-",           # OpenAI key prefix
            "AIza",          # Google API key prefix
            "sk-ant-",       # Anthropic key prefix
        ]

        for pattern in sensitive_patterns:
            # å…è®¸åœ¨ç¤ºä¾‹/æ¨¡æ¿ä¸­å‡ºç°ï¼Œä½†ä¸å…è®¸å®é™…å¯†é’¥
            # å®é™…å¯†é’¥é€šå¸¸é•¿åº¦>20å­—ç¬¦
            assert pattern + "test" in result.stdout or pattern not in result.stdout, \
                f"Potential API key leak detected with pattern: {pattern}"

    def test_env_file_in_gitignore(self):
        """éªŒè¯.envæ–‡ä»¶åœ¨.gitignoreä¸­"""
        gitignore_path = "backend/.gitignore"

        if os.path.exists(gitignore_path):
            with open(gitignore_path, "r") as f:
                content = f.read()
                assert ".env" in content, ".env should be in .gitignore"

    def test_api_keys_masked_in_logs(self):
        """AC-20.3.3: APIå¯†é’¥åœ¨æ—¥å¿—ä¸­è‡ªåŠ¨è„±æ•"""
        # æ­¤æµ‹è¯•éœ€è¦ä¸æ—¥å¿—ç³»ç»Ÿé›†æˆ
        # éªŒè¯æ—¥å¿—ä¸­ä¸åŒ…å«æ˜æ–‡APIå¯†é’¥
        pass
```

#### æ­¥éª¤8: å®ç°æ€§èƒ½æµ‹è¯•

**æ–‡ä»¶**: `backend/tests/performance/test_switch_latency.py`
```python
# âœ… Verified from Epic 20 performance requirements
import pytest
import time
import statistics
from typing import List


@pytest.mark.asyncio
class TestSwitchLatency:
    """Provideråˆ‡æ¢å»¶è¿Ÿæ€§èƒ½æµ‹è¯•"""

    async def test_average_switch_latency(self):
        """æµ‹è¯•å¹³å‡åˆ‡æ¢å»¶è¿Ÿ"""
        latencies: List[float] = []
        iterations = 100

        for _ in range(iterations):
            start = time.time()
            # æ¨¡æ‹ŸProvideré€‰æ‹©
            # ProviderFactory.get_provider()
            elapsed_ms = (time.time() - start) * 1000
            latencies.append(elapsed_ms)

        avg_latency = statistics.mean(latencies)
        p99_latency = sorted(latencies)[int(iterations * 0.99)]

        assert avg_latency < 50, f"Average switch latency {avg_latency}ms exceeds 50ms"
        assert p99_latency < 100, f"P99 switch latency {p99_latency}ms exceeds 100ms"


@pytest.mark.asyncio
class TestHealthCheckLatency:
    """å¥åº·æ£€æŸ¥å»¶è¿Ÿæ€§èƒ½æµ‹è¯• - AC-20.E4"""

    async def test_health_check_latency_under_500ms(self, async_client):
        """AC-20.E4: å¥åº·æ£€æŸ¥ç«¯ç‚¹å“åº”æ—¶é—´<500ms"""
        latencies = []
        iterations = 10

        for _ in range(iterations):
            start = time.time()
            response = await async_client.get("/api/v1/health")
            elapsed_ms = (time.time() - start) * 1000
            latencies.append(elapsed_ms)
            assert response.status_code == 200

        avg_latency = statistics.mean(latencies)
        max_latency = max(latencies)

        assert avg_latency < 200, f"Average health check latency {avg_latency}ms exceeds 200ms"
        assert max_latency < 500, f"Max health check latency {max_latency}ms exceeds 500ms"
```

### File Changes Summary

| æ–‡ä»¶è·¯å¾„ | æ“ä½œ | æè¿° |
|---------|------|------|
| `backend/tests/conftest.py` | ä¿®æ”¹/æ–°å¢ | æ·»åŠ Providerç›¸å…³fixtures |
| `backend/tests/integration/test_multi_provider_switch.py` | æ–°å¢ | å¤šProvideråˆ‡æ¢é›†æˆæµ‹è¯• |
| `backend/tests/integration/test_failover.py` | æ–°å¢ | æ•…éšœè½¬ç§»é›†æˆæµ‹è¯• |
| `backend/tests/integration/test_provider_recovery.py` | æ–°å¢ | Provideræ¢å¤é›†æˆæµ‹è¯• |
| `backend/tests/e2e/test_health_endpoint.py` | æ–°å¢ | å¥åº·æ£€æŸ¥ç«¯ç‚¹E2Eæµ‹è¯• |
| `backend/tests/security/test_api_key_security.py` | æ–°å¢ | APIå¯†é’¥å®‰å…¨æµ‹è¯• |
| `backend/tests/performance/test_switch_latency.py` | æ–°å¢ | åˆ‡æ¢å»¶è¿Ÿæ€§èƒ½æµ‹è¯• |

### Key Files (Verified Paths)

**å·²å­˜åœ¨çš„æ–‡ä»¶** (GlobéªŒè¯):
- `backend/app/config.py` âœ…
- `backend/app/clients/base_provider.py` âœ…
- `backend/app/clients/google_provider.py` âœ…
- `backend/app/clients/openai_provider.py` âœ…
- `backend/app/clients/anthropic_provider.py` âœ…
- `backend/app/api/v1/endpoints/health.py` âœ…

**éœ€è¦åˆ›å»ºçš„ç›®å½•**:
- `backend/tests/integration/` (å¦‚ä¸å­˜åœ¨)
- `backend/tests/e2e/` (å¦‚ä¸å­˜åœ¨)
- `backend/tests/performance/` (å¦‚ä¸å­˜åœ¨)
- `backend/tests/security/` (å¦‚ä¸å­˜åœ¨)

## Testing Requirements

### æµ‹è¯•è¦†ç›–ç‡ç›®æ ‡

| æ¨¡å— | ç›®æ ‡è¦†ç›–ç‡ |
|------|----------|
| `backend/app/clients/` | â‰¥ 90% |
| `backend/app/services/health_check_service.py` | â‰¥ 85% |
| æ•´ä½“Epic 20ä»£ç  | â‰¥ 85% |

### æµ‹è¯•è¿è¡Œå‘½ä»¤

```bash
# è¿è¡Œæ‰€æœ‰Epic 20æµ‹è¯•
cd backend
pytest tests/ -v --cov=app/clients --cov=app/services/health_check_service --cov-report=html

# åªè¿è¡Œé›†æˆæµ‹è¯•
pytest tests/integration/ -v

# åªè¿è¡ŒE2Eæµ‹è¯•
pytest tests/e2e/ -v

# åªè¿è¡Œæ€§èƒ½æµ‹è¯•
pytest tests/performance/ -v

# è¿è¡Œå®‰å…¨æµ‹è¯•
pytest tests/security/ -v
```

## Dependencies

### ä¸Šæ¸¸ä¾èµ–
- Story 20.1: å¤šProvideræ¶æ„è®¾è®¡ âœ… (ProvideråŸºç±»)
- Story 20.2: Provideråˆ‡æ¢æœºåˆ¶ (ProviderFactory)
- Story 20.3: APIå¯†é’¥å®‰å…¨ç®¡ç† (å¯†é’¥è„±æ•)
- Story 20.4: å¥åº·æ£€æŸ¥ä¸æ•…éšœè½¬ç§» (HealthCheckService)
- Story 20.5: Providerå“åº”æ—¶é—´ç›‘æ§ (å¦‚å­˜åœ¨)

### PythonåŒ…ä¾èµ–
- `pytest>=7.0` (å·²æœ‰)
- `pytest-asyncio>=0.21` (å·²æœ‰)
- `pytest-cov>=4.0` (å·²æœ‰)
- `httpx>=0.24` (ç”¨äºAPIæµ‹è¯•)
- `respx>=0.20` (Mock HTTPå“åº”)

## Tasks / Subtasks

- [ ] **Task 1**: åˆ›å»ºæµ‹è¯•ç›®å½•ç»“æ„
  - [ ] 1.1: åˆ›å»º `backend/tests/integration/`
  - [ ] 1.2: åˆ›å»º `backend/tests/e2e/`
  - [ ] 1.3: åˆ›å»º `backend/tests/performance/`
  - [ ] 1.4: åˆ›å»º `backend/tests/security/`

- [ ] **Task 2**: å®ç°å…±äº«Fixtures (AC: 20.6.1-20.6.10)
  - [ ] 2.1: æ‰©å±• `conftest.py` æ·»åŠ Provider fixtures
  - [ ] 2.2: æ·»åŠ async_client fixture

- [ ] **Task 3**: å®ç°é›†æˆæµ‹è¯• (AC: 20.6.6, 20.6.7, 20.6.8)
  - [ ] 3.1: å®ç° `test_multi_provider_switch.py`
  - [ ] 3.2: å®ç° `test_failover.py`
  - [ ] 3.3: å®ç° `test_provider_recovery.py`

- [ ] **Task 4**: å®ç°E2Eæµ‹è¯• (AC: 20.6.9, 20.6.10)
  - [ ] 4.1: å®ç° `test_health_endpoint.py`
  - [ ] 4.2: å®ç° `test_agent_call_flow.py` (å¦‚Agentè°ƒç”¨å¯ç”¨)

- [ ] **Task 5**: å®ç°å®‰å…¨æµ‹è¯• (AC: 20.6.3)
  - [ ] 5.1: å®ç° `test_api_key_security.py`

- [ ] **Task 6**: å®ç°æ€§èƒ½æµ‹è¯• (AC: 20.6.2, 20.6.4)
  - [ ] 6.1: å®ç° `test_switch_latency.py`
  - [ ] 6.2: å®ç° `test_health_check_latency.py`

- [ ] **Task 7**: éªŒè¯Epicçº§åˆ«éªŒæ”¶æ ‡å‡† (AC: 20.6.1-20.6.5)
  - [ ] 7.1: è¿è¡Œæ‰€æœ‰æµ‹è¯•å¹¶ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
  - [ ] 7.2: éªŒè¯æ‰€æœ‰AC-20.E*æ ‡å‡†é€šè¿‡
  - [ ] 7.3: æ›´æ–°æµ‹è¯•æ–‡æ¡£

---

## Definition of Done

- [ ] æ‰€æœ‰ACéªŒæ”¶æ ‡å‡†é€šè¿‡
- [ ] Epicçº§åˆ«éªŒæ”¶æ ‡å‡†(AC-20.E1~AC-20.E5)å…¨éƒ¨éªŒè¯é€šè¿‡
- [ ] ä»£ç éµå¾ª `docs/architecture/coding-standards.md` è§„èŒƒ
- [ ] æ‰€æœ‰æµ‹è¯•ä½¿ç”¨ç±»å‹æ³¨è§£
- [ ] æµ‹è¯•è¦†ç›–ç‡ â‰¥ 85%
- [ ] æ‰€æœ‰æµ‹è¯•åœ¨CIç¯å¢ƒä¸­é€šè¿‡
- [ ] æ€§èƒ½æµ‹è¯•ç»“æœæ»¡è¶³SLAè¦æ±‚
- [ ] å®‰å…¨æµ‹è¯•æ— APIå¯†é’¥æ³„éœ²

---

**Storyåˆ›å»ºæ—¶é—´**: 2025-12-12T10:00:00Z
**Epicæ¥æº**: EPIC-20-BACKEND-STABILITY-MULTI-PROVIDER.md (Test Plan Section)
**SM Agent**: Bob ğŸƒ

**âš ï¸ æ³¨æ„**:
æ­¤Story (20.6) åŸºäºEpic 20çš„æµ‹è¯•è®¡åˆ’æ¨æ–­åˆ›å»ºï¼ŒEpicæ–‡æ¡£ä¸­æœªæ˜¾å¼å®šä¹‰Story 20.5å’Œ20.6ã€‚
å»ºè®®æ›´æ–°Epicæ–‡æ¡£ä»¥åŒ…å«Story 20.5 (Providerå“åº”æ—¶é—´ç›‘æ§) å’Œ Story 20.6 (é›†æˆæµ‹è¯•ä¸E2EéªŒè¯)ã€‚
