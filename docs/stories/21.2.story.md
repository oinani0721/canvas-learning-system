# Story 21.2: ContextEnrichmentServiceæ‰©å±•

## Status
ğŸ”„ In Development

## Story

**As a** AgentæœåŠ¡,
**I want** èƒ½å¤Ÿè·å–ç›®æ ‡èŠ‚ç‚¹çš„å®Œæ•´ä¸Šä¸‹æ–‡,
**so that** ç”Ÿæˆä¸Canvasç»“æ„ç›¸å…³çš„å†…å®¹ï¼Œé¿å…å¹»è§‰ã€‚

## Acceptance Criteria

1. AC-21.2.1: æ”¯æŒæå–incoming/outgoing Edgeå…³ç³»
2. AC-21.2.2: æ”¯æŒæå–Edgeæ ‡ç­¾ (å¦‚"åŸºç¡€æ‹†è§£"ã€"ä¸ªäººç†è§£")
3. AC-21.2.3: æ”¯æŒæå–çˆ¶/å­/åŒçº§èŠ‚ç‚¹å†…å®¹
4. AC-21.2.4: æ”¯æŒå¯é…ç½®çš„ç›¸é‚»èŠ‚ç‚¹æ·±åº¦ (é»˜è®¤1å±‚)
5. AC-21.2.5: è¿”å›ç»“æ„åŒ–EnrichedContextå¯¹è±¡

## Tasks / Subtasks

- [ ] Task 1: å®šä¹‰EnrichedContextæ•°æ®ç±» (AC: 5)
  - [ ] åˆ›å»ºEnrichedContext dataclass
  - [ ] å®šä¹‰ä½ç½®ä¿¡æ¯å­—æ®µ
  - [ ] å®šä¹‰Edgeå…³ç³»å­—æ®µ
  - [ ] å®šä¹‰ç›¸é‚»èŠ‚ç‚¹å­—æ®µ
  - [ ] å®šä¹‰full_contextå­—ç¬¦ä¸²æ„å»º

- [ ] Task 2: å®ç°Edgeå…³ç³»æå– (AC: 1, 2)
  - [ ] å®ç° _extract_edges æ–¹æ³•
  - [ ] æå– incoming edges (æŒ‡å‘å½“å‰èŠ‚ç‚¹)
  - [ ] æå– outgoing edges (ä»å½“å‰èŠ‚ç‚¹å‡ºå‘)
  - [ ] æå– edge labels

- [ ] Task 3: å®ç°ç›¸é‚»èŠ‚ç‚¹æå– (AC: 3, 4)
  - [ ] å®ç° _extract_neighbors æ–¹æ³•
  - [ ] æå–çˆ¶èŠ‚ç‚¹ (é€šè¿‡incoming edges)
  - [ ] æå–å­èŠ‚ç‚¹ (é€šè¿‡outgoing edges)
  - [ ] æå–åŒçº§èŠ‚ç‚¹ (ç›¸åŒçˆ¶èŠ‚ç‚¹)
  - [ ] æ”¯æŒæ·±åº¦å‚æ•°é…ç½®

- [ ] Task 4: æ›´æ–°enrich_contextæ–¹æ³• (AC: 1-5)
  - [ ] æ·»åŠ include_edgeså‚æ•°
  - [ ] æ·»åŠ include_neighborså‚æ•°
  - [ ] æ·»åŠ max_neighbor_depthå‚æ•°
  - [ ] æ•´åˆæ‰€æœ‰ä¸Šä¸‹æ–‡ä¿¡æ¯

- [ ] Task 5: ç¼–å†™å•å…ƒæµ‹è¯•
  - [ ] æµ‹è¯•Edgeæå–
  - [ ] æµ‹è¯•ç›¸é‚»èŠ‚ç‚¹æå–
  - [ ] æµ‹è¯•æ·±åº¦é™åˆ¶
  - [ ] æµ‹è¯•ç©ºCanvaså¤„ç†

## Dev Notes

### æ¶æ„ä¸Šä¸‹æ–‡

**é—®é¢˜æ ¹å› ** [Source: docs/prd/EPIC-21-AGENT-E2E-FLOW-FIX.md#bug-2-agentç”Ÿæˆå¹»è§‰]

Agentåªèƒ½çœ‹åˆ°å•èŠ‚ç‚¹å†…å®¹ï¼Œä¸äº†è§£Canvasç»“æ„ã€Edgeå…³ç³»å’Œç›¸é‚»èŠ‚ç‚¹ï¼Œå¯¼è‡´ç”Ÿæˆå¹»è§‰å†…å®¹ã€‚

```
ç”¨æˆ·è°ƒç”¨ decompose_basic()
            â”‚
            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ é—®é¢˜: decompose_basic() ä¸ä½¿ç”¨ ContextEnrichmentService  â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚ @agents_router.post("/decompose/basic")                â”‚
â”‚ async def decompose_basic(request: DecomposeRequest):  â”‚
â”‚     content = node.get("text", "")  # â† åªæœ‰å•èŠ‚ç‚¹å†…å®¹   â”‚
â”‚     result = await agent_service.decompose_basic(      â”‚
â”‚         content=content  # â† æ— ä¸Šä¸‹æ–‡!                  â”‚
â”‚     )                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å®ç°å‚è€ƒ

**EnrichedContextæ•°æ®ç±»** [Source: docs/prd/EPIC-21-AGENT-E2E-FLOW-FIX.md#æŠ€æœ¯æ¶æ„]

```python
# backend/app/services/context_enrichment_service.py

from dataclasses import dataclass
from typing import Dict, List, Any, Optional

@dataclass
class EnrichedContext:
    """ä¸°å¯Œçš„ä¸Šä¸‹æ–‡ä¿¡æ¯"""

    # ç›®æ ‡èŠ‚ç‚¹
    target_node: Dict[str, Any]
    target_content: str

    # ä½ç½®ä¿¡æ¯
    x: int
    y: int
    width: int
    height: int

    # Edgeå…³ç³» (æ–°å¢)
    incoming_edges: List[Dict]  # æŒ‡å‘å½“å‰èŠ‚ç‚¹çš„Edge
    outgoing_edges: List[Dict]  # ä»å½“å‰èŠ‚ç‚¹å‡ºå‘çš„Edge
    edge_labels: List[str]      # Edgeæ ‡ç­¾åˆ—è¡¨

    # ç›¸é‚»èŠ‚ç‚¹ (æ–°å¢)
    parent_nodes: List[Dict]    # çˆ¶èŠ‚ç‚¹å†…å®¹
    child_nodes: List[Dict]     # å­èŠ‚ç‚¹å†…å®¹
    sibling_nodes: List[Dict]   # åŒçº§èŠ‚ç‚¹å†…å®¹

    # æ•™æä¸Šä¸‹æ–‡ (å¯é€‰)
    textbook_context: Optional[str] = None

    # å®Œæ•´ä¸Šä¸‹æ–‡å­—ç¬¦ä¸²
    full_context: str = ""
```

**Edgeå…³ç³»æå–**:

```python
async def _extract_edges(
    self,
    canvas_data: Dict,
    node_id: str
) -> Tuple[List[Dict], List[Dict], List[str]]:
    """æå–èŠ‚ç‚¹çš„Edgeå…³ç³»"""
    edges = canvas_data.get("edges", [])

    incoming = [e for e in edges if e.get("toNode") == node_id]
    outgoing = [e for e in edges if e.get("fromNode") == node_id]

    labels = []
    for edge in incoming + outgoing:
        label = edge.get("label", "")
        if label and label not in labels:
            labels.append(label)

    return incoming, outgoing, labels
```

**ç›¸é‚»èŠ‚ç‚¹æå–**:

```python
async def _extract_neighbors(
    self,
    canvas_data: Dict,
    node_id: str,
    incoming_edges: List[Dict],
    outgoing_edges: List[Dict],
    max_depth: int = 1
) -> Tuple[List[Dict], List[Dict], List[Dict]]:
    """æå–ç›¸é‚»èŠ‚ç‚¹"""
    nodes = {n["id"]: n for n in canvas_data.get("nodes", [])}

    # çˆ¶èŠ‚ç‚¹: é€šè¿‡incoming edgesæ‰¾åˆ°
    parent_ids = [e.get("fromNode") for e in incoming_edges]
    parents = [nodes[pid] for pid in parent_ids if pid in nodes]

    # å­èŠ‚ç‚¹: é€šè¿‡outgoing edgesæ‰¾åˆ°
    child_ids = [e.get("toNode") for e in outgoing_edges]
    children = [nodes[cid] for cid in child_ids if cid in nodes]

    # åŒçº§èŠ‚ç‚¹: ä¸å½“å‰èŠ‚ç‚¹æœ‰ç›¸åŒçˆ¶èŠ‚ç‚¹çš„èŠ‚ç‚¹
    siblings = []
    for parent_id in parent_ids:
        parent_children = [
            e.get("toNode") for e in canvas_data.get("edges", [])
            if e.get("fromNode") == parent_id and e.get("toNode") != node_id
        ]
        for sibling_id in parent_children:
            if sibling_id in nodes and nodes[sibling_id] not in siblings:
                siblings.append(nodes[sibling_id])

    return parents, children, siblings
```

### ç¼ºå¤±çš„ä¸Šä¸‹æ–‡ç±»å‹

| ä¸Šä¸‹æ–‡ç±»å‹ | å½“å‰çŠ¶æ€ | æœ¬Storyä¿®å¤ |
|------------|----------|-------------|
| Canvaså†…éƒ¨Edgeå…³ç³» | âŒ æœªæå– | âœ… å®ç° |
| ç›¸é‚»èŠ‚ç‚¹å†…å®¹ | âŒ æœªæå– | âœ… å®ç° |
| Edgeæ ‡ç­¾è¯­ä¹‰ | âŒ æœªæå– | âœ… å®ç° |
| è·¨Canvaså…³è” | âŒ æœªæå– | â³ Epic 25 |
| æ•™æä¸Šä¸‹æ–‡ | âŒ æœªæå– | â³ Epic 25 |

### å…³é”®æ–‡ä»¶

- `backend/app/services/context_enrichment_service.py` - ä¸»è¦ä¿®æ”¹
- `backend/app/models/schemas.py` - æ–°å¢EnrichedContext
- `backend/tests/unit/test_context_enrichment.py` - æ–°å¢æµ‹è¯•

### æµ‹è¯•è¦æ±‚

**å•å…ƒæµ‹è¯•è¦†ç›–**:
- æµ‹è¯•ç©ºCanvasçš„Edgeæå–
- æµ‹è¯•å¤šEdgeèŠ‚ç‚¹çš„å…³ç³»æå–
- æµ‹è¯•æ·±åº¦ä¸º1/2/3çš„ç›¸é‚»èŠ‚ç‚¹æå–
- æµ‹è¯•Edgeæ ‡ç­¾å»é‡
- æµ‹è¯•å¾ªç¯Edgeçš„å¤„ç†

## SDDè§„èŒƒå¼•ç”¨

- **OpenAPI Spec**: `specs/api/canvas-api.openapi.yml#/components/schemas/EnrichedContext`
- **æ¶æ„æ–‡æ¡£**: `docs/prd/EPIC-21-AGENT-E2E-FLOW-FIX.md#æŠ€æœ¯æ¶æ„`

## ADRå…³è”

æ— ç›´æ¥å…³è”çš„ADRã€‚æ­¤ Story ä¸º Bug Fixï¼Œä¸æ¶‰åŠæ¶æ„å†³ç­–å˜æ›´ã€‚

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-12 | 1.0 | åˆå§‹Storyåˆ›å»º | SM Agent (Bob) |
