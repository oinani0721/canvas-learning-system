# Story 30.12: Agent è§¦å‘å®Œæ•´æ€§è¡¥é½

**Epic**: [EPIC-30: Memory System Complete Activation](../epics/EPIC-30-MEMORY-SYSTEM-COMPLETE-ACTIVATION.md)
**Priority**: P0
**Estimated Hours**: 4
**Dependencies**: æ—  (ä¸ 30.10/30.11 å¯å¹¶è¡Œ)

---

## Status

**Done**

---

## Story

**As a** Canvas Learning System user,
**I want** all 14 agents to trigger memory writes after execution,
**so that** every learning interaction is recorded in my learning history for FSRS review scheduling.

---

## Problem Statement

å¯¹æŠ—æ€§å®¡æŸ¥ (2026-02-09) å‘ç° Agent Memory Mapping å®šä¹‰äº† 14 ä¸ª agentï¼Œä½†å®é™…è°ƒç”¨ `_trigger_memory_write()` çš„åªæœ‰ 11 ä¸ªã€‚

**ä»£ç ç°å®æ£€æŸ¥ä¿®æ­£**: ä¹‹å‰æŠ¥å‘Šç§°"ä»… 3/14 å®Œæˆ"ï¼Œç»é€è¡Œä»£ç éªŒè¯ï¼Œå®é™…ä¸º **11/14 å®Œæˆ**ï¼Œç¼ºå¤± 3 ä¸ªã€‚

### å·²æœ‰è§¦å‘ (11/14) âœ…

| Agent | è§¦å‘ä½ç½® |
|-------|---------|
| basic-decomposition | agent_service.py:L2218 |
| deep-decomposition | agent_service.py:L2327 |
| scoring-agent | agent_service.py:L2441 |
| oral-explanation | agent_service.py:L2959 (via type_map) |
| four-level-explanation | agent_service.py:L2959 (via type_map) |
| example-teaching | agent_service.py:L2959 (via type_map) |
| clarification-path | agent_service.py:L2959 (via type_map) |
| comparison-table | agent_service.py:L2959 (via type_map) |
| memory-anchor | agent_service.py:L2959 (via type_map) |
| verification-question-agent | agent_service.py:L3482 |
| question-decomposition | agent_service.py:L3637 |

### ç¼ºå¤±è§¦å‘ (3/14) ğŸ”´

| Agent | å¯¹åº”æ˜ å°„ | åŸå›  |
|-------|---------|------|
| hint-generation | AgentMemoryType.EXPLANATION_GENERATED | VerificationService è°ƒç”¨ï¼Œä¸ç»è¿‡ AgentService |
| canvas-orchestrator | AgentMemoryType.CANVAS_OPENED | ç³»ç»Ÿ orchestration agentï¼Œæ— ç›´æ¥è°ƒç”¨ç‚¹ |
| review-board-agent-selector | AgentMemoryType.CONCEPT_REVIEWED | ç³»ç»Ÿ agentï¼ŒReviewService è°ƒç”¨ |

---

## Acceptance Criteria

1. **AC-30.12.1**: hint-generation è§¦å‘
   - VerificationService è°ƒç”¨ hint-generation agent åè§¦å‘ `_trigger_memory_write()`
   - åœ¨ verification_service.py ä¸­ `_call_gemini_for_hint()` æˆåŠŸåæ·»åŠ è§¦å‘
   - agent_type="hint-generation", memory_type=EXPLANATION_GENERATED

2. **AC-30.12.2**: canvas-orchestrator è§¦å‘
   - Canvas orchestrator å¯åŠ¨æ—¶è®°å½• canvas_opened äº‹ä»¶
   - åœ¨ batch_orchestrator.py æˆ– intelligent_parallel_service.py çš„ session å¯åŠ¨å¤„æ·»åŠ è§¦å‘
   - agent_type="canvas-orchestrator", memory_type=CANVAS_OPENED

3. **AC-30.12.3**: review-board-agent-selector è§¦å‘ (é™çº§ä¸ºå¯é€‰)
   - å¦‚æœ review-board-agent-selector æœ‰å®é™…è°ƒç”¨ç‚¹ï¼Œæ·»åŠ  memory write è§¦å‘
   - å¦‚æœä»…ä¸º mapping é¢„ç•™ï¼Œæ ‡è®°ä¸º "reserved" å¹¶åœ¨ agent_memory_mapping.py æ·»åŠ æ³¨é‡Š
   - ç¡®ä¿ä¸å½±å“ç°æœ‰ 11 ä¸ª agent çš„è§¦å‘é€»è¾‘

4. **AC-30.12.4**: 14/14 æ˜ å°„å®Œæ•´æ€§éªŒè¯
   - agent_memory_mapping.py ä¸­æ‰€æœ‰ 14 ä¸ª agent éƒ½æœ‰å¯¹åº”çš„è§¦å‘ä»£ç æˆ– "reserved" æ ‡æ³¨
   - å•å…ƒæµ‹è¯•éªŒè¯æ¯ä¸ª mapped agent åœ¨è‡³å°‘ä¸€å¤„ä»£ç ä¸­è°ƒç”¨ `_trigger_memory_write()`

---

## Tasks / Subtasks

### Task 1: hint-generation è§¦å‘
- [x] 1.1 å®šä½ verification_service.py ä¸­ hint-generation è°ƒç”¨ç‚¹ (L2803)
- [x] 1.2 åœ¨æˆåŠŸè¿”å› hint åæ·»åŠ  `_trigger_memory_write(agent_type="hint-generation", ...)`
- [x] 1.3 ç¡®è®¤ VerificationService é€šè¿‡ `self._agent_service` è®¿é—® memory write
- [x] 1.4 å•å…ƒæµ‹è¯•: hint ç”ŸæˆæˆåŠŸåè§¦å‘ memory write (2 tests)

### Task 2: canvas-orchestrator è§¦å‘
- [x] 2.1 å®šä½å…¥å£: batch_orchestrator.py `start_batch_session()` L294
- [x] 2.2 åœ¨ session çŠ¶æ€è½¬ä¸º RUNNING åæ·»åŠ  canvas_opened äº‹ä»¶è®°å½•
- [x] 2.3 å•å…ƒæµ‹è¯•: ä»£ç éªŒè¯ canvas-orchestrator trigger å­˜åœ¨ (2 tests)

### Task 3: review-board-agent-selector è¯„ä¼°
- [x] 3.1 æ£€æŸ¥ review-board-agent-selector â€” ä»…åœ¨ mapping ä¸­ï¼Œæ— å®é™…è°ƒç”¨ç‚¹
- [x] 3.2 N/A (æ— è°ƒç”¨ç‚¹)
- [x] 3.3 åœ¨ agent_memory_mapping.py æ ‡æ³¨ "# Reserved: no active call site yet"
- [x] 3.4 graphiti-memory-agent åŒæ ·æ— è°ƒç”¨ç‚¹ï¼Œä¸€å¹¶æ ‡æ³¨ Reserved

### Task 4: å®Œæ•´æ€§éªŒè¯æµ‹è¯•
- [x] 4.1 test_all_14_agents_in_mapping â€” éªŒè¯ mapping æœ‰ 14 æ¡
- [x] 4.2 test_trigger_code_or_reserved_for_each_agent â€” æ‰«æä»£ç éªŒè¯

---

## Dev Notes

### å…³é”®ä»£ç ä½ç½®

| æ–‡ä»¶ | è¡Œå· | ä¿®æ”¹å†…å®¹ |
|------|------|---------|
| `backend/app/services/verification_service.py` | ~L2798 | hint-generation è§¦å‘ç‚¹ |
| `backend/app/services/batch_orchestrator.py` | session å¯åŠ¨å¤„ | canvas-orchestrator è§¦å‘ |
| `backend/app/core/agent_memory_mapping.py` | L64-65 | è¯„ä¼° reserved agents |

### æ³¨æ„äº‹é¡¹

- VerificationService é€šè¿‡ `call_agent(AgentType.HINT_GENERATION, ...)` è°ƒç”¨ hint agent (L2798)
- éœ€è¦ç¡®è®¤ VerificationService æ˜¯å¦æœ‰ memory_service ä¾èµ–æ³¨å…¥ (å†å² P0 é—®é¢˜: æ›¾æœªæ³¨å…¥)
- batch_orchestrator çš„ `_trigger_memory_write()` (L896-950) å·²å®ç°é€šç”¨è§¦å‘é€»è¾‘ï¼Œcanvas-orchestrator å¯èƒ½éœ€è¦åœ¨æ›´é«˜å±‚è°ƒç”¨

### åŸºç¡€è®¾æ–½ AC æ£€æŸ¥

| ç»´åº¦ | æ£€æŸ¥ | çŠ¶æ€ |
|------|------|------|
| D2 å¼¹æ€§ | æ–°å¢è§¦å‘å¤±è´¥ä¸é˜»å¡ä¸»æµç¨‹ | æ²¿ç”¨ fire-and-forget æ¨¡å¼ |
| D5 é™çº§ | memory_service ä¸å¯ç”¨æ—¶è·³è¿‡ | æ²¿ç”¨ç°æœ‰é™çº§é€»è¾‘ |
| D6 é›†æˆ | ä¸ç°æœ‰ 11 ä¸ªè§¦å‘çš„ä¸€è‡´æ€§ | AC-30.12.4 |

---

## Dev Agent Record

### Implementation
1. hint-generation: Added `_trigger_memory_write()` call in `verification_service.py` after successful AI hint generation (L2810+)
2. canvas-orchestrator: Added trigger in `batch_orchestrator.py` `start_batch_session()` after state transition to RUNNING
3. review-board-agent-selector + graphiti-memory-agent: Marked "Reserved" in mapping (no active call sites)

### Tests
7 tests in `test_story_30_12_agent_trigger.py` â€” all pass

---

## File List
- `backend/app/services/verification_service.py` â€” hint-generation trigger
- `backend/app/services/batch_orchestrator.py` â€” canvas-orchestrator trigger
- `backend/app/core/agent_memory_mapping.py` â€” Reserved annotation
- `backend/tests/unit/test_story_30_12_agent_trigger.py` â€” 7 tests (NEW)

---

## Change Log

| Date | Change | Author |
|------|--------|--------|
| 2026-02-09 | Story åˆ›å»º (PM Agent: John)ï¼Œä¿®æ­£å®¡æŸ¥æŠ¥å‘Šé”™è¯¯ (11/14 é 3/14) | ROG |

---

## ä»£ç ç°å®æ£€æŸ¥

| å£°ç§°çš„åŠŸèƒ½ | ä»£ç ä½ç½® | çŠ¶æ€ |
|-----------|----------|------|
| AGENT_MEMORY_MAPPING 14 ä¸ª agent | agent_memory_mapping.py:L40-66 | âœ… ç¡®è®¤ |
| _trigger_memory_write é€šç”¨æ–¹æ³• | agent_service.py:L3040-3085 | âœ… ç¡®è®¤ |
| hint-generation AgentType æšä¸¾ | agent_service.py:L111 | âœ… ç¡®è®¤ |
| ç°æœ‰è§¦å‘ç‚¹ 11 å¤„ | agent_service.py å¤šå¤„ | âœ… é€è¡ŒéªŒè¯ |
| hint è°ƒç”¨åœ¨ VerificationService | verification_service.py:L2798 | âœ… ç¡®è®¤ |
