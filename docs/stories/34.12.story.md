# Story 34.12: 静默降级修复 + 死代码清理

<!-- Powered by BMAD Core -->

## Status

**Done** (2026-02-11) — Code Review 完成，全部修复已验证

---

## Story

**As a** 运维人员和开发者,
**I want** review_service.py 中的 18 个 `except Exception` 被特化为具体异常类型，所有降级路径都有 WARNING 日志，retention_rate 死代码被清理,
**so that** 编程错误不会被静默吞掉，降级行为对运维可见，响应模型不包含永远为 None 的幽灵字段

## 来源

本 Story 基于 R4 对抗性审查发现创建：
- Finding #6: 18 个 `except Exception` 泛捕获是安全隐患 — 吞掉 TypeError/AttributeError 等编程错误 (原始声称24个，实际18个)
- Finding #7: `retention_rate` 永远返回 None — 死代码违反增量优化原则
- CLAUDE.md 明确禁止"静默降级"

---

## Acceptance Criteria

### AC1: except Exception 特化 — 18 个 → ≤5 个 [P1]

**问题**: `backend/app/services/review_service.py` 中有 18 处 `except Exception` 泛捕获，静默吞掉编程错误。

**验收标准**:

```gherkin
Given backend/app/services/review_service.py 中 18 个 except Exception
When 按调用上下文特化为具体异常类型
Then 满足以下标准:
  - 网络/IO 相关: except (ConnectionError, TimeoutError, IOError)
  - 序列化相关: except (ValueError, KeyError, TypeError)
  - 数据库相关: except (DatabaseError, OperationalError)
  - 外部服务相关: except (httpx.HTTPError, asyncio.TimeoutError)
  - 仅保留 ≤5 个 except Exception 在"最外层兜底"位置

And grep -c "except Exception" review_service.py 结果 ≤5
And 每个保留的 except Exception 都有注释说明为何必须是泛捕获
```

**基础设施维度 (D2 弹性)**:
- 特化后的异常处理必须区分"可恢复错误"(重试/降级)和"不可恢复错误"(向上抛出)

---

### AC2: 降级路径日志透明化 [P1]

**问题**: CLAUDE.md 禁止静默降级，但当前 `if service is None: return default` 不记录日志。

**验收标准**:

```gherkin
Given review_service.py 中所有 "if xxx is None" 降级路径
When 添加 WARNING 级别日志
Then 每个降级路径输出:
  logger.warning(
    "功能 %s 降级运行: %s 为 None，返回默认值 %s",
    feature_name, dependency_name, default_value
  )

And grep -c "logger.warning.*降级" review_service.py 结果 ≥3
And 日志包含: 功能名称、缺失的依赖名称、使用的默认值
```

**基础设施维度 (D5 降级)**:
- 运维人员必须能从日志中知道哪些功能在降级运行

---

### AC3: retention_rate 清理 [P1]

**问题**: `retention_rate` 字段永远返回 None，是死代码。

**验收标准**:

```gherkin
Given retention_rate 字段在响应模型中存在但永远为 None
When 审查其设计意图和使用场景
Then 满足以下之一:
  选项 A (推荐 — 如果无下游消费者):
    - 从响应模型中移除 retention_rate 字段
    - 从 API 响应中移除对应 key
    - 更新 OpenAPI 规范

  选项 B (如果前端依赖此字段):
    - 实现真实计算: retention_rate = 正确回答数 / 总复习数
    - 添加单元测试验证计算正确性
    - 前端显示保持不变

And 无论哪个选项，grep "retention_rate" 不再出现 "= None" 硬编码
```

**基础设施维度 (D1 持久化)**:
- 如果实现计算，数据来源必须明确（从哪个存储读取）

---

### AC4: 回归验证 [Gate]

**验收标准**:

```gherkin
Given AC1-AC3 全部完成
When 运行完整测试套件
Then:
  - pytest backend/tests/ -k "review" → 全 PASS
  - pytest backend/tests/integration/test_review_history_pagination.py → 48/48 PASS
  - 无新增 WARNING 或 ERROR 日志（非降级场景）
  - OpenAPI 规范更新（如果修改了响应模型）
```

---

## Tasks / Subtasks

- [x] **Task 1: 审计 except Exception** (AC: 1)
  - [x] 1.1 `grep -n "except Exception" review_service.py` 列出全部 18 处 (非24处，代码现实检查修正)
  - [x] 1.2 按调用上下文分类: Config/Import(3), File I/O(2), FSRS Library(2), External Service(8), Background(1), API-facing(2)
  - [x] 1.3 确定每处应使用的具体异常类型: 14个特化 + 4个保留

- [x] **Task 2: 特化异常处理** (AC: 1)
  - [x] 2.1 替换 14 个异常为具体类型 (Config/Import→ImportError/RuntimeError, File I/O→OSError/JSONDecodeError, External→ConnectionError/TimeoutError/ValueError等)
  - [x] 2.2 保留 4 个最外层兜底 (L744 FSRS调度, L909 FSRS记录, L1883 fire-and-forget, L1932 API兜底)
  - [x] 2.3 每个保留的泛捕获添加 `# INTENTIONAL` 注释

- [x] **Task 3: 添加降级日志** (AC: 2)
  - [x] 3.1 审计所有 `if xxx is None` 降级路径: 找到4个graphiti_client降级路径 + 1个fsrs_manager降级路径
  - [x] 3.2 添加/更新 `logger.warning` 降级日志，统一使用"功能 %s 降级运行"格式
  - [x] 3.3 验证日志格式统一: 4个降级日志均包含功能名、依赖名、默认值

- [x] **Task 4: 清理 retention_rate** (AC: 3)
  - [x] 4.1 grep 查找 retention_rate 的所有使用者: 前端 ReviewOutputParser.ts 使用了该字段
  - [x] 4.2 确定选项 B (前端依赖此字段，需实现真实计算)
  - [x] 4.3 实现: retention_rate = count(rating >= 3) / count(total rated records)，无记录时返回None

- [x] **Task 5: ATDD 红灯测试** (先于实现!)
  - [x] 5.1 写测试: 验证 except Exception ≤5 且有 INTENTIONAL 注释 (4个静态分析测试)
  - [x] 5.2 写测试: 验证降级路径产生 WARNING 日志 (2个测试)
  - [x] 5.3 写测试: 验证 retention_rate 不再硬编码 None + 计算正确性 + 空记录处理 (3个测试)
  - [x] 5.4 确认红灯: 9/9 新测试 FAIL → 实现后 9/9 PASS

- [x] **Task 6: 回归验证** (AC: 4)
  - [x] 6.1 运行 review 相关测试: 101 tests passed, 0 failures
  - [x] 6.2 OpenAPI 规范无需更新 (retention_rate 字段保留，类型未变，仅实现了计算)

---

## Dev Notes

### except Exception 分类参考

```python
# 网络/IO 相关 — 可恢复
except (ConnectionError, TimeoutError, IOError, OSError) as e:
    logger.warning("网络错误，降级处理: %s", e)
    return default_value

# 序列化/数据相关 — 数据问题
except (ValueError, KeyError, TypeError, json.JSONDecodeError) as e:
    logger.error("数据格式错误: %s", e)
    raise  # 或降级

# 外部服务相关
except (httpx.HTTPError, asyncio.TimeoutError) as e:
    logger.warning("外部服务不可用: %s", e)
    return fallback

# 最外层兜底 (仅限 endpoint handler)
# INTENTIONAL: 防止未预期异常导致 500 响应无信息
except Exception as e:
    logger.exception("未预期错误: %s", e)
    raise HTTPException(500, detail="Internal error")
```

### retention_rate 调查清单

```bash
# 查找所有使用者
grep -rn "retention_rate" --include="*.py" --include="*.ts" backend/ canvas-progress-tracker/
# 查找响应模型定义
grep -rn "retention_rate" --include="*.py" backend/app/models/ backend/app/schemas/
# 查找前端消费
grep -rn "retention_rate" --include="*.ts" canvas-progress-tracker/
```

### ATDD Evidence

- [x] 红灯测试文件: `tests/unit/test_review_service_error_handling.py` (新建)
- [ ] 红灯 commit hash: (待填)
- [ ] 绿灯 commit hash: (待填)

---

## Dev Agent Record

### Implementation Plan
- AC1: 18个except Exception审计 → 14个特化 + 4个保留(with INTENTIONAL注释)
- AC2: 4个graphiti_client降级路径添加/更新统一格式WARNING日志
- AC3: 选择Option B (前端依赖retention_rate), 实现 count(rating≥3)/total 计算

### Completion Notes
- ✅ AC1: 18→4 except Exception (≤5 ✅), 所有保留的均有INTENTIONAL注释
- ✅ AC2: 5个降级路径均使用 "功能 %s 降级运行" 统一格式 (含 get_fsrs_state)
- ✅ AC3: retention_rate 从硬编码None改为从rating数据实时计算
- ✅ AC4: 102个review相关测试全通过, 0回归
- 代码现实检查: Story原始声称24个except Exception, 实际为18个

### Code Review Fixes (2026-02-11)
- **H1 (HIGH)**: _card_states 生产格式为 JSON 字符串, get_history 添加 isinstance+json.loads 解析
- **M1**: get_fsrs_state 降级日志改为统一 "功能 %s 降级运行" 格式
- **M2**: 4个 Graphiti 异常元组补齐 KeyError/AttributeError, 保持一致性
- **M4**: AST 测试移除冗余 node.name 检查 (ExceptHandler 无 name 保证)
- **L1**: 测试文件移除未使用 import (json, logging, patch)
- 新增测试: test_retention_rate_works_with_serialized_card_states (验证生产 JSON 字符串格式)

### Debug Log
- 无

---

## File List

| File | Action | Description |
|------|--------|-------------|
| `backend/app/services/review_service.py` | Modified | 14个except Exception特化, 4个INTENTIONAL注释, 5个降级WARNING日志, retention_rate计算实现 + JSON字符串解析 |
| `backend/tests/unit/test_review_service_error_handling.py` | Created | 10个ATDD测试 (AC1: 4, AC2: 2, AC3: 4) |

---

## 依赖关系

**前置依赖**:
- ✅ Story 34.10 (DI 引用已修复)

**被依赖**:
- EPIC 级 NFR 重新评估
- CLAUDE.md 静默降级规则验证

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-10 | 0.1 | Initial draft — R4 对抗性审查 Finding #6, #7 | SM Agent (Bob) |
| 2026-02-11 | 1.0 | Implementation complete — 18→4 except Exception, 4 degradation logs, retention_rate calculation | Dev Agent |
| 2026-02-11 | 1.1 | Code Review fixes — H1 JSON string parsing, M1 unified degradation log, M2 consistent exception tuples, 102 tests passed | Code Reviewer |
