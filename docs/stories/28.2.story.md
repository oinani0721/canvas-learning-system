# Story 28.2: Agent模板引用格式规范

## Status: Done

## Parallel Development Support (v3.1)

**affected_files**:
```yaml
affected_files:
  - .claude/agents/oral-explanation.md
  - .claude/agents/four-level-explanation.md
  - .claude/agents/clarification-path.md
  - .claude/agents/example-teaching.md
  - .claude/agents/comparison-table.md
  - .claude/agents/memory-anchor.md
  - .claude/agents/basic-decomposition.md
  - .claude/agents/deep-decomposition.md
  - .claude/agents/question-decomposition.md
```

**parallel_group**: (Filled by orchestrator)
```yaml
parallel_group: "epic-28-batch-1"
worktree: null
```

> **Note**: 本 Story 可与 Story 28.1 (教材路径元数据传递) 并行开发

---

## Epic Context & Background

**所属Epic**: EPIC-28 - 双向链接跳回教材功能
**Epic文档**: [epic-28-bidirectional-textbook-links.md](../epics/epic-28-bidirectional-textbook-links.md)

**本Story在Epic中的定位**:
- Story 28.2 是 Epic 28 的 **Agent模板更新Story**，为双向链接提供格式规范
- **优先级**: P0 (必须完成)
- **依赖**: 无前置依赖
- **可并行**: Story 28.1 (教材路径元数据传递)
- **后续**: Story 28.4 (集成测试) 依赖本Story

**Epic核心问题回顾**:

### Problem 2: Agent模板无引用格式规范
- **现象**: Agent不知道如何生成 `[[file#section]]` 链接格式
- **根因**: Agent模板缺少引用格式规范
- **修复**: 本Story在9个Agent模板中添加引用规范
- **本Story验证**: AC 1-4 验证所有模板已更新

---

## Story

**As a** Canvas学习系统开发者,
**I want** 在9个Agent模板中定义统一的教材引用格式规范,
**so that** Agent生成的响应能够包含可点击的双向链接，用户可以直接跳回原始教材位置。

## Acceptance Criteria

1. **AC1**: 所有9个Agent模板(.claude/agents/)都添加了"引用规范"section
2. **AC2**: 引用规范定义了两种格式:
   - Markdown/Canvas教材: `[[教材文件路径#章节名]]`
   - PDF教材: `[[教材文件.pdf#page=N|章节名]]`
3. **AC3**: Output Format section更新，明确要求在引用教材内容时附带来源链接
4. **AC4**: 提供示例模板，展示如何在不同Agent输出类型(Markdown vs JSON)中包含引用

## Tasks / Subtasks

- [x] **Task 1**: 设计引用规范section模板 (AC: 1, 2)
  - [x] 1.1 定义通用引用格式说明
  - [x] 1.2 提供Markdown/Canvas教材引用示例
  - [x] 1.3 提供PDF教材引用示例
  - [x] 1.4 定义引用嵌入规则(直接引用 vs 块引用)

- [x] **Task 2**: 更新Markdown输出类Agent模板 (AC: 1, 3, 4)
  - [x] 2.1 更新 oral-explanation.md
  - [x] 2.2 更新 four-level-explanation.md
  - [x] 2.3 更新 clarification-path.md
  - [x] 2.4 更新 example-teaching.md
  - [x] 2.5 更新 comparison-table.md
  - [x] 2.6 更新 memory-anchor.md

- [x] **Task 3**: 更新JSON输出类Agent模板 (AC: 1, 3, 4)
  - [x] 3.1 更新 basic-decomposition.md (JSON格式，引用在text字段)
  - [x] 3.2 更新 deep-decomposition.md (JSON格式，引用在text字段)
  - [x] 3.3 更新 question-decomposition.md (JSON格式，引用在text字段)

- [x] **Task 4**: 验证引用格式Obsidian兼容性 (AC: 2)
  - [x] 4.1 测试Markdown文件链接格式在Obsidian中可点击
  - [x] 4.2 测试PDF文件链接格式在Obsidian中可点击
  - [x] 4.3 验证#section和#page=N子路径正确工作

## Dev Notes

### SDD规范参考 (必填)

**Agent API Schema** (从OpenAPI specs):
- Agent模板位置: `.claude/agents/`目录下9个模板文件
- 模板格式: Markdown with YAML frontmatter
- 规范来源: `[Source: specs/api/agent-api.openapi.yml]`

**Agent输出类型分类**:

| Agent模板 | 输出类型 | 字数范围 | 引用嵌入方式 |
|-----------|----------|----------|--------------|
| oral-explanation.md | Markdown | 800-1200字 | 直接在文本中 |
| four-level-explanation.md | Markdown | 1200-1600字 | 直接在文本中 |
| clarification-path.md | Markdown | 1500+字 | 直接在文本中 |
| example-teaching.md | Markdown | ~1000字 | 直接在文本中 |
| comparison-table.md | Markdown表格 | N/A | 表格单元格中 |
| memory-anchor.md | Markdown | 3 sections | 直接在文本中 |
| basic-decomposition.md | JSON | sub_questions[] | 在text字段中 |
| deep-decomposition.md | JSON | sub_questions[] | 在text字段中 |
| question-decomposition.md | JSON | questions[] | 在text字段中 |

**引用规范section模板** (待添加到所有Agent模板):
```markdown
## 引用规范

当你的回答引用了教材内容时，**必须**使用以下格式标注来源：

### Markdown/Canvas教材
> [引用的内容]
> — 来源: [[教材文件路径#章节名]]

示例:
> 命题的否定不同于否命题
> — 来源: [[逻辑学基础/命题与推理.md#命题的否定]]

### PDF教材
> [引用的内容]
> — 来源: [[教材文件.pdf#page=页码|章节名]]

示例:
> 命题逻辑是数理逻辑的基础
> — 来源: [[离散数学.pdf#page=42|第三章 命题逻辑]]

### 引用规则
1. 每次直接引用教材原文时，必须附带来源链接
2. 概括性描述可以不附带链接，但如有明确来源建议添加
3. 链接格式必须正确，确保用户可以点击跳转
```

### ADR决策关联 (必填)

| ADR编号 | 决策标题 | 对Story的影响 |
|---------|----------|---------------|
| ADR-001 | 使用Obsidian Canvas作为可视化知识图谱载体 | 链接必须使用Obsidian内部链接格式`[[file#section]]` |

**关键约束** (从ADR-001 Consequences提取):
- **约束1**: 所有Canvas操作必须使用JSON格式 (不影响本Story，但Agent模板输出需考虑)
- **约束2**: 内部链接必须使用Obsidian WikiLink格式: `[[file]]`, `[[file#heading]]`, `[[file#^block]]`
- **约束3**: PDF链接使用Obsidian PDF viewer格式: `[[file.pdf#page=N]]`

**Obsidian链接格式验证** (来自obsidian-canvas Skill):
- 文件节点支持`file`属性和可选`subpath`属性
- subpath支持`#Section`格式指向章节
- PDF viewer支持`#page=N`格式指向页码

来源引用: `[Source: ADR-001, obsidian-canvas Skill]`

### 相关源代码位置

```
.claude/agents/
├── oral-explanation.md      # Markdown输出 (800-1200字)
├── four-level-explanation.md # Markdown输出 (1200-1600字)
├── clarification-path.md    # Markdown输出 (1500+字)
├── example-teaching.md      # Markdown输出 (~1000字)
├── comparison-table.md      # Markdown表格输出
├── memory-anchor.md         # Markdown输出 (3 sections)
├── basic-decomposition.md   # JSON输出
├── deep-decomposition.md    # JSON输出
└── question-decomposition.md # JSON输出
```

### 实现指南

**Markdown输出Agent更新要点**:
1. 在System Prompt section后添加"引用规范"section
2. 在Output Format section中强调必须包含来源链接
3. 在示例中展示带引用的输出格式

**JSON输出Agent更新要点**:
1. 在System Prompt section后添加"引用规范"section
2. 在JSON schema说明中添加source_reference可选字段说明
3. 在text类型字段中允许嵌入`[[链接]]`格式

**示例 - Markdown Agent引用嵌入**:
```markdown
## 核心讲解

命题的否定是形式逻辑中的重要概念。根据[[逻辑学基础/命题与推理.md#命题的否定]]，命题"若p则q"的否定是"p且非q"，而不是"若非p则非q"。

...
```

**示例 - JSON Agent引用嵌入**:
```json
{
  "sub_questions": [
    {
      "question": "什么是命题的否定？",
      "guidance": "参考[[逻辑学基础/命题与推理.md#命题的否定]]，命题否定是将命题的真值取反。",
      "source": "[[逻辑学基础/命题与推理.md#命题的否定]]"
    }
  ]
}
```

### Testing

**测试要求**:
- 文件位置: 不需要自动化测试（Prompt Engineering变更）
- 测试方法: 手动验证Obsidian链接可点击性

**测试用例**:
1. 在Obsidian中创建测试Markdown文件，验证`[[file#section]]`格式可正确跳转
2. 测试PDF链接`[[file.pdf#page=N|alias]]`格式在Obsidian中正确打开PDF并跳转页码
3. 调用Agent API，验证响应中包含正确格式的引用链接
4. 验证链接在Canvas节点文本中正确渲染为可点击链接

**验收标准**:
- 所有9个Agent模板已更新
- Markdown和PDF两种链接格式均已定义
- Agent生成的响应中引用格式符合规范

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-27 | 0.1 | Story Draft created by SM Agent | Bob (SM) |

---

## Dev Agent Record

### Agent Model Used
(待开发时填写)

### Debug Log References
(待开发时填写)

### Completion Notes List
(待开发时填写)

### File List
(待开发时填写)

---

## QA Results

### Review Date: 2026-01-02

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**Overall Assessment: GOOD with Documentation Gaps**

The implementation is technically complete and correct. All 9 Agent templates have been updated with consistent "引用规范" sections that properly define bidirectional link formats for both Markdown/Canvas and PDF textbooks. The implementation follows ADR-001 Obsidian WikiLink format requirements.

**Strengths:**
1. Consistent structure across all 9 templates
2. Clear format definitions with comprehensive examples
3. Proper handling of both Markdown and JSON output types
4. Reference rules are clear and actionable
5. Both `[[file#section]]` and `[[file.pdf#page=N|name]]` formats documented

**Documentation Gaps Identified:**
- Dev Agent Record section not filled (shows "待开发时填写")
- File List section not filled
- Completion Notes not filled

### Refactoring Performed

No refactoring performed - prompt template implementation is complete and correct.

### Compliance Check

- Coding Standards: ✓ Templates follow consistent structure
- Project Structure: ✓ Files in correct `.claude/agents/` directory
- Testing Strategy: ✓ Manual testing approach appropriate for prompt engineering
- All ACs Met: ✓ See Requirements Traceability below

### Requirements Traceability (Given-When-Then)

| AC | Given | When | Then | Status |
|----|-------|------|------|--------|
| AC1 | 9 Agent templates exist | Dev adds reference section | Each template has "引用规范" after System Prompt | ✅ VERIFIED |
| AC2 | Two textbook types (MD/PDF) | Reference spec is added | Two formats defined: `[[file#section]]` and `[[file.pdf#page=N\|name]]` | ✅ VERIFIED |
| AC3 | Output Format section exists | Reference spec is added | Instructions emphasize source link inclusion | ✅ VERIFIED |
| AC4 | MD and JSON output types exist | Examples are added | Both types have proper embedding examples | ✅ VERIFIED |

**Verification Evidence:**
- oral-explanation.md: Lines 32-57 (引用规范 section)
- four-level-explanation.md: Lines 35-60 (引用规范 section)
- clarification-path.md: Lines 33-58 (引用规范 section)
- example-teaching.md: Lines 33-59 (引用规范 section)
- comparison-table.md: Lines 39-61 (引用规范 section with table embedding)
- memory-anchor.md: Lines 54-78 (引用规范 section)
- basic-decomposition.md: Lines 74-104 (引用规范 section with JSON examples)
- deep-decomposition.md: Lines 79-109 (引用规范 section with JSON examples)
- question-decomposition.md: Lines 79-109 (引用规范 section with JSON examples)

### Improvements Checklist

- [x] All 9 Agent templates updated with 引用规范 section
- [x] Markdown/Canvas format defined (`[[file#section]]`)
- [x] PDF format defined (`[[file.pdf#page=N|name]]`)
- [x] JSON output agents have field embedding examples (text/guidance)
- [x] Markdown output agents have inline text embedding examples
- [ ] Dev Agent Record section needs to be filled by developer
- [ ] File List section needs to be filled by developer
- [ ] Completion Notes needs to be filled by developer

### Security Review

**Status: PASS**
No security concerns - prompt templates only, no code execution or data handling changes.

### Performance Considerations

**Status: PASS**
No performance impact - changes are to prompt templates only.

### Files Modified During Review

No files modified during this review.

### Test Architecture Assessment

**Approach: Manual Testing (Appropriate)**

The story explicitly states automated tests are not required for prompt engineering changes. The manual testing approach with 4 test cases is adequate:
1. Markdown file link verification in Obsidian
2. PDF link format verification in Obsidian
3. Agent API response link format verification
4. Canvas node text link rendering verification

### Gate Status

Gate: CONCERNS → docs/qa/gates/28.2-agent-template-reference-format.yml

**Gate Decision Rationale:**
- Implementation: COMPLETE and CORRECT
- Documentation: INCOMPLETE (Dev Agent Record, File List not filled)
- Risk Level: LOW (prompt engineering changes only)

### Recommended Status

**✓ Ready for Done** - Implementation is complete. Documentation sections should be filled by developer but are non-blocking for production use.

---

## Story Draft Checklist Validation

| Category                             | Status | Issues |
| ------------------------------------ | ------ | ------ |
| 1. Goal & Context Clarity            | PASS   | Goal clear, fits Epic 28 bidirectional links |
| 2. Technical Implementation Guidance | PASS   | All 9 templates listed with output types |
| 3. Reference Effectiveness           | PASS   | ADR-001, obsidian-canvas Skill referenced |
| 4. Self-Containment Assessment       | PASS   | Complete reference spec template provided |
| 5. Testing Guidance                  | PASS   | Manual testing approach with 4 test cases |
| 6. SDD/ADR Verification (MANDATORY)  | PASS   | SDD规范引用 + ADR关联 sections complete |

**Final Assessment: READY**

The story provides sufficient context for implementation:
- Clear goal: Add reference format specification to 9 Agent templates
- Complete reference spec template ready for copy-paste
- Distinct guidance for Markdown vs JSON output agents
- Obsidian link format verified via Skill documentation
