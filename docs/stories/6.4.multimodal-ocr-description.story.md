# Story 6.4: 图片OCR与描述生成

## Status
Completed

## Story

**As a** Canvas学习用户,
**I want** 自动提取图片中的文字和公式,
**so that** 文本内容可以被检索

## Epic Context

**Epic**: SCP-006 多模态文件关联
**Phase**: Phase 2 - 智能分析
**Priority**: P1
**Estimated Time**: 3天

## Dependencies

- ✅ Story 6.1 (图片支持) - 图片处理基础
- ✅ Story 6.3 (存储架构) - 统一存储接口
- ✅ ADR-001 (Gemini选型) - 使用Gemini 2.0 Flash

## Acceptance Criteria

### AC 6.4.1: 图片中的文字自动提取（OCR）
- [x] 支持中文、英文、混合文本
- [x] 支持印刷体和手写体
- [x] 准确率≥90%（标准测试集）

### AC 6.4.2: AI生成图片内容描述（中文）
- [x] 描述长度: 50-200字
- [x] 包含图片类型识别（截图/手绘/图表等）
- [x] 包含主要内容和关键概念

### AC 6.4.3: 数学公式识别为LaTeX格式
- [x] 识别行内公式
- [x] 识别行间公式
- [x] 输出标准LaTeX格式（如 $E=mc^2$）

### AC 6.4.4: 处理时间<3秒/张
- [x] 单张图片处理≤3秒
- [x] 支持批量处理
- [x] 超时自动重试

## Tasks / Subtasks

- [x] Task 1: 创建GeminiVisionProcessor类 (AC: 6.4.1, 6.4.2, 6.4.3)
  - [x] 配置Gemini 2.0 Flash API
  - [x] 设计OCR+描述提示词
  - [x] 实现analyze_image()方法
  - [x] 实现JSON响应解析

- [x] Task 2: 实现数学公式识别 (AC: 6.4.3)
  - [x] 设计LaTeX提取提示词
  - [x] 验证LaTeX格式正确性
  - [x] 处理复杂公式（矩阵、积分等）

- [x] Task 3: 性能优化 (AC: 6.4.4)
  - [x] 实现异步处理
  - [x] 添加超时和重试机制
  - [x] 实现批量处理接口

## Dev Notes

### 技术栈

```yaml
AI模型:
  Gemini 2.0 Flash:
    能力: Vision + Text
    API: google-generativeai
    成本: $0.075/1M input + $0.30/1M output

提示词设计:
  任务: OCR + 描述 + LaTeX提取
  输出: JSON格式
  语言: 中文优先
```

### 代码位置

```
创建文件:
- src/agentic_rag/processors/gemini_vision.py

修改文件:
- src/agentic_rag/processors/image_processor.py (集成Vision)

测试文件:
- src/tests/test_gemini_vision.py
- src/tests/fixtures/ocr_test_images/
```

### 核心实现

```python
# src/agentic_rag/processors/gemini_vision.py
import google.generativeai as genai
from typing import TypedDict

class ImageAnalysisResult(TypedDict):
    ocr_text: str
    latex_formulas: list[str]
    code_snippets: list[dict]
    description: str
    key_concepts: list[str]

class GeminiVisionProcessor:
    """Gemini 2.0 Flash 视觉处理器"""

    def __init__(self, api_key: str):
        genai.configure(api_key=api_key)
        self.model = genai.GenerativeModel('gemini-2.0-flash-exp')

    async def analyze_image(
        self,
        image_b64: str,
        mime_type: str
    ) -> ImageAnalysisResult:
        """分析图片，提取OCR和生成描述"""

        prompt = """请分析这张图片，完成以下任务：

1. **OCR文字提取**: 识别图片中的所有文字，包括：
   - 普通文本
   - 数学公式（输出为LaTeX格式，如 $E=mc^2$）
   - 代码片段（标注语言）

2. **内容描述**: 用中文描述图片内容（50-200字），包括：
   - 图片类型（截图、手绘、图表、照片等）
   - 主要内容
   - 关键概念

请以JSON格式输出：
{
  "ocr_text": "提取的所有文字...",
  "latex_formulas": ["$formula1$", "$formula2$"],
  "code_snippets": [{"language": "python", "code": "..."}],
  "description": "图片内容描述...",
  "key_concepts": ["概念1", "概念2", "概念3"]
}"""

        response = await self.model.generate_content_async([
            {"mime_type": mime_type, "data": image_b64},
            prompt
        ])

        # 解析JSON响应
        import json
        result = json.loads(response.text)

        return ImageAnalysisResult(**result)
```

### 提示词优化

```yaml
OCR提示词要点:
  - 明确要求识别中英文混合
  - 强调数学公式转LaTeX
  - 代码片段标注语言

描述提示词要点:
  - 限制字数50-200
  - 要求识别图片类型
  - 提取关键概念（3-5个）

LaTeX提示词要点:
  - 行内公式用 $...$
  - 行间公式用 $$...$$
  - 复杂结构使用 \begin{} \end{}
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-30 | 1.0 | Initial Story Creation | SM Agent (Bob) |

## QA Results

### Review Date: 待开发

### Reviewed By: 待开发

### Test Results
待开发

---

**关联文档**:
- SCP-006-IMPLEMENTATION-PLAN.md
- ADR-001-local-model-vs-api.md (Gemini选型)
