# Story 13.2 - Canvas APIé›†æˆ

**Epic**: Epic 13 - Obsidian Pluginæ ¸å¿ƒåŠŸèƒ½
**Story ID**: Story 13.2
**åˆ›å»ºæ—¥æœŸ**: 2025-11-30
**Storyç‚¹æ•°**: 5 Points
**é¢„ä¼°æ—¶é—´**: 4å¤©
**ä¼˜å…ˆçº§**: P0 (Must Have)
**ä¾èµ–**: Story 13.1 (Pluginé¡¹ç›®åˆå§‹åŒ–)

---

## ğŸ“‹ Storyæè¿°

å®ç°Obsidian Canvas APIå°è£…å±‚ï¼Œä¸ºPluginæä¾›ç±»å‹å®‰å…¨çš„Canvasæ–‡ä»¶è¯»å†™å’ŒèŠ‚ç‚¹/è¾¹æ“ä½œAPIã€‚è¿™æ˜¯Epic 13çš„æ ¸å¿ƒåŸºç¡€è®¾æ–½å±‚ï¼Œæ‰€æœ‰åç»­åŠŸèƒ½ï¼ˆå‘½ä»¤ã€èœå•ã€è®¾ç½®ï¼‰éƒ½ä¾èµ–æ­¤APIå±‚ã€‚

**æ ¸å¿ƒç›®æ ‡**:
- å°è£…Obsidian Vault APIçš„Canvasæ–‡ä»¶è¯»å†™æ“ä½œ
- æä¾›ç±»å‹å®‰å…¨çš„TypeScriptæ¥å£ï¼ˆCanvasData, CanvasNode, CanvasEdgeï¼‰
- å®ç°èŠ‚ç‚¹/è¾¹çš„CRUDæ“ä½œ
- å®ç°æŒ‰é¢œè‰²è¿‡æ»¤èŠ‚ç‚¹çš„ä¸šåŠ¡é€»è¾‘
- é…ç½®`.canvas_backups/`ä¸ºéšè—æ–‡ä»¶å¤¹ [SCP-003]

---

## ğŸ¯ ç”¨æˆ·æ•…äº‹ (User Story)

```
ä½œä¸ºCanvas Learning System Pluginçš„å¼€å‘è€…
å½“æˆ‘éœ€è¦è¯»å–æˆ–ä¿®æ”¹Canvasæ–‡ä»¶æ—¶
æˆ‘å¸Œæœ›æœ‰ä¸€ä¸ªç±»å‹å®‰å…¨çš„TypeScript APIå±‚
è¿™æ ·æˆ‘å¯ä»¥å®‰å…¨åœ°æ“ä½œCanvasæ•°æ®
è€Œä¸å¿…æ‰‹åŠ¨å¤„ç†JSONè§£æå’ŒVault APIè°ƒç”¨
ä»è€Œé™ä½Bugé£é™©ï¼Œæé«˜å¼€å‘æ•ˆç‡
```

---

## ğŸ›  æŠ€æœ¯èƒŒæ™¯

### Obsidian Canvasæ–‡ä»¶æ ¼å¼

**âœ… Verified from obsidian-canvas Skill (SKILL.md - Quick Reference #1)**

Canvasæ–‡ä»¶æ˜¯JSONæ ¼å¼ï¼Œæ‰©å±•åä¸º`.canvas`ï¼š

```json
{
  "nodes": [
    {
      "id": "unique-node-id",
      "type": "text",
      "x": 0,
      "y": 0,
      "width": 250,
      "height": 60,
      "text": "# Heading\nContent with **markdown**",
      "color": "1"
    },
    {
      "id": "file-node-id",
      "type": "file",
      "x": 300,
      "y": 0,
      "width": 400,
      "height": 300,
      "file": "path/to/note.md",
      "subpath": "#Section"
    }
  ],
  "edges": [
    {
      "id": "edge-id",
      "fromNode": "unique-node-id",
      "toNode": "file-node-id",
      "fromSide": "right",
      "toSide": "left",
      "toEnd": "arrow"
    }
  ]
}
```

### èŠ‚ç‚¹ç±»å‹

**âœ… Verified from obsidian-canvas Skill (SKILL.md - Key Concepts)**

| Type | æè¿° | å¿…å¡«å±æ€§ |
|------|------|----------|
| `text` | æ–‡æœ¬èŠ‚ç‚¹ï¼Œæ”¯æŒMarkdown | `text` |
| `file` | æ–‡ä»¶å¼•ç”¨èŠ‚ç‚¹ | `file` (å¯é€‰`subpath`) |
| `link` | å¤–éƒ¨é“¾æ¥èŠ‚ç‚¹ | `url` |
| `group` | åˆ†ç»„å®¹å™¨ | `label` (å¯é€‰) |

### é¢œè‰²ç³»ç»Ÿ

**âœ… Verified from obsidian-canvas Skill (SKILL.md - Section 6) + ADR-0001**

| Color Code | é¢œè‰² | é¡¹ç›®è¯­ä¹‰ |
|------------|------|----------|
| `"1"` | ğŸ”´ çº¢è‰² | ä¸ç†è§£/æœªé€šè¿‡ |
| `"2"` | ğŸŸ  æ©™è‰² | (æœªä½¿ç”¨) |
| `"3"` | ğŸŸ¡ é»„è‰² | ä¼¼æ‡‚éæ‡‚/å¾…æ£€éªŒ |
| `"4"` | ğŸŸ¢ ç»¿è‰² | å®Œå…¨ç†è§£/å·²é€šè¿‡ |
| `"5"` | ğŸ”µ é’è‰² | AIè¡¥å……è§£é‡Š |
| `"6"` | ğŸŸ£ ç´«è‰² | ä¸ªäººç†è§£è¾“å‡ºåŒº |

**âš ï¸ æ³¨æ„**: é¡¹ç›®ä½¿ç”¨çš„è¯­ä¹‰æ˜ å°„ä¸ObsidianåŸç”Ÿé¢œè‰²åç§°ä¸åŒã€‚
- é¡¹ç›®ä¸­"é»„è‰²èŠ‚ç‚¹"å®é™…ä½¿ç”¨color="6"ï¼ˆç´«è‰²ï¼‰
- è¯¦è§`canvas-layer-architecture.md`é¢œè‰²å¸¸é‡å®šä¹‰

### Obsidian Vault API

**âœ… Verified from obsidian-canvas Skill (SKILL.md - Quick Reference #2-5)**

```typescript
// è¯»å–Canvasæ–‡ä»¶
const content = await this.app.vault.read(file);
const canvasData = JSON.parse(content);

// å†™å…¥Canvasæ–‡ä»¶
const newContent = JSON.stringify(canvasData, null, 2);
await this.app.vault.modify(canvasFile, newContent);

// åˆ›å»ºæ–°Canvasæ–‡ä»¶
await this.app.vault.create(canvasPath, content);
```

---

## ğŸ“š Dev Notes (æŠ€æœ¯ä¸Šä¸‹æ–‡ - Dev Agentä¸“ç”¨)

### SDDè§„èŒƒå¼•ç”¨

| è§„èŒƒç±»å‹ | æ–‡ä»¶è·¯å¾„ | ç›¸å…³å†…å®¹ |
|----------|----------|----------|
| OpenAPI | `specs/api/canvas-api.openapi.yml` | Layer1-JSON: `/canvas/{canvas_path}`, `/canvas/{canvas_path}/nodes`, `/canvas/{canvas_path}/edges` |
| JSON Schema | `specs/data/canvas-node.schema.json` | CanvasNodeå®šä¹‰ (id, type, x, y, width, height, color, text/file/url) |
| JSON Schema | `specs/data/canvas-edge.schema.json` | CanvasEdgeå®šä¹‰ (id, fromNode, toNode, fromSide, toSide, label) |

### ADRå…³è”

| ADR | æ–‡ä»¶è·¯å¾„ | å†³ç­–è¦ç‚¹ |
|-----|----------|----------|
| ADR-0001 | `docs/architecture/decisions/0001-use-obsidian-canvas.md` | ä½¿ç”¨Obsidian Canvasä½œä¸ºå¯è§†åŒ–çŸ¥è¯†å›¾è°±è½½ä½“ï¼ŒJSONæ ¼å¼ï¼Œé¢œè‰²ç³»ç»Ÿæ˜ å°„ |

### SCPå…³è”

| SCP | æ–‡ä»¶è·¯å¾„ | ç›¸å…³è¦æ±‚ |
|-----|----------|----------|
| SCP-003 | `docs/SPRINT_CHANGE_PROPOSAL_SCP-003_Canvaså¤‡ä»½æ–‡ä»¶å¤¹è§„èŒƒ.md` | Story 13.2éœ€è¦ï¼šåœ¨Pluginä¸­é…ç½®`.canvas_backups/`ä¸ºéšè—æ–‡ä»¶å¤¹ |

### æ ¸å¿ƒTypeScriptæ¥å£

**æ–‡ä»¶**: `src/canvas-api/types.ts`

```typescript
// âœ… Verified from specs/data/canvas-node.schema.json
export interface CanvasNode {
  id: string;
  type: 'text' | 'file' | 'group' | 'link';
  x: number;
  y: number;
  width?: number;  // default: 250
  height?: number; // default: 60
  color?: '1' | '2' | '3' | '4' | '5' | '6';
  // type-specific fields
  text?: string;   // type=text
  file?: string;   // type=file
  subpath?: string;// type=file (optional)
  url?: string;    // type=link
  label?: string;  // type=group
}

// âœ… Verified from specs/data/canvas-edge.schema.json
export interface CanvasEdge {
  id: string;
  fromNode: string;
  toNode: string;
  fromSide?: 'top' | 'bottom' | 'left' | 'right';
  toSide?: 'top' | 'bottom' | 'left' | 'right';
  toEnd?: 'none' | 'arrow';
  label?: string;
  color?: string;
}

// âœ… Verified from specs/api/canvas-api.openapi.yml (CanvasData schema)
export interface CanvasData {
  nodes: CanvasNode[];
  edges: CanvasEdge[];
}

// Canvasé¢œè‰²å¸¸é‡ (é¡¹ç›®è¯­ä¹‰æ˜ å°„)
// âœ… Verified from canvas-layer-architecture.md:165-171
export const CANVAS_COLORS = {
  RED: '1',      // ğŸ”´ ä¸ç†è§£/æœªé€šè¿‡
  ORANGE: '2',   // ğŸŸ  (æœªä½¿ç”¨)
  YELLOW: '3',   // ğŸŸ¡ ä¼¼æ‡‚éæ‡‚
  GREEN: '4',    // ğŸŸ¢ å®Œå…¨ç†è§£
  CYAN: '5',     // ğŸ”µ AIè¡¥å……è§£é‡Š
  PURPLE: '6'    // ğŸŸ£ ä¸ªäººç†è§£è¾“å‡ºåŒº
} as const;
```

### æ ¸å¿ƒAPIå®ç°

**æ–‡ä»¶**: `src/canvas-api/canvas-service.ts`

```typescript
import { App, TFile, TFolder } from 'obsidian';
import { CanvasData, CanvasNode, CanvasEdge } from './types';

/**
 * Canvas APIæœåŠ¡ç±»
 *
 * æä¾›Canvasæ–‡ä»¶çš„CRUDæ“ä½œå’Œä¸šåŠ¡é€»è¾‘
 *
 * âœ… Verified from obsidian-canvas Skill (SKILL.md - Quick Reference #2-5)
 */
export class CanvasService {
  constructor(private app: App) {}

  // ===================== Layer 1: åŸºç¡€è¯»å†™ =====================

  /**
   * è¯»å–Canvasæ–‡ä»¶
   *
   * âœ… Verified from obsidian-canvas Skill (SKILL.md - Section 2)
   */
  async readCanvas(file: TFile): Promise<CanvasData> {
    if (file.extension !== 'canvas') {
      throw new Error(`Not a canvas file: ${file.path}`);
    }
    const content = await this.app.vault.read(file);
    const data = JSON.parse(content);

    // éªŒè¯ç»“æ„
    if (!data.nodes || !Array.isArray(data.nodes)) {
      throw new Error('Invalid canvas format: missing nodes array');
    }
    if (!data.edges || !Array.isArray(data.edges)) {
      data.edges = []; // edgeså¯ä»¥ä¸ºç©º
    }

    return data as CanvasData;
  }

  /**
   * å†™å…¥Canvasæ–‡ä»¶
   *
   * âœ… Verified from obsidian-canvas Skill (SKILL.md - Section 4)
   */
  async writeCanvas(file: TFile, canvasData: CanvasData): Promise<void> {
    const content = JSON.stringify(canvasData, null, 2);
    await this.app.vault.modify(file, content);
  }

  /**
   * åˆ›å»ºæ–°Canvasæ–‡ä»¶
   *
   * âœ… Verified from obsidian-canvas Skill (SKILL.md - Section 7)
   */
  async createCanvas(path: string, canvasData?: CanvasData): Promise<TFile> {
    const data = canvasData || { nodes: [], edges: [] };
    const content = JSON.stringify(data, null, 2);
    return await this.app.vault.create(path, content);
  }

  // ===================== Layer 2: èŠ‚ç‚¹æ“ä½œ =====================

  /**
   * ç”Ÿæˆå”¯ä¸€ID
   *
   * âœ… Verified from obsidian-canvas Skill (SKILL.md - Section 3)
   */
  generateId(): string {
    return Math.random().toString(36).substring(2, 15) +
           Math.random().toString(36).substring(2, 15);
  }

  /**
   * æ·»åŠ èŠ‚ç‚¹
   *
   * âœ… Verified from obsidian-canvas Skill (SKILL.md - Section 3)
   */
  addNode(canvasData: CanvasData, node: Omit<CanvasNode, 'id'>): string {
    const newNode: CanvasNode = {
      id: this.generateId(),
      width: 250,
      height: 60,
      ...node
    };
    canvasData.nodes.push(newNode);
    return newNode.id;
  }

  /**
   * è·å–å•ä¸ªèŠ‚ç‚¹
   */
  getNode(canvasData: CanvasData, nodeId: string): CanvasNode | undefined {
    return canvasData.nodes.find(node => node.id === nodeId);
  }

  /**
   * æ›´æ–°èŠ‚ç‚¹
   */
  updateNode(canvasData: CanvasData, nodeId: string, updates: Partial<CanvasNode>): boolean {
    const index = canvasData.nodes.findIndex(node => node.id === nodeId);
    if (index === -1) return false;
    canvasData.nodes[index] = { ...canvasData.nodes[index], ...updates };
    return true;
  }

  /**
   * åˆ é™¤èŠ‚ç‚¹ï¼ˆåŒæ—¶åˆ é™¤å…³è”çš„è¾¹ï¼‰
   */
  deleteNode(canvasData: CanvasData, nodeId: string): boolean {
    const index = canvasData.nodes.findIndex(node => node.id === nodeId);
    if (index === -1) return false;

    // åˆ é™¤èŠ‚ç‚¹
    canvasData.nodes.splice(index, 1);

    // åˆ é™¤å…³è”çš„è¾¹
    canvasData.edges = canvasData.edges.filter(
      edge => edge.fromNode !== nodeId && edge.toNode !== nodeId
    );

    return true;
  }

  // ===================== Layer 3: è¾¹æ“ä½œ =====================

  /**
   * æ·»åŠ è¾¹
   *
   * âœ… Verified from obsidian-canvas Skill (SKILL.md - Section 5)
   */
  addEdge(canvasData: CanvasData, edge: Omit<CanvasEdge, 'id'>): string {
    const newEdge: CanvasEdge = {
      id: this.generateId(),
      toEnd: 'arrow',
      ...edge
    };
    canvasData.edges.push(newEdge);
    return newEdge.id;
  }

  /**
   * åˆ é™¤è¾¹
   */
  deleteEdge(canvasData: CanvasData, edgeId: string): boolean {
    const index = canvasData.edges.findIndex(edge => edge.id === edgeId);
    if (index === -1) return false;
    canvasData.edges.splice(index, 1);
    return true;
  }

  // ===================== Layer 4: ä¸šåŠ¡é€»è¾‘ =====================

  /**
   * æŒ‰é¢œè‰²è·å–èŠ‚ç‚¹
   *
   * âœ… Verified from obsidian-canvas Skill (SKILL.md - Section 8)
   */
  getNodesByColor(canvasData: CanvasData, color: string): CanvasNode[] {
    return canvasData.nodes.filter(node => node.color === color);
  }

  /**
   * è·å–è¿æ¥çš„èŠ‚ç‚¹
   *
   * âœ… Verified from obsidian-canvas Skill (SKILL.md - Section 8)
   */
  getConnectedNodes(canvasData: CanvasData, nodeId: string): CanvasNode[] {
    const connectedIds = new Set<string>();

    canvasData.edges.forEach(edge => {
      if (edge.fromNode === nodeId) connectedIds.add(edge.toNode);
      if (edge.toNode === nodeId) connectedIds.add(edge.fromNode);
    });

    return canvasData.nodes.filter(node => connectedIds.has(node.id));
  }

  /**
   * è·å–æ–‡æœ¬èŠ‚ç‚¹
   */
  getTextNodes(canvasData: CanvasData): CanvasNode[] {
    return canvasData.nodes.filter(node => node.type === 'text');
  }

  /**
   * è·å–æ–‡ä»¶èŠ‚ç‚¹
   */
  getFileNodes(canvasData: CanvasData): CanvasNode[] {
    return canvasData.nodes.filter(node => node.type === 'file');
  }
}
```

### SCP-003: éšè—å¤‡ä»½æ–‡ä»¶å¤¹é…ç½®

**æ–‡ä»¶**: `src/canvas-api/backup-folder.ts`

```typescript
import { App, TFolder } from 'obsidian';

/**
 * Canvaså¤‡ä»½æ–‡ä»¶å¤¹ç®¡ç†
 *
 * âœ… Verified from SCP-003 (Section 4.3)
 *
 * Story 13.2éœ€è¦å®ç°:
 * - é…ç½®.canvas_backups/ä¸ºéšè—æ–‡ä»¶å¤¹
 *
 * Story 13.5éœ€è¦å®ç°:
 * - å³é”®èœå•"ä¿æŠ¤æ­¤å¤‡ä»½"åŠŸèƒ½
 */
export class BackupFolderManager {
  private static readonly BACKUP_FOLDER = '.canvas_backups';

  constructor(private app: App) {}

  /**
   * ç¡®ä¿å¤‡ä»½æ–‡ä»¶å¤¹å­˜åœ¨ä¸”è¢«éšè—
   *
   * âœ… Verified from SCP-003 (Section 4.1 & 4.3)
   */
  async ensureBackupFolder(): Promise<TFolder | null> {
    const vault = this.app.vault;
    const folderPath = BackupFolderManager.BACKUP_FOLDER;

    let folder = vault.getAbstractFileByPath(folderPath);

    if (!folder) {
      // åˆ›å»ºæ–‡ä»¶å¤¹
      await vault.createFolder(folderPath);
      folder = vault.getAbstractFileByPath(folderPath);
    }

    return folder instanceof TFolder ? folder : null;
  }

  /**
   * è·å–å¤‡ä»½æ–‡ä»¶å¤¹è·¯å¾„
   */
  getBackupFolderPath(): string {
    return BackupFolderManager.BACKUP_FOLDER;
  }

  /**
   * æ£€æŸ¥è·¯å¾„æ˜¯å¦åœ¨å¤‡ä»½æ–‡ä»¶å¤¹å†…
   */
  isBackupPath(path: string): boolean {
    return path.startsWith(BackupFolderManager.BACKUP_FOLDER);
  }
}
```

**Pluginé…ç½®** (`src/main.ts`ä¸­çš„è®¾ç½®):

```typescript
// âœ… Verified from SCP-003 (Section 4.3)
// åœ¨Pluginçš„onload()ä¸­é…ç½®å¤‡ä»½æ–‡ä»¶å¤¹éšè—

export default class CanvasLearningPlugin extends Plugin {
  async onload() {
    // å…¶ä»–åˆå§‹åŒ–...

    // SCP-003: é…ç½®.canvas_backups/ä¸ºéšè—æ–‡ä»¶å¤¹
    // Obsidianä¼šè‡ªåŠ¨éšè—ä»¥.å¼€å¤´çš„æ–‡ä»¶å¤¹
    // ç¡®ä¿å¤‡ä»½æ–‡ä»¶å¤¹å­˜åœ¨
    const backupManager = new BackupFolderManager(this.app);
    await backupManager.ensureBackupFolder();
  }
}
```

### é¡¹ç›®æ–‡ä»¶ç»“æ„

```
src/
â”œâ”€â”€ canvas-api/
â”‚   â”œâ”€â”€ types.ts              # TypeScriptç±»å‹å®šä¹‰
â”‚   â”œâ”€â”€ canvas-service.ts     # æ ¸å¿ƒCanvas APIæœåŠ¡
â”‚   â”œâ”€â”€ backup-folder.ts      # å¤‡ä»½æ–‡ä»¶å¤¹ç®¡ç† [SCP-003]
â”‚   â””â”€â”€ index.ts              # å¯¼å‡º
â”œâ”€â”€ main.ts                   # Pluginä¸»å…¥å£
â””â”€â”€ ...
```

---

## âœ… éªŒæ”¶æ ‡å‡† (Acceptance Criteria)

### åŠŸèƒ½éªŒæ”¶

**AC1**: Canvasæ–‡ä»¶è¯»å–åŠŸèƒ½
- [ ] èƒ½å¤Ÿè¯»å–æœ‰æ•ˆçš„.canvasæ–‡ä»¶å¹¶è¿”å›CanvasDataå¯¹è±¡
- [ ] å¯¹é.canvasæ–‡ä»¶æŠ›å‡ºæ˜ç¡®é”™è¯¯
- [ ] å¯¹æ— æ•ˆJSONæ ¼å¼æŠ›å‡ºæ˜ç¡®é”™è¯¯
- [ ] å¯¹ç¼ºå°‘nodesæ•°ç»„çš„æ–‡ä»¶æŠ›å‡ºæ˜ç¡®é”™è¯¯
- [ ] å¯¹ç¼ºå°‘edgesæ•°ç»„çš„æ–‡ä»¶è‡ªåŠ¨è¡¥å…¨ä¸ºç©ºæ•°ç»„

**AC2**: Canvasæ–‡ä»¶å†™å…¥åŠŸèƒ½
- [ ] èƒ½å¤Ÿå°†CanvasDataå¯¹è±¡å†™å…¥.canvasæ–‡ä»¶
- [ ] å†™å…¥ä½¿ç”¨2ç©ºæ ¼ç¼©è¿›çš„JSONæ ¼å¼
- [ ] å†™å…¥åæ–‡ä»¶å†…å®¹å¯è¢«Obsidianæ­£å¸¸æ‰“å¼€

**AC3**: èŠ‚ç‚¹CRUDæ“ä½œ
- [ ] addNode(): æ·»åŠ èŠ‚ç‚¹åˆ°Canvasï¼Œè¿”å›æ–°èŠ‚ç‚¹ID
- [ ] getNode(): é€šè¿‡IDè·å–èŠ‚ç‚¹
- [ ] updateNode(): æ›´æ–°èŠ‚ç‚¹å±æ€§
- [ ] deleteNode(): åˆ é™¤èŠ‚ç‚¹å¹¶è‡ªåŠ¨åˆ é™¤å…³è”è¾¹

**AC4**: è¾¹CRUDæ“ä½œ
- [ ] addEdge(): æ·»åŠ è¾¹ï¼Œé»˜è®¤toEnd='arrow'
- [ ] deleteEdge(): åˆ é™¤è¾¹

**AC5**: ä¸šåŠ¡é€»è¾‘åŠŸèƒ½
- [ ] getNodesByColor(): æŒ‰é¢œè‰²è¿‡æ»¤èŠ‚ç‚¹
- [ ] getConnectedNodes(): è·å–ä¸æŒ‡å®šèŠ‚ç‚¹è¿æ¥çš„æ‰€æœ‰èŠ‚ç‚¹
- [ ] getTextNodes(): è·å–æ‰€æœ‰æ–‡æœ¬èŠ‚ç‚¹
- [ ] getFileNodes(): è·å–æ‰€æœ‰æ–‡ä»¶èŠ‚ç‚¹

**AC6**: å¤‡ä»½æ–‡ä»¶å¤¹é…ç½® [SCP-003]
- [ ] æ’ä»¶åŠ è½½æ—¶ç¡®ä¿`.canvas_backups/`æ–‡ä»¶å¤¹å­˜åœ¨
- [ ] å¤‡ä»½æ–‡ä»¶å¤¹åœ¨Obsidianæ–‡ä»¶æµè§ˆå™¨ä¸­ä¸æ˜¾ç¤ºï¼ˆä»¥.å¼€å¤´è‡ªåŠ¨éšè—ï¼‰
- [ ] isBackupPath()æ­£ç¡®è¯†åˆ«å¤‡ä»½æ–‡ä»¶å¤¹å†…çš„è·¯å¾„

### æŠ€æœ¯éªŒæ”¶

**AC7**: TypeScriptç±»å‹å®‰å…¨
- [ ] æ‰€æœ‰æ¥å£ä¸`specs/data/canvas-node.schema.json`ä¸€è‡´
- [ ] æ‰€æœ‰æ¥å£ä¸`specs/data/canvas-edge.schema.json`ä¸€è‡´
- [ ] ç¼–è¯‘æ—¶æ— TypeScripté”™è¯¯

**AC8**: é”™è¯¯å¤„ç†
- [ ] æ‰€æœ‰å…¬å¼€æ–¹æ³•æœ‰try-catchä¿æŠ¤
- [ ] é”™è¯¯ä¿¡æ¯åŒ…å«ä¸Šä¸‹æ–‡ï¼ˆæ–‡ä»¶è·¯å¾„ã€æ“ä½œç±»å‹ï¼‰
- [ ] ä¸ä¼šå› å•ä¸ªæ“ä½œå¤±è´¥å¯¼è‡´æ•´ä¸ªæ’ä»¶å´©æºƒ

---

## ğŸ“ ä»»åŠ¡æ¸…å• (Task Checklist)

### Task 1: TypeScriptç±»å‹å®šä¹‰ â±ï¸ 0.5å¤©

**æ–‡ä»¶**: `src/canvas-api/types.ts`

**å®ç°æ­¥éª¤**:
1. [ ] å®šä¹‰CanvasNodeæ¥å£ï¼ˆå‚è€ƒspecs/data/canvas-node.schema.jsonï¼‰
2. [ ] å®šä¹‰CanvasEdgeæ¥å£ï¼ˆå‚è€ƒspecs/data/canvas-edge.schema.jsonï¼‰
3. [ ] å®šä¹‰CanvasDataæ¥å£ï¼ˆå‚è€ƒspecs/api/canvas-api.openapi.ymlï¼‰
4. [ ] å®šä¹‰CANVAS_COLORSå¸¸é‡ï¼ˆå‚è€ƒcanvas-layer-architecture.mdï¼‰
5. [ ] å¯¼å‡ºæ‰€æœ‰ç±»å‹

**éªŒæ”¶**:
- [ ] TypeScriptç¼–è¯‘æ— é”™è¯¯
- [ ] ç±»å‹ä¸JSON Schemaä¸€è‡´

---

### Task 2: CanvasServiceåŸºç¡€è¯»å†™ â±ï¸ 1å¤©

**æ–‡ä»¶**: `src/canvas-api/canvas-service.ts`

**å®ç°æ­¥éª¤**:
1. [ ] å®ç°readCanvas()æ–¹æ³•
2. [ ] å®ç°writeCanvas()æ–¹æ³•
3. [ ] å®ç°createCanvas()æ–¹æ³•
4. [ ] å®ç°generateId()æ–¹æ³•
5. [ ] æ·»åŠ é”™è¯¯å¤„ç†å’ŒéªŒè¯

**éªŒæ”¶**:
- [ ] èƒ½æ­£ç¡®è¯»å–ç°æœ‰Canvasæ–‡ä»¶
- [ ] èƒ½æ­£ç¡®å†™å…¥Canvasæ–‡ä»¶
- [ ] èƒ½åˆ›å»ºæ–°çš„Canvasæ–‡ä»¶

---

### Task 3: èŠ‚ç‚¹CRUDæ“ä½œ â±ï¸ 1å¤©

**æ–‡ä»¶**: `src/canvas-api/canvas-service.ts`

**å®ç°æ­¥éª¤**:
1. [ ] å®ç°addNode()æ–¹æ³•
2. [ ] å®ç°getNode()æ–¹æ³•
3. [ ] å®ç°updateNode()æ–¹æ³•
4. [ ] å®ç°deleteNode()æ–¹æ³•ï¼ˆå«è¾¹æ¸…ç†ï¼‰

**éªŒæ”¶**:
- [ ] æ‰€æœ‰CRUDæ“ä½œæ­£å¸¸å·¥ä½œ
- [ ] åˆ é™¤èŠ‚ç‚¹æ—¶å…³è”è¾¹è¢«æ­£ç¡®åˆ é™¤

---

### Task 4: è¾¹æ“ä½œå’Œä¸šåŠ¡é€»è¾‘ â±ï¸ 1å¤©

**æ–‡ä»¶**: `src/canvas-api/canvas-service.ts`

**å®ç°æ­¥éª¤**:
1. [ ] å®ç°addEdge()æ–¹æ³•
2. [ ] å®ç°deleteEdge()æ–¹æ³•
3. [ ] å®ç°getNodesByColor()æ–¹æ³•
4. [ ] å®ç°getConnectedNodes()æ–¹æ³•
5. [ ] å®ç°getTextNodes()æ–¹æ³•
6. [ ] å®ç°getFileNodes()æ–¹æ³•

**éªŒæ”¶**:
- [ ] æ‰€æœ‰ä¸šåŠ¡æ–¹æ³•æ­£å¸¸å·¥ä½œ
- [ ] é¢œè‰²è¿‡æ»¤ç»“æœæ­£ç¡®

---

### Task 5: å¤‡ä»½æ–‡ä»¶å¤¹é…ç½® [SCP-003] â±ï¸ 0.5å¤©

**æ–‡ä»¶**: `src/canvas-api/backup-folder.ts`, `src/main.ts`

**å®ç°æ­¥éª¤**:
1. [ ] å®ç°BackupFolderManagerç±»
2. [ ] å®ç°ensureBackupFolder()æ–¹æ³•
3. [ ] å®ç°getBackupFolderPath()æ–¹æ³•
4. [ ] å®ç°isBackupPath()æ–¹æ³•
5. [ ] åœ¨Plugin onload()ä¸­è°ƒç”¨ensureBackupFolder()

**éªŒæ”¶**:
- [ ] æ’ä»¶åŠ è½½æ—¶å¤‡ä»½æ–‡ä»¶å¤¹è‡ªåŠ¨åˆ›å»º
- [ ] å¤‡ä»½æ–‡ä»¶å¤¹åœ¨Obsidianä¸­éšè—

---

## ğŸ”— ä¾èµ–å…³ç³»

### ä¾èµ–çš„Story

| Story | åç§° | å¿…éœ€ | è¯´æ˜ |
|-------|------|------|------|
| Story 13.1 | Pluginé¡¹ç›®åˆå§‹åŒ– | âœ… | æä¾›PluginåŸºç¡€æ¡†æ¶ã€TypeScripté…ç½®ã€æ„å»ºè„šæœ¬ |

### è¢«ä¾èµ–çš„Story

| Story | åç§° | è¯´æ˜ |
|-------|------|------|
| Story 13.3 | APIå®¢æˆ·ç«¯å®ç° | ä½¿ç”¨CanvasServiceä¸åç«¯äº¤äº’ |
| Story 13.4 | æ ¸å¿ƒå‘½ä»¤å®ç° | ä½¿ç”¨CanvasServiceè¯»å†™Canvas |
| Story 13.5 | å³é”®èœå•å’Œå¿«æ·é”® | ä½¿ç”¨BackupFolderManagerå®ç°"ä¿æŠ¤å¤‡ä»½"åŠŸèƒ½ |

---

## ğŸ“Š æµ‹è¯•è®¡åˆ’

### å•å…ƒæµ‹è¯•

**Test 1**: Canvasè¯»å†™æµ‹è¯•
- [ ] è¯»å–æœ‰æ•ˆCanvasæ–‡ä»¶æˆåŠŸ
- [ ] è¯»å–éCanvasæ–‡ä»¶æŠ›å‡ºé”™è¯¯
- [ ] è¯»å–æ— æ•ˆJSONæŠ›å‡ºé”™è¯¯
- [ ] å†™å…¥åæ–‡ä»¶å†…å®¹æ­£ç¡®

**Test 2**: èŠ‚ç‚¹æ“ä½œæµ‹è¯•
- [ ] addNodeè¿”å›æœ‰æ•ˆID
- [ ] getNodeè¿”å›æ­£ç¡®èŠ‚ç‚¹
- [ ] updateNodeæ›´æ–°æˆåŠŸ
- [ ] deleteNodeåˆ é™¤æˆåŠŸä¸”è¾¹è¢«æ¸…ç†

**Test 3**: è¾¹æ“ä½œæµ‹è¯•
- [ ] addEdgeè¿”å›æœ‰æ•ˆID
- [ ] deleteEdgeåˆ é™¤æˆåŠŸ

**Test 4**: ä¸šåŠ¡é€»è¾‘æµ‹è¯•
- [ ] getNodesByColorè¿”å›æ­£ç¡®èŠ‚ç‚¹
- [ ] getConnectedNodesè¿”å›æ­£ç¡®ç»“æœ
- [ ] getTextNodes/getFileNodesè¿‡æ»¤æ­£ç¡®

**Test 5**: å¤‡ä»½æ–‡ä»¶å¤¹æµ‹è¯•
- [ ] ensureBackupFolderåˆ›å»ºæ–‡ä»¶å¤¹æˆåŠŸ
- [ ] isBackupPathæ­£ç¡®è¯†åˆ«è·¯å¾„

### é›†æˆæµ‹è¯•

**Test 6**: E2Eåœºæ™¯1 - å®Œæ•´CRUDæµç¨‹
1. åˆ›å»ºæ–°Canvas
2. æ·»åŠ èŠ‚ç‚¹
3. æ·»åŠ è¾¹
4. æ›´æ–°èŠ‚ç‚¹é¢œè‰²
5. åˆ é™¤èŠ‚ç‚¹ï¼ˆéªŒè¯è¾¹è¢«åˆ é™¤ï¼‰
6. å†™å…¥æ–‡ä»¶
7. é‡æ–°è¯»å–éªŒè¯

**Test 7**: E2Eåœºæ™¯2 - ä¸Obsidianäº¤äº’
1. æ‰“å¼€ç°æœ‰Canvas
2. è¯»å–å†…å®¹
3. ä¿®æ”¹å¹¶ä¿å­˜
4. åœ¨Obsidianä¸­éªŒè¯æ›´æ”¹

---

## âš ï¸ é£é™©å’Œç¼“è§£ç­–ç•¥

### é£é™©1: Canvasæ ¼å¼å˜åŒ– âš ï¸ ä½é£é™©

**æè¿°**: Obsidianæ›´æ–°å¯èƒ½æ”¹å˜Canvasæ–‡ä»¶æ ¼å¼

**ç¼“è§£ç­–ç•¥**:
- ä½¿ç”¨obsidian-canvas Skillçš„æ ‡å‡†æ ¼å¼
- ç¼–å†™å®Œæ•´çš„å•å…ƒæµ‹è¯•è¦†ç›–æ ¼å¼è§£æ
- å…³æ³¨Obsidian CHANGELOG

### é£é™©2: IDå†²çª âš ï¸ ä½é£é™©

**æè¿°**: generateId()å¯èƒ½ç”Ÿæˆé‡å¤ID

**ç¼“è§£ç­–ç•¥**:
- ä½¿ç”¨è¶³å¤Ÿé•¿çš„éšæœºå­—ç¬¦ä¸²ï¼ˆ26ä½ï¼‰
- åœ¨å¤§è§„æ¨¡åœºæ™¯ä¸‹å¯è€ƒè™‘UUID

---

## ğŸ“ Storyå®Œæˆå®šä¹‰ (Definition of Done)

- [ ] æ‰€æœ‰5ä¸ªTaskå®Œæˆ
- [ ] æ‰€æœ‰8ä¸ªéªŒæ”¶æ ‡å‡†é€šè¿‡
- [ ] å•å…ƒæµ‹è¯•è¦†ç›–ç‡â‰¥80%
- [ ] é›†æˆæµ‹è¯•é€šè¿‡
- [ ] TypeScriptç¼–è¯‘æ— é”™è¯¯
- [ ] ä»£ç å·²Review
- [ ] æ–‡æ¡£å·²æ›´æ–°

---

## ğŸ” åå¹»è§‰éªŒè¯æ¸…å•

| éªŒè¯é¡¹ | æ¥æº | éªŒè¯çŠ¶æ€ |
|--------|------|----------|
| Canvas JSONæ ¼å¼ | obsidian-canvas Skill (SKILL.md) | âœ… |
| èŠ‚ç‚¹ç±»å‹å®šä¹‰ | specs/data/canvas-node.schema.json | âœ… |
| è¾¹ç±»å‹å®šä¹‰ | specs/data/canvas-edge.schema.json | âœ… |
| é¢œè‰²ç³»ç»Ÿ | ADR-0001 + canvas-layer-architecture.md | âœ… |
| Vault APIç”¨æ³• | obsidian-canvas Skill (SKILL.md #2-5) | âœ… |
| å¤‡ä»½æ–‡ä»¶å¤¹è§„èŒƒ | SCP-003 | âœ… |

---

**Storyåˆ›å»ºæ—¥æœŸ**: 2025-11-30
**Storyä½œè€…**: SM Agent (Bob)
**çŠ¶æ€**: Draft
