# Story 22.2: TemporalClient实现

## Status
⏳ Ready for Development

## Story

**As a** Agent服务,
**I want** 能够存储和查询学习事件的时序数据,
**so that** 支持基于时间的学习分析和艾宾浩斯复习提醒。

## Acceptance Criteria

1. AC-22.2.1: 能够存储学习事件 (episode) 到Graphiti
2. AC-22.2.2: 能够按时间范围查询事件
3. AC-22.2.3: 能够按实体类型 (Concept, CanvasNode) 查询
4. AC-22.2.4: 支持时间窗口聚合查询 (日/周/月统计)
5. AC-22.2.5: 与Graphiti库正确集成
6. AC-22.2.6: 单元测试覆盖TemporalClient

## Tasks / Subtasks

- [ ] Task 1: 创建TemporalClient类骨架 (AC: 5)
  - [ ] 定义类结构和初始化方法
  - [ ] 集成Graphiti客户端
  - [ ] 配置Neo4j连接参数
  - [ ] 添加类型注解

- [ ] Task 2: 实现学习事件存储 (AC: 1)
  - [ ] 实现add_learning_episode方法
  - [ ] 定义Episode数据结构
  - [ ] 支持自定义metadata
  - [ ] 返回episode_id

- [ ] Task 3: 实现时间范围查询 (AC: 2)
  - [ ] 实现search_by_time_range方法
  - [ ] 支持start_time和end_time参数
  - [ ] 支持可选的entity_type过滤
  - [ ] 返回Episode列表

- [ ] Task 4: 实现实体类型查询 (AC: 3)
  - [ ] 实现search_by_entity_type方法
  - [ ] 支持Concept、CanvasNode等类型
  - [ ] 支持分页参数

- [ ] Task 5: 实现时间聚合查询 (AC: 4)
  - [ ] 实现get_learning_stats方法
  - [ ] 支持day/week/month粒度
  - [ ] 返回学习次数、时长、概念数等统计

- [ ] Task 6: 编写单元测试 (AC: 6)
  - [ ] 测试Episode存储
  - [ ] 测试时间范围查询
  - [ ] 测试实体类型查询
  - [ ] 测试聚合查询
  - [ ] Mock Graphiti客户端

## Dev Notes

### 架构上下文

**问题根因** [Source: docs/prd/EPIC-22-MEMORY-SYSTEM-NEO4J-GRAPHITI.md#问题分析]

TemporalClient类完全不存在，导致无法存储和查询学习历史:

```
预期文件: src/agentic_rag/clients/temporal_client.py
实际状态: 文件不存在

后果:
- 无法追踪用户学习进度
- 无法实现艾宾浩斯复习提醒
- Agent无法利用历史学习数据
```

### 实现参考

**TemporalClient实现** [Source: docs/prd/EPIC-22-MEMORY-SYSTEM-NEO4J-GRAPHITI.md#Story-22.2]

```python
# src/agentic_rag/clients/temporal_client.py

from graphiti_core import Graphiti
from graphiti_core.nodes import EpisodeType
from datetime import datetime
from typing import List, Dict, Optional, Literal
import logging

logger = logging.getLogger(__name__)

class TemporalClient:
    """Graphiti时序查询客户端"""

    def __init__(
        self,
        neo4j_uri: str,
        neo4j_user: str,
        neo4j_password: str
    ):
        self.graphiti = Graphiti(
            neo4j_uri=neo4j_uri,
            neo4j_user=neo4j_user,
            neo4j_password=neo4j_password
        )

    async def add_learning_episode(
        self,
        content: str,
        episode_type: str = "learning",
        metadata: Optional[Dict] = None
    ) -> str:
        """
        添加学习事件

        Args:
            content: 学习内容描述
            episode_type: 事件类型 (learning, review, assessment)
            metadata: 额外元数据 (canvas_path, node_id, score等)

        Returns:
            episode_id: 新创建的Episode ID
        """
        episode = await self.graphiti.add_episode(
            name=f"{episode_type}_{datetime.now().isoformat()}",
            episode_body=content,
            source=EpisodeType.text,
            reference_time=datetime.now()
        )
        logger.info(f"Added learning episode: {episode.uuid}")
        return episode.uuid

    async def search_by_time_range(
        self,
        start_time: datetime,
        end_time: datetime,
        entity_type: Optional[str] = None,
        limit: int = 100
    ) -> List[Dict]:
        """
        按时间范围搜索学习事件

        Args:
            start_time: 开始时间
            end_time: 结束时间
            entity_type: 可选的实体类型过滤
            limit: 返回结果数量限制

        Returns:
            学习事件列表
        """
        results = await self.graphiti.search(
            query="",
            center_node_uuid=None,
            num_results=limit
        )
        # 过滤时间范围
        filtered = [
            r for r in results
            if hasattr(r, 'created_at') and start_time <= r.created_at <= end_time
        ]
        if entity_type:
            filtered = [r for r in filtered if r.entity_type == entity_type]
        return [self._to_dict(r) for r in filtered]

    async def get_learning_stats(
        self,
        user_id: str,
        granularity: Literal["day", "week", "month"] = "day",
        limit: int = 30
    ) -> Dict:
        """
        获取学习统计数据

        Args:
            user_id: 用户ID
            granularity: 统计粒度
            limit: 返回的时间周期数

        Returns:
            统计数据字典
        """
        # 实现统计逻辑
        pass

    def _to_dict(self, result) -> Dict:
        """将Graphiti结果转换为字典"""
        return {
            "uuid": result.uuid,
            "name": result.name,
            "created_at": result.created_at.isoformat() if hasattr(result, 'created_at') else None,
            "content": result.episode_body if hasattr(result, 'episode_body') else None
        }
```

**Graphiti数据模型**:

```python
# 学习事件 Episode
{
    "episode_id": "ep_001",
    "timestamp": "2025-12-11T10:30:00Z",
    "event_type": "LEARNING",
    "data": {
        "canvas_path": "离散数学.canvas",
        "node_id": "node_123",
        "concept": "逆否命题",
        "agent_used": "basic-decomposition",
        "duration_seconds": 300,
        "score": 85
    }
}
```

### 关键文件

- `src/agentic_rag/clients/temporal_client.py` - 新增客户端
- `src/agentic_rag/clients/__init__.py` - 导出TemporalClient
- `tests/unit/test_temporal_client.py` - 新增测试文件

### 依赖安装

```bash
pip install graphiti-core>=0.3.0
```

### 测试要求

**单元测试覆盖**:
- 测试Episode存储成功
- 测试时间范围查询
- 测试空结果处理
- 测试实体类型过滤
- 测试统计数据生成

## SDD规范引用

- **架构文档**: `docs/prd/EPIC-22-MEMORY-SYSTEM-NEO4J-GRAPHITI.md#Graphiti-时序数据模型`
- **Graphiti文档**: @graphiti Skill

## ADR关联

- ADR-0006: 选择Graphiti作为时序记忆框架 (如存在)

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-12 | 1.0 | 初始Story创建 | SM Agent (Bob) |
