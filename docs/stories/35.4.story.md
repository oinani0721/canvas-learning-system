# Story 35.4: MediaPanel后端集成

## Status: Complete

## Story

**As a** Canvas Learning System用户,
**I want** MediaPanel组件从后端API获取真实的多模态数据,
**so that** 我可以查看与当前概念节点关联的图片、PDF、音视频等学习资料。

## Acceptance Criteria

1. **AC 35.4.1**: MediaPanel从后端获取数据
   - MediaPanel组件调用ApiClient.getMediaByConceptId()方法
   - 正确解析后端返回的MediaItem[]数据
   - 数据映射符合MediaItem接口定义

2. **AC 35.4.2**: 支持概念切换刷新
   - 当用户选择不同Canvas节点时，自动刷新MediaPanel
   - 使用conceptId作为数据获取的key
   - 切换时取消进行中的请求（AbortController）

3. **AC 35.4.3**: 加载状态UI
   - 显示加载指示器（spinner/skeleton）
   - 加载过程中禁用交互按钮
   - 首次加载与刷新加载UI区分

4. **AC 35.4.4**: 错误状态UI
   - 网络错误显示友好提示
   - 提供重试按钮（对于可重试错误）
   - 错误详情可展开查看（开发模式）

5. **AC 35.4.5**: 刷新功能
   - 提供手动刷新按钮
   - 刷新时显示加载状态
   - 刷新成功/失败给予用户反馈

## Dependencies

- **Story 35.3**: ApiClient多模态集成 (提供getMediaByConceptId方法)
- **Story 35.1/35.2**: 多模态API端点 (后端支持)

## Tasks / Subtasks

- [x] **Task 1**: 集成ApiClient调用 (AC: 35.4.1)
  - [x] 1.1 在MediaPanel.ts中导入ApiClient
  - [x] 1.2 创建fetchMediaItems(conceptId: string)方法
  - [x] 1.3 将static items props替换为动态数据获取
  - [x] 1.4 实现数据映射：后端响应 -> MediaItem[]

- [x] **Task 2**: 实现概念切换监听 (AC: 35.4.2)
  - [x] 2.1 添加conceptId作为组件属性
  - [x] 2.2 使用AbortController管理请求生命周期
  - [x] 2.3 在onConceptChange回调中触发数据刷新
  - [x] 2.4 添加请求防抖（300ms）避免频繁调用

- [x] **Task 3**: 实现加载状态UI (AC: 35.4.3)
  - [x] 3.1 添加isLoading状态变量
  - [x] 3.2 创建LoadingSpinner组件或复用现有
  - [x] 3.3 加载时显示skeleton/placeholder
  - [x] 3.4 加载时禁用刷新按钮

- [x] **Task 4**: 实现错误处理UI (AC: 35.4.4)
  - [x] 4.1 添加error状态变量
  - [x] 4.2 创建ErrorDisplay组件显示错误信息
  - [x] 4.3 根据ApiError.isRetryable显示重试按钮
  - [x] 4.4 使用ApiError.getUserFriendlyMessage()显示消息

- [x] **Task 5**: 实现刷新功能 (AC: 35.4.5)
  - [x] 5.1 添加刷新按钮到MediaPanel头部
  - [x] 5.2 绑定点击事件到fetchMediaItems
  - [x] 5.3 刷新成功显示Notice提示
  - [x] 5.4 刷新失败显示错误提示

- [x] **Task 6**: 单元测试
  - [x] 6.1 测试正常数据获取流程
  - [x] 6.2 测试概念切换取消前一请求
  - [x] 6.3 测试加载状态显示
  - [x] 6.4 测试错误状态显示和重试
  - [x] 6.5 测试刷新功能

## Dev Notes

### SDD规范参考 (必填)

**API端点** (待Story 35.2定义):
```yaml
# 按概念查询媒体 (Story 35.2 AC 35.2.1)
GET /api/v1/multimodal/by-concept/{concept_id}
Response: MediaItem[]
```
[Source: docs/epics/EPIC-35-MULTIMODAL-ACTIVATION.md#L79]

**数据Schema** (MediaItem接口):
```typescript
// 前端MediaItem接口 (Epic 35定义)
interface MediaItem {
  id: string;
  type: 'image' | 'pdf' | 'audio' | 'video';
  path: string;
  title?: string;
  relevanceScore: number;
  conceptId?: string;
  metadata?: Record<string, any>;
  thumbnail?: string;
}
```
[Source: docs/epics/EPIC-35-MULTIMODAL-ACTIVATION.md#L300-L311]

**后端Schema对照** (MultimodalContent):
```json
{
  "id": "uuid",
  "media_type": "image|pdf|audio|video",
  "file_path": "string",
  "thumbnail_path": "string|null",
  "related_concept_id": "string",
  "metadata": {...}
}
```
[Source: specs/data/multimodal-content.schema.json]

**数据映射规则**:
- `media_type` -> `type` (直接映射)
- `file_path` -> `path`
- `thumbnail_path` -> `thumbnail`
- `related_concept_id` -> `conceptId`
- `relevanceScore` 默认为1.0（非搜索场景）

### ADR决策关联 (必填)

| ADR编号 | 决策标题 | 对Story的影响 |
|---------|----------|---------------|
| ADR-007 | 缓存策略-分层 | 可参考L1内存缓存模式，前端数据建议短TTL（如5分钟） |
| ADR-009 | 错误处理-重试策略 | 使用ApiError.isRetryable判断是否显示重试按钮 |

**关键约束**:
- 网络超时默认30秒 (ADR-009)
- 可重试错误: NetworkError, TimeoutError, HttpError5xx
- 错误响应需包含bug_id用于追踪
- 多模态关系存储在Neo4j（HAS_MEDIA关系，见Epic 35设计）

[Source: ADR-007, ADR-009, Epic 35]

### 现有代码参考

**MediaPanel.ts位置**: `canvas-progress-tracker/obsidian-plugin/src/components/MediaPanel.ts`
- 现有代码约800行，UI组件完整
- 当前通过props接收静态items数组
- 需要改造为从ApiClient获取数据

**ApiClient.ts位置**: `canvas-progress-tracker/obsidian-plugin/src/api/ApiClient.ts`
- 现有代码约1138行，完整的HTTP客户端
- Story 35.3将添加getMediaByConceptId方法
- 遵循现有retry/timeout模式

**types.ts位置**: `canvas-progress-tracker/obsidian-plugin/src/api/types.ts`
- 已定义ApiError类和isRetryable属性
- 已定义ErrorType和错误处理策略
- Story 35.3将添加MediaItem接口

### 实现模式参考

参考现有ReviewDashboardView.ts的数据获取模式:
```typescript
async loadData(): Promise<void> {
  this.isLoading = true;
  this.error = null;
  try {
    const data = await this.apiClient.getReviewSchedule();
    this.items = data.items;
  } catch (e) {
    if (e instanceof ApiError) {
      this.error = e;
    }
  } finally {
    this.isLoading = false;
    this.render();
  }
}
```

### Testing

**测试文件位置**: `canvas-progress-tracker/obsidian-plugin/tests/components/MediaPanel.test.ts`

**测试框架**: Jest + @testing-library

**测试标准** (from coding-standards.md):
- 单元测试覆盖所有AC场景
- Mock ApiClient返回各种状态
- 测试异步状态转换

**测试用例**:
```typescript
describe('MediaPanel', () => {
  it('should fetch media items on mount', async () => {...});
  it('should cancel request on concept change', async () => {...});
  it('should show loading state', async () => {...});
  it('should show error with retry button', async () => {...});
  it('should refresh on button click', async () => {...});
});
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-20 | 0.1 | Initial draft | Bob (SM Agent) |
| 2026-01-20 | 1.0 | Implementation complete | James (Dev Agent) |
| 2026-01-20 | 1.1 | Fixed abort controller bug (Issue: cancelled requests still calling onRefresh) | James (Dev Agent) |
| 2026-01-20 | 1.2 | Fixed refresh button disabled state not updating during loading | James (Dev Agent) |

## Dev Agent Record

### Agent Model Used
Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References
1. **Test Timeout Issue**: Initial tests failed with timeout due to `setImmediate` not available in jsdom. Fixed by using `setTimeout(resolve, 0)` and real timers.
2. **Abort Controller Bug**: Cancelled requests were still calling onRefresh because the check used global `currentAbortController` which gets replaced. Fixed by capturing local `myAbortController` reference.
3. **Button State Issue**: Refresh button disabled state was set once at creation, never updated. Fixed by adding state update in `renderItems()`.

### Completion Notes List

1. **AC 35.4.1 (Data Fetching)**:
   - Added imports for ApiClient and ApiError
   - Extended MediaPanelProps with apiClient, conceptId, onRefresh
   - Implemented fetchMediaItems() async function
   - Data mapping is handled by ApiClient (Story 35.3)

2. **AC 35.4.2 (Concept Change)**:
   - Added conceptId to PanelState
   - Implemented AbortController for request cancellation
   - Added handleConceptChange() with 300ms debounce
   - Added CONCEPT_CHANGE_DEBOUNCE_MS constant
   - Exported updateMediaPanelConcept() helper function

3. **AC 35.4.3 (Loading State)**:
   - Added isLoading to PanelState
   - Created createLoadingState() with spinner and animation
   - Added CSS keyframes for spinner animation
   - Refresh button disabled during loading

4. **AC 35.4.4 (Error State)**:
   - Added error to PanelState
   - Created createErrorState() with user-friendly message
   - Retry button shown only for retryable errors (ApiError.isRetryable)
   - Error details expandable in dev mode
   - Exported getMediaPanelError() helper function

5. **AC 35.4.5 (Refresh)**:
   - Added onRefresh parameter to createPanelHeader()
   - Added refresh button with hover effects
   - Callback called on success/failure
   - Exported refreshMediaPanel() helper function

6. **Additional**:
   - Added cleanupMediaPanel() for resource cleanup
   - Added isMediaPanelLoading() helper
   - Maintained backwards compatibility with static mode

### File List

| File | Action | Lines Changed |
|------|--------|---------------|
| `canvas-progress-tracker/obsidian-plugin/src/components/MediaPanel.ts` | Modified | +~200 lines |
| `canvas-progress-tracker/obsidian-plugin/tests/components/MediaPanel.test.ts` | Created | ~450 lines |
| `docs/stories/35.4.story.md` | Updated | Task checkboxes, Dev Record |

## QA Results

### Review Date: 2026-01-31

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**Overall Assessment: EXCELLENT (95/100)**

Story 35.4 实现了 MediaPanel 组件与后端 API 的完整集成，代码质量出色。

**优点:**
1. **清晰的架构设计**: 组件支持静态模式（向后兼容）和动态模式（API 集成），设计灵活
2. **完善的错误处理**: 使用 ApiError 类实现了细粒度的错误分类和用户友好消息
3. **请求管理**: AbortController + debouncing (300ms) 有效防止竞态条件和过度请求
4. **资源清理**: cleanupMediaPanel() 正确处理组件卸载时的资源释放
5. **测试覆盖全面**: 28 个测试用例覆盖所有 5 个 AC，全部通过
6. **良好的文档**: JSDoc 注释完整，包含 Story 追溯和使用示例

**代码亮点:**
- `myAbortController` 局部引用防止取消请求后的回调执行（Dev Record 中记录的 bug 修复）
- `renderItems()` 中动态更新刷新按钮状态（修复的按钮状态问题）
- 开发模式下的错误详情展开功能便于调试

### Refactoring Performed

无需重构 - 代码已经符合项目标准。

### Compliance Check

- Coding Standards: ✓ 遵循 TypeScript 最佳实践，接口定义清晰
- Project Structure: ✓ 组件位于正确位置 (`src/components/MediaPanel.ts`)
- Testing Strategy: ✓ 28 个单元测试，按 AC 分组，覆盖边缘情况
- All ACs Met: ✓ 全部 5 个验收标准已实现并测试通过

### Improvements Checklist

[x] AC 35.4.1: MediaPanel 从后端获取数据 - 5 个测试通过
[x] AC 35.4.2: 支持概念切换刷新 - 3 个测试通过 (含防抖和取消)
[x] AC 35.4.3: 加载状态 UI - 4 个测试通过
[x] AC 35.4.4: 错误状态 UI - 6 个测试通过 (含重试逻辑)
[x] AC 35.4.5: 刷新功能 - 5 个测试通过
[x] 清理功能测试 - 2 个额外测试通过
[x] 静态模式向后兼容 - 3 个额外测试通过

### Security Review

✓ 无安全问题发现
- 使用 ApiClient 进行 API 调用，遵循现有安全模式
- 错误详情仅在开发模式下展示 (`window.DEBUG` 或 `dev` 路径检测)
- 没有敏感数据泄露风险

### Performance Considerations

✓ 性能设计良好
- **防抖**: 300ms 延迟防止快速切换时的过度 API 调用
- **请求取消**: AbortController 确保不处理过时请求
- **懒加载**: 图片使用 `loading="lazy"` 属性
- **建议** (非阻塞): 考虑在 Story 35.3 中已实现的 5 分钟缓存 (ADR-007)

### Files Modified During Review

无文件修改 - 代码质量已达标。

### Gate Status

Gate: **PASS** → docs/qa/gates/35.4-mediapanel-backend-integration.yml

### Recommended Status

✓ Ready for Done

**测试执行结果:**
```
Test Suites: 1 passed, 1 total
Tests:       28 passed, 28 total
Time:        2.38s
```

所有验收标准已验证通过，代码质量优秀，建议状态更新为 Done。
