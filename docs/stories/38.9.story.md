# Story 38.9: ReviewService DI 统一化 — 消除双重单例

## Status

**Done** (2026-02-10)

## Story

**As a** 开发者,
**I want** ReviewService 使用统一的单例模式（与 MemoryService 对齐），消除 review.py 与 dependencies.py 的双重单例,
**so that** DI 变更只需修改一处、测试隔离更可靠、代码维护成本降低

## 来源

本 Story 基于 EPIC-34 对抗性审查报告（层级2 技术债务）中发现的架构问题：

- `review.py:_get_or_create_review_service()` 模块级单例绕过 FastAPI DI
- `dependencies.py:get_review_service()` async generator 从未被任何 endpoint 使用
- DI 变更（如 graphiti_client 注入）必须在两处同步修改

---

## Acceptance Criteria

### AC1: 在 services/review_service.py 添加 async 单例工厂

```gherkin
Given services/review_service.py
When 添加 get_review_service() 函数
Then 使用 asyncio.Lock() double-check lock 模式（与 get_memory_service 对齐）
And 单例创建包含完整依赖链：CanvasService + memory_client, BackgroundTaskManager, FSRSManager, graphiti_client
And 提供 reset_review_service_singleton() 用于测试隔离
```

### AC2: dependencies.py 委托到 services 层单例

```gherkin
Given dependencies.py 的 get_review_service()
When 重构此函数
Then 内部调用 services.review_service.get_review_service()
And 不再自行创建 ReviewService 实例
And ReviewServiceDep 类型别名保持不变
```

### AC3: review.py 删除模块级单例，使用 services 层单例

```gherkin
Given review.py 的 4 个 endpoint 调用 _get_or_create_review_service()
When 迁移完成
Then _review_service_instance 和 _get_or_create_review_service() 被删除
And 4 个 endpoint 使用 await get_review_service() 从 services 层获取
And DI 路径统一：dependencies.py 和 review.py 解析到同一个单例
```

### AC4: 测试更新 — patch 目标和 reset 机制

```gherkin
Given 5 个引用旧单例的测试文件
When 测试更新完成
Then patch 目标从 review._get_or_create_review_service → services.review_service.get_review_service
And 单例 reset 从 review._review_service_instance = None → reset_review_service_singleton()
And 所有现有测试通过
```

### AC5: DI 完整性测试

```gherkin
Given ReviewService 单例工厂
When 创建实例
Then graphiti_client 被显式处理（注入或 None + WARNING 日志）
And CanvasService 包含 memory_client（对齐 EPIC-36 P0 修复）
And FSRSManager 通过 create_fsrs_manager() 统一工厂创建
```

---

## Dev Agent Record

### 修改文件列表

| 文件 | 修改类型 | AC |
|------|---------|-----|
| `backend/app/services/review_service.py` | 添加单例工厂 | AC1, AC5 |
| `backend/app/dependencies.py` | 简化 get_review_service() | AC2 |
| `backend/app/api/v1/endpoints/review.py` | 删除旧单例 + 迁移 4 endpoints | AC3 |
| `backend/tests/integration/test_review_history_pagination.py` | 更新 patch 目标 | AC4 |
| `backend/tests/api/v1/endpoints/test_fsrs_state_api.py` | 更新 patch 目标 | AC4 |
| `backend/tests/performance/test_history_performance.py` | 更新 patch 目标 | AC4 |
| `backend/tests/integration/test_review_generate_api.py` | 更新 singleton reset | AC4 |
| `backend/tests/unit/test_story_38_3_fsrs_init_guarantee.py` | 更新 singleton 测试 | AC4 |

### 测试验证

- 运行 `pytest backend/tests/unit/test_review_history_pagination.py -v`
- 运行 `pytest backend/tests/integration/test_review_history_pagination.py -v`
- 运行 `pytest backend/tests/api/v1/endpoints/test_fsrs_state_api.py -v`
- 运行 `pytest backend/tests/unit/test_story_38_3_fsrs_init_guarantee.py -v`
