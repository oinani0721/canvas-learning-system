# Story 13.5: å³é”®èœå•å’Œå¿«æ·é”®

## Status
Pending

## Story

**As a** Canvaså­¦ä¹ ç³»ç»Ÿç”¨æˆ·,
**I want** é€šè¿‡å³é”®èœå•å’Œå¿«æ·é”®å¿«é€Ÿè®¿é—®å¸¸ç”¨å‘½ä»¤,
**so that** æé«˜å­¦ä¹ æ•ˆç‡ï¼Œå‡å°‘é‡å¤æ“ä½œï¼Œæå‡æ•´ä½“ä½¿ç”¨ä½“éªŒã€‚

## Acceptance Criteria

1. åœ¨Canvasç¼–è¾‘å™¨ä¸­å³é”®ç‚¹å‡»èŠ‚ç‚¹æ—¶ï¼Œæ˜¾ç¤ºè‡ªå®šä¹‰ä¸Šä¸‹æ–‡èœå•ï¼ŒåŒ…å«å¸¸ç”¨å‘½ä»¤ï¼ˆæ‹†è§£ã€è¯„åˆ†ã€è§£é‡Šç­‰ï¼‰
2. åœ¨æ–‡ä»¶ç®¡ç†å™¨ä¸­å³é”®ç‚¹å‡».canvasæ–‡ä»¶æ—¶ï¼Œæ˜¾ç¤ºCanvasç›¸å…³æ“ä½œèœå•
3. å®ç°SCP-003è¦æ±‚çš„"ä¿æŠ¤æ­¤å¤‡ä»½ ğŸ”’"å³é”®èœå•é€‰é¡¹ï¼Œç”¨äºæ ‡è®°é‡è¦å¤‡ä»½æ–‡ä»¶
4. æ”¯æŒç”¨æˆ·åœ¨æ’ä»¶è®¾ç½®ä¸­è‡ªå®šä¹‰å¿«æ·é”®ç»‘å®š
5. æ‰€æœ‰å‘½ä»¤å‡æ”¯æŒé€šè¿‡å¿«æ·é”®è§¦å‘ï¼Œæä¾›é»˜è®¤å¿«æ·é”®å»ºè®®ï¼ˆä½†ä¸å¼ºåˆ¶è®¾ç½®ï¼‰
6. å¿«æ·é”®ä¸ä¸Šä¸‹æ–‡èœå•å‘½ä»¤ä¿æŒä¸€è‡´æ€§
7. æä¾›å®Œæ•´çš„å¿«æ·é”®æ–‡æ¡£å’Œç”¨æˆ·æŒ‡å—

## Tasks / Subtasks

- [ ] Task 1: å®ç°Editorä¸Šä¸‹æ–‡èœå• (AC: 1)
  - [ ] æ³¨å†Œeditor-menuäº‹ä»¶ç›‘å¬å™¨
  - [ ] æ£€æµ‹å³é”®ç‚¹å‡»çš„CanvasèŠ‚ç‚¹ç±»å‹ï¼ˆæ–‡æœ¬/æ–‡ä»¶/é“¾æ¥/ç»„ï¼‰
  - [ ] æ ¹æ®èŠ‚ç‚¹ç±»å‹åŠ¨æ€ç”Ÿæˆèœå•é¡¹ï¼ˆæ‹†è§£ã€è¯„åˆ†ã€è§£é‡Šç­‰ï¼‰
  - [ ] å®ç°èœå•é¡¹ç‚¹å‡»å¤„ç†ï¼Œè°ƒç”¨å¯¹åº”çš„å‘½ä»¤å¤„ç†å™¨
  - [ ] ä¸ºèœå•é¡¹æ·»åŠ å›¾æ ‡å’Œæè¿°æ–‡æœ¬

- [ ] Task 2: å®ç°æ–‡ä»¶ç®¡ç†å™¨ä¸Šä¸‹æ–‡èœå• (AC: 2)
  - [ ] æ³¨å†Œfile-menuäº‹ä»¶ç›‘å¬å™¨
  - [ ] æ£€æµ‹å³é”®ç‚¹å‡»çš„æ–‡ä»¶æ˜¯å¦ä¸º.canvasæ–‡ä»¶
  - [ ] æ·»åŠ Canvasä¸“å±èœå•é¡¹ï¼ˆæ‰“å¼€å¤ä¹ ä»ªè¡¨æ¿ã€æ‰¹é‡æ“ä½œç­‰ï¼‰
  - [ ] å®ç°èœå•é¡¹ä¸åç«¯APIçš„é›†æˆ
  - [ ] å¤„ç†å¤šæ–‡ä»¶é€‰æ‹©æƒ…å†µï¼ˆfiles-menuäº‹ä»¶ï¼‰

- [ ] Task 3: å®ç°SCP-003å¤‡ä»½ä¿æŠ¤åŠŸèƒ½ (AC: 3)
  - [ ] åœ¨.canvas_backups/ç›®å½•çš„æ–‡ä»¶ä¸Šä¸‹æ–‡èœå•ä¸­æ·»åŠ "ä¿æŠ¤æ­¤å¤‡ä»½ ğŸ”’"é€‰é¡¹
  - [ ] åˆ›å»ºå¤‡ä»½å…ƒæ•°æ®ç®¡ç†ç³»ç»Ÿï¼ˆè®°å½•ä¿æŠ¤çŠ¶æ€ã€åˆ›å»ºæ—¶é—´ã€å¤‡æ³¨ç­‰ï¼‰
  - [ ] å®ç°å¤‡ä»½æ–‡ä»¶çš„é”å®šæ ‡è®°ï¼ˆæ·»åŠ .protectedåç¼€æˆ–ä½¿ç”¨å…ƒæ•°æ®æ–‡ä»¶ï¼‰
  - [ ] åœ¨æ–‡ä»¶åˆ—è¡¨ä¸­æ˜¾ç¤ºä¿æŠ¤çŠ¶æ€ï¼ˆå›¾æ ‡æˆ–é¢œè‰²æ ‡è¯†ï¼‰
  - [ ] å®ç°"å–æ¶ˆä¿æŠ¤"åŠŸèƒ½
  - [ ] ç¡®ä¿æ¸…ç†æ“ä½œä¸ä¼šåˆ é™¤å—ä¿æŠ¤çš„å¤‡ä»½æ–‡ä»¶

- [ ] Task 4: å®ç°å‘½ä»¤æ³¨å†Œä¸å¿«æ·é”®ç»‘å®š (AC: 4, 5, 6)
  - [ ] ä½¿ç”¨addCommandæ³¨å†Œæ‰€æœ‰æ ¸å¿ƒå‘½ä»¤
  - [ ] ä¸ºæ¯ä¸ªå‘½ä»¤å®šä¹‰å”¯ä¸€çš„å‘½ä»¤IDï¼ˆä½¿ç”¨ç»Ÿä¸€å‘½åè§„èŒƒï¼‰
  - [ ] è®¾ç½®å‘½ä»¤çš„åç§°ã€å›¾æ ‡å’Œå›è°ƒå‡½æ•°
  - [ ] ä¸ºå¸¸ç”¨å‘½ä»¤æä¾›å»ºè®®çš„é»˜è®¤å¿«æ·é”®ï¼ˆéµå¾ªObsidianæœ€ä½³å®è·µï¼šä¸å¼ºåˆ¶è®¾ç½®ï¼‰
  - [ ] å®ç°checkCallbackéªŒè¯å‘½ä»¤æ˜¯å¦å¯ç”¨ï¼ˆä¾‹å¦‚ï¼šæ˜¯å¦åœ¨Canvasè§†å›¾ä¸­ï¼‰
  - [ ] ç¡®ä¿å¿«æ·é”®ä¸ä¸Šä¸‹æ–‡èœå•çš„å‘½ä»¤IDä¸€è‡´

- [ ] Task 5: å¿«æ·é”®è®¾ç½®ç•Œé¢ (AC: 4)
  - [ ] åœ¨æ’ä»¶è®¾ç½®é¡µé¢æ·»åŠ "å¿«æ·é”®"éƒ¨åˆ†
  - [ ] æ˜¾ç¤ºæ‰€æœ‰å¯ç”¨å‘½ä»¤åŠå…¶å½“å‰å¿«æ·é”®ç»‘å®š
  - [ ] æä¾›å¿«æ·é”®å†²çªæ£€æµ‹å’Œè­¦å‘Š
  - [ ] æ”¯æŒå¿«æ·é”®çš„é‡ç½®ä¸ºé»˜è®¤å€¼
  - [ ] æ·»åŠ å¿«æ·é”®é¢„è®¾æ–¹æ¡ˆï¼ˆåˆå­¦è€…/é«˜çº§ç”¨æˆ·/è‡ªå®šä¹‰ï¼‰

- [ ] Task 6: å¿«æ·é”®æ–‡æ¡£å’Œå¸®åŠ©ç³»ç»Ÿ (AC: 7)
  - [ ] åˆ›å»ºå¿«æ·é”®å‚è€ƒæ–‡æ¡£ï¼ˆMarkdownæ ¼å¼ï¼‰
  - [ ] åœ¨æ’ä»¶è®¾ç½®ä¸­æ·»åŠ "æŸ¥çœ‹å¿«æ·é”®å¸®åŠ©"æŒ‰é’®
  - [ ] å®ç°å¿«æ·é”®é€ŸæŸ¥å‘½ä»¤ï¼ˆæ˜¾ç¤ºå¿«æ·é”®å¤‡å¿˜å•ï¼‰
  - [ ] æ·»åŠ ä¸Šä¸‹æ–‡å¸®åŠ©æç¤ºï¼ˆhoveræ—¶æ˜¾ç¤ºå¿«æ·é”®ï¼‰
  - [ ] åˆ›å»ºå¿«æ·é”®å†²çªè§£å†³æŒ‡å—

- [ ] Task 7: é›†æˆæµ‹è¯•ä¸ç”¨æˆ·ä½“éªŒä¼˜åŒ– (AC: 1-7)
  - [ ] æµ‹è¯•æ‰€æœ‰ä¸Šä¸‹æ–‡èœå•åœ¨ä¸åŒåœºæ™¯ä¸‹çš„æ˜¾ç¤º
  - [ ] éªŒè¯å¿«æ·é”®åœ¨ä¸åŒæ“ä½œç³»ç»Ÿä¸Šçš„å…¼å®¹æ€§ï¼ˆModé”®é€‚é…ï¼‰
  - [ ] æµ‹è¯•å¿«æ·é”®å†²çªå¤„ç†
  - [ ] ä¼˜åŒ–èœå•æ˜¾ç¤ºæ€§èƒ½ï¼ˆå¤§é‡èŠ‚ç‚¹åœºæ™¯ï¼‰
  - [ ] æ”¶é›†ç”¨æˆ·åé¦ˆå¹¶è¿­ä»£ä¼˜åŒ–

## Dev Notes

### æ¶æ„ä¸Šä¸‹æ–‡

**ä¸Šä¸‹æ–‡èœå•ç³»ç»Ÿ** [Source: Obsidian Plugin Developer Docs - Context Menus]

Obsidianæä¾›äº†ä¸¤ç§ä¸»è¦çš„ä¸Šä¸‹æ–‡èœå•æ‰©å±•æœºåˆ¶ï¼š

```
ä¸Šä¸‹æ–‡èœå•æ¶æ„:
â”œâ”€â”€ editor-menu (ç¼–è¾‘å™¨å³é”®èœå•)
â”‚   â”œâ”€â”€ è§¦å‘æ¡ä»¶: åœ¨Canvasç¼–è¾‘å™¨ä¸­å³é”®ç‚¹å‡»
â”‚   â”œâ”€â”€ å›è°ƒå‚æ•°: (menu: Menu, editor: Editor, view: MarkdownView)
â”‚   â””â”€â”€ ç”¨é€”: èŠ‚ç‚¹çº§æ“ä½œï¼ˆæ‹†è§£ã€è¯„åˆ†ã€è§£é‡Šï¼‰
â”œâ”€â”€ file-menu (æ–‡ä»¶å³é”®èœå•)
â”‚   â”œâ”€â”€ è§¦å‘æ¡ä»¶: åœ¨æ–‡ä»¶ç®¡ç†å™¨ä¸­å³é”®ç‚¹å‡»å•ä¸ªæ–‡ä»¶
â”‚   â”œâ”€â”€ å›è°ƒå‚æ•°: (menu: Menu, file: TAbstractFile, source: string)
â”‚   â””â”€â”€ ç”¨é€”: æ–‡ä»¶çº§æ“ä½œï¼ˆæ‰“å¼€å¤ä¹ ä»ªè¡¨æ¿ã€å¤‡ä»½ä¿æŠ¤ï¼‰
â””â”€â”€ files-menu (å¤šæ–‡ä»¶å³é”®èœå•)
    â”œâ”€â”€ è§¦å‘æ¡ä»¶: åœ¨æ–‡ä»¶ç®¡ç†å™¨ä¸­å³é”®ç‚¹å‡»å¤šä¸ªæ–‡ä»¶
    â”œâ”€â”€ å›è°ƒå‚æ•°: (menu: Menu, files: TAbstractFile[], source: string)
    â””â”€â”€ ç”¨é€”: æ‰¹é‡æ“ä½œ
```

### æŠ€æœ¯éªŒè¯è¦æ±‚

**âš ï¸ å¼ºåˆ¶æ–‡æ¡£æ¥æº**: `@obsidian-canvas` Skill

æœ¬Storyå®ç°çš„æ‰€æœ‰Obsidian APIè°ƒç”¨å¿…é¡»åœ¨ä»£ç ä¸­æ·»åŠ Skillå¼•ç”¨æ³¨é‡Šï¼Œæ ¼å¼å¦‚ä¸‹ï¼š
```typescript
// âœ… Verified from Obsidian Canvas Skill (README.md - Registering Events)
this.registerEvent(
  this.app.workspace.on('editor-menu', (menu, editor, view) => {
    // èœå•é¡¹æ·»åŠ é€»è¾‘
  })
);
```

### æ ¸å¿ƒAPIå‚è€ƒ

**ä¸Šä¸‹æ–‡èœå•æ³¨å†Œ** [Source: @obsidian-canvas Skill - README.md, Context Menu Docs]

```typescript
// âœ… Verified from Obsidian Canvas Skill (Context Menus - Editor Menu Integration)
// æ³¨å†Œç¼–è¾‘å™¨ä¸Šä¸‹æ–‡èœå•
this.registerEvent(
  this.app.workspace.on('editor-menu', (menu, editor, view) => {
    // æ£€æŸ¥å½“å‰è§†å›¾æ˜¯å¦ä¸ºCanvas
    if (view.file?.extension !== 'canvas') return;

    // æ·»åŠ èœå•é¡¹
    menu.addItem((item) => {
      item
        .setTitle('æ‹†è§£æ­¤èŠ‚ç‚¹ ğŸ”')
        .setIcon('git-branch')
        .onClick(async () => {
          // è°ƒç”¨æ‹†è§£å‘½ä»¤
          await this.commandWrapper.executeDecomposition(nodeId);
        });
    });

    menu.addItem((item) => {
      item
        .setTitle('è¯„åˆ† â­')
        .setIcon('star')
        .onClick(async () => {
          // è°ƒç”¨è¯„åˆ†å‘½ä»¤
          await this.commandWrapper.executeScoring(nodeId);
        });
    });
  })
);

// âœ… Verified from Obsidian Canvas Skill (Context Menus - File Menu Integration)
// æ³¨å†Œæ–‡ä»¶ä¸Šä¸‹æ–‡èœå•
this.registerEvent(
  this.app.workspace.on('file-menu', (menu, file, source) => {
    // æ£€æŸ¥æ–‡ä»¶ç±»å‹
    if (!(file instanceof TFile) || file.extension !== 'canvas') return;

    // æ·»åŠ Canvasä¸“å±èœå•é¡¹
    menu.addItem((item) => {
      item
        .setTitle('æ‰“å¼€å¤ä¹ ä»ªè¡¨æ¿ ğŸ“Š')
        .setIcon('bar-chart')
        .onClick(async () => {
          await this.openReviewDashboard(file);
        });
    });

    // SCP-003: å¤‡ä»½ä¿æŠ¤èœå•é¡¹
    if (file.path.includes('.canvas_backups/')) {
      const isProtected = await this.backupManager.isProtected(file.path);

      menu.addItem((item) => {
        item
          .setTitle(isProtected ? 'å–æ¶ˆä¿æŠ¤ ğŸ”“' : 'ä¿æŠ¤æ­¤å¤‡ä»½ ğŸ”’')
          .setIcon(isProtected ? 'unlock' : 'lock')
          .onClick(async () => {
            await this.backupManager.toggleProtection(file.path);
          });
      });
    }
  })
);
```

**å‘½ä»¤æ³¨å†Œä¸å¿«æ·é”®** [Source: @obsidian-canvas Skill - README.md; GitHub obsidian-api]

```typescript
// âœ… Verified from Obsidian Canvas Skill (README.md - App Architecture)
// å‘½ä»¤æ³¨å†Œï¼ˆæ”¯æŒå¿«æ·é”®ï¼‰
this.addCommand({
  id: 'canvas-decompose-node',
  name: 'æ‹†è§£å½“å‰èŠ‚ç‚¹',
  icon: 'git-branch',
  editorCheckCallback: (checking: boolean, editor: Editor, view: MarkdownView) => {
    // æ£€æŸ¥å½“å‰æ˜¯å¦åœ¨Canvasè§†å›¾ä¸­
    const isCanvas = view.file?.extension === 'canvas';

    if (checking) {
      return isCanvas; // è¿”å›å‘½ä»¤æ˜¯å¦å¯ç”¨
    }

    // æ‰§è¡Œå‘½ä»¤
    if (isCanvas) {
      this.executeDecomposition();
    }
  },
  // âš ï¸ Obsidianæœ€ä½³å®è·µ: ä¸è®¾ç½®é»˜è®¤å¿«æ·é”®ï¼Œé¿å…å†²çª
  // hotkeys: [] // ç”¨æˆ·å¯åœ¨è®¾ç½®ä¸­è‡ªå®šä¹‰
});

// å¸¦æœ‰å»ºè®®å¿«æ·é”®çš„å‘½ä»¤ï¼ˆåœ¨æ–‡æ¡£ä¸­è¯´æ˜ï¼Œä½†ä¸å¼ºåˆ¶ï¼‰
this.addCommand({
  id: 'canvas-score-nodes',
  name: 'è¯„åˆ†æ‰€æœ‰é»„è‰²èŠ‚ç‚¹',
  icon: 'star',
  // âš ï¸ ä¸æ¨èè®¾ç½®é»˜è®¤å¿«æ·é”®
  // å»ºè®®åœ¨æ–‡æ¡£ä¸­è¯´æ˜: æ¨èå¿«æ·é”® Ctrl+Shift+S (ç”¨æˆ·è‡ªè¡Œè®¾ç½®)
  callback: async () => {
    await this.scoreAllYellowNodes();
  }
});
```

**Modifieré”®è·¨å¹³å°é€‚é…** [Source: GitHub obsidian-api/obsidian.d.ts]

```typescript
// âœ… Verified from Obsidian API (obsidian.d.ts - Modifier type)
// Modé”®åœ¨macOSä¸Šæ˜ å°„ä¸ºMeta(Cmd)ï¼Œå…¶ä»–å¹³å°æ˜ å°„ä¸ºCtrl
// å¯ç”¨çš„Modifier: 'Mod' | 'Ctrl' | 'Meta' | 'Shift' | 'Alt'

interface Hotkey {
  modifiers: Modifier[];
  key: string;
}

// ç¤ºä¾‹å¿«æ·é”®å®šä¹‰ï¼ˆç”¨æˆ·è‡ªå®šä¹‰ï¼‰
const suggestedHotkeys = {
  'canvas-decompose-node': { modifiers: ['Mod', 'Shift'], key: 'D' },
  'canvas-score-nodes': { modifiers: ['Mod', 'Shift'], key: 'S' },
  'canvas-oral-explain': { modifiers: ['Mod', 'Shift'], key: 'E' }
};
```

### SCP-003å¤‡ä»½ä¿æŠ¤å®ç°

**å¤‡ä»½å…ƒæ•°æ®ç®¡ç†** [Source: PRD Epic 13 - Story 13.5]

```typescript
interface BackupMetadata {
  filePath: string;
  protected: boolean;
  protectedAt?: number;
  protectedBy?: string;
  note?: string;
}

class BackupProtectionManager {
  private metadataPath = '.canvas_backups/.metadata.json';
  private metadata: Map<string, BackupMetadata>;

  // âœ… Verified from Obsidian Canvas Skill (README.md - Vault API)
  async loadMetadata(): Promise<void> {
    try {
      const file = this.app.vault.getAbstractFileByPath(this.metadataPath);
      if (file instanceof TFile) {
        const content = await this.app.vault.read(file);
        const data = JSON.parse(content);
        this.metadata = new Map(Object.entries(data));
      }
    } catch (error) {
      console.log('No existing metadata, creating new');
      this.metadata = new Map();
    }
  }

  async toggleProtection(filePath: string): Promise<void> {
    const current = this.metadata.get(filePath);

    if (current?.protected) {
      // å–æ¶ˆä¿æŠ¤
      this.metadata.delete(filePath);
      new Notice(`å¤‡ä»½å·²å–æ¶ˆä¿æŠ¤: ${filePath}`);
    } else {
      // æ·»åŠ ä¿æŠ¤
      this.metadata.set(filePath, {
        filePath,
        protected: true,
        protectedAt: Date.now(),
        protectedBy: 'user',
      });
      new Notice(`å¤‡ä»½å·²ä¿æŠ¤: ${filePath} ğŸ”’`);
    }

    await this.saveMetadata();
  }

  async isProtected(filePath: string): Promise<boolean> {
    return this.metadata.get(filePath)?.protected || false;
  }

  async saveMetadata(): Promise<void> {
    const data = Object.fromEntries(this.metadata);
    const content = JSON.stringify(data, null, 2);

    const file = this.app.vault.getAbstractFileByPath(this.metadataPath);
    if (file instanceof TFile) {
      await this.app.vault.modify(file, content);
    } else {
      await this.app.vault.create(this.metadataPath, content);
    }
  }

  // æ¸…ç†æ“ä½œæ£€æŸ¥
  async canDelete(filePath: string): Promise<boolean> {
    if (await this.isProtected(filePath)) {
      new Notice('âš ï¸ æ­¤å¤‡ä»½å·²å—ä¿æŠ¤ï¼Œæ— æ³•åˆ é™¤', 5000);
      return false;
    }
    return true;
  }
}
```

### å¿«æ·é”®æœ€ä½³å®è·µ

**Obsidianå®˜æ–¹å»ºè®®** [Source: Web Search - Obsidian Hotkey Best Practices]

1. **ä¸è®¾ç½®é»˜è®¤å¿«æ·é”®**: é¿å…ä¸ç”¨æˆ·è‡ªå®šä¹‰å¿«æ·é”®æˆ–å…¶ä»–æ’ä»¶å†²çª
2. **åœ¨æ–‡æ¡£ä¸­æä¾›å»ºè®®**: åœ¨READMEå’Œè®¾ç½®ç•Œé¢ä¸­è¯´æ˜æ¨èçš„å¿«æ·é”®ç»„åˆ
3. **ä½¿ç”¨Modé”®**: ç¡®ä¿macOSå’ŒWindows/Linuxçš„å…¼å®¹æ€§
4. **æä¾›å†²çªæ£€æµ‹**: åœ¨è®¾ç½®ç•Œé¢ä¸­æ˜¾ç¤ºæ½œåœ¨å†²çª
5. **æ”¯æŒé‡å¤è§¦å‘**: å¯¹äºéœ€è¦é‡å¤æ‰§è¡Œçš„å‘½ä»¤è®¾ç½®`repeatable: true`

**æ¨èå¿«æ·é”®æ–¹æ¡ˆ** (ä»…ä½œä¸ºæ–‡æ¡£å»ºè®®ï¼Œä¸å¼ºåˆ¶)

```typescript
// åœ¨æ’ä»¶READMEå’Œè®¾ç½®ç•Œé¢ä¸­å±•ç¤º
const RECOMMENDED_HOTKEYS = {
  'canvas-decompose-node': 'Mod+Shift+D',
  'canvas-score-nodes': 'Mod+Shift+S',
  'canvas-oral-explain': 'Mod+Shift+E',
  'canvas-generate-verification': 'Mod+Shift+V',
  'canvas-open-dashboard': 'Mod+Shift+R',
};
```

### ç”¨æˆ·ä½“éªŒè€ƒè™‘

**ä¸Šä¸‹æ–‡æ„ŸçŸ¥èœå•** [Source: Obsidian Canvas Skill - Context Menu Docs]

```typescript
// æ ¹æ®èŠ‚ç‚¹çŠ¶æ€åŠ¨æ€ç”Ÿæˆèœå•é¡¹
this.registerEvent(
  this.app.workspace.on('editor-menu', (menu, editor, view) => {
    if (view.file?.extension !== 'canvas') return;

    // è·å–å½“å‰èŠ‚ç‚¹çŠ¶æ€
    const nodeColor = this.getCurrentNodeColor(editor);

    // æ ¹æ®é¢œè‰²æ˜¾ç¤ºä¸åŒèœå•é¡¹
    if (nodeColor === '1' || nodeColor === 'red') {
      // çº¢è‰²èŠ‚ç‚¹: æä¾›æ‹†è§£å’Œè§£é‡Š
      menu.addItem((item) => {
        item.setTitle('æ‹†è§£æ­¤æ¦‚å¿µ ğŸ”').onClick(() => {/* ... */});
      });
      menu.addItem((item) => {
        item.setTitle('å£è¯­åŒ–è§£é‡Š ğŸ’¬').onClick(() => {/* ... */});
      });
    } else if (nodeColor === '3' || nodeColor === 'yellow') {
      // é»„è‰²èŠ‚ç‚¹: æä¾›è¯„åˆ†å’Œå¯¹æ¯”
      menu.addItem((item) => {
        item.setTitle('è¯„åˆ†æ­¤èŠ‚ç‚¹ â­').onClick(() => {/* ... */});
      });
      menu.addItem((item) => {
        item.setTitle('ç”Ÿæˆå¯¹æ¯”è¡¨ ğŸ“Š').onClick(() => {/* ... */});
      });
    } else if (nodeColor === '4' || nodeColor === 'green') {
      // ç»¿è‰²èŠ‚ç‚¹: æä¾›å¤ä¹ å’Œå¯¼å‡º
      menu.addItem((item) => {
        item.setTitle('æ·»åŠ åˆ°å¤ä¹ è®¡åˆ’ ğŸ“…').onClick(() => {/* ... */});
      });
    }

    // é€šç”¨èœå•é¡¹ï¼ˆæ‰€æœ‰èŠ‚ç‚¹ï¼‰
    menu.addSeparator();
    menu.addItem((item) => {
      item.setTitle('æŸ¥çœ‹èŠ‚ç‚¹å†å² ğŸ•').onClick(() => {/* ... */});
    });
  })
);
```

### æ€§èƒ½ä¼˜åŒ–

**èœå•ç”Ÿæˆæ€§èƒ½** [Source: Obsidian Plugin Best Practices]

```typescript
// ç¼“å­˜å¸¸ç”¨æ•°æ®ï¼Œé¿å…é‡å¤è®¡ç®—
class ContextMenuManager {
  private nodeCache = new Map<string, any>();

  // âœ… Verified from Obsidian Canvas Skill (README.md - registerEvent)
  registerMenus(): void {
    // ä½¿ç”¨registerEventç¡®ä¿è‡ªåŠ¨æ¸…ç†
    this.registerEvent(
      this.app.workspace.on('editor-menu', (menu, editor, view) => {
        // å¿«é€Ÿæ£€æŸ¥ï¼Œé¿å…ä¸å¿…è¦çš„å¤„ç†
        if (view.file?.extension !== 'canvas') return;

        // å¼‚æ­¥è·å–èŠ‚ç‚¹æ•°æ®ï¼ˆä¸é˜»å¡èœå•æ˜¾ç¤ºï¼‰
        this.addMenuItems(menu, editor, view);
      })
    );
  }

  private addMenuItems(menu: Menu, editor: Editor, view: MarkdownView): void {
    // æ·»åŠ èœå•é¡¹ï¼ˆåŒæ­¥æ“ä½œï¼Œå¿«é€Ÿå®Œæˆï¼‰
    menu.addItem((item) => {
      item
        .setTitle('æ‹†è§£èŠ‚ç‚¹')
        .setIcon('git-branch')
        .onClick(async () => {
          // ç‚¹å‡»åå†æ‰§è¡Œè€—æ—¶æ“ä½œ
          await this.performDecomposition();
        });
    });
  }
}
```

### ç¼–ç è§„èŒƒ

**TypeScriptç±»å‹å®‰å…¨** [Source: canvas-progress-tracker/docs/obsidian-plugin-architecture.md]

```typescript
// ä¸¥æ ¼çš„ç±»å‹å®šä¹‰
interface MenuItemConfig {
  title: string;
  icon: IconName;
  condition?: () => boolean;
  action: () => Promise<void>;
}

class CanvasMenuRegistry {
  private menuItems: Map<string, MenuItemConfig> = new Map();

  registerMenuItem(id: string, config: MenuItemConfig): void {
    this.menuItems.set(id, config);
  }

  // âœ… Verified from Obsidian Canvas Skill (Context Menus - menu.addItem API)
  buildMenu(menu: Menu, context: 'editor' | 'file'): void {
    this.menuItems.forEach((config, id) => {
      // æ£€æŸ¥æ¡ä»¶
      if (config.condition && !config.condition()) return;

      menu.addItem((item) => {
        item
          .setTitle(config.title)
          .setIcon(config.icon)
          .onClick(async () => {
            try {
              await config.action();
            } catch (error) {
              console.error(`Menu action failed: ${id}`, error);
              new Notice(`æ“ä½œå¤±è´¥: ${error.message}`);
            }
          });
      });
    });
  }
}
```

### æµ‹è¯•è¦æ±‚

**è·¨å¹³å°æµ‹è¯•** [Source: PRD Epic 13 - å…¼å®¹æ€§éœ€æ±‚]

1. **æ“ä½œç³»ç»Ÿ**: Windows, macOS, Linux
2. **Modé”®æ˜ å°„**: éªŒè¯Modåœ¨ä¸åŒå¹³å°çš„è¡Œä¸º
3. **å¿«æ·é”®å†²çª**: æµ‹è¯•ä¸Obsidianæ ¸å¿ƒå¿«æ·é”®çš„å†²çª
4. **æ€§èƒ½**: æµ‹è¯•å¤§é‡èŠ‚ç‚¹æ—¶çš„èœå•å“åº”é€Ÿåº¦

**æµ‹è¯•åœºæ™¯**:
```typescript
// æµ‹è¯•ç”¨ä¾‹ç¤ºä¾‹
describe('Context Menu', () => {
  test('ç¼–è¾‘å™¨å³é”®èœå•åœ¨Canvasè§†å›¾ä¸­æ˜¾ç¤º', async () => {
    // æ‰“å¼€Canvasæ–‡ä»¶
    // è§¦å‘editor-menuäº‹ä»¶
    // éªŒè¯èœå•é¡¹å­˜åœ¨
  });

  test('SCP-003å¤‡ä»½ä¿æŠ¤èœå•é¡¹æ­£ç¡®æ˜¾ç¤º', async () => {
    // æ‰“å¼€.canvas_backups/ç›®å½•ä¸­çš„æ–‡ä»¶
    // è§¦å‘file-menuäº‹ä»¶
    // éªŒè¯"ä¿æŠ¤æ­¤å¤‡ä»½"èœå•é¡¹å­˜åœ¨
  });

  test('å¿«æ·é”®åœ¨macOSå’ŒWindowsä¸Šæ­£ç¡®å·¥ä½œ', async () => {
    // æ¨¡æ‹ŸMod+Shift+D
    // éªŒè¯å‘½ä»¤æ‰§è¡Œ
  });
});
```

### é›†æˆè€ƒè™‘

**ä¸Story 13.4çš„é›†æˆ** [Source: PRD Epic 13]

Story 13.4å®ç°äº†æ ¸å¿ƒå‘½ä»¤çš„ä¸šåŠ¡é€»è¾‘ï¼Œæœ¬Storyæä¾›ç”¨æˆ·äº¤äº’å…¥å£ï¼š

```
é›†æˆæ¶æ„:
Story 13.5 (UIå±‚)          Story 13.4 (é€»è¾‘å±‚)
â”œâ”€â”€ ä¸Šä¸‹æ–‡èœå•         â†’   â”œâ”€â”€ CommandWrapper
â”‚   â””â”€â”€ èœå•é¡¹ç‚¹å‡»           â””â”€â”€ è°ƒç”¨åç«¯API
â”œâ”€â”€ å¿«æ·é”®ç»‘å®š         â†’   â””â”€â”€ å‘½ä»¤æ‰§è¡Œå™¨
â”‚   â””â”€â”€ å‘½ä»¤è§¦å‘
â””â”€â”€ å¤‡ä»½ä¿æŠ¤UI         â†’   â”œâ”€â”€ BackupManager
    â””â”€â”€ å…ƒæ•°æ®ç®¡ç†             â””â”€â”€ æ–‡ä»¶ç³»ç»Ÿæ“ä½œ
```

**è°ƒç”¨ç¤ºä¾‹**:
```typescript
// ä¸Šä¸‹æ–‡èœå•è°ƒç”¨Story 13.4çš„CommandWrapper
menu.addItem((item) => {
  item
    .setTitle('æ‹†è§£èŠ‚ç‚¹')
    .onClick(async () => {
      // è°ƒç”¨Story 13.4å®ç°çš„å‘½ä»¤åŒ…è£…å™¨
      await this.plugin.commandWrapper.executeDecomposition({
        canvasPath: view.file.path,
        nodeId: currentNodeId,
      });
    });
});
```

### æ–‡æ¡£è¦æ±‚

**ç”¨æˆ·æ–‡æ¡£** (docs/user-guide/hotkeys.md)

åº”åŒ…å«ï¼š
1. æ‰€æœ‰å¯ç”¨å‘½ä»¤åˆ—è¡¨
2. æ¨èçš„å¿«æ·é”®è®¾ç½®
3. å¦‚ä½•è‡ªå®šä¹‰å¿«æ·é”®
4. å¦‚ä½•è§£å†³å¿«æ·é”®å†²çª
5. ä¸Šä¸‹æ–‡èœå•ä½¿ç”¨è¯´æ˜
6. SCP-003å¤‡ä»½ä¿æŠ¤åŠŸèƒ½è¯´æ˜

**å¼€å‘è€…æ–‡æ¡£** (docs/dev/context-menu-api.md)

åº”åŒ…å«ï¼š
1. å¦‚ä½•æ³¨å†Œæ–°çš„ä¸Šä¸‹æ–‡èœå•é¡¹
2. å¦‚ä½•æ·»åŠ æ–°å‘½ä»¤
3. èœå•é¡¹å‘½åè§„èŒƒ
4. å›¾æ ‡é€‰æ‹©æŒ‡å—

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-27 | 1.0 | åˆå§‹Storyåˆ›å»ºï¼ŒåŸºäºEpic 13å’ŒPRD v1.1.8 | SM Agent (Bob) |

## Dev Agent Record

### Agent Model Used
å¾…å¼€å‘

### Debug Log References
å¾…å¼€å‘

### Completion Notes
å¾…å¼€å‘

### File List
**è®¡åˆ’åˆ›å»ºçš„æ–‡ä»¶ï¼š**
- `canvas-progress-tracker/obsidian-plugin/src/managers/ContextMenuManager.ts` - ä¸Šä¸‹æ–‡èœå•ç®¡ç†å™¨
- `canvas-progress-tracker/obsidian-plugin/src/managers/HotkeyManager.ts` - å¿«æ·é”®ç®¡ç†å™¨
- `canvas-progress-tracker/obsidian-plugin/src/managers/BackupProtectionManager.ts` - å¤‡ä»½ä¿æŠ¤ç®¡ç†å™¨
- `canvas-progress-tracker/obsidian-plugin/src/types/menu.ts` - èœå•ç›¸å…³ç±»å‹å®šä¹‰
- `canvas-progress-tracker/obsidian-plugin/src/utils/hotkey-helper.ts` - å¿«æ·é”®å·¥å…·å‡½æ•°
- `canvas-progress-tracker/obsidian-plugin/.canvas_backups/.metadata.json` - å¤‡ä»½å…ƒæ•°æ®ï¼ˆè¿è¡Œæ—¶ç”Ÿæˆï¼‰
- `docs/user-guide/hotkeys.md` - å¿«æ·é”®ç”¨æˆ·æŒ‡å—
- `docs/dev/context-menu-api.md` - ä¸Šä¸‹æ–‡èœå•å¼€å‘æ–‡æ¡£

**ä¿®æ”¹çš„æ–‡ä»¶ï¼š**
- `canvas-progress-tracker/obsidian-plugin/main.ts` - æ³¨å†Œä¸Šä¸‹æ–‡èœå•å’Œå¿«æ·é”®
- `canvas-progress-tracker/obsidian-plugin/src/types/settings.ts` - æ·»åŠ å¿«æ·é”®é…ç½®
- `canvas-progress-tracker/obsidian-plugin/src/components/PluginSettingsTab.tsx` - æ·»åŠ å¿«æ·é”®è®¾ç½®ç•Œé¢

## QA Results

### Review Date: å¾…å¼€å‘

### Reviewed By: å¾…å¼€å‘

### Code Quality Assessment
å¾…å¼€å‘

### Compliance Check
å¾…å¼€å‘

### Security Review
å¾…å¼€å‘

### Performance Considerations
å¾…å¼€å‘

### Architecture & Design Review
å¾…å¼€å‘

### Test Quality Review
å¾…å¼€å‘

### Final Status
å¾…å¼€å‘

---

## æŠ€æœ¯éªŒè¯æ‘˜è¦

**SkilléªŒè¯**: âœ… @obsidian-canvas

**ä¸»è¦APIéªŒè¯**:
1. âœ… `this.registerEvent()` - äº‹ä»¶æ³¨å†Œ (README.md)
2. âœ… `this.app.workspace.on('editor-menu', ...)` - ç¼–è¾‘å™¨èœå• (Context Menu Docs)
3. âœ… `this.app.workspace.on('file-menu', ...)` - æ–‡ä»¶èœå• (Context Menu Docs)
4. âœ… `menu.addItem()` - èœå•é¡¹æ·»åŠ  (Context Menu Docs)
5. âœ… `this.addCommand()` - å‘½ä»¤æ³¨å†Œ (README.md)
6. âœ… `Modifier` ç±»å‹ - å¿«æ·é”®ä¿®é¥°ç¬¦ (obsidian.d.ts)

**å¤–éƒ¨å‚è€ƒæ¥æº**:
- [Obsidian Context Menus Documentation](https://docs.obsidian.md/Plugins/User+interface/Context+menus)
- [Obsidian Plugin Developer Docs - Context Menus](https://marcusolsson.github.io/obsidian-plugin-docs/user-interface/context-menus)
- [Obsidian API Repository](https://github.com/obsidianmd/obsidian-api)

---

**æœ¬Storyå®Œæˆåï¼Œç”¨æˆ·å°†èƒ½å¤Ÿé€šè¿‡å³é”®èœå•å’Œå¿«æ·é”®é«˜æ•ˆè®¿é—®æ‰€æœ‰Canvaså­¦ä¹ ç³»ç»ŸåŠŸèƒ½ï¼Œæå¤§æå‡ä½¿ç”¨ä½“éªŒã€‚åŒæ—¶ï¼ŒSCP-003å¤‡ä»½ä¿æŠ¤åŠŸèƒ½ç¡®ä¿é‡è¦å­¦ä¹ è¿›åº¦ä¸ä¼šè¢«æ„å¤–åˆ é™¤ã€‚**
