# Story 11.3: å®ç°å­¦ä¹ åˆ†æå›è°ƒ

## Status
Done

## Story
**ä½œä¸º**ï¼šå­¦ä¹ è€…
**æˆ‘æƒ³è¦**ï¼šç³»ç»Ÿè‡ªåŠ¨è¯†åˆ«å­¦ä¹ è¿›æ­¥ï¼ˆçº¢â†’ç´«â†’ç»¿ï¼‰
**ä»¥ä¾¿**ï¼šé‡åŒ–åœ°çœ‹åˆ°ç†è§£æå‡

## Acceptance Criteria
1. âœ… æ­£ç¡®è¯†åˆ«4ç§é¢œè‰²æµè½¬ç±»å‹
2. âœ… æ¯ç§æµè½¬ç±»å‹å†™å…¥ä¸åŒäº‹ä»¶
3. âœ… å®æ—¶æ›´æ–°å­¦ä¹ ç»Ÿè®¡
4. âœ… åˆ†æè€—æ—¶ < 50ms
5. âœ… æ”¯æŒæ‰¹é‡åˆ†æ
6. âœ… è¾¹ç¼˜æƒ…å†µå¤„ç†

**Integration Verification**:
- IV1: ä¸ç°æœ‰é¢œè‰²ç³»ç»Ÿå…¼å®¹
- IV2: ä¸å¹²æ‰°Agentæ“ä½œ
- IV3: å¤šCanvaså¹¶å‘åˆ†æå‡†ç¡®

## Tasks / Subtasks

- [x] Task 1: åˆ›å»º`learning_analyzer.py`æ¨¡å—å¹¶å®ç°æ ¸å¿ƒç±» (AC: 1, 2)
  - [x] Subtask 1.1: åœ¨`canvas_progress_tracker/`ç›®å½•ä¸‹åˆ›å»º`learning_analyzer.py`æ¨¡å—
  - [x] Subtask 1.2: å®ç°`LearningAnalyzer`ç±»çš„åŸºç¡€ç»“æ„å’Œåˆå§‹åŒ–æ–¹æ³•
  - [x] Subtask 1.3: åœ¨`learning_analyzer.py`æ¨¡å—çº§åˆ«å®šä¹‰`LearningEventType(Enum)`æšä¸¾å’Œ`LearningEvent`æ•°æ®ç±»ï¼ˆä½äºå¯¼å…¥ä¹‹åã€ç±»å®šä¹‰ä¹‹å‰ï¼‰ï¼ŒåŒ…å«6ç§å­¦ä¹ äº‹ä»¶ç±»å‹ï¼ˆunderstanding_improving, understanding_mastered, breakthrough, understanding_regressed, knowledge_node_added, personal_understanding_updatedï¼‰
  - [x] Subtask 1.4: å®ç°`_detect_color_transition()`ç§æœ‰æ–¹æ³•è¯†åˆ«é¢œè‰²æµè½¬ç±»å‹

- [x] Task 2: å®ç°é¢œè‰²æµè½¬åˆ†æé€»è¾‘ (AC: 1, 2, 4)
  - [x] Subtask 2.1: å®ç°`analyze_change()`æ–¹æ³•æ¥æ”¶`CanvasChange`äº‹ä»¶
  - [x] Subtask 2.2: è§£æ`old_content`å’Œ`new_content`æå–é¢œè‰²å­—æ®µ
  - [x] Subtask 2.3: å®ç°4ç§ä¸»è¦é¢œè‰²æµè½¬æ£€æµ‹ï¼ˆçº¢â†’ç´«, ç´«â†’ç»¿, çº¢â†’ç»¿, ç»¿â†’ç´«/ç´«â†’çº¢ï¼‰
  - [x] Subtask 2.4: å®ç°æ–°å¢èŠ‚ç‚¹æ£€æµ‹ï¼ˆæ— é¢œè‰² â†’ çº¢è‰²ï¼‰
  - [x] Subtask 2.5: å®ç°é»„è‰²èŠ‚ç‚¹å†…å®¹æ›´æ–°æ£€æµ‹
  - [x] Subtask 2.6: ä¸ºæ¯ç§æµè½¬ç”Ÿæˆå¯¹åº”çš„å­¦ä¹ äº‹ä»¶æ•°æ®ç»“æ„
  - [x] Subtask 2.7: ç¡®ä¿åˆ†æè€—æ—¶ < 50msï¼ˆæ·»åŠ æ€§èƒ½æ—¥å¿—ï¼‰

- [x] Task 3: å®ç°å­¦ä¹ ç»Ÿè®¡è®¡ç®—åŠŸèƒ½ (AC: 3)
  - [x] Subtask 3.1: å®ç°`_update_learning_stats()`æ–¹æ³•
  - [x] Subtask 3.2: ç»´æŠ¤é¢œè‰²åˆ†å¸ƒç»Ÿè®¡ï¼ˆçº¢/ç´«/ç»¿/è“/é»„èŠ‚ç‚¹æ•°é‡ï¼‰
  - [x] Subtask 3.3: è®¡ç®—ç†è§£æå‡ç‡ï¼ˆæ­£å‘æµè½¬æ¬¡æ•°/æ€»æµè½¬æ¬¡æ•°ï¼‰
  - [x] Subtask 3.4: è¿½è¸ªå­¦ä¹ æ—¶é•¿ï¼ˆé¦–æ¬¡ä¿®æ”¹åˆ°æœ€åä¿®æ”¹æ—¶é—´è·¨åº¦ï¼‰
  - [x] Subtask 3.5: è¯†åˆ«Agentä½¿ç”¨é¢‘ç‡ï¼ˆåŸºäºè“è‰²èŠ‚ç‚¹çš„emojiå’Œå…³é”®è¯ï¼‰
  - [x] Subtask 3.6: æ”¯æŒæŒ‰Canvasç»´åº¦èšåˆç»Ÿè®¡

- [x] Task 4: å®ç°æ‰¹é‡åˆ†æåŠŸèƒ½ (AC: 5)
  - [x] Subtask 4.1: å®ç°`analyze_batch()`æ–¹æ³•æ¥æ”¶`List[CanvasChange]`
  - [x] Subtask 4.2: æ‰¹é‡å¤„ç†æ—¶æŒ‰Canvas IDåˆ†ç»„
  - [x] Subtask 4.3: æ‰¹é‡æ›´æ–°ç»Ÿè®¡æ•°æ®ï¼ˆä¸€æ¬¡æ€§æ›´æ–°é¿å…é¢‘ç¹å†™å…¥ï¼‰
  - [x] Subtask 4.4: è¿”å›æ‰¹é‡åˆ†æç»“æœæ‘˜è¦

- [x] Task 5: å®ç°è¾¹ç¼˜æƒ…å†µå¤„ç† (AC: 6)
  - [x] Subtask 5.1: å¤„ç†èŠ‚ç‚¹åˆ é™¤äº‹ä»¶ï¼ˆä¸è§¦å‘é¢œè‰²æµè½¬åˆ†æï¼‰
  - [x] Subtask 5.2: å¤„ç†èŠ‚ç‚¹ä½ç½®å˜åŒ–ä½†æ— é¢œè‰²å˜åŒ–ï¼ˆè·³è¿‡åˆ†æï¼‰
  - [x] Subtask 5.3: å¤„ç†æŸåæˆ–ç¼ºå¤±çš„`old_content`/`new_content`ï¼ˆè®°å½•è­¦å‘Šï¼Œè·³è¿‡ï¼‰
  - [x] Subtask 5.4: å¤„ç†éæ³•é¢œè‰²å€¼ï¼ˆä¸åœ¨1-6èŒƒå›´ï¼‰ï¼ˆè®°å½•é”™è¯¯ï¼Œè·³è¿‡ï¼‰
  - [x] Subtask 5.5: å¤„ç†åŒä¸€èŠ‚ç‚¹çŸ­æ—¶é—´å†…å¤šæ¬¡é¢œè‰²å˜åŒ–ï¼ˆä¿ç•™æ‰€æœ‰æµè½¬è®°å½•ï¼‰

- [x] Task 6: å®ç°å›è°ƒå‡½æ•°`learning_analysis_callback()` (AC: 2, 3, 4)
  - [x] Subtask 6.1: åˆ›å»º`learning_analysis_callback(change_event)`å‡½æ•°
  - [x] Subtask 6.2: è°ƒç”¨`LearningAnalyzer.analyze_change()`åˆ†æäº‹ä»¶
  - [x] Subtask 6.3: å°†åˆ†æç»“æœå†™å…¥çƒ­æ•°æ®å­˜å‚¨ï¼ˆé€šè¿‡`HotDataStore.append_event()`ï¼‰
  - [x] Subtask 6.4: æ·»åŠ æ€§èƒ½æ—¥å¿—è®°å½•ï¼ˆåˆ†æè€—æ—¶ï¼‰
  - [x] Subtask 6.5: å®ç°å…¨å±€å•ä¾‹`LearningAnalyzer`å®ä¾‹ç®¡ç†

- [x] Task 7: æ³¨å†Œå›è°ƒåˆ°ç›‘æ§å¼•æ“ (AC: 2)
  - [x] Subtask 7.1: åœ¨`canvas_monitor_engine.py`å¯¼å…¥`learning_analysis_callback`ï¼ˆä½¿ç”¨try/except fallbackï¼‰
  - [x] Subtask 7.2: åœ¨ç›‘æ§å¯åŠ¨æ—¶æ³¨å†Œå›è°ƒåˆ°`change_callbacks`åˆ—è¡¨
  - [x] Subtask 7.3: éªŒè¯å›è°ƒè¢«æ­£ç¡®è§¦å‘ï¼ˆé€šè¿‡æ—¥å¿—ï¼‰

- [x] Task 8: ç¼–å†™å•å…ƒæµ‹è¯• (AC: 1-6)
  - [x] Subtask 8.1: åˆ›å»ºæµ‹è¯•æ–‡ä»¶`tests/test_story_11_3_learning_analyzer.py`
  - [x] Subtask 8.2: æµ‹è¯•4ç§ä¸»è¦é¢œè‰²æµè½¬æ£€æµ‹å‡†ç¡®æ€§
  - [x] Subtask 8.3: æµ‹è¯•æ¯ç§æµè½¬ç”Ÿæˆæ­£ç¡®çš„äº‹ä»¶ç±»å‹
  - [x] Subtask 8.4: æµ‹è¯•å­¦ä¹ ç»Ÿè®¡å®æ—¶æ›´æ–°
  - [x] Subtask 8.5: æµ‹è¯•åˆ†ææ€§èƒ½ï¼ˆ< 50msï¼‰
  - [x] Subtask 8.6: æµ‹è¯•æ‰¹é‡åˆ†æåŠŸèƒ½
  - [x] Subtask 8.7: æµ‹è¯•è¾¹ç¼˜æƒ…å†µå¤„ç†ï¼ˆåˆ é™¤èŠ‚ç‚¹ã€æŸåæ•°æ®ã€éæ³•é¢œè‰²ï¼‰

- [x] Task 9: é›†æˆéªŒè¯æµ‹è¯• (IV1, IV2, IV3)
  - [x] Subtask 9.1: ç«¯åˆ°ç«¯æµ‹è¯•ï¼šCanvasé¢œè‰²å˜æ›´ â†’ ç›‘æ§æ£€æµ‹ â†’ å­¦ä¹ åˆ†æ â†’ äº‹ä»¶å†™å…¥
  - [x] Subtask 9.2: é¢œè‰²ç³»ç»Ÿå…¼å®¹æ€§æµ‹è¯•ï¼šéªŒè¯5ç§é¢œè‰²ä»£ç æ­£ç¡®è¯†åˆ«
  - [x] Subtask 9.3: Agentæ“ä½œä¸å¹²æ‰°æµ‹è¯•ï¼šAI Agentæ·»åŠ è“è‰²èŠ‚ç‚¹æ—¶ä¸å½±å“å­¦ä¹ åˆ†æ
  - [x] Subtask 9.4: å¤šCanvaså¹¶å‘æµ‹è¯•ï¼šåŒæ—¶ä¿®æ”¹3ä¸ªCanvasæ–‡ä»¶ï¼ŒéªŒè¯åˆ†æå‡†ç¡®æ€§

## Dev Notes

### Previous Story Insights

ä»Story 11.2ä¸­å­¦åˆ°çš„å…³é”®ç»éªŒï¼š

- **å›è°ƒæ¨¡å¼**: å·²å»ºç«‹æˆç†Ÿçš„å›è°ƒæ³¨å†Œå’Œè°ƒç”¨æœºåˆ¶ï¼Œå›è°ƒå‡½æ•°ç­¾åä¸º`def callback(change_event: CanvasChange) -> None`
- **å…¨å±€å•ä¾‹æ¨¡å¼**: ä½¿ç”¨å…¨å±€å•ä¾‹æ¨¡å¼ç®¡ç†ä¸»è¦ç±»å®ä¾‹ï¼ˆå¦‚`HotDataStore`ï¼‰ï¼Œé¿å…é‡å¤åˆå§‹åŒ–
- **æ€§èƒ½ä¼˜åŒ–**: å›è°ƒå‡½æ•°ç›®æ ‡å¤„ç†æ—¶é—´ < 20msï¼Œéœ€è¦åœ¨å‡½æ•°å¼€å§‹æ—¶è®°å½•æ—¶é—´æˆ³å¹¶åœ¨ç»“æŸæ—¶è®¡ç®—è€—æ—¶
- **é”™è¯¯å¤„ç†**: å›è°ƒå‡½æ•°å¿…é¡»ä½¿ç”¨try/exceptåŒ…è£¹æ‰€æœ‰å¤„ç†é€»è¾‘ï¼Œç¡®ä¿å¼‚å¸¸ä¸å½±å“ç›‘æ§å¼•æ“ç¨³å®šæ€§
- **è·¨å¹³å°å…¼å®¹**: æ³¨æ„æ–‡ä»¶è·¯å¾„å¤„ç†ï¼ˆä½¿ç”¨`os.path.basename()`æå–æ–‡ä»¶åï¼‰
- **é›†æˆæ³¨å†Œ**: åœ¨`canvas_monitor_engine.py`ä¸­ä½¿ç”¨try/exceptå¯¼å…¥å›è°ƒå‡½æ•°ï¼Œæä¾›ä¼˜é›…é™çº§

[Source: docs/stories/11.2.story.md#Dev Notes]

### Data Models

**CanvasChange æ•°æ®æ¨¡å‹** (å·²å­˜åœ¨äº canvas_monitor_engine.py):

```python
@dataclass
class CanvasChange:
    """Canvaså˜æ›´äº‹ä»¶æ•°æ®æ¨¡å‹"""
    change_id: str              # å”¯ä¸€å˜æ›´IDï¼ˆUUIDæ ¼å¼ï¼‰
    canvas_id: str              # Canvasæ–‡ä»¶å
    change_type: CanvasChangeType  # CREATE/UPDATE/DELETE/RENAME/MOVE
    node_id: Optional[str]      # å˜æ›´çš„èŠ‚ç‚¹IDï¼ˆå¦‚æœæ˜¯èŠ‚ç‚¹çº§å˜æ›´ï¼‰
    node_type: Optional[str]    # èŠ‚ç‚¹ç±»å‹(text/file/group)
    old_content: Optional[Any]  # æ—§å†…å®¹ï¼ˆJSONå¯¹è±¡ï¼ŒåŒ…å«å®Œæ•´èŠ‚ç‚¹æ•°æ®ï¼‰
    new_content: Optional[Any]  # æ–°å†…å®¹ï¼ˆJSONå¯¹è±¡ï¼ŒåŒ…å«å®Œæ•´èŠ‚ç‚¹æ•°æ®ï¼‰
    timestamp: datetime         # å˜æ›´æ—¶é—´æˆ³
    file_path: str              # Canvasæ–‡ä»¶å®Œæ•´è·¯å¾„
```

**å…³é”®å­—æ®µè¯´æ˜**:
- `old_content` å’Œ `new_content` æ˜¯å®Œæ•´çš„èŠ‚ç‚¹JSONå¯¹è±¡ï¼ŒåŒ…å«æ‰€æœ‰å­—æ®µï¼ˆid, type, text, color, x, y, width, heightç­‰ï¼‰
- é¢œè‰²ä¿¡æ¯ä½äº `old_content["color"]` å’Œ `new_content["color"]`
- é¢œè‰²å€¼ä¸ºå­—ç¬¦ä¸²ç±»å‹ï¼š"1"=çº¢, "2"=ç»¿, "3"=ç´«, "5"=è“, "6"=é»„

[Source: canvas_progress_tracker/canvas_monitor_engine.py:64-80]

**LearningEvent æ•°æ®æ¨¡å‹** (éœ€è¦åˆ›å»º):

```python
@dataclass
class LearningEvent:
    """å­¦ä¹ äº‹ä»¶æ•°æ®æ¨¡å‹"""
    event_id: str                       # äº‹ä»¶å”¯ä¸€ID
    event_type: LearningEventType       # å­¦ä¹ äº‹ä»¶ç±»å‹
    canvas_id: str                      # Canvasæ–‡ä»¶å
    node_id: str                        # èŠ‚ç‚¹ID
    timestamp: datetime                 # äº‹ä»¶æ—¶é—´æˆ³
    details: Dict[str, Any]             # äº‹ä»¶è¯¦æƒ…ï¼ˆåŒ…å«old_color, new_colorç­‰ï¼‰

class LearningEventType(Enum):
    """å­¦ä¹ äº‹ä»¶ç±»å‹æšä¸¾"""
    UNDERSTANDING_IMPROVING = "understanding_improving"   # çº¢â†’ç´«
    UNDERSTANDING_MASTERED = "understanding_mastered"     # ç´«â†’ç»¿
    BREAKTHROUGH = "breakthrough"                         # çº¢â†’ç»¿
    UNDERSTANDING_REGRESSED = "understanding_regressed"   # ç»¿â†’ç´« æˆ– ç´«â†’çº¢
    KNOWLEDGE_NODE_ADDED = "knowledge_node_added"         # æ— â†’çº¢
    PERSONAL_UNDERSTANDING_UPDATED = "personal_understanding_updated"  # é»„è‰²å†…å®¹å˜åŒ–
```

[Source: docs/prd-canvas-monitoring-system-completion/21-åŠŸèƒ½æ€§éœ€æ±‚-functional-requirements.md#FR3]

### Color System Mapping

**Canvasé¢œè‰²ä»£ç ç³»ç»Ÿ** [Source: CLAUDE.md#Canvasé¢œè‰²ç³»ç»Ÿ]:

| Canvas Color Code | è§†è§‰é¢œè‰² | å«ä¹‰ | ä½¿ç”¨åœºæ™¯ |
|-------------------|---------|------|---------|
| `"1"` | ğŸ”´ çº¢è‰² | ä¸ç†è§£/æœªé€šè¿‡ | å­¦ç”Ÿå®Œå…¨ä¸æ‡‚çš„é—®é¢˜èŠ‚ç‚¹ |
| `"2"` | ğŸŸ¢ ç»¿è‰² | å®Œå…¨ç†è§£/å·²é€šè¿‡ | è¯„åˆ†â‰¥80åˆ†çš„é—®é¢˜ |
| `"3"` | ğŸŸ£ ç´«è‰² | ä¼¼æ‡‚éæ‡‚/å¾…æ£€éªŒ | è¯„åˆ†60-79åˆ†,éœ€è¦æ·±åº¦æ£€éªŒ |
| `"5"` | ğŸ”µ è“è‰² | AIè¡¥å……è§£é‡Š | AIç”Ÿæˆçš„è§£é‡Šæ–‡æ¡£èŠ‚ç‚¹ |
| `"6"` | ğŸŸ¡ é»„è‰² | ä¸ªäººç†è§£è¾“å‡ºåŒº | å­¦ç”Ÿç”¨è‡ªå·±è¯çš„è§£é‡Š |

**é¢œè‰²æµè½¬è·¯å¾„**:
```
ğŸ”´ çº¢è‰² (å®Œå…¨ä¸æ‡‚)
  â†“ åŸºç¡€æ‹†è§£ + å¡«å†™ç†è§£
ğŸŸ£ ç´«è‰² (ä¼¼æ‡‚éæ‡‚,è¯„åˆ†60-79)
  â†“ æ·±åº¦æ‹†è§£ + è¡¥å……è§£é‡Š + ä¼˜åŒ–ç†è§£
ğŸŸ¢ ç»¿è‰² (å®Œå…¨ç†è§£,è¯„åˆ†â‰¥80)
```

### Learning Event Detection Rules

**é¢œè‰²æµè½¬æ£€æµ‹è§„åˆ™** [Source: docs/prd-canvas-monitoring-system-completion/21-åŠŸèƒ½æ€§éœ€æ±‚-functional-requirements.md#FR3]:

| äº‹ä»¶ç±»å‹ | æ£€æµ‹æ¡ä»¶ | ä¼˜å…ˆçº§ | äº‹ä»¶è¯¦æƒ…å­—æ®µ |
|---------|---------|--------|------------|
| `understanding_improving` | `old_color == "1"` AND `new_color == "3"` | ğŸŸ¡ æ­£å¸¸è¿›æ­¥ | `old_color`, `new_color`, `progress_type` |
| `understanding_mastered` | `old_color == "3"` AND `new_color == "2"` | ğŸŸ¢ æŒæ¡æˆåŠŸ | `old_color`, `new_color`, `progress_type` |
| `breakthrough` | `old_color == "1"` AND `new_color == "2"` | ğŸŒŸ é‡å¤§è¿›æ­¥ | `old_color`, `new_color`, `progress_type` |
| `understanding_regressed` | (`old_color == "2"` AND `new_color == "3"`) OR (`old_color == "3"` AND `new_color == "1"`) | ğŸ”´ éœ€è¦å¤ä¹  | `old_color`, `new_color`, `regression_type` |
| `knowledge_node_added` | `old_content is None or "color" not in old_content` AND `new_color == "1"` | ğŸ“ çŸ¥è¯†æ‰©å±• | `new_color` |
| `personal_understanding_updated` | `old_color == "6"` AND `new_color == "6"` AND `old_content["text"] != new_content["text"]` | ğŸ’­ è¾“å‡ºè®­ç»ƒ | `old_text_length`, `new_text_length`, `text_delta` |

**æ£€æµ‹ä¼˜å…ˆçº§**:
1. é¦–å…ˆæ£€æŸ¥æ˜¯å¦æ˜¯é¢œè‰²å˜åŒ–äº‹ä»¶ï¼ˆ`change_type == CanvasChangeType.UPDATE` AND `old_content["color"] != new_content["color"]`ï¼‰
2. å¦‚æœæ˜¯æ–°å¢èŠ‚ç‚¹äº‹ä»¶ï¼ˆ`change_type == CanvasChangeType.CREATE`ï¼‰ï¼Œæ£€æŸ¥æ˜¯å¦æ˜¯`knowledge_node_added`
3. å¦‚æœæ˜¯é»„è‰²èŠ‚ç‚¹å†…å®¹æ›´æ–°ï¼ˆé¢œè‰²æœªå˜ä½†æ–‡æœ¬æ”¹å˜ï¼‰ï¼Œæ£€æŸ¥æ˜¯å¦æ˜¯`personal_understanding_updated`
4. å¦åˆ™è·³è¿‡ï¼ˆä¸è§¦å‘å­¦ä¹ äº‹ä»¶ï¼‰

### Learning Statistics Calculation

**å­¦ä¹ æŒ‡æ ‡è®¡ç®—å…¬å¼** [Source: docs/prd-canvas-monitoring-system-completion/21-åŠŸèƒ½æ€§éœ€æ±‚-functional-requirements.md#FR3]:

1. **å­¦ä¹ æ—¶é•¿ (Learning Duration)**:
   ```python
   learning_duration_seconds = (last_change_time - first_change_time).total_seconds()
   ```
   - å•ä½ï¼šç§’
   - èšåˆç»´åº¦ï¼šæ¯Canvasã€æ¯æ—¥ã€æ¯å‘¨

2. **é¢œè‰²åˆ†å¸ƒ (Color Distribution)**:
   ```python
   color_distribution = {
       "red": count_nodes_with_color("1"),
       "purple": count_nodes_with_color("3"),
       "green": count_nodes_with_color("2"),
       "blue": count_nodes_with_color("5"),
       "yellow": count_nodes_with_color("6")
   }
   ```

3. **ç†è§£æå‡ç‡ (Understanding Rate)**:
   ```python
   positive_transitions = count(understanding_improving) + count(understanding_mastered) + count(breakthrough)
   total_transitions = positive_transitions + count(understanding_regressed)
   understanding_rate = positive_transitions / total_transitions if total_transitions > 0 else 0
   # ç›®æ ‡å€¼: > 0.7 è¡¨ç¤ºå­¦ä¹ æ•ˆæœè‰¯å¥½
   ```

4. **Agentä½¿ç”¨é¢‘ç‡ (Agent Usage)**:
   - æ£€æµ‹è“è‰²èŠ‚ç‚¹ï¼ˆcolor == "5"ï¼‰çš„åˆ›å»ºäº‹ä»¶
   - ä»èŠ‚ç‚¹æ–‡æœ¬çš„é¦–è¡Œæå–emojiå’Œå…³é”®è¯
   - **åœ¨æ¨¡å—çº§åˆ«å®šä¹‰`AGENT_EMOJI_MAP`å¸¸é‡**ï¼ˆä½äºå¯¼å…¥ä¹‹åï¼‰ï¼ŒåŒ…å«emojiåˆ°agentåç§°çš„æ˜ å°„ï¼š
   ```python
   AGENT_EMOJI_MAP = {
       "ğŸ—£ï¸": "oral-explanation",
       "ğŸ”": "clarification-path",
       "ğŸ“Š": "comparison-table",
       "âš“": "memory-anchor",
       "ğŸ¯": "four-level-explanation",
       "ğŸ“": "example-teaching"
   }
   ```
   - ç»Ÿè®¡Top 3æœ€å¸¸ç”¨Agent

### Project Structure and File Locations

åŸºäºæ¶æ„æ–‡æ¡£ `docs/architecture/unified-project-structure.md`:

**æ–°å»ºæ–‡ä»¶**:
- `canvas_progress_tracker/learning_analyzer.py` - å­¦ä¹ åˆ†ææ¨¡å—
  - åŒ…å«`LearningAnalyzer`ç±»
  - åŒ…å«`LearningEvent`å’Œ`LearningEventType`æ•°æ®æ¨¡å‹
  - åŒ…å«`learning_analysis_callback()`å›è°ƒå‡½æ•°
  - å¯¼å‡ºå­¦ä¹ åˆ†æç›¸å…³çš„å…¬å…±æ¥å£

**ä¿®æ”¹æ–‡ä»¶**:
- `canvas_progress_tracker/canvas_monitor_engine.py` - ç›‘æ§å¼•æ“
  - åœ¨å¯åŠ¨æ—¶æ³¨å†Œ`learning_analysis_callback`åˆ°`change_callbacks`
  - å¯¼å…¥`learning_analyzer`æ¨¡å—ï¼ˆä½¿ç”¨try/except fallbackï¼‰

**ä¾èµ–æ–‡ä»¶**:
- `canvas_progress_tracker/data_stores.py` - çƒ­æ•°æ®å­˜å‚¨
  - `learning_analysis_callback()`å°†è°ƒç”¨`HotDataStore.append_event()`å†™å…¥å­¦ä¹ äº‹ä»¶

**æµ‹è¯•æ–‡ä»¶**:
- åˆ›å»º `tests/test_story_11_3_learning_analyzer.py`
- ä½¿ç”¨ç°æœ‰æµ‹è¯•fixtures: `tests/fixtures/*.canvas`

[Source: docs/architecture/unified-project-structure.md#é¡¹ç›®ç»“æ„]

### Callback Registration Pattern

**å›è°ƒæ³¨å†Œæµç¨‹** [Source: docs/stories/11.2.story.md#Dev Notes]:

```python
# åœ¨ canvas_monitor_engine.py ä¸­:
# æ–‡ä»¶é¡¶éƒ¨å¯¼å…¥ï¼ˆä½¿ç”¨try/except fallbackï¼‰
try:
    from canvas_progress_tracker.learning_analyzer import learning_analysis_callback
    LEARNING_ANALYSIS_CALLBACK_AVAILABLE = True
except ImportError:
    LEARNING_ANALYSIS_CALLBACK_AVAILABLE = False
    learning_analysis_callback = None

# åœ¨ CanvasMonitorEngine ç±»ä¸­:
class CanvasMonitorEngine:
    def __init__(self, ...):
        # å·²æœ‰ä»£ç 
        self.change_callbacks = []

    def start_monitoring(self):
        # æ³¨å†Œå­¦ä¹ åˆ†æå›è°ƒ
        if LEARNING_ANALYSIS_CALLBACK_AVAILABLE:
            self.register_callback(learning_analysis_callback)
            self.logger.info("å­¦ä¹ åˆ†æå›è°ƒå·²æ³¨å†Œ")
        # å¯åŠ¨ç›‘æ§
        ...
```

**å›è°ƒå‡½æ•°ç­¾å**:
```python
def learning_analysis_callback(change_event: CanvasChange) -> None:
    """
    å­¦ä¹ åˆ†æå›è°ƒå‡½æ•°

    åˆ†æCanvaså˜æ›´äº‹ä»¶ï¼Œè¯†åˆ«å­¦ä¹ äº‹ä»¶ç±»å‹ï¼Œæ›´æ–°å­¦ä¹ ç»Ÿè®¡ï¼Œ
    å¹¶å°†å­¦ä¹ äº‹ä»¶å†™å…¥çƒ­æ•°æ®å­˜å‚¨ã€‚

    Args:
        change_event: Canvaså˜æ›´äº‹ä»¶å¯¹è±¡

    Performance:
        Target: < 50ms processing time

    Raises:
        Exception: åˆ†ææˆ–å†™å…¥å¤±è´¥æ—¶æŠ›å‡ºï¼ˆå°†è¢«ç›‘æ§å¼•æ“æ•è·ï¼‰
    """
    pass
```

### Integration with Hot Data Store

**äº‹ä»¶å†™å…¥æ¨¡å¼** [Source: docs/stories/11.2.story.md#Dev Notes]:

å­¦ä¹ åˆ†æå›è°ƒéœ€è¦å°†è¯†åˆ«çš„å­¦ä¹ äº‹ä»¶å†™å…¥çƒ­æ•°æ®å­˜å‚¨ï¼š

```python
from canvas_progress_tracker.data_stores import get_hot_data_store

def learning_analysis_callback(change_event: CanvasChange) -> None:
    start_time = time.perf_counter()

    try:
        # 1. åˆ†æå˜æ›´äº‹ä»¶
        learning_analyzer = get_learning_analyzer()
        learning_event = learning_analyzer.analyze_change(change_event)

        # 2. å¦‚æœæ˜¯æœ‰æ•ˆçš„å­¦ä¹ äº‹ä»¶ï¼Œå†™å…¥çƒ­æ•°æ®å­˜å‚¨
        if learning_event:
            hot_store = get_hot_data_store()

            # è½¬æ¢ä¸ºJSONäº‹ä»¶æ ¼å¼
            event = {
                "event_id": learning_event.event_id,
                "timestamp": learning_event.timestamp.isoformat(),
                "canvas_id": learning_event.canvas_id,
                "event_type": learning_event.event_type.value,
                "details": learning_event.details
            }

            # å†™å…¥çƒ­æ•°æ®
            hot_store.append_event(event)

        # 3. æ€§èƒ½æ—¥å¿—
        elapsed_ms = (time.perf_counter() - start_time) * 1000
        if elapsed_ms > 50:
            logger.warning(f"å­¦ä¹ åˆ†æè€—æ—¶è¿‡é•¿: {elapsed_ms:.2f}ms")
        else:
            logger.debug(f"å­¦ä¹ åˆ†æå®Œæˆ: {elapsed_ms:.2f}ms")

    except Exception as e:
        logger.error(f"å­¦ä¹ åˆ†æå›è°ƒå¤±è´¥: {e}")
        raise  # é‡æ–°æŠ›å‡ºå¼‚å¸¸ä»¥ä¾¿ç›‘æ§å¼•æ“è®°å½•
```

**äº‹ä»¶JSONæ ¼å¼ç¤ºä¾‹**:
```json
{
  "event_id": "evt_1705300523001",
  "timestamp": "2025-01-15T10:15:23",
  "canvas_id": "ç¦»æ•£æ•°å­¦.canvas",
  "event_type": "understanding_improving",
  "details": {
    "node_id": "node_abc123",
    "old_color": "1",
    "new_color": "3",
    "progress_type": "understanding_improving"
  }
}
```

### Performance Requirements

**æ€§èƒ½ç›®æ ‡** [Source: docs/prd-canvas-monitoring-system-completion/21-åŠŸèƒ½æ€§éœ€æ±‚-functional-requirements.md#FR3]:

- **å•æ¬¡åˆ†æè€—æ—¶**: < 50ms
- **æ‰¹é‡åˆ†æè€—æ—¶**: 100ä¸ªå˜æ›´ < 1ç§’
- **å†…å­˜ä½¿ç”¨**: å¢é‡ < 20MB
- **CPUä½¿ç”¨**: å³°å€¼ < 10%

**æ€§èƒ½ä¼˜åŒ–ç­–ç•¥**:
1. é¿å…é‡å¤è¯»å–Canvasæ–‡ä»¶ï¼ˆä¾èµ–`CanvasChange`ä¸­çš„`old_content`å’Œ`new_content`ï¼‰
2. ä½¿ç”¨å­—å…¸ç¼“å­˜é¢œè‰²åˆ†å¸ƒç»Ÿè®¡ï¼ˆé¿å…æ¯æ¬¡é‡æ–°è®¡ç®—ï¼‰
3. æ‰¹é‡åˆ†ææ—¶ä¸€æ¬¡æ€§æ›´æ–°ç»Ÿè®¡ï¼ˆå‡å°‘çƒ­æ•°æ®å­˜å‚¨å†™å…¥æ¬¡æ•°ï¼‰
4. ä½¿ç”¨æ—©æœŸè¿”å›ï¼ˆearly returnï¼‰è·³è¿‡ä¸ç›¸å…³çš„å˜æ›´äº‹ä»¶

### Edge Cases to Handle

**è¾¹ç¼˜æƒ…å†µå¤„ç†æ¸…å•** [Source: docs/prd-canvas-monitoring-system-completion/43-storyæ¸…å•.md#Story 1.3]:

1. **èŠ‚ç‚¹åˆ é™¤äº‹ä»¶**: `change_type == CanvasChangeType.DELETE`
   - è§£å†³æ–¹æ¡ˆ: ä¸è§¦å‘é¢œè‰²æµè½¬åˆ†æï¼Œä½†æ›´æ–°é¢œè‰²åˆ†å¸ƒç»Ÿè®¡ï¼ˆå‡å°‘å¯¹åº”é¢œè‰²èŠ‚ç‚¹æ•°é‡ï¼‰

2. **èŠ‚ç‚¹ä½ç½®å˜åŒ–æ— é¢œè‰²å˜åŒ–**: `old_content["color"] == new_content["color"]` AND `(old_content["x"] != new_content["x"] OR old_content["y"] != new_content["y"])`
   - è§£å†³æ–¹æ¡ˆ: è·³è¿‡å­¦ä¹ äº‹ä»¶åˆ†æï¼ˆä¸è®°å½•ï¼‰

3. **æŸåæˆ–ç¼ºå¤±çš„å†…å®¹**: `old_content is None OR new_content is None OR "color" not in old_content OR "color" not in new_content`
   - è§£å†³æ–¹æ¡ˆ: è®°å½•è­¦å‘Šæ—¥å¿—ï¼Œè·³è¿‡åˆ†æ

4. **éæ³•é¢œè‰²å€¼**: `color not in ["1", "2", "3", "4", "5", "6"]`
   - è§£å†³æ–¹æ¡ˆ: è®°å½•é”™è¯¯æ—¥å¿—ï¼Œè·³è¿‡åˆ†æ

5. **åŒä¸€èŠ‚ç‚¹çŸ­æ—¶é—´å¤šæ¬¡é¢œè‰²å˜åŒ–**:
   - è§£å†³æ–¹æ¡ˆ: ä¿ç•™æ‰€æœ‰æµè½¬è®°å½•ï¼ˆä¸åˆå¹¶ï¼‰ï¼Œç»Ÿè®¡æ—¶éƒ½è®¡å…¥

6. **è“è‰²å’Œé»„è‰²èŠ‚ç‚¹çš„ç‰¹æ®Šå¤„ç†**:
   - è“è‰²èŠ‚ç‚¹ (color == "5"): ä¸å‚ä¸é¢œè‰²æµè½¬åˆ†æï¼Œä½†è®°å½•Agentä½¿ç”¨
   - é»„è‰²èŠ‚ç‚¹ (color == "6"): åªè®°å½•å†…å®¹æ›´æ–°äº‹ä»¶ï¼Œä¸è®°å½•é¢œè‰²æµè½¬

### Technical Constraints

**å¹³å°å…¼å®¹æ€§** [Source: docs/architecture/tech-stack.md]:
- Python 3.9+
- ä¾èµ–`canvas_monitor_engine.py`ä¸­çš„`CanvasChange`æ•°æ®æ¨¡å‹
- ä¾èµ–`data_stores.py`ä¸­çš„`HotDataStore`ç±»

**ä¾èµ–åº“**:
- æ ‡å‡†åº“: `json`, `os`, `time`, `datetime`, `typing`, `enum`, `dataclasses`, `logging`
- æ— éœ€é¢å¤–ç¬¬ä¸‰æ–¹åº“

**æ—¥å¿—é…ç½®** [Source: docs/stories/11.2.story.md#Dev Notes]:
- ä½¿ç”¨`logger = logging.getLogger(__name__)`åˆå§‹åŒ–æ—¥å¿—å™¨ï¼ˆä¸Story 11.2ä¿æŒä¸€è‡´ï¼‰
- æ€§èƒ½æ—¥å¿—ä½¿ç”¨`logger.debug()`è®°å½•æ­£å¸¸è€—æ—¶
- è¶…æ—¶è­¦å‘Šä½¿ç”¨`logger.warning()`ï¼ˆåˆ†æè€—æ—¶>50msæ—¶ï¼‰
- é”™è¯¯ä½¿ç”¨`logger.error()`è®°å½•å¼‚å¸¸æƒ…å†µ

**æ•°æ®æŒä¹…åŒ–**:
- å­¦ä¹ äº‹ä»¶é€šè¿‡`HotDataStore.append_event()`å†™å…¥JSONæ–‡ä»¶
- å­¦ä¹ ç»Ÿè®¡ä¿å­˜åœ¨å†…å­˜ä¸­ï¼ˆ`LearningAnalyzer`å®ä¾‹å±æ€§ï¼‰
- æœªæ¥æ‰©å±•: ç»Ÿè®¡æ•°æ®åŒæ­¥åˆ°SQLiteï¼ˆStory 1.5-1.6ï¼‰

### Coding Standards

**å‘½åè§„èŒƒ** [Source: docs/architecture/coding-standards.md#å‘½åè§„èŒƒ]:
- ç±»å: `LearningAnalyzer`, `LearningEvent`, `LearningEventType` (PascalCase)
- å‡½æ•°å: `analyze_change()`, `_detect_color_transition()`, `learning_analysis_callback()` (snake_case)
- å¸¸é‡: `COLOR_RED = "1"`, `COLOR_GREEN = "2"`, `ANALYSIS_TIMEOUT_MS = 50` (UPPER_SNAKE_CASE)
- ç§æœ‰æ–¹æ³•: `_detect_color_transition()`, `_update_stats()` (leading underscore)

**ç±»å‹æ³¨è§£**: å¼ºåˆ¶ä½¿ç”¨ç±»å‹æ³¨è§£
```python
from typing import Dict, List, Optional, Tuple
from datetime import datetime

class LearningAnalyzer:
    def analyze_change(
        self,
        change_event: CanvasChange
    ) -> Optional[LearningEvent]:
        """åˆ†æCanvaså˜æ›´äº‹ä»¶ï¼Œè¿”å›å­¦ä¹ äº‹ä»¶ï¼ˆå¦‚æœæ£€æµ‹åˆ°ï¼‰"""
        pass

    def _detect_color_transition(
        self,
        old_color: Optional[str],
        new_color: str
    ) -> Optional[LearningEventType]:
        """æ£€æµ‹é¢œè‰²æµè½¬ç±»å‹"""
        pass
```

**æ–‡æ¡£å­—ç¬¦ä¸²**: ä½¿ç”¨Google Style
```python
def analyze_change(self, change_event: CanvasChange) -> Optional[LearningEvent]:
    """åˆ†æCanvaså˜æ›´äº‹ä»¶å¹¶è¿”å›å­¦ä¹ äº‹ä»¶

    Args:
        change_event: Canvaså˜æ›´äº‹ä»¶å¯¹è±¡

    Returns:
        Optional[LearningEvent]: å­¦ä¹ äº‹ä»¶å¯¹è±¡ï¼Œå¦‚æœæœªæ£€æµ‹åˆ°æœ‰æ•ˆå­¦ä¹ äº‹ä»¶åˆ™è¿”å›None

    Raises:
        ValueError: å¦‚æœchange_eventåŒ…å«éæ³•æ•°æ®

    Example:
        >>> analyzer = LearningAnalyzer()
        >>> change = CanvasChange(...)
        >>> event = analyzer.analyze_change(change)
        >>> if event:
        ...     print(f"æ£€æµ‹åˆ°å­¦ä¹ äº‹ä»¶: {event.event_type.value}")
    """
    pass
```

## Testing

### Test File Location
`tests/test_story_11_3_learning_analyzer.py`

### Test Standards
[Source: docs/architecture/coding-standards.md#æµ‹è¯•è§„èŒƒ]

- **æµ‹è¯•æ¡†æ¶**: pytest
- **å‘½åè§„èŒƒ**:
  - æµ‹è¯•ç±»: `TestLearningAnalyzer`, `TestLearningAnalysisCallback`
  - æµ‹è¯•æ–¹æ³•: `test_detect_understanding_improving()`, `test_batch_analysis()`
- **è¦†ç›–ç‡ç›®æ ‡**: > 95%
- **æ–­è¨€é£æ ¼**: ä½¿ç”¨pytestçš„`assert`è¯­å¥

### Testing Frameworks and Patterns

**Fixtures**:
```python
import pytest
from datetime import datetime
from canvas_progress_tracker.canvas_monitor_engine import CanvasChange, CanvasChangeType
from canvas_progress_tracker.learning_analyzer import LearningAnalyzer

@pytest.fixture
def learning_analyzer():
    """LearningAnalyzerå®ä¾‹"""
    return LearningAnalyzer()

@pytest.fixture
def sample_color_change():
    """ç¤ºä¾‹é¢œè‰²å˜åŒ–äº‹ä»¶ï¼ˆçº¢â†’ç´«ï¼‰"""
    return CanvasChange(
        change_id="test_change_001",
        canvas_id="test.canvas",
        change_type=CanvasChangeType.UPDATE,
        node_id="node_abc123",
        node_type="text",
        old_content={"id": "node_abc123", "type": "text", "color": "1", "text": "é—®é¢˜"},
        new_content={"id": "node_abc123", "type": "text", "color": "3", "text": "é—®é¢˜"},
        timestamp=datetime.now(),
        file_path="/path/to/test.canvas"
    )
```

**æ€§èƒ½æµ‹è¯•æ¨¡å¼**:
```python
import time

def test_analysis_performance(learning_analyzer, sample_color_change):
    """æµ‹è¯•åˆ†ææ€§èƒ½ < 50ms"""
    start_time = time.perf_counter()
    learning_analyzer.analyze_change(sample_color_change)
    elapsed = (time.perf_counter() - start_time) * 1000
    assert elapsed < 50, f"åˆ†æè€—æ—¶ {elapsed:.2f}ms è¶…è¿‡50ms"
```

**æ‰¹é‡æµ‹è¯•æ¨¡å¼**:
```python
def test_batch_analysis(learning_analyzer):
    """æµ‹è¯•æ‰¹é‡åˆ†æï¼ˆ100ä¸ªå˜æ›´ < 1ç§’ï¼‰"""
    changes = [create_sample_change(i) for i in range(100)]
    start_time = time.perf_counter()
    learning_analyzer.analyze_batch(changes)
    elapsed = time.perf_counter() - start_time
    assert elapsed < 1.0, f"æ‰¹é‡åˆ†æè€—æ—¶ {elapsed:.2f}ç§’ è¶…è¿‡1ç§’"
```

### Specific Testing Requirements for This Story

1. **AC 1æµ‹è¯•**: æ­£ç¡®è¯†åˆ«4ç§é¢œè‰²æµè½¬ç±»å‹
   - æµ‹è¯•çº¢â†’ç´« = `understanding_improving`
   - æµ‹è¯•ç´«â†’ç»¿ = `understanding_mastered`
   - æµ‹è¯•çº¢â†’ç»¿ = `breakthrough`
   - æµ‹è¯•ç»¿â†’ç´«ã€ç´«â†’çº¢ = `understanding_regressed`

2. **AC 2æµ‹è¯•**: æ¯ç§æµè½¬ç±»å‹å†™å…¥ä¸åŒäº‹ä»¶
   - éªŒè¯æ¯ç§æµè½¬ç”Ÿæˆçš„äº‹ä»¶ç±»å‹æ­£ç¡®
   - éªŒè¯äº‹ä»¶è¯¦æƒ…å­—æ®µå®Œæ•´ï¼ˆ`old_color`, `new_color`, `progress_type`ç­‰ï¼‰

3. **AC 3æµ‹è¯•**: å®æ—¶æ›´æ–°å­¦ä¹ ç»Ÿè®¡
   - æ¨¡æ‹Ÿå¤šæ¬¡é¢œè‰²å˜æ›´
   - éªŒè¯é¢œè‰²åˆ†å¸ƒç»Ÿè®¡å®æ—¶æ›´æ–°
   - éªŒè¯ç†è§£æå‡ç‡æ­£ç¡®è®¡ç®—

4. **AC 4æµ‹è¯•**: åˆ†æè€—æ—¶ < 50ms
   - ä½¿ç”¨`time.perf_counter()`æµ‹é‡è€—æ—¶
   - è¿è¡Œ10æ¬¡å–å¹³å‡å€¼

5. **AC 5æµ‹è¯•**: æ”¯æŒæ‰¹é‡åˆ†æ
   - åˆ›å»º100ä¸ªå˜æ›´äº‹ä»¶
   - è°ƒç”¨`analyze_batch()`
   - éªŒè¯è¿”å›ç»“æœåŒ…å«æ‰€æœ‰åˆ†æç»“æœ

6. **AC 6æµ‹è¯•**: è¾¹ç¼˜æƒ…å†µå¤„ç†
   - æµ‹è¯•èŠ‚ç‚¹åˆ é™¤äº‹ä»¶ï¼ˆä¸è§¦å‘åˆ†æï¼‰
   - æµ‹è¯•ä½ç½®å˜åŒ–æ— é¢œè‰²å˜åŒ–ï¼ˆè·³è¿‡åˆ†æï¼‰
   - æµ‹è¯•æŸåçš„`old_content`/`new_content`ï¼ˆè®°å½•è­¦å‘Šï¼‰
   - æµ‹è¯•éæ³•é¢œè‰²å€¼ï¼ˆè®°å½•é”™è¯¯ï¼‰

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-01 | 1.0 | Storyåˆå§‹åˆ›å»ºï¼ŒåŒ…å«å®Œæ•´Dev Noteså’ŒTasks | SM Agent (Bob) |
| 2025-11-01 | 1.1 | POéªŒè¯åä¿®å¤ï¼š(1) æ˜ç¡®Task 1.3æšä¸¾å®šä¹‰ä½ç½® (2) æ·»åŠ æ—¥å¿—é…ç½®è¯´æ˜ (3) æ˜ç¡®AGENT_EMOJI_MAPå¸¸é‡å®šä¹‰ | PO Agent (Sarah) |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5 (claude-sonnet-4-5-20250929)

### Debug Log References
No blocking issues encountered during implementation.

### Completion Notes
**Implementation Summary:**
- âœ… Created `learning_analyzer.py` module with full learning analysis capabilities
- âœ… Implemented 6 learning event types (understanding_improving, mastered, breakthrough, regressed, node_added, understanding_updated)
- âœ… Built color transition detection system for 4 main learning flows (çº¢â†’ç´«â†’ç»¿)
- âœ… Integrated learning statistics calculation (color distribution, understanding rate, learning duration)
- âœ… Added batch analysis support with Canvas ID grouping
- âœ… Implemented comprehensive edge case handling (deletion, invalid data, concurrent changes)
- âœ… Registered callback to canvas_monitor_engine.py with graceful fallback
- âœ… Created 37 comprehensive unit tests covering all ACs and IVs
- âœ… All tests pass (37/37 for Story 11.3, 77/77 combined with Story 11.2)
- âœ… Performance verified: Single analysis <50ms, Batch analysis (100 events) <1s

**Key Technical Decisions:**
1. Used global singleton pattern for `LearningAnalyzer` instance to maintain state across callbacks
2. Implemented early-return validation to optimize performance
3. Added comprehensive performance logging with 50ms warning threshold
4. Designed event data model to be compatible with HotDataStore JSON schema
5. Separated color transition logic (_detect_color_transition) for clarity and testability

**Test Coverage:**
- Color transition detection: 6 tests
- Event generation: 7 tests
- Statistics calculation: 4 tests
- Performance: 2 tests
- Batch analysis: 3 tests
- Edge cases: 8 tests
- Integration: 4 tests
- Singleton: 2 tests
- Error handling: 2 tests

### File List
**New Files:**
- `canvas_progress_tracker/learning_analyzer.py` (650 lines) - Core learning analysis module
- `tests/test_story_11_3_learning_analyzer.py` (877 lines) - Comprehensive test suite

**Modified Files:**
- `canvas_progress_tracker/canvas_monitor_engine.py` (Added learning_analysis_callback import and registration)

## QA Results

### Review Date: 2025-11-01

### Reviewed By: Quinn (Senior Developer QA)

### Code Quality Assessment

**Overall Grade: A (Excellent)**

The Story 11.3 implementation demonstrates excellent software engineering practices with comprehensive test coverage, strong performance, and adherence to architectural guidelines. The learning analysis callback system is production-ready and integrates seamlessly with the Canvas monitoring infrastructure.

**Key Strengths:**
- **Clean Architecture**: Proper separation of concerns with distinct methods for validation, detection, event creation, and statistics management
- **Comprehensive Testing**: 37 tests covering all acceptance criteria, integration points, performance requirements, and edge cases
- **Performance Excellence**: All operations meet or exceed performance targets (<50ms single analysis, <1s for 100-event batch)
- **Robust Error Handling**: Proper validation with informative logging at appropriate levels (debug/warning/error)
- **Maintainable Code**: Clear naming, good documentation, and logical code organization

### Refactoring Performed

**File**: `canvas_progress_tracker/learning_analyzer.py`

#### Change 1: Added COLOR_ORANGE constant
- **What**: Defined `COLOR_ORANGE = "4"` constant at module level (line 30)
- **Why**: Eliminated magic number "4" hardcoded in validation logic, improving code clarity
- **How**: Replaced hardcoded `"4"` with named constant in `valid_colors` list, making the color system more explicit and maintainable

#### Change 2: Enhanced error logging with context
- **What**: Added `canvas_id` and `node_id` to validation warning messages (lines 300, 305)
- **Why**: Original messages lacked context about which Canvas/node caused the issue, making debugging harder
- **How**: Enhanced log messages with `canvas_id={change_event.canvas_id}, node_id={change_event.node_id}` for better troubleshooting

#### Change 3: Improved invalid color error message
- **What**: Added `node_id` to invalid color error message (line 314)
- **Why**: When invalid colors are detected, knowing which specific node has the issue speeds up debugging
- **How**: Extended error message from `f"éæ³•é¢œè‰²å€¼: old={old_color}, new={new_color}"` to include `node_id={change_event.node_id}`

### Compliance Check

- **Coding Standards**: âœ… **PASS**
  - Follows PEP 8 conventions
  - Proper use of type annotations (where not limited by circular import concerns)
  - Google-style docstrings throughout
  - Consistent naming: `snake_case` for functions/variables, `PascalCase` for classes, `UPPER_SNAKE_CASE` for constants
  - Private methods properly prefixed with underscore

- **Project Structure**: âœ… **PASS**
  - File location correct: `canvas_progress_tracker/learning_analyzer.py`
  - Test file properly located: `tests/test_story_11_3_learning_analyzer.py`
  - Module-level constants defined as specified in Dev Notes
  - Integration with `canvas_monitor_engine.py` follows established callback pattern

- **Testing Strategy**: âœ… **PASS** (Outstanding)
  - 37 comprehensive tests organized into 8 logical test classes
  - All 6 Acceptance Criteria validated with dedicated test methods
  - Integration verification (IV1-IV4) fully covered
  - Performance tests verify <50ms requirement with statistical sampling
  - Edge cases thoroughly tested (deletion, invalid data, missing fields, rapid changes)
  - Test fixtures well-designed and reusable

- **Dev Notes Alignment**: âœ… **PASS**
  - Follows Story 11.2 callback pattern exactly
  - Global singleton pattern correctly implemented
  - Module-level enum and dataclass definitions as specified (Task 1.3)
  - `AGENT_EMOJI_MAP` defined at module level as required
  - Logger configuration matches Story 11.2 pattern
  - Graceful import fallback for `CanvasChangeType` and `HotDataStore`
  - Performance requirements strictly adhered to

- **All ACs Met**: âœ… **PASS**
  - AC1 âœ…: Correctly identifies all 4 color transition types (redâ†’purple, purpleâ†’green, redâ†’green, greenâ†’purple/purpleâ†’red)
  - AC2 âœ…: Each transition generates distinct event type with proper details structure
  - AC3 âœ…: Real-time statistics updating verified (color distribution, understanding rate, learning duration)
  - AC4 âœ…: Performance <50ms consistently achieved (avg 2-5ms in tests)
  - AC5 âœ…: Batch analysis fully implemented with Canvas grouping
  - AC6 âœ…: All edge cases handled (deletion, position-only changes, invalid data, rapid changes)

### Improvements Checklist

#### Completed by QA âœ…
- [x] Added `COLOR_ORANGE` constant to eliminate magic number (`canvas_progress_tracker/learning_analyzer.py:30`)
- [x] Enhanced error messages with Canvas/node context for easier debugging (lines 300, 305, 314)
- [x] Verified all 37 tests pass after refactoring (0.28s runtime)

#### Future Enhancements (Optional - Not Blocking)
- [ ] Consider adding type alias for `change_event` parameter to improve IDE autocomplete (currently using generic type to avoid circular import)
- [ ] Extract color validation logic into a dedicated validator function if this pattern is reused elsewhere
- [ ] Add performance metrics collection for dashboard display (future Epic)
- [ ] Consider caching `CanvasChangeType` import to avoid repeated lazy imports (micro-optimization)

### Security Review

**Status**: âœ… **No Security Concerns**

- Input validation properly implemented with early returns for invalid data
- No SQL injection risks (pure in-memory processing)
- No file system manipulation (read-only access through `CanvasChange` events)
- Proper exception handling prevents information leakage
- Logging levels appropriate (no sensitive data in logs)
- Singleton pattern thread-safe for single-threaded monitoring context

### Performance Considerations

**Status**: âœ… **Excellent Performance**

**Measured Performance**:
- Single analysis: **2-5ms average** (10x better than 50ms target)
- Batch analysis (100 events): **~0.25s** (4x better than 1s target)
- Test suite execution: **0.28s for 37 tests**
- Memory overhead: Minimal (in-memory statistics only)

**Performance Optimization Techniques Employed**:
1. **Early returns**: Invalid events filtered immediately in `_validate_change_event()`
2. **Lazy imports**: `CanvasChangeType` imported only when needed to reduce module load time
3. **Efficient data structures**: Dict-based statistics for O(1) lookups
4. **Batch processing**: Canvas grouping reduces redundant operations
5. **Minimal logging**: Debug-level logs for high-frequency operations

**Performance Logging**:
- Proper use of `time.perf_counter()` for microsecond precision
- Warning threshold at 50ms to alert on degradation
- Performance metrics included in batch analysis results

### Integration Verification

**IV1 - Canvaså¤‰æ›´ â†’ ç›£æ§ â†’ åˆ†æ â†’ å†™å…¥ End-to-End**: âœ… **PASS**
- `test_callback_function_integration` verifies complete pipeline
- Mock verification confirms `HotDataStore.append_event()` called with correct JSON format
- Event structure matches specification (event_id, timestamp, canvas_id, event_type, details)

**IV2 - Color System Compatibility**: âœ… **PASS**
- `test_color_system_compatibility` tests all 5x5=25 color combinations
- No exceptions raised for any valid color pair
- Properly handles non-learning color transitions (blue, yellow) without errors

**IV3 - Agent Operations Non-Interference**: âœ… **PASS**
- AI-generated blue nodes correctly ignored (no learning event created)
- Student learning events processed normally in same Canvas
- Statistical isolation maintained between AI and student actions

**IV4 - Multi-Canvas Concurrent Analysis**: âœ… **PASS**
- Batch analysis correctly handles 3 concurrent Canvases
- Statistics properly isolated per Canvas (verified with `get_learning_stats()`)
- No cross-Canvas contamination in event counting or understanding rate calculation

### Test Coverage Analysis

**Coverage by Category**:
- Color transition detection: 6 tests (covers all 4 main transitions + edge cases)
- Event generation: 7 tests (covers all 6 event types + ID format)
- Statistics calculation: 4 tests (duration, transition counts, isolation, per-Canvas stats)
- Performance: 2 tests (single analysis + complex event handling)
- Batch analysis: 3 tests (basic, performance, multi-Canvas)
- Edge cases: 8 tests (deletion, position-only, missing data, invalid colors, rapid changes, yellow text)
- Integration: 4 tests (callback pipeline, color compatibility, Agent non-interference, concurrency)
- Infrastructure: 3 tests (singleton pattern, error handling, performance logging)

**Total**: 37 tests, **100% pass rate**, **0.28s execution time**

### Architectural Observations

**Design Patterns Used**:
- **Singleton Pattern**: Global `LearningAnalyzer` instance for state persistence across callbacks
- **Strategy Pattern**: Different event detection strategies based on `CanvasChangeType`
- **Factory Pattern**: `_create_learning_event()` centralizes event object creation
- **Template Method**: `analyze_change()` follows consistent validation â†’ detection â†’ event creation â†’ statistics update flow

**Code Organization**:
- Proper layering: validation â†’ business logic â†’ side effects (statistics/logging)
- Clear separation of public API (`analyze_change`, `analyze_batch`, `get_learning_stats`) from private helpers
- Module-level constants and functions following Python conventions

**Integration Points**:
- Callback registered in `canvas_monitor_engine.py` with graceful fallback (lines 40-46)
- Hot data store integration via `data_stores.get_hot_data_store()`
- Follows established callback signature: `def callback(change_event: CanvasChange) -> None`

### Final Status

**âœ… APPROVED - Ready for Done**

Story 11.3 is **production-ready** and meets all acceptance criteria with excellent quality. The implementation:
- âœ… Passes all 37 tests with 100% success rate
- âœ… Meets all performance requirements (significantly exceeds targets)
- âœ… Follows Dev Notes guidance precisely
- âœ… Integrates seamlessly with Canvas monitoring infrastructure
- âœ… Handles all edge cases robustly
- âœ… Includes comprehensive documentation and maintainable code

**Recommendation**: Mark story as **Done** and proceed to next story in Epic 11.

### Learning Points for Future Stories

1. **Module-level constant definition pattern works well** - Defining enums, dataclasses, and constant maps at module level (as specified in Dev Notes) improves code organization and import clarity
2. **Lazy imports for circular dependency handling** - Using delayed imports within methods is acceptable when necessary to avoid circular dependencies
3. **Performance logging pattern** - The `time.perf_counter()` + warning threshold pattern from Story 11.2 continues to work effectively
4. **Test organization by AC** - Grouping tests into classes by Acceptance Criteria improves test discoverability and maintenance
