# Story 31.A.9: Story 31.10 æ¨èé™çº§ UI æŒ‡ç¤ºå™¨åç«¯é›†æˆæµ‹è¯•

## å…ƒæ•°æ®

| å±æ€§ | å€¼ |
|------|------|
| Story ID | 31.A.9 |
| EPIC | EPIC-31 - æ£€éªŒç™½æ¿æ™ºèƒ½å¼•å¯¼ç³»ç»Ÿ |
| ä¼˜å…ˆçº§ | P1 - High |
| çŠ¶æ€ | Done |
| æ¥æº | å¯¹æŠ—æ€§å®¡æ ¸ 2026-02-10 å‘ç° #2/#7 (ğŸ”´/ğŸŸ¡ Severity) |
| ç±»å‹ | æµ‹è¯•è¡¥å…¨ / å¯è¿½æº¯æ€§ä¿®å¤ |

---

## 0. ä»£ç ç°å®æ£€æŸ¥ç»“æœ (2026-02-10)

> æœ¬ Story æ¥æºäºå¯¹æŠ—æ€§å®¡æ ¸å‘ç°ï¼š
> - #2: å¯è¿½æº¯æ€§çŸ©é˜µå°† Story 31.10 é”™è¯¯å®šä¹‰ä¸º "è·¨è¿›ç¨‹ä¼šè¯æŒä¹…åŒ–"ï¼Œæ ‡è®° 0/5 è¦†ç›–
> - #7: `test_session_persistence.py` æµ‹è¯•çš„æ˜¯ä¼šè¯çŠ¶æ€è½¬æ¢ï¼Œé 31.10 å®é™…å®šä¹‰ï¼ˆæ¨èé™çº§ UI æŒ‡ç¤ºå™¨ï¼‰
> - Story 31.10 å‰ç«¯å·²æœ‰ 13 ä¸ª Jest æµ‹è¯•ï¼Œä½†åç«¯é™çº§è·¯å¾„ç¼ºå°‘é›†æˆæµ‹è¯•

### 0.1 Story 31.10 çœŸå®å®šä¹‰

| å±æ€§ | å€¼ |
|------|------|
| æ ‡é¢˜ | æ¨èé™çº§æ¨¡å¼ UI æŒ‡ç¤ºå™¨ |
| æ¥æº | `docs/stories/31.10.story.md` |
| æ ¸å¿ƒåŠŸèƒ½ | å½“ `POST /agents/recommend-action` å¤±è´¥æ—¶ï¼Œå‰ç«¯æ˜¾ç¤º "ç¦»çº¿æ¨è" æ ‡ç­¾ |
| å‰ç«¯å®ç° | `ScoringResultPanel.ts` â€” `renderRecommendationStatus()` æ–¹æ³• |
| å‰ç«¯æµ‹è¯• | `ScoringResultPanel.test.ts` â€” 13 ä¸ªæµ‹è¯•å…¨éƒ¨é€šè¿‡ |

### 0.2 åç«¯é™çº§è§¦å‘é“¾ (å·²éªŒè¯)

```
ç”¨æˆ·æäº¤ç­”æ¡ˆ
  â†’ POST /api/v1/review/process-answer
    â†’ VerificationService.process_answer()
      â†’ _evaluate_answer_with_scoring_agent()
        â†’ æ­£å¸¸: agent_service.call_scoring() â†’ (quality, score, False)
        â†’ é™çº§: _mock_evaluate_answer() â†’ (quality, score, True)  â† degraded=True
      â†’ è¿”å› {"score": 75, "degraded": true, "action": "..."}
  â†’ å‰ç«¯æ¥æ”¶ degraded=true â†’ ScoringResultPanel æ¸²æŸ“é™çº§ UI
```

### 0.3 `test_session_persistence.py` å®é™…æµ‹è¯•å†…å®¹

| æµ‹è¯•ç±» | æµ‹è¯•æ•° | å®é™…æµ‹è¯•å†…å®¹ | ä¸ 31.10 å…³ç³» |
|--------|-------|------------|-------------|
| TestSessionStateTransitions | 5 | ä¼šè¯çŠ¶æ€æœº: in_progress â†’ paused â†’ resumed | âŒ æ— å…³ |
| TestSessionNotFound | 5 | ä¼šè¯ä¸å­˜åœ¨é”™è¯¯å¤„ç† | âŒ æ— å…³ |
| TestProgressPersistence | 4 | è¿›åº¦æ•°æ®è·¨æ“ä½œä¸€è‡´æ€§ | âŒ æ— å…³ |
| TestTimestampTracking | 3 | æš‚åœ/æ¢å¤æ—¶é—´æˆ³ | âŒ æ— å…³ |
| TestInMemoryStorage | 3 | TTLCache å†…å­˜å­˜å‚¨ç‰¹å¾ | âŒ æ— å…³ |

**ç»“è®º**: `test_session_persistence.py` çš„ 20 ä¸ªæµ‹è¯•ä¸ Story 31.10 "æ¨èé™çº§ UI æŒ‡ç¤ºå™¨" **å®Œå…¨æ— å…³**ã€‚

### 0.4 åç«¯æµ‹è¯•ç¼ºå£

| ç¼ºå¤±çš„æµ‹è¯• | å¯¹åº” 31.10 AC | é‡è¦æ€§ |
|-----------|--------------|--------|
| Agent è°ƒç”¨å¤±è´¥æ—¶ `degraded=True` æ˜¯å¦æ­£ç¡®è®¾ç½® | AC-31.10.1 å‰ç½®æ¡ä»¶ | ğŸ”´ é«˜ |
| `degraded` å­—æ®µæ˜¯å¦åœ¨ API å“åº”ä¸­æ­£ç¡®ä¼ æ’­ | AC-31.10.1 å‰ç½®æ¡ä»¶ | ğŸ”´ é«˜ |
| mock è¯„åˆ† + `degraded=True` ç»„åˆæ—¶åˆ†æ•°åˆç†æ€§ | AC-31.10.3 é‡è¯• | ğŸŸ¡ ä¸­ |
| `recommend-action` ç«¯ç‚¹å¤±è´¥æ—¶è¿”å›æ ¼å¼ | AC-31.10.1 è§¦å‘æ¡ä»¶ | ğŸŸ¡ ä¸­ |

---

## 1. é—®é¢˜æè¿°

### 1.1 æ ¸å¿ƒé—®é¢˜

Story 31.10 çš„å‰ç«¯å®ç°å’Œæµ‹è¯•å·²å®Œæˆï¼ˆ13 ä¸ª Jest æµ‹è¯•ï¼‰ï¼Œä½†åç«¯ç¼ºå°‘ä»¥ä¸‹æµ‹è¯•ï¼š

1. **é™çº§æ ‡å¿—ä¼ æ’­æµ‹è¯•**: `process_answer()` è¿”å› `degraded=True` æ—¶çš„å®Œæ•´å“åº”æ ¼å¼
2. **recommend-action é™çº§æµ‹è¯•**: ç«¯ç‚¹å¤±è´¥æ—¶çš„å“åº”æ ¼å¼ï¼ˆå‰ç«¯ä¾èµ–æ­¤æ ¼å¼å†³å®šæ˜¯å¦æ˜¾ç¤ºé™çº§ UIï¼‰
3. **ç«¯åˆ°ç«¯é™çº§é“¾æµ‹è¯•**: ä» Agent ä¸å¯ç”¨ â†’ `degraded=True` â†’ API å“åº” çš„å®Œæ•´é“¾è·¯

### 1.2 å¯è¿½æº¯æ€§å½±å“

å¯¹æŠ—æ€§å®¡æ ¸å‘ç°å¯è¿½æº¯æ€§çŸ©é˜µå°† 31.10 é”™è¯¯æ ‡è®°ä¸º "0/5 NONE âŒ"ã€‚è™½ç„¶å‰ç«¯æœ‰ 13 ä¸ªæµ‹è¯•ï¼Œä½†åç«¯ç¼ºå°‘å¯¹åº”çš„é›†æˆæµ‹è¯•æ„å‘³ç€**é™çº§ä¿¡å·çš„æ­£ç¡®æ€§æ²¡æœ‰åç«¯ä¿è¯**ã€‚

---

## 2. ç›®æ ‡

ä¸º Story 31.10 "æ¨èé™çº§ UI æŒ‡ç¤ºå™¨" è¡¥å…¨åç«¯é›†æˆæµ‹è¯•ï¼Œç¡®ä¿é™çº§ä¿¡å·ä»åç«¯æ­£ç¡®ä¼ æ’­ï¼š

| ç›®æ ‡ | è¯´æ˜ |
|------|------|
| é™çº§æ ‡å¿—æµ‹è¯• | `process_answer` åœ¨é™çº§æ—¶è¿”å› `degraded=True` |
| API ä¼ æ’­æµ‹è¯• | API ç«¯ç‚¹æ­£ç¡®é€ä¼  `degraded` å­—æ®µ |
| recommend-action æµ‹è¯• | ç«¯ç‚¹å¤±è´¥æ—¶è¿”å›å¯è¢«å‰ç«¯è¯†åˆ«çš„é”™è¯¯æ ¼å¼ |
| å¯è¿½æº¯æ€§ä¿®å¤ | ä¸ºçŸ©é˜µæä¾›æ˜ç¡®çš„æµ‹è¯•-AC æ˜ å°„ |

---

## 3. éªŒæ”¶æ ‡å‡†

### AC-31.A.9.1: `process_answer` é™çº§æ ‡å¿—æµ‹è¯•

**æ–‡ä»¶**: `backend/tests/unit/test_degraded_flag_propagation.py` (æ–°å»º)

**æµ‹è¯•åœºæ™¯**:
```python
class TestDegradedFlagPropagation:
    """Story 31.A.9: éªŒè¯ degraded æ ‡å¿—åœ¨ process_answer ä¸­æ­£ç¡®è®¾ç½®å’Œä¼ æ’­ã€‚
    æ”¯æ’‘ Story 31.10 AC-31.10.1 (é™çº§æ ‡ç­¾) çš„åç«¯å‰ç½®æ¡ä»¶ã€‚
    """

    @pytest.mark.asyncio
    async def test_degraded_true_when_agent_unavailable(
        self, verification_service_no_agent, temp_canvas_file
    ):
        """Agent ä¸å¯ç”¨æ—¶ degraded=True"""
        session = await verification_service_no_agent.start_session(
            canvas_name="test", canvas_path=temp_canvas_file
        )
        result = await verification_service_no_agent.process_answer(
            session["session_id"], "æµ‹è¯•ç­”æ¡ˆ" * 20
        )
        assert result["degraded"] is True

    @pytest.mark.asyncio
    async def test_degraded_false_when_agent_succeeds(
        self, verification_service, temp_canvas_file
    ):
        """Agent æ­£å¸¸æ—¶ degraded=False"""
        session = await verification_service.start_session(
            canvas_name="test", canvas_path=temp_canvas_file
        )
        result = await verification_service.process_answer(
            session["session_id"], "æµ‹è¯•ç­”æ¡ˆ" * 20
        )
        assert result["degraded"] is False

    @pytest.mark.asyncio
    async def test_degraded_true_when_agent_timeout(
        self, verification_service_timeout, temp_canvas_file
    ):
        """Agent è¶…æ—¶æ—¶ degraded=True"""
        session = await verification_service_timeout.start_session(
            canvas_name="test", canvas_path=temp_canvas_file
        )
        result = await verification_service_timeout.process_answer(
            session["session_id"], "æµ‹è¯•ç­”æ¡ˆ" * 20
        )
        assert result["degraded"] is True
```

**éªŒæ”¶æ¡ä»¶**:
- [x] Agent ä¸å¯ç”¨æ—¶ `degraded=True`
- [x] Agent æ­£å¸¸æ—¶ `degraded=False`
- [x] Agent è¶…æ—¶æ—¶ `degraded=True`
- [x] 3 ä¸ªåœºæ™¯éƒ½æœ‰å¯¹åº”æµ‹è¯•

---

### AC-31.A.9.2: `process_answer` é™çº§å“åº”æ ¼å¼å®Œæ•´æ€§

**æ–‡ä»¶**: åŒ `test_degraded_flag_propagation.py`

**æµ‹è¯•åœºæ™¯**:
```python
    @pytest.mark.asyncio
    async def test_degraded_response_has_required_fields(
        self, verification_service_no_agent, temp_canvas_file
    ):
        """é™çº§å“åº”åŒ…å«å‰ç«¯ ScoringResultPanel éœ€è¦çš„æ‰€æœ‰å­—æ®µ"""
        session = await verification_service_no_agent.start_session(
            canvas_name="test", canvas_path=temp_canvas_file
        )
        result = await verification_service_no_agent.process_answer(
            session["session_id"], "æµ‹è¯•ç­”æ¡ˆ" * 20
        )
        # å‰ç«¯ ScoringResultPanel ä¾èµ–è¿™äº›å­—æ®µ
        assert "score" in result
        assert "degraded" in result
        assert "action" in result
        assert isinstance(result["score"], (int, float))
        assert 0 <= result["score"] <= 100

    @pytest.mark.asyncio
    async def test_degraded_score_is_reasonable(
        self, verification_service_no_agent, temp_canvas_file
    ):
        """é™çº§è¯„åˆ†åœ¨åˆç†èŒƒå›´å†…"""
        session = await verification_service_no_agent.start_session(
            canvas_name="test", canvas_path=temp_canvas_file
        )
        # çŸ­ç­”æ¡ˆåº”å¾—ä½åˆ†
        result_short = await verification_service_no_agent.process_answer(
            session["session_id"], "çŸ­"
        )
        # ç­”å®Œä¸€é¢˜åå¯èƒ½ä¼šè¯ç»“æŸï¼Œæ–°å»ºä¸€ä¸ª
        session2 = await verification_service_no_agent.start_session(
            canvas_name="test2", canvas_path=temp_canvas_file
        )
        # é•¿ç­”æ¡ˆåº”å¾—é«˜åˆ†
        result_long = await verification_service_no_agent.process_answer(
            session2["session_id"], "è¿™æ˜¯ä¸€ä¸ªè¯¦ç»†çš„å›ç­”" * 50
        )
        assert result_short["score"] < result_long["score"]
```

**éªŒæ”¶æ¡ä»¶**:
- [x] é™çº§å“åº”åŒ…å« `score`, `degraded`, `action` å­—æ®µ
- [x] `score` åœ¨ 0-100 èŒƒå›´å†…
- [x] çŸ­ç­”æ¡ˆåˆ†æ•° < é•¿ç­”æ¡ˆåˆ†æ•°ï¼ˆmock è¯„åˆ†çš„åŸºæœ¬åˆç†æ€§ï¼‰

---

### AC-31.A.9.3: recommend-action ç«¯ç‚¹é™çº§æµ‹è¯•

**æ–‡ä»¶**: `backend/tests/integration/test_recommend_action_degradation.py` (æ–°å»º)

**å®é™…æµ‹è¯•åœºæ™¯** (Code Review 2026-02-10 å·²åŒæ­¥):
```python
class TestRecommendActionDegradation:
    """Story 31.A.9 AC-3: éªŒè¯ recommend-action ç«¯ç‚¹åœ¨ Memory ä¸å¯ç”¨æ—¶çš„è¡Œä¸ºã€‚
    æ”¯æ’‘ Story 31.10 AC-31.10.1 (é™çº§æ ‡ç­¾è§¦å‘æ¡ä»¶)ã€‚

    ä½¿ç”¨ app.dependency_overrides æ³¨å…¥ mock MemoryServiceã€‚
    """

    def test_recommend_action_graceful_on_memory_failure(self):
        """Memory ä¸å¯ç”¨æ—¶ç«¯ç‚¹ä¼˜é›…é™çº§ â€” ä»è¿”å›åŸºäºåˆ†æ•°çš„æœ‰æ•ˆæ¨è."""
        # ... DI override + TestClient(app)
        assert response.status_code == 200
        assert data["action"] in ("decompose", "explain", "next")

    def test_recommend_action_success_format(self):
        """Memory æ­£å¸¸æ—¶ç«¯ç‚¹è¿”å›å®Œæ•´æ¨è + history_context."""
        assert data["action"] == "explain"  # score=75 â†’ 60-79 range

    def test_recommend_action_response_matches_schema(self):
        """å“åº”æ ¼å¼ä¸ RecommendActionResponse schema ä¸€è‡´."""
        # éªŒè¯: action, agent, reason, priority, review_suggested, alternative_agents

    def test_recommend_action_score_thresholds(self):
        """éªŒè¯ä¸‰ä¸ªåˆ†æ•°é˜ˆå€¼: <60â†’decompose, 60-79â†’explain, â‰¥80â†’next."""
```

**éªŒæ”¶æ¡ä»¶**:
- [x] Memory å¤±è´¥æ—¶ç«¯ç‚¹ä¼˜é›…é™çº§ï¼Œè¿”å›åŸºäºåˆ†æ•°çš„æœ‰æ•ˆæ¨è (200)
- [x] Memory æ­£å¸¸æ—¶è¿”å›å®Œæ•´æ¨èæ•°æ®
- [x] å“åº”æ ¼å¼ä¸ `RecommendActionResponse` schema ä¸€è‡´ï¼ˆå« `agent` å­—æ®µéªŒè¯ï¼‰
- [x] ä¸‰ä¸ªåˆ†æ•°é˜ˆå€¼æ­£ç¡®æ˜ å°„åˆ°å¯¹åº” action

---

### AC-31.A.9.4: å¯è¿½æº¯æ€§çŸ©é˜µæ˜ å°„æ–‡æ¡£

**æ–‡ä»¶**: æµ‹è¯•æ–‡ä»¶ docstring ä¸­å†…è”æ ‡æ³¨

**é¢„æœŸæ ¼å¼**:
```python
"""
Story 31.A.9: æ¨èé™çº§ UI æŒ‡ç¤ºå™¨åç«¯é›†æˆæµ‹è¯•

å¯è¿½æº¯æ€§æ˜ å°„ (æ”¯æ’‘ Story 31.10):
- AC-31.10.1 (é™çº§æ ‡ç­¾) â†’ test_degraded_true_when_agent_unavailable
- AC-31.10.2 (æ­£å¸¸æ ‡ç­¾) â†’ test_degraded_false_when_agent_succeeds
- AC-31.10.3 (é‡è¯•èƒ½åŠ›) â†’ test_degraded_true_when_agent_timeout
- AC-31.10.4 (æ ·å¼ä¸€è‡´æ€§) â†’ N/A (å‰ç«¯ Jest æµ‹è¯•è¦†ç›–)
- AC-31.10.5 (å›é€€é€»è¾‘ä¸å˜) â†’ test_degraded_response_has_required_fields

å‰ç«¯æµ‹è¯• (å·²å­˜åœ¨):
- ScoringResultPanel.test.ts: 13 ä¸ªæµ‹è¯•è¦†ç›– AC-31.10.1~8 å‰ç«¯æ¸²æŸ“
"""
```

**éªŒæ”¶æ¡ä»¶**:
- [x] æµ‹è¯•æ–‡ä»¶ docstring åŒ…å«ä¸ Story 31.10 AC çš„æ˜¾å¼æ˜ å°„
- [x] æ¯ä¸ª AC æœ‰æ˜ç¡®çš„è¦†ç›–æ–¹ï¼ˆåç«¯æµ‹è¯•æˆ–å‰ç«¯æµ‹è¯•ï¼‰

---

## 4. æŠ€æœ¯å®ç°

### 4.1 æ–°å»ºæ–‡ä»¶æ¸…å•

| æ–‡ä»¶ | æµ‹è¯•ç±»å‹ | æµ‹è¯•æ•°é‡ |
|------|---------|---------|
| `backend/tests/unit/test_degraded_flag_propagation.py` | å•å…ƒ | 5+ |
| `backend/tests/integration/test_recommend_action_degradation.py` | é›†æˆ | 3+ |

### 4.2 Fixtures (Code Review 2026-02-10 å·²åŒæ­¥)

```python
@pytest.fixture
def temp_canvas_dir(tmp_path: Path) -> Path:
    """Create temp dir with valid .canvas file containing red/purple nodes."""
    canvas_data = {"nodes": [...], "edges": []}
    canvas_file = tmp_path / "test.canvas"
    canvas_file.write_text(json.dumps(canvas_data), encoding="utf-8")
    return tmp_path

@pytest.fixture
def verification_service_no_agent(temp_canvas_dir: Path):
    """VerificationService with agent_service=None â†’ forces degradation."""
    return VerificationService(
        agent_service=None,
        canvas_base_path=str(temp_canvas_dir),  # åŒ…å« test.canvas çš„ç›®å½•
    )

@pytest.fixture
def verification_service_timeout(temp_canvas_dir: Path):
    """VerificationService with agent that always times out."""
    mock_agent = MagicMock()
    mock_agent.call_scoring = AsyncMock(side_effect=asyncio.TimeoutError)
    return VerificationService(
        agent_service=mock_agent,
        canvas_base_path=str(temp_canvas_dir),
    )
```

---

## 5. é£é™©ä¸ç¼“è§£

| é£é™© | æ¦‚ç‡ | å½±å“ | ç¼“è§£æªæ–½ |
|------|------|------|---------|
| recommend-action ç«¯ç‚¹ç­¾åå˜åŒ– | ä½ | ä¸­ | æµ‹è¯•ä»å®é™…ä»£ç  import schema |
| ä¼šè¯ç®¡ç†å‰¯ä½œç”¨ | ä½ | ä½ | æ¯ä¸ªæµ‹è¯•ä½¿ç”¨ç‹¬ç«‹ä¼šè¯ |
| mock è¯„åˆ†é€»è¾‘å˜åŒ– | ä½ | ä½ | æµ‹è¯•æ–­è¨€èŒƒå›´è€Œéç²¾ç¡®å€¼ |

---

## 6. Definition of Done

- [x] AC-31.A.9.1: 3 ä¸ªé™çº§æ ‡å¿—åœºæ™¯æµ‹è¯•é€šè¿‡
- [x] AC-31.A.9.2: é™çº§å“åº”æ ¼å¼å®Œæ•´æ€§æµ‹è¯•é€šè¿‡
- [x] AC-31.A.9.3: recommend-action ç«¯ç‚¹é™çº§æµ‹è¯•é€šè¿‡
- [x] AC-31.A.9.4: æµ‹è¯•æ–‡ä»¶åŒ…å«å¯è¿½æº¯æ€§æ˜ å°„ docstring
- [x] æ‰€æœ‰æ–°æµ‹è¯•ä¸ Story 31.10 AC æœ‰æ˜¾å¼å¯¹åº”å…³ç³»
- [x] ç°æœ‰æµ‹è¯•æ— å›å½’

---

## 7. ä¾èµ–å…³ç³»

```
31.A.9 åç«¯é™çº§æµ‹è¯• (æœ¬ Story)
    â”œâ”€â”€ ä¾èµ– Story 31.10 (å‰ç«¯é™çº§ UI å·²å®ç°ï¼Œæœ¬ Story è¡¥åç«¯æµ‹è¯•)
    â”œâ”€â”€ å…³è” Story 31.A.8 (å¦‚æœ 31.A.8 å…ˆå®Œæˆï¼Œæµ‹è¯•å¯éªŒè¯ degraded_reason å­—æ®µ)
    â””â”€â”€ å…³è” Story 31.3 (recommend-action ç«¯ç‚¹å®ç°ï¼Œæœ¬ Story æµ‹è¯•å…¶é™çº§è¡Œä¸º)
```

---

## ç‰ˆæœ¬å†å²

| ç‰ˆæœ¬ | æ—¥æœŸ | å˜æ›´ |
|------|------|------|
| 1.0 | 2026-02-10 | åˆå§‹åˆ›å»º â€” æ¥æºäºå¯¹æŠ—æ€§å®¡æ ¸å‘ç° #2 (å¯è¿½æº¯æ€§çŸ©é˜µ 31.10 å®šä¹‰é”™è¯¯) å’Œ #7 (test_session_persistence æµ‹çš„ä¸æ˜¯ 31.10) |
| 1.1 | 2026-02-10 | å®ç°å®Œæˆ â€” 9 ä¸ªæµ‹è¯•å…¨éƒ¨é€šè¿‡ (5 å•å…ƒ + 4 é›†æˆ), å›å½’æ£€æŸ¥é€šè¿‡ |
| 1.2 | 2026-02-10 | Code Review ä¿®å¤ â€” AC-31.A.9.3 ç¤ºä¾‹ä»£ç åŒæ­¥å®é™…å®ç°, é›†æˆæµ‹è¯•ç§»é™¤å¤šä½™ asyncio æ ‡è®°, æ·»åŠ  agent å­—æ®µ schema æ–­è¨€, fixture ç¤ºä¾‹ä¿®æ­£ |

---

## 8. Dev Agent å®ç°è®°å½•

### 8.1 æ–°å»ºæ–‡ä»¶

| æ–‡ä»¶ | æµ‹è¯•ç±»å‹ | æµ‹è¯•æ•°é‡ | çŠ¶æ€ |
|------|---------|---------|------|
| `backend/tests/unit/test_degraded_flag_propagation.py` | å•å…ƒ | 5 | âœ… å…¨éƒ¨é€šè¿‡ |
| `backend/tests/integration/test_recommend_action_degradation.py` | é›†æˆ | 4 | âœ… å…¨éƒ¨é€šè¿‡ |

### 8.2 æµ‹è¯•æ¸…å•

**å•å…ƒæµ‹è¯• (test_degraded_flag_propagation.py)**:
| æµ‹è¯• | å¯¹åº” AC | è¯´æ˜ |
|------|--------|------|
| `test_degraded_true_when_agent_unavailable` | AC-31.10.1 | agent_service=None â†’ degraded=True |
| `test_degraded_false_when_agent_succeeds` | AC-31.10.2 | mock agent è¿”å› success â†’ degraded=False |
| `test_degraded_true_when_agent_timeout` | AC-31.10.3 | mock agent æŠ›å‡º TimeoutError â†’ degraded=True |
| `test_degraded_response_has_required_fields` | AC-31.10.5 | é™çº§å“åº”åŒ…å« score/degraded/action/quality/progress |
| `test_degraded_score_is_reasonable` | AC-31.10.5 | çŸ­ç­”æ¡ˆåˆ†æ•° < é•¿ç­”æ¡ˆåˆ†æ•° |

**é›†æˆæµ‹è¯• (test_recommend_action_degradation.py)**:
| æµ‹è¯• | å¯¹åº” AC | è¯´æ˜ |
|------|--------|------|
| `test_recommend_action_graceful_on_memory_failure` | AC-31.10.1 | memory_service å¤±è´¥æ—¶ä»è¿”å› 200 |
| `test_recommend_action_success_format` | AC-31.10.2 | æ­£å¸¸æƒ…å†µè¿”å› action=explain (score=75) |
| `test_recommend_action_response_matches_schema` | AC-31.10.5 | å“åº”åŒ…å«æ‰€æœ‰ schema å¿…éœ€å­—æ®µ |
| `test_recommend_action_score_thresholds` | AC-31.10.5 | <60â†’decompose, 60-79â†’explain, â‰¥80â†’next |

### 8.3 å›å½’æ£€æŸ¥

- 1680 æµ‹è¯•é€šè¿‡
- 10 ä¸ªé¢„å­˜åœ¨å¤±è´¥ (ä¸æœ¬ Story æ— å…³: agent_memory_trigger, cross_canvas_auto_discover, epic32_p0_fixes, neo4j_health, qa_38_6_scoring_reliability)
