# Story 31.8: æ¨èé™çº§æ¨¡å¼ UI æŒ‡ç¤ºå™¨

## Status

**Status**: Merged into Story 31.10

> **Redundancy Note**: Story 31.8 ä¸ Story 31.10 åŠŸèƒ½é‡å åº¦çº¦ 85%ã€‚ä¸¤è€…éƒ½å®ç° ScoringResultPanel çš„ fallback indicator UIï¼ˆç¦»çº¿æ¨èæŒ‡ç¤ºå™¨ã€é‡è¯•æŒ‰é’®ã€console.warn æ—¥å¿—ï¼‰ã€‚Story 31.10 çš„å®ç°æ›´å®Œæ•´ï¼ˆåŒ…å«åœ¨çº¿çŠ¶æ€ "æ™ºèƒ½æ¨è" æ ‡ç­¾ï¼‰ï¼Œ31.8 çš„ç‹¬ç‰¹è´¡çŒ®ï¼ˆCSS ç±»å `.fallback-indicator`ã€æ–‡æ¡ˆè°ƒæ•´ï¼‰å·²åˆå¹¶å…¥ 31.10ã€‚

## Story

**As a** Canvaså­¦ä¹ ç³»ç»Ÿç”¨æˆ·,
**I want** åœ¨ API æ¨èä¸å¯ç”¨æ—¶çœ‹åˆ°æ˜ç¡®çš„é™çº§æŒ‡ç¤º,
**so that** æˆ‘èƒ½çŸ¥é“å½“å‰çœ‹åˆ°çš„æ¨èæ˜¯ AI æ™ºèƒ½æ¨èè¿˜æ˜¯æœ¬åœ°å¤‡ç”¨é€»è¾‘ï¼Œé¿å…å¯¹æ¨èç»“æœäº§ç”Ÿé”™è¯¯ä¿¡ä»»ã€‚

## Story Context

**Existing System Integration:**

- **é›†æˆç»„ä»¶**: `ScoringResultPanel.ts` â€” è¯„åˆ†ç»“æœå¼¹çª—ï¼Œå±•ç¤ºè¯„åˆ†å’Œæ¨èæŒ‰é’®
- **æŠ€æœ¯æ ˆ**: TypeScript, Obsidian Modal API, CSS
- **ç°æœ‰æ¨¡å¼**: `renderAgentButtons()` æ¸²æŸ“æ¨èæŒ‰é’®ï¼Œ`fetchRecommendation()` è·å– API æ¨è
- **è§¦å‘ç‚¹**: `ScoringResultPanel.ts:310-331` â€” `renderCurrentResult()` ä¸­ API è°ƒç”¨å¤±è´¥åé™é»˜å›é€€

**Origin:**
- æ¥æº: Story 31.3 QA å®¡æŸ¥ [MOCK-001]
- QA Gate: `docs/qa/gates/31.3-agent-recommend-action.yml`
- Severity: MEDIUM

**é—®é¢˜ç°çŠ¶:**

```typescript
// ScoringResultPanel.ts:325-331 - å½“å‰è¡Œä¸º
if (recommendation) {
    suggestions = this.convertRecommendationToSuggestions(recommendation);
} else {
    suggestions = getSuggestionsForScore(result.score.total); // é™é»˜å›é€€ï¼Œç”¨æˆ·æ¯«ä¸çŸ¥æƒ…
}
```

ç”¨æˆ·æ— æ³•åˆ†è¾¨æ¨èæ¥æºâ€”â€”API æ™ºèƒ½æ¨èï¼ˆåŸºäºå­¦ä¹ å†å²å’Œè¶‹åŠ¿åˆ†æï¼‰ä¸æœ¬åœ°ç¡¬ç¼–ç å›é€€ï¼ˆå›ºå®šåˆ†æ•°é˜ˆå€¼ï¼‰çœ‹èµ·æ¥å®Œå…¨ä¸€æ ·ã€‚å½“åç«¯æŒ‚æ‰æ—¶ï¼Œç”¨æˆ·ä»¥ä¸ºåœ¨ç”¨ AI æ¨èï¼Œå®é™…ä¸Šæ˜¯å›ºå®šè§„åˆ™ã€‚

## Acceptance Criteria

**Functional Requirements:**

1. **AC-31.8.1**: å½“ `fetchRecommendation()` å¤±è´¥å›é€€åˆ°æœ¬åœ°é€»è¾‘æ—¶ï¼Œæ¨èåŒºåŸŸé¡¶éƒ¨æ˜¾ç¤ºé™çº§æŒ‡ç¤ºå™¨æ¨ªå¹…
   - æ–‡æ¡ˆ: "âš ï¸ ç¦»çº¿æ¨è â€” åç«¯ä¸å¯ç”¨ï¼Œä½¿ç”¨æœ¬åœ°è§„åˆ™"
   - æ ·å¼: æµ…é»„è‰²èƒŒæ™¯ + è¾¹æ¡†ï¼Œä½¿ç”¨ Obsidian å†…ç½®è­¦å‘Šå˜é‡ `--background-modifier-warning` / `--text-warning`ï¼ˆé¡¹ç›® `styles.css` å¤šå¤„å·²ä½¿ç”¨ `--text-warning`ï¼Œå¦‚ L292, L1716, L5395ï¼‰

2. **AC-31.8.2**: é™çº§æŒ‡ç¤ºå™¨åŒ…å«ä¸€ä¸ªã€Œé‡è¯•ã€æŒ‰é’®ï¼Œç‚¹å‡»åé‡æ–°è°ƒç”¨ `fetchRecommendation()` å¹¶åˆ·æ–°æ¨èåˆ—è¡¨
   - é‡è¯•æˆåŠŸ: ç§»é™¤é™çº§æŒ‡ç¤ºå™¨ï¼Œæ˜¾ç¤º API æ¨èç»“æœ
   - é‡è¯•å¤±è´¥: ä¿æŒé™çº§æŒ‡ç¤ºå™¨ï¼Œæ˜¾ç¤º Notice "åç«¯ä»ä¸å¯ç”¨"

3. **AC-31.8.3**: å½“ API æ¨èæ­£å¸¸è¿”å›æ—¶ï¼Œä¸æ˜¾ç¤ºä»»ä½•é¢å¤–æŒ‡ç¤ºå™¨ï¼ˆä¸å½“å‰è¡Œä¸ºä¸€è‡´ï¼‰

4. **AC-31.8.4**: é™çº§çŠ¶æ€é€šè¿‡ `console.warn` è®°å½•åˆ°æ§åˆ¶å°æ—¥å¿—ï¼Œæ–¹ä¾¿è°ƒè¯•

**Integration Requirements:**

5. **AC-31.8.5**: ç°æœ‰è¯„åˆ†å±•ç¤ºåŠŸèƒ½ï¼ˆæ€»åˆ†ã€ç»´åº¦åˆ†ã€è¿›åº¦æ¡ï¼‰ç»§ç»­æ­£å¸¸å·¥ä½œï¼Œä¸å—å½±å“
6. **AC-31.8.6**: ç°æœ‰ Agent æŒ‰é’®ç‚¹å‡»è¡Œä¸ºï¼ˆè°ƒç”¨ decompose/explain/clarify/memory-anchor APIï¼‰ä¸å˜
7. **AC-31.8.7**: å¯¼èˆªæŒ‰é’®ï¼ˆä¸Šä¸€ä¸ª/ä¸‹ä¸€ä¸ªï¼‰åœ¨é™çº§æ¨¡å¼ä¸‹ä»æ­£å¸¸å·¥ä½œï¼›åˆ‡æ¢èŠ‚ç‚¹æ—¶ä¼šä¸ºæ¯ä¸ªèŠ‚ç‚¹ç‹¬ç«‹æ£€æŸ¥ API å¯ç”¨æ€§

**Quality Requirements:**

8. **AC-31.8.8**: æ–°å¢è‡³å°‘ 3 ä¸ªå‰ç«¯å•å…ƒæµ‹è¯•:
   - æµ‹è¯• API å¤±è´¥æ—¶æ˜¾ç¤ºé™çº§æŒ‡ç¤ºå™¨
   - æµ‹è¯•é‡è¯•æŒ‰é’®ç‚¹å‡»åæˆåŠŸæ¢å¤
   - æµ‹è¯• API æ­£å¸¸æ—¶ä¸æ˜¾ç¤ºé™çº§æŒ‡ç¤ºå™¨
9. **AC-31.8.9**: TypeScript ç¼–è¯‘é€šè¿‡ (`tsc --noEmit`)
10. **AC-31.8.10**: ä¸å¼•å…¥æ–°çš„ npm ä¾èµ–

## Tasks / Subtasks

- [x] **Task 1: ä¿®æ”¹ `renderCurrentResult()` æ·»åŠ é™çº§æ£€æµ‹** (AC: 31.8.1, 31.8.3, 31.8.4)
  - [x] 1.1: åœ¨ `renderCurrentResult()` ä¸­å¼•å…¥ `isUsingFallback` å¸ƒå°”æ ‡å¿—
  - [x] 1.2: `fetchRecommendation()` è¿”å› `undefined` æ—¶è®¾ç½® `isUsingFallback = true`
  - [x] 1.3: åœ¨ `renderFeedback()` ä¹‹åã€`renderAgentButtons()` ä¹‹å‰æ’å…¥é™çº§æŒ‡ç¤ºå™¨æ¸²æŸ“è°ƒç”¨
  - [x] 1.4: æ·»åŠ  `console.warn('[Story 31.8] Using fallback recommendations')` æ—¥å¿—

- [x] **Task 2: å®ç° `renderFallbackIndicator()` æ–¹æ³•** (AC: 31.8.1, 31.8.2)
  - [x] 2.1: åˆ›å»º `renderFallbackIndicator(result: ScoringResultItem): void` ç§æœ‰æ–¹æ³•
  - [x] 2.2: æ¸²æŸ“é™çº§æ¨ªå¹… div (class: `fallback-indicator`) + æ–‡æ¡ˆ span
  - [x] 2.3: æ¸²æŸ“é‡è¯•æŒ‰é’® (class: `fallback-retry-button`)
  - [x] 2.4: é‡è¯•æŒ‰é’®ç‚¹å‡»äº‹ä»¶: æ¸…é™¤ `apiRecommendations` ç¼“å­˜ â†’ é‡æ–°è°ƒç”¨ `renderCurrentResult()`
  - [x] 2.5: é‡è¯•å¤±è´¥æ—¶æ˜¾ç¤º Obsidian `Notice("åç«¯ä»ä¸å¯ç”¨")`

- [x] **Task 3: æ·»åŠ  CSS æ ·å¼** (AC: 31.8.1)
  - [x] 3.1: åœ¨ `styles.css` ä¸­æ·»åŠ  `.fallback-indicator` æ ·å¼ï¼ˆä½¿ç”¨ `--background-modifier-warning` / `--text-warning` å˜é‡ï¼‰
  - [x] 3.2: æ·»åŠ  `.fallback-retry-button` æ ·å¼
  - [x] 3.3: éªŒè¯æš—è‰²/äº®è‰²ä¸»é¢˜ä¸‹æ ·å¼æ­£å¸¸

- [x] **Task 4: ç¼–å†™å•å…ƒæµ‹è¯•** (AC: 31.8.8)
  - [x] 4.1: åˆ›å»ºæµ‹è¯•æ–‡ä»¶ `tests/views/ScoringResultPanel.fallback.test.ts`
  - [x] 4.2: æµ‹è¯•ç”¨ä¾‹ 1 â€” API å¤±è´¥æ—¶ DOM ä¸­å­˜åœ¨ `.fallback-indicator` å…ƒç´ 
  - [x] 4.3: æµ‹è¯•ç”¨ä¾‹ 2 â€” é‡è¯•æˆåŠŸå `.fallback-indicator` è¢«ç§»é™¤
  - [x] 4.4: æµ‹è¯•ç”¨ä¾‹ 3 â€” API æ­£å¸¸æ—¶ä¸å­˜åœ¨ `.fallback-indicator` å…ƒç´ 

- [x] **Task 5: ç¼–è¯‘éªŒè¯å’Œå›å½’æ£€æŸ¥** (AC: 31.8.5, 31.8.6, 31.8.7, 31.8.9, 31.8.10)
  - [x] 5.1: `tsc --noEmit` é€šè¿‡
  - [x] 5.2: è¿è¡Œç°æœ‰æµ‹è¯•å¥—ä»¶ç¡®è®¤æ— å›å½’
  - [x] 5.3: ç¡®è®¤æ— æ–°å¢ npm ä¾èµ–

## Dev Notes

### SDDè§„èŒƒå‚è€ƒ (å¿…å¡«)

**APIç«¯ç‚¹** (æœ¬ Story ä¸æ–°å¢ç«¯ç‚¹ï¼Œä½†ä¾èµ–ä»¥ä¸‹ç«¯ç‚¹):

- ç«¯ç‚¹: `POST /agents/recommend-action`
- è§„èŒƒæ¥æº: `[Source: specs/api/agent-api.openapi.yml#L183-L240]`
- æœ¬ Story ä¸ä¿®æ”¹è¯¥ç«¯ç‚¹ï¼Œä»…åœ¨å‰ç«¯ `fetchRecommendation()` å¤±è´¥æ—¶æ·»åŠ  UI æŒ‡ç¤º
- å“åº” Schema: `RecommendActionResponse` â€” å« `action`, `reason`, `alternative_agents`, `review_suggested` å­—æ®µ

**æ•°æ®Schema** (æ— æ–°å¢ï¼Œå¼•ç”¨ç°æœ‰):

- `RecommendActionResponse` `[Source: specs/data/recommend-action-response.schema.json]`
- å‰ç«¯ç±»å‹å®šä¹‰: `RecommendActionResponse` in `canvas-progress-tracker/obsidian-plugin/src/api/types.ts`

**è¡Œä¸ºè§„èŒƒ**: æ—  Gherkin spec æ¶‰åŠï¼ˆçº¯ UI æ”¹åŠ¨ï¼‰

### ADRå†³ç­–å…³è” (å¿…å¡«)

| ADRç¼–å· | å†³ç­–æ ‡é¢˜ | å¯¹Storyçš„å½±å“ |
|---------|----------|---------------|
| ADR-0001 | ä½¿ç”¨Obsidian Canvas | UI æ”¹åŠ¨ä½¿ç”¨ Obsidian Modal API (`contentEl.createEl`)ï¼ŒCSS ä½¿ç”¨ Obsidian å˜é‡ |

**å…³é”®çº¦æŸ** (ä»ADR Consequencesæå–):
- çº¦æŸ1: æ‰€æœ‰ UI å…ƒç´ å¿…é¡»é€šè¿‡ Obsidian API åˆ›å»ºï¼Œä¸èƒ½ç›´æ¥æ“ä½œ innerHTML `[Source: ADR-0001]`
- çº¦æŸ2: CSS æ ·å¼å¿…é¡»ä½¿ç”¨ Obsidian CSS å˜é‡ä»¥å…¼å®¹æš—è‰²/äº®è‰²ä¸»é¢˜ `[Source: ADR-0001]`

> æœ¬ Story ä¸ºçº¯å‰ç«¯ UI æŒ‡ç¤ºå™¨ï¼Œä¸æ¶‰åŠ LangGraphã€Graphitiã€é”™è¯¯é‡è¯•ç­‰åç«¯æ¶æ„å†³ç­–ï¼Œå› æ­¤å…¶ä½™ ADR ä¸é€‚ç”¨ã€‚

### Integration Approach

åœ¨ `renderCurrentResult()` ä¸­å¼•å…¥ `isUsingFallback` æ ‡å¿—:

```typescript
private async renderCurrentResult(): Promise<void> {
    // ...
    let suggestions: AgentSuggestion[];
    let isUsingFallback = false;
    const recommendation = await this.fetchRecommendation(result);

    if (recommendation) {
        suggestions = this.convertRecommendationToSuggestions(recommendation);
    } else {
        suggestions = getSuggestionsForScore(result.score.total);
        isUsingFallback = true;
    }

    // ... existing renders ...

    // æ–°å¢: é™çº§æŒ‡ç¤ºå™¨
    if (isUsingFallback) {
        this.renderFallbackIndicator(result);
    }

    this.renderAgentButtons(result, suggestions);
    // ...
}
```

æ–°å¢ `renderFallbackIndicator()` æ–¹æ³•:

```typescript
private renderFallbackIndicator(result: ScoringResultItem): void {
    const { contentEl } = this;
    const indicator = contentEl.createEl('div', {
        cls: 'fallback-indicator'
    });

    indicator.createEl('span', {
        text: 'âš ï¸ ç¦»çº¿æ¨è â€” åç«¯ä¸å¯ç”¨ï¼Œä½¿ç”¨æœ¬åœ°è§„åˆ™',
        cls: 'fallback-text',
    });

    const retryBtn = indicator.createEl('button', {
        text: 'ğŸ”„ é‡è¯•',
        cls: 'fallback-retry-button',
    });

    retryBtn.addEventListener('click', async () => {
        // æ¸…é™¤ç¼“å­˜ï¼Œå¼ºåˆ¶é‡æ–°è¯·æ±‚
        this.apiRecommendations.delete(result.nodeId);
        await this.renderCurrentResult();
    });
}
```

### CSS Styles

```css
.fallback-indicator {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 8px 12px;
    margin: 8px 0;
    background-color: var(--background-modifier-warning);
    border: 1px solid var(--text-warning);
    border-radius: 6px;
    font-size: 0.85em;
}

.fallback-retry-button {
    margin-left: 12px;
    padding: 4px 12px;
    cursor: pointer;
    border-radius: 4px;
}
```

### Existing Pattern Reference

- `renderFeedback()` æ–¹æ³• (`ScoringResultPanel.ts:434-444`) â€” æ¡ä»¶æ¸²æŸ“ UI åŒºå—çš„ç°æœ‰æ¨¡å¼
- `getScoreColorClass()` â€” ä½¿ç”¨ CSS ç±»åæ§åˆ¶æ ·å¼çš„ç°æœ‰æ¨¡å¼
- Obsidian CSS å˜é‡: `--background-modifier-warning`, `--text-warning` â€” å·²æœ‰çš„è­¦å‘Šé…è‰²

### Key Constraints

- **ä¸ä¿®æ”¹åç«¯**: æ­¤ Story ä»…é™å‰ç«¯ UI æ”¹åŠ¨
- **ä¸æ”¹å˜å›é€€é€»è¾‘æœ¬èº«**: å›é€€è¡Œä¸ºä¿æŒä¸å˜ï¼Œåªæ·»åŠ  UI å¯è§æ€§
- **CSS ä½¿ç”¨ Obsidian å˜é‡**: ç¡®ä¿åœ¨æš—è‰²/äº®è‰²ä¸»é¢˜ä¸‹éƒ½èƒ½æ­£å¸¸æ˜¾ç¤º
- **ç¼“å­˜è¡Œä¸º**: é‡è¯•æ—¶éœ€è¦æ¸…é™¤ `apiRecommendations` å¯¹åº” key çš„ç¼“å­˜

### Files to Modify

| æ–‡ä»¶ | æ”¹åŠ¨ç±»å‹ | è¯´æ˜ |
|------|---------|------|
| `canvas-progress-tracker/obsidian-plugin/src/views/ScoringResultPanel.ts` | ä¿®æ”¹ | æ·»åŠ  `renderFallbackIndicator()` æ–¹æ³•ï¼Œä¿®æ”¹ `renderCurrentResult()` |
| `canvas-progress-tracker/obsidian-plugin/styles.css` | ä¿®æ”¹ | æ·»åŠ  `.fallback-indicator` ç›¸å…³æ ·å¼ |
| `canvas-progress-tracker/obsidian-plugin/tests/views/ScoringResultPanel.fallback.test.ts` | æ–°å¢ | é™çº§æŒ‡ç¤ºå™¨å•å…ƒæµ‹è¯• |

### Testing

**æµ‹è¯•æ¡†æ¶**:
- é¡¹ç›®å‰ç«¯åŒæ—¶é…ç½®äº† Jest (`package.json: "test": "jest"`, `jest.config.js`) å’Œ Vitest (`vitest.config.ts`)
- `tests/setup.ts` ä½¿ç”¨ Jest API (`jest.spyOn`, `jest.setTimeout`)
- æ¨èä½¿ç”¨ **Jest** (ä¸ package.json scripts å’Œç°æœ‰ 50+ æµ‹è¯•ä¸€è‡´)

**æµ‹è¯•æ–‡ä»¶ä½ç½®**:
- `canvas-progress-tracker/obsidian-plugin/tests/views/ScoringResultPanel.fallback.test.ts`
- å‚è€ƒç°æœ‰ view æµ‹è¯•: `tests/views/ProgressTrackerView.test.ts`, `tests/views/ReviewDashboardView.test.ts`

**Mock ä¾èµ–**:
- Obsidian API mock: `tests/__mocks__/obsidian.ts` (å·²æœ‰)
- `ApiClient` éœ€ mock `recommendAction()` æ–¹æ³• (å‚è€ƒ `tests/api/ApiClient.test.ts`)

**æµ‹è¯•è¦æ±‚**:
1. è‡³å°‘ 3 ä¸ªæµ‹è¯•ç”¨ä¾‹ (AC-31.8.8)
2. ä½¿ç”¨ç°æœ‰ `tests/__mocks__/obsidian.ts` mock Obsidian API
3. æµ‹è¯• DOM å…ƒç´ çš„åˆ›å»º/ç§»é™¤ï¼Œä¸éœ€è¦çœŸå® API è°ƒç”¨

## Definition of Done

- [x] é™çº§æŒ‡ç¤ºå™¨åœ¨ API å¤±è´¥æ—¶æ­£ç¡®æ˜¾ç¤º (AC: 31.8.1)
- [x] é‡è¯•æŒ‰é’®åŠŸèƒ½æ­£å¸¸ï¼ˆæˆåŠŸæ¢å¤ / å¤±è´¥ä¿æŒæŒ‡ç¤ºå™¨ï¼‰(AC: 31.8.2)
- [x] API æ­£å¸¸æ—¶æ— é¢å¤– UI å…ƒç´  (AC: 31.8.3)
- [x] é™çº§æ—¥å¿—è¾“å‡ºåˆ° console.warn (AC: 31.8.4)
- [x] å¯¼èˆªåˆ‡æ¢èŠ‚ç‚¹æ—¶é™çº§çŠ¶æ€æ­£ç¡®æ›´æ–° (AC: 31.8.7)
- [x] TypeScript ç¼–è¯‘é€šè¿‡ (AC: 31.8.9)
- [x] 3+ ä¸ªå•å…ƒæµ‹è¯•é€šè¿‡ (AC: 31.8.8) â€” 8 ä¸ªæµ‹è¯•å…¨éƒ¨é€šè¿‡
- [x] ç°æœ‰åŠŸèƒ½æ— å›å½’ï¼šè¯„åˆ†ã€æŒ‰é’®ã€å¯¼èˆª (AC: 31.8.5, 31.8.6) â€” views/ ä¸‹ 122 ä¸ªæµ‹è¯•å…¨éƒ¨é€šè¿‡
- [x] æš—è‰²/äº®è‰²ä¸»é¢˜ä¸‹æ ·å¼æ­£å¸¸ (AC: 31.8.1) â€” ä½¿ç”¨ Obsidian CSS å˜é‡ `--background-modifier-warning` / `--text-warning`
- [x] æ— æ–°å¢ npm ä¾èµ– (AC: 31.8.10)

## Risk and Compatibility Check

**Minimal Risk Assessment:**

| ç»´åº¦ | è¯„ä¼° |
|------|------|
| **Primary Risk** | CSS æ ·å¼åœ¨ä¸åŒ Obsidian ä¸»é¢˜ä¸‹å¯èƒ½ä¸ä¸€è‡´ |
| **Mitigation** | ä½¿ç”¨ Obsidian å†…ç½® CSS å˜é‡è€Œéç¡¬ç¼–ç é¢œè‰² |
| **Rollback** | åˆ é™¤ `renderFallbackIndicator()` æ–¹æ³• + ç§»é™¤ CSS å³å¯å›é€€ï¼Œæ”¹åŠ¨å®Œå…¨éš”ç¦» |

**Compatibility Verification:**

- [x] ä¸æ”¹å˜ç°æœ‰ API æ¥å£
- [x] ä¸å¢åŠ æ•°æ®åº“å˜æ›´
- [x] UI æ”¹åŠ¨éµå¾ªç°æœ‰è®¾è®¡æ¨¡å¼ï¼ˆObsidian Modal + CSS å˜é‡ï¼‰
- [x] æ€§èƒ½å½±å“å¯å¿½ç•¥ï¼ˆä»…å¢åŠ ä¸€ä¸ª DOM å…ƒç´ å’Œä¸€ä¸ªäº‹ä»¶ç›‘å¬å™¨ï¼‰

## Dependencies

- **ä¾èµ– Story 31.3**: åç«¯ `POST /agents/recommend-action` ç«¯ç‚¹å·²å®ç°
- **ä¸é˜»å¡å…¶ä»– Story**: çº¯å‰ç«¯ UX å¢å¼º

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-05 | 1.0 | Initial story creation from QA finding [MOCK-001] | PM Agent (John) |
| 2026-02-05 | 1.1 | **PO Validation Fix**: è¡¥å…… Tasks/Subtasks + SDDè§„èŒƒå‚è€ƒ + ADRå†³ç­–å…³è” + Testing section + QA Results å ä½ç¬¦ã€‚ä¿®æ­£ AC-31.8.1 `score-medium` ä¸å‡†ç¡®å¼•ç”¨ä¸º Obsidian CSS å˜é‡ã€‚AC 5-10 ç»Ÿä¸€ç¼–å·ã€‚DoD å…³è” ACã€‚ | PO Agent (Sarah) |
| 2026-02-05 | 2.0 | **Implementation Complete**: æ‰€æœ‰ 5 ä¸ª Task å®Œæˆï¼Œ8 ä¸ªå•å…ƒæµ‹è¯•é€šè¿‡ï¼Œtsc ç¼–è¯‘é€šè¿‡ï¼Œæ— å›å½’ã€‚Story 31.10 å·²æœ‰ `renderRecommendationStatus()`/`handleRetry()` æ¡†æ¶ï¼Œæœ¬ Story é€‚é…ç¦»çº¿çŠ¶æ€ CSS ç±»åã€æ–‡æ¡ˆã€æ—¥å¿—çº§åˆ«ã€‚ | Dev Agent (James) |

## Dev Agent Record

### Agent Model Used

Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References

- `tsc --noEmit`: ç¼–è¯‘é€šè¿‡ï¼Œæ— é”™è¯¯
- `jest --testPathPattern="ScoringResultPanel"`: 21/21 é€šè¿‡ (Story 31.8: 8, Story 31.10: 13)
- `jest --testPathPattern="views/"`: 122/122 é€šè¿‡ï¼Œæ— å›å½’
- å…¨é‡æµ‹è¯•: 1553/1641 é€šè¿‡ï¼Œ88 ä¸ªé¢„å­˜å¤±è´¥ä¸æœ¬ Story æ— å…³ï¼ˆESM transform é…ç½®é—®é¢˜ï¼‰

### Completion Notes List

1. **å®ç°æ–¹å¼è°ƒæ•´**: Story 31.10 å·²åœ¨ `ScoringResultPanel.ts` ä¸­é¢„å…ˆå®ç°äº† `renderRecommendationStatus()` å’Œ `handleRetry()` æ–¹æ³•ã€‚æœ¬ Story åœ¨æ­¤åŸºç¡€ä¸Šé€‚é…ï¼šå°†ç¦»çº¿çŠ¶æ€çš„ CSS ç±»åæ”¹ä¸º `fallback-indicator`/`fallback-text`/`fallback-retry-button`ï¼Œæ–‡æ¡ˆæ”¹ä¸º "âš ï¸ ç¦»çº¿æ¨è â€” åç«¯ä¸å¯ç”¨ï¼Œä½¿ç”¨æœ¬åœ°è§„åˆ™"ï¼Œæ—¥å¿—æ”¹ä¸º `console.warn`ï¼Œé‡è¯•å¤±è´¥ Notice æ”¹ä¸º "åç«¯ä»ä¸å¯ç”¨"ã€‚
2. **æµ‹è¯•è¦†ç›–**: æ–°å¢ 8 ä¸ªæµ‹è¯•ç”¨ä¾‹ï¼ˆè¶…å‡º AC-31.8.8 è¦æ±‚çš„ 3 ä¸ªï¼‰ï¼Œè¦†ç›–å…¨éƒ¨åŠŸèƒ½ AC å’Œé›†æˆ ACã€‚
3. **CSS ä¸»é¢˜å…¼å®¹**: ä½¿ç”¨ `--background-modifier-warning` å’Œ `--text-warning` Obsidian CSS å˜é‡ï¼Œç¡®ä¿æš—è‰²/äº®è‰²ä¸»é¢˜å…¼å®¹ã€‚
4. **é‡è¯•é˜²æŠ–**: `handleRetry()` å†…ç½® 2 ç§’é˜²æŠ–ï¼ˆ`lastRetryTime` å­—æ®µï¼‰ï¼Œé˜²æ­¢ç”¨æˆ·å¿«é€Ÿé‡å¤ç‚¹å‡»ã€‚

### File List

| æ–‡ä»¶ | æ”¹åŠ¨ç±»å‹ | è¯´æ˜ |
|------|---------|------|
| `canvas-progress-tracker/obsidian-plugin/src/views/ScoringResultPanel.ts` | ä¿®æ”¹ | `renderRecommendationStatus()` ç¦»çº¿åˆ†æ”¯ä½¿ç”¨ Story 31.8 CSS ç±»åå’Œæ–‡æ¡ˆï¼›`console.warn` æ—¥å¿—ï¼›`handleRetry()` å¤±è´¥ Notice "åç«¯ä»ä¸å¯ç”¨" |
| `canvas-progress-tracker/obsidian-plugin/styles.css` | ä¿®æ”¹ | æ–°å¢ `.fallback-indicator`ã€`.fallback-text`ã€`.fallback-retry-button` æ ·å¼å— |
| `canvas-progress-tracker/obsidian-plugin/tests/views/ScoringResultPanel.fallback.test.ts` | æ–°å¢ | 8 ä¸ªæµ‹è¯•ç”¨ä¾‹è¦†ç›– AC-31.8.1 ~ AC-31.8.7 |
| `canvas-progress-tracker/obsidian-plugin/tests/views/ScoringResultPanel.test.ts` | ä¿®æ”¹ | æ›´æ–° CSS é€‰æ‹©å™¨åŒ¹é…é‡å‘½åçš„ç±»å |

## QA Results

### Review Date: 2026-02-05

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

å®ç°è´¨é‡ä¼˜ç§€ã€‚Story 31.8 å·§å¦™å¤ç”¨äº† Story 31.10 å·²æœ‰çš„ `renderRecommendationStatus()` / `handleRetry()` åŸºç¡€æ¶æ„ï¼Œä»…é€‚é… CSS ç±»åã€æ–‡æ¡ˆå’Œæ—¥å¿—çº§åˆ«ï¼Œé¿å…äº†ä»£ç é‡å¤ã€‚

å…³é”®è®¾è®¡äº®ç‚¹ï¼š
- `handleRetry()` çš„åŒå±‚ Notice ç­–ç•¥è®¾è®¡åˆç†ï¼š`renderCurrentResult()` å†…çš„ Notice å¤„ç† API å¤±è´¥ï¼ˆå¸¸è§„è·¯å¾„ï¼‰ï¼Œ`handleRetry()` catch å—å¤„ç† DOM æ¸²æŸ“é”™è¯¯ï¼ˆå¼‚å¸¸è·¯å¾„ï¼‰ï¼Œäº’ä¸é‡å 
- `isRetrying` æ ‡å¿—åœ¨ `renderCurrentResult()` æœ«å°¾ (L340) ç»Ÿä¸€ resetï¼Œé˜²æ­¢çŠ¶æ€æ³„æ¼
- 2 ç§’é˜²æŠ– + `btn.disabled` åŒé‡ä¿æŠ¤é˜²æ­¢é‡å¤ç‚¹å‡»
- `contentEl.empty()` åœ¨æ¯æ¬¡é‡æ¸²æŸ“æ—¶æ¸…ç†æ—§ DOMï¼Œæ— å†…å­˜æ³„æ¼é£é™©

### Refactoring Performed

æ— éœ€é‡æ„ã€‚ä»£ç è´¨é‡å·²è¾¾åˆ°å¯äº¤ä»˜æ ‡å‡†ã€‚

### Compliance Check

- Coding Standards: âœ“ â€” ä½¿ç”¨ Obsidian createEl API (é innerHTML)ï¼ŒTypeScript ç±»å‹å®Œæ•´
- Project Structure: âœ“ â€” æµ‹è¯•æ–‡ä»¶ä½äº `tests/views/`ï¼ŒCSS åœ¨ `styles.css`ï¼Œç¬¦åˆé¡¹ç›®ç»“æ„
- Testing Strategy: âœ“ â€” 8 ä¸ªå•å…ƒæµ‹è¯•è¦†ç›–å…¨éƒ¨åŠŸèƒ½ ACï¼Œä½¿ç”¨ Jest + jsdom
- All ACs Met: âœ“ â€” 10/10 AC å…¨éƒ¨æœ‰å¯¹åº”å®ç°å’Œæµ‹è¯•è¦†ç›–

### Improvements Checklist

- [x] é™çº§æŒ‡ç¤ºå™¨æ­£ç¡®æ¸²æŸ“ (.fallback-indicator + .fallback-text)
- [x] é‡è¯•æŒ‰é’®æ­£å¸¸å·¥ä½œï¼ˆæˆåŠŸç§»é™¤æŒ‡ç¤ºå™¨ / å¤±è´¥æ˜¾ç¤º Noticeï¼‰
- [x] console.warn æ—¥å¿—åŒ…å« Story 31.8 æ ‡è¯†
- [x] CSS ä½¿ç”¨ Obsidian å˜é‡å…¼å®¹æš—è‰²/äº®è‰²ä¸»é¢˜
- [x] å¯¼èˆªåˆ‡æ¢èŠ‚ç‚¹æ—¶ç‹¬ç«‹æ£€æŸ¥ API çŠ¶æ€
- [x] 8 ä¸ªæµ‹è¯•è¦†ç›–å…¨éƒ¨åŠŸèƒ½å’Œé›†æˆ AC
- [ ] æå– `addObsidianMethods()` æµ‹è¯• helper åˆ°å…±äº«æ–‡ä»¶ `tests/__helpers__/obsidian-dom.ts`ï¼ˆå½“å‰åœ¨ fallback.test.ts å’Œ ScoringResultPanel.test.ts ä¸­é‡å¤ï¼Œçº¦ 50 è¡Œï¼‰â€” ä¸é˜»å¡ï¼Œæœªæ¥ä¼˜åŒ–é¡¹

### Security Review

æ— å®‰å…¨é—®é¢˜ã€‚çº¯ UI æ”¹åŠ¨ï¼Œæ— ç”¨æˆ·è¾“å…¥å¤„ç†ï¼Œæ—  innerHTML ä½¿ç”¨ï¼Œæ‰€æœ‰ DOM é€šè¿‡ Obsidian createEl API åˆ›å»ºã€‚

### Performance Considerations

å½±å“å¯å¿½ç•¥ã€‚ä»…å¢åŠ  1 ä¸ª DOM å…ƒç´ å’Œ 1 ä¸ªäº‹ä»¶ç›‘å¬å™¨ã€‚é‡è¯•æŒ‰é’®å†…ç½® 2 ç§’é˜²æŠ–ï¼Œé˜²æ­¢è¿‡åº¦ API è°ƒç”¨ã€‚

### Files Modified During Review

æ— æ–‡ä»¶ä¿®æ”¹ã€‚

### Gate Status

Gate: PASS â†’ docs/qa/gates/31.8-fallback-indicator-ui.yml

### Recommended Status

âœ… Ready for Done â€” æ‰€æœ‰ 10 ä¸ª AC å·²å®ç°å¹¶æµ‹è¯•è¦†ç›–ï¼Œæ— é˜»å¡é—®é¢˜ã€‚
(Story owner decides final status)
