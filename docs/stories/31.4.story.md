# Story 31.4: æ£€éªŒé—®é¢˜å»é‡ä¸å†å²æŸ¥è¯¢

## Status

**Status**: Review

## Story

**As a** Canvaså­¦ä¹ ç³»ç»Ÿç”¨æˆ·,
**I want** åœ¨æ£€éªŒç™½æ¿ç”Ÿæˆæ—¶è‡ªåŠ¨å»é‡å·²é—®è¿‡çš„é—®é¢˜ï¼Œå¹¶èƒ½æŸ¥è¯¢æ¦‚å¿µçš„æ£€éªŒå†å²,
**so that** æˆ‘èƒ½è·å¾—å¤šè§’åº¦çš„æ£€éªŒé—®é¢˜ï¼Œé¿å…é‡å¤æé—®ï¼ŒåŒæ—¶è¿½è¸ªæ¦‚å¿µæŒæ¡è¿›åº¦

## Acceptance Criteria

1. **AC-31.4.1**: é—®é¢˜ç”Ÿæˆå‰æŸ¥è¯¢Graphitiæ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ç›¸åŒæ¦‚å¿µçš„éªŒè¯é—®é¢˜
2. **AC-31.4.2**: è‹¥å­˜åœ¨ï¼Œç”Ÿæˆæ–°è§’åº¦é—®é¢˜ï¼ˆåº”ç”¨ã€æ¯”è¾ƒã€åä¾‹ç­‰ï¼‰æˆ–è¿”å›å·²æœ‰é—®é¢˜
3. **AC-31.4.3**: æ–°å¢ `GET /verification/history/{concept}` ç«¯ç‚¹æŸ¥è¯¢æ¦‚å¿µæ£€éªŒå†å²
4. **AC-31.4.4**: å†å²æ•°æ®åŒ…å«ï¼šé—®é¢˜å†…å®¹ã€ç”¨æˆ·å›ç­”ã€å¾—åˆ†ã€æ—¶é—´æˆ³

## Tasks / Subtasks

- [ ] **Task 0: æ›´æ–°OpenAPIè§„èŒƒ (SoTä¼˜å…ˆ)** (AC: 31.4.3)
  - [ ] 0.1: åœ¨ `specs/api/review-api.openapi.yml` æ·»åŠ  `/verification/history/{concept}` ç«¯ç‚¹å®šä¹‰
  - [ ] 0.2: æ·»åŠ  `VerificationHistoryResponse` schema åˆ° components/schemas
  - [ ] 0.3: éªŒè¯OpenAPIè¯­æ³•æ­£ç¡® (`npm run validate:openapi` æˆ–ç­‰æ•ˆ)
  - [ ] 0.4: æäº¤specæ›´æ–°åå†å¼€å§‹å®ç°

- [ ] **Task 1: æ‰©å±•GraphitiTemporalClientæ·»åŠ æ£€éªŒé—®é¢˜æŸ¥è¯¢** (AC: 31.4.1)
  - [ ] 1.1: åœ¨ `src/agentic_rag/clients/graphiti_temporal_client.py` æ·»åŠ  `search_verification_questions()` æ–¹æ³•
  - [ ] 1.2: ä½¿ç”¨Graphiti hybrid searchæŸ¥è¯¢åŒæ¦‚å¿µçš„å†å²é—®é¢˜
  - [ ] 1.3: æ”¯æŒæŒ‰ concept_name, canvas_name, time_range è¿‡æ»¤
  - [ ] 1.4: è¿”å›ç»“æ„åŒ…å«: question_id, question_text, asked_at, score (å¦‚æœ‰)

- [ ] **Task 2: å®ç°é—®é¢˜å»é‡é€»è¾‘** (AC: 31.4.1, 31.4.2)
  - [ ] 2.1: åœ¨ `verification_service.py` ä¿®æ”¹é—®é¢˜ç”Ÿæˆæµç¨‹
  - [ ] 2.2: è°ƒç”¨ `graphiti_client.search_verification_questions()` æŸ¥è¯¢å†å²
  - [ ] 2.3: å¦‚æœæ— å†å²é—®é¢˜ â†’ ç”Ÿæˆæ ‡å‡†éªŒè¯é—®é¢˜ (what is X?)
  - [ ] 2.4: å¦‚æœæœ‰å†å²é—®é¢˜ â†’ è°ƒç”¨ `generate_alternative_question()` ç”Ÿæˆæ–°è§’åº¦é—®é¢˜
  - [ ] 2.5: æ–°è§’åº¦ç±»å‹: åº”ç”¨é¢˜ã€å¯¹æ¯”é¢˜ã€åä¾‹é¢˜ã€ç»¼åˆé¢˜

- [ ] **Task 3: å®ç°æ–°è§’åº¦é—®é¢˜ç”Ÿæˆ** (AC: 31.4.2)
  - [ ] 3.1: åˆ›å»º `_generate_alternative_question()` ç§æœ‰æ–¹æ³•
  - [ ] 3.2: ä½¿ç”¨Gemini APIç”Ÿæˆä¸åŒè§’åº¦çš„é—®é¢˜
  - [ ] 3.3: Promptæ¨¡æ¿åŒ…å«å†å²é—®é¢˜ä¸Šä¸‹æ–‡é¿å…é‡å¤
  - [ ] 3.4: æ”¯æŒé…ç½®é—®é¢˜è§’åº¦ä¼˜å…ˆçº§ (åº”ç”¨ > å¯¹æ¯” > åä¾‹)

- [ ] **Task 4: æ–°å¢éªŒè¯å†å²æŸ¥è¯¢ç«¯ç‚¹** (AC: 31.4.3, 31.4.4)
  - [ ] 4.1: åœ¨ `backend/app/api/v1/endpoints/verification.py` æ·»åŠ æ–°ç«¯ç‚¹
  - [ ] 4.2: è·¯å¾„: `GET /verification/history/{concept}`
  - [ ] 4.3: Queryå‚æ•°: `canvas_name` (å¯é€‰), `limit` (é»˜è®¤10), `offset` (é»˜è®¤0)
  - [ ] 4.4: å“åº”åŒ…å«åˆ†é¡µä¿¡æ¯å’Œå†å²è®°å½•åˆ—è¡¨

- [ ] **Task 5: å®šä¹‰API Schema** (AC: 31.4.3, 31.4.4)
  - [ ] 5.1: åˆ›å»º `specs/data/verification-history-response.schema.json`
  - [ ] 5.2: åœ¨ `backend/app/models/` æ·»åŠ Pydanticæ¨¡å‹
  - [ ] 5.3: æ›´æ–° `specs/api/review-api.openapi.yml` æ·»åŠ æ–°ç«¯ç‚¹å®šä¹‰

- [ ] **Task 6: å­˜å‚¨æ£€éªŒé—®é¢˜åˆ°Graphiti** (AC: 31.4.1)
  - [ ] 6.1: åœ¨é—®é¢˜ç”Ÿæˆåè°ƒç”¨ `graphiti_client.add_verification_question()`
  - [ ] 6.2: Episodeå†…å®¹æ ¼å¼: `"éªŒè¯é—®é¢˜: {question} | æ¦‚å¿µ: {concept} | Canvas: {canvas_name}"`
  - [ ] 6.3: ä½¿ç”¨ group_id æ”¯æŒå¤šå­¦ç§‘éš”ç¦»

- [ ] **Task 7: å•å…ƒæµ‹è¯•** (æ‰€æœ‰AC)
  - [ ] 7.1: æµ‹è¯• `search_verification_questions()` è¿”å›æ ¼å¼
  - [ ] 7.2: æµ‹è¯•é—®é¢˜å»é‡é€»è¾‘ (æ— å†å²/æœ‰å†å²)
  - [ ] 7.3: æµ‹è¯•æ–°è§’åº¦é—®é¢˜ç”Ÿæˆ
  - [ ] 7.4: æµ‹è¯• `GET /verification/history/{concept}` ç«¯ç‚¹
  - [ ] 7.5: æµ‹è¯•åˆ†é¡µåŠŸèƒ½
  - [ ] 7.6: æµ‹è¯•è¦†ç›–ç‡ >= 80%

## Dev Notes

### SDDè§„èŒƒå‚è€ƒ (å¿…å¡«)

**APIç«¯ç‚¹** (æ–°å¢):

æ­¤ç«¯ç‚¹éœ€è¦åœ¨ `specs/api/review-api.openapi.yml` ä¸­æ·»åŠ :

```yaml
# æ–°å¢è·¯å¾„å®šä¹‰
/verification/history/{concept}:
  get:
    tags: [verification]
    summary: Get verification history for a concept
    description: |
      æŸ¥è¯¢æŒ‡å®šæ¦‚å¿µçš„æ£€éªŒå†å²è®°å½•ã€‚

      è¿”å›æ•°æ®åŒ…å«:
      - æ£€éªŒé—®é¢˜å†…å®¹
      - ç”¨æˆ·å›ç­” (å¦‚æœ‰)
      - å¾—åˆ† (å¦‚æœ‰)
      - æ—¶é—´æˆ³

      æ”¯æŒæŒ‰Canvasè¿‡æ»¤å’Œåˆ†é¡µã€‚
    operationId: getVerificationHistory
    parameters:
      - name: concept
        in: path
        required: true
        description: æ¦‚å¿µåç§° (URL encoded)
        schema:
          type: string
          example: "é€†å¦å‘½é¢˜"
      - name: canvas_name
        in: query
        description: æŒ‰Canvasåç§°è¿‡æ»¤
        schema:
          type: string
          example: "ç¦»æ•£æ•°å­¦.canvas"
      - name: limit
        in: query
        description: è¿”å›æ•°é‡é™åˆ¶
        schema:
          type: integer
          default: 10
          maximum: 100
      - name: offset
        in: query
        description: åˆ†é¡µåç§»é‡
        schema:
          type: integer
          default: 0
    responses:
      '200':
        description: æ£€éªŒå†å²è®°å½•
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/VerificationHistoryResponse'
      '404':
        description: æ¦‚å¿µä¸å­˜åœ¨
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Error'
```

è§„èŒƒæ¥æº: `[Source: specs/api/review-api.openapi.yml - éœ€æ–°å¢]`

**æ•°æ®Schema** (æ–°å»º `specs/data/verification-history-response.schema.json`):

```json
{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "VerificationHistoryResponse",
  "type": "object",
  "required": ["concept", "total_count", "items"],
  "properties": {
    "concept": {
      "type": "string",
      "description": "æŸ¥è¯¢çš„æ¦‚å¿µåç§°"
    },
    "total_count": {
      "type": "integer",
      "description": "æ€»è®°å½•æ•°"
    },
    "items": {
      "type": "array",
      "items": {
        "type": "object",
        "required": ["question_id", "question_text", "asked_at"],
        "properties": {
          "question_id": {
            "type": "string",
            "description": "é—®é¢˜å”¯ä¸€ID"
          },
          "question_text": {
            "type": "string",
            "description": "é—®é¢˜å†…å®¹"
          },
          "question_type": {
            "type": "string",
            "enum": ["standard", "application", "comparison", "counterexample", "synthesis"],
            "description": "é—®é¢˜ç±»å‹/è§’åº¦"
          },
          "user_answer": {
            "type": "string",
            "nullable": true,
            "description": "ç”¨æˆ·å›ç­” (å¦‚æœ‰)"
          },
          "score": {
            "type": "integer",
            "nullable": true,
            "minimum": 0,
            "maximum": 100,
            "description": "è¯„åˆ† (å¦‚æœ‰)"
          },
          "canvas_name": {
            "type": "string",
            "description": "æ¥æºCanvas"
          },
          "asked_at": {
            "type": "string",
            "format": "date-time",
            "description": "æé—®æ—¶é—´"
          }
        }
      }
    },
    "pagination": {
      "type": "object",
      "properties": {
        "limit": {"type": "integer"},
        "offset": {"type": "integer"},
        "has_more": {"type": "boolean"}
      }
    }
  }
}
```

**ç°æœ‰ç›¸å…³Schema** `[Source: specs/api/review-api.openapi.yml]`:
- `HistoryResponse` - å¤ä¹ å†å²å“åº”æ ¼å¼ (å¯å‚è€ƒç»“æ„)
- `Error` - é”™è¯¯å“åº”æ ¼å¼

### ADRå†³ç­–å…³è” (å¿…å¡«)

| ADRç¼–å· | å†³ç­–æ ‡é¢˜ | å¯¹Storyçš„å½±å“ |
|---------|----------|---------------|
| ADR-0003 | ä½¿ç”¨Graphitiå®ç°æ—¶åºçŸ¥è¯†å›¾è°±è®°å¿†ç³»ç»Ÿ | é—®é¢˜å»é‡æŸ¥è¯¢å¿…é¡»ä½¿ç”¨Graphiti hybrid search API |
| ADR-009 | é”™è¯¯å¤„ç†ä¸é‡è¯•ç­–ç•¥ | GraphitiæŸ¥è¯¢éœ€è¦è¶…æ—¶ä¿æŠ¤å’Œgraceful degradation |
| ADR-0004 | å¼‚æ­¥å¹¶è¡Œæ‰§è¡Œå¼•æ“ | GraphitiæŸ¥è¯¢å¿…é¡»å¼‚æ­¥æ‰§è¡Œ(ä½¿ç”¨await) |

**å…³é”®çº¦æŸ** (ä»ADR Consequencesæå–):

- **çº¦æŸ1**: GraphitiæŸ¥è¯¢å¿…é¡»**å¼‚æ­¥æ‰§è¡Œ**ï¼ˆä½¿ç”¨`await`ï¼‰ï¼Œé¿å…é˜»å¡ä¸»æµç¨‹ `[Source: ADR-0003]`
- **çº¦æŸ2**: æŸ¥è¯¢è¶…æ—¶è®¾ç½®ä¸º500msï¼Œè¶…æ—¶åfallbackè¿”å›ç©ºç»“æœ `[Source: ADR-0003, ADR-009]`
- **çº¦æŸ3**: ä½¿ç”¨group_idè¿›è¡Œå¤šå­¦ç§‘éš”ç¦»ï¼Œç¡®ä¿ä¸åŒå­¦ç§‘çš„é—®é¢˜ä¸æ··æ·† `[Source: ADR-0003]`
- **çº¦æŸ4**: æ‰€æœ‰Graphitiå†™å…¥æ“ä½œä½¿ç”¨Fire-and-Forgetæ¨¡å¼ï¼Œä¸é˜»å¡ä¸»æµç¨‹ `[Source: ADR-0003]`

æ¥æºå¼•ç”¨: `[Source: ADR-0003, ADR-0004, ADR-009]`

### å…³é”®å®ç°å‚è€ƒ

**GraphitiTemporalClientæœç´¢æ¨¡å¼** `[Source: src/agentic_rag/clients/graphiti_temporal_client.py]`:

```python
# å·²æœ‰çš„æœç´¢æ–¹æ³•ç­¾åå‚è€ƒ
async def search_by_time_range(
    self,
    start_time: datetime,
    end_time: datetime,
    entity_types: Optional[List[str]] = None,
    limit: int = 100
) -> List[Dict[str, Any]]:
    """æŒ‰æ—¶é—´èŒƒå›´æŸ¥è¯¢äº‹ä»¶"""
    ...
```

**æ–°å¢search_verification_questionsæ–¹æ³•** (å‚è€ƒæ¨¡å¼):

```python
async def search_verification_questions(
    self,
    concept: str,
    canvas_name: Optional[str] = None,
    limit: int = 10,
    group_id: Optional[str] = None
) -> List[Dict[str, Any]]:
    """
    æŸ¥è¯¢æ¦‚å¿µçš„å†å²æ£€éªŒé—®é¢˜

    Args:
        concept: æ¦‚å¿µåç§°
        canvas_name: Canvasåç§°è¿‡æ»¤(å¯é€‰)
        limit: è¿”å›æ•°é‡é™åˆ¶
        group_id: å­¦ç§‘éš”ç¦»ID

    Returns:
        List of verification questions with metadata

    [Source: ADR-0003 Graphiti Memory, Hybrid Search section]
    """
    if not self._initialized:
        await self.initialize()

    try:
        # ä½¿ç”¨Graphiti hybrid search
        # âœ… Verified from Graphiti Skill: search() supports query + filters
        results = await asyncio.wait_for(
            self._graphiti.search(
                query=f"éªŒè¯é—®é¢˜ æ¦‚å¿µ:{concept}",
                group_ids=[group_id] if group_id else None,
                limit=limit
            ),
            timeout=self.timeout_ms / 1000
        )
        return self._format_question_results(results)
    except asyncio.TimeoutError:
        logger.warning(f"Graphiti search timeout for concept: {concept}")
        return []  # Graceful degradation
```

**é—®é¢˜è§’åº¦ç±»å‹å®šä¹‰**:

| è§’åº¦ç±»å‹ | è‹±æ–‡æ ‡è¯† | ç¤ºä¾‹Prompt |
|----------|----------|------------|
| æ ‡å‡†éªŒè¯ | standard | "è¯·è§£é‡Šä»€ä¹ˆæ˜¯{concept}ï¼Ÿ" |
| åº”ç”¨é¢˜ | application | "è¯·ä¸¾ä¾‹è¯´æ˜{concept}åœ¨å®é™…ä¸­å¦‚ä½•åº”ç”¨" |
| å¯¹æ¯”é¢˜ | comparison | "è¯·æ¯”è¾ƒ{concept}ä¸{related_concept}çš„åŒºåˆ«" |
| åä¾‹é¢˜ | counterexample | "è¯·ä¸¾å‡ºä¸€ä¸ªä¸å±äº{concept}çš„åä¾‹å¹¶è§£é‡Š" |
| ç»¼åˆé¢˜ | synthesis | "è¯·ç»“åˆ{context}è§£é‡Š{concept}çš„ä½œç”¨" |

**VerificationServiceä¿®æ”¹ç‚¹** `[Source: backend/app/services/verification_service.py]`:

å½“å‰Mockå®ç°ä½ç½®:
- Line 199: `concepts = ["æ¦‚å¿µ1", "æ¦‚å¿µ2", "æ¦‚å¿µ3"]` - Placeholderæ¦‚å¿µåˆ—è¡¨
- Line 235: `first_question = f"è¯·è§£é‡Šä»€ä¹ˆæ˜¯ã€Œ{concepts[0]}ã€ï¼Ÿ"` - å›ºå®šé—®é¢˜æ ¼å¼
- Line 361: `next_question = f"è¯·è§£é‡Šä»€ä¹ˆæ˜¯ã€Œ{concept_queue[next_idx]}ã€ï¼Ÿ"` - å›ºå®šé—®é¢˜æ ¼å¼

éœ€è¦ä¿®æ”¹ä¸ºè°ƒç”¨å»é‡é€»è¾‘åç”Ÿæˆé—®é¢˜ã€‚

### Episodeå­˜å‚¨æ ¼å¼

å­˜å‚¨æ£€éªŒé—®é¢˜åˆ°Graphitiæ—¶ä½¿ç”¨ä»¥ä¸‹æ ¼å¼:

```python
await graphiti_client.add_episode(
    content=f"éªŒè¯é—®é¢˜: {question_text} | æ¦‚å¿µ: {concept} | Canvas: {canvas_name} | ç±»å‹: {question_type}",
    metadata={
        "type": "verification_question",
        "concept": concept,
        "canvas_name": canvas_name,
        "question_type": question_type,  # standard/application/comparison/etc
        "question_id": str(uuid.uuid4()),
    },
    group_id=self._build_group_id(canvas_name)
)
```

### ä¾èµ–å…³ç³»

- **ä¾èµ–Story 31.1**: VerificationServiceæ ¸å¿ƒé€»è¾‘æ¿€æ´»ï¼ˆç¡®ä¿ä¼šè¯ç®¡ç†å¯ç”¨ï¼‰
- **ä¾èµ–Story 30.2**: Neo4jClientçœŸå®é©±åŠ¨å®ç°ï¼ˆGraphitiæŸ¥è¯¢ä¾èµ–Neo4jï¼‰
  - **Fallback**: å¦‚æœStory 30.2æœªå®Œæˆï¼Œä½¿ç”¨mock clientå¹¶æ·»åŠ TODOæ ‡è®°å¾…åç»­é›†æˆ
- **å·²æœ‰ä¾èµ–**: GraphitiTemporalClient å·²å®ç°åŸºç¡€åŠŸèƒ½ (`src/agentic_rag/clients/graphiti_temporal_client.py`)

### Conflict Resolutions (Step 8d)

| # | Conflict | Decision | Action | Resolved By | Timestamp |
|---|----------|----------|--------|-------------|-----------|
| 1 | Story vs OpenAPI: New endpoint not in spec | A (Accept SoT) | Added Task 0 to update spec FIRST | User | 2026-01-20 |
| 2 | Wrong file reference (graphiti_client.py) | A (Fix story) | Updated to graphiti_temporal_client.py | User | 2026-01-20 |

**Resolution Notes**:
- Task 0 added to ensure OpenAPI spec (Level 4) is updated before implementation (Level 6)
- File reference corrected: `backend/app/clients/graphiti_client.py` (Edge sync client) â†’ `src/agentic_rag/clients/graphiti_temporal_client.py` (Temporal query client)

### Testing

**æµ‹è¯•æ–‡ä»¶ä½ç½®**:
- åç«¯: `backend/tests/unit/test_verification_dedup.py`
- åç«¯: `backend/tests/integration/test_verification_history_api.py`

**æµ‹è¯•æ¡†æ¶**:
- pytest + pytest-asyncio

**æµ‹è¯•è¦æ±‚**:
1. å•å…ƒæµ‹è¯•ï¼šéªŒè¯ `search_verification_questions()` æ­£ç¡®è°ƒç”¨Graphiti
2. å•å…ƒæµ‹è¯•ï¼šéªŒè¯å»é‡é€»è¾‘ï¼ˆæ— å†å²é—®é¢˜/æœ‰å†å²é—®é¢˜ï¼‰
3. å•å…ƒæµ‹è¯•ï¼šéªŒè¯æ–°è§’åº¦é—®é¢˜ç”Ÿæˆ
4. é›†æˆæµ‹è¯•ï¼šéªŒè¯ `GET /verification/history/{concept}` ç«¯ç‚¹å“åº”æ ¼å¼
5. é›†æˆæµ‹è¯•ï¼šéªŒè¯åˆ†é¡µåŠŸèƒ½æ­£ç¡®
6. æµ‹è¯•è¦†ç›–ç‡è¦æ±‚: >= 80%

**æµ‹è¯•æ¨¡å¼** `[Source: ADR-008 Testing Framework]`:

```python
# åç«¯æµ‹è¯•ç¤ºä¾‹
import pytest
from unittest.mock import AsyncMock, patch
from backend.app.services.verification_service import VerificationService


class TestVerificationDedup:
    """éªŒè¯é—®é¢˜å»é‡æµ‹è¯•"""

    @pytest.fixture
    def mock_graphiti_client(self):
        client = AsyncMock()
        client.search_verification_questions = AsyncMock(return_value=[])
        return client

    @pytest.mark.asyncio
    async def test_no_history_generates_standard_question(
        self, mock_graphiti_client
    ):
        """æ— å†å²æ—¶ç”Ÿæˆæ ‡å‡†éªŒè¯é—®é¢˜"""
        service = VerificationService(graphiti_client=mock_graphiti_client)

        question = await service._generate_question_for_concept("é€†å¦å‘½é¢˜")

        assert "é€†å¦å‘½é¢˜" in question
        assert mock_graphiti_client.search_verification_questions.called

    @pytest.mark.asyncio
    async def test_with_history_generates_alternative_question(
        self, mock_graphiti_client
    ):
        """æœ‰å†å²æ—¶ç”Ÿæˆæ–°è§’åº¦é—®é¢˜"""
        mock_graphiti_client.search_verification_questions.return_value = [
            {"question_text": "è¯·è§£é‡Šä»€ä¹ˆæ˜¯é€†å¦å‘½é¢˜ï¼Ÿ", "question_type": "standard"}
        ]
        service = VerificationService(graphiti_client=mock_graphiti_client)

        question = await service._generate_question_for_concept("é€†å¦å‘½é¢˜")

        # åº”è¯¥ç”Ÿæˆä¸åŒäºå†å²é—®é¢˜çš„æ–°è§’åº¦
        assert "è¯·è§£é‡Šä»€ä¹ˆæ˜¯" not in question or "åº”ç”¨" in question or "æ¯”è¾ƒ" in question


class TestVerificationHistoryAPI:
    """éªŒè¯å†å²æŸ¥è¯¢APIæµ‹è¯•"""

    def test_get_history_returns_correct_format(self, client):
        """GET /verification/history/{concept} è¿”å›æ­£ç¡®æ ¼å¼"""
        response = client.get(
            "/api/v1/verification/history/é€†å¦å‘½é¢˜",
            params={"limit": 5}
        )
        assert response.status_code == 200
        data = response.json()
        assert "concept" in data
        assert "total_count" in data
        assert "items" in data
        assert isinstance(data["items"], list)

    def test_pagination_works(self, client):
        """åˆ†é¡µåŠŸèƒ½æ­£ç¡®"""
        response = client.get(
            "/api/v1/verification/history/é€†å¦å‘½é¢˜",
            params={"limit": 2, "offset": 0}
        )
        assert response.status_code == 200
        data = response.json()
        assert len(data["items"]) <= 2
        assert "pagination" in data
```

### ğŸ“‹ æŠ€æœ¯éªŒè¯æŠ¥å‘Š (Step 3.6)

**éªŒè¯å®Œæˆæ—¶é—´**: 2026-01-19T04:15:00Z
**éªŒè¯æ‰§è¡Œäºº**: SM Agent (Bob)
**Quality GateçŠ¶æ€**: âœ… PASSED

#### æŠ€æœ¯æ ˆæ¸…å•

| æŠ€æœ¯æ ˆ | æŸ¥è¯¢æ–¹å¼ | éªŒè¯çŠ¶æ€ | æ–‡æ¡£ä½ç½® |
|--------|---------|---------|----------|
| Graphiti | Skill | âœ… å·²éªŒè¯ | .claude/skills/graphiti/SKILL.md |
| FastAPI | å·²æœ‰ä»£ç  | âœ… å·²éªŒè¯ | backend/app/api/v1/endpoints/ |
| Neo4j | Context7 | âœ… å·²éªŒè¯ | /websites/neo4j_cypher-manual_25 |

#### æ ¸å¿ƒAPIéªŒè¯ç»“æœ

**Graphiti APIs** `[Source: ADR-0003, graphiti_temporal_client.py]`:
- âœ… `Graphiti.search()` â†’ Verified from ADR-0003 (Hybrid Searchæ”¯æŒ)
  - å‚æ•°: `query`, `group_ids`, `limit`
  - è¿”å›: List of search results
- âœ… `add_episode()` â†’ Verified from graphiti_temporal_client.py:77-82
  - å‚æ•°: `content`, `metadata`, `group_id`

**FastAPI Pattern** `[Source: backend/app/api/v1/endpoints/]`:
- âœ… `@router.get()` path parameter pattern â†’ Verified from review.py
- âœ… Query params with defaults â†’ Verified from review.py:127-140

**GraphitiClient** `[Source: backend/app/clients/graphiti_client.py]`:
- âœ… `async def` pattern â†’ Verified (all methods async)
- âœ… timeout handling â†’ Verified (2000ms default)
- âœ… graceful degradation â†’ Verified (return empty on error)

#### æŠ€æœ¯çº¦æŸå’Œæ³¨æ„äº‹é¡¹

**ç‰ˆæœ¬çº¦æŸ**:
- Graphiti: graphiti-core >= 0.3.x
- Neo4j: >= 5.0 (æ”¯æŒgroup_idåˆ†åŒº)
- FastAPI: >= 0.100.0

**æ€§èƒ½çº¦æŸ** `[Source: ADR-0003]`:
- GraphitiæŸ¥è¯¢è¶…æ—¶: 500ms
- å†å²è–„å¼±ç‚¹æŸ¥è¯¢ç›®æ ‡: <2ç§’

**å®‰å…¨è€ƒè™‘**:
- conceptå‚æ•°éœ€è¦URLç¼–ç å¤„ç†ï¼ˆä¸­æ–‡æ¦‚å¿µåï¼‰
- é˜²æ­¢SQLæ³¨å…¥ï¼ˆä½¿ç”¨Graphitiå‚æ•°åŒ–æŸ¥è¯¢ï¼‰

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-19 | 1.0 | Initial story creation with ultrathink mode | SM Agent (Bob) |
| 2026-01-20 | 1.1 | PO validation: Added Task 0 (OpenAPI spec update), fixed file references, added Conflict Resolutions section | PO Agent (Sarah) |

## Dev Agent Record

### Agent Model Used

_To be filled by Dev Agent_

### Debug Log References

_To be filled by Dev Agent_

### Completion Notes List

_To be filled by Dev Agent_

### File List

_To be filled by Dev Agent_

## QA Results

### Review Information

| Field | Value |
|-------|-------|
| **Review Date** | 2026-01-21 |
| **Review Type** | Pre-Implementation Specification Review |
| **Reviewer** | Quinn (QA Agent) |
| **Story Status** | Approved |
| **Risk Level** | Medium (Graphiti integration, new API endpoint) |

### Executive Summary

**PASS WITH OBSERVATIONS** - Story 31.4 specification is well-structured with comprehensive technical details. Notably, significant implementation already exists in the codebase for most AC requirements. The story correctly identifies dependencies and provides clear ADR compliance mappings.

### Acceptance Criteria Traceability

| AC | Description | Tasks | Testable | Implementation Status |
|----|-------------|-------|----------|----------------------|
| AC-31.4.1 | Query Graphiti for existing questions before generation | Task 1, 2 | âœ… Yes | âš ï¸ **Implemented**: `search_verification_questions()` exists in graphiti_temporal_client.py:774-933 |
| AC-31.4.2 | Generate new angle questions if history exists | Task 2, 3 | âœ… Yes | âš ï¸ **Implemented**: `_generate_alternative_question()` exists in verification_service.py:1872-1968 |
| AC-31.4.3 | GET /verification/history/{concept} endpoint | Task 0, 4, 5 | âœ… Yes | âš ï¸ **Partially Implemented**: OpenAPI spec complete (review-api.openapi.yml:412-473), endpoint routing TBD |
| AC-31.4.4 | History data includes question, answer, score, timestamp | Task 5 | âœ… Yes | âš ï¸ **Implemented**: Schema defined in spec (lines 1292-1368) and Pydantic models exist |

### ADR/SDD Compliance

| ADR | Requirement | Story Compliance | Status |
|-----|-------------|------------------|--------|
| ADR-0003 | Graphiti async execution with await | âœ… Documented in constraints | COMPLIANT |
| ADR-0003 | 500ms timeout with graceful degradation | âœ… Explicitly stated | COMPLIANT |
| ADR-0003 | group_id for multi-subject isolation | âœ… Task 6.3 addresses this | COMPLIANT |
| ADR-0003 | Fire-and-Forget writes | âœ… Existing impl uses this pattern | COMPLIANT |
| ADR-009 | Error handling and retry | âœ… Timeout handling documented | COMPLIANT |
| ADR-0004 | Async parallel execution | âœ… All methods use async | COMPLIANT |

### Technical Design Assessment

**Strengths:**
1. âœ… Clear SDD-first approach with Task 0 prioritizing OpenAPI spec update
2. âœ… Comprehensive episode storage format specification
3. âœ… Well-defined question angle priority system (application > comparison > counterexample > synthesis)
4. âœ… Proper dependency identification (Story 31.1, 30.2)
5. âœ… Technical verification report included (Step 3.6)

**Observations:**
1. âš ï¸ **Implementation Ahead of Story**: Significant code already exists:
   - `graphiti_temporal_client.py`: `search_verification_questions()` (160 lines)
   - `graphiti_temporal_client.py`: `add_verification_question()` (74 lines)
   - `verification_service.py`: `_generate_alternative_question()` (97 lines)
   - `verification_service.py`: `_get_question_history_from_graphiti()` (48 lines)
2. âš ï¸ **Story Status Mismatch**: Story status is "Approved" but substantial implementation exists. Consider updating to "In Progress" or documenting prior implementation.
3. â„¹ï¸ **Test Files Exist**: Both `test_verification_dedup.py` and `test_verification_history_api.py` are already created with proper AC references.

### Test Strategy Assessment

| Test Type | Coverage | Files | Status |
|-----------|----------|-------|--------|
| Unit Tests | AC-31.4.1, AC-31.4.2 | `test_verification_dedup.py` | âœ… File exists |
| Integration Tests | AC-31.4.3, AC-31.4.4 | `test_verification_history_api.py` | âœ… File exists |
| Coverage Target | â‰¥80% | pytest-cov | âœ… Specified |

**Test Quality:**
- âœ… Tests include source references to story tasks
- âœ… Mocking strategy is appropriate (AsyncMock for Graphiti client)
- âœ… Pagination tests specified (Task 7.5)

### Risk Assessment

| Risk | Likelihood | Impact | Mitigation |
|------|------------|--------|------------|
| Graphiti timeout affecting UX | Medium | Medium | 500ms timeout + graceful degradation documented |
| Chinese character URL encoding | Medium | Low | Story mentions URL encoding requirement |
| Neo4j dependency (Story 30.2) | Medium | High | Fallback strategy documented |

### Gate Decision

| Criterion | Status | Notes |
|-----------|--------|-------|
| Requirements Complete | âœ… PASS | All 4 ACs are well-defined and testable |
| ADR Compliance | âœ… PASS | All relevant ADRs addressed |
| SDD Alignment | âœ… PASS | OpenAPI spec and JSON schema specified |
| Test Strategy | âœ… PASS | Unit and integration test structure defined |
| Technical Feasibility | âœ… PASS | Implementation already proven viable |
| Dependencies Clear | âœ… PASS | Story 31.1, 30.2 dependencies noted |

### Recommendations

1. **Update Story Status**: Since implementation largely exists, update status to reflect actual progress or document this as retroactive story documentation.
2. **Verify Test Coverage**: Run existing tests to confirm they pass against existing implementation.
3. **API Route Verification**: Confirm `/verification/history/{concept}` endpoint is properly routed in FastAPI router.

### QA Gate Result

**Status**: âœ… **PASS**

**Rationale**: Story 31.4 specification meets all quality criteria. The well-structured technical documentation, clear ADR compliance, and existing test infrastructure provide confidence in implementation readiness. The observation that implementation already exists is noteworthy but does not block approval - it suggests the story may be documenting existing functionality.

**Signed**: Quinn (QA Agent) | 2026-01-21
