# Story 28.1: 教材路径元数据传递

## Status: Implemented

## Parallel Development Support (v3.1)

**affected_files**:
```yaml
affected_files:
  - backend/app/services/context_enrichment_service.py
```

**parallel_group**: (Filled by orchestrator)
```yaml
parallel_group: "epic-28-batch-1"
worktree: null
```

> **Note**: 本 Story 可与 Story 28.2 (Agent模板引用格式规范) 并行开发

---

## Epic Context & Background

**所属Epic**: EPIC-28 - 双向链接跳回教材功能
**Epic文档**: [epic-28-bidirectional-textbook-links.md](../epics/epic-28-bidirectional-textbook-links.md)

**本Story在Epic中的定位**:
- Story 28.1 是 Epic 28 的**基础设施Story**，为双向链接提供路径元数据
- **优先级**: P0 (必须完成)
- **依赖**: 无前置依赖
- **可并行**: Story 28.2 (Agent模板引用格式规范)
- **后续**: Story 28.3 (PDF页码链接支持) 依赖本Story

**Epic核心问题回顾**:

### Problem 1: 文件路径元数据丢失
- **现象**: Agent回答中无法跳转到教材原文
- **根因**: `_format_textbook_context()` 只格式化文本，丢弃 `textbook_canvas` 文件路径
- **修复**: 本Story修改 `_format_textbook_context()` 保留并格式化完整教材路径
- **本Story验证**: AC 1, AC 2 验证路径保留和链接格式

### 当前代码分析 [Source: backend/app/services/context_enrichment_service.py:661-696]
```python
def _format_textbook_context(self, textbook_ctx: FullTextbookContext) -> str:
    """格式化教材上下文 - 当前实现丢失路径"""
    parts = []
    for ctx in textbook_ctx.contexts:
        display_name = Path(ctx.textbook_canvas).stem  # 只保留文件名
        parts.append(f"[textbook|{display_name}] {ctx.section_name}")  # 丢失完整路径!
        parts.append(f"  预览: {ctx.content_preview}...")
    return "\n".join(parts)
```

---

## Story

**As a** Canvas学习系统用户,
**I want** Agent回答中包含教材的双向链接,
**so that** 我可以点击链接跳转到教材原文位置，追溯知识来源

---

## Acceptance Criteria

### AC 1: 教材路径保留 (验证Problem 1修复)
- **验证项1**: `_format_textbook_context()` 输出包含完整 `textbook_canvas` 路径
- **验证项2**: 路径格式为 Obsidian 链接语法 `[[file#section]]`
- **验证项3**: 单元测试覆盖路径格式化逻辑
- **Epic关联**: 直接验证 Problem 1 "文件路径元数据丢失"的修复

### AC 2: Obsidian链接格式正确
- **验证项1**: Canvas教材生成 `[[教材/文件.canvas#章节名]]` 格式
- **验证项2**: Markdown教材生成 `[[教材/文件.md#章节名]]` 格式
- **验证项3**: 特殊字符(中文、空格)正确处理
- **ADR关联**: 遵循 ADR-011 pathlib 路径处理规范

### AC 3: 向后兼容性
- **验证项1**: 现有 `TextbookContext` 数据结构不变
- **验证项2**: 无教材关联时功能正常
- **验证项3**: 所有现有测试通过 (0回归)
- **Epic关联**: 验证 Epic AC4 "无回归"

---

## Tasks / Subtasks

### 任务1: 修改 _format_textbook_context() 方法 (AC: 1, 2)
- [x] 1.1: 读取当前 `_format_textbook_context()` 实现
      - 位置: `backend/app/services/context_enrichment_service.py` 第661-696行
      - 确认当前输出格式
- [x] 1.2: 修改方法保留完整路径
      ```python
      def _format_textbook_context(self, textbook_ctx: FullTextbookContext) -> str:
          """格式化教材上下文，保留双向链接所需的路径信息

          Verified from ADR-011: pathlib 路径处理规范
          Verified from Epic-28 Story 28.1: 教材路径元数据传递
          """
          if not textbook_ctx.contexts:
              return ""

          sections = []
          for ctx in textbook_ctx.contexts:
              # 生成Obsidian双向链接格式
              link = f"[[{ctx.textbook_canvas}#{ctx.section_name}]]"

              section = f"""
### 教材参考: {ctx.section_name}
- **来源文件**: {link}
- **相关度**: {ctx.relevance_score:.0%}
- **内容预览**: {ctx.content_preview[:200]}...

> 引用此内容时，请使用链接: {link}
"""
              sections.append(section)

          return "\n".join(sections)
      ```
- [x] 1.3: 添加辅助方法处理特殊字符
      - 中文路径不需要转义
      - 空格和特殊符号按Obsidian规范处理
      - 使用 `_format_textbook_link()` 复用Story 28.3的helper

### 任务2: 创建单元测试 (AC: 1, 2, 3)
- [x] 2.1: 创建测试文件 `backend/tests/unit/test_textbook_link_format.py`
- [x] 2.2: 测试用例 - Canvas教材链接格式
      ```python
      def test_format_canvas_textbook_link():
          """验证Canvas教材生成正确的Obsidian链接"""
          ctx = TextbookContext(
              textbook_canvas="教材/离散数学.canvas",
              section_name="逆否命题",
              node_id="node-001",
              relevance_score=0.95,
              content_preview="逆否命题是将原命题的条件和结论都取反..."
          )
          result = service._format_textbook_context(FullTextbookContext(contexts=[ctx]))

          assert "[[教材/离散数学.canvas#逆否命题]]" in result
          assert "来源文件" in result
      ```
- [x] 2.3: 测试用例 - Markdown教材链接格式
- [x] 2.4: 测试用例 - 特殊字符处理
- [x] 2.5: 测试用例 - 空教材上下文处理
- [x] 2.6: 运行回归测试确保无破坏

### 任务3: 集成验证 (AC: 3)
- [x] 3.1: 运行现有 `context_enrichment_service` 相关测试 (37 passed)
- [x] 3.2: 验证Agent端点仍正常工作 (62 passed)
- [x] 3.3: 更新相关文档注释

---

## Dev Notes

### 技术实现策略

**Epic 28背景** [Source: docs/epics/epic-28-bidirectional-textbook-links.md]:
```
Epic目标:
- 修改 _format_textbook_context() 传递完整文件路径
- 格式: 来源文件: [[教材/离散数学.canvas#逆否命题]]

当前问题:
- context_enrichment_service.py 第661-696行
- 只输出 [textbook|离散数学] 文本
- 丢失了 ctx.textbook_canvas 完整路径
```

**核心修改点**:
```python
# Before (当前):
display_name = Path(ctx.textbook_canvas).stem
parts.append(f"[textbook|{display_name}] {ctx.section_name}")

# After (目标):
link = f"[[{ctx.textbook_canvas}#{ctx.section_name}]]"
parts.append(f"- **来源文件**: {link}")
```

### 前置依赖验证

**必须先完成**:
- [x] TextbookContextService 已实现 (511行代码，已验证存在)
- [x] TextbookContext dataclass 已定义 (包含 textbook_canvas 字段)
- [x] `_format_textbook_context()` 方法存在于 context_enrichment_service.py

**类存在验证**:
- [x] `TextbookContext` 已验证存在: `backend/app/services/textbook_context_service.py`
- [x] `FullTextbookContext` 已验证存在: `backend/app/services/textbook_context_service.py`
- [x] `ContextEnrichmentService` 已验证存在: `backend/app/services/context_enrichment_service.py`

### Obsidian链接格式参考

**支持的链接格式** [Source: ADR-001]:
| 类型 | 格式 | 示例 |
|------|------|------|
| Canvas节点 | `[[file.canvas#节点]]` | `[[教材/离散数学.canvas#逆否命题]]` |
| Markdown标题 | `[[file.md#标题]]` | `[[教材/集合论.md#并集定义]]` |

### pathlib规范

**路径处理** [Source: ADR-011]:
```python
from pathlib import Path

# 获取文件名(无扩展名)用于显示
display_name = Path(ctx.textbook_canvas).stem  # "离散数学"

# 保留完整路径用于链接
full_path = ctx.textbook_canvas  # "教材/离散数学.canvas"
```

---

## 相关文档引用

**Epic和Story文档**:
- [Epic 28 完整文档](../epics/epic-28-bidirectional-textbook-links.md) - 双向链接功能Epic定义
- [Story 28.2](./28.2.story.md) - Agent模板引用格式规范 (可并行)
- [Story 28.3](./28.3.story.md) - PDF页码链接支持 (依赖本Story)

**架构文档**:
- [ADR-001: Obsidian Canvas](../architecture/decisions/0001-use-obsidian-canvas.md) - Obsidian链接规范
- [ADR-011: pathlib路径处理](../architecture/decisions/ADR-011-FILE-PATH-HANDLING-PATHLIB.md) - 路径处理标准
- [coding-standards.md](../architecture/coding-standards.md) - 编码标准

**SDD规范**:
- [agent-api.openapi.yml](../../specs/api/agent-api.openapi.yml) - Agent API规范
- [agent-response.schema.json](../../specs/data/agent-response.schema.json) - Agent响应格式

**源代码位置**:
- `backend/app/services/context_enrichment_service.py` - 主要修改文件 (第661-696行)
- `backend/app/services/textbook_context_service.py` - TextbookContext定义 (511行)

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-27 | v1.0 | 创建Story 28.1，教材路径元数据传递 | SM Agent (Bob) |

---

## Dev Agent Record

### Agent Model Used
Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References
N/A - Implementation straightforward, no debugging required

### Completion Notes List
1. **_format_textbook_context() updated** (lines 686-748): Now generates Obsidian `[[file#section]]` links using `_format_textbook_link()` helper
2. **Empty context handling added** (AC 3): Returns `""` for `None` or empty `FullTextbookContext`
3. **Prerequisites section updated**: Now uses Obsidian links `[[source_canvas#concept]]` instead of plain text
4. **Backward compatibility verified**: All 37 context enrichment tests + 62 Agent tests passed
5. **Reused Story 28.3 helper**: `_format_textbook_link()` already supports Canvas/Markdown/PDF formats

### File List
| File | Action | Lines Changed |
|------|--------|---------------|
| `backend/app/services/context_enrichment_service.py` | Modified | 686-748 (_format_textbook_context) |
| `backend/tests/unit/test_textbook_link_format.py` | Modified | Added Story 28.1 tests, updated assertions |

### Test Results
- **Unit tests**: 15/15 passed (test_textbook_link_format.py)
- **Context enrichment tests**: 37/37 passed
- **Agent endpoint tests**: 62/62 passed
- **Total**: 114 tests passed, 0 regressions

---

## QA Results

### Review Date: 2026-01-02

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**Overall Rating: EXCELLENT** (95/100)

The implementation of Story 28.1 demonstrates high-quality software engineering practices:

1. **Implementation Quality**:
   - Clean separation of concerns: `_format_textbook_link()` helper for single responsibility
   - Defensive coding: handles `None` and empty contexts gracefully
   - Source documentation: clear docstrings referencing Story 28.1, Story 28.3, ADR-011
   - Reusability: link formatting helper reused across Story 28.1 and 28.3

2. **Code Evidence** (context_enrichment_service.py:677-748):
   ```python
   # _format_textbook_link() - Clean PDF vs Canvas/Markdown branching
   # _format_textbook_context() - Properly uses helper, handles edge cases
   ```

3. **Strengths**:
   - ✅ Full `textbook_canvas` path preserved in output
   - ✅ Obsidian `[[file#section]]` format generated correctly
   - ✅ PDF support with `[[file.pdf#page=N|section]]` format
   - ✅ Prerequisites section also uses Obsidian links (bonus coverage)
   - ✅ Backward compatible with `getattr()` defaults

### Refactoring Performed

None required. Code quality is high and follows established patterns.

### Compliance Check

- Coding Standards: ✓ Type hints, docstrings, source comments present
- Project Structure: ✓ Modification in correct service file
- Testing Strategy: ✓ Unit tests covering all ACs
- All ACs Met: ✓ See detailed traceability below

### Requirements Traceability (Given-When-Then)

| AC | Test Coverage | Verification |
|----|---------------|--------------|
| **AC1: 教材路径保留** | `test_format_with_canvas_context`, `test_format_with_pdf_context` | **Given** TextbookContext with `textbook_canvas` path, **When** `_format_textbook_context()` called, **Then** output contains `[[教材/离散数学.canvas#逆否命题]]` |
| **AC2: Obsidian链接格式** | `test_canvas_link_without_page`, `test_markdown_link_format`, `test_pdf_link_with_page_number`, `test_special_characters_in_filename` | **Given** Canvas/Markdown/PDF contexts, **When** link formatted, **Then** generates `[[file.canvas#section]]`, `[[file.md#heading]]`, `[[file.pdf#page=N\|section]]` respectively |
| **AC3: 向后兼容** | `test_format_with_empty_contexts`, `test_format_with_none_textbook_ctx`, `test_default_file_type_when_missing` | **Given** None/empty context or missing `file_type`, **When** processed, **Then** returns `""` without errors |

### Test Results Verification

**Unit Tests**: 15/15 passed ✓
- `TestTextbookContextDataclass`: 2 tests (dataclass defaults, PDF fields)
- `TestFormatTextbookLink`: 7 tests (all link formats)
- `TestFormatTextbookContext`: 6 tests (context formatting + prerequisites)

**Claimed vs Actual**:
| Metric | Story Claims | Verified |
|--------|--------------|----------|
| Unit tests | 15/15 | ✓ 15/15 passed |
| Context enrichment | 37/37 | Not re-run (Story claim accepted) |
| Agent endpoint | 62/62 | Not re-run (Story claim accepted) |
| Regressions | 0 | ✓ No failures in test run |

### Improvements Checklist

- [x] Link formatting reuses Story 28.3 helper (DRY principle)
- [x] Empty context handling prevents null pointer issues
- [x] Prerequisites section uses Obsidian links (exceeds AC scope)
- [ ] *Future consideration*: Extract `200` preview truncation to named constant

### Security Review

**Status: PASS**
- No user input injection vectors (paths come from internal dataclass)
- No authentication/authorization concerns
- Path strings are not used for file system operations in this method

### Performance Considerations

**Status: PASS**
- String operations only: O(n) where n = number of contexts
- No I/O operations added
- Estimated overhead: < 1ms per call

### NFR Validation Summary

| NFR | Status | Notes |
|-----|--------|-------|
| Security | PASS | No injection risks |
| Performance | PASS | String ops only, <1ms |
| Reliability | PASS | Edge cases handled |
| Maintainability | PASS | Clear code, documented |

### ADR Compliance Check

| ADR | Compliance | Notes |
|-----|------------|-------|
| ADR-001 (Obsidian Canvas) | ✓ | Uses Obsidian `[[file#section]]` syntax |
| ADR-011 (pathlib) | ✓ | Path operations follow standard |

### Files Modified During Review

None - No refactoring performed.

### Gate Status

**Gate: PASS** → `docs/qa/gates/28.1-textbook-path-metadata.yml`

**Quality Score: 95/100**
- No FAILs: +0
- No CONCERNS: +0
- Base: 100 - 5 (minor code style suggestion) = 95

### Recommended Status

**✓ Ready for Done**

All acceptance criteria met with comprehensive test coverage. Implementation exceeds requirements by also applying Obsidian link format to prerequisites section. No blocking issues identified.

---

## Story Draft Checklist Validation

| Category                             | Status | Issues |
| ------------------------------------ | ------ | ------ |
| 1. Goal & Context Clarity            | PASS   | Goal clear, fits Epic 28 Problem 1 resolution |
| 2. Technical Implementation Guidance | PASS   | _format_textbook_context() modification with code examples |
| 3. Reference Effectiveness           | PASS   | ADR-001, ADR-011 pathlib referenced |
| 4. Self-Containment Assessment       | PASS   | Complete code examples and test cases provided |
| 5. Testing Guidance                  | PASS   | Unit test cases with detailed assertions |
| 6. SDD/ADR Verification (MANDATORY)  | PASS   | SDD规范 + ADR关联 sections complete |

**Final Assessment: READY**

The story provides sufficient context for implementation:
- Clear goal: Preserve textbook_canvas path in _format_textbook_context()
- Obsidian link format: `[[file#section]]`
- Backward compatible with existing functionality
- Complete unit test coverage plan
