# Story 35.10: å¤šæ¨¡æ€APIå®‰å…¨åŠ å›ºä¸ç«¯ç‚¹è§„èŒƒä¿®å¤

**Status**: done

---

## Epic Context & Background

**æ‰€å±Epic**: EPIC-35 - å¤šæ¨¡æ€åŠŸèƒ½å®Œæ•´æ¿€æ´» (Multimodal Activation)
**Epicæ–‡æ¡£**: [EPIC-35-MULTIMODAL-ACTIVATION.md](../epics/EPIC-35-MULTIMODAL-ACTIVATION.md)

**æœ¬Storyåœ¨Epicä¸­çš„å®šä½**:
- EPIC-35 å¯¹æŠ—æ€§å®¡æŸ¥äº§ç”Ÿçš„å®‰å…¨ä¿®å¤ Story
- ä¿®å¤ P0-3 è·¯å¾„éå†é˜²æŠ¤ç¼ºå¤± + P1-7 DELETE è¿”å›ç  + P1-8 è·¯ç”±å¥åº·æ£€æŸ¥éªŒè¯
- **ä¾èµ–**: Story 35.1 (ä¸Šä¼ API), Story 35.9 (E2Eæµ‹è¯•)

**å®¡æŸ¥æ¥æº**:
- å¯¹æŠ—æ€§ä»£ç å®¡æŸ¥æŠ¥å‘Š (2026-02-09)
- P0-3: è·¯å¾„éå†é˜²æŠ¤ â€” Story 35.1 Dev Notes å£°ç§°æœ‰ `resolve() + is_relative_to()` é˜²æŠ¤ï¼Œä½† `multimodal_service.py:520` å®é™…æ— æ­¤æ£€æŸ¥
- P1-7: DELETE ç«¯ç‚¹è¿”å› 200 + bodyï¼ŒAC 35.1.3 è¦æ±‚ 204 No Content
- P1-8: è·¯ç”±é¡ºåº â€” å·²æœ‰ UUID regex çº¦æŸå’Œæ³¨é‡Šä¿æŠ¤ï¼Œéœ€éªŒè¯æµ‹è¯•è·³è¿‡çš„æ ¹å› 

---

## Story

**As a** Canvas Learning Systemç®¡ç†å‘˜,
**I want** å¤šæ¨¡æ€APIå…·å¤‡å®Œæ•´çš„å®‰å…¨é˜²æŠ¤å’Œè§„èŒƒä¸€è‡´çš„HTTPå“åº”,
**so that** ä¸Šä¼ åŠŸèƒ½ä¸å­˜åœ¨è·¯å¾„éå†æ¼æ´ï¼ŒAPIè¡Œä¸ºä¸OpenAPIè§„èŒƒä¸€è‡´ã€‚

---

## Acceptance Criteria

### AC 35.10.1: è·¯å¾„éå†é˜²æŠ¤ â€” resolve() + is_relative_to() (ä¿®å¤P0-3)

**Given** ç”¨æˆ·é€šè¿‡ POST /upload ä¸Šä¼ æ–‡ä»¶
**When** æ–‡ä»¶ååŒ…å«è·¯å¾„éå†å­—ç¬¦ (å¦‚ `../../etc/passwd`, `..\\windows\\system32\\`)
**Then** ç³»ç»Ÿæ‹’ç»å†™å…¥å¹¶è¿”å› 400 Bad Request

**ä»£ç ç°å®æ£€æŸ¥**:
- ğŸ”´ å½“å‰ä»£ç ä½ç½®: `backend/app/services/multimodal_service.py:518-528`
- ğŸ”´ å½“å‰è¡Œä¸º: `file_path = self.storage_base_path / media_type.value / unique_filename` åç›´æ¥ `open(file_path, "wb")`
- ğŸ”´ ç¼ºå¤±: æ—  `file_path.resolve()` å’Œ `is_relative_to(self.storage_base_path)` æ£€æŸ¥
- ğŸŸ¡ éƒ¨åˆ†ç¼“è§£: `_generate_unique_filename()` ç”Ÿæˆ `{timestamp}_{uuid}{ext}` æ ¼å¼ï¼Œä¸åŒ…å«è·¯å¾„åˆ†éš”ç¬¦
- ğŸ”´ æ®‹ä½™é£é™©: `ext = Path(original_filename).suffix.lower()` å¯èƒ½åœ¨æç«¯æƒ…å†µä¸‹å¼•å…¥é£é™©

**ä¿®å¤æ–¹æ¡ˆ**:
```python
# multimodal_service.py:520 é™„è¿‘
file_path = self.storage_base_path / media_type.value / unique_filename
resolved_path = file_path.resolve()

# é˜²æ­¢è·¯å¾„éå†æ”»å‡»
if not resolved_path.is_relative_to(self.storage_base_path.resolve()):
    logger.warning(
        f"Path traversal attempt detected: {original_filename} -> {resolved_path}"
    )
    raise MultimodalServiceError("Invalid file path: path traversal detected")
```

**æµ‹è¯•ç”¨ä¾‹**:
```python
@pytest.mark.parametrize("malicious_filename", [
    "../../etc/passwd",
    "..\\..\\windows\\system32\\config",
    "normal/../../../evil.txt",
    "....//....//etc/shadow",
])
async def test_path_traversal_blocked(service, malicious_filename):
    with pytest.raises(MultimodalServiceError, match="path traversal"):
        await service.upload_file(
            filename=malicious_filename,
            content_type="image/png",
            file_bytes=b"fake",
            file_size=4,
            related_concept_id="test",
        )
```

### AC 35.10.2: upload_from_url è·¯å¾„éå†é˜²æŠ¤ (ä¿®å¤P0-3 ç¬¬äºŒå†™å…¥ç‚¹)

**Given** ç”¨æˆ·é€šè¿‡ POST /upload-url ä¸Šä¼ URLå†…å®¹
**When** URLæ–‡ä»¶åè§£æååŒ…å«è·¯å¾„éå†å­—ç¬¦
**Then** ç³»ç»Ÿæ‹’ç»å†™å…¥å¹¶è¿”å› 400 Bad Request

**ä»£ç ç°å®æ£€æŸ¥**:
- ğŸ”´ å½“å‰ä»£ç ä½ç½®: `backend/app/services/multimodal_service.py:665-666`
- ğŸ”´ åŒæ ·ç¼ºå¤± resolve() + is_relative_to() æ£€æŸ¥

**ä¿®å¤æ–¹æ¡ˆ**: ä¸ AC 35.10.1 ç›¸åŒçš„é˜²æŠ¤é€»è¾‘ï¼Œæå–ä¸ºç§æœ‰æ–¹æ³• `_validate_file_path(file_path)` å¤ç”¨ã€‚

### AC 35.10.3: DELETE ç«¯ç‚¹è¿”å› 204 No Content (ä¿®å¤P1-7)

**Given** ç”¨æˆ·å‘é€ DELETE /api/v1/multimodal/{content_id} è¯·æ±‚
**When** å†…å®¹æˆåŠŸåˆ é™¤
**Then** è¿”å› HTTP 204 No Content (æ— å“åº”ä½“)

**ä»£ç ç°å®æ£€æŸ¥**:
- ğŸ”´ å½“å‰ä»£ç ä½ç½®: `backend/app/api/v1/endpoints/multimodal.py:446-471`
- ğŸ”´ å½“å‰è¡Œä¸º: è¿”å› `MultimodalDeleteResponse` (HTTP 200 + JSON body)
- ğŸ“‹ Story 35.1 AC 35.1.3 æ˜ç¡®è¦æ±‚: "è¿”å›204 No ContentæˆåŠŸ"
- âš ï¸ QA Review æ³¨é‡Š: "ä¸ºæœ‰æ„è®¾è®¡å†³ç­– - è¿”å›åˆ é™¤ç¡®è®¤ä¿¡æ¯å¯¹å‰ç«¯æ›´å‹å¥½"

**å†³ç­–éœ€æ±‚**: éœ€ç¡®è®¤æœ€ç»ˆè¡Œä¸º â€” ä¸¥æ ¼éµå®ˆ AC (204) è¿˜æ˜¯ä¿ç•™å½“å‰å®ç° (200+body)ã€‚

**å¦‚æœé€‰æ‹© 204**:
```python
@multimodal_router.delete(
    "/{content_id}",
    status_code=status.HTTP_204_NO_CONTENT,
    summary="Delete content",
)
async def delete_content(
    service: MultimodalServiceDep,
    content_id: str = Path(..., pattern=UUID_PATTERN),
) -> None:
    await service.delete_content(content_id)
    # è¿”å› None â†’ FastAPI è‡ªåŠ¨ç”Ÿæˆ 204 No Content
```

**å¦‚æœä¿ç•™ 200**: æ›´æ–° Story 35.1 AC 35.1.3 å’Œ OpenAPI è§„èŒƒä½¿å…¶ä¸€è‡´ã€‚

### AC 35.10.4: è·¯ç”±å¥åº·æ£€æŸ¥ç«¯ç‚¹å¯è¾¾æ€§éªŒè¯ (éªŒè¯P1-8)

**Given** åç«¯æœåŠ¡è¿è¡Œä¸­
**When** å‘é€ GET /api/v1/multimodal/health
**Then** è¿”å›å¥åº·çŠ¶æ€ (ä¸è¢« `/{content_id}` è·¯ç”±æ‹¦æˆª)

**ä»£ç ç°å®æ£€æŸ¥**:
- âœ… è·¯ç”±é¡ºåºå·²æ­£ç¡®: `/health` (L236) å®šä¹‰åœ¨ `/{content_id}` (L390) ä¹‹å‰
- âœ… UUID regex çº¦æŸ: `content_id` å‚æ•°æœ‰ `pattern=r"^[0-9a-fA-F]{8}-..."` çº¦æŸ
- âœ… ä»£ç æ³¨é‡Š (L385-388): "MUST be defined AFTER all static paths"
- âš ï¸ ä½† Story 35.9 æŠ¥å‘Šæµ‹è¯•è¢« skip â€” éœ€ç¡®è®¤ skip æ ¹å› æ˜¯å¦ä¸ºè·¯ç”±é—®é¢˜è¿˜æ˜¯å…¶ä»–åŸå› 

**éªŒè¯ä»»åŠ¡**:
1. è¿è¡Œ `GET /api/v1/multimodal/health` ç¡®è®¤è¿”å› 200 + å¥åº·çŠ¶æ€
2. æ£€æŸ¥ Story 35.9 ä¸­è¢« skip çš„æµ‹è¯•ï¼Œç¡®è®¤ skip åŸå› 
3. å¦‚æœ skip æ˜¯ç”±äº LanceDB/Neo4j ä¾èµ–è€Œéè·¯ç”±ï¼Œæ ‡è®°ä¸ºéè·¯ç”±é—®é¢˜

---

## Tasks / Subtasks

### ä»»åŠ¡1: æå–è·¯å¾„å®‰å…¨éªŒè¯æ–¹æ³• (AC: 1, 2)

- [x] 1.1: åœ¨ `MultimodalService` ä¸­åˆ›å»º `_validate_safe_path(file_path: Path) -> Path` æ–¹æ³•
      - `resolve()` è§„èŒƒåŒ–è·¯å¾„
      - `is_relative_to(self.storage_base_path)` æ£€æŸ¥
      - å¤±è´¥æ—¶ raise `MultimodalServiceError` + WARNING æ—¥å¿—
- [x] 1.2: åœ¨ `upload_file()` æ–¹æ³•ä¸­ (L520é™„è¿‘) è°ƒç”¨ `_validate_safe_path()`
- [x] 1.3: åœ¨ `upload_from_url()` æ–¹æ³•ä¸­ (L665é™„è¿‘) è°ƒç”¨ `_validate_safe_path()`

### ä»»åŠ¡2: DELETE è¿”å›ç ä¿®å¤ (AC: 3)

- [x] 2.1: ç¡®è®¤è®¾è®¡å†³ç­– (204 vs 200+body) â€” ç”¨æˆ·é€‰æ‹© 204
- [x] 2.2: ä¿®æ”¹ `multimodal.py` çš„ `delete_content()` ç«¯ç‚¹ä¸º `status_code=204`, `-> None`
- [x] 2.3: æ›´æ–° e2e å’Œ contract æµ‹è¯•ä¸­ DELETE ç«¯ç‚¹çš„å“åº”ç æ–­è¨€
- [x] 2.4: æ›´æ–°å‰ç«¯ `ApiClient.ts` ä¸­ `deleteMultimodal()` çš„å“åº”å¤„ç† (204 â†’ void)

### ä»»åŠ¡3: è·¯ç”±å¥åº·æ£€æŸ¥éªŒè¯ (AC: 4)

- [x] 3.1: è¿è¡Œ e2e æµ‹è¯•ç¡®è®¤ `GET /health` ç«¯ç‚¹å¯è¾¾ â€” é€šè¿‡
- [x] 3.2: æ’æŸ¥ Story 35.9 è¢« skip æµ‹è¯•çš„çœŸå®åŸå›  â€” ä¸Šä¼ ä¾èµ–å¤±è´¥å¯¼è‡´ skipï¼Œéè·¯ç”±é—®é¢˜
- [x] 3.3: æ ‡æ³¨ä¸ºéè·¯ç”±é—®é¢˜ (LanceDB/MultimodalStore ä¾èµ–ç›¸å…³)

### ä»»åŠ¡4: å®‰å…¨æµ‹è¯•ç”¨ä¾‹ (AC: 1, 2)

- [x] 4.1: åˆ›å»º `backend/tests/unit/test_multimodal_path_security.py`
      - 7 ä¸ª `_validate_safe_path` ç›´æ¥å•å…ƒæµ‹è¯•
      - 4 ä¸ª `upload_file` è·¯å¾„éå† parametrize æµ‹è¯•
      - 1 ä¸ª `upload_file` è°ƒç”¨é¡ºåºéªŒè¯æµ‹è¯•
      - 1 ä¸ª `upload_from_url` è°ƒç”¨éªŒè¯æµ‹è¯•
- [x] 4.2: éªŒè¯ç°æœ‰æµ‹è¯•æ— å›å½’ (64/64 é€šè¿‡)

---

## Dev Notes

### ä»£ç ç°å®æ£€æŸ¥è¡¨

| å£°ç§°çš„åŠŸèƒ½ | ä»£ç ä½ç½® | çŠ¶æ€ |
|-----------|----------|------|
| è·¯å¾„éå†é˜²æŠ¤ | `multimodal_service.py:478-498` | âœ… å·²æ·»åŠ  `_validate_safe_path()` |
| è·¯å¾„éå†é˜²æŠ¤ (URL) | `multimodal_service.py:691` | âœ… å·²è°ƒç”¨ `_validate_safe_path()` |
| DELETE 204 | `multimodal.py:446` | âœ… å·²æ”¹ä¸º `status_code=204`, `-> None` |
| /health è·¯ç”±å¯è¾¾ | `multimodal.py:236-252` | âœ… è·¯ç”±é¡ºåºæ­£ç¡®ï¼Œe2e æµ‹è¯•é€šè¿‡ |

### å®‰å…¨é˜²æŠ¤å‚è€ƒ

**ADR-011 æ–‡ä»¶è·¯å¾„å¤„ç†** (Story 35.1 Dev Notes å¼•ç”¨):
```python
resolved = (vault_path / filename).resolve()
if not resolved.is_relative_to(vault_path):
    raise FileError("Path traversal detected")
```

### å½±å“èŒƒå›´

- `multimodal_service.py`: 2å¤„æ–‡ä»¶å†™å…¥ç‚¹éœ€æ·»åŠ éªŒè¯
- `multimodal.py`: DELETE ç«¯ç‚¹è¿”å›ç 
- æµ‹è¯•æ–‡ä»¶: æ–°å¢å®‰å…¨æµ‹è¯•

---

## Dev Agent Record

### Implementation Plan
- AC 35.10.1/35.10.2: æå– `_validate_safe_path()` ç§æœ‰æ–¹æ³•ï¼Œåœ¨ `upload_file()` å’Œ `upload_from_url()` çš„æ–‡ä»¶å†™å…¥å‰è°ƒç”¨
- AC 35.10.3: DELETE ç«¯ç‚¹ä» 200+body æ”¹ä¸º 204 No Contentï¼Œæ›´æ–°å‰ç«¯ `deleteMultimodal()` é€‚é…
- AC 35.10.4: éªŒè¯ /health ç«¯ç‚¹å¯è¾¾æ€§ï¼Œç¡®è®¤ skip åŸå› ä¸ºä¸Šä¼ ä¾èµ–å¤±è´¥éè·¯ç”±é—®é¢˜

### Completion Notes
- âœ… `_validate_safe_path()` æ–¹æ³•å®ç°å¹¶åœ¨ä¸¤å¤„å†™å…¥ç‚¹è°ƒç”¨ï¼Œä½¿ç”¨ `resolve() + is_relative_to()` é˜²æŠ¤
- âœ… DELETE ç«¯ç‚¹æ”¹ä¸º 204 No Contentï¼Œç§»é™¤ `MultimodalDeleteResponse` å¯¼å…¥
- âœ… å‰ç«¯ `deleteMultimodal()` æ›´æ–°ä¸º `request<void>`ï¼Œä¸å†è§£æ response body
- âœ… e2e æµ‹è¯• DELETE æ–­è¨€ä» 200 æ›´æ–°ä¸º 204
- âœ… contract æµ‹è¯• DELETE éªŒè¯ä» body å­—æ®µæ£€æŸ¥æ”¹ä¸º 204 çŠ¶æ€ç æ£€æŸ¥
- âœ… /health ç«¯ç‚¹ e2e æµ‹è¯•é€šè¿‡ï¼Œè·¯ç”±é¡ºåºæ­£ç¡®
- âœ… 13 ä¸ªæ–°å®‰å…¨æµ‹è¯•å…¨éƒ¨é€šè¿‡
- âœ… 64 ä¸ª multimodal ç›¸å…³æµ‹è¯•å…¨éƒ¨é€šè¿‡ï¼Œæ— å›å½’

### Code Review Fixes (2026-02-09)
- **H-1 ä¿®å¤**: `multimodal_service.py:delete_content()` è¿”å›ç±»å‹ä» `MultimodalDeleteResponse` æ”¹ä¸º `None`ï¼Œç§»é™¤æ­»ä»£ç æ„é€ å’Œæœªä½¿ç”¨å¯¼å…¥
- **H-2 ä¿®å¤**: æ–°å¢ 3 ä¸ªçœŸå®é˜²å¾¡é“¾æµ‹è¯• (`TestRealDefenseChain`) â€” ä¸ Mock `_validate_safe_path`ï¼ŒéªŒè¯ `_generate_unique_filename` + `_validate_safe_path` åŒé‡é˜²æŠ¤
- **M-1 ä¿®å¤**: `_validate_safe_path()` æ—¥å¿—ä½¿ç”¨ `repr()` + `%s` æ ¼å¼åŒ–é˜²æ­¢æ—¥å¿—æ³¨å…¥
- **M-2 ä¿®å¤**: File List ä¸­ `test_multimodal_pact_interactions.py` Action ä» "Modified" æ”¹ä¸º "Created"

### Debug Log
- `....//....//` è·¯å¾„æ¨¡å¼åœ¨ Windows ä¸Š `Path.resolve()` ä¸äº§ç”Ÿéå†ï¼ˆ`....` ä¸æ˜¯æœ‰æ•ˆè·¯å¾„ç»„ä»¶ï¼‰ï¼Œè°ƒæ•´ä¸º `../../../../../../../tmp/evil` æµ‹è¯•

---

## File List

| File | Action | Description |
|------|--------|-------------|
| `backend/app/services/multimodal_service.py` | Modified | æ·»åŠ  `_validate_safe_path()` æ–¹æ³•ï¼Œåœ¨ `upload_file()` å’Œ `upload_from_url()` ä¸­è°ƒç”¨ |
| `backend/app/api/v1/endpoints/multimodal.py` | Modified | DELETE ç«¯ç‚¹æ”¹ä¸º 204 No Contentï¼Œç§»é™¤ MultimodalDeleteResponse å¯¼å…¥ |
| `canvas-progress-tracker/obsidian-plugin/src/api/ApiClient.ts` | Modified | `deleteMultimodal()` é€‚é… 204 No Content å“åº” |
| `backend/tests/unit/test_multimodal_path_security.py` | Created | 13 ä¸ªè·¯å¾„éå†å®‰å…¨æµ‹è¯• |
| `backend/tests/e2e/test_multimodal_workflow.py` | Modified | DELETE æ–­è¨€ä» 200 æ›´æ–°ä¸º 204 |
| `backend/tests/contract/test_multimodal_pact_interactions.py` | Created | DELETE éªŒè¯ä» body å­—æ®µæ”¹ä¸º 204 çŠ¶æ€ç  (é Modifiedï¼Œæ˜¯æ–°æ–‡ä»¶) |
| `docs/stories/35.10.story.md` | Modified | æ ‡è®°æ‰€æœ‰ä»»åŠ¡å®Œæˆï¼Œæ·»åŠ  Dev Agent Record |

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-09 | 1.0 | åŸºäºå¯¹æŠ—æ€§å®¡æŸ¥æŠ¥å‘Šåˆ›å»º | John (PM Agent) |
| 2026-02-09 | 2.0 | å®ç°æ‰€æœ‰ AC: è·¯å¾„éå†é˜²æŠ¤ + DELETE 204 + å¥åº·æ£€æŸ¥éªŒè¯ | Amelia (Dev Agent) |
| 2026-02-09 | 2.1 | Code Review ä¿®å¤: H-1 service æ­»ä»£ç , H-2 çœŸå®é˜²å¾¡é“¾æµ‹è¯•, M-1 æ—¥å¿—æ³¨å…¥é˜²æŠ¤, M-2 File List ä¿®æ­£ | Code Review (AI) |
