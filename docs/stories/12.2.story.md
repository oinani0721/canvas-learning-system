# Story 12.2: LanceDB POC验证

## Status: Approved

## Epic Context & Background

**所属Epic**: EPIC-12 - 三层记忆系统 + Agentic RAG
**Epic文档**: [EPIC-12-STORY-MAP.md](../epics/EPIC-12-STORY-MAP.md)

**本Story在Epic中的定位**:
- Phase 1 (基础设施层) 的核心Story
- 验证LanceDB作为ChromaDB替代方案的性能和功能
- **依赖**: 无 (独立POC)
- **被依赖**: Story 12.3, 12.5, 12.6 (后续Story依赖此验证结果)

**Epic核心问题回顾**:

### Problem 1: 向量数据库性能瓶颈
- **现象**: ChromaDB在大规模向量检索时性能下降明显
- **根因**: ChromaDB架构限制，缺乏CUDA加速支持
- **修复**: 引入LanceDB替代ChromaDB
- **本Story验证**: 验证LanceDB在10K和100K向量规模下的检索延迟是否满足要求

### Problem 2: 缺乏多模态支持
- **现象**: 当前系统仅支持文本向量检索
- **根因**: ChromaDB不原生支持ImageBind等多模态嵌入
- **修复**: LanceDB原生支持ImageBind多模态嵌入
- **本Story验证**: 验证ImageBind集成可行性 (Optional)

---

## Story

**As a** Canvas Learning System开发者,
**I want** 验证LanceDB作为语义向量数据库的性能和功能,
**so that** 确认LanceDB能满足系统对向量检索延迟和多模态能力的需求，为后续开发提供技术基础

---

## Acceptance Criteria

### AC 1: 10K向量检索延迟验证 (验证Problem 1核心)
- **测试规模**: 10,000个1536维向量 (OpenAI text-embedding-3-small)
- **性能目标**: P95延迟 < 20ms
- **测试方法**: 运行100次查询，计算P95值
- **Epic关联**: 直接验证ADR-002性能声明
- **失败处理**: 若P95 ≥ 20ms，记录实际延迟值并在报告中分析原因；若P95 > 50ms，建议保留ChromaDB作为备选方案

### AC 2: 100K向量检索延迟验证 (验证Problem 1扩展)
- **测试规模**: 100,000个1536维向量
- **性能目标**: P95延迟 < 50ms
- **测试方法**: 运行100次查询，计算P95值
- **ADR-002参考**: LanceDB预期~10ms @ 100K (vs ChromaDB ~95ms)
- **失败处理**: 若P95 ≥ 50ms，记录实际延迟值并分析是否因缺少CUDA加速导致；若P95 > 100ms，触发ADR-002复审流程，评估是否继续使用ChromaDB

### AC 3: OpenAI Embedding集成验证
- **集成方式**: 使用LanceDB EmbeddingFunctionRegistry
- **模型**: text-embedding-3-small (1536维)
- **验证点**:
  - 正确创建Schema
  - 正确添加数据
  - 正确执行向量搜索
- **代码来源**: Context7 LanceDB文档

### AC 4: 多模态能力验证 (Optional, P2)
- **集成方式**: ImageBind embedding function
- **验证点**: 文本-图像跨模态检索
- **Epic关联**: 为Epic 12.16多模态扩展做准备
- **注意**: 此AC为Optional，不影响Story完成

### AC 5: 性能对比报告
- **对比对象**: LanceDB vs ChromaDB (基于ADR-002数据)
- **报告内容**:
  - 10K/100K向量检索延迟对比
  - 内存占用对比
  - CUDA加速效果 (如果可用)
- **输出**: `docs/reports/lancedb-poc-benchmark-report.md`

---

## Tasks / Subtasks

### 任务1: 环境准备和LanceDB安装 (AC: 1, 2, 3)
- [ ] 1.1: 安装LanceDB Python包
  ```bash
  pip install lancedb
  ```
- [ ] 1.2: 验证CUDA可用性 (可选，但推荐)
  ```python
  # ✅ CUDA验证代码
  import torch

  def check_cuda_availability():
      cuda_available = torch.cuda.is_available()
      if cuda_available:
          device_name = torch.cuda.get_device_name(0)
          vram = torch.cuda.get_device_properties(0).total_memory / (1024**3)
          print(f"✅ CUDA可用: {device_name}, VRAM: {vram:.1f}GB")
      else:
          print("⚠️ CUDA不可用，将使用CPU模式 (性能可能下降)")
      return cuda_available

  # 运行检查
  has_cuda = check_cuda_availability()
  ```
- [ ] 1.3: 创建测试目录 `src/tests/poc/lancedb_poc/`

### 任务2: 创建LanceDB POC测试代码 (AC: 1, 2, 3)
- [ ] 2.1: 创建 `src/tests/poc/lancedb_poc/test_lancedb_performance.py`
  - 包含10K向量性能测试
  - 包含100K向量性能测试
  - 计算P95延迟
- [ ] 2.2: 创建 `src/tests/poc/lancedb_poc/test_lancedb_openai_embedding.py`
  - 使用OpenAI embedding集成
  - 验证Schema定义
  - 验证向量搜索

### 任务3: 实现性能基准测试 (AC: 1, 2)
- [ ] 3.1: 生成10K随机测试向量 (numpy, 1536维)
- [ ] 3.2: 生成100K随机测试向量
- [ ] 3.3: 实现查询延迟测量函数
- [ ] 3.4: 运行100次查询并计算P95

### 任务4: 实现OpenAI Embedding集成测试 (AC: 3)
- [ ] 4.1: 定义LanceDB Schema (使用Pydantic LanceModel)
  ```python
  # ✅ Verified from Context7 LanceDB docs
  from lancedb.pydantic import LanceModel, Vector
  from lancedb.embeddings import EmbeddingFunctionRegistry

  registry = EmbeddingFunctionRegistry().get_instance()
  openai = registry.get("openai").create()

  class CanvasNodeSchema(LanceModel):
      vector: Vector(openai.ndims()) = openai.VectorField()
      text: str = openai.SourceField()
      node_id: str
      canvas_path: str
  ```
- [ ] 4.2: 创建表并添加测试数据
- [ ] 4.3: 执行语义搜索验证

### 任务5: 多模态验证 (AC: 4, Optional)
- [ ] 5.1: 安装ImageBind依赖 (可选)
- [ ] 5.2: 创建多模态Schema
- [ ] 5.3: 验证文本-图像跨模态检索

### 任务6: 生成性能对比报告 (AC: 5)
- [ ] 6.1: 收集所有测试数据
- [ ] 6.2: 创建 `docs/reports/lancedb-poc-benchmark-report.md`
- [ ] 6.3: 包含与ADR-002预期的对比分析

---

## Dev Notes

### Dependencies Verification

**前置依赖验证** (必须先完成):
- [ ] 无Story依赖 (独立POC)
- [ ] Python 3.9+ 环境就绪
- [ ] OpenAI API Key配置 (环境变量 `OPENAI_API_KEY`)
- [ ] 目录结构验证: `src/tests/poc/` 存在

**技术栈依赖**:
- [ ] lancedb >= 0.4.0
- [ ] numpy (向量生成)
- [ ] openai (embedding API)
- [ ] pytest (测试框架)

### SDD规范参考

**API规范** [Source: Context7 /lancedb/lancedb]:

```python
# ✅ Verified from Context7 LanceDB docs - Create Table with OpenAI Embeddings
import lancedb
from lancedb.embeddings import EmbeddingFunctionRegistry
from lancedb.pydantic import LanceModel, Vector

registry = EmbeddingFunctionRegistry().get_instance()
openai = registry.get("openai").create()

class Schema(LanceModel):
    vector: Vector(openai.ndims()) = openai.VectorField()
    text: str = openai.SourceField()

db = lancedb.connect("~/lancedb")
tbl = db.create_table("my_table", schema=Schema, mode="overwrite")
```

```python
# ✅ Verified from Context7 LanceDB docs - Vector Search
results = table.search("query text").limit(10).to_pandas()
```

### ADR决策关联

**ADR-002: LanceDB Selection** [Source: docs/architecture/ADR-002-VECTOR-DATABASE-SELECTION.md]:
- **决策**: 选择LanceDB替代ChromaDB
- **性能预期**:
  - 10K向量: ~2ms (vs ChromaDB ~15ms)
  - 100K向量: ~10ms (vs ChromaDB ~95ms)
- **成本**: ~$8/年 vs ChromaDB ~$4/年
- **多模态**: 支持ImageBind (text/image/audio/video)

**ADR-003: 3-Layer Memory System** [Source: docs/architecture/decisions/0003-graphiti-memory.md]:
- **Layer 3**: Semantic Memory → LanceDB + CUDA加速
- **本Story关系**: 验证Layer 3技术选型

### Testing Standards

**测试文件位置**: `src/tests/poc/lancedb_poc/`

**测试类型**:
- 性能基准测试 (P95延迟)
- 集成测试 (OpenAI embedding)
- 可选: 多模态测试 (ImageBind)

**Mock策略**:
- 性能测试使用随机向量，无需Mock
- OpenAI embedding测试需要真实API Key (CI环境可跳过)

**覆盖率目标**: N/A (POC验证，非生产代码)

### Related Documentation

**Epic和Story文档**:
- [EPIC-12-STORY-MAP.md](../epics/EPIC-12-STORY-MAP.md) - Epic 12完整Story Map
- [EPIC-12-3LAYER-MEMORY-AGENTIC-RAG.md](../epics/EPIC-12-3LAYER-MEMORY-AGENTIC-RAG.md) - Epic 12详细设计

**架构文档** [Source: docs/architecture/]:
- [ADR-002-VECTOR-DATABASE-SELECTION.md](../architecture/ADR-002-VECTOR-DATABASE-SELECTION.md) - LanceDB选型决策
- [MIGRATION-CHROMADB-TO-LANCEDB-ADAPTER.md](../architecture/MIGRATION-CHROMADB-TO-LANCEDB-ADAPTER.md) - 迁移适配器设计

**外部文档**:
- Context7 LanceDB: `/lancedb/lancedb` - API参考
- LanceDB官方文档: https://lancedb.github.io/lancedb/

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-28 | 1.0 | 初始创建 - SM Agent *draft | Bob (SM Agent) |
| 2025-11-28 | 1.1 | PO验证改进: AC 1/2添加失败处理标准; 任务1.2添加CUDA验证代码 | Sarah (PO Agent) |

---

## Dev Agent Record

### Agent Model Used
*待填写*

### Debug Log References
*待填写*

### Completion Notes List
*待填写*

### File List
*待填写*

---

## QA Results

*待QA Agent审查*
