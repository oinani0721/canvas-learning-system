# Story 33.9: EPIC-33 P0 DI Chain Repair

## Status: Done

---

## Story

**As a** Canvas Learning System user,
**I want** the intelligent parallel batch processing system to actually execute batch jobs when I confirm,
**so that** my yellow nodes are processed by agents instead of being stuck in "pending" forever.

---

## Problem Statement

### Adversarial Audit Finding (2026-02-09)

`intelligent_parallel.py:get_service()` constructs `IntelligentParallelService` with:
```python
batch_orchestrator=None,   # Line 111
agent_service=None,        # Line 112
```

This means:
1. **POST /confirm** creates a session but never starts batch execution (perpetual "pending")
2. **POST /cancel** has no BatchOrchestrator to signal cancellation
3. **POST /single-agent** (retry) raises RuntimeError because agent_service is None

A **correct** DI factory already exists at `dependencies.py:1064-1127` (`get_intelligent_parallel_service` + `IntelligentParallelServiceDep`) but **no endpoint uses it** — it is dead code.

### Root Cause

`BatchOrchestrator` and `AgentService` require async construction (GeminiClient needs settings, AgentService needs canvas_service + neo4j_client), but `get_service()` is synchronous. The original developer could not resolve async deps in a sync context, so they passed `None` with a comment referencing a non-existent `set_batch_deps()` method.

### Why Depends() Alone Won't Work

`BatchOrchestrator._cancel_requested` is **instance-level state**. If each request creates a new `BatchOrchestrator` via `Depends()`, the `/cancel` endpoint gets a fresh instance that cannot signal the running batch (which holds a reference to the original instance). The `BatchOrchestrator` **must** be a singleton shared across `/confirm` and `/cancel`.

---

## Recommended Approach: Async Lazy Singleton Initialization

Keep the `get_service()` singleton pattern, but add an async initialization step that injects the missing dependencies on first use.

```
Startup/First Request
    │
    ├── get_service()             ← sync: creates service skeleton
    │     grouping_service  ✅
    │     session_manager   ✅
    │     routing_engine    ✅
    │     batch_orchestrator = None  ← PROBLEM
    │     agent_service = None       ← PROBLEM
    │
    └── _ensure_async_deps()      ← async: fills in the missing deps
          GeminiClient(settings)   → gemini_client
          AgentService(gemini, ...)  → agent_service
          BatchOrchestrator(session_mgr, agent_svc, routing, ...)  → batch_orchestrator
          service._batch_orchestrator = batch_orchestrator  ✅
          service._agent_service = agent_service            ✅
```

Each endpoint calls `await _ensure_async_deps()` (idempotent, no-op after first call) before `return get_service()`.

---

## Acceptance Criteria

### AC-33.9.1: batch_orchestrator is injected (P0)
- **Given** the backend server is running
- **When** any endpoint calls `get_service()`
- **Then** `service._batch_orchestrator is not None`
- **And** the BatchOrchestrator was constructed with `session_manager`, `agent_service`, `canvas_service`, `vault_path`, and `routing_engine`

### AC-33.9.2: agent_service is injected (P0)
- **Given** the backend server is running
- **When** any endpoint calls `get_service()`
- **Then** `service._agent_service is not None`
- **And** the AgentService was constructed with `gemini_client`, `canvas_service`, `neo4j_client`

### AC-33.9.3: /confirm starts batch execution (P0)
- **Given** a valid grouping preview has been generated
- **When** the user calls `POST /api/v1/canvas/intelligent-parallel/confirm`
- **Then** the response is `202 Accepted` with a session_id
- **And** polling `GET /api/v1/canvas/intelligent-parallel/{session_id}` shows status transitioning from `pending` → `running` → `completed` (not stuck at `pending`)

### AC-33.9.4: /cancel can cancel a running batch (P0)
- **Given** a batch session is in `running` state
- **When** the user calls `POST /api/v1/canvas/intelligent-parallel/cancel`
- **Then** the running tasks complete gracefully
- **And** remaining tasks are skipped
- **And** session status becomes `cancelled`

### AC-33.9.5: /single-agent (retry) works (P0)
- **Given** a previously failed node exists
- **When** the user calls `POST /api/v1/canvas/intelligent-parallel/single-agent`
- **Then** the agent is invoked (no RuntimeError)
- **And** the result is returned successfully

### AC-33.9.6: routing_engine is passed to BatchOrchestrator (P1)
- **Given** the BatchOrchestrator is constructed
- **Then** `batch_orchestrator._routing_engine is not None`
- **And** content auto-routing functions correctly during batch execution

### AC-33.9.7: DI completeness integration test (P1)
- A new test file `tests/integration/test_epic33_di_completeness.py` verifies:
  - `get_service()` returns a service where `_batch_orchestrator is not None`
  - `get_service()` returns a service where `_agent_service is not None`
  - `service._batch_orchestrator._routing_engine is not None`
  - The service can successfully call `start_batch_session` (not just return pending)

### AC-33.9.8: Cleanup phantom code (P2)
- Remove `set_batch_deps()` references from comments (line 111, 112)
- Remove or repurpose the dead code `get_intelligent_parallel_service()` in dependencies.py (either use it or delete it)
- All existing tests pass (321+ tests, zero regressions)

---

## Technical Details

### Files to Modify

| File | Change | Priority |
|------|--------|----------|
| `backend/app/api/v1/endpoints/intelligent_parallel.py` | Add `_ensure_async_deps()`, modify `get_service()` | P0 |
| `backend/app/dependencies.py` | (Optional) Clean up dead code or wire it in | P2 |
| `backend/tests/integration/test_epic33_di_completeness.py` | New file: DI integration test | P1 |

### Key Constructors Reference

**AgentService** (`agent_service.py:992-1000`):
```python
AgentService(
    gemini_client=GeminiClient(api_key, model, base_url),
    canvas_service=CanvasService(canvas_base_path=...),
    neo4j_client=get_neo4j_client_dep(),
)
```

**BatchOrchestrator** (`batch_orchestrator.py:162-170`):
```python
BatchOrchestrator(
    session_manager=get_session_manager(),
    agent_service=agent_service,
    canvas_service=canvas_service,
    vault_path=str(settings.canvas_base_path),
    routing_engine=get_agent_routing_engine(),
)
```

**IntelligentParallelService** (`intelligent_parallel_service.py:56-65`):
```python
IntelligentParallelService(
    grouping_service=...,
    session_manager=...,
    batch_orchestrator=...,   # ← MUST NOT BE None
    agent_service=...,        # ← MUST NOT BE None
    routing_engine=...,
)
```

### Singleton Constraint

`BatchOrchestrator._cancel_requested` is instance-level state. The `/confirm` and `/cancel` endpoints MUST share the same `BatchOrchestrator` instance. Therefore:
- The BatchOrchestrator must be created once and stored in the singleton service
- Per-request `Depends()` pattern is NOT suitable for this component

### Warning Log Sentinel

After the fix, the following WARNING messages should **never** appear in startup logs:
```
"batch_orchestrator not injected"
"agent_service not injected"
```

If they appear, the fix is incomplete.

---

## Out of Scope

- WebSocket hardcoded host (P2 #9 from audit — separate story)
- Optional[Any] type safety improvement (P2 #10 — separate refactor)
- _cancel_requested memory leak (P2 #11 — separate story)
- Rearchitecting to pure Depends() pattern (would require making BatchOrchestrator stateless)

---

## Test Plan

```bash
# 1. Unit tests (existing — must not regress)
cd backend && python -m pytest tests/unit/test_intelligent_parallel_endpoints.py -v

# 2. New DI completeness test
python -m pytest tests/integration/test_epic33_di_completeness.py -v

# 3. Full regression
python -m pytest tests/ -v --timeout=120

# 4. Manual verification
python -m uvicorn app.main:app --reload --port 8000
# Check logs for absence of "not injected" warnings
# Call /confirm → poll status → should transition from pending → running → completed
```

---

## Definition of Done

- [ ] `service._batch_orchestrator is not None` in production
- [ ] `service._agent_service is not None` in production
- [ ] `service._batch_orchestrator._routing_engine is not None`
- [ ] No "not injected" WARNING in startup logs
- [ ] `/confirm` → session reaches `completed` (not perpetual `pending`)
- [ ] DI completeness integration test passes
- [ ] All 321+ existing tests pass
- [ ] Phantom `set_batch_deps()` comments removed
