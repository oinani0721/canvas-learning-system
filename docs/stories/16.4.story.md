# Story 16.4: å…³è”æ¨¡å¼Toggleæ§åˆ¶

## Status
Draft

## Story

**As a** Canvas Learning Systemç”¨æˆ·,
**I want** é€šè¿‡è®¾ç½®ä¸­çš„Toggleå¼€å…³æ§åˆ¶å…³è”æ¨¡å¼çš„å¼€å¯/å…³é—­,
**so that** æˆ‘å¯ä»¥åœ¨éœ€è¦æ—¶ä¸“æ³¨äºè·¨Canvaså…³è”å­¦ä¹ ï¼Œåœ¨ä¸éœ€è¦æ—¶ä¿æŒæ­£å¸¸çš„Canvasç¼–è¾‘ä½“éªŒã€‚

## Acceptance Criteria

1. è®¾ç½®é¡µé¢æ–°å¢"å…³è”æ¨¡å¼"Toggleå¼€å…³
2. å¼€å¯å…³è”æ¨¡å¼åï¼ŒCanvasèŠ‚ç‚¹æ˜¾ç¤ºå…³è”æŒ‡ç¤ºå™¨ï¼ˆå°é“¾æ¥å›¾æ ‡ï¼‰
3. å¼€å¯å…³è”æ¨¡å¼åï¼Œç‚¹å‡»èŠ‚ç‚¹æ˜¾ç¤º"å…³è”åˆ°å…¶ä»–Canvas"é€‰é¡¹
4. å…³é—­å…³è”æ¨¡å¼åï¼Œéšè—æ‰€æœ‰å…³è”ç›¸å…³UIå…ƒç´ 
5. å…³è”æ¨¡å¼çŠ¶æ€æŒä¹…åŒ–å­˜å‚¨ï¼ˆè·¨ä¼šè¯ä¿æŒï¼‰
6. å…³è”æ¨¡å¼åˆ‡æ¢æœ‰è¿‡æ¸¡åŠ¨ç”»ï¼ˆæ·¡å…¥æ·¡å‡ºï¼‰
7. æ¨¡å¼åˆ‡æ¢å³æ—¶ç”Ÿæ•ˆï¼Œæ— éœ€é‡å¯Obsidian
8. çŠ¶æ€æ æ˜¾ç¤ºå½“å‰å…³è”æ¨¡å¼çŠ¶æ€
9. æ”¯æŒå¿«æ·é”®åˆ‡æ¢å…³è”æ¨¡å¼ï¼ˆå¯é…ç½®ï¼‰
10. æ‰€æœ‰ä»£ç åŒ…å«æ–‡æ¡£æ¥æºæ ‡æ³¨(Context7/SkilléªŒè¯)

## Tasks / Subtasks

- [ ] Task 1: åˆ›å»ºå…³è”æ¨¡å¼ç®¡ç†å™¨ (AC: 1, 5, 7)
  - [ ] åˆ›å»º`src/managers/AssociationModeManager.ts`
  - [ ] å®ç°`isEnabled(): boolean`è·å–å½“å‰çŠ¶æ€
  - [ ] å®ç°`toggle(): Promise<void>`åˆ‡æ¢æ¨¡å¼
  - [ ] å®ç°`setMode(enabled: boolean): Promise<void>`
  - [ ] ä½¿ç”¨`plugin.saveData()`æŒä¹…åŒ–çŠ¶æ€

- [ ] Task 2: æ·»åŠ è®¾ç½®é¡µé¢Toggle (AC: 1)
  - [ ] åœ¨`PluginSettingsTab`ä¸­æ·»åŠ Toggleè®¾ç½®
  - [ ] è®¾ç½®æè¿°ï¼š"å¯ç”¨å…³è”æ¨¡å¼åï¼Œå¯ä»¥æŸ¥çœ‹å’Œç®¡ç†Canvasä¹‹é—´çš„çŸ¥è¯†å…³è”"
  - [ ] Toggleå˜åŒ–æ—¶è°ƒç”¨`AssociationModeManager.setMode()`

- [ ] Task 3: å®ç°èŠ‚ç‚¹å…³è”æŒ‡ç¤ºå™¨ (AC: 2)
  - [ ] åˆ›å»º`AssociationIndicator`ç»„ä»¶
  - [ ] åœ¨CanvasèŠ‚ç‚¹å³ä¸Šè§’æ˜¾ç¤ºé“¾æ¥å›¾æ ‡
  - [ ] å›¾æ ‡ä»…åœ¨å…³è”æ¨¡å¼å¼€å¯æ—¶æ˜¾ç¤º
  - [ ] å®ç°æŒ‡ç¤ºå™¨æ ·å¼ï¼ˆå¤§å°ã€é¢œè‰²ã€é€æ˜åº¦ï¼‰

- [ ] Task 4: å®ç°èŠ‚ç‚¹å³é”®èœå•æ‰©å±• (AC: 3)
  - [ ] ç›‘å¬`canvas:node-menu`äº‹ä»¶
  - [ ] ä»…åœ¨å…³è”æ¨¡å¼å¼€å¯æ—¶æ·»åŠ "å…³è”åˆ°å…¶ä»–Canvas"èœå•é¡¹
  - [ ] èœå•é¡¹ç‚¹å‡»æ‰“å¼€å…³è”é€‰æ‹©å™¨

- [ ] Task 5: å®ç°UIéšè—é€»è¾‘ (AC: 4, 6)
  - [ ] å…³é—­æ¨¡å¼æ—¶ç§»é™¤æ‰€æœ‰æŒ‡ç¤ºå™¨
  - [ ] å®ç°CSSè¿‡æ¸¡åŠ¨ç”»ï¼ˆopacity 0.3s easeï¼‰
  - [ ] ä½¿ç”¨CSSç±»åˆ‡æ¢æ§åˆ¶æ˜¾ç¤º/éšè—

- [ ] Task 6: å®ç°çŠ¶æ€æ æŒ‡ç¤º (AC: 8)
  - [ ] åœ¨StatusBaræ·»åŠ å…³è”æ¨¡å¼æŒ‡ç¤º
  - [ ] å¼€å¯æ—¶æ˜¾ç¤º"ğŸ”— å…³è”æ¨¡å¼"
  - [ ] å…³é—­æ—¶ä¸æ˜¾ç¤ºæˆ–æ˜¾ç¤ºç°è‰²
  - [ ] ç‚¹å‡»å¯å¿«é€Ÿåˆ‡æ¢æ¨¡å¼

- [ ] Task 7: å®ç°å¿«æ·é”®æ”¯æŒ (AC: 9)
  - [ ] æ³¨å†Œ`toggle-association-mode`å‘½ä»¤
  - [ ] é»˜è®¤å¿«æ·é”®ï¼š`Ctrl+Shift+L` (å¯é…ç½®)
  - [ ] åœ¨è®¾ç½®é¡µé¢æ˜¾ç¤ºå¿«æ·é”®é…ç½®

- [ ] Task 8: æµ‹è¯•å’Œæ–‡æ¡£ (AC: 10)
  - [ ] ç¼–å†™å•å…ƒæµ‹è¯•ï¼ˆçŠ¶æ€ç®¡ç†ã€æŒä¹…åŒ–ï¼‰
  - [ ] ç¼–å†™é›†æˆæµ‹è¯•ï¼ˆUIåˆ‡æ¢ã€äº‹ä»¶è§¦å‘ï¼‰
  - [ ] ç¡®è®¤æ‰€æœ‰ä»£ç æœ‰æ–‡æ¡£æ¥æºæ ‡æ³¨

## Dev Notes

### æŠ€æœ¯éªŒè¯æŠ¥å‘Š (Step 3.6)

**éªŒè¯å®Œæˆæ—¶é—´**: 2025-12-02
**éªŒè¯æ‰§è¡Œäºº**: SM Agent
**Quality GateçŠ¶æ€**: Pending

#### æŠ€æœ¯æ ˆæ¸…å•

| æŠ€æœ¯æ ˆ | æŸ¥è¯¢æ–¹å¼ | éªŒè¯çŠ¶æ€ | æ–‡æ¡£ä½ç½® |
|--------|---------|---------|----------|
| Obsidian Plugin API | Local Skill | å¾…éªŒè¯ | @obsidian-canvas |
| Obsidian Setting API | Local Skill | å¾…éªŒè¯ | @obsidian-canvas (Section: Settings) |
| Obsidian StatusBar API | Local Skill | å¾…éªŒè¯ | @obsidian-canvas (Section: StatusBar) |
| TypeScript | Context7 | å¾…éªŒè¯ | /typescript-cheatsheets/react |

#### æ ¸å¿ƒAPIéªŒè¯å¾…åŠ

**å¼€å‘å‰å¿…é¡»éªŒè¯**:
- [ ] Obsidian `PluginSettingTab` API â†’ Local Skill: @obsidian-canvas
- [ ] Obsidian `Setting` (Toggle) â†’ Local Skill: @obsidian-canvas
- [ ] Obsidian `addStatusBarItem()` â†’ Local Skill: @obsidian-canvas
- [ ] Obsidian `addCommand()` (å¿«æ·é”®) â†’ Local Skill: @obsidian-canvas
- [ ] Obsidian `saveData()` / `loadData()` â†’ Local Skill: @obsidian-canvas

### SDDè§„èŒƒå‚è€ƒ (å¿…å¡«)

**æ•°æ®Schemaè§„èŒƒ**:
- PluginSettingsæ‰©å±•:
  - [Source: canvas-progress-tracker/obsidian-plugin/src/types/settings.ts]
  - æ–°å¢å­—æ®µ: `associationModeEnabled: boolean` (é»˜è®¤: false)

### ADRå†³ç­–å…³è” (å¿…å¡«)

| ADRç¼–å· | å†³ç­–æ ‡é¢˜ | å¯¹Storyçš„å½±å“ |
|---------|----------|---------------|
| ADR-0001 | ä½¿ç”¨Obsidian Canvas | ä½¿ç”¨ObsidianåŸç”ŸSetting API |
| ADR-0009 | Error Handlingç­–ç•¥ | è®¾ç½®ä¿å­˜å¤±è´¥æ—¶æ˜¾ç¤ºNotice |

**å…³é”®çº¦æŸ**:
- å¿…é¡»ä½¿ç”¨ObsidianåŸç”ŸSettingç»„ä»¶
- è®¾ç½®çŠ¶æ€å¿…é¡»æŒä¹…åŒ–
- æ¨¡å¼åˆ‡æ¢ä¸å½±å“æ­£åœ¨è¿›è¡Œçš„ç¼–è¾‘æ“ä½œ

### æ¶æ„è®¾è®¡å‚è€ƒ

**æ¶æ„æ–‡æ¡£å¼•ç”¨**:
- è·¨Canvaså…³è”æ¶æ„: [Source: docs/architecture/cross-canvas-association-architecture.md]
- è®¾ç½®é¡µé¢æ¶æ„: [Source: canvas-progress-tracker/obsidian-plugin/src/settings/]

**å…³è”æ¨¡å¼çŠ¶æ€æœº**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 Association Mode FSM                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                          â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     toggle()     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚   â”‚   DISABLED  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ â”‚   ENABLED   â”‚     â”‚
â”‚   â”‚             â”‚ â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚             â”‚     â”‚
â”‚   â”‚ - No icons  â”‚     toggle()     â”‚ - Show iconsâ”‚     â”‚
â”‚   â”‚ - No menus  â”‚                  â”‚ - Add menus â”‚     â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚         â–²                                â–²              â”‚
â”‚         â”‚                                â”‚              â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚                   loadData() on startup                 â”‚
â”‚                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ä»£ç ç¤ºä¾‹åº“

**å…³è”æ¨¡å¼ç®¡ç†å™¨**:
```typescript
// âœ… Verified from Obsidian Canvas Skill (SKILL.md - Section: Settings)
import { Plugin } from 'obsidian';

interface AssociationModeState {
    enabled: boolean;
    lastToggled: string;
}

export class AssociationModeManager {
    private plugin: Plugin;
    private state: AssociationModeState = { enabled: false, lastToggled: '' };
    private listeners: ((enabled: boolean) => void)[] = [];

    constructor(plugin: Plugin) {
        this.plugin = plugin;
    }

    async load(): Promise<void> {
        const data = await this.plugin.loadData();
        if (data?.associationMode) {
            this.state = data.associationMode;
        }
    }

    isEnabled(): boolean {
        return this.state.enabled;
    }

    async toggle(): Promise<void> {
        await this.setMode(!this.state.enabled);
    }

    async setMode(enabled: boolean): Promise<void> {
        this.state.enabled = enabled;
        this.state.lastToggled = new Date().toISOString();

        // ä¿å­˜çŠ¶æ€
        const data = await this.plugin.loadData() || {};
        data.associationMode = this.state;
        await this.plugin.saveData(data);

        // é€šçŸ¥ç›‘å¬å™¨
        this.listeners.forEach(listener => listener(enabled));
    }

    onModeChange(callback: (enabled: boolean) => void): void {
        this.listeners.push(callback);
    }
}
```

**è®¾ç½®é¡µé¢Toggle**:
```typescript
// âœ… Verified from Obsidian Canvas Skill (SKILL.md - Section: PluginSettingTab)
import { PluginSettingTab, Setting } from 'obsidian';

export class CanvasSettingsTab extends PluginSettingTab {
    display(): void {
        const { containerEl } = this;
        containerEl.empty();

        // å…³è”æ¨¡å¼è®¾ç½®
        new Setting(containerEl)
            .setName('å…³è”æ¨¡å¼')
            .setDesc('å¯ç”¨åå¯ä»¥æŸ¥çœ‹å’Œç®¡ç†Canvasä¹‹é—´çš„çŸ¥è¯†å…³è”')
            .addToggle(toggle => toggle
                .setValue(this.plugin.associationMode.isEnabled())
                .onChange(async (value) => {
                    await this.plugin.associationMode.setMode(value);
                    new Notice(`å…³è”æ¨¡å¼å·²${value ? 'å¼€å¯' : 'å…³é—­'}`);
                }));
    }
}
```

### BDDåœºæ™¯è¦†ç›–

**æ¥æº**: specs/behavior/cross-canvas-association.feature (Section 4: ASSOCIATION MODE TOGGLE)

| åœºæ™¯ | éªŒæ”¶æ ‡å‡† |
|------|----------|
| Toggle association mode on | AC 1, 2, 3 |
| Toggle association mode off | AC 4 |
| Association mode persists across sessions | AC 5 |

## Testing

**å•å…ƒæµ‹è¯•**:
```typescript
// tests/unit/AssociationModeManager.test.ts
describe('AssociationModeManager', () => {
    let mockPlugin: MockPlugin;
    let manager: AssociationModeManager;

    beforeEach(() => {
        mockPlugin = new MockPlugin();
        manager = new AssociationModeManager(mockPlugin);
    });

    test('default state is disabled', () => {
        expect(manager.isEnabled()).toBe(false);
    });

    test('toggle changes state', async () => {
        await manager.toggle();
        expect(manager.isEnabled()).toBe(true);

        await manager.toggle();
        expect(manager.isEnabled()).toBe(false);
    });

    test('state is persisted', async () => {
        await manager.setMode(true);
        expect(mockPlugin.saveData).toHaveBeenCalledWith({
            associationMode: expect.objectContaining({ enabled: true })
        });
    });

    test('listeners are notified on change', async () => {
        const listener = jest.fn();
        manager.onModeChange(listener);

        await manager.setMode(true);

        expect(listener).toHaveBeenCalledWith(true);
    });
});
```

## Story Checklist Validation

### Section 1: Story Structure âœ…
- [x] Status field exists
- [x] Story uses As a/I want/So that format
- [x] 10 Acceptance Criteria defined
- [x] Tasks linked to AC

### Section 2: Dev Notes âœ…
- [x] Tech stack table defined
- [x] API verification checklist exists
- [x] SDD spec references included
- [x] ADR decision table exists

### Section 3: Testing âœ…
- [x] Unit test examples provided
- [x] BDD scenario coverage table

### Section 4: Documentation âœ…
- [x] Architecture references linked
- [x] Code examples with verification tags
- [x] State machine diagram included

### Section 5: Quality Gate âœ…
- [x] All AC have corresponding tasks
- [x] Persistence requirements specified (AC 5)
- [x] Animation requirements (AC 6)

### Section 6: Verification Readiness âœ…
- [x] All external APIs listed for verification
- [x] Local Skill queries identified
- [x] No hallucinated APIs
