# Story 12.4: Temporal Memory实现

## Status: Approved

## Epic Context & Background

**所属Epic**: EPIC-12 - 三层记忆系统 + Agentic RAG
**Epic文档**: [EPIC-12-STORY-MAP.md](../epics/EPIC-12-STORY-MAP.md)

**本Story在Epic中的定位**:
- Phase 1 (基础设施层) 的核心Story
- 实现3层记忆系统的Layer 1: Temporal Memory (时序记忆)
- **依赖**: 无 (独立实现)
- **被依赖**: Story 12.5, 12.10 (StateGraph和检验白板集成依赖此功能)

**Epic核心问题回顾**:

### Problem 5: 缺乏学习行为时序追踪
- **现象**: 系统无法追踪用户学习行为的时间序列
- **根因**: 没有时序数据库记录学习历史
- **修复**: 实现SQLite时序数据库 + FSRS遗忘曲线算法
- **本Story验证**: 验证学习行为记录和FSRS卡片管理功能

### Problem 6: 艾宾浩斯复习系统缺乏薄弱点推荐
- **现象**: 复习系统无法智能推荐需要复习的概念
- **根因**: 缺乏FSRS算法集成
- **修复**: 集成py-fsrs库，实现get_weak_concepts()
- **本Story验证**: 验证低稳定性概念排序正确

---

## Story

**As a** Canvas学习系统,
**I want** 追踪学习行为时序和FSRS遗忘曲线,
**so that** 支持艾宾浩斯复习系统的薄弱点智能推荐

---

## Acceptance Criteria

### AC 1: FSRS库集成成功 (验证Problem 6基础)
- **库安装**: `pip install fsrs`
- **核心对象**:
  - `Scheduler()` 调度器初始化
  - `Card()` 卡片对象创建
  - `Rating` 评分枚举 (Again=1, Hard=2, Good=3, Easy=4)
- **验证方式**: 单元测试调用FSRS API成功
- **Context7来源**: `/open-spaced-repetition/py-fsrs`

### AC 2: 学习行为时序追踪 (验证Problem 5)
- **数据库**: SQLite `learning_behavior.db`
- **Schema**:
  ```sql
  CREATE TABLE learning_behaviors (
      id INTEGER PRIMARY KEY,
      session_id TEXT,
      canvas_file TEXT,
      concept TEXT,
      action_type TEXT,
      timestamp DATETIME,
      metadata JSON
  )
  ```
- **API**: `record_behavior(canvas_file, concept, action_type, metadata)`
- **Epic关联**: 为艾宾浩斯复习系统提供时序数据

### AC 3: get_weak_concepts()返回低稳定性概念 (验证Problem 6核心)
- **输入**: `canvas_file="离散数学.canvas", limit=10`
- **输出**: `List[str]` 概念名称列表
- **排序逻辑**: 按FSRS stability升序排列
- **权重**: 70%低稳定性 + 30%高错误率 (PRD v1.1.8)
- **ADR-003引用**: 检验白板生成薄弱点推荐

### AC 4: update_behavior()更新FSRS卡片 (验证Problem 6)
- **输入**: `concept, rating (1-4分)`
- **更新字段**: `Card.difficulty`, `Card.stability`, `Card.due`
- **验证**: due日期基于FSRS-4.5算法正确计算
- **Context7来源**: `scheduler.review_card(card, rating)`

### AC 5: 性能和数据持久化
- **存储**: 1000个概念FSRS卡片存储成功
- **查询**: `get_weak_concepts()` 延迟 < 50ms
- **数据库大小**: < 10MB (1000概念场景)
- **Epic关联**: 确保系统性能满足PRD要求

---

## Tasks / Subtasks

### 任务1: 创建Temporal Memory模块结构 (AC: 1, 2, 3, 4, 5)
- [ ] 1.1: 创建目录 `src/memory/temporal/`
- [ ] 1.2: 创建文件结构:
  ```
  src/memory/temporal/
  ├── __init__.py
  ├── temporal_memory.py     # 核心类
  ├── fsrs_manager.py        # FSRS卡片管理
  ├── behavior_tracker.py    # 行为追踪
  └── schema.py              # SQLite Schema
  ```
- [ ] 1.3: 创建数据目录 `data/temporal/`

### 任务2: 实现FSRS集成 (AC: 1)
- [ ] 2.1: 安装py-fsrs库
  ```bash
  pip install fsrs
  ```
- [ ] 2.2: 创建 `fsrs_manager.py`
  ```python
  # ✅ Verified from Context7 /open-spaced-repetition/py-fsrs
  from fsrs import Scheduler, Card, Rating, ReviewLog

  class FSRSManager:
      def __init__(self):
          self.scheduler = Scheduler()

      def create_card(self) -> Card:
          return Card()

      def review_card(self, card: Card, rating: int) -> tuple[Card, ReviewLog]:
          rating_enum = Rating(rating)
          return self.scheduler.review_card(card, rating_enum)

      def get_retrievability(self, card: Card) -> float:
          return self.scheduler.get_card_retrievability(card)
  ```
- [ ] 2.3: 测试: 验证FSRS API调用成功

### 任务3: 实现SQLite时序数据库 (AC: 2)
- [ ] 3.1: 创建 `schema.py`
  ```python
  BEHAVIOR_SCHEMA = """
  CREATE TABLE IF NOT EXISTS learning_behaviors (
      id INTEGER PRIMARY KEY AUTOINCREMENT,
      session_id TEXT NOT NULL,
      canvas_file TEXT NOT NULL,
      concept TEXT NOT NULL,
      action_type TEXT NOT NULL,
      timestamp DATETIME DEFAULT CURRENT_TIMESTAMP,
      metadata TEXT
  )
  """

  FSRS_CARD_SCHEMA = """
  CREATE TABLE IF NOT EXISTS fsrs_cards (
      concept TEXT PRIMARY KEY,
      canvas_file TEXT,
      difficulty REAL,
      stability REAL,
      due DATETIME,
      state INTEGER,
      last_review DATETIME,
      reps INTEGER DEFAULT 0,
      lapses INTEGER DEFAULT 0,
      card_data TEXT
  )
  """
  ```
- [ ] 3.2: 创建 `behavior_tracker.py`
- [ ] 3.3: 实现 `record_behavior()` API
- [ ] 3.4: 测试: 验证行为记录持久化

### 任务4: 实现TemporalMemory核心类 (AC: 2, 3, 4)
- [ ] 4.1: 创建 `temporal_memory.py`
  ```python
  class TemporalMemory:
      def __init__(self, db_path: str = "data/temporal/learning_behavior.db"):
          self.db_path = db_path
          self.fsrs_manager = FSRSManager()
          self._init_db()

      def record_behavior(self, canvas_file: str, concept: str,
                         action_type: str, metadata: dict = None) -> str:
          """记录学习行为"""
          pass

      def get_weak_concepts(self, canvas_file: str, limit: int = 10) -> List[str]:
          """获取低稳定性概念列表 (70%低稳定性 + 30%高错误率)"""
          pass

      def update_behavior(self, concept: str, rating: int) -> None:
          """更新FSRS卡片"""
          pass
  ```
- [ ] 4.2: 实现 `get_weak_concepts()` 排序逻辑
- [ ] 4.3: 实现 `update_behavior()` FSRS更新
- [ ] 4.4: 测试: 验证完整流程

### 任务5: 实现性能优化 (AC: 5)
- [ ] 5.1: 添加SQLite索引
  ```sql
  CREATE INDEX idx_canvas_concept ON fsrs_cards(canvas_file, concept);
  CREATE INDEX idx_stability ON fsrs_cards(stability);
  ```
- [ ] 5.2: 实现查询缓存 (可选)
- [ ] 5.3: 性能测试: 1000概念场景

### 任务6: 创建测试套件 (AC: 1-5)
- [ ] 6.1: 创建 `src/tests/memory/test_temporal_memory.py`
- [ ] 6.2: 测试FSRS集成
- [ ] 6.3: 测试行为记录
- [ ] 6.4: 测试get_weak_concepts()
- [ ] 6.5: 测试update_behavior()
- [ ] 6.6: 性能基准测试

---

## Dev Notes

### Dependencies Verification

**前置依赖验证** (必须先完成):
- [ ] 无Story依赖 (独立实现)
- [ ] Python 3.9+ 环境就绪
- [ ] SQLite3 可用 (Python内置)

**技术栈依赖**:
- [ ] fsrs >= 3.0.0 (py-fsrs)
- [ ] sqlite3 (Python内置)
- [ ] pytest (测试框架)

### SDD规范参考

**FSRS API** [Source: Context7 /open-spaced-repetition/py-fsrs]:

```python
# ✅ Verified from Context7 - Initialize FSRS Scheduler
from fsrs import Scheduler, Card, Rating, ReviewLog

scheduler = Scheduler()

# ✅ Verified from Context7 - Create Card
card = Card()  # 新卡片立即due

# ✅ Verified from Context7 - Review Card with Rating
# Rating.Again (==1) forgot the card
# Rating.Hard (==2) remembered with serious difficulty
# Rating.Good (==3) remembered after hesitation
# Rating.Easy (==4) remembered easily
rating = Rating.Good
card, review_log = scheduler.review_card(card, rating)

# ✅ Verified from Context7 - Get Retrievability
retrievability = scheduler.get_card_retrievability(card)
# Returns probability of remembering (e.g., 0.94)

# ✅ Verified from Context7 - Check Due Date
due = card.due
```

**Rating枚举** [Source: Context7 py-fsrs]:
```python
Rating.Again  # ==1, forgot the card
Rating.Hard   # ==2, remembered with serious difficulty
Rating.Good   # ==3, remembered after hesitation
Rating.Easy   # ==4, remembered easily
```

**State枚举** [Source: Context7 py-fsrs]:
```python
State.Learning    # ==1, new card being studied
State.Review      # ==2, card graduated from Learning
State.Relearning  # ==3, card lapsed from Review
```

### ADR决策关联

**ADR-003: Graphiti Memory System** [Source: docs/architecture/decisions/0003-graphiti-memory.md]:
- **3层记忆系统**: Layer 1 = Temporal Memory
- **艾宾浩斯复习**: py-fsrs算法集成
- **薄弱点推荐**: 70%低稳定性 + 30%高错误率

**本Story与3层架构关系**:
```
Layer 1: Temporal Memory (时序记忆) ← 本Story实现
  ↓ SQLite + FSRS
  ↓ 存储: 学习行为 + FSRS卡片

Layer 2: Graphiti (概念关系网络)
  ↓ Story 12.1 实现

Layer 3: Semantic Memory (语义向量)
  ↓ Story 12.2, 12.3 实现
```

### Testing Standards

**测试文件位置**: `src/tests/memory/`

**测试类型**:
- 单元测试 (FSRS API, SQLite操作)
- 集成测试 (完整流程)
- 性能测试 (1000概念基准)

**Mock策略**:
- FSRS使用真实库 (无需Mock)
- SQLite使用内存数据库 (`:memory:`)

**覆盖率目标**: ≥80%

### Related Documentation

**Epic和Story文档**:
- [EPIC-12-STORY-MAP.md](../epics/EPIC-12-STORY-MAP.md) - Epic 12完整Story Map
- [12.1.story.md](./12.1.story.md) - Graphiti时序知识图谱集成 (Layer 2)

**架构文档** [Source: docs/architecture/]:
- [0003-graphiti-memory.md](../architecture/decisions/0003-graphiti-memory.md) - 3层记忆系统ADR
- [ebbinghaus-review-system-architecture.md](../architecture/ebbinghaus-review-system-architecture.md) - 艾宾浩斯系统架构

**外部文档**:
- Context7 py-fsrs: `/open-spaced-repetition/py-fsrs` - FSRS API参考
- FSRS算法说明: https://github.com/open-spaced-repetition/py-fsrs

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-28 | 1.0 | 初始创建 - SM Agent *draft | Bob (SM Agent) |

---

## Dev Agent Record

### Agent Model Used
*待填写*

### Debug Log References
*待填写*

### Completion Notes List
*待填写*

### File List
*待填写*

---

## QA Results

*待QA Agent审查*
