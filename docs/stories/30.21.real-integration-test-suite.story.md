# Story 30.21: 真实环境集成测试套件 (Mock 性能基准替代)

**Epic**: [EPIC-30: Memory System Complete Activation](../epics/EPIC-30-MEMORY-SYSTEM-COMPLETE-ACTIVATION.md)
**Priority**: P0
**Estimated Hours**: 10
**Dependencies**: Story 30.16 (Docker Neo4j 基础设施), Story 30.10 (幂等性实现)

---

## Status

**Review** — 8 个测试通过 (4 integration + 3 fallback + 1 marker), Benchmark 报告已生成. ⚠️ Task 2.4 (Mock 基准标注) 延迟至单独 PR

---

## Story

**As a** developer,
**I want** integration tests running against real Neo4j that validate idempotency, performance benchmarks, and fallback behaviors,
**so that** the Mock-based performance claims are replaced with real measurements and Neo4j idempotency is verified at the database level.

---

## Problem Statement

对抗性审查 (2026-02-10) 发现 3 个关键问题:

1. **性能基准虚假 (发现 #3)**: `test_batch_50_events_under_500ms` 使用 `AsyncMock()` — Mock 环境零延迟，"< 500ms" 毫无意义。
2. **幂等性只验证 Mock (发现 #9)**: 去重验证仅在 `memory_service._episodes` 内存列表执行，从未在 Neo4j MERGE 层验证。
3. **85-90% Mock 比例 (发现 #6)**: 3 层存储的复杂交互无法仅靠 Mock 验证。

**核心矛盾**: EPIC 30 的核心目标是 "Neo4j 持久化"，但没有一个测试验证了真实 Neo4j 持久化行为。

---

## Acceptance Criteria

### AC-30.21.1: 真实 Neo4j 幂等性验证
- **Given** `NEO4J_MOCK=false` 且 Neo4j 服务可用
- **When** 同一事件 (相同 canvas_path + node_id + concept) 被提交两次
- **Then** Neo4j 中只存在 1 条记录 (MERGE 去重)
- **And** 第二次返回的 `episode_id` 与第一次相同
- **And** Cypher 查询 `MATCH (e:Episode {id: $id}) RETURN count(e)` 返回 1

### AC-30.21.2: 真实性能基准
- **Given** 真实 Neo4j 连接 (非 Mock)
- **When** 提交 50 个不同事件批量写入
- **Then** 记录实际耗时 (wall clock)
- **And** 输出结构化 benchmark 报告: `{env: "Real Neo4j", events: 50, elapsed_ms: X, avg_ms: Y}`
- **And** 报告写入 `_bmad-output/test-artifacts/benchmark-epic30-real.md`
- **Note**: 不设硬性阈值，记录真实值供参考。Mock 环境基准标注为 `env: "Mock (不可信)"`

### AC-30.21.3: JSON 回退模式端到端验证
- **Given** Neo4j 服务不可达 (连接超时或拒绝)
- **When** 提交学习事件
- **Then** 自动降级到 JSON 存储
- **And** `logger.warning` 包含 "Falling back to JSON" 或 "fallback"
- **And** 数据持久化到 `data/neo4j_memory.json`
- **And** JSON 文件中包含刚写入的事件

### AC-30.21.4: 测试标记隔离
- **Given** 集成测试使用 `@pytest.mark.integration` 标记
- **When** 运行 `pytest -m "not integration"`
- **Then** 集成测试被跳过, 不影响常规测试
- **When** 运行 `pytest -m integration`
- **Then** 只运行集成测试 (需要 Docker Neo4j)

---

## Tasks / Subtasks

### Task 1: 真实 Neo4j 幂等性测试
- [x] 1.1 创建 `test_story_30_21_real_integration.py`
- [x] 1.2 `test_idempotent_neo4j_persistence()` — 重复写入 + Cypher 计数验证
- [x] 1.3 `test_idempotent_batch_persistence()` — 批量重复 + 去重验证
- [x] 1.4 本地 fixture: `neo4j_client()` — 连接真实 Neo4j (port 7689) + 清理测试数据

### Task 2: 真实性能基准
- [x] 2.1 `test_real_batch_50_benchmark()` — 50 事件真实延迟测量 (446ms total, 8.93ms/event)
- [x] 2.2 `test_real_single_write_latency()` — 单次写入 p50=7.7ms, p95=9.82ms
- [x] 2.3 Benchmark 报告生成 (JSON + Markdown) → `_bmad-output/test-artifacts/`
- [ ] 2.4 现有 Mock 基准标注为 `env: Mock (不可信)` — 需单独 PR

### Task 3: JSON 回退验证
- [x] 3.1 `test_json_fallback_data_persistence()` — JSON 文件写入验证
- [x] 3.2 `test_json_fallback_warning_log()` — WARNING 日志验证
- [x] 3.3 `test_json_fallback_event_queryable()` — 回退后数据可查询

### Task 4: 测试标记和 CI 配置
- [x] 4.1 确认 `pytest.ini` 中 `integration` marker 已配置
- [x] 4.2 验证 `pytest -m "not integration"` 跳过所有集成测试 (4 deselected)
- [x] 4.3 测试文件顶部 docstring 包含完整运行说明

---

## Dev Notes

### 运行方式
```bash
# 启动 Neo4j
docker-compose up -d neo4j && sleep 10

# 运行真实集成测试
cd backend && pytest tests/integration/test_story_30_21_real_integration.py -m integration -v

# 查看 benchmark 报告
cat ../_bmad-output/test-artifacts/benchmark-epic30-real.md
```

### 基础设施 AC 检查

| 维度 | 检查 | 状态 |
|------|------|------|
| D1 持久化 | Neo4j MERGE 幂等性 | AC-30.21.1 |
| D2 弹性 | JSON 回退数据完整 | AC-30.21.3 |
| D5 降级 | 回退 + WARNING 日志 | AC-30.21.3 |
| D6 集成 | 端到端写入查询 | AC-30.21.1 |

### Gate 影响预估
- P0 覆盖率: 88% → 95% (AC-30.2.4 性能基准从 NONE 升为 FULL)
- Mock 比例: 85-90% → ~75% (新增真实集成测试)
- 消除对抗性审查发现 #3 (虚假性能基准) 和 #9 (Mock 幂等性)

---

## Files Changed

| File | Change |
|------|--------|
| `backend/tests/integration/test_story_30_21_real_integration.py` | **新增** — 8 个测试 (4 integration + 3 fallback + 1 marker) |
| `_bmad-output/test-artifacts/benchmark-epic30-real.json` | **新增** — 批量写入 benchmark JSON 报告 |
| `_bmad-output/test-artifacts/benchmark-epic30-real.md` | **新增** — 批量写入 benchmark Markdown 报告 |
| `_bmad-output/test-artifacts/benchmark-epic30-latency.json` | **新增** — 单次写入延迟 JSON 报告 |

---

## Benchmark Results (Real Neo4j, 2026-02-10)

| Metric | Value |
|--------|-------|
| Batch 50 events total | 446.34 ms |
| Batch avg per event | 8.93 ms |
| Single write p50 | 7.70 ms |
| Single write p95 | 9.82 ms |
| Single write avg | 7.97 ms |
| Neo4j URI | bolt://localhost:7689 |

---

## Change Log

| Date | Change | Author |
|------|--------|--------|
| 2026-02-10 | Story 创建 (对抗性审查修复 Phase 2) | ROG |
| 2026-02-10 | 实现完成 — 8/8 测试通过, Benchmark 报告已生成 | Dev Agent |
| 2026-02-10 | Code Review: 修复 6 个问题 (2H+4M) — try/finally 清理, p50/p95 修正, 真实降级测试, marker 验证, fixture 日志 | Code Review |
