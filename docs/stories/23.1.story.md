# Story 23.1: LangGraph导入问题修复

## Status: Draft

## Epic Context & Background

**所属Epic**: EPIC-23 - RAG智能推理系统
**Epic文档**: [EPIC-23-RAG-INTELLIGENT-INFERENCE.md](../prd/EPIC-23-RAG-INTELLIGENT-INFERENCE.md)
**优先级**: P0 (Critical)
**估计**: 2 Story Points

**本Story在Epic中的定位**:
- Epic 23的**首个Story**，解决RAG系统完全失效的根因
- 修复后将使 `LANGGRAPH_AVAILABLE = True`
- **依赖**: Epic 22 (记忆系统) 已完成
- **被依赖**: Story 23.2, 23.3, 23.4 全部依赖本Story修复导入问题

**Epic核心问题回顾**:

### Bug 7: Agentic RAG不工作

**现象**:
- `src/agentic_rag` 模块导入失败
- `LANGGRAPH_AVAILABLE = False`
- 所有RAG功能失效

**根因链路**:
```
src/agentic_rag 模块导入失败
    ↓
LANGGRAPH_AVAILABLE = False
    ↓
RAGService.query() 返回空结果或抛出异常
    ↓
所有依赖RAG的功能失效 (检验白板生成、薄弱点识别等)
```

**修复目标**: 确保 `from agentic_rag import canvas_agentic_rag` 成功执行

---

## Story

**As a** Canvas学习系统,
**I want** 修复agentic_rag模块的导入问题,
**so that** LANGGRAPH_AVAILABLE = True，使RAG功能可用

---

## Acceptance Criteria

### AC 1: agentic_rag模块导入成功
- **Given**: Python环境已配置所有依赖
- **When**: 执行 `from agentic_rag import canvas_agentic_rag, CanvasRAGState, CanvasRAGConfig`
- **Then**: 导入成功，无ImportError

### AC 2: RAGService中LANGGRAPH_AVAILABLE为True
- **Given**: AC 1已满足
- **When**: 检查 `backend/app/services/rag_service.py` 的 `LANGGRAPH_AVAILABLE` 变量
- **Then**: `LANGGRAPH_AVAILABLE = True`

### AC 3: 所有依赖版本记录在requirements.txt
- **Given**: 导入成功所需的所有依赖
- **When**: 检查 `backend/requirements.txt`
- **Then**: 包含所有必需依赖及其版本约束:
  - langgraph>=0.2.0
  - langchain-core>=0.3.0
  - lancedb>=0.14.0
  - sentence-transformers>=2.2.0
  - neo4j>=5.0.0
  - 其他必要依赖

### AC 4: 导入诊断日志
- **Given**: 模块导入发生
- **When**: 导入失败时
- **Then**: 日志清晰记录:
  - 具体哪个import语句失败
  - 缺少的模块名称
  - 建议的修复步骤

---

## Tasks / Subtasks

### 任务1: 分析当前导入问题 (AC: 1, 4)
- [ ] 1.1: 运行导入诊断脚本，识别失败的具体import
- [ ] 1.2: 检查 `src/agentic_rag/__init__.py` 的导入链
- [ ] 1.3: 检查 `state_graph.py` 的依赖导入
- [ ] 1.4: 记录所有缺失的依赖

### 任务2: 修复依赖缺失 (AC: 3)
- [ ] 2.1: 更新 `backend/requirements.txt` 添加缺失依赖
- [ ] 2.2: 验证依赖版本兼容性
- [ ] 2.3: 运行 `pip install -r requirements.txt` 验证安装

### 任务3: 修复导入路径问题 (AC: 1)
- [ ] 3.1: 检查 `sys.path` 是否包含 `src/` 目录
- [ ] 3.2: 修复 `__init__.py` 中可能的相对/绝对导入问题
- [ ] 3.3: 检查循环导入并修复

### 任务4: 添加Fallback和诊断 (AC: 4)
- [ ] 4.1: 在 `__init__.py` 添加try-except包装
- [ ] 4.2: 添加详细的错误诊断日志
- [ ] 4.3: 提供降级方案（graceful degradation）

### 任务5: 验证RAGService集成 (AC: 2)
- [ ] 5.1: 创建/更新 `backend/app/services/rag_service.py`
- [ ] 5.2: 验证 `LANGGRAPH_AVAILABLE = True`
- [ ] 5.3: 运行RAGService单元测试

### 任务6: 编写导入测试 (AC: 1, 2, 3)
- [ ] 6.1: 创建 `tests/test_agentic_rag_import.py`
- [ ] 6.2: 测试所有公开API导入成功
- [ ] 6.3: 测试StateGraph编译成功
- [ ] 6.4: 测试RAGService LANGGRAPH_AVAILABLE标志

---

## Dev Notes

### Technical Context

**当前代码结构** (已存在):
```
src/agentic_rag/
├── __init__.py              # 模块入口 - 导入问题所在
├── state.py                 # CanvasRAGState定义
├── config.py                # CanvasRAGConfig定义
├── state_graph.py           # LangGraph StateGraph构建
├── nodes.py                 # 检索/融合/Rerank节点
├── clients/
│   ├── lancedb_client.py    # LanceDB向量库客户端
│   ├── graphiti_client.py   # Graphiti图谱客户端
│   └── temporal_client.py   # 时序记忆客户端
├── fusion/
│   ├── rrf_fusion.py        # RRF融合算法
│   ├── weighted_fusion.py   # 加权融合算法
│   └── cascade_retrieval.py # 级联检索
├── quality/
│   ├── quality_checker.py   # 质量评估
│   └── query_rewriter.py    # Query重写
├── retrievers/
│   └── multimodal_retriever.py  # 多模态检索
└── processors/
    ├── multimodal_vectorizer.py # 多模态向量化
    └── pdf_processor.py     # PDF处理
```

**当前__init__.py内容** (src/agentic_rag/__init__.py:23-25):
```python
from agentic_rag.state import CanvasRAGState
from agentic_rag.config import CanvasRAGConfig
from agentic_rag.state_graph import canvas_agentic_rag
```

**state_graph.py关键导入** (src/agentic_rag/state_graph.py:27-41):
```python
from langgraph.graph import END, START, StateGraph
from langgraph.types import RetryPolicy, Send

from agentic_rag.config import CanvasRAGConfig
from agentic_rag.nodes import (
    check_quality,
    fuse_results,
    rerank_results,
    retrieve_graphiti,
    retrieve_lancedb,
)
from agentic_rag.retrievers import multimodal_retrieval_node
from agentic_rag.state import CanvasRAGState
```

### 可能的根因分析

**根因1: 依赖缺失**
- `langgraph>=0.2.0` - 已在requirements.txt
- `langchain-core` - **可能缺失**
- `lancedb` - **可能缺失**
- `sentence-transformers` - 用于reranking，**可能缺失**
- `neo4j` - Graphiti依赖，**可能缺失**

**根因2: 导入路径问题**
- `from agentic_rag.xxx` 使用绝对导入
- 需要 `src/` 目录在 `sys.path` 中
- 或者使用 `from .xxx` 相对导入

**根因3: 循环导入**
- `state_graph.py` 导入 `nodes.py`
- `nodes.py` 可能导入其他模块
- 需检查是否形成循环

### SDD References

**OpenAPI参考**:
- specs/api/canvas-api.openapi.yml (无直接关联)

**JSON Schema参考**:
- specs/data/langgraph-state.schema.json - CanvasRAGState结构

**ADR参考**:
- docs/architecture/decisions/0002-langgraph-agents.md - LangGraph选型决策
- docs/architecture/decisions/0003-graphiti-memory.md - Graphiti集成决策
- docs/architecture/ADR-003-AGENTIC-RAG-ARCHITECTURE.md - Agentic RAG架构

### Implementation Guidelines

**Step 1: 诊断当前问题**
```bash
cd C:\Users\ROG\托福\Canvas-sm-draft-23.1
python -c "from agentic_rag import canvas_agentic_rag; print('SUCCESS')" 2>&1
```

**Step 2: 修复requirements.txt**
```txt
# 添加到 backend/requirements.txt
# Core LangGraph
langgraph>=0.2.0
langchain-core>=0.3.0

# Vector Database
lancedb>=0.14.0

# Reranking
sentence-transformers>=2.2.0

# Knowledge Graph
neo4j>=5.0.0
graphiti-core>=0.6.0

# Embedding Models
openai>=1.0.0  # 如果使用OpenAI embeddings
```

**Step 3: 修复__init__.py (添加诊断)**
```python
"""
Agentic RAG - Canvas Learning System智能检索增强生成系统
"""

import logging
import sys

logger = logging.getLogger(__name__)

# 诊断: 检查sys.path
_src_path = str(Path(__file__).parent.parent)
if _src_path not in sys.path:
    sys.path.insert(0, _src_path)
    logger.info(f"Added {_src_path} to sys.path")

try:
    from agentic_rag.state import CanvasRAGState
    from agentic_rag.config import CanvasRAGConfig
    from agentic_rag.state_graph import canvas_agentic_rag

    AGENTIC_RAG_AVAILABLE = True
    _IMPORT_ERROR = None
except ImportError as e:
    AGENTIC_RAG_AVAILABLE = False
    _IMPORT_ERROR = str(e)
    logger.error(f"Failed to import agentic_rag: {e}")
    logger.error("Please install dependencies: pip install -r backend/requirements.txt")

    # Placeholder exports
    CanvasRAGState = None
    CanvasRAGConfig = None
    canvas_agentic_rag = None

__version__ = "1.0.0"

__all__ = [
    "CanvasRAGState",
    "CanvasRAGConfig",
    "canvas_agentic_rag",
    "AGENTIC_RAG_AVAILABLE",
]
```

**Step 4: 创建rag_service.py (如果不存在)**
```python
# backend/app/services/rag_service.py
"""
RAG Service - 调用Agentic RAG的服务层
"""

import logging

logger = logging.getLogger(__name__)

try:
    from agentic_rag import canvas_agentic_rag, CanvasRAGConfig
    LANGGRAPH_AVAILABLE = True
except ImportError as e:
    LANGGRAPH_AVAILABLE = False
    _IMPORT_ERROR = str(e)
    logger.warning(f"LangGraph not available: {e}")

class RAGService:
    """RAG检索服务"""

    def __init__(self):
        if not LANGGRAPH_AVAILABLE:
            logger.warning("RAGService initialized without LangGraph support")

    async def query(self, query: str, config: dict = None):
        """执行RAG查询"""
        if not LANGGRAPH_AVAILABLE:
            raise RuntimeError(f"LangGraph not available: {_IMPORT_ERROR}")

        result = await canvas_agentic_rag.ainvoke(
            {"messages": [{"role": "user", "content": query}]},
            config=config or {}
        )
        return result
```

### Testing Requirements

**测试文件**: `src/tests/test_agentic_rag_import.py`

```python
import pytest

def test_agentic_rag_import():
    """测试agentic_rag模块导入成功"""
    from agentic_rag import canvas_agentic_rag, CanvasRAGState, CanvasRAGConfig

    assert canvas_agentic_rag is not None
    assert CanvasRAGState is not None
    assert CanvasRAGConfig is not None

def test_stategraph_compile():
    """测试StateGraph已编译"""
    from agentic_rag import canvas_agentic_rag

    # 检查是已编译的图
    assert hasattr(canvas_agentic_rag, 'invoke')
    assert hasattr(canvas_agentic_rag, 'ainvoke')

def test_langgraph_available_flag():
    """测试LANGGRAPH_AVAILABLE标志"""
    # 假设rag_service存在
    try:
        from backend.app.services.rag_service import LANGGRAPH_AVAILABLE
        assert LANGGRAPH_AVAILABLE == True
    except ImportError:
        pytest.skip("rag_service not yet created")

def test_all_exports():
    """测试所有导出正确"""
    from agentic_rag import __all__

    assert "CanvasRAGState" in __all__
    assert "CanvasRAGConfig" in __all__
    assert "canvas_agentic_rag" in __all__
```

### Dependencies

**Story依赖**:
- ✅ Epic 22 (记忆系统) - 已完成

**技术依赖**:
- Python 3.9+
- langgraph>=0.2.0
- langchain-core>=0.3.0
- lancedb>=0.14.0 (Story 23.2会详细实现)
- neo4j>=5.0.0 (已有从Epic 22)

### Key Files to Modify

| 文件路径 | 修改类型 | 说明 |
|---------|---------|------|
| `src/agentic_rag/__init__.py` | 修改 | 添加诊断日志和fallback |
| `backend/requirements.txt` | 修改 | 添加缺失依赖 |
| `backend/app/services/rag_service.py` | 新建/修改 | RAG服务封装 |
| `src/tests/test_agentic_rag_import.py` | 新建 | 导入测试用例 |

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-12 | 1.0 | 初始创建 - SM Agent自动化batch模式 | Bob (SM Agent) |

---

## Dev Agent Record

### Agent Model Used
*待填写*

### Debug Log References
*待填写*

### Completion Notes List
*待填写*

### File List
*待填写*

---

## QA Results

*待QA Agent审查*

---

## Related Documentation

**Epic文档**:
- [EPIC-23-RAG-INTELLIGENT-INFERENCE.md](../prd/EPIC-23-RAG-INTELLIGENT-INFERENCE.md) - Epic 23完整PRD

**架构文档**:
- [ADR-003-AGENTIC-RAG-ARCHITECTURE.md](../architecture/ADR-003-AGENTIC-RAG-ARCHITECTURE.md) - Agentic RAG架构决策
- [0002-langgraph-agents.md](../architecture/decisions/0002-langgraph-agents.md) - LangGraph ADR
- [0003-graphiti-memory.md](../architecture/decisions/0003-graphiti-memory.md) - Graphiti ADR
- [coding-standards.md](../architecture/coding-standards.md) - 编码规范

**技能参考**:
- LangGraph Skill: `.claude/skills/langgraph/SKILL.md`
- Graphiti Skill: `.claude/skills/graphiti/SKILL.md`

**后续Story**:
- Story 23.2: LanceDB Embedding Pipeline
- Story 23.3: StateGraph智能推理链配置
- Story 23.4: 多源融合 (教材+历史+跨Canvas)
