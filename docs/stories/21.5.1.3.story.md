# Story 21.5.1.3: API参数格式测试与回归验证

> **Epic**: EPIC-21.5.1 - API参数格式修复与安全检查优化
> **状态**: ✅ Validated
> **优先级**: P2
> **前置依赖**: Story 21.5.1.1 (✅), Story 21.5.1.2 (✅)

---

## Story Goal

创建端到端集成测试，验证API参数格式修复后的全流程工作正常，并运行回归测试确保无新问题引入。

---

## Acceptance Criteria

- [x] **AC-1**: 添加前端单元测试 `extractCanvasFileName()` ✅ (已由 21.5.1.1 完成)
- [x] **AC-2**: 添加后端单元测试 `_validate_canvas_name()` ✅ (已由 21.5.1.2 完成)
- [x] **AC-3**: 添加端到端测试 (插件调用 → 后端响应) ✅ 15个测试用例
- [x] **AC-4**: 运行现有测试套件，确保无回归 ✅ 47个集成测试 + 16个单元测试全部通过

---

## Technical Design

### AC-3: 端到端集成测试

创建 `backend/tests/integration/test_agent_canvas_param.py`:

1. **测试合法Canvas名称请求**:
   - 简单文件名: `"test.canvas"`
   - 子目录路径: `"笔记库/子目录/test.canvas"`
   - 中文路径: `"学习/数学/离散数学.canvas"`

2. **测试路径遍历拒绝**:
   - `"../../../etc/passwd"` → 400 或 500 错误
   - `"test/../secret"` → 400 或 500 错误

3. **测试全流程**:
   - API 请求 → CanvasService 验证 → 返回适当响应

### AC-4: 回归测试

运行完整测试套件:
```bash
python -m pytest backend/tests/ -v
python -m pytest canvas-progress-tracker/obsidian-plugin/tests/ -v (如果Jest支持)
```

---

## Test Files

- `backend/tests/integration/test_agent_canvas_param.py` (新建)

---

## SDD规范引用

| 规范 | 路径 | 相关章节 |
|------|------|----------|
| OpenAPI Spec | `specs/api/fastapi-backend-api.openapi.yml` | `/paths/~1api~1v1~1agents` |
| Request Schema | `specs/data/decompose-request.schema.json` | `canvas_name` property |
| Response Schema | `specs/data/error-response.schema.json` | 500 error format |

---

## ADR关联

| ADR | 标题 | 关联内容 |
|-----|------|----------|
| ADR-008 | Testing Framework (pytest) | 测试框架选型依据 |
| ADR-011 | Security Validation Patterns | Path traversal 检测策略 |

---

## Dev Log

| 时间 | 操作 | 结果 |
|------|------|------|
| 2025-12-14 | Story 创建 | ✅ |
| 2025-12-14 | 创建集成测试 `test_agent_canvas_param.py` | ✅ 15个测试用例 |
| 2025-12-14 | 运行集成测试 | ✅ 15/15 通过 |
| 2025-12-14 | 运行回归测试 | ✅ 47个集成测试 + 16个单元测试通过 |
| 2025-12-14 | QA Gate 审核 | ✅ PASS |

---

## QA Records

| 阶段 | 状态 | 备注 |
|------|------|------|
| Trace | ✅ | AC-1~4 全部实现 |
| NFR Assessment | ✅ | 测试覆盖全面，无性能问题 |
| Gate Review | ✅ PASS | 分数: 98/100 |

---

## 测试结果摘要

### AC-3: 端到端集成测试 (15个测试用例)

**有效路径测试 (3)**:
- `test_decompose_basic_accepts_simple_filename` ✅
- `test_decompose_basic_accepts_subdirectory_path` ✅
- `test_explain_oral_accepts_chinese_path` ✅

**路径遍历拒绝测试 (6)**:
- `test_decompose_basic_rejects_path_traversal` ✅
- `test_decompose_deep_rejects_embedded_traversal` ✅
- `test_score_rejects_null_byte_injection` ✅
- `test_explain_clarification_rejects_backslash` ✅
- `test_explain_comparison_rejects_double_slash` ✅
- `test_explain_memory_rejects_absolute_path` ✅

**全流程测试 (2)**:
- `test_all_agent_endpoints_handle_canvas_name_consistently` ✅
- `test_all_agent_endpoints_reject_traversal_consistently` ✅

**边界情况测试 (4)**:
- `test_empty_canvas_name_handled` ✅
- `test_unicode_characters_in_canvas_name` ✅
- `test_very_long_canvas_name_handled` ✅
- `test_special_characters_in_canvas_name` ✅

### AC-4: 回归测试结果

| 测试类型 | 数量 | 通过 | 失败 |
|----------|------|------|------|
| 集成测试 | 47 | 47 | 0 |
| 单元测试 (canvas_validation) | 16 | 16 | 0 |
| **总计** | **63** | **63** | **0** |
