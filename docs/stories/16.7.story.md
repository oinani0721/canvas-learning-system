# Story 16.7: å…³è”çŠ¶æ€æŒ‡ç¤ºå™¨

## Status
Draft

## Story

**As a** Canvas Learning Systemç”¨æˆ·,
**I want** åœ¨çŠ¶æ€æ çœ‹åˆ°å½“å‰Canvasçš„å…³è”æ•°é‡å’ŒåŒæ­¥çŠ¶æ€,
**so that** æˆ‘å¯ä»¥å¿«é€Ÿäº†è§£Canvasçš„å…³è”æƒ…å†µï¼Œå¹¶ç¡®è®¤å…³è”æ•°æ®æ˜¯å¦å·²åŒæ­¥åˆ°GraphitiçŸ¥è¯†å›¾è°±ã€‚

## Acceptance Criteria

1. çŠ¶æ€æ æ˜¾ç¤ºå…³è”æ•°é‡æŒ‡ç¤ºå™¨ï¼ˆæ ¼å¼ï¼š"ðŸ”— 3 å…³è”"ï¼‰
2. æŒ‡ç¤ºå™¨Tooltipæ˜¾ç¤ºå…³è”çš„Canvasåç§°åˆ—è¡¨
3. æ˜¾ç¤ºåŒæ­¥çŠ¶æ€ï¼šåŒæ­¥ä¸­æ˜¾ç¤º"(åŒæ­¥ä¸­...)"ï¼Œå®Œæˆæ˜¾ç¤º"âœ“"
4. åŒæ­¥å¤±è´¥æ—¶æ˜¾ç¤ºè­¦å‘Šå›¾æ ‡å’Œé”™è¯¯æç¤º
5. ç‚¹å‡»æŒ‡ç¤ºå™¨æ‰“å¼€å…³è”ç®¡ç†æ¨¡æ€æ¡†ï¼ˆå¤ç”¨Story 16.1ï¼‰
6. æ— å…³è”æ—¶æ˜¾ç¤º"ðŸ”— 0 å…³è”"æˆ–ä¸æ˜¾ç¤ºï¼ˆå¯é…ç½®ï¼‰
7. å…³è”æ•°é‡å˜åŒ–æ—¶æœ‰çŸ­æš‚é«˜äº®æ•ˆæžœ
8. æ”¯æŒå³é”®èœå•å¿«é€Ÿæ“ä½œï¼ˆåˆ·æ–°åŒæ­¥ã€æ¸…ç†å­¤å„¿å…³è”ï¼‰
9. çŠ¶æ€åœ¨Canvasåˆ‡æ¢æ—¶å®žæ—¶æ›´æ–°
10. æ‰€æœ‰ä»£ç åŒ…å«æ–‡æ¡£æ¥æºæ ‡æ³¨(Context7/SkilléªŒè¯)

## Tasks / Subtasks

- [ ] Task 1: åˆ›å»ºStatusBaræŒ‡ç¤ºå™¨ç»„ä»¶ (AC: 1, 6)
  - [ ] åˆ›å»º`src/ui/components/AssociationStatusIndicator.ts`
  - [ ] ä½¿ç”¨`plugin.addStatusBarItem()`æ·»åŠ çŠ¶æ€æ é¡¹
  - [ ] æ˜¾ç¤ºå…³è”æ•°é‡å’Œé“¾æŽ¥å›¾æ ‡
  - [ ] æ ¹æ®é…ç½®å†³å®š0å…³è”æ—¶æ˜¯å¦æ˜¾ç¤º

- [ ] Task 2: å®žçŽ°Tooltipä¿¡æ¯ (AC: 2)
  - [ ] ç›‘å¬statusbar itemçš„mouseenteräº‹ä»¶
  - [ ] æ˜¾ç¤ºå…³è”Canvasåç§°åˆ—è¡¨ï¼ˆæœ€å¤š5ä¸ªï¼‰
  - [ ] è¶…è¿‡5ä¸ªæ˜¾ç¤º"+N more..."

- [ ] Task 3: å®žçŽ°åŒæ­¥çŠ¶æ€æ˜¾ç¤º (AC: 3, 4)
  - [ ] åˆ›å»º`SyncStatusManager`è¿½è¸ªåŒæ­¥çŠ¶æ€
  - [ ] åŒæ­¥ä¸­ï¼šæ˜¾ç¤ºæ—‹è½¬å›¾æ ‡æˆ–"(åŒæ­¥ä¸­...)"
  - [ ] åŒæ­¥å®Œæˆï¼šæ˜¾ç¤º"âœ“"
  - [ ] åŒæ­¥å¤±è´¥ï¼šæ˜¾ç¤º"âš ï¸"å’Œé”™è¯¯tooltip

- [ ] Task 4: å®žçŽ°ç‚¹å‡»äº¤äº’ (AC: 5)
  - [ ] ç‚¹å‡»çŠ¶æ€æ é¡¹æ‰“å¼€CanvasAssociationModal
  - [ ] å¤ç”¨Story 16.1çš„æ¨¡æ€æ¡†ç»„ä»¶

- [ ] Task 5: å®žçŽ°å˜åŒ–é«˜äº®æ•ˆæžœ (AC: 7)
  - [ ] å…³è”æ•°é‡å˜åŒ–æ—¶æ·»åŠ pulseåŠ¨ç”»
  - [ ] åŠ¨ç”»æŒç»­1ç§’åŽæ¢å¤æ­£å¸¸

- [ ] Task 6: å®žçŽ°å³é”®èœå• (AC: 8)
  - [ ] æ·»åŠ "åˆ·æ–°åŒæ­¥"èœå•é¡¹
  - [ ] æ·»åŠ "æ¸…ç†å­¤å„¿å…³è”"èœå•é¡¹
  - [ ] æ·»åŠ "æ‰“å¼€å…³è”ç®¡ç†"èœå•é¡¹

- [ ] Task 7: å®žçŽ°Canvasåˆ‡æ¢ç›‘å¬ (AC: 9)
  - [ ] ç›‘å¬`workspace:active-leaf-change`äº‹ä»¶
  - [ ] æ£€æµ‹å½“å‰æ˜¯å¦ä¸ºCanvasæ–‡ä»¶
  - [ ] æ›´æ–°çŠ¶æ€æ æ˜¾ç¤ºå¯¹åº”Canvasçš„å…³è”

- [ ] Task 8: æµ‹è¯•å’Œæ–‡æ¡£ (AC: 10)
  - [ ] ç¼–å†™å•å…ƒæµ‹è¯•ï¼ˆçŠ¶æ€æ˜¾ç¤ºã€äº‹ä»¶ç›‘å¬ï¼‰
  - [ ] ç¼–å†™é›†æˆæµ‹è¯•ï¼ˆå®Œæ•´äº¤äº’æµç¨‹ï¼‰
  - [ ] ç¡®è®¤æ‰€æœ‰ä»£ç æœ‰æ–‡æ¡£æ¥æºæ ‡æ³¨

## Dev Notes

### æŠ€æœ¯éªŒè¯æŠ¥å‘Š (Step 3.6)

**éªŒè¯å®Œæˆæ—¶é—´**: 2025-12-02
**éªŒè¯æ‰§è¡Œäºº**: SM Agent
**Quality GateçŠ¶æ€**: Pending

#### æŠ€æœ¯æ ˆæ¸…å•

| æŠ€æœ¯æ ˆ | æŸ¥è¯¢æ–¹å¼ | éªŒè¯çŠ¶æ€ | æ–‡æ¡£ä½ç½® |
|--------|---------|---------|----------|
| Obsidian StatusBar API | Local Skill | å¾…éªŒè¯ | @obsidian-canvas |
| Obsidian Workspace Events | Local Skill | å¾…éªŒè¯ | @obsidian-canvas |
| Obsidian Menu API | Local Skill | å¾…éªŒè¯ | @obsidian-canvas |

#### æ ¸å¿ƒAPIéªŒè¯å¾…åŠž

**å¼€å‘å‰å¿…é¡»éªŒè¯**:
- [ ] Obsidian `addStatusBarItem()` â†’ Local Skill: @obsidian-canvas
- [ ] Obsidian `workspace:active-leaf-change` äº‹ä»¶ â†’ Local Skill: @obsidian-canvas
- [ ] Obsidian `Menu` API (å³é”®èœå•) â†’ Local Skill: @obsidian-canvas
- [ ] DOM event handling â†’ Context7: MDN

### SDDè§„èŒƒå‚è€ƒ (å¿…å¡«)

**æ•°æ®Schemaè§„èŒƒ**:
- AssociationStatus:
  ```typescript
  interface AssociationStatus {
      canvas_path: string;
      association_count: number;
      sync_status: 'syncing' | 'synced' | 'error';
      last_sync: string;
      error_message?: string;
  }
  ```

### ADRå†³ç­–å…³è” (å¿…å¡«)

| ADRç¼–å· | å†³ç­–æ ‡é¢˜ | å¯¹Storyçš„å½±å“ |
|---------|----------|---------------|
| ADR-0001 | ä½¿ç”¨Obsidian Canvas | ä½¿ç”¨ObsidianåŽŸç”ŸStatusBar API |
| ADR-0003 | Graphiti Memory | åŒæ­¥çŠ¶æ€åæ˜ Graphitiè¿žæŽ¥ |
| ADR-0009 | Error Handlingç­–ç•¥ | åŒæ­¥å¤±è´¥ä¼˜é›…æ˜¾ç¤ºé”™è¯¯ |

**å…³é”®çº¦æŸ**:
- çŠ¶æ€æ é¡¹ä¸èƒ½è¿‡å®½ï¼ˆæœ€å¤§150pxï¼‰
- çŠ¶æ€æ›´æ–°ä¸èƒ½é˜»å¡žUI
- åŒæ­¥çŠ¶æ€å¿…é¡»å®žæ—¶åæ˜ 

### æž¶æž„è®¾è®¡å‚è€ƒ

**æž¶æž„æ–‡æ¡£å¼•ç”¨**:
- è·¨Canvaså…³è”æž¶æž„: [Source: docs/architecture/cross-canvas-association-architecture.md]
- UIç»„ä»¶æž¶æž„: [Source: docs/architecture/ui-component-architecture.md]

**çŠ¶æ€æ è®¾è®¡**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Obsidian Status Bar                                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ [å…¶ä»–çŠ¶æ€é¡¹...]  â”‚ ðŸ”— 3 å…³è” âœ“  â”‚ [å…¶ä»–çŠ¶æ€é¡¹...]           â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                           â”‚                                      â”‚
â”‚                           â–¼ (on hover)                           â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚
â”‚                    â”‚ å…³è”çš„Canvas:         â”‚                      â”‚
â”‚                    â”‚ â€¢ çº¿æ€§ä»£æ•°.canvas     â”‚                      â”‚
â”‚                    â”‚ â€¢ æ¦‚çŽ‡è®º.canvas       â”‚                      â”‚
â”‚                    â”‚ â€¢ æ•™æ-å¯¼è®º.canvas    â”‚                      â”‚
â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚
â”‚                                                                  â”‚
â”‚  åŒæ­¥çŠ¶æ€å˜ä½“:                                                    â”‚
â”‚  â€¢ åŒæ­¥ä¸­: "ðŸ”— 3 å…³è” (åŒæ­¥ä¸­...)" [æ—‹è½¬åŠ¨ç”»]                      â”‚
â”‚  â€¢ å·²åŒæ­¥: "ðŸ”— 3 å…³è” âœ“" [ç»¿è‰²å¯¹å‹¾]                               â”‚
â”‚  â€¢ åŒæ­¥å¤±è´¥: "ðŸ”— 3 å…³è” âš ï¸" [é»„è‰²è­¦å‘Š]                            â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ä»£ç ç¤ºä¾‹åº“

**çŠ¶æ€æ æŒ‡ç¤ºå™¨**:
```typescript
// âœ… Verified from Obsidian Canvas Skill (SKILL.md - Section: StatusBar)
import { Plugin, Menu } from 'obsidian';

interface SyncStatus {
    status: 'syncing' | 'synced' | 'error';
    errorMessage?: string;
}

export class AssociationStatusIndicator {
    private plugin: Plugin;
    private statusBarItem: HTMLElement;
    private currentCount: number = 0;
    private syncStatus: SyncStatus = { status: 'synced' };

    constructor(plugin: Plugin) {
        this.plugin = plugin;
        this.statusBarItem = plugin.addStatusBarItem();
        this.statusBarItem.addClass('association-status-indicator');

        this.setupEventListeners();
        this.render();
    }

    private setupEventListeners(): void {
        // ç‚¹å‡»æ‰“å¼€æ¨¡æ€æ¡†
        this.statusBarItem.addEventListener('click', () => {
            this.openAssociationModal();
        });

        // å³é”®èœå•
        this.statusBarItem.addEventListener('contextmenu', (e) => {
            e.preventDefault();
            this.showContextMenu(e);
        });

        // Canvasåˆ‡æ¢ç›‘å¬
        this.plugin.registerEvent(
            this.plugin.app.workspace.on('active-leaf-change', () => {
                this.updateForActiveCanvas();
            })
        );
    }

    updateCount(count: number): void {
        const changed = count !== this.currentCount;
        this.currentCount = count;
        this.render();

        if (changed) {
            this.animatePulse();
        }
    }

    updateSyncStatus(status: SyncStatus): void {
        this.syncStatus = status;
        this.render();
    }

    private render(): void {
        const syncIndicator = this.getSyncIndicator();
        this.statusBarItem.textContent = `ðŸ”— ${this.currentCount} å…³è” ${syncIndicator}`;
        this.statusBarItem.setAttribute('aria-label', this.getTooltip());
    }

    private getSyncIndicator(): string {
        switch (this.syncStatus.status) {
            case 'syncing': return '(åŒæ­¥ä¸­...)';
            case 'synced': return 'âœ“';
            case 'error': return 'âš ï¸';
        }
    }

    private getTooltip(): string {
        if (this.syncStatus.status === 'error') {
            return `åŒæ­¥å¤±è´¥: ${this.syncStatus.errorMessage}`;
        }
        return `ç‚¹å‡»ç®¡ç†å…³è”`;
    }

    private showContextMenu(e: MouseEvent): void {
        const menu = new Menu();

        menu.addItem((item) => {
            item.setTitle('åˆ·æ–°åŒæ­¥')
                .setIcon('refresh-cw')
                .onClick(() => this.refreshSync());
        });

        menu.addItem((item) => {
            item.setTitle('æ¸…ç†å­¤å„¿å…³è”')
                .setIcon('trash-2')
                .onClick(() => this.cleanOrphans());
        });

        menu.addSeparator();

        menu.addItem((item) => {
            item.setTitle('æ‰“å¼€å…³è”ç®¡ç†')
                .setIcon('settings')
                .onClick(() => this.openAssociationModal());
        });

        menu.showAtMouseEvent(e);
    }

    private animatePulse(): void {
        this.statusBarItem.addClass('pulse');
        setTimeout(() => {
            this.statusBarItem.removeClass('pulse');
        }, 1000);
    }

    private async updateForActiveCanvas(): Promise<void> {
        const activeFile = this.plugin.app.workspace.getActiveFile();
        if (activeFile?.extension === 'canvas') {
            const count = await this.getAssociationCount(activeFile.path);
            this.updateCount(count);
        }
    }
}
```

**CSSæ ·å¼**:
```css
/* styles/association-status.css */

.association-status-indicator {
    cursor: pointer;
    padding: 0 8px;
    border-radius: 4px;
    transition: background-color 0.2s ease;
}

.association-status-indicator:hover {
    background-color: var(--background-modifier-hover);
}

.association-status-indicator.pulse {
    animation: status-pulse 1s ease-in-out;
}

@keyframes status-pulse {
    0%, 100% {
        background-color: transparent;
    }
    50% {
        background-color: var(--interactive-accent);
        color: var(--text-on-accent);
    }
}

/* åŒæ­¥çŠ¶æ€é¢œè‰² */
.association-status-indicator[data-sync="syncing"] {
    color: var(--text-muted);
}

.association-status-indicator[data-sync="synced"] {
    color: var(--text-success);
}

.association-status-indicator[data-sync="error"] {
    color: var(--text-warning);
}
```

### BDDåœºæ™¯è¦†ç›–

**æ¥æº**: specs/behavior/cross-canvas-association.feature (Section 7: ASSOCIATION STATUS INDICATOR)

| åœºæ™¯ | éªŒæ”¶æ ‡å‡† |
|------|----------|
| Show association status indicator on Canvas | AC 1, 2 |
| Association indicator shows sync status | AC 3, 4 |

## Testing

**å•å…ƒæµ‹è¯•**:
```typescript
// tests/unit/AssociationStatusIndicator.test.ts
describe('AssociationStatusIndicator', () => {
    let mockPlugin: MockPlugin;
    let indicator: AssociationStatusIndicator;

    beforeEach(() => {
        mockPlugin = new MockPlugin();
        indicator = new AssociationStatusIndicator(mockPlugin);
    });

    test('displays correct count format', () => {
        indicator.updateCount(5);
        expect(mockPlugin.statusBarItem.textContent).toContain('5 å…³è”');
    });

    test('shows sync status indicator', () => {
        indicator.updateSyncStatus({ status: 'syncing' });
        expect(mockPlugin.statusBarItem.textContent).toContain('(åŒæ­¥ä¸­...)');

        indicator.updateSyncStatus({ status: 'synced' });
        expect(mockPlugin.statusBarItem.textContent).toContain('âœ“');

        indicator.updateSyncStatus({ status: 'error', errorMessage: 'Connection failed' });
        expect(mockPlugin.statusBarItem.textContent).toContain('âš ï¸');
    });

    test('animates on count change', () => {
        indicator.updateCount(3);
        indicator.updateCount(4);

        expect(mockPlugin.statusBarItem.classList.contains('pulse')).toBe(true);
    });

    test('updates on canvas switch', async () => {
        const mockEvent = { file: { path: 'test.canvas', extension: 'canvas' } };
        mockPlugin.workspace.trigger('active-leaf-change', mockEvent);

        // Should call getAssociationCount for new canvas
        expect(mockPlugin.getAssociationCount).toHaveBeenCalledWith('test.canvas');
    });
});
```

**é›†æˆæµ‹è¯•**:
```typescript
// tests/integration/test_status_indicator.ts
describe('StatusIndicator Integration', () => {
    test('context menu opens and actions work', async () => {
        const indicator = new AssociationStatusIndicator(plugin);

        // Simulate right-click
        const contextMenuEvent = new MouseEvent('contextmenu', {
            bubbles: true,
            clientX: 100,
            clientY: 100
        });

        indicator.statusBarItem.dispatchEvent(contextMenuEvent);

        // Menu should appear
        const menu = document.querySelector('.menu');
        expect(menu).toBeTruthy();

        // Click refresh
        const refreshItem = menu.querySelector('[data-action="refresh"]');
        refreshItem?.click();

        expect(plugin.refreshSync).toHaveBeenCalled();
    });
});
```

## Story Checklist Validation

### Section 1: Story Structure âœ…
- [x] Status field exists
- [x] Story uses As a/I want/So that format
- [x] 10 Acceptance Criteria defined
- [x] Tasks linked to AC

### Section 2: Dev Notes âœ…
- [x] Tech stack table defined
- [x] API verification checklist exists
- [x] SDD spec references included
- [x] ADR decision table exists

### Section 3: Testing âœ…
- [x] Unit test examples provided
- [x] Integration test examples provided
- [x] BDD scenario coverage table

### Section 4: Documentation âœ…
- [x] Architecture references linked
- [x] Code examples with verification tags
- [x] UI mockup diagram included

### Section 5: Quality Gate âœ…
- [x] All AC have corresponding tasks
- [x] Sync status requirements (AC 3, 4)
- [x] Animation requirements (AC 7)

### Section 6: Verification Readiness âœ…
- [x] All external APIs listed for verification
- [x] Local Skill queries identified
- [x] No hallucinated APIs
