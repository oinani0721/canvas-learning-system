# Story 22.3: Graphiti MCP集成

## Status
⏳ Ready for Development

## Story

**As a** Claude Code用户,
**I want** 通过MCP协议与Graphiti记忆系统交互,
**so that** 在对话中可以使用学习历史和知识图谱。

## Acceptance Criteria

1. AC-22.3.1: Graphiti MCP服务器能够启动
2. AC-22.3.2: Claude Code能够连接到MCP服务器
3. AC-22.3.3: add_memory工具正常工作
4. AC-22.3.4: search_memories工具正常工作
5. AC-22.3.5: 配置文件模板完整且文档化
6. AC-22.3.6: 提供MCP集成测试脚本

## Tasks / Subtasks

- [ ] Task 1: 创建MCP配置文件 (AC: 1, 5)
  - [ ] 创建graphiti-config.json配置模板
  - [ ] 配置NEO4J环境变量引用
  - [ ] 添加启动命令配置

- [ ] Task 2: 验证MCP服务器启动 (AC: 1)
  - [ ] 编写启动脚本
  - [ ] 验证端口监听
  - [ ] 添加健康检查

- [ ] Task 3: 配置Claude Code连接 (AC: 2)
  - [ ] 更新claude_desktop_config.json (如需要)
  - [ ] 更新.claude/settings.json MCP配置
  - [ ] 验证连接成功

- [ ] Task 4: 测试add_memory工具 (AC: 3)
  - [ ] 测试添加单条记忆
  - [ ] 测试添加带metadata的记忆
  - [ ] 验证数据持久化

- [ ] Task 5: 测试search_memories工具 (AC: 4)
  - [ ] 测试关键词搜索
  - [ ] 测试语义搜索
  - [ ] 验证搜索结果格式

- [ ] Task 6: 编写使用文档 (AC: 5, 6)
  - [ ] 创建graphiti-mcp-setup.md指南
  - [ ] 添加常见问题解答
  - [ ] 提供测试脚本

## Dev Notes

### 架构上下文

**问题根因** [Source: docs/prd/EPIC-22-MEMORY-SYSTEM-NEO4J-GRAPHITI.md#问题分析]

Graphiti MCP服务器未配置或未启动，导致Claude Code无法访问记忆系统:

```
配置文件: claude_desktop_config.json 或 .claude/settings.json
问题: Graphiti MCP服务器条目缺失或未启动

后果:
- Claude无法保存对话记忆
- 跨会话知识图谱不存在
- 学习历史无法被Agent访问
```

### 实现参考

**MCP配置文件** [Source: docs/prd/EPIC-22-MEMORY-SYSTEM-NEO4J-GRAPHITI.md#Story-22.3]

```json
// .claude/mcp/graphiti-config.json
{
  "mcpServers": {
    "graphiti-memory": {
      "command": "python",
      "args": ["-m", "graphiti_mcp"],
      "env": {
        "NEO4J_URI": "${NEO4J_URI}",
        "NEO4J_USERNAME": "${NEO4J_USERNAME}",
        "NEO4J_PASSWORD": "${NEO4J_PASSWORD}"
      }
    }
  }
}
```

**Claude Code设置** (如果使用.claude/settings.json):

```json
// .claude/settings.json 增加MCP配置
{
  "mcpServers": {
    "graphiti-memory": {
      "command": "python",
      "args": ["-m", "graphiti_mcp"],
      "env": {
        "NEO4J_URI": "bolt://localhost:7687",
        "NEO4J_USERNAME": "neo4j",
        "NEO4J_PASSWORD": "your_password"
      }
    }
  }
}
```

**MCP工具使用示例**:

```markdown
## 添加记忆
使用 add_memory 工具:
- key: "concept_inverse_proposition"
- content: "学习了逆否命题的定义和应用"
- metadata: {"canvas_path": "离散数学.canvas", "score": 85}

## 搜索记忆
使用 search_memories 工具:
- query: "逆否命题"
返回相关的学习历史和概念关系
```

**启动脚本**:

```powershell
# scripts/start-graphiti-mcp.ps1

# 设置环境变量
$env:NEO4J_URI = "bolt://localhost:7687"
$env:NEO4J_USERNAME = "neo4j"
$env:NEO4J_PASSWORD = "your_password"

# 启动MCP服务器
python -m graphiti_mcp
```

### 关键文件

- `.claude/mcp/graphiti-config.json` - MCP配置文件 (新增)
- `.claude/settings.json` - Claude Code设置 (修改)
- `docs/guides/graphiti-mcp-setup.md` - 使用文档 (新增)
- `scripts/start-graphiti-mcp.ps1` - 启动脚本 (新增)
- `scripts/test-graphiti-mcp.py` - 测试脚本 (新增)

### 依赖安装

```bash
pip install graphiti-mcp>=0.1.0
```

### 测试要求

**集成测试覆盖**:
- 测试MCP服务器启动
- 测试add_memory工具
- 测试search_memories工具
- 测试list_memories工具
- 测试连接失败降级

### 验证步骤

1. 启动Neo4j数据库
2. 运行 `scripts/start-graphiti-mcp.ps1`
3. 在Claude Code中使用 `add_memory` 工具
4. 验证数据写入Neo4j
5. 使用 `search_memories` 工具查询

## SDD规范引用

- **MCP规范**: Model Context Protocol文档
- **架构文档**: `docs/prd/EPIC-22-MEMORY-SYSTEM-NEO4J-GRAPHITI.md#期望的记忆系统架构`

## ADR关联

- ADR-0007: 选择MCP作为Claude集成协议 (如存在)

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-12 | 1.0 | 初始Story创建 | SM Agent (Bob) |
