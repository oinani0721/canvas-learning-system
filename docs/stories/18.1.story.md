# Story 18.1: Operation Tracker - Canvas操作历史系统

## Status
Completed

## Story

**As a** Canvas Learning System用户,
**I want** 所有Canvas操作自动追踪,
**so that** 我可以查看操作历史并支持回滚。

## Acceptance Criteria

1. `OperationTracker`追踪7种操作: node_add, node_delete, node_modify, node_color_change, edge_add, edge_delete, batch_operation
2. `Operation`记录包含: id, type, canvasPath, timestamp, userId, data(before/after), metadata
3. 历史记录限制可配置(默认100条/Canvas)
4. 操作持久化到 `.canvas-learning/history/{canvas_name}/`
5. `TrackedCanvasOperator`包装现有CanvasService
6. GET `/api/v1/rollback/history/{canvas_path}` 返回操作历史
7. 所有代码有Context7/Skill文档来源标注

## Tasks / Subtasks

- [ ] Task 1: 创建数据模型 (AC: 2)
  - [ ] 创建 `src/rollback/__init__.py`
  - [ ] 创建 `src/rollback/models.py` 定义Operation和OperationType
  - [ ] 定义OperationType枚举 (7种操作类型)
  - [ ] 定义Operation dataclass (id, type, canvasPath, timestamp, userId, data, metadata)
  - [ ] 定义OperationData dataclass (before, after, nodeIds, edgeIds)
  - [ ] 定义OperationMetadata dataclass (agentId, requestId, description)

- [ ] Task 2: 实现OperationTracker核心类 (AC: 1, 3)
  - [ ] 创建 `src/rollback/operation_tracker.py`
  - [ ] 实现 `OperationTracker.__init__(max_history_per_canvas: int = 100)`
  - [ ] 实现 `track_operation(operation: Operation)` 方法
  - [ ] 实现 `get_history(canvas_path: str, limit: int = 50)` 方法
  - [ ] 实现 `get_operation(operation_id: str)` 方法
  - [ ] 实现历史记录限制逻辑 (超过max_history时删除最旧记录)

- [ ] Task 3: 实现磁盘持久化 (AC: 4)
  - [ ] 实现 `_get_history_path(canvas_path: str) -> Path` 方法
  - [ ] 实现 `_save_operation(operation: Operation)` 方法 (JSON序列化)
  - [ ] 实现 `_load_history(canvas_path: str) -> List[Operation]` 方法
  - [ ] 使用orjson进行JSON序列化 (性能优化)
  - [ ] 确保原子写入 (临时文件 + 重命名)

- [ ] Task 4: 创建TrackedCanvasOperator包装类 (AC: 5)
  - [ ] 创建 `src/rollback/tracked_operator.py`
  - [ ] 实现 `TrackedCanvasOperator` 类包装现有CanvasService
  - [ ] 实现 `add_node()` 方法 (自动追踪node_add)
  - [ ] 实现 `delete_node()` 方法 (自动追踪node_delete)
  - [ ] 实现 `modify_node()` 方法 (自动追踪node_modify)
  - [ ] 实现 `change_node_color()` 方法 (自动追踪node_color_change)
  - [ ] 实现 `add_edge()` 方法 (自动追踪edge_add)
  - [ ] 实现 `delete_edge()` 方法 (自动追踪edge_delete)
  - [ ] 实现 `batch_operation()` 方法 (自动追踪batch_operation)

- [ ] Task 5: 创建REST API端点 (AC: 6)
  - [ ] 创建 `backend/app/api/v1/endpoints/rollback.py`
  - [ ] 实现 `GET /api/v1/rollback/history/{canvas_path}` 端点
  - [ ] 创建 `backend/app/services/rollback_service.py` 业务逻辑层
  - [ ] 创建 `backend/app/models/rollback.py` Pydantic schemas
  - [ ] 在 `backend/app/api/v1/router.py` 注册rollback_router

- [ ] Task 6: 单元测试 (AC: 7)
  - [ ] 创建 `src/tests/unit/test_operation_tracker.py`
  - [ ] 测试7种操作类型追踪
  - [ ] 测试历史记录限制
  - [ ] 测试磁盘持久化
  - [ ] 测试TrackedCanvasOperator包装
  - [ ] 确保测试覆盖率 >90%

## Dev Notes

### 技术验证报告 (Step 3.6)

**验证完成时间**: 2025-12-04
**验证执行人**: SM Agent (Bob)
**Quality Gate状态**: Pending

#### 技术栈清单

| 技术栈 | 查询方式 | 验证状态 | 文档位置 |
|--------|---------|---------|----------|
| orjson | Context7 | 待验证 | /ijl/orjson |
| dataclasses | Python stdlib | 已验证 | 标准库 |
| pathlib | Python stdlib | 已验证 | 标准库 |
| uuid | Python stdlib | 已验证 | 标准库 |
| FastAPI Depends | Context7 | 待验证 | /fastapi/fastapi |
| Pydantic BaseModel | Context7 | 待验证 | /pydantic/pydantic |

#### 核心API验证待办

**开发前必须验证**:
- [ ] orjson.dumps() / orjson.loads() → Context7: /ijl/orjson
- [ ] dataclasses.dataclass / field → Python stdlib
- [ ] pathlib.Path.mkdir(parents=True, exist_ok=True) → Python stdlib
- [ ] FastAPI APIRouter → Context7: /fastapi/fastapi
- [ ] Pydantic BaseModel → Context7: /pydantic/pydantic

### SDD规范引用 (必填)

**API端点规范** (Epic 18 Rollback):
- `GET /api/v1/rollback/history/{canvas_path}` - 获取操作历史
  - [Source: docs/architecture/rollback-recovery-architecture.md:296-310]
  - operationId: `getOperationHistory`
  - 响应格式: `application/json`
  - 响应Schema: `OperationHistoryResponse`
  - Query参数: `limit` (int, default=50), `offset` (int, default=0)

**Operation数据模型** (Source: docs/architecture/rollback-recovery-architecture.md:38-66):
```typescript
interface Operation {
    id: string;                    // UUID
    type: OperationType;           // 操作类型枚举
    canvasPath: string;            // Canvas文件路径
    timestamp: Date;               // 操作时间戳
    userId: string;                // 用户ID
    data: {
        before: any;               // 操作前状态
        after: any;                // 操作后状态
        nodeIds?: string[];        // 影响的节点ID
        edgeIds?: string[];        // 影响的边ID
    };
    metadata: {
        agentId?: string;          // 执行Agent ID
        requestId?: string;        // 请求追踪ID
        description: string;       // 操作描述
    };
}

enum OperationType {
    NODE_ADD = 'node_add',
    NODE_DELETE = 'node_delete',
    NODE_MODIFY = 'node_modify',
    NODE_COLOR_CHANGE = 'node_color_change',
    EDGE_ADD = 'edge_add',
    EDGE_DELETE = 'edge_delete',
    BATCH_OPERATION = 'batch_operation'
}
```

### ADR决策关联 (必填)

| ADR编号 | 决策标题 | 对Story的影响 |
|---------|----------|---------------|
| ADR-0007 | Caching Strategy | 操作历史可使用L1内存缓存加速查询 |
| ADR-0009 | Error Handling | 持久化失败时的错误处理遵循重试策略 |
| ADR-0010 | Logging Aggregation | 操作追踪日志使用structlog格式 |

**关键约束**:
- 操作历史限制默认100条/Canvas，防止磁盘占用过大
- 持久化使用原子写入保证数据一致性
- 操作ID使用UUID v4保证唯一性

### 架构设计参考

**架构文档引用**:
- OperationTracker类设计: [Source: docs/architecture/rollback-recovery-architecture.md:68-120]
- TrackedCanvasOperator设计: [Source: docs/architecture/rollback-recovery-architecture.md:122-180]
- 存储路径结构: [Source: docs/architecture/rollback-recovery-architecture.md:182-210]
- API端点定义: [Source: docs/architecture/rollback-recovery-architecture.md:296-350]

**存储路径结构**:
```
.canvas-learning/
├── history/
│   ├── {canvas_name}/
│   │   ├── operations.json      # 操作历史列表
│   │   └── operations/
│   │       ├── {operation_id}.json  # 单个操作详情
```

### 代码示例库

**OperationTracker类** (Source: docs/architecture/rollback-recovery-architecture.md:68-120):
```python
# src/rollback/operation_tracker.py
# ✅ Verified from Architecture Doc (rollback-recovery-architecture.md:68-120)
import uuid
from datetime import datetime, timezone
from pathlib import Path
from typing import List, Optional
from dataclasses import dataclass, field
import orjson

from .models import Operation, OperationType, OperationData, OperationMetadata

class OperationTracker:
    """Canvas操作历史追踪器

    [Source: docs/architecture/rollback-recovery-architecture.md:68-120]
    """

    def __init__(self,
                 storage_root: Path = Path(".canvas-learning"),
                 max_history_per_canvas: int = 100):
        self.storage_root = storage_root
        self.max_history = max_history_per_canvas
        self._history_cache: dict[str, List[Operation]] = {}

    def track_operation(self, operation: Operation) -> str:
        """追踪一个Canvas操作

        Args:
            operation: 操作记录

        Returns:
            操作ID
        """
        canvas_path = operation.canvas_path

        # 加载现有历史
        history = self._load_history(canvas_path)

        # 添加新操作
        history.append(operation)

        # 限制历史记录数量
        if len(history) > self.max_history:
            history = history[-self.max_history:]

        # 持久化
        self._save_history(canvas_path, history)
        self._history_cache[canvas_path] = history

        return operation.id

    def get_history(self, canvas_path: str, limit: int = 50, offset: int = 0) -> List[Operation]:
        """获取Canvas的操作历史"""
        if canvas_path in self._history_cache:
            history = self._history_cache[canvas_path]
        else:
            history = self._load_history(canvas_path)
            self._history_cache[canvas_path] = history

        # 返回最新的记录 (倒序)
        return list(reversed(history))[offset:offset+limit]
```

**TrackedCanvasOperator类** (Source: docs/architecture/rollback-recovery-architecture.md:122-180):
```python
# src/rollback/tracked_operator.py
# ✅ Verified from Architecture Doc (rollback-recovery-architecture.md:122-180)
from typing import Any, Dict, Optional
from datetime import datetime, timezone
import uuid

from .operation_tracker import OperationTracker
from .models import Operation, OperationType, OperationData, OperationMetadata

class TrackedCanvasOperator:
    """带操作追踪的Canvas操作器

    包装现有CanvasService，自动追踪所有操作。

    [Source: docs/architecture/rollback-recovery-architecture.md:122-180]
    """

    def __init__(self, canvas_service, tracker: OperationTracker, user_id: str = "system"):
        self.canvas_service = canvas_service
        self.tracker = tracker
        self.user_id = user_id

    def add_node(self, canvas_path: str, node_data: Dict[str, Any],
                 agent_id: Optional[str] = None) -> str:
        """添加节点并追踪操作"""
        # 执行实际操作
        node_id = self.canvas_service.add_node(canvas_path, node_data)

        # 追踪操作
        operation = Operation(
            id=str(uuid.uuid4()),
            type=OperationType.NODE_ADD,
            canvas_path=canvas_path,
            timestamp=datetime.now(timezone.utc),
            user_id=self.user_id,
            data=OperationData(
                before=None,
                after=node_data,
                node_ids=[node_id]
            ),
            metadata=OperationMetadata(
                agent_id=agent_id,
                description=f"Added node {node_id}"
            )
        )
        self.tracker.track_operation(operation)

        return node_id
```

**Pydantic Schema** (Source: docs/architecture/rollback-recovery-architecture.md:296-350):
```python
# backend/app/models/rollback.py
# ✅ Verified from Architecture Doc (rollback-recovery-architecture.md:296-350)
from pydantic import BaseModel, Field
from datetime import datetime
from typing import Optional, List, Any
from enum import Enum

class OperationType(str, Enum):
    NODE_ADD = "node_add"
    NODE_DELETE = "node_delete"
    NODE_MODIFY = "node_modify"
    NODE_COLOR_CHANGE = "node_color_change"
    EDGE_ADD = "edge_add"
    EDGE_DELETE = "edge_delete"
    BATCH_OPERATION = "batch_operation"

class OperationDataResponse(BaseModel):
    before: Optional[Any] = None
    after: Optional[Any] = None
    node_ids: Optional[List[str]] = None
    edge_ids: Optional[List[str]] = None

class OperationMetadataResponse(BaseModel):
    agent_id: Optional[str] = None
    request_id: Optional[str] = None
    description: str

class OperationResponse(BaseModel):
    id: str
    type: OperationType
    canvas_path: str
    timestamp: datetime
    user_id: str
    data: OperationDataResponse
    metadata: OperationMetadataResponse

class OperationHistoryResponse(BaseModel):
    canvas_path: str
    total: int
    operations: List[OperationResponse]
```

### 文件路径参考

**需要新增的文件**:
- 新增: `src/rollback/__init__.py` - 包初始化
- 新增: `src/rollback/models.py` - 数据模型
- 新增: `src/rollback/operation_tracker.py` - OperationTracker类
- 新增: `src/rollback/tracked_operator.py` - TrackedCanvasOperator类
- 新增: `backend/app/api/v1/endpoints/rollback.py` - REST端点
- 新增: `backend/app/services/rollback_service.py` - 业务逻辑
- 新增: `backend/app/models/rollback.py` - Pydantic模型
- 新增: `src/tests/unit/test_operation_tracker.py` - 单元测试

**需要修改的文件**:
- 修改: `backend/app/api/v1/router.py` - 注册rollback_router

**现有文件参考**:
- Canvas服务: `backend/app/services/canvas_service.py`
- 依赖注入: `backend/app/dependencies.py`
- API路由: `backend/app/api/v1/router.py`

### 依赖关系

**前置Story**:
- 无（本Story是Epic 18的第一个Story）

**后续影响**:
- Story 18.2: Snapshot Manager（依赖本Story的Operation ID关联快照）
- Story 18.3: Rollback Engine（依赖本Story的操作历史进行回滚）
- Story 18.5: API和配置（依赖本Story的REST端点）

### Definition of Done

- [ ] 所有AC通过验收测试
- [ ] `OperationTracker` 实现7种操作类型追踪
- [ ] `TrackedCanvasOperator` 包装现有CanvasService
- [ ] 操作历史持久化到磁盘
- [ ] REST API端点可用
- [ ] 单元测试覆盖率≥90%
- [ ] 代码Review通过
- [ ] 所有代码有文档来源标注

### 风险和缓解

| 风险 | 概率 | 影响 | 缓解措施 |
|------|------|------|---------|
| 磁盘写入性能 | 中 | 低 | 使用orjson + 异步写入 |
| 历史数据过大 | 中 | 中 | 限制100条/Canvas + 自动清理 |
| 并发写入冲突 | 低 | 中 | 使用文件锁 + 原子写入 |
| CanvasService接口变更 | 低 | 高 | TrackedOperator使用适配器模式 |

### 估算

- **Story Points**: 5
- **预估工时**: 2天
- **复杂度**: 中（涉及数据模型、持久化、API端点）

---

**文档版本**: v1.0.0
**创建时间**: 2025-12-04
**创建者**: SM Agent (Bob)
**Epic**: Epic 18 - 数据迁移和回滚
