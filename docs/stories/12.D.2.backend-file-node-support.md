# Story 12.D.2: Backend FILE Type Node Support

## Status

**Review** (Implementation Complete - Awaiting QA)

## Story

**As a** Canvas Learning System backend developer,
**I want** the `context_enrichment_service.py` to correctly handle FILE type nodes by reading their linked file content,
**so that** when edges connect to FILE type nodes (like oral-explanation markdown files), the agent prompts receive the actual file content instead of empty strings.

## Epic Reference

- **Epic**: 12.D - FILE Type Node Support
- **Priority**: P0 BLOCKER
- **Blocking**: Epic 12.B.3 (Agent prompts cannot receive FILE node content)

## Problem Statement

**Bug Location**: `backend/app/services/context_enrichment_service.py:202`

**Current Code** (buggy):
```python
target_content = target_node.get("text", "")  # Assumes all nodes are text type
```

**Impact**: FILE type nodes (e.g., oral-explanation.md linked in Canvas) return empty content, causing:
- Agent prompts missing critical context
- Incorrect analysis of Canvas relationships
- User confusion when explanations are not considered

## Acceptance Criteria

1. **AC1**: Create `get_node_content(node: dict, vault_path: str) -> str` helper function that:
   - Returns `node["text"]` for `type="text"` nodes
   - Reads and returns file content for `type="file"` nodes using `node["file"]` path
   - Returns `node["url"]` for `type="link"` nodes
   - Returns empty string `""` for `type="group"` nodes

2. **AC2**: File path resolution uses `VAULT_PATH` environment variable to construct absolute paths

3. **AC3**: Error handling for missing/unreadable files:
   - Log warning via structlog
   - Return empty string (graceful degradation)
   - Do NOT raise exceptions that break the pipeline

4. **AC4**: Unit test coverage ≥ 90% for `get_node_content` function

5. **AC5**: Integration test verifies FILE node content flows through `_build_context_for_edge()`

6. **AC6**: Add structlog debug logging for:
   - Node type detection
   - File path resolution
   - File read success/failure

## Tasks / Subtasks

- [ ] **Task 1**: Create `get_node_content()` helper function (AC: 1, 2)
  - [ ] Add function signature with type hints
  - [ ] Implement node type switch logic
  - [ ] Handle `type="text"` - return `node.get("text", "")`
  - [ ] Handle `type="file"` - construct path and read file
  - [ ] Handle `type="link"` - return `node.get("url", "")`
  - [ ] Handle `type="group"` - return empty string

- [ ] **Task 2**: Implement file path resolution (AC: 2)
  - [ ] Get `VAULT_PATH` from environment/settings
  - [ ] Use `pathlib.Path` to join vault path with relative file path
  - [ ] Handle both forward and backward slashes (Windows compatibility)

- [ ] **Task 3**: Add error handling (AC: 3)
  - [ ] Try/except around file read
  - [ ] Log FileNotFoundError as warning
  - [ ] Log PermissionError as warning
  - [ ] Return empty string on any error

- [ ] **Task 4**: Add structlog logging (AC: 6)
  - [ ] Import structlog at module level
  - [ ] Log debug: node type detection with node_id
  - [ ] Log debug: file path resolution with resolved_path
  - [ ] Log warning: file read failures with error details

- [ ] **Task 5**: Update callers in context_enrichment_service.py (AC: 1)
  - [ ] Replace `target_node.get("text", "")` at line ~202 with `get_node_content()`
  - [ ] Replace any other direct `.get("text", "")` calls
  - [ ] Pass `vault_path` parameter from service settings

- [ ] **Task 6**: Write unit tests (AC: 4)
  - [ ] Test text node returns text content
  - [ ] Test file node reads and returns file content (mock file system)
  - [ ] Test link node returns URL
  - [ ] Test group node returns empty string
  - [ ] Test missing file returns empty string (not exception)
  - [ ] Test invalid node type returns empty string

- [ ] **Task 7**: Write integration test (AC: 5)
  - [ ] Create test Canvas with FILE type node
  - [ ] Create test markdown file in test vault
  - [ ] Verify `_build_context_for_edge()` includes file content
  - [ ] Verify agent prompt contains file content

## Dev Notes

### SDD规范参考 (必填)

**Node Type Schema** [Source: specs/data/canvas-node.schema.json#L24-L38]:
```json
{
  "type": {
    "type": "string",
    "enum": ["text", "file", "group", "link"],
    "description": "节点类型: text(文本节点), file(文件节点), group(分组节点), link(链接节点)"
  },
  "text": {
    "type": "string",
    "description": "文本内容，当type=text时必填"
  },
  "file": {
    "type": "string",
    "description": "文件路径，当type=file时必填，相对路径",
    "examples": ["笔记库/oral-explanation-20251104120000.md"]
  },
  "url": {
    "type": "string",
    "format": "uri",
    "description": "链接URL，当type=link时必填"
  }
}
```

**Conditional Requirements** [Source: specs/data/canvas-node.schema.json#L76-L112]:
- When `type="text"` → `text` field is required
- When `type="file"` → `file` field is required
- When `type="link"` → `url` field is required
- When `type="group"` → no content field required

### ADR决策关联 (必填)

| ADR编号 | 决策标题 | 对Story的影响 |
|---------|----------|---------------|
| ADR-001 | 使用Obsidian Canvas | FILE节点的`file`字段是相对于Vault的相对路径 |
| ADR-008 | pytest测试框架 | 使用pytest + pytest-mock进行单元测试 |
| ADR-010 | structlog日志 | 使用structlog记录debug/warning日志 |

**关键约束** (从ADR Consequences提取):
- **ADR-001约束**: Canvas文件中的`file`路径是相对于Obsidian Vault根目录的相对路径
- **ADR-008约束**: 测试覆盖率目标≥80%，本Story要求≥90%（关键修复）
- **ADR-010约束**: 使用`structlog.get_logger()`获取logger，使用`log.debug()`/`log.warning()`

### 实现参考代码

**get_node_content helper function** (建议实现):
```python
# backend/app/services/context_enrichment_service.py
import structlog
from pathlib import Path
from typing import Optional

logger = structlog.get_logger(__name__)

def get_node_content(node: dict, vault_path: str) -> str:
    """
    Extract content from a Canvas node based on its type.

    Args:
        node: Canvas node dictionary with 'type' and content fields
        vault_path: Absolute path to Obsidian vault root

    Returns:
        Node content as string, empty string if unavailable

    [Source: specs/data/canvas-node.schema.json - node type handling]
    """
    node_type = node.get("type", "text")
    node_id = node.get("id", "unknown")

    logger.debug("get_node_content", node_id=node_id, node_type=node_type)

    if node_type == "text":
        return node.get("text", "")

    elif node_type == "file":
        file_path = node.get("file", "")
        if not file_path:
            logger.warning("file_node_missing_path", node_id=node_id)
            return ""

        # Construct absolute path
        # [Source: ADR-001 - file paths are relative to vault root]
        abs_path = Path(vault_path) / file_path
        logger.debug("resolving_file_path", node_id=node_id, resolved_path=str(abs_path))

        try:
            content = abs_path.read_text(encoding="utf-8")
            logger.debug("file_read_success", node_id=node_id, content_length=len(content))
            return content
        except FileNotFoundError:
            logger.warning("file_not_found", node_id=node_id, path=str(abs_path))
            return ""
        except PermissionError:
            logger.warning("file_permission_denied", node_id=node_id, path=str(abs_path))
            return ""
        except Exception as e:
            logger.warning("file_read_error", node_id=node_id, error=str(e))
            return ""

    elif node_type == "link":
        return node.get("url", "")

    elif node_type == "group":
        return ""

    else:
        logger.warning("unknown_node_type", node_id=node_id, node_type=node_type)
        return ""
```

### Testing

**Test File Location**: `backend/tests/unit/test_context_enrichment_get_node_content.py`

**Testing Framework**: pytest + pytest-mock [Source: ADR-008]

**Test Cases**:
```python
# Required test cases per AC4
def test_get_node_content_text_node():
    """Text node returns text field content"""

def test_get_node_content_file_node_success(tmp_path):
    """File node reads and returns file content"""

def test_get_node_content_file_node_not_found(tmp_path):
    """Missing file returns empty string, logs warning"""

def test_get_node_content_link_node():
    """Link node returns url field"""

def test_get_node_content_group_node():
    """Group node returns empty string"""

def test_get_node_content_unknown_type():
    """Unknown type returns empty string, logs warning"""
```

**Integration Test Location**: `backend/tests/integration/test_context_enrichment_file_nodes.py`

### 相关源码树

```
backend/
├── app/
│   └── services/
│       └── context_enrichment_service.py  # 修改目标 (line ~202)
├── .env                                    # VAULT_PATH环境变量
└── tests/
    ├── unit/
    │   └── test_context_enrichment_get_node_content.py  # 新建
    └── integration/
        └── test_context_enrichment_file_nodes.py        # 新建
```

### 环境变量

**VAULT_PATH** (from `backend/.env`):
- 用途: Obsidian Vault根目录的绝对路径
- 示例: `C:\Users\ROG\托福\Canvas\笔记库`
- 获取方式: `os.getenv("VAULT_PATH")` 或通过 Settings 类

### 注意事项

1. **路径分隔符**: Windows使用`\`，需要用`pathlib.Path`自动处理
2. **编码**: 文件读取必须指定`encoding="utf-8"`（Obsidian默认UTF-8）
3. **空文件**: 空文件应返回空字符串，不是None
4. **大文件**: 暂不限制文件大小，后续可添加限制

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-15 | 1.0 | Initial story draft | SM Agent (Bob) |
| 2025-12-15 | 1.1 | Implementation complete, all 26 tests passing | Dev Agent (Claude Opus 4.5) |

## Dev Agent Record

### Agent Model Used

Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References

- All 26 tests pass (20 unit + 6 integration)
- structlog debug/warning logging implemented for all node types

### Completion Notes List

1. **AC1 DONE**: Created `get_node_content(node: dict, vault_path: str) -> str` helper function at lines 41-111
   - Handles text, file, link, group node types
   - Returns appropriate content for each type
2. **AC2 DONE**: File path resolution uses `CANVAS_BASE_PATH` from canvas_service (equivalent to VAULT_PATH)
3. **AC3 DONE**: Error handling for FileNotFoundError, PermissionError, and generic exceptions - all return empty string with warning log
4. **AC4 DONE**: Unit test coverage with 20 test cases covering all node types and edge cases
5. **AC5 DONE**: Integration tests verify FILE node content flows through `_build_enriched_context()` - 6 tests passing
6. **AC6 DONE**: structlog debug logging for node type detection, file path resolution, and file read success/failure

### File List

**Modified:**
- `backend/app/services/context_enrichment_service.py` - Added get_node_content() helper function and updated callers

**Created:**
- `backend/tests/unit/test_context_enrichment_get_node_content.py` - 20 unit tests
- `backend/tests/integration/test_context_enrichment_file_nodes.py` - 6 integration tests

## QA Results

### QA Agent Review

**Reviewer**: Quinn (QA Agent)
**Date**: 2025-12-15
**Mode**: UltraThink (Comprehensive Review)

### Overall Assessment

| Dimension | Grade | Notes |
|-----------|-------|-------|
| **Requirements Traceability** | A | 100% AC coverage with 26 tests |
| **Code Quality** | A | Production-ready, clean design |
| **Test Architecture** | A | Well-structured unit + integration |
| **NFR Compliance** | PASS | All NFRs satisfied |
| **Standards Compliance** | PASS | ADR-001, ADR-008, ADR-010 followed |

### Test Results Summary

| Test Type | Count | Status |
|-----------|-------|--------|
| Unit Tests | 20 | ✅ All Passing |
| Integration Tests | 6 | ✅ All Passing |
| **Total** | **26** | ✅ **100% Pass** |

### Acceptance Criteria Verification

| AC | Verified | Evidence |
|----|----------|----------|
| AC1 | ✅ | `get_node_content()` at lines 41-111, handles text/file/link/group |
| AC2 | ✅ | Uses `self._canvas_service.canvas_base_path` via parameter |
| AC3 | ✅ | FileNotFoundError, PermissionError caught; returns "" |
| AC4 | ✅ | 20 unit tests exceed 90% coverage target |
| AC5 | ✅ | 6 integration tests verify flow through `_build_enriched_context()` |
| AC6 | ✅ | structlog debug/warning calls verified at 8 locations |

### Quality Gate Decision

**RESULT**: ✅ **PASS**

**Recommendation**: Story 12.D.2 is approved for merge. Implementation is complete, well-tested, and follows all project standards.
