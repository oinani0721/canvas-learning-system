# Story 30.22: Agent 触发深度测试 (映射表 → 行为验证)

**Epic**: [EPIC-30: Memory System Complete Activation](../epics/EPIC-30-MEMORY-SYSTEM-COMPLETE-ACTIVATION.md)
**Priority**: P1
**Estimated Hours**: 6
**Dependencies**: Story 30.12 (Agent 触发补齐), Story 30.14 (现有参数化测试)

---

## Status

**Done**

---

## Story

**As a** developer,
**I want** Agent parametrize tests that verify actual trigger behavior (not just mapping table existence),
**so that** I can confirm each AgentType produces correct memory episodes when triggered.

---

## Problem Statement

对抗性审查 (2026-02-10) 发现 (发现 #10):

1. **当前参数化测试只验证映射表**: `@pytest.mark.parametrize("agent_name", ALL_AGENTS)` + `get_memory_type_for_agent(agent_name)` 只检查映射字典中存在对应条目。
2. **不验证触发行为**: 没有测试验证 "Agent 执行完成 → `_trigger_memory_write()` 被调用 → episode 包含正确字段"。
3. **映射表存在 ≠ 功能正确**: 映射表可能存在条目但触发逻辑有 bug，当前测试无法检测。

---

## Acceptance Criteria

### AC-30.22.1: Agent 触发写入行为验证
- **Given** 14 种 `AgentType` 的每一种
- **When** Agent 执行完成并触发 `_trigger_memory_write()`
- **Then** `memory_client.add_learning_episode()` 被调用 (或同等记忆写入方法)
- **And** 调用参数包含: `agent_type` (与 AgentType 一致), `canvas_name` (非空), `concept` (非空)
- **And** 每种 AgentType 使用 `@pytest.mark.parametrize` 覆盖

### AC-30.22.2: 触发失败降级验证
- **Given** `memory_client` 不可用 (为 None 或抛出异常)
- **When** Agent 触发 `_trigger_memory_write()`
- **Then** 不抛出异常 (fire-and-forget)
- **And** 降级信息被记录:
  - None 路径: `logger.debug` 记录 "Memory client not available" (构造时已有 warning)
  - 异常路径: `logger.warning` 记录错误信息 (包含 agent_type 和 error message)

### AC-30.22.3: Episode 结构完整性验证
- **Given** 任意一种 AgentType 触发写入
- **When** episode (LearningMemory) 被生成
- **Then** episode 包含以下必要字段:
  - `memory_key` (非空, 确定性 — 格式: canvas_name:node_id:timestamp)
  - `timestamp` (ISO 8601 格式, None 时自动生成)
  - `canvas_name` (非空)
  - `node_id` (非空)
  - `concept` (非空)
- **And** 未映射的 agent_name 不触发写入 (early return)
- **Note** `agent_type` 和 `memory_type` 在 `_trigger_memory_write` 级别验证，不存储于 LearningMemory (见代码现实检查表)

---

## Tasks / Subtasks

### Task 1: 行为验证测试
- [x] 1.1 创建 `test_story_30_22_agent_trigger_deep.py`
- [x] 1.2 实现 15 种 AgentType 的 `@pytest.mark.parametrize` 触发测试
- [x] 1.3 使用 `AsyncMock` 验证 `memory_client.add_learning_episode()` 被调用
- [x] 1.4 断言调用参数包含 LearningMemory 实例的 canvas_name, concept, node_id

### Task 2: 降级测试
- [x] 2.1 `test_trigger_with_none_memory_client_no_crash()` — memory_client=None 时不崩溃
- [x] 2.2 `test_trigger_with_exception_in_add_episode_no_crash()` — memory_client 抛异常时降级
- [x] 2.3 `test_trigger_warning_contains_agent_type_on_outer_failure()` — 验证 logger.warning 包含 agent_type

### Task 3: Episode 结构验证
- [x] 3.1 `test_episode_structure_has_required_fields()` — 必要字段完整性 (含 optional 字段透传)
- [x] 3.2 `test_episode_memory_key_determinism()` — 相同输入生成相同 memory_key
- [x] 3.3 `test_unmapped_agent_skips_write()` — 未映射 agent early return + `test_memory_key_with_auto_timestamp()` — 自动时间戳 ISO 8601

---

## Dev Notes

### 与现有 Story 30.14 的关系
- Story 30.14 (`test_story_30_14_agent_trigger.py`) 保留 — 映射完整性 + 静态分析仍有价值
- Story 30.22 **补充**而非替代 30.14 — 增加行为层面的深度验证
- 避免重复: 30.22 不测映射表存在性（30.14 已覆盖），只测触发行为

### 基础设施 AC 检查

| 维度 | 检查 | 状态 |
|------|------|------|
| D2 弹性 | memory_client 不可用时降级 | AC-30.22.2 |
| D3 输入验证 | episode 必要字段完整 | AC-30.22.3 |
| D5 降级 | fire-and-forget + WARNING 日志 | AC-30.22.2 |

### 代码现实检查 (AC vs 实际代码)

| AC 声称 | 代码实际 | 适配策略 |
|---------|---------|---------|
| episode 有 episode_id | LearningMemory 有 memory_key 属性 | 用 memory_key 验证确定性 |
| episode 有 agent_type | agent_type 在 _trigger_memory_write 级别使用，不传入 LearningMemory | 通过 parametrize 15 agents 隐式覆盖 |
| episode 有 memory_type | memory_type 在 _trigger_memory_write 内部用于映射检查 | 通过 get_memory_type_for_agent 验证 |
| 14 种 AgentType | 实际映射有 15 种（含 hint-generation） | 测试覆盖全部 15 种 |

---

## Dev Agent Record

### Implementation Plan
- 创建 `backend/tests/unit/test_story_30_22_agent_trigger_deep.py`
- 3 个测试类，对应 3 个 AC
- TestAgentTriggerBehavior: 4 个 parametrize 测试 × 15 agents = 60 个测试用例
- TestTriggerDegradation: 3 个降级测试
- TestEpisodeStructure: 5 个结构验证测试 + 15 agents parametrize

### Completion Notes
- 69 个测试全部通过 (21s)
- 使用 `wait_for_call` fixture 处理 fire-and-forget asyncio.create_task
- 使用 `wait_for_condition` 处理 logger.warning 验证中的异步等待 (替代脆弱的 yield_to_event_loop)
- 验证了 LearningMemory 对象的 call_args 参数正确性（区别于 30.14 的 assert_called_once）
- 验证了 memory_key 确定性（相同输入 → 相同 key）+ 自动时间戳 ISO 8601 格式
- 验证了 logger.warning 中包含 agent_type（通过 patch record_learning_episode 触发外层 except）
- 验证了 memory_client=None 降级路径的 debug 日志
- 验证了未映射 agent 的 early return（add_learning_episode 不被调用）
- Code Review 修复: 6 个问题 (2H+4M), AC 修正匹配代码现实, 同义反复测试替换为行为测试

---

## File List

| Action | File Path |
|--------|-----------|
| Created | `backend/tests/unit/test_story_30_22_agent_trigger_deep.py` |

---

## Change Log

| Date | Change | Author |
|------|--------|--------|
| 2026-02-10 | Story 创建 (对抗性审查修复 Phase 3) | ROG |
| 2026-02-10 | 实现完成: 82 tests (Task 1-3 全部完成), status → review | Dev Agent |
| 2026-02-10 | Code Review: 修复 6 个问题 (2H+4M), AC 修正, 测试优化 82→69, status → done | Reviewer |
