# Story 36.12: ç«¯åˆ°ç«¯é›†æˆéªŒè¯ä¸å¤±è´¥å¯è§‚æµ‹æ€§å¢å¼º

## Status

In Progress

---

## Story

**As a** Canvas Learning System operator,
**I want** end-to-end integration tests that verify the complete data flow from Edge creation through Neo4j sync to Agent memory retrieval, plus observable failure handling for fire-and-forget operations,
**so that** I can be confident the entire EPIC-36 pipeline works in production, and I can detect and diagnose sync failures instead of silently losing data.

---

## Background

### ä¸ºä»€ä¹ˆéœ€è¦è¿™ä¸ª Story

**å¯¹æŠ—æ€§å®¡æŸ¥å‘ç° (2026-02-10)**:

| å‘ç°ç¼–å· | é—®é¢˜ | ä¸¥é‡ç¨‹åº¦ |
|---------|------|---------|
| F7 | EPIC-36 ç¼ºå°‘ CLAUDE.md å¼ºåˆ¶è¦æ±‚çš„ç«¯åˆ°ç«¯é›†æˆéªŒè¯ Story | ğŸ”´ é˜»å¡ |
| F11 | Story 36.3/36.9 çš„ fire-and-forget åœ¨ 3 æ¬¡é‡è¯•å…¨å¤±è´¥åé™é»˜ä¸¢æ•°æ® | ğŸŸ¡ é‡è¦ |
| F13 | å›æ»šè®¡åˆ’ (`GRAPHITI_USE_NEO4J=false`) æœªç»æµ‹è¯•éªŒè¯ | ğŸŸ¢ å»ºè®® |
| F10 | æˆåŠŸæ ‡å‡† (P95 < 200ms, 5såŒæ­¥) ç¼ºä¹æµ‹é‡æ–¹æ³•è®º | ğŸŸ¡ é‡è¦ |

**CLAUDE.md å¼ºåˆ¶è¦æ±‚**: "æ¯ä¸ª EPIC çš„æœ€åä¸€ä¸ª Story å¿…é¡»æ˜¯ç«¯åˆ°ç«¯é›†æˆéªŒè¯"

### å·²å®Œæˆ Story çš„é—ç•™ç¼ºå£

| Story | çŠ¶æ€ | é—ç•™ç¼ºå£ |
|-------|------|---------|
| 36.3 | âœ… Complete | QA å»ºè®® "è€ƒè™‘æ·»åŠ ç›‘æ§æŒ‡æ ‡è®°å½•åŒæ­¥æˆåŠŸ/å¤±è´¥æ¬¡æ•°" æœªå®ç° |
| 36.9 | âœ… Complete | åŒå†™å…¨éƒ¨å¤±è´¥åæ— è®¡æ•°å™¨/æ­»ä¿¡è®°å½• |
| å…¨å±€ | â€” | æ— è·¨ Story çš„ç«¯åˆ°ç«¯æ•°æ®æµéªŒè¯ |

---

## Acceptance Criteria

### E2E é›†æˆéªŒè¯ (F7)

1. **AC-36.12.1: Edge â†’ Neo4j â†’ Agent æ•°æ®æµ**
   - Given å‰ç«¯åˆ›å»ºä¸€ä¸ª Canvas Edge
   - When Edge é€šè¿‡ `add_edge()` API åˆ›å»º
   - Then Neo4j ä¸­å‡ºç°å¯¹åº”çš„ `CONNECTS_TO` å…³ç³» (5s å†…)
   - And Agent æŸ¥è¯¢ `_get_learning_memories()` èƒ½è·å–åˆ°è¯¥ Edge ç›¸å…³çš„ä¸Šä¸‹æ–‡

2. **AC-36.12.2: è·¨Canvaså…³è”æŒä¹…åŒ–éªŒè¯**
   - Given åˆ›å»ºä¸€ä¸ª Canvas å…³è” (`ASSOCIATED_WITH`)
   - When æœåŠ¡é‡å¯ (æ¨¡æ‹Ÿ MemoryService é‡æ–°åˆå§‹åŒ–)
   - Then å…³è”æ•°æ®ä»ä» Neo4j ä¸­å¯æŸ¥è¯¢
   - And å…³è”çš„ CRUD æ“ä½œ (create/read/update/delete) å…¨éƒ¨å¯ç”¨

3. **AC-36.12.3: å›æ»šå¼€å…³éªŒè¯** (F13)
   - Given `memory_client` æœªæ³¨å…¥ (æ¨¡æ‹Ÿ Neo4j ä¸å¯ç”¨/DI é™çº§)
   - When æ‰§è¡Œ Edge åˆ›å»º + è®°å¿†å†™å…¥ + å…³è”æŸ¥è¯¢
   - Then å…¨é“¾è·¯åˆ‡æ¢åˆ° JSON fallback å­˜å‚¨
   - And åŠŸèƒ½æ­£å¸¸ï¼Œæ— å¼‚å¸¸æŠ›å‡º
   - And æ—¥å¿—ä¸­å‡ºç° "JSON fallback" ç›¸å…³è®°å½•
   - Note: å›æ»šé€šè¿‡ DI å±‚æ§åˆ¶ (memory_client=None), éç‹¬ç«‹ç¯å¢ƒå˜é‡

### å¤±è´¥å¯è§‚æµ‹æ€§ (F11)

4. **AC-36.12.4: Edge åŒæ­¥å¤±è´¥è®¡æ•°å™¨**
   - Given Neo4j ä¸å¯ç”¨
   - When Edge åŒæ­¥ 3 æ¬¡é‡è¯•å…¨éƒ¨å¤±è´¥
   - Then `edge_sync_failures_total` è®¡æ•°å™¨ +1
   - And WARNING æ—¥å¿—åŒ…å«: edge_id, canvas_name, å¤±è´¥åŸå› , é‡è¯•æ¬¡æ•°
   - And å¤±è´¥çš„ Edge ä¿¡æ¯å†™å…¥ `backend/data/failed_edge_syncs.jsonl` (dead-letter)

5. **AC-36.12.5: åŒå†™å¤±è´¥è®¡æ•°å™¨**
   - Given LearningMemoryClient ä¸å¯ç”¨æˆ–è¶…æ—¶
   - When Graphiti JSON åŒå†™å¤±è´¥
   - Then `dual_write_failures_total` è®¡æ•°å™¨ +1
   - And WARNING æ—¥å¿—åŒ…å«: episode_id, å¤±è´¥åŸå› 
   - And å¤±è´¥è®°å½•è¿½åŠ åˆ° `backend/data/failed_dual_writes.jsonl`

6. **AC-36.12.6: å¥åº·æ£€æŸ¥åæ˜ å¤±è´¥çŠ¶æ€**
   - Given å­˜åœ¨åŒæ­¥å¤±è´¥è®°å½•
   - When è°ƒç”¨ `GET /health/storage`
   - Then å“åº”åŒ…å« `edge_sync_failures` å’Œ `dual_write_failures` å­—æ®µ
   - And å¤±è´¥æ•° > 0 æ—¶æ•´ä½“çŠ¶æ€ä¸º `degraded` (é `healthy`)

### æ€§èƒ½åŸºå‡† (F10)

7. **AC-36.12.7: P95 å»¶è¿ŸåŸºå‡†æµ‹è¯•**
   - Given è‡³å°‘ 100 æ¬¡ Edge åŒæ­¥æ“ä½œ
   - When ç»Ÿè®¡ P95 å»¶è¿Ÿ
   - Then å†™å…¥å»¶è¿Ÿ P95 < 200ms (æœ¬åœ°å¼€å‘ç¯å¢ƒåŸºå‡†)
   - And æŸ¥è¯¢å»¶è¿Ÿ P95 < 100ms
   - And ç»“æœè¾“å‡ºåˆ° pytest-benchmark æŠ¥å‘Š

### åŸºç¡€è®¾æ–½ AC (D1-D6)

8. **AC-36.12.8: D1 æŒä¹…åŒ–éªŒè¯**
   - Dead-letter æ–‡ä»¶ (`failed_edge_syncs.jsonl`, `failed_dual_writes.jsonl`) åœ¨æœåŠ¡é‡å¯åä»å­˜åœ¨
   - æ–‡ä»¶å†™å…¥ä½¿ç”¨ append æ¨¡å¼ + `encoding="utf-8"`

9. **AC-36.12.9: D2 å¼¹æ€§éªŒè¯**
   - Neo4j å®Œå…¨ä¸å¯ç”¨æ—¶: Edge åˆ›å»ºæˆåŠŸ + JSON fallback + å¤±è´¥è®¡æ•° + dead-letter
   - LearningMemoryClient ä¸å¯ç”¨æ—¶: ä¸»æµç¨‹æˆåŠŸ + WARNING æ—¥å¿— + å¤±è´¥è®¡æ•°

10. **AC-36.12.10: D4 é…ç½®éªŒè¯**
    - Neo4j å›æ»š: é€šè¿‡ DI å±‚æ§åˆ¶ (memory_client æ³¨å…¥ä¸å¦), éç‹¬ç«‹ç¯å¢ƒå˜é‡
    - `ENABLE_GRAPHITI_JSON_DUAL_WRITE` é»˜è®¤å€¼ = true (ç”± config.py ç®¡ç†)
    - `EDGE_SYNC_DEAD_LETTER_PATH` é»˜è®¤å€¼ = `backend/data/failed_edge_syncs.jsonl`
    - æ‰€æœ‰é…ç½®é¡¹åœ¨ `.env.example` ä¸­è®°å½•

---

## Tasks / Subtasks

- [x] **Task 1: E2E é›†æˆæµ‹è¯•** (AC: 1, 2, 3) âœ… å·²å®ç°
  - [x] 1.1 `backend/tests/e2e/test_epic36_integration.py` â€” 9 ä¸ªæµ‹è¯•å…¨éƒ¨ PASS
  - [x] 1.2 Edge â†’ Neo4j åŒæ­¥å®Œæ•´é“¾è·¯ (`TestEdgeToNeo4jSyncE2E`, 2 tests)
  - [ ] 1.3 è·¨Canvaså…³è” CRUD + é‡å¯åæŒä¹…åŒ– âš ï¸ ç¼ºä¸“ç”¨ E2E æµ‹è¯• (ä»£ç å·²å®ç°)
  - [x] 1.4 å›æ»šå¼€å…³ JSON fallback (`TestRollbackSwitchE2E`, 2 tests)
  - [x] 1.5 Agent æ•°æ®è¯»å– â€” é€šè¿‡å¼¹æ€§æµ‹è¯•é—´æ¥è¦†ç›–

- [x] **Task 2: å¤±è´¥å¯è§‚æµ‹æ€§ â€” Edge åŒæ­¥** (AC: 4, 8) âœ… å·²å®ç°
  - [x] 2.1 `canvas_service.py:_sync_edge_to_neo4j()` è°ƒç”¨ `increment_edge_sync_failures()` + `write_dead_letter()`
  - [x] 2.2 `app/core/failure_counters.py` åˆ›å»ºå®Œæˆ (çº¿ç¨‹å®‰å…¨è®¡æ•°å™¨ + JSONL dead-letter)
  - [x] 2.3 `tests/unit/test_failure_observability.py` å•å…ƒæµ‹è¯•è¦†ç›–

- [x] **Task 3: å¤±è´¥å¯è§‚æµ‹æ€§ â€” åŒå†™** (AC: 5, 8) âœ… å·²å®ç°
  - [x] 3.1 `memory_service.py:_write_to_graphiti_json()` è°ƒç”¨ `increment_dual_write_failures()` + `write_dead_letter()`
  - [x] 3.2 å•å…ƒæµ‹è¯•è¦†ç›–

- [x] **Task 4: å¥åº·æ£€æŸ¥å¢å¼º** (AC: 6) âœ… å·²å®ç°
  - [x] 4.1 `health.py` å“åº”åŒ…å« `edge_sync_failures` å­—æ®µ
  - [x] 4.2 å¤±è´¥æ•° > 0 â†’ çŠ¶æ€ä¸º `degraded`
  - [x] 4.3 `POST /health/storage/reset-counters` ç«¯ç‚¹å·²åˆ›å»º

- [ ] **Task 5: æ€§èƒ½åŸºå‡†æµ‹è¯•** (AC: 7) âš ï¸ é—´æ¥è¦†ç›–
  - [x] 5.1 Neo4j å†™å…¥ P95 < 200ms â€” `test_graphiti_client_mock_performance.py`
  - [x] 5.2 Neo4j æŸ¥è¯¢ P95 < 100ms â€” åŒä¸Š
  - [ ] 5.3 Edge åŒæ­¥ä¸“ç”¨ P95 åŸºå‡† âš ï¸ ç¼ºå°‘ (fire-and-forget æ¨¡å¼ä¸‹ä¸é˜»å¡ä¸»æµç¨‹)

- [x] **Task 6: é…ç½®ä¸æ–‡æ¡£** (AC: 10) âœ… å·²å®ç°
  - [x] 6.1 `.env.example` å·²åŒ…å«ç›¸å…³é…ç½®é¡¹
  - [x] 6.2 dead-letter è·¯å¾„åœ¨ `failure_counters.py` ä¸­å¯é…ç½®

---

## Dev Notes

### ä»£ç ç°å®æ£€æŸ¥ (Code Reality Check)

**å½“å‰çŠ¶æ€ (2026-02-10 éªŒè¯)**:

| ç»„ä»¶ | ä½ç½® | çŠ¶æ€ | å¤‡æ³¨ |
|------|------|------|------|
| Edge åŒæ­¥ + å¤±è´¥è®¡æ•° | `canvas_service.py:_sync_edge_to_neo4j()` | âœ… å·²å®ç° | è°ƒç”¨ `increment_edge_sync_failures()` + `write_dead_letter()` |
| åŒå†™ + å¤±è´¥è®¡æ•° | `memory_service.py:_write_to_graphiti_json()` | âœ… å·²å®ç° | è°ƒç”¨ `increment_dual_write_failures()` + `write_dead_letter()` |
| å¤±è´¥è®¡æ•°å™¨æ¨¡å— | `app/core/failure_counters.py` | âœ… å·²å®ç° | çº¿ç¨‹å®‰å…¨è®¡æ•°å™¨ + JSONL dead-letter |
| /health/storage å¢å¼º | `health.py:1285, 1705` | âœ… å·²å®ç° | `edge_sync_failures` å­—æ®µ + `POST /reset-counters` |
| E2E é›†æˆæµ‹è¯• | `tests/e2e/test_epic36_integration.py` | âœ… å·²å®ç° | 9 ä¸ªæµ‹è¯•å…¨éƒ¨ PASS |
| å¤±è´¥å¯è§‚æµ‹æ€§å•å…ƒæµ‹è¯• | `tests/unit/test_failure_observability.py` | âœ… å·²å®ç° | è®¡æ•°å™¨ + dead-letter å®Œæ•´è¦†ç›– |
| è·¨Canvaså…³è”æŒä¹…åŒ– E2E | â€” | âš ï¸ ç¼ºä¸“ç”¨E2Eæµ‹è¯• | ä»£ç å·²å®ç° (`_load_associations_from_neo4j`), ç”± cross_canvas å•å…ƒæµ‹è¯•è¦†ç›– |
| P95 å»¶è¿ŸåŸºå‡† | `tests/unit/test_graphiti_client_mock_performance.py` | âš ï¸ é—´æ¥è¦†ç›– | Neo4j å†™å…¥ P95<200ms / æŸ¥è¯¢ P95<100ms æµ‹è¯•å­˜åœ¨ |

### SDD è§„èŒƒå‚è€ƒ

**API ç«¯ç‚¹**:
- `GET /health/storage` (å·²å­˜åœ¨, éœ€å¢å¼º) â€” `health.py:1507`
- `POST /health/storage/reset-counters` (æ–°å¢)

**æ•°æ®æ ¼å¼ (Dead-letter JSONL)**:
```jsonl
{"timestamp":"2026-02-10T12:00:00","type":"edge_sync","edge_id":"abc-123","canvas_name":"test.canvas","error":"ConnectionRefused","retry_count":3}
{"timestamp":"2026-02-10T12:00:01","type":"dual_write","episode_id":"ep-456","error":"TimeoutError","timeout_ms":2000}
```

### ADR å†³ç­–å…³è”

| ADR ç¼–å· | å†³ç­–æ ‡é¢˜ | å¯¹ Story çš„å½±å“ |
|---------|----------|---------------|
| ADR-0003 | Graphiti Memory Architecture | E2E éªŒè¯è¦†ç›– 3 å±‚æ¶æ„å®Œæ•´æ€§ |
| ADR-0004 | Async Execution Engine | fire-and-forget å¤±è´¥å¿…é¡»æœ‰å¯è§‚æµ‹æ€§ |
| ADR-009 | Error Handling & Retry Strategy | é‡è¯•è€—å°½åçš„é™çº§è¡Œä¸ºè¡¥å…… |

### è·¨ Story ä¾èµ–

| ä¾èµ– Story | æä¾›çš„èƒ½åŠ› | æœ¬ Story éªŒè¯çš„å†…å®¹ |
|-----------|-----------|------------------|
| 36.1 | GraphitiClientBase + DI | DI å®Œæ•´æ€§åœ¨ E2E é“¾è·¯ä¸­å·¥ä½œ |
| 36.2 | Neo4j Cypher è°ƒç”¨ | Edge å…³ç³»çœŸå®åˆ›å»º |
| 36.3 | Edge è‡ªåŠ¨åŒæ­¥ | åŒæ­¥æˆåŠŸ + å¤±è´¥å¯è§‚æµ‹æ€§ |
| 36.4 | å…¨é‡åŒæ­¥ç«¯ç‚¹ | POST /sync-edges åœ¨ E2E ä¸­å¯ç”¨ |
| 36.5 | è·¨Canvaså…³è” CRUD | å…³è”æŒä¹…åŒ– + é‡å¯åå¯æŸ¥ |
| 36.7 | Agent Neo4j æ³¨å…¥ | _get_learning_memories() è¿”å›æ•°æ® |
| 36.9 | åŒå†™ | åŒå†™æˆåŠŸ + å¤±è´¥å¯è§‚æµ‹æ€§ |
| 36.10 | å¥åº·æ£€æŸ¥ | /health/storage åæ˜ å¤±è´¥çŠ¶æ€ |

---

## Testing

### æµ‹è¯•æ–‡ä»¶ä½ç½®
- é›†æˆ: `backend/tests/e2e/test_epic36_integration.py` (æ–°å»º, mock-based é›†æˆæµ‹è¯•)
- å•å…ƒ: `backend/tests/unit/test_failure_observability.py` (æ–°å»º)
- æ€§èƒ½: âš ï¸ `backend/tests/benchmark/test_edge_sync_latency.py` æœªåˆ›å»º (AC-36.12.7 ç”± `test_graphiti_client_mock_performance.py` é—´æ¥è¦†ç›–)

### æµ‹è¯•æ ‡å‡†
- Framework: pytest + pytest-asyncio + pytest-benchmark
- E2E æµ‹è¯•ä½¿ç”¨ JSON fallback æ¨¡å¼ (ä¸ä¾èµ– Neo4j Docker)
- æ€§èƒ½æµ‹è¯•éœ€è¦è‡³å°‘ 100 æ¬¡é‡‡æ ·

### å…³é”®æµ‹è¯•ç”¨ä¾‹

1. `test_edge_creation_to_neo4j_sync_e2e`: Edge åˆ›å»º â†’ Neo4j åŒæ­¥å®Œæ•´é“¾è·¯
2. `test_cross_canvas_association_persistence`: åˆ›å»ºå…³è” â†’ æ¨¡æ‹Ÿé‡å¯ â†’ æŸ¥è¯¢ä»åœ¨
3. `test_rollback_switch_json_fallback`: GRAPHITI_USE_NEO4J=false å…¨é“¾è·¯éªŒè¯
4. `test_edge_sync_failure_counter_and_dead_letter`: åŒæ­¥å¤±è´¥ â†’ è®¡æ•°å™¨+1 â†’ dead-letter å†™å…¥
5. `test_dual_write_failure_counter_and_dead_letter`: åŒå†™å¤±è´¥ â†’ è®¡æ•°å™¨+1 â†’ dead-letter å†™å…¥
6. `test_health_storage_reflects_failures`: æœ‰å¤±è´¥æ—¶ /health/storage è¿”å› degraded
7. `test_edge_sync_p95_under_200ms`: P95 å»¶è¿ŸåŸºå‡† (100+ é‡‡æ ·)

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-10 | 0.1 | åŸºäºå¯¹æŠ—æ€§å®¡æŸ¥ F7/F10/F11/F13 åˆ›å»ºã€‚EPIC-36 æ”¶å°¾ Story: E2E é›†æˆéªŒè¯ + å¤±è´¥å¯è§‚æµ‹æ€§ + æ€§èƒ½åŸºå‡† + å›æ»šéªŒè¯ | PM Agent (Bob) |
| 2026-02-10 | 0.2 | ä»£ç ç°å®æ£€æŸ¥: å‘ç° 8/10 AC å·²åœ¨å…¶ä»– Story ä¸­å®ç° (36.3/36.9/36.10)ã€‚Status Draft â†’ Completeã€‚Task 1-4, 6 å…¨éƒ¨å·²å®ç°ã€‚Task 5 é—´æ¥è¦†ç›–ã€‚2 ä¸ªç¼ºå£: AC-36.12.2 ç¼ºä¸“ç”¨ E2E æµ‹è¯•, AC-36.12.7 ç¼º edge sync ä¸“ç”¨ P95 åŸºå‡† | Dev Agent |
| 2026-02-11 | 0.3 | **å¯¹æŠ—æ€§ä»£ç å®¡æŸ¥ (11 findings: 3H/5M/3L)**ã€‚ä¿®å¤: (C1) Status Completeâ†’In Progress â€” Task 1.3/5 æœªå®Œæˆä¸åº”æ ‡è®° Complete; (C2) AC-36.12.10 ENABLE_GRAPHITI_JSON_DUAL_WRITE é»˜è®¤å€¼ä» false ä¿®æ­£ä¸º true (ä¸ config.py:419 ä¸€è‡´); (C3) AC-36.12.3/AC-36.12.10 ç§»é™¤ä¸å­˜åœ¨çš„ GRAPHITI_USE_NEO4J é…ç½®å¼•ç”¨, æ”¹ä¸º DI å±‚æ§åˆ¶æ–‡æ¡£; (M1) Testing èŠ‚ç§»é™¤ä¸å­˜åœ¨çš„ benchmark æµ‹è¯•æ–‡ä»¶å£°ç§°; (M2) failure_counters.py æ·»åŠ åŒæ­¥ I/O è®¾è®¡è¯´æ˜; (M3) canvas_service.py æ¾„æ¸… retry_count è¯­ä¹‰; (M4) E2E æµ‹è¯•æ–‡ä»¶æ·»åŠ åˆ†ç±»è¯´æ˜ (mock-based é›†æˆæµ‹è¯•é HTTP E2E) | Code Review (AI) |
