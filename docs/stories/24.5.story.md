# Story 24.5: RAG Context Injection for Verification Canvas

## Status
- [x] Draft
- [x] Ready for Dev
- [x] In Progress
- [x] QA Review
- [x] Done

---

## Epic Context & Background

**Epic ID**: EPIC-24
**Epic Title**: Verification Canvas Redesign (智能引导模式)
**Story Priority**: P1 (High)
**Estimated Points**: 3

**Epic Objective**: Redesign the verification canvas (检验白板) generation system to support Socratic guidance mode, integrate RAG context for intelligent question generation, and provide dynamic agent selection based on user answer quality.

**This Story's Role**: Story 24.5 integrates Epic 23's RAG system into the verification canvas, enabling context-aware question generation based on learning history and knowledge graph relationships.

**Dependencies**:
- Story 24.1: Verification Canvas Generation Engine (Architecture)
- Story 24.2: Socratic Q&A Flow (Question generation foundation)
- Epic 23: RAG Intelligent Inference System (Completed)

---

## Story Overview

**As a** Canvas Learning System user,
**I want** verification questions to be generated with RAG context from my learning history and textbook content,
**So that** questions are more relevant, hints are personalized based on my past struggles, and cross-canvas relationships enhance the verification experience.

---

## Acceptance Criteria

### AC1: Question Generation Uses RAG Context
- **Given**: A verification canvas is being generated
- **When**: A question for concept X is generated
- **Then**:
  - RAG service is queried for context related to concept X
  - Query includes learning history, textbook excerpts, and cross-canvas relationships
  - Generated question incorporates relevant context
- **Verification**: API logs show RAG query; question content includes context references

### AC2: Hints Based on Learning History
- **Given**: User provides a partial/incorrect answer
- **When**: System generates a hint
- **Then**:
  - RAG service retrieves past attempts on similar concepts
  - Hint references common mistakes or previously successful explanations
  - Hint avoids repeating ineffective approaches
- **Verification**: Hint content differs based on user's history; new users get generic hints

### AC3: Cross-Canvas Association in Prompts
- **Given**: Concept X appears in multiple canvases or is related to textbook content
- **When**: A hint or follow-up question is generated
- **Then**:
  - System retrieves related concepts from other canvases (Epic 25)
  - Cross-references are included when beneficial
  - User is informed which related material might help
- **Verification**: Response includes cross-canvas references when applicable

### AC4: Textbook Context Reference
- **Given**: A canvas is associated with a textbook or lecture material
- **When**: Questions or hints are generated
- **Then**:
  - RAG queries textbook context via TextbookContextService
  - Relevant textbook sections are cited in hints
  - Question complexity matches textbook difficulty level
- **Verification**: API response includes textbook references; verify via mounted textbook service

### AC5: Graceful RAG Degradation
- **Given**: RAG service is unavailable or times out
- **When**: Verification canvas generation is attempted
- **Then**:
  - System falls back to non-RAG question generation
  - Warning is logged but generation continues
  - User is informed that enhanced context is unavailable
  - No error is thrown to user
- **Verification**: Timeout simulation produces successful generation with fallback message

---

## Dev Notes (CRITICAL - Self-Contained)

### Technical Context

This story integrates Epic 23's RAG system (`RAGService`) with the verification canvas generation pipeline. The goal is to enhance question and hint quality using learning history, cross-canvas relationships, and textbook context.

**Current State**:
- `VerificationService` exists (Story 24.1-24.2)
- `RAGService` from Epic 23 is operational
- `CrossCanvasService` and `TextbookContextService` from Epic 25 are available

**Target State**:
- `VerificationService` calls `RAGService` for context
- Questions include RAG-enhanced prompts
- Hints leverage learning history
- Cross-canvas and textbook context are integrated
- Graceful fallback when RAG fails

### API Endpoints

**Primary Endpoint**: `POST /review/generate-canvas`
- **File**: `backend/app/api/v1/endpoints/review.py`
- No API changes required; RAG integration is internal to VerificationService

**Internal Service Calls**:
- `RAGService.query()` - Core RAG query
- `CrossCanvasService.find_related_canvases()` - Cross-canvas relationships
- `TextbookContextService.get_context()` - Textbook excerpts

### SDD References

| Type | File | Lines | Description |
|------|------|-------|-------------|
| OpenAPI | specs/api/review-api.openapi.yml | L215-257 | generate-canvas endpoint |
| Behavior | specs/behavior/verification-canvas.feature | L50-75 | RAG context scenarios |

### ADR References

| ADR | Description | Relevance |
|-----|-------------|-----------|
| docs/architecture/decisions/0003-graphiti-memory.md | Graphiti integration | Learning history storage |

### Implementation Guidelines

**Step 1: Add RAG Dependency to VerificationService**
```python
# backend/app/services/verification_service.py
from backend.app.services.rag_service import RAGService
from backend.app.services.cross_canvas_service import CrossCanvasService
from backend.app.services.textbook_context_service import TextbookContextService

class VerificationService:
    def __init__(
        self,
        rag_service: RAGService,
        cross_canvas_service: CrossCanvasService,
        textbook_context_service: TextbookContextService,
        logger: logging.Logger
    ):
        self.rag_service = rag_service
        self.cross_canvas_service = cross_canvas_service
        self.textbook_context_service = textbook_context_service
        self.logger = logger
```

**Step 2: Implement RAG Context Query**
```python
# backend/app/services/verification_service.py
async def _get_rag_context_for_concept(
    self,
    concept: str,
    canvas_name: str,
    timeout: float = 5.0
) -> Optional[dict]:
    """Query RAG for concept-related context with timeout fallback."""
    try:
        rag_result = await asyncio.wait_for(
            self.rag_service.query(
                query=f"关于「{concept}」的学习历史、相关知识和常见错误",
                canvas_file=canvas_name,
                include_history=True,
                include_textbook=True
            ),
            timeout=timeout
        )
        return {
            "learning_history": rag_result.history_context,
            "textbook_excerpts": rag_result.textbook_context,
            "related_concepts": rag_result.related_concepts,
            "common_mistakes": rag_result.common_mistakes
        }
    except asyncio.TimeoutError:
        self.logger.warning(f"RAG query timeout for concept: {concept}")
        return None
    except Exception as e:
        self.logger.error(f"RAG query failed: {e}")
        return None
```

**Step 3: Enhance Question Generation**
```python
# backend/app/services/verification_service.py
async def generate_question_with_rag(
    self,
    concept: str,
    canvas_name: str
) -> str:
    """Generate verification question with RAG context."""
    # Get RAG context
    rag_context = await self._get_rag_context_for_concept(concept, canvas_name)

    if rag_context:
        # Build enhanced prompt
        prompt = self._build_rag_enhanced_prompt(concept, rag_context)
    else:
        # Fallback: basic question without RAG
        prompt = self._build_basic_prompt(concept)

    # Generate question via LLM
    question = await self._generate_question(prompt)
    return question

def _build_rag_enhanced_prompt(self, concept: str, context: dict) -> str:
    """Build prompt with RAG context for question generation."""
    prompt_parts = [
        f"为概念「{concept}」生成一个检验问题。",
        "",
        "## 学习历史",
        context.get("learning_history", "无历史记录"),
        "",
        "## 教材参考",
        context.get("textbook_excerpts", "无教材引用"),
        "",
        "## 相关概念",
        ", ".join(context.get("related_concepts", [])) or "无相关概念",
        "",
        "## 常见错误",
        context.get("common_mistakes", "无已知错误模式"),
        "",
        "请根据以上上下文，生成一个能够检验用户对该概念理解深度的问题。"
    ]
    return "\n".join(prompt_parts)
```

**Step 4: Enhance Hint Generation**
```python
# backend/app/services/verification_service.py
async def generate_hint_with_rag(
    self,
    concept: str,
    user_answer: str,
    attempt_number: int,
    canvas_name: str
) -> str:
    """Generate personalized hint based on RAG context."""
    rag_context = await self._get_rag_context_for_concept(concept, canvas_name)

    if rag_context and rag_context.get("learning_history"):
        # Personalized hint based on history
        past_hints = rag_context.get("past_effective_hints", [])
        return self._generate_personalized_hint(
            concept, user_answer, past_hints, attempt_number
        )
    else:
        # Generic hint
        return self._generate_generic_hint(concept, attempt_number)
```

**Step 5: Add Cross-Canvas Context**
```python
# backend/app/services/verification_service.py
async def _get_cross_canvas_context(
    self,
    concept: str,
    canvas_name: str
) -> List[dict]:
    """Get related concepts from other canvases."""
    try:
        related = await self.cross_canvas_service.find_related_canvases(
            concept=concept,
            current_canvas=canvas_name,
            limit=3
        )
        return [
            {
                "canvas": r.canvas_name,
                "concept": r.related_concept,
                "relationship": r.relationship_type
            }
            for r in related
        ]
    except Exception as e:
        self.logger.warning(f"Cross-canvas lookup failed: {e}")
        return []
```

**Step 6: Graceful Degradation**
```python
# backend/app/services/verification_service.py
class VerificationService:
    RAG_ENABLED = True  # Can be disabled via config
    RAG_TIMEOUT = 5.0   # Timeout in seconds

    async def generate_verification_canvas(
        self,
        canvas_name: str,
        **kwargs
    ) -> ReviewProgress:
        """Generate canvas with graceful RAG fallback."""
        rag_available = self.RAG_ENABLED

        if rag_available:
            try:
                # Test RAG connectivity
                await asyncio.wait_for(
                    self.rag_service.health_check(),
                    timeout=1.0
                )
            except:
                self.logger.warning("RAG service unavailable, using fallback mode")
                rag_available = False

        # Continue with or without RAG
        return await self._generate_canvas_internal(
            canvas_name,
            use_rag=rag_available,
            **kwargs
        )
```

### Key Files to Modify

| File Path | Change Type | Description |
|-----------|-------------|-------------|
| `backend/app/services/verification_service.py` | Modify | Add RAG integration methods |
| `backend/app/dependencies.py` | Modify | Inject RAGService dependency |
| `src/verification_graph/nodes.py` | Modify | Use RAG in question/hint nodes |
| `src/tests/test_rag_integration.py` | Create | RAG integration tests |
| `src/tests/test_rag_fallback.py` | Create | Fallback behavior tests |

### Existing Code References

| Location | Line Range | Purpose |
|----------|------------|---------|
| backend/app/services/rag_service.py | Full | RAGService class |
| backend/app/services/cross_canvas_service.py | L50-100 | Cross-canvas queries |
| backend/app/services/textbook_context_service.py | L30-80 | Textbook context retrieval |
| backend/app/services/verification_service.py | L90-150 | Current verification logic |

---

## Testing Requirements

### Unit Tests

**Test File**: `src/tests/test_rag_context_injection.py`

```python
import pytest
from unittest.mock import AsyncMock, patch
from backend.app.services.verification_service import VerificationService

class TestRAGContextInjection:

    @pytest.mark.asyncio
    async def test_question_generation_uses_rag_context(
        self,
        verification_service,
        mock_rag_service
    ):
        """AC1: Question generation should query RAG for context."""
        mock_rag_service.query.return_value = MockRAGResult(
            history_context="用户之前对此概念有3次错误尝试",
            textbook_context="教材第5章定义...",
            related_concepts=["概念A", "概念B"]
        )

        question = await verification_service.generate_question_with_rag(
            concept="逆否命题",
            canvas_name="离散数学.canvas"
        )

        mock_rag_service.query.assert_called_once()
        assert "逆否命题" in question or "inversely" in question.lower()

    @pytest.mark.asyncio
    async def test_hint_uses_learning_history(
        self,
        verification_service,
        mock_rag_service
    ):
        """AC2: Hints should reference learning history."""
        mock_rag_service.query.return_value = MockRAGResult(
            history_context="用户常混淆逆命题和否命题",
            past_effective_hints=["尝试从结论倒推..."]
        )

        hint = await verification_service.generate_hint_with_rag(
            concept="逆否命题",
            user_answer="错误答案",
            attempt_number=1,
            canvas_name="离散数学.canvas"
        )

        # Hint should be personalized
        assert hint != verification_service._generate_generic_hint("逆否命题", 1)

    @pytest.mark.asyncio
    async def test_cross_canvas_references_included(
        self,
        verification_service,
        mock_cross_canvas_service
    ):
        """AC3: Cross-canvas relationships should be included."""
        mock_cross_canvas_service.find_related_canvases.return_value = [
            MockRelatedCanvas("数理逻辑.canvas", "充分必要条件", "relates_to")
        ]

        context = await verification_service._get_cross_canvas_context(
            concept="逆否命题",
            canvas_name="离散数学.canvas"
        )

        assert len(context) > 0
        assert context[0]["canvas"] == "数理逻辑.canvas"

    @pytest.mark.asyncio
    async def test_textbook_context_retrieved(
        self,
        verification_service,
        mock_rag_service
    ):
        """AC4: Textbook context should be included in prompts."""
        mock_rag_service.query.return_value = MockRAGResult(
            textbook_context="《离散数学》第三章：命题逻辑的等价变换..."
        )

        rag_context = await verification_service._get_rag_context_for_concept(
            concept="逆否命题",
            canvas_name="离散数学.canvas"
        )

        assert "textbook_excerpts" in rag_context
        assert "离散数学" in rag_context["textbook_excerpts"]

    @pytest.mark.asyncio
    async def test_graceful_degradation_on_timeout(
        self,
        verification_service,
        mock_rag_service
    ):
        """AC5: RAG timeout should not block generation."""
        mock_rag_service.query.side_effect = asyncio.TimeoutError()

        # Should not raise exception
        result = await verification_service.generate_verification_canvas(
            canvas_name="test.canvas"
        )

        assert result is not None
        # Verify fallback was used
        assert verification_service.logger.warning.called

    @pytest.mark.asyncio
    async def test_graceful_degradation_on_service_error(
        self,
        verification_service,
        mock_rag_service
    ):
        """AC5: RAG service error should trigger fallback."""
        mock_rag_service.health_check.side_effect = ConnectionError()

        result = await verification_service.generate_verification_canvas(
            canvas_name="test.canvas"
        )

        assert result is not None
```

### Integration Tests

**Test File**: `src/tests/integration/test_rag_verification_integration.py`

```python
@pytest.mark.integration
async def test_full_rag_verification_flow():
    """E2E test for RAG-enhanced verification canvas generation."""
    # Setup: Create canvas with learning history
    # Execute: Generate verification canvas
    # Verify: Questions include RAG context, hints are personalized
    pass
```

---

## Dependencies

### Story Dependencies
- Story 24.1: Architecture must be in place
- Story 24.2: Question generation flow must exist

### Technical Dependencies
- RAGService from Epic 23
- CrossCanvasService from Epic 25
- TextbookContextService from Epic 25
- Neo4j for Graphiti queries

### External Dependencies
- `neo4j>=5.0.0` - Graph database
- `graphiti-core>=0.6.0` - Knowledge graph SDK
- `lancedb>=0.4.0` - Vector database for RAG

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-13 | 1.0 | Initial draft - Manual creation | Bob (SM Agent) |

---

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5 (claude-sonnet-4-5-20250929)

### Debug Log References
- Test run: All 14 tests passed (AC1-AC5 verified)
- pytest output: src/tests/test_rag_context_injection.py (7.85s)

### Completion Notes List
1. ✅ Updated VerificationService with RAG integration:
   - Added RAG, CrossCanvas, and TextbookContext dependencies
   - Implemented `_get_rag_context_for_concept()` with timeout fallback
   - Implemented `generate_question_with_rag()` with enhanced prompts
   - Implemented `generate_hint_with_rag()` with learning history
   - Implemented `_get_cross_canvas_context()` for cross-canvas relationships
   - Implemented `_build_rag_enhanced_prompt()` and `_build_basic_prompt()`

2. ✅ Updated dependencies.py:
   - Added `get_verification_service()` with RAG service injection
   - Created VerificationServiceDep type alias
   - Configured 3-second timeout for textbook queries (AC4)
   - Services are optional - graceful degradation built-in (AC5)

3. ✅ Created comprehensive test suite:
   - `src/tests/test_rag_context_injection.py` (14 tests)
   - AC1: Question generation uses RAG context (2 tests)
   - AC2: Hints based on learning history (2 tests)
   - AC3: Cross-canvas references (2 tests)
   - AC4: Textbook context (1 test)
   - AC5: Graceful degradation (4 tests)
   - Integration tests (2 tests)
   - Performance tests (1 test)

4. ✅ All acceptance criteria met:
   - AC1: RAG query includes learning history, textbook, concepts, mistakes
   - AC2: Personalized hints differ based on history
   - AC3: Cross-canvas lookup returns related canvases (limited to 3)
   - AC4: Textbook context included in RAG results
   - AC5: Timeout/error handling with fallback to basic prompts

### File List
**Modified**:
- `backend/app/services/verification_service.py` (v2.0.0)
  - Added RAG dependencies to __init__
  - Added 6 new methods for RAG integration
  - 270+ lines of new code with full documentation

- `backend/app/dependencies.py`
  - Added VerificationService imports
  - Added `get_verification_service()` function (60 lines)
  - Added VerificationServiceDep type alias
  - Updated __all__ exports

**Created**:
- `src/tests/test_rag_context_injection.py` (460 lines)
  - 14 test cases covering all ACs
  - Mock classes for RAG, CrossCanvas services
  - Integration and performance tests

---

## QA Results

*Pending QA Agent review*

---

## Related Documentation

**Epic Documentation**:
- Epic 24: Verification Canvas Redesign - PRD

**Dependency Stories**:
- Story 24.1: Verification Canvas Generation Engine
- Story 24.2: Socratic Q&A Flow

**Epic 23 References** (RAG System):
- `backend/app/services/rag_service.py` - Core RAG service
- `src/agentic_rag/` - RAG implementation

**Epic 25 References** (Cross-Canvas):
- `backend/app/services/cross_canvas_service.py` - Cross-canvas queries
- `backend/app/services/textbook_context_service.py` - Textbook context

**Architecture Documentation**:
- docs/architecture/decisions/0003-graphiti-memory.md - Graphiti ADR

**API Specifications**:
- specs/api/review-api.openapi.yml - Review API (L215-257: generate-canvas endpoint)

**Skills References**:
- .claude/skills/graphiti/SKILL.md - Graphiti documentation
- .claude/skills/langgraph/SKILL.md - LangGraph documentation
