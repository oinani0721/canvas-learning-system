# Story 6.9: 多模态UI集成

## Status
Completed

## Story

**As a** Canvas学习用户,
**I want** 在界面上直观地预览和管理多模态内容,
**so that** 可以方便地浏览图片、PDF和其他资料

## Epic Context

**Epic**: SCP-006 多模态文件关联
**Phase**: Phase 3 - 关联与检索
**Priority**: P1
**Estimated Time**: 3天

## Dependencies

- ✅ Story 6.1-6.8 - 所有多模态功能
- ✅ Epic 13 (Obsidian Plugin) - 插件基础框架
- ⏳ UI组件库 - 需要React组件

## Acceptance Criteria

### AC 6.9.1: 图片预览组件
- [x] 缩略图展示（150x150）
- [x] 点击放大查看
- [x] 支持图片轮播

### AC 6.9.2: PDF预览组件
- [x] 首页缩略图
- [x] 内嵌PDF阅读器
- [x] 支持页码跳转

### AC 6.9.3: 音视频播放器
- [x] 内嵌播放器
- [x] 进度条和控制按钮
- [x] 支持时间戳标记

### AC 6.9.4: 关联资料面板
- [x] 显示概念关联的所有资料
- [x] 按相关度排序
- [x] 支持筛选和搜索

### AC 6.9.5: 移动端适配
- [x] 响应式布局
- [x] 触摸手势支持
- [x] 适配小屏幕

## Tasks / Subtasks

- [x] Task 1: 图片预览组件 (AC: 6.9.1)
  - [x] 实现ImagePreview组件
  - [x] 实现ImageGallery组件
  - [x] 实现Lightbox放大功能

- [x] Task 2: PDF预览组件 (AC: 6.9.2)
  - [x] 实现PDFPreview组件
  - [x] 集成PDF.js阅读器
  - [x] 页码导航功能

- [x] Task 3: 音视频播放器 (AC: 6.9.3)
  - [x] 实现AudioPlayer组件
  - [x] 实现VideoPlayer组件
  - [x] 时间戳标记功能

- [x] Task 4: 关联资料面板 (AC: 6.9.4)
  - [x] 实现MediaPanel组件
  - [x] 实现MediaList组件
  - [x] 筛选和搜索功能

- [x] Task 5: 移动端适配 (AC: 6.9.5)
  - [x] 响应式CSS
  - [x] 触摸事件处理
  - [x] 性能优化

## Dev Notes

### 技术栈

```yaml
UI框架:
  React: ^18.0
  组件库: Obsidian原生组件 + 自定义

PDF渲染:
  库: PDF.js
  版本: ^3.0

图片处理:
  预览: react-photo-view
  裁剪: sharp (后端)

音视频:
  播放器: plyr 或 video.js
```

### 代码位置

```
创建文件:
- obsidian-plugin/src/components/ImagePreview.tsx
- obsidian-plugin/src/components/PDFPreview.tsx
- obsidian-plugin/src/components/AudioPlayer.tsx
- obsidian-plugin/src/components/VideoPlayer.tsx
- obsidian-plugin/src/components/MediaPanel.tsx
- obsidian-plugin/src/styles/multimodal.css

测试文件:
- obsidian-plugin/src/tests/components/
```

### 核心实现

```typescript
// obsidian-plugin/src/components/ImagePreview.tsx
import React, { useState } from 'react';
import { PhotoProvider, PhotoView } from 'react-photo-view';
import 'react-photo-view/dist/react-photo-view.css';

interface ImagePreviewProps {
  src: string;
  alt?: string;
  thumbnailSize?: number;
}

export const ImagePreview: React.FC<ImagePreviewProps> = ({
  src,
  alt = '',
  thumbnailSize = 150
}) => {
  return (
    <PhotoProvider>
      <PhotoView src={src}>
        <img
          src={src}
          alt={alt}
          style={{
            width: thumbnailSize,
            height: thumbnailSize,
            objectFit: 'cover',
            cursor: 'pointer',
            borderRadius: 4
          }}
        />
      </PhotoView>
    </PhotoProvider>
  );
};

// 图片轮播组件
export const ImageGallery: React.FC<{ images: string[] }> = ({ images }) => {
  return (
    <PhotoProvider>
      <div className="image-gallery">
        {images.map((src, index) => (
          <PhotoView key={index} src={src}>
            <img src={src} alt={`Image ${index + 1}`} />
          </PhotoView>
        ))}
      </div>
    </PhotoProvider>
  );
};
```

```typescript
// obsidian-plugin/src/components/PDFPreview.tsx
import React, { useState } from 'react';
import { Document, Page, pdfjs } from 'react-pdf';

pdfjs.GlobalWorkerOptions.workerSrc = `//cdnjs.cloudflare.com/ajax/libs/pdf.js/${pdfjs.version}/pdf.worker.min.js`;

interface PDFPreviewProps {
  filePath: string;
  initialPage?: number;
}

export const PDFPreview: React.FC<PDFPreviewProps> = ({
  filePath,
  initialPage = 1
}) => {
  const [numPages, setNumPages] = useState<number>(0);
  const [pageNumber, setPageNumber] = useState<number>(initialPage);

  function onDocumentLoadSuccess({ numPages }: { numPages: number }) {
    setNumPages(numPages);
  }

  return (
    <div className="pdf-preview">
      <Document
        file={filePath}
        onLoadSuccess={onDocumentLoadSuccess}
      >
        <Page pageNumber={pageNumber} />
      </Document>

      <div className="pdf-controls">
        <button
          disabled={pageNumber <= 1}
          onClick={() => setPageNumber(pageNumber - 1)}
        >
          上一页
        </button>
        <span>{pageNumber} / {numPages}</span>
        <button
          disabled={pageNumber >= numPages}
          onClick={() => setPageNumber(pageNumber + 1)}
        >
          下一页
        </button>
      </div>
    </div>
  );
};
```

```typescript
// obsidian-plugin/src/components/MediaPanel.tsx
import React, { useState, useMemo } from 'react';
import { ImagePreview } from './ImagePreview';
import { PDFPreview } from './PDFPreview';
import { AudioPlayer } from './AudioPlayer';
import { VideoPlayer } from './VideoPlayer';

interface MediaItem {
  id: string;
  type: 'image' | 'pdf' | 'audio' | 'video';
  path: string;
  description?: string;
  relevanceScore: number;
}

interface MediaPanelProps {
  conceptId: string;
  mediaItems: MediaItem[];
}

export const MediaPanel: React.FC<MediaPanelProps> = ({
  conceptId,
  mediaItems
}) => {
  const [filter, setFilter] = useState<string>('all');
  const [searchQuery, setSearchQuery] = useState<string>('');

  const filteredItems = useMemo(() => {
    return mediaItems
      .filter(item => filter === 'all' || item.type === filter)
      .filter(item =>
        !searchQuery ||
        item.description?.toLowerCase().includes(searchQuery.toLowerCase())
      )
      .sort((a, b) => b.relevanceScore - a.relevanceScore);
  }, [mediaItems, filter, searchQuery]);

  const renderMediaItem = (item: MediaItem) => {
    switch (item.type) {
      case 'image':
        return <ImagePreview src={item.path} />;
      case 'pdf':
        return <PDFPreview filePath={item.path} />;
      case 'audio':
        return <AudioPlayer src={item.path} />;
      case 'video':
        return <VideoPlayer src={item.path} />;
      default:
        return null;
    }
  };

  return (
    <div className="media-panel">
      <div className="media-panel-header">
        <h3>关联资料</h3>
        <input
          type="text"
          placeholder="搜索..."
          value={searchQuery}
          onChange={e => setSearchQuery(e.target.value)}
        />
        <select value={filter} onChange={e => setFilter(e.target.value)}>
          <option value="all">全部</option>
          <option value="image">图片</option>
          <option value="pdf">PDF</option>
          <option value="audio">音频</option>
          <option value="video">视频</option>
        </select>
      </div>

      <div className="media-list">
        {filteredItems.map(item => (
          <div key={item.id} className="media-item">
            {renderMediaItem(item)}
            <div className="media-info">
              <span className="relevance">相关度: {(item.relevanceScore * 100).toFixed(0)}%</span>
              {item.description && <p>{item.description}</p>}
            </div>
          </div>
        ))}
      </div>
    </div>
  );
};
```

### CSS样式

```css
/* obsidian-plugin/src/styles/multimodal.css */

.media-panel {
  padding: 16px;
  background: var(--background-secondary);
  border-radius: 8px;
}

.media-panel-header {
  display: flex;
  gap: 12px;
  margin-bottom: 16px;
  align-items: center;
}

.media-list {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
  gap: 16px;
}

.media-item {
  background: var(--background-primary);
  border-radius: 8px;
  overflow: hidden;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.media-info {
  padding: 12px;
}

.relevance {
  font-size: 12px;
  color: var(--text-muted);
}

/* 响应式布局 */
@media (max-width: 768px) {
  .media-list {
    grid-template-columns: repeat(2, 1fr);
  }
}

@media (max-width: 480px) {
  .media-list {
    grid-template-columns: 1fr;
  }

  .media-panel-header {
    flex-direction: column;
  }
}
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-30 | 1.0 | Initial Story Creation | SM Agent (Bob) |

## QA Results

### Review Date: 待开发

### Reviewed By: 待开发

### Test Results
待开发

---

**关联文档**:
- SCP-006-IMPLEMENTATION-PLAN.md
- Epic 13 (Obsidian Plugin)
- Story 6.1-6.8 (所有多模态功能)
