# Story 33.11: Dead Code Removal + DI Consolidation

## Status: done

---

## Story

**As a** Canvas Learning System maintainer,
**I want** dead code removed and duplicated DI logic consolidated into a single source of truth,
**so that** the codebase is maintainable and future developers are not confused by unused 809-line modules or duplicated initialization paths.

---

## Problem Statement

### Adversarial Audit Findings (2026-02-10)

| # | Finding | Severity | Location |
|---|---------|----------|----------|
| 1 | `result_merger.py` (809 lines) is **100% dead code** — no import or call from anywhere in the codebase | P0 | `backend/app/services/result_merger.py` |
| 2 | `_ensure_async_deps()` in `intelligent_parallel.py` duplicates ~80% of `dependencies.py` DI logic, manually constructing GeminiClient, CanvasService, AgentService, BatchOrchestrator | P1 | `intelligent_parallel.py:124-229` |

### Root Cause Analysis

**#1 ResultMerger Dead Code**: Story 33.7 implemented 3 merge strategies (Supplementary, Hierarchical, Voting) with an ABC base class, registry pattern, and factory function. However, no Story wired the merger into `BatchOrchestrator` or any endpoint. Grep confirms zero imports outside the module itself:

```
grep -rn "result_merger\|ResultMerger\|merge_results" backend/app/
→ Only hits within result_merger.py itself
```

**#2 DI Duplication**: Story 33.9 added `_ensure_async_deps()` to inject `BatchOrchestrator` and `AgentService` at runtime. This function manually constructs the full dependency chain (GeminiClient → AgentService → BatchOrchestrator) with the same logic as `dependencies.py:L941-1041`. Any change to DI configuration must be made in two places, creating drift risk.

---

## Acceptance Criteria

### AC-33.11.1: ResultMerger removal (P0)
- **Given** `result_merger.py` has zero external callers
- **When** the file is deleted
- **Then** all existing tests pass (zero regressions)
- **And** no import errors at startup
- **And** the associated model file `merge_strategy_models.py` is also cleaned up if unused

### AC-33.11.2: DI consolidation (P1)
- **Given** `_ensure_async_deps()` in `intelligent_parallel.py` duplicates `dependencies.py` logic
- **When** the DI is consolidated
- **Then** `_ensure_async_deps()` delegates to `dependencies.py` factory functions (or imports pre-built instances)
- **And** any future DI configuration change needs to be made in only ONE place
- **And** all existing tests pass (zero regressions)

### AC-33.11.3: No new dead code introduced (P1)
- **Given** the cleanup is complete
- **When** running `grep -rn "result_merger\|merge_strategy_models" backend/app/`
- **Then** zero hits remain (no stale imports or comments referencing removed modules)

---

## Technical Details

### Files to Modify/Delete

| File | Action | Priority |
|------|--------|----------|
| `backend/app/services/result_merger.py` | **DELETE** (809 lines) | P0 |
| `backend/app/models/merge_strategy_models.py` | **DELETE** if no other consumers | P0 |
| `backend/app/api/v1/endpoints/intelligent_parallel.py` | Refactor `_ensure_async_deps()` to reuse `dependencies.py` | P1 |
| `backend/app/dependencies.py` | Ensure EPIC-33 factories are usable from endpoint layer | P1 |

### Fix #1: Delete ResultMerger

Pre-deletion verification checklist:
```bash
# Verify zero external imports
grep -rn "from.*result_merger import\|import.*result_merger" backend/app/ --include="*.py"
# Expected: 0 hits outside result_merger.py itself

# Verify zero external imports of models
grep -rn "from.*merge_strategy_models import\|import.*merge_strategy_models" backend/app/ --include="*.py"
# Expected: only result_merger.py imports these

# Delete
rm backend/app/services/result_merger.py
rm backend/app/models/merge_strategy_models.py  # if confirmed unused

# Verify no import errors
cd backend && python -c "from app.main import app; print('OK')"
```

### Fix #2: DI Consolidation Strategy

**Current state** (`intelligent_parallel.py:124-229`):
```python
async def _ensure_async_deps():
    # Manually constructs: GeminiClient, CanvasService, AgentService, BatchOrchestrator
    # ~100 lines of DI logic duplicated from dependencies.py
```

**Target state** — delegate to `dependencies.py`:
```python
async def _ensure_async_deps():
    global _deps_initialized
    if _deps_initialized:
        return
    async with _deps_lock:
        if _deps_initialized:
            return
        service = get_service()

        from app.dependencies import (
            get_settings,
            get_session_manager,
            get_agent_routing_engine,
        )
        # Reuse the existing DI factory for BatchOrchestrator + AgentService
        from app.dependencies import _build_batch_orchestrator_and_agent_service
        batch_orchestrator, agent_service = await _build_batch_orchestrator_and_agent_service()

        service._batch_orchestrator = batch_orchestrator
        service._agent_service = agent_service
        _deps_initialized = True
```

This requires extracting the common construction logic into a reusable async helper in `dependencies.py`.

### Singleton Constraint (Preserved)

The `BatchOrchestrator` must remain a singleton — `_cancel_requested` is instance-level state shared between `/confirm` and `/cancel`. The DI consolidation must NOT switch to per-request `Depends()` for this component.

---

## Test Plan

```bash
# 1. Verify deletion doesn't break imports
cd backend && python -c "from app.main import app; print('Startup OK')"

# 2. Run all existing tests
python -m pytest tests/ -v --timeout=120

# 3. Verify zero stale references
grep -rn "result_merger\|merge_strategy_models\|ResultMerger" backend/ --include="*.py"
# Expected: 0 hits

# 4. DI integration test still passes
python -m pytest tests/integration/test_epic33_di_completeness.py -v
```

---

## Definition of Done

- [x] `result_merger.py` deleted (809 lines removed)
- [x] `merge_strategy_models.py` deleted (confirmed only imported by result_merger.py)
- [x] Zero stale imports/references to deleted modules (grep verified: 0 hits)
- [x] `_ensure_async_deps()` delegates to `dependencies.py` (single source of truth)
- [x] All existing tests pass (zero regressions) — 125+ tests passed
- [x] DI integration test verifies consolidated path works

---

## Dev Agent Record

### Implementation Plan

1. Verify result_merger.py is 100% dead code (grep zero external imports)
2. Delete result_merger.py, merge_strategy_models.py, and all related test files
3. Clean stale imports in test_batch_processing.py and factories.py
4. Add `build_batch_processing_deps()` to dependencies.py (single source of truth)
5. Refactor `_ensure_async_deps()` in intelligent_parallel.py to delegate to dependencies.py
6. Run full test suite to verify zero regressions

### Debug Log

- First grep found zero imports of result_merger in `backend/app/`
- After deletion, broader grep of `backend/` revealed additional references in:
  - `tests/unit/result_merger/` directory (7 files) — deleted entire directory
  - `tests/factories.py` importing AgentResult — cleaned up
- Second grep confirmed zero remaining references across entire backend

### Completion Notes

Story 33.11 complete. All 3 ACs verified:
- **AC-33.11.1**: Deleted result_merger.py (809 lines), merge_strategy_models.py, and all related tests (~1200 lines total removed)
- **AC-33.11.2**: Created `build_batch_processing_deps()` in dependencies.py; `_ensure_async_deps()` reduced from ~100 lines to ~15 lines delegating to dependencies.py
- **AC-33.11.3**: Zero stale references (grep verified)

Test results: 39 batch/parallel integration tests + 86 unit tests all pass. App startup verified.

## File List

| File | Action | Description |
|------|--------|-------------|
| `backend/app/services/result_merger.py` | **DELETED** | 809 lines of 100% dead code |
| `backend/app/models/merge_strategy_models.py` | **DELETED** | Only imported by result_merger.py |
| `backend/tests/integration/test_result_merger_integration.py` | **DELETED** | Tests for deleted module |
| `backend/tests/unit/result_merger/` | **DELETED** | 7 files testing deleted module |
| `backend/tests/integration/test_batch_processing.py` | **MODIFIED** | Removed ResultMerger imports and TestResultMergerIntegration class |
| `backend/tests/factories.py` | **MODIFIED** | Removed AgentResult import and make_agent_result() |
| `backend/app/dependencies.py` | **MODIFIED** | Added `build_batch_processing_deps()` |
| `backend/app/api/v1/endpoints/intelligent_parallel.py` | **MODIFIED** | Refactored `_ensure_async_deps()` to delegate to dependencies.py |

## Change Log

| Date | Change |
|------|--------|
| 2026-02-10 | Story created from EPIC-33 adversarial audit findings |
| 2026-02-10 | AC-33.11.1 complete: Dead code deleted (~1200 lines total) |
| 2026-02-10 | AC-33.11.2 complete: DI consolidated to single source of truth |
| 2026-02-10 | AC-33.11.3 complete: Zero stale references verified |
| 2026-02-10 | Story marked as done — 125+ tests pass, zero regressions |
