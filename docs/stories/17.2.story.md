# Story 17.2: 深度监控 - Agent和记忆系统性能追踪

## Status
✅ Completed (QA-PASS 8/8 AC, 2025-12-03)

**Implementation Evidence**:
- `backend/app/middleware/agent_metrics.py` - Agent执行追踪
- `backend/app/middleware/memory_metrics.py` - 记忆系统监控
- `backend/app/services/resource_monitor.py` - 资源使用监控
- `backend/tests/test_agent_metrics.py`, `test_memory_metrics.py`, `test_resource_monitor.py` - 60 unit tests (100% pass)
- All 8 AC verified with code evidence

## Story

**As a** Canvas Learning System运维工程师和开发者,
**I want** 对Agent执行时间、记忆系统查询延迟和系统资源使用进行深度监控,
**so that** 我可以识别性能瓶颈、优化系统运行效率、并在问题发生前主动干预。

## Acceptance Criteria

1. Agent执行追踪：所有14种Agent调用都记录执行时间，数据可在Prometheus格式指标中查询
2. 按Agent类型统计：可按agent_type分组查看平均执行时间、调用次数、错误率
3. 记忆系统监控：Graphiti、Temporal、Semantic三层记忆查询延迟独立追踪
4. 资源使用监控：CPU、内存、磁盘使用率实时采集，采集频率≤5秒
5. 性能指标集成：所有新增指标可通过`/metrics`端点以Prometheus格式导出
6. MetricsSummary扩展：`/metrics/summary`返回agents和memory_system详细统计
7. 错误追踪集成：Agent错误按类型计数，与ADR-009错误体系一致
8. 所有代码包含文档来源标注(Context7/Skill/ADR验证)

## Tasks / Subtasks

- [ ] Task 1: Agent执行追踪装饰器实现 (AC: 1, 2)
  - [ ] 创建 `backend/app/middleware/agent_metrics.py`
  - [ ] 实现 `track_agent_execution(agent_type: str)` 装饰器
  - [ ] 定义 `AGENT_EXECUTION_TIME` Histogram指标 (buckets: 0.1, 0.5, 1.0, 2.0, 5.0, 10.0, 30.0)
  - [ ] 定义 `AGENT_ERRORS` Counter指标 (labels: agent_type, error_type)
  - [ ] 定义 `AGENT_INVOCATIONS` Counter指标 (labels: agent_type, status)

- [ ] Task 2: 记忆系统监控实现 (AC: 3)
  - [ ] 创建 `backend/app/middleware/memory_metrics.py`
  - [ ] 定义 `MEMORY_QUERY_LATENCY` Histogram指标 (labels: memory_type, operation)
  - [ ] 实现 `track_memory_query(memory_type: str, operation: str)` 上下文管理器
  - [ ] 集成到Graphiti客户端 (search, add_episode)
  - [ ] 集成到LanceDB客户端 (vector_search)
  - [ ] 集成到Temporal客户端 (get_episode_range)

- [ ] Task 3: 资源使用监控实现 (AC: 4)
  - [ ] 创建 `backend/app/services/resource_monitor.py`
  - [ ] 定义 `RESOURCE_CPU_USAGE` Gauge指标
  - [ ] 定义 `RESOURCE_MEMORY_USAGE` Gauge指标
  - [ ] 定义 `RESOURCE_DISK_USAGE` Gauge指标
  - [ ] 实现 `ResourceMonitor` 类 (asyncio后台任务，每5秒采集)
  - [ ] 集成psutil获取系统指标

- [ ] Task 4: MetricsSummary扩展 (AC: 5, 6)
  - [ ] 扩展 `backend/app/services/metrics_collector.py`
  - [ ] 实现 `get_agent_metrics_summary()` 方法
  - [ ] 实现 `get_memory_metrics_summary()` 方法
  - [ ] 实现 `get_resource_metrics_summary()` 方法
  - [ ] 更新 `/metrics/summary` 端点返回完整MetricsSummary

- [ ] Task 5: 错误追踪集成 (AC: 7)
  - [ ] 集成ADR-009 ErrorCode体系
  - [ ] 在Agent执行失败时记录错误类型
  - [ ] 在记忆系统查询失败时记录错误类型
  - [ ] 确保错误指标与structlog日志一致 (ADR-010)

- [ ] Task 6: 测试和验证 (AC: 8)
  - [ ] 创建 `tests/unit/test_agent_metrics.py`
  - [ ] 创建 `tests/unit/test_memory_metrics.py`
  - [ ] 创建 `tests/unit/test_resource_monitor.py`
  - [ ] 创建 `tests/integration/test_deep_monitoring.py`
  - [ ] 验证Prometheus格式输出正确
  - [ ] 确认所有代码有文档来源标注

## Dev Notes

### 技术验证报告 (Step 3.6)

**验证完成时间**: 2025-12-03
**验证执行人**: SM Agent (Bob)
**Quality Gate状态**: Pending

#### 技术栈清单

| 技术栈 | 查询方式 | 验证状态 | 文档位置 |
|--------|---------|---------|----------|
| prometheus_client | Context7 | 待验证 | /prometheus/client_python |
| psutil | Context7 | 待验证 | /giampaolo/psutil |
| structlog | Local ADR | 已验证 | ADR-010-LOGGING-AGGREGATION-STRUCTLOG.md |
| tenacity | Local ADR | 已验证 | ADR-009-ERROR-HANDLING-RETRY-STRATEGY.md |
| asyncio | Context7 | 待验证 | /python/cpython (asyncio) |
| FastAPI Middleware | Context7 | 待验证 | /fastapi/fastapi |

#### 核心API验证待办

**开发前必须验证**:
- [ ] prometheus_client Counter, Histogram, Gauge → Context7: /prometheus/client_python
- [ ] prometheus_client labels() 和 observe() API → Context7: /prometheus/client_python
- [ ] psutil.cpu_percent(), psutil.virtual_memory(), psutil.disk_usage() → Context7: /giampaolo/psutil
- [ ] asyncio.create_task() for background monitoring → Context7: /python/cpython
- [ ] functools.wraps for decorator implementation → Context7: /python/cpython
- [ ] structlog get_logger() and bind() → ADR-010:77-100

### SDD规范参考 (必填)

**API端点规范** (Epic 17 Monitoring):
- `GET /metrics` - 获取Prometheus格式指标
  - [Source: specs/api/canvas-api.openapi.yml:605-628]
  - 响应格式: `text/plain` (Prometheus格式)
  - 本Story需新增指标:
    - `canvas_agent_execution_seconds` (Histogram)
    - `canvas_agent_errors_total` (Counter)
    - `canvas_agent_invocations_total` (Counter)
    - `canvas_memory_query_seconds` (Histogram)
    - `canvas_resource_cpu_usage` (Gauge)
    - `canvas_resource_memory_usage` (Gauge)
    - `canvas_resource_disk_usage` (Gauge)

- `GET /metrics/summary` - 获取JSON格式指标摘要
  - [Source: specs/api/canvas-api.openapi.yml:630-642]
  - 响应Schema: `MetricsSummary`

**MetricsSummary Schema** (本Story实现重点):
- [Source: specs/api/canvas-api.openapi.yml:987-1060]
- 字段 (本Story实现):
  - `agents.invocations_total`: Agent总调用数 (integer)
  - `agents.avg_execution_time_s`: 平均执行时间秒 (number)
  - `agents.by_type`: 按类型统计 (object, key=agent_type)
    - `count`: 调用次数
    - `avg_time_s`: 平均时间
  - `memory_system.graphiti`: Graphiti统计
    - `queries_total`, `avg_latency_ms`
  - `memory_system.temporal`: Temporal统计
    - `events_total`, `avg_latency_ms`
  - `memory_system.semantic`: Semantic统计
    - `searches_total`, `avg_latency_ms`
  - `resources.cpu_usage_percent`: CPU使用率
  - `resources.memory_usage_percent`: 内存使用率
  - `resources.disk_usage_percent`: 磁盘使用率

### ADR决策关联 (必填)

| ADR编号 | 决策标题 | 对Story的影响 |
|---------|----------|---------------|
| ADR-0004 | Async Execution Engine | Agent追踪装饰器需兼容异步执行引擎 |
| ADR-0009 | Error Handling & Retry | 错误追踪使用ErrorCode体系 (1xxx-5xxx) |
| ADR-0010 | Logging Aggregation | 监控指标与structlog日志协同记录 |

**关键约束**:
- 错误码必须遵循ADR-009定义: Agent相关5xxx, 数据库2xxx, 网络4xxx
- 日志格式必须遵循ADR-010: structlog JSON + 文本双格式
- Agent追踪装饰器必须支持async函数

### 架构设计参考

**架构文档引用**:
- 监控架构图: [Source: docs/architecture/performance-monitoring-architecture.md:87-124]
- Agent性能追踪: [Source: docs/architecture/performance-monitoring-architecture.md:200-238]
- 记忆系统性能监控: [Source: docs/architecture/performance-monitoring-architecture.md:240-266]
- 资源监控数据结构: [Source: docs/architecture/performance-monitoring-architecture.md:62-73]
- 实施计划Phase 2: [Source: docs/architecture/performance-monitoring-architecture.md:496-500]

**性能目标** (Source: docs/architecture/performance-monitoring-architecture.md:49-58):
| 指标 | 目标值 | 告警阈值 |
|------|--------|---------|
| Agent执行时间 | <5s | >10s |
| Graphiti查询 | <200ms | >500ms |
| LanceDB语义搜索 | <100ms | >300ms |
| Temporal查询 | <200ms | >500ms |

**14种Agent类型** (需追踪):
- basic-decomposition
- clarification-path
- comparison-table
- deep-decomposition
- example-teaching
- four-level-explanation
- graphiti-memory-agent
- memory-anchor
- oral-explanation
- question-decomposition
- scoring-agent
- verification-question-agent
- canvas-orchestrator (系统级)
- general-purpose (系统级)

### 代码示例库

**Agent执行追踪装饰器** (Source: docs/architecture/performance-monitoring-architecture.md:200-238):
```python
# backend/app/middleware/agent_metrics.py
# ✅ Verified from Architecture Doc (performance-monitoring-architecture.md:200-238)
import time
import functools
from prometheus_client import Counter, Histogram

AGENT_EXECUTION_TIME = Histogram(
    'canvas_agent_execution_seconds',
    'Agent execution time',
    ['agent_type'],
    buckets=[0.1, 0.5, 1.0, 2.0, 5.0, 10.0, 30.0]
)

AGENT_ERRORS = Counter(
    'canvas_agent_errors_total',
    'Agent execution errors',
    ['agent_type', 'error_type']
)

AGENT_INVOCATIONS = Counter(
    'canvas_agent_invocations_total',
    'Agent invocation count',
    ['agent_type', 'status']
)

def track_agent_execution(agent_type: str):
    """Agent执行追踪装饰器

    Args:
        agent_type: Agent类型名称 (e.g., "scoring-agent")

    Usage:
        @track_agent_execution("scoring-agent")
        async def score_nodes(nodes: List[Node]):
            ...
    """
    def decorator(func):
        @functools.wraps(func)
        async def wrapper(*args, **kwargs):
            start = time.perf_counter()
            try:
                result = await func(*args, **kwargs)
                AGENT_INVOCATIONS.labels(
                    agent_type=agent_type,
                    status='success'
                ).inc()
                return result
            except Exception as e:
                AGENT_ERRORS.labels(
                    agent_type=agent_type,
                    error_type=type(e).__name__
                ).inc()
                AGENT_INVOCATIONS.labels(
                    agent_type=agent_type,
                    status='error'
                ).inc()
                raise
            finally:
                duration = time.perf_counter() - start
                AGENT_EXECUTION_TIME.labels(
                    agent_type=agent_type
                ).observe(duration)
        return wrapper
    return decorator
```

**记忆系统监控上下文管理器** (Source: docs/architecture/performance-monitoring-architecture.md:240-266):
```python
# backend/app/middleware/memory_metrics.py
# ✅ Verified from Architecture Doc (performance-monitoring-architecture.md:240-266)
import time
from contextlib import contextmanager
from prometheus_client import Histogram, Counter

MEMORY_QUERY_LATENCY = Histogram(
    'canvas_memory_query_seconds',
    'Memory system query latency',
    ['memory_type', 'operation'],
    buckets=[0.01, 0.05, 0.1, 0.2, 0.5, 1.0]
)

MEMORY_ERRORS = Counter(
    'canvas_memory_errors_total',
    'Memory system errors',
    ['memory_type', 'operation', 'error_type']
)

@contextmanager
def track_memory_query(memory_type: str, operation: str):
    """记忆系统查询追踪上下文管理器

    Args:
        memory_type: 记忆类型 ('graphiti', 'temporal', 'semantic')
        operation: 操作类型 ('search', 'add', 'get')

    Usage:
        with track_memory_query('graphiti', 'search'):
            result = await graphiti_client.search(query)
    """
    start = time.perf_counter()
    try:
        yield
    except Exception as e:
        MEMORY_ERRORS.labels(
            memory_type=memory_type,
            operation=operation,
            error_type=type(e).__name__
        ).inc()
        raise
    finally:
        duration = time.perf_counter() - start
        MEMORY_QUERY_LATENCY.labels(
            memory_type=memory_type,
            operation=operation
        ).observe(duration)
```

**资源监控服务** (Source: docs/architecture/performance-monitoring-architecture.md:62-73):
```python
# backend/app/services/resource_monitor.py
# ✅ Verified from Architecture Doc (performance-monitoring-architecture.md:62-73)
# ⚠️ psutil API需Context7验证: /giampaolo/psutil
import asyncio
import psutil
from prometheus_client import Gauge
import structlog

logger = structlog.get_logger(__name__)

RESOURCE_CPU = Gauge('canvas_resource_cpu_usage', 'CPU usage percent')
RESOURCE_MEMORY = Gauge('canvas_resource_memory_usage', 'Memory usage percent')
RESOURCE_DISK = Gauge('canvas_resource_disk_usage', 'Disk usage percent')

class ResourceMonitor:
    """系统资源监控服务

    每5秒采集CPU、内存、磁盘使用率
    """

    def __init__(self, interval: float = 5.0):
        self.interval = interval
        self._running = False
        self._task = None

    async def start(self):
        """启动后台监控任务"""
        self._running = True
        self._task = asyncio.create_task(self._monitor_loop())
        logger.info("resource_monitor.started", interval=self.interval)

    async def stop(self):
        """停止后台监控任务"""
        self._running = False
        if self._task:
            self._task.cancel()
            try:
                await self._task
            except asyncio.CancelledError:
                pass
        logger.info("resource_monitor.stopped")

    async def _monitor_loop(self):
        """监控循环"""
        while self._running:
            try:
                # CPU使用率 (非阻塞)
                cpu_percent = psutil.cpu_percent(interval=None)
                RESOURCE_CPU.set(cpu_percent)

                # 内存使用率
                memory = psutil.virtual_memory()
                RESOURCE_MEMORY.set(memory.percent)

                # 磁盘使用率 (根目录)
                disk = psutil.disk_usage('/')
                RESOURCE_DISK.set(disk.percent)

                logger.debug(
                    "resource_monitor.collected",
                    cpu=cpu_percent,
                    memory=memory.percent,
                    disk=disk.percent
                )
            except Exception as e:
                logger.error("resource_monitor.error", error=str(e))

            await asyncio.sleep(self.interval)

    def get_current(self) -> dict:
        """获取当前资源指标"""
        return {
            "cpu_usage_percent": psutil.cpu_percent(interval=None),
            "memory_usage_percent": psutil.virtual_memory().percent,
            "disk_usage_percent": psutil.disk_usage('/').percent
        }
```

**MetricsSummary扩展** (Source: specs/api/canvas-api.openapi.yml:1012-1060):
```python
# backend/app/services/metrics_collector.py (扩展)
# ✅ Verified from OpenAPI Spec (canvas-api.openapi.yml:987-1060)
from prometheus_client import REGISTRY
from typing import Dict, Any

def get_agent_metrics_summary() -> Dict[str, Any]:
    """获取Agent指标摘要"""
    # 从Prometheus REGISTRY读取指标
    invocations_total = 0
    by_type = {}

    # 遍历Agent调用计数器
    for metric in REGISTRY.collect():
        if metric.name == 'canvas_agent_invocations_total':
            for sample in metric.samples:
                if sample.name.endswith('_total'):
                    agent_type = sample.labels.get('agent_type', 'unknown')
                    count = int(sample.value)
                    invocations_total += count
                    if agent_type not in by_type:
                        by_type[agent_type] = {"count": 0, "avg_time_s": 0}
                    by_type[agent_type]["count"] = count

    # TODO: 计算平均执行时间从Histogram

    return {
        "invocations_total": invocations_total,
        "avg_execution_time_s": 0,  # 从Histogram计算
        "by_type": by_type
    }

def get_memory_metrics_summary() -> Dict[str, Any]:
    """获取记忆系统指标摘要"""
    return {
        "graphiti": {
            "queries_total": 0,  # 从Counter读取
            "avg_latency_ms": 0  # 从Histogram计算
        },
        "temporal": {
            "events_total": 0,
            "avg_latency_ms": 0
        },
        "semantic": {
            "searches_total": 0,
            "avg_latency_ms": 0
        }
    }
```

### 文件路径参考

**现有监控代码** (Story 17.1产出):
- 监控中间件: `backend/app/middleware/metrics.py`
- 指标端点: `backend/app/api/v1/endpoints/health.py`

**需要新增的文件**:
- 新增: `backend/app/middleware/agent_metrics.py`
- 新增: `backend/app/middleware/memory_metrics.py`
- 新增: `backend/app/services/resource_monitor.py`
- 修改: `backend/app/services/metrics_collector.py` (扩展summary)
- 修改: `backend/app/main.py` (启动ResourceMonitor)
- 新增: `tests/unit/test_agent_metrics.py`
- 新增: `tests/unit/test_memory_metrics.py`
- 新增: `tests/unit/test_resource_monitor.py`
- 新增: `tests/integration/test_deep_monitoring.py`

**现有Agent代码** (需要集成追踪):
- Agent调用入口: `backend/app/services/agent_service.py`
- 各Agent实现: `src/agents/` 目录

**现有记忆系统代码** (需要集成追踪):
- Graphiti客户端: `src/memory/graphiti_client.py`
- LanceDB客户端: `src/memory/lancedb_client.py`
- Temporal客户端: `src/memory/temporal_client.py`

### 依赖关系

**前置Story**:
- Story 17.1: 基础监控 (提供metrics_middleware, Prometheus指标端点)

**后续影响**:
- Story 17.3: 告警和Dashboard (依赖本Story的Agent/Memory指标进行告警规则)
- Story 17.4: 性能优化策略实施 (依赖本Story的指标识别性能瓶颈)
- Story 17.5: E2E测试 (依赖本Story的完整指标进行验证)

### Definition of Done

- [ ] 所有AC通过验收测试
- [ ] `track_agent_execution` 装饰器应用到所有14种Agent
- [ ] `track_memory_query` 应用到Graphiti/LanceDB/Temporal客户端
- [ ] `ResourceMonitor` 后台任务稳定运行
- [ ] `/metrics` 端点返回所有新增指标
- [ ] `/metrics/summary` 返回完整的agents和memory_system字段
- [ ] 单元测试覆盖率≥90%
- [ ] 集成测试通过
- [ ] 代码Review通过
- [ ] 文档更新完成

### 风险和缓解

| 风险 | 概率 | 影响 | 缓解措施 |
|------|------|------|---------|
| 指标采集影响性能 | 中 | 中 | 使用高效的time.perf_counter()，避免阻塞 |
| Prometheus指标过多 | 低 | 低 | 限制label基数，避免高基数指标 |
| 资源监控不准确 | 低 | 低 | 使用psutil官方API，测试验证 |
| 装饰器与async不兼容 | 中 | 高 | 使用functools.wraps，测试async函数 |
| 记忆系统集成困难 | 中 | 中 | 使用上下文管理器，最小化侵入性 |

### 估算

- **Story Points**: 5
- **预估工时**: 2-3天
- **复杂度**: 中 (主要是指标定义和集成)

---

**文档版本**: v1.0.0
**创建时间**: 2025-12-03
**创建者**: SM Agent (Bob)
**Epic**: Epic 17 - 性能优化和监控
