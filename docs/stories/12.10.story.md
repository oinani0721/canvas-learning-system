# Story 12.10: Canvas检验白板生成集成

## Status: Approved

## Epic Context & Background

**所属Epic**: EPIC-12 - 三层记忆系统 + Agentic RAG
**Epic文档**: [EPIC-12-STORY-MAP.md](../epics/EPIC-12-STORY-MAP.md)

**本Story在Epic中的定位**:
- Phase 3 (集成测试层) 的首个Story
- 将完整的Agentic RAG集成到Canvas检验白板生成流程
- **依赖**: Story 12.9 (质量控制完成，Agentic RAG完整)
- **被依赖**: Story 12.15 (E2E集成测试依赖此功能)

**Epic核心问题回顾**:

### Problem 13: 检验白板生成准确率不足
- **现象**: 当前检验白板生成的检验题相关性约70%
- **根因**: 单一检索逻辑，未充分利用历史薄弱点数据
- **修复**: 集成Agentic RAG，使用Weighted融合 + Cohere Rerank
- **本Story验证**: 验证准确率提升至85%

### Problem 14: 集成风险 - Epic 4功能退化
- **现象**: 新系统可能破坏现有Epic 4检验白板功能
- **根因**: 直接修改核心代码
- **修复**: Adapter模式，不修改Epic 4核心代码
- **本Story验证**: 验证Epic 4的12个测试全部通过

---

## Story

**As a** Canvas学习系统用户,
**I want** 使用新Agentic RAG生成检验白板,
**so that** 检验题更精准地针对我的薄弱点，准确率提升至85%

---

## Acceptance Criteria

### AC 1: generate_verification_canvas()集成Agentic RAG (验证Problem 13基础)
- **集成方式**: 替换现有单一检索逻辑
- **调用**: `canvas_agentic_rag.ainvoke(...)`
- **配置**:
  - `fusion_strategy="weighted"` (薄弱点权重70%)
  - `reranking_strategy="cohere"` (检验白板用Cohere)
  - `is_review_canvas=True` (触发高精度配置)
- **验证方式**: 单元测试验证Agentic RAG被正确调用
- **Epic关联**: 核心集成点

### AC 2: 检验白板生成准确率 ≥ 85% (验证Problem 13核心)
- **测试集**: 10个Canvas, 100个检验题
- **人工评估**: 相关性 (相关/不相关)
- **验证标准**: 相关题数 ≥ 85
- **对比基准**: 当前系统约70%准确率
- **Epic关联**: 核心质量指标

### AC 3: 向后兼容Epic 4 (验证Problem 14)
- **Epic 4现有功能**:
  - 提取红色/紫色节点
  - 生成检验题
  - 创建Canvas
- **验证方式**: 集成后无breaking changes
- **测试**: Epic 4的12个测试全部通过
- **Epic关联**: 确保向后兼容

### AC 4: 性能不退化 (验证Problem 13效率)
- **检验白板生成总时间**: < 5秒 (vs 当前~8秒, 提升37%)
- **检索延迟**: < 400ms (Agentic RAG部分)
- **LLM生成时间**: ~3秒 (不变)
- **验证方式**: 性能基准测试
- **Epic关联**: 确保用户体验不降级

### AC 5: 错误处理和降级 (验证Problem 14安全)
- **Agentic RAG失败**: 降级到单一检索 (LanceDB only)
- **日志**: 记录降级事件, 告警
- **验证方式**: 模拟Agentic RAG异常，验证降级后仍能生成检验白板
- **质量说明**: 降级后质量可能降低，但功能可用
- **Epic关联**: 确保系统健壮性

---

## Tasks / Subtasks

### 任务1: 创建AgenticRAGAdapter适配层 (AC: 1, 3)
- [ ] 1.1: 创建 `src/canvas/adapters/agentic_rag_adapter.py`
  ```python
  # ✅ Verified from EPIC-12-STORY-MAP.md (Story 12.10 Technical Details)
  from typing import List, Dict, Optional
  from agentic_rag.graph import canvas_agentic_rag
  from agentic_rag.config import CanvasRAGConfig
  import logging

  logger = logging.getLogger(__name__)

  class AgenticRAGAdapter:
      """Agentic RAG适配器 - 封装检索调用，支持降级"""

      def __init__(self, config: Optional[CanvasRAGConfig] = None):
          self.config = config or CanvasRAGConfig(
              fusion_strategy="weighted",
              reranking_strategy="cohere",
              retrieval_batch_size=10
          )

      async def retrieve_for_verification(
          self,
          canvas_file: str,
          red_purple_nodes: List[Dict]
      ) -> List[Dict]:
          """
          为检验白板生成检索薄弱点

          Args:
              canvas_file: Canvas文件路径
              red_purple_nodes: 红色和紫色节点列表

          Returns:
              List[Dict]: Reranked检索结果
          """
          try:
              # 构建查询
              concepts = [node.get("concept", "") for node in red_purple_nodes]
              query = f"检索Canvas薄弱点和相关概念: {', '.join(concepts)}"

              # 调用Agentic RAG
              result = await canvas_agentic_rag.ainvoke(
                  {
                      "messages": [{"role": "user", "content": query}],
                      "canvas_file": canvas_file,
                      "is_review_canvas": True  # 触发Cohere Rerank
                  },
                  config={"context": self.config}
              )

              return result.get("reranked_results", [])

          except Exception as e:
              logger.warning(f"Agentic RAG失败，降级到LanceDB: {e}")
              return await self._fallback_lancedb_search(canvas_file, concepts)

      async def _fallback_lancedb_search(
          self,
          canvas_file: str,
          concepts: List[str]
      ) -> List[Dict]:
          """降级：仅使用LanceDB检索"""
          from memory.semantic.lancedb_client import LanceDBClient

          client = LanceDBClient()
          results = []

          for concept in concepts[:10]:  # 限制查询数量
              search_results = client.search(concept, limit=5)
              results.extend(search_results)

          return results[:20]  # 返回Top-20
  ```
- [ ] 1.2: 测试: 验证正常路径和降级路径

### 任务2: 修改CanvasOrchestrator集成Agentic RAG (AC: 1, 3)
- [ ] 2.1: 修改 `src/canvas_utils.py` - CanvasOrchestrator类
  ```python
  # ✅ Verified from EPIC-12-STORY-MAP.md (Story 12.10 Technical Details)
  from canvas.adapters.agentic_rag_adapter import AgenticRAGAdapter

  class CanvasOrchestrator:
      def __init__(self, canvas_path: str):
          self.canvas_path = canvas_path
          self.operator = CanvasOperator()
          self.business_logic = CanvasBusinessLogic(canvas_path)
          # 新增: Agentic RAG适配器
          self.rag_adapter = AgenticRAGAdapter()

      async def generate_verification_canvas(
          self,
          output_canvas_file: str
      ) -> str:
          """生成检验白板 (增强版, 使用Agentic RAG)"""

          # 1. 提取红色/紫色节点 (Epic 4逻辑不变)
          extracted_nodes = self.business_logic.extract_verification_nodes()
          red_purple_nodes = (
              extracted_nodes.get("red_nodes", []) +
              extracted_nodes.get("purple_nodes", [])
          )

          # 2. 使用Agentic RAG检索薄弱点 (新增)
          reranked_results = await self.rag_adapter.retrieve_for_verification(
              self.canvas_path,
              red_purple_nodes
          )

          # 3. 生成检验题 (Epic 4逻辑增强)
          verification_questions = self.generate_verification_questions_with_agent(
              red_purple_nodes,
              reranked_results  # 传入Agentic RAG结果
          )

          # 4. 创建检验白板Canvas (Epic 4逻辑不变)
          self.create_verification_canvas(
              verification_questions,
              output_canvas_file
          )

          return output_canvas_file
  ```
- [ ] 2.2: 保持Epic 4原有方法签名不变
- [ ] 2.3: 测试: 验证集成后功能正常

### 任务3: 增强generate_verification_questions_with_agent (AC: 1, 2)
- [ ] 3.1: 修改问题生成方法接收Agentic RAG结果
  ```python
  def generate_verification_questions_with_agent(
      self,
      red_purple_nodes: List[Dict],
      agentic_rag_results: List[Dict] = None  # 新增参数
  ) -> List[Dict]:
      """
      生成检验问题 (增强版)

      Args:
          red_purple_nodes: 红色和紫色节点
          agentic_rag_results: Agentic RAG检索结果 (可选)

      Returns:
          List[Dict]: 检验问题列表
      """
      # 构建增强的上下文
      context = self._build_question_context(
          red_purple_nodes,
          agentic_rag_results
      )

      # 调用verification-question-agent
      questions = self._call_verification_question_agent(context)

      return questions

  def _build_question_context(
      self,
      nodes: List[Dict],
      rag_results: List[Dict] = None
  ) -> Dict:
      """构建问题生成上下文"""
      context = {
          "nodes": nodes,
          "node_count": len(nodes),
          "weak_points": [],
          "historical_errors": []
      }

      if rag_results:
          # 提取薄弱点信息
          context["weak_points"] = [
              r.get("concept", "") for r in rag_results
              if r.get("source") == "temporal"
          ]
          # 提取历史错误
          context["historical_errors"] = [
              r for r in rag_results
              if r.get("metadata", {}).get("error_count", 0) > 0
          ]

      return context
  ```
- [ ] 3.2: 测试: 验证问题生成质量提升

### 任务4: 实现错误处理和降级逻辑 (AC: 5)
- [ ] 4.1: 添加降级监控指标
  ```python
  from prometheus_client import Counter

  agentic_rag_fallback_counter = Counter(
      'canvas_agentic_rag_fallback_total',
      'Total Agentic RAG fallback events',
      ['reason']
  )

  # 在AgenticRAGAdapter中使用
  async def retrieve_for_verification(...):
      try:
          # ... 正常逻辑
      except ConnectionError as e:
          agentic_rag_fallback_counter.labels(reason='connection').inc()
          logger.warning(f"Agentic RAG连接失败: {e}")
          return await self._fallback_lancedb_search(...)
      except TimeoutError as e:
          agentic_rag_fallback_counter.labels(reason='timeout').inc()
          logger.warning(f"Agentic RAG超时: {e}")
          return await self._fallback_lancedb_search(...)
  ```
- [ ] 4.2: 测试: 模拟各种异常，验证降级正确

### 任务5: 性能优化 (AC: 4)
- [ ] 5.1: 添加检索并行化
  ```python
  import asyncio

  async def generate_verification_canvas(self, output_canvas_file: str) -> str:
      # 并行执行: 节点提取 + Agentic RAG预热
      extract_task = asyncio.create_task(
          asyncio.to_thread(self.business_logic.extract_verification_nodes)
      )
      preheat_task = asyncio.create_task(
          self.rag_adapter.preheat()  # 预热连接
      )

      # 等待节点提取完成
      extracted_nodes = await extract_task
      await preheat_task  # 确保预热完成

      # ... 后续逻辑
  ```
- [ ] 5.2: 性能测试: 验证总时间 < 5秒

### 任务6: 准确率验证测试 (AC: 2)
- [ ] 6.1: 创建 `src/tests/integration/test_verification_accuracy.py`
  ```python
  import pytest
  from canvas_utils import CanvasOrchestrator

  @pytest.mark.asyncio
  async def test_verification_accuracy():
      """验证检验白板生成准确率 >= 85%"""
      test_canvases = [
          "tests/fixtures/离散数学-test.canvas",
          "tests/fixtures/线性代数-test.canvas",
          # ... 10个测试Canvas
      ]

      total_questions = 0
      relevant_questions = 0

      for canvas_path in test_canvases:
          orchestrator = CanvasOrchestrator(canvas_path)
          output_path = canvas_path.replace(".canvas", "-检验白板.canvas")

          await orchestrator.generate_verification_canvas(output_path)

          # 人工标注的相关性判断 (预先准备)
          relevance_labels = load_relevance_labels(output_path)

          for question_id, is_relevant in relevance_labels.items():
              total_questions += 1
              if is_relevant:
                  relevant_questions += 1

      accuracy = relevant_questions / total_questions
      assert accuracy >= 0.85, f"准确率应>=85%，实际: {accuracy:.1%}"
  ```
- [ ] 6.2: 准备10个测试Canvas和人工标注数据

### 任务7: 回归测试 - Epic 4兼容性 (AC: 3)
- [ ] 7.1: 创建 `src/tests/regression/test_epic4_compatibility.py`
  ```python
  import pytest
  from canvas_utils import CanvasOrchestrator, CanvasBusinessLogic

  class TestEpic4Compatibility:
      """验证Epic 4功能无退化"""

      def test_extract_verification_nodes_unchanged(self):
          """Story 4.1: 节点提取逻辑不变"""
          logic = CanvasBusinessLogic("tests/fixtures/test.canvas")
          nodes = logic.extract_verification_nodes()

          assert "red_nodes" in nodes
          assert "purple_nodes" in nodes
          assert "stats" in nodes

      def test_generate_verification_questions_backward_compatible(self):
          """Story 4.2: 问题生成向后兼容"""
          orchestrator = CanvasOrchestrator("tests/fixtures/test.canvas")

          # 不传入agentic_rag_results应该仍然工作
          questions = orchestrator.generate_verification_questions_with_agent(
              red_purple_nodes=[{"id": "test", "concept": "测试"}],
              agentic_rag_results=None  # 显式传None
          )

          assert isinstance(questions, list)

      def test_create_verification_canvas_unchanged(self):
          """Story 4.3: Canvas创建逻辑不变"""
          # ... 验证Canvas结构
          pass
  ```
- [ ] 7.2: 运行Epic 4的12个测试，确保全部通过

### 任务8: 创建完整测试套件 (AC: 1-5)
- [ ] 8.1: 创建 `src/tests/integration/test_canvas_agentic_rag_integration.py`
- [ ] 8.2: 测试正常路径
- [ ] 8.3: 测试降级路径
- [ ] 8.4: 测试性能指标
- [ ] 8.5: 测试准确率指标

---

## Dev Notes

### Dependencies Verification

**前置依赖验证** (必须先完成):
- [ ] **Story 12.9已完成**: Agentic RAG质量控制循环可用
- [ ] canvas_agentic_rag StateGraph可invoke
- [ ] CanvasOrchestrator类存在 (src/canvas_utils.py:12800)
- [ ] Epic 4测试套件可运行

**技术栈依赖**:
- [ ] langgraph >= 0.2.55
- [ ] pytest-asyncio (异步测试)
- [ ] prometheus_client (监控指标)
- [ ] 现有canvas_utils.py模块

### SDD规范参考

**Adapter模式** [Source: EPIC-12-STORY-MAP.md Story 12.10]:

```python
# ✅ Verified from Epic 12 - Adapter模式隔离变更
class AgenticRAGAdapter:
    """
    适配器模式: 隔离Agentic RAG与现有代码
    - 不修改Epic 4核心逻辑
    - 支持降级到旧逻辑
    - 便于单元测试
    """
    pass
```

**降级策略** [Source: LANGGRAPH-MEMORY-INTEGRATION-DESIGN.md]:

```python
# ✅ Verified from Architecture doc - 降级策略
try:
    result = await canvas_agentic_rag.ainvoke(...)
except Exception as e:
    logger.warning(f"Agentic RAG失败, 降级到LanceDB: {e}")
    result = await self._fallback_lancedb_search(...)
```

### ADR决策关联

**Epic 4 检验白板系统** [Source: docs/stories/story-4.*.md]:
- **Story 4.1**: extract_verification_nodes() - 节点提取
- **Story 4.2**: generate_verification_questions() - 问题生成
- **Story 4.3**: create_verification_canvas() - Canvas创建
- **本Story关系**: 增强Story 4.2，不修改4.1和4.3

**ADR-002: LangGraph Multi-Agent System** [Source: docs/architecture/decisions/0002-langgraph-agents.md]:
- **决策**: 使用LangGraph作为多Agent编排框架
- **本Story关系**: canvas_agentic_rag是LangGraph图

### Testing Standards

**测试文件位置**:
- `src/tests/integration/` - 集成测试
- `src/tests/regression/` - 回归测试

**测试类型**:
- 单元测试 (AgenticRAGAdapter)
- 集成测试 (完整流程)
- 回归测试 (Epic 4兼容性)
- 性能测试 (延迟基准)
- 准确率测试 (人工标注验证)

**Mock策略**:
- Agentic RAG使用Mock (单元测试)
- 使用真实图执行 (集成测试)
- 准备10个测试Canvas

**覆盖率目标**: ≥80%

### Performance Benchmarks

**延迟预算** (from Epic 12 PRD):

| 操作 | 当前延迟 | 目标延迟 | 提升 |
|------|----------|----------|------|
| 检验白板生成总时间 | ~8秒 | < 5秒 | 37% |
| Agentic RAG检索 | - | < 400ms | - |
| LLM问题生成 | ~3秒 | ~3秒 | - |

**准确率目标**:

| 指标 | 当前 | 目标 |
|------|------|------|
| 检验题相关性 | ~70% | ≥ 85% |
| 薄弱点覆盖率 | ~50% | ≥ 70% |

### Related Documentation

**Epic和Story文档**:
- [EPIC-12-STORY-MAP.md](../epics/EPIC-12-STORY-MAP.md) - Epic 12完整Story Map
- [12.9.story.md](./12.9.story.md) - 质量控制循环 (前置依赖)
- [12.15.story.md](./12.15.story.md) - E2E集成测试 (后续Story)

**Epic 4文档** [Source: docs/stories/]:
- [4.1.story.md](./4.1.story.md) - 节点提取
- [4.2.story.md](./4.2.story.md) - 问题生成
- [4.3.story.md](./4.3.story.md) - Canvas创建

**架构文档** [Source: docs/architecture/]:
- [LANGGRAPH-MEMORY-INTEGRATION-DESIGN.md](../architecture/LANGGRAPH-MEMORY-INTEGRATION-DESIGN.md) - Agentic RAG架构
- [0002-langgraph-agents.md](../architecture/decisions/0002-langgraph-agents.md) - LangGraph ADR

**代码文件** [Source: src/]:
- [canvas_utils.py](../../src/canvas_utils.py) - CanvasOrchestrator类 (line 12800)

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-28 | 1.0 | 初始创建 - SM Agent *draft | Bob (SM Agent) |

---

## Dev Agent Record

### Agent Model Used
*待填写*

### Debug Log References
*待填写*

### Completion Notes List
*待填写*

### File List
*待填写*

---

## QA Results

*待QA Agent审查*
