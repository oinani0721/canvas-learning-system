# Story 24.1: Verification Canvas Generation Engine with Mode Support

## Status
- [x] Draft
- [x] Ready for Dev
- [x] In Progress
- [x] QA Review
- [x] Done

---

## Epic Context & Background

**Epic ID**: EPIC-24
**Epic Title**: Verification Canvas Redesign
**Story Priority**: P0 (Critical)
**Estimated Points**: 5

**Epic Objective**: Redesign the verification canvas (检验白板) generation system to support dual review modes (fresh/targeted), integrate with Graphiti for history tracking, and improve the overall generation workflow.

**This Story's Role**: Story 24.1 is the foundational story that implements the core mode-switching capability in the verification canvas generation engine, enabling both "fresh exam" (全新检验) and "targeted review" (针对性复习) modes.

**Dependencies**:
- Epic 22 (Memory System) - Completed
- Epic 23 (RAG Intelligent Inference) - Completed

---

## Story Overview

**As a** Canvas Learning System user,
**I want** the verification canvas generator to support two distinct modes: "fresh" for blind testing and "targeted" for weakness-focused review,
**So that** I can choose the appropriate review strategy based on my learning needs and the system can leverage my review history for smarter question generation.

---

## Acceptance Criteria

### AC1: Mode Parameter Support in API
- **Given**: The `/review/generate-canvas` endpoint exists
- **When**: A request is made with `mode: "fresh"` or `mode: "targeted"`
- **Then**: The system processes the request using the appropriate generation strategy
- **Verification**: API accepts and validates mode parameter per specs/api/review-api.openapi.yml#L215-249

### AC2: Fresh Mode Generation
- **Given**: Mode is set to "fresh" (全新检验)
- **When**: Verification canvas is generated
- **Then**:
  - No historical review data is queried
  - Questions are generated solely from current canvas concepts
  - All eligible concepts (purple/red nodes) have equal probability of selection
- **Verification**: Generated canvas contains questions without historical weighting

### AC3: Targeted Mode Generation with Graphiti Integration
- **Given**: Mode is set to "targeted" (针对性复习)
- **When**: Verification canvas is generated
- **Then**:
  - System queries Graphiti for historical weak concepts
  - Weight distribution applies: 70% weak concepts + 30% mastered concepts (configurable)
  - Questions prioritize previously failed/difficult concepts
- **Verification**: Query logs show Graphiti retrieval; question distribution matches weight config

### AC4: Default Mode Configuration
- **Given**: User has a global review mode preference setting
- **When**: No mode is explicitly specified in the API request
- **Then**: System uses the user's configured default mode (default: "fresh")
- **Verification**: Correct default mode is applied when mode parameter is omitted

### AC5: Review Mode Metadata Storage
- **Given**: A verification canvas is generated with either mode
- **When**: Generation completes successfully
- **Then**:
  - Mode used is stored in canvas metadata
  - Graphiti stores `(ReviewCanvas)-[:GENERATED_FROM {mode: "fresh"|"targeted"}]->(OriginalCanvas)` relationship
- **Verification**: Canvas JSON contains mode metadata; Neo4j query returns correct relationship

### AC6: Weight Configuration Override
- **Given**: Targeted mode is selected
- **When**: Custom weight parameters are provided (`weak_weight`, `mastered_weight`)
- **Then**: Custom weights are used instead of defaults (70/30)
- **Verification**: Generated questions follow custom weight distribution

---

## Dev Notes (CRITICAL - Self-Contained)

### Technical Context

This story implements mode-switching capability for verification canvas generation. The existing `ReviewService.generate_verification_canvas()` method needs enhancement to support dual modes.

**Current State** (backend/app/services/review_service.py:90-100):
- `ReviewService` exists with basic verification canvas generation
- No mode parameter support currently
- No Graphiti integration for history tracking

**Target State**:
- `generate_verification_canvas(mode: str, weights: Optional[dict])` method
- Graphiti client integration for targeted mode
- Mode metadata stored in canvas and Neo4j

### API Endpoints

**Primary Endpoint**: `POST /review/generate-canvas`
- **File**: `backend/app/api/v1/endpoints/review.py`
- **OpenAPI Spec**: `specs/api/review-api.openapi.yml#L215-249`

**Request Schema Enhancement** (extend specs/data/review-generate-request.schema.json):
```json
{
  "mode": {
    "type": "string",
    "enum": ["fresh", "targeted"],
    "default": "fresh",
    "description": "Review mode: fresh=blind test, targeted=weakness-focused"
  },
  "weak_weight": {
    "type": "number",
    "minimum": 0,
    "maximum": 1,
    "default": 0.7,
    "description": "Weight for weak concepts in targeted mode"
  },
  "mastered_weight": {
    "type": "number",
    "minimum": 0,
    "maximum": 1,
    "default": 0.3,
    "description": "Weight for mastered concepts in targeted mode"
  }
}
```

### Data Models

**Request Schema**: `specs/data/review-generate-request.schema.json`
- Lines 14-32 define existing properties
- Add mode, weak_weight, mastered_weight properties

**Response Schema**: `specs/data/review-generate-response.schema.json`
- Lines 14-41 define response structure
- Add `mode_used` property to response

**Canvas Node Schema**: `specs/data/canvas-node.schema.json`
- Used for node color filtering. Note: JSON Canvas uses numeric color codes (1-6).
- Project semantic mapping: color 4 = 不理解 (semantically red), color 3 = 似懂非懂 (semantically purple)
- include_colors: ["3", "4"] filters nodes that need review (partial/no understanding)

### SDD References

| Type | File | Lines | Description |
|------|------|-------|-------------|
| OpenAPI | specs/api/review-api.openapi.yml | L215-249 | generate-canvas endpoint |
| OpenAPI | specs/api/review-api.openapi.yml | L75-112 | path definitions |
| Schema | specs/data/review-generate-request.schema.json | L14-32 | Request model |
| Schema | specs/data/review-generate-response.schema.json | L14-41 | Response model |
| Schema | specs/data/canvas-node.schema.json | Full | Node structure |

### ADR References

| ADR | Description | Relevance |
|-----|-------------|-----------|
| docs/architecture/decisions/0002-langgraph-agents.md | LangGraph for agents | Question generation agent |
| docs/architecture/decisions/0003-graphiti-memory.md | Graphiti integration | History tracking |

### Implementation Guidelines

**Step 1: Extend Request Model**
```python
# backend/app/models/schemas.py
class GenerateReviewRequest(BaseModel):
    canvas_name: str
    include_colors: List[str] = ["3", "4"]  # purple, red
    question_count: Optional[int] = None
    # NEW: Mode parameters
    mode: Literal["fresh", "targeted"] = "fresh"
    weak_weight: float = Field(default=0.7, ge=0, le=1)
    mastered_weight: float = Field(default=0.3, ge=0, le=1)
```

**Step 2: Update ReviewService**
```python
# backend/app/services/review_service.py
class ReviewService:
    async def generate_verification_canvas(
        self,
        canvas_name: str,
        mode: str = "fresh",
        weak_weight: float = 0.7,
        mastered_weight: float = 0.3,
        include_colors: List[str] = ["3", "4"],
        question_count: Optional[int] = None
    ) -> ReviewProgress:
        """
        Generate verification canvas with mode support.

        Args:
            mode: "fresh" for blind test, "targeted" for weakness-focused
            weak_weight: Weight for weak concepts (targeted mode only)
            mastered_weight: Weight for mastered concepts (targeted mode only)
        """
        if mode == "targeted":
            # Query Graphiti for historical weak concepts
            weak_concepts = await self._query_weak_concepts_from_graphiti(canvas_name)
            # Apply weighted selection
            selected_concepts = self._apply_weighted_selection(
                weak_concepts, weak_weight, mastered_weight
            )
        else:
            # Fresh mode: equal probability selection
            selected_concepts = await self._get_all_eligible_concepts(canvas_name)

        # Generate questions and canvas
        result = await self._generate_canvas_from_concepts(
            canvas_name, selected_concepts, mode
        )

        # Store relationship in Graphiti
        await self._store_review_relationship(canvas_name, result.review_canvas_name, mode)

        return result
```

**Step 3: Add Graphiti Integration**
```python
# backend/app/services/review_service.py
async def _query_weak_concepts_from_graphiti(self, canvas_name: str) -> List[dict]:
    """Query historical weak concepts from Graphiti knowledge graph."""
    # Cypher query for weak concepts
    query = """
    MATCH (c:Canvas {name: $canvas_name})<-[:BELONGS_TO]-(concept:Concept)
    OPTIONAL MATCH (concept)-[r:REVIEWED]->(review:ReviewResult)
    WHERE r.score < 60 OR r.rating IN [1, 2]  # Again or Hard
    RETURN concept.name AS concept_name,
           avg(r.score) AS avg_score,
           count(r) AS review_count
    ORDER BY avg_score ASC, review_count DESC
    """
    # Execute via Graphiti client
    return await self.graphiti_client.execute_query(query, {"canvas_name": canvas_name})

async def _store_review_relationship(
    self,
    original_canvas: str,
    review_canvas: str,
    mode: str
) -> None:
    """Store GENERATED_FROM relationship in Graphiti."""
    # Create relationship with mode metadata
    await self.graphiti_client.create_relationship(
        source_type="ReviewCanvas",
        source_name=review_canvas,
        target_type="Canvas",
        target_name=original_canvas,
        relationship_type="GENERATED_FROM",
        properties={"mode": mode, "generated_at": datetime.utcnow().isoformat()}
    )
```

**Step 4: Update API Endpoint**
```python
# backend/app/api/v1/endpoints/review.py
@router.post("/generate-canvas", response_model=GenerateReviewResponse)
async def generate_review_canvas(request: GenerateReviewRequest):
    """Generate verification canvas with mode support."""
    result = await review_service.generate_verification_canvas(
        canvas_name=request.canvas_name,
        mode=request.mode,
        weak_weight=request.weak_weight,
        mastered_weight=request.mastered_weight,
        include_colors=request.include_colors,
        question_count=request.question_count
    )
    return GenerateReviewResponse(
        review_canvas_name=result.review_canvas_name,
        source_canvas_name=request.canvas_name,
        question_count=result.question_count,
        mode_used=request.mode  # NEW: Include mode in response
    )
```

**Step 5: Update JSON Schema**
Update `specs/data/review-generate-request.schema.json` to include mode properties.

### Key Files to Modify

| File Path | Change Type | Description |
|-----------|-------------|-------------|
| `backend/app/models/schemas.py` | Modify | Add mode parameters to GenerateReviewRequest |
| `backend/app/services/review_service.py` | Modify | Add mode handling and Graphiti integration |
| `backend/app/api/v1/endpoints/review.py` | Modify | Update endpoint to pass mode |
| `specs/data/review-generate-request.schema.json` | Modify | Add mode, weak_weight, mastered_weight |
| `specs/data/review-generate-response.schema.json` | Modify | Add mode_used property |
| `src/tests/test_review_mode_support.py` | Create | Test cases for mode functionality |

### Existing Code References

| Location | Line Range | Purpose |
|----------|------------|---------|
| backend/app/services/review_service.py | 90-100 | ReviewService class definition |
| backend/app/api/v1/endpoints/review.py | 71-100 | Canvas file operations |
| specs/api/review-api.openapi.yml | 215-249 | generate-canvas endpoint spec |

---

## Testing Requirements

### Unit Tests

**Test File**: `src/tests/test_review_mode_support.py`

```python
import pytest
from backend.app.services.review_service import ReviewService

class TestReviewModeSupport:

    @pytest.mark.asyncio
    async def test_fresh_mode_no_graphiti_query(self, review_service, mock_graphiti):
        """AC2: Fresh mode should not query Graphiti history."""
        result = await review_service.generate_verification_canvas(
            canvas_name="test.canvas",
            mode="fresh"
        )
        mock_graphiti.execute_query.assert_not_called()
        assert result.mode_used == "fresh"

    @pytest.mark.asyncio
    async def test_targeted_mode_queries_graphiti(self, review_service, mock_graphiti):
        """AC3: Targeted mode should query Graphiti for weak concepts."""
        mock_graphiti.execute_query.return_value = [
            {"concept_name": "concept1", "avg_score": 45.0},
            {"concept_name": "concept2", "avg_score": 55.0}
        ]
        result = await review_service.generate_verification_canvas(
            canvas_name="test.canvas",
            mode="targeted"
        )
        mock_graphiti.execute_query.assert_called_once()
        assert result.mode_used == "targeted"

    @pytest.mark.asyncio
    async def test_default_mode_is_fresh(self, review_service):
        """AC4: Default mode should be 'fresh' when not specified."""
        result = await review_service.generate_verification_canvas(
            canvas_name="test.canvas"
        )
        assert result.mode_used == "fresh"

    @pytest.mark.asyncio
    async def test_graphiti_relationship_stored(self, review_service, mock_graphiti):
        """AC5: Mode should be stored in Graphiti relationship."""
        await review_service.generate_verification_canvas(
            canvas_name="test.canvas",
            mode="targeted"
        )
        mock_graphiti.create_relationship.assert_called_once()
        call_args = mock_graphiti.create_relationship.call_args
        assert call_args.kwargs["properties"]["mode"] == "targeted"

    @pytest.mark.asyncio
    async def test_custom_weights_applied(self, review_service, mock_graphiti):
        """AC6: Custom weights should override defaults."""
        result = await review_service.generate_verification_canvas(
            canvas_name="test.canvas",
            mode="targeted",
            weak_weight=0.8,
            mastered_weight=0.2
        )
        # Verify weight distribution in question selection
        assert result is not None
```

### Integration Tests

**Test File**: `src/tests/integration/test_review_canvas_integration.py`

```python
@pytest.mark.integration
async def test_full_generation_flow_targeted_mode():
    """E2E test for targeted mode verification canvas generation."""
    # Setup: Create canvas with review history
    # Execute: Call API with mode=targeted
    # Verify: Response includes mode_used, Graphiti has relationship
    pass
```

### API Contract Tests

**Test with Schemathesis**:
```bash
schemathesis run specs/api/review-api.openapi.yml --endpoint "/review/generate-canvas"
```

---

## Dependencies

### Story Dependencies
- None (First story in Epic 24)

### Technical Dependencies
- Neo4j running for Graphiti queries
- Graphiti client available (`src/agentic_rag/clients/graphiti_client.py`)
- Existing ReviewService (`backend/app/services/review_service.py`)

### External Dependencies
- `neo4j>=5.0.0` - Graph database
- `graphiti-core>=0.6.0` - Knowledge graph SDK

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-13 | 1.0 | Initial draft - SM Agent automated batch mode | Bob (SM Agent) |

---

## Dev Agent Record

### Agent Model Used
Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References
- Plan file: `C:\Users\ROG\.claude\plans\indexed-splashing-plum.md`
- Session: 2026-01-16

### Completion Notes List
1. **AC1-AC6 已完成** - 所有验收标准在 `review_service.py` 中实现
2. **重复代码已清理** - Story 24.6 收尾任务已完成
   - 删除 `_apply_weighted_selection` 重复定义
   - 删除 `_weighted_sample` 重复定义
   - 重命名 `_query_review_sessions_from_graphiti` 避免冲突
3. **Fallback 逻辑增强** - 添加 `fallback_used` 标记到响应
4. **单元测试覆盖** - 15 个测试用例全部通过

### File List
| 文件 | 操作 | 描述 |
|------|------|------|
| `backend/app/services/review_service.py` | 修改 | Mode 支持、权重选择、Graphiti 集成、fallback 逻辑 |
| `backend/app/api/v1/endpoints/review.py` | 已存在 | API 端点已支持 mode 参数 |
| `backend/app/models/schemas.py` | 已存在 | Request schema 已包含 mode, weak_weight, mastered_weight |
| `specs/data/review-generate-response.schema.json` | 修改 | 添加 fallback_used 属性 |
| `backend/tests/unit/test_review_mode_support.py` | 创建 | 15 个单元测试覆盖所有 AC |

---

## QA Results

**QA Status**: Passed (via Story 24.6 收尾工作)

| 测试类型 | 数量 | 状态 |
|---------|------|------|
| 单元测试 | 15 | ✅ 全部通过 |
| AC 覆盖 | 6/6 | ✅ 100% |

**测试命令**:
```bash
pytest backend/tests/unit/test_review_mode_support.py -v --no-cov
```

---

## Related Documentation

**Epic Documentation**:
- Epic 24: Verification Canvas Redesign (created with this Story)

**PRD References**:
- docs/prd/v118-检验白板历史关联与可选复习模式-2025-11-14-必读.md - Core requirements

**Architecture Documentation**:
- docs/architecture/decisions/0003-graphiti-memory.md - Graphiti ADR
- docs/architecture/EPIC-11-BACKEND-ARCHITECTURE.md - Backend layer structure
- docs/architecture/ebbinghaus-review-system-architecture.md - Review system design

**API Specifications**:
- specs/api/review-api.openapi.yml - Review API OpenAPI spec
- specs/data/review-generate-request.schema.json - Request schema
- specs/data/review-generate-response.schema.json - Response schema

**Skills References**:
- .claude/skills/graphiti/SKILL.md - Graphiti documentation
- .claude/skills/langgraph/SKILL.md - LangGraph documentation
