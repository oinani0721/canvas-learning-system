# Story 36.13: ç”Ÿäº§åŠ å›º â€” asyncio.sleep å®¡è®¡ + TTLCache é…ç½®åŒ–

## Status

Done

---

## Story

**As a** Canvas Learning System operator,
**I want** all retry delays to use configurable constants instead of magic numbers, and all TTLCache instances to have their maxsize/ttl exposed as Settings,
**so that** I can tune performance and retry behavior without modifying source code, and eliminate unnecessary `asyncio.sleep` calls that slow down operations.

---

## Background

### ä¸ºä»€ä¹ˆéœ€è¦è¿™ä¸ª Story

**å¯¹æŠ—æ€§å®¡æŸ¥å‘ç° (2026-02-10)**:

| å‘ç°ç¼–å· | é—®é¢˜ | ä¸¥é‡ç¨‹åº¦ |
|---------|------|---------|
| F6 | ç”Ÿäº§ä»£ç ä¸­å­˜åœ¨ 13 å¤„ `asyncio.sleep`ï¼Œå…¶ä¸­ 1 å¤„æ˜¯"æ¨¡æ‹Ÿå·¥ä½œ" (`review_service.py:368`)ï¼Œéƒ¨åˆ†é‡è¯•å»¶è¿Ÿæœªé…ç½®åŒ– | ğŸŸ¡ é‡è¦ |
| F8 | 4 ä¸ª Service ä½¿ç”¨ TTLCacheï¼Œä½† maxsize/ttl å¤§å¤šç¡¬ç¼–ç ï¼Œä¸å¯é€šè¿‡ Settings/ç¯å¢ƒå˜é‡è°ƒæ•´ | ğŸŸ¡ é‡è¦ |

### ä»£ç ç°å®æ£€æŸ¥ (2026-02-10 éªŒè¯)

**asyncio.sleep æ¸…å• (13 å¤„)**:

| ä½ç½® | ç”¨é€” | å½“å‰å€¼ | é—®é¢˜ |
|------|------|--------|------|
| `review_service.py:368` | "Simulate work" | 0.2s | ğŸ”´ æ— æ„ä¹‰ sleepï¼Œåº”åˆ é™¤ |
| `memory_service.py:447` | é‡è¯•å»¶è¿Ÿ | å˜é‡ | âš ï¸ å»¶è¿Ÿå› å­æœªé…ç½®åŒ– |
| `memory_service.py:468` | é‡è¯•å»¶è¿Ÿ | å˜é‡ | âš ï¸ åŒä¸Š |
| `gemini_client.py:279` | API é‡è¯• | å˜é‡ | âœ… æ­£å¸¸çš„é€€é¿ç­–ç•¥ |
| `gemini_client.py:297` | API é‡è¯• | å˜é‡ | âœ… åŒä¸Š |
| `agent_service.py:3795` | yield | 0.01s | âœ… åç¨‹è®©å‡º |
| `alert_manager.py:231` | è¯„ä¼°å¾ªç¯ | é…ç½®å€¼ | âœ… å·²é…ç½® |
| `background_task_manager.py:330` | æ¸…ç†å¾ªç¯ | `settings.TASK_CLEANUP_INTERVAL_SECONDS` | âœ… å·²é…ç½® |
| `lancedb_index_service.py:196` | é˜²æŠ– | `self._debounce_seconds` | âœ… å·²é…ç½® |
| `websocket.py:213` | å¿ƒè·³ | `HEARTBEAT_INTERVAL_SECONDS` | âœ… å¸¸é‡ |
| `resource_monitor.py:363` | ç›‘æ§å¾ªç¯ | å‚æ•° | âœ… å·²é…ç½® |
| `session_manager.py:491` | æ¸…ç†å¾ªç¯ | `CLEANUP_INTERVAL_SECONDS` | âœ… å¸¸é‡ |
| `multimodal_service.py:1388` | åµŒå…¥é‡è¯• | `EMBEDDING_RETRY_DELAY` | âœ… å¸¸é‡ |

**TTLCache æ¸…å• (5 å®ä¾‹)**:

| Service | ä½ç½® | maxsize | ttl | å¯é…ç½®? |
|---------|------|---------|-----|--------|
| `AgentService` | `agent_service.py:1043` | 1000 | 30s | âŒ ç¡¬ç¼–ç  |
| `ContextEnrichmentService` | `context_enrichment_service.py:245` | 1000 | 30s (`self._association_cache_ttl`) | âš ï¸ ttl å¯é€šè¿‡æ„é€ å‡½æ•°ï¼Œmaxsize ç¡¬ç¼–ç  |
| `MemoryService` | `memory_service.py:205` | 1000 | 30s (`SCORE_HISTORY_CACHE_TTL`) | âš ï¸ ttl ç”¨å¸¸é‡ï¼Œmaxsize ç¡¬ç¼–ç  |
| `VerificationService` (sessions) | `verification_service.py:468` | 500 (`SESSION_MAXSIZE`) | 3600s (`SESSION_TTL`) | âš ï¸ ç”¨æ¨¡å—å¸¸é‡ï¼Œé Settings |
| `VerificationService` (progress) | `verification_service.py:469` | 500 | 3600s | âš ï¸ åŒä¸Š |

---

## Acceptance Criteria

### asyncio.sleep å®¡è®¡ (F6)

1. **AC-36.13.1: åˆ é™¤æ— æ„ä¹‰ sleep**
   - Given `review_service.py:368` çš„ `asyncio.sleep(0.2) # Simulate work`
   - When Story å®Œæˆ
   - Then è¯¥ sleep è°ƒç”¨è¢«åˆ é™¤
   - And åŠŸèƒ½è¡Œä¸ºä¸å˜ (æµ‹è¯•é€šè¿‡)

2. **AC-36.13.2: memory_service é‡è¯•å»¶è¿Ÿé…ç½®åŒ–**
   - Given `memory_service.py:447,468` çš„é‡è¯•å»¶è¿Ÿ
   - When éœ€è¦è°ƒæ•´é‡è¯•ç­–ç•¥
   - Then å»¶è¿ŸåŸºæ•°å’Œæœ€å¤§å»¶è¿Ÿå¯é€šè¿‡ Settings é…ç½®
   - And é»˜è®¤å€¼ä¿æŒä¸å½“å‰è¡Œä¸ºä¸€è‡´

### TTLCache é…ç½®åŒ– (F8)

3. **AC-36.13.3: AgentService ç¼“å­˜é…ç½®åŒ–**
   - Given `agent_service.py:1043` çš„ `TTLCache(maxsize=1000, ttl=30)`
   - When éœ€è¦è°ƒæ•´ç¼“å­˜è¡Œä¸º
   - Then maxsize å’Œ ttl å¯é€šè¿‡ Settings é…ç½®
   - And é»˜è®¤å€¼ = `maxsize=1000, ttl=30`

4. **AC-36.13.4: MemoryService ç¼“å­˜é…ç½®åŒ–**
   - Given `memory_service.py:205` çš„ `TTLCache(maxsize=1000, ttl=SCORE_HISTORY_CACHE_TTL)`
   - When éœ€è¦è°ƒæ•´ç¼“å­˜è¡Œä¸º
   - Then maxsize å¯é€šè¿‡ Settings é…ç½®
   - And é»˜è®¤å€¼ = `maxsize=1000`

5. **AC-36.13.5: ContextEnrichmentService ç¼“å­˜é…ç½®åŒ–**
   - Given `context_enrichment_service.py:245` çš„ `TTLCache(maxsize=1000, ...)`
   - When éœ€è¦è°ƒæ•´ç¼“å­˜è¡Œä¸º
   - Then maxsize å¯é€šè¿‡ Settings é…ç½®
   - And é»˜è®¤å€¼ = `maxsize=1000`

6. **AC-36.13.6: é…ç½®é¡¹æ–‡æ¡£åŒ–**
   - Given æ‰€æœ‰æ–°å¢ Settings å­—æ®µ
   - When æŸ¥çœ‹ `.env.example`
   - Then æ‰€æœ‰æ–°é…ç½®é¡¹éƒ½æœ‰æ³¨é‡Šè¯´æ˜ã€é»˜è®¤å€¼å’Œåˆç†å–å€¼èŒƒå›´

### åŸºç¡€è®¾æ–½ AC

7. **AC-36.13.7: D4 é…ç½®éªŒè¯**
   - æ‰€æœ‰æ–°å¢ Settings å­—æ®µæœ‰åˆç†é»˜è®¤å€¼
   - ä¸è®¾ç½®ç¯å¢ƒå˜é‡æ—¶ç³»ç»Ÿè¡Œä¸ºä¸å½“å‰å®Œå…¨ä¸€è‡´ (å‘åå…¼å®¹)
   - æç«¯å€¼ (maxsize=1, ttl=0) ä¸ä¼šå¯¼è‡´å´©æºƒ

---

## Tasks / Subtasks

- [x] **Task 1: åˆ é™¤æ— æ„ä¹‰ asyncio.sleep** (AC: 1)
  - [x] 1.1 åˆ é™¤ `review_service.py:368` çš„ `asyncio.sleep(0.2)`
  - [x] 1.2 è¿è¡Œç›¸å…³æµ‹è¯•ç¡®è®¤åŠŸèƒ½ä¸å˜

- [x] **Task 2: memory_service é‡è¯•é…ç½®åŒ–** (AC: 2)
  - [x] 2.1 åœ¨ `config.py` Settings ä¸­æ·»åŠ  `MEMORY_RETRY_BASE_DELAY` å’Œ `MEMORY_RETRY_MAX_DELAY`
  - [x] 2.2 æ›´æ–° `memory_service.py` ä½¿ç”¨ Settings ä¸­çš„é…ç½®å€¼
  - [x] 2.3 å•å…ƒæµ‹è¯•éªŒè¯é…ç½®ç”Ÿæ•ˆ

- [x] **Task 3: TTLCache é…ç½®åŒ–** (AC: 3, 4, 5)
  - [x] 3.1 åœ¨ `config.py` Settings ä¸­æ·»åŠ :
    - `AGENT_MEMORY_CACHE_MAXSIZE` (default: 1000)
    - `AGENT_MEMORY_CACHE_TTL` (default: 30)
    - `SCORE_HISTORY_CACHE_MAXSIZE` (default: 1000)
    - `ENRICHMENT_CACHE_MAXSIZE` (default: 1000)
  - [x] 3.2 æ›´æ–° `agent_service.py` æ„é€ å‡½æ•°è¯»å– Settings
  - [x] 3.3 æ›´æ–° `memory_service.py` è¯»å– Settings
  - [x] 3.4 æ›´æ–° `context_enrichment_service.py` è¯»å– Settings
  - [x] 3.5 æ›´æ–° `dependencies.py` ä¼ é€’æ–°å‚æ•°
  - [x] 3.6 å•å…ƒæµ‹è¯•éªŒè¯é…ç½®ç”Ÿæ•ˆ + è¾¹ç•Œå€¼æµ‹è¯•

- [x] **Task 4: é…ç½®æ–‡æ¡£ + å‘åå…¼å®¹éªŒè¯** (AC: 6, 7)
  - [x] 4.1 æ›´æ–° `.env.example` æ·»åŠ æ–°é…ç½®é¡¹
  - [x] 4.2 ç«¯åˆ°ç«¯éªŒè¯: ä¸è®¾ç½®ä»»ä½•æ–°ç¯å¢ƒå˜é‡æ—¶è¡Œä¸ºå®Œå…¨ä¸€è‡´
  - [x] 4.3 è¾¹ç•Œå€¼æµ‹è¯•: maxsize=1, ttl=0

---

## Dev Notes

### ä»£ç ä¿®æ”¹èŒƒå›´

| æ–‡ä»¶ | ä¿®æ”¹ç±»å‹ | è¯´æ˜ |
|------|---------|------|
| `config.py` | æ–°å¢å­—æ®µ | 5-6 ä¸ªæ–° Settings å­—æ®µ |
| `review_service.py:368` | åˆ é™¤ | ç§»é™¤ `asyncio.sleep(0.2)` |
| `memory_service.py:447,468` | ä¿®æ”¹ | é‡è¯•å»¶è¿Ÿè¯»å– Settings |
| `agent_service.py:1043` | ä¿®æ”¹ | TTLCache å‚æ•°è¯»å– Settings |
| `memory_service.py:205` | ä¿®æ”¹ | TTLCache maxsize è¯»å– Settings |
| `context_enrichment_service.py:245` | ä¿®æ”¹ | TTLCache maxsize è¯»å– Settings |
| `dependencies.py` | ä¿®æ”¹ | ä¼ é€’æ–°é…ç½®å‚æ•°åˆ° Service æ„é€ å‡½æ•° |
| `.env.example` | æ–°å¢ | æ–‡æ¡£åŒ–æ–°é…ç½®é¡¹ |

### ä¸ä¿®æ”¹çš„ TTLCache

| Service | åŸå›  |
|---------|------|
| `VerificationService` | å·²ä½¿ç”¨æ¨¡å—å¸¸é‡ `SESSION_TTL`/`SESSION_MAXSIZE`ï¼Œä¸” Session ç”Ÿå‘½å‘¨æœŸä¸é€‚åˆé¢‘ç¹è°ƒæ•´ |

### è·¨ Story ä¾èµ–

| ä¾èµ– Story | æä¾›çš„èƒ½åŠ› | æœ¬ Story ä¿®æ”¹çš„å†…å®¹ |
|-----------|-----------|------------------|
| 36.1 | DI æ¡†æ¶ | é€šè¿‡ DI ä¼ é€’æ–°é…ç½®å€¼ |
| 36.7 | AgentService å†…å­˜ç¼“å­˜ | ç¼“å­˜å‚æ•°é…ç½®åŒ– |
| 36.9 | MemoryService åŒå†™ | é‡è¯•å»¶è¿Ÿé…ç½®åŒ– |

---

## Testing

### æµ‹è¯•æ–‡ä»¶ä½ç½®
- å•å…ƒ: `backend/tests/unit/test_cache_configuration.py` (æ–°å»º)
- ç°æœ‰: ä¿®æ”¹æ¶‰åŠçš„ç°æœ‰æµ‹è¯•éœ€ç¡®è®¤ä¸ break

### å…³é”®æµ‹è¯•ç”¨ä¾‹

1. `test_delete_simulate_work_sleep`: åˆ é™¤ sleep å review_service åŠŸèƒ½æ­£å¸¸
2. `test_memory_retry_delay_from_settings`: é‡è¯•å»¶è¿Ÿä½¿ç”¨é…ç½®å€¼
3. `test_agent_service_cache_from_settings`: AgentService TTLCache ä½¿ç”¨é…ç½®å€¼
4. `test_memory_service_cache_from_settings`: MemoryService TTLCache ä½¿ç”¨é…ç½®å€¼
5. `test_enrichment_cache_from_settings`: ContextEnrichmentService TTLCache ä½¿ç”¨é…ç½®å€¼
6. `test_default_values_backward_compatible`: é»˜è®¤å€¼ä¸å½“å‰è¡Œä¸ºä¸€è‡´
7. `test_extreme_values_no_crash`: maxsize=1, ttl=0 ä¸å´©æºƒ

---

## Dev Agent Record

### Implementation Notes (2026-02-11)

**å®ç°æ–¹æ¡ˆ:**

1. **AC-1 (åˆ é™¤æ— æ„ä¹‰ sleep)**: ç›´æ¥åˆ é™¤ `review_service.py` ä¸­ `_generate()` é—­åŒ…é‡Œçš„ `await asyncio.sleep(0.2) # Simulate work`ã€‚

2. **AC-2 (memory_service é‡è¯•é…ç½®åŒ–)**: MemoryService æ˜¯ singleton æ¨¡å¼ï¼ˆæ¨¡å—çº§ `get_memory_service()`ï¼‰ï¼Œæ„é€ å‡½æ•°æ— å‚æ•°ã€‚å› æ­¤åœ¨ `__init__` ä¸­ç›´æ¥ import Settings å¹¶è¯»å–é…ç½®å€¼ï¼Œä½¿ç”¨ try/except fallback åˆ°åŸå§‹ç¡¬ç¼–ç å€¼ã€‚åŒæ—¶å°† `min(base * 2^attempt, max_delay)` æ¨¡å¼åº”ç”¨åˆ°ä¸¤å¤„é‡è¯•å»¶è¿Ÿã€‚

3. **AC-3,4,5 (TTLCache é…ç½®åŒ–)**: AgentService å’Œ ContextEnrichmentService é€šè¿‡æ„é€ å‡½æ•°å‚æ•°æ³¨å…¥ï¼ˆå¸¦é»˜è®¤å€¼ä¿æŒå‘åå…¼å®¹ï¼‰ï¼Œdependencies.py ä¼ é€’ Settings å€¼ã€‚MemoryService åœ¨ `__init__` ä¸­ç›´æ¥è¯»å– Settingsã€‚

4. **AC-6 (.env.example)**: æ·»åŠ äº† "Memory Retry Configuration" å’Œ "TTLCache Configuration" ä¸¤ä¸ªæ–°é…ç½®èŠ‚ã€‚

5. **AC-7 (å‘åå…¼å®¹ + æç«¯å€¼)**: æ‰€æœ‰ Settings å­—æ®µé»˜è®¤å€¼ä¸åŸå§‹ç¡¬ç¼–ç å€¼ä¸€è‡´ã€‚æµ‹è¯•è¦†ç›– maxsize=1 å’Œ ttl=0 ä¸å´©æºƒã€‚

**è®¾è®¡å†³ç­–:**
- MemoryService ç›´æ¥è¯» Settings è€Œéé€šè¿‡ DI ä¼ å‚ â€” å› ä¸º singleton å·¥å‚ `get_memory_service()` ä¸æ¥å—å‚æ•°
- VerificationService çš„ä¸¤ä¸ª TTLCache ä¸åœ¨æœ¬ Story èŒƒå›´å†… â€” å·²ä½¿ç”¨æ¨¡å—å¸¸é‡ï¼ŒSession ç”Ÿå‘½å‘¨æœŸä¸é€‚åˆé¢‘ç¹è°ƒæ•´

### File List

| File | Action | Description |
|------|--------|-------------|
| `backend/app/config.py` | Modified | æ·»åŠ  6 ä¸ªæ–° Settings å­—æ®µ (MEMORY_RETRY_BASE_DELAY, MEMORY_RETRY_MAX_DELAY, AGENT_MEMORY_CACHE_MAXSIZE, AGENT_MEMORY_CACHE_TTL, SCORE_HISTORY_CACHE_MAXSIZE, ENRICHMENT_CACHE_MAXSIZE) |
| `backend/app/services/review_service.py` | Modified | åˆ é™¤ `asyncio.sleep(0.2) # Simulate work` |
| `backend/app/services/memory_service.py` | Modified | é‡è¯•å»¶è¿Ÿå’Œ score_history_cache maxsize è¯»å– Settings |
| `backend/app/services/agent_service.py` | Modified | æ„é€ å‡½æ•°æ·»åŠ  memory_cache_maxsize, memory_cache_ttl å‚æ•° |
| `backend/app/services/context_enrichment_service.py` | Modified | æ„é€ å‡½æ•°æ·»åŠ  association_cache_maxsize å‚æ•° |
| `backend/app/dependencies.py` | Modified | ä¼ é€’æ–°é…ç½®å‚æ•°åˆ° AgentService å’Œ ContextEnrichmentService |
| `backend/.env.example` | Modified | æ–‡æ¡£åŒ–æ–°é…ç½®é¡¹ |
| `backend/tests/unit/test_cache_configuration.py` | Created | 15 ä¸ªæµ‹è¯•è¦†ç›–å…¨éƒ¨ 7 ä¸ª AC + DI è·¯å¾„éªŒè¯ |

### Test Results

- **æ–°å¢æµ‹è¯•**: 15/15 é€šè¿‡ (`test_cache_configuration.py`)
- **å›å½’æµ‹è¯•**: 89 é€šè¿‡, 0 æ–°å¢å¤±è´¥ (16 ä¸ªé¢„å­˜å¤±è´¥ä¸æœ¬ Story æ— å…³)
- **æµ‹è¯•èŒƒå›´**: `test_review_service_fsrs.py`, `test_memory_service_write_retry.py`, `test_context_enrichment_2hop.py`, `test_graphiti_json_dual_write.py`

---

## Senior Developer Review (AI)

**Review Date:** 2026-02-11
**Reviewer:** Adversarial Code Review Agent

### Findings (10 total: 3 HIGH, 4 MEDIUM, 3 LOW)

| # | Severity | Issue | Status |
|---|----------|-------|--------|
| H1 | ğŸ”´ HIGH | MemoryService.__init__ é™é»˜é™çº§: è£¸ `except Exception:` æ— æ—¥å¿— | âœ… Fixed â€” æ”¹ä¸º `except (ImportError, RuntimeError, AttributeError) as e` + logger.warning |
| H2 | ğŸ”´ HIGH | AgentService docstring é—æ¼ memory_cache_maxsize/ttl å‚æ•° | âœ… Fixed â€” æ·»åŠ å‚æ•°æ–‡æ¡£ |
| H3 | ğŸ”´ HIGH | test TTL æ–­è¨€æ— æ•ˆ: `timer is not None` æ€»ä¸º True | âœ… Fixed â€” æ”¹ä¸º `assert ttl == 10` |
| M1 | ğŸŸ¡ MED | config.py ä¸åœ¨ git diff ä¸­ (å·²æå‰ commit) | â„¹ï¸ Noted â€” è·¨ session å®ç°å¯¼è‡´ï¼Œä¸å½±å“åŠŸèƒ½ |
| M2 | ğŸŸ¡ MED | review_service.py diff åŒ…å«é 36.13 å˜æ›´ | â„¹ï¸ Noted â€” å…¶ä»– Story å…±äº«åŒä¸€å·¥ä½œåŒº |
| M3 | ğŸŸ¡ MED | MemoryService æµ‹è¯•ç»•è¿‡ singleton DI è·¯å¾„ | âœ… Fixed â€” æ–°å¢ 3 ä¸ª DI è·¯å¾„ä¼ æ’­æµ‹è¯• |
| M4 | ğŸŸ¡ MED | AC-6 æ— è‡ªåŠ¨åŒ–æµ‹è¯• | âœ… Fixed â€” æ–°å¢ .env.example å†…å®¹éªŒè¯æµ‹è¯• |
| L1 | ğŸŸ¢ LOW | ContextEnrichmentService TTL ä»ç¡¬ç¼–ç  | â„¹ï¸ Story èŒƒå›´å†…ï¼Œè®°ä¸ºåç»­ä¼˜åŒ– |
| L2 | ğŸŸ¢ LOW | inspect.getsource æºç æ£€æŸ¥æµ‹è¯•è¾ƒè„†å¼± | â„¹ï¸ å½“å‰å¯æ¥å— |
| L3 | ğŸŸ¢ LOW | Settings å­—æ®µæ— ä¸Šé™éªŒè¯ | â„¹ï¸ .env.example å·²å»ºè®®èŒƒå›´ |

### Review Outcome: âœ… APPROVED (after fixes)

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-10 | 0.1 | åŸºäºå¯¹æŠ—æ€§å®¡æŸ¥ F6/F8 åˆ›å»ºã€‚ç”Ÿäº§åŠ å›º: asyncio.sleep å®¡è®¡ + TTLCache é…ç½®åŒ– | PM Agent (Bob) |
| 2026-02-11 | 1.0 | å®ç°å®Œæˆ: 4 Tasks å…¨éƒ¨å®Œæˆ, 12 æµ‹è¯•é€šè¿‡, 89 å›å½’æµ‹è¯•é€šè¿‡, çŠ¶æ€ â†’ Review | Dev Agent |
| 2026-02-11 | 1.1 | Code Review: 10 findings (3H/4M/3L), 5 fixed, æµ‹è¯• 12â†’15, çŠ¶æ€ â†’ Done | Code Review Agent |
