# Story 31.1: VerificationService核心逻辑激活

---

## Status

**Completed**

---

## Story

**As a** Canvas Learning System用户,
**I want** 检验白板使用真实AI功能评估我的概念理解,
**so that** 我可以获得个性化的验证问题和准确的掌握度评分,而非模拟数据。

---

## Acceptance Criteria

- [x] **AC-31.1.1**: `start_session()` 从Canvas文件读取红色(color="4")+紫色(color="3")节点并提取概念
- [x] **AC-31.1.2**: `generate_question_with_rag()` 调用Gemini API生成个性化验证问题
- [x] **AC-31.1.3**: `process_answer()` 集成scoring-agent评估回答（返回0-40分）
- [x] **AC-31.1.4**: 所有方法支持RAG上下文注入（学习历史、教材、相关概念）
- [x] **AC-31.1.5**: 500ms超时保护和优雅降级

---

## Dev Notes

### 技术验证报告 (Step 3.6)

**验证完成时间**: 2026-01-18T23:45:00Z
**验证执行人**: SM Agent (Bob)
**Quality Gate状态**: PASSED

#### 核心Mock实现定位

| Mock位置 | 当前实现 | 应有实现 | 行号 |
|----------|---------|---------|------|
| `start_session()` | `["概念1", "概念2", "概念3"]` 硬编码 | 从Canvas读取红/紫节点 | L197-199 |
| `process_answer()` | 基于`len(user_answer)`评分 | 集成scoring-agent评估 | L279-292 |
| `generate_question_with_rag()` | `f"请解释什么是「{concept}」？"` | 调用Gemini API | L751-753 |

```python
# Mock 1 - start_session() @ L197-199
concepts = ["概念1", "概念2", "概念3"]  # 硬编码占位符

# Mock 2 - process_answer() @ L279-292 (字符长度评分)
if len(user_answer) > 100:
    quality = "excellent"
    score = 90.0
elif len(user_answer) > 50:
    quality = "good"
    score = 70.0
# ...

# Mock 3 - generate_question_with_rag() @ L751-753
question = f"请解释什么是「{concept}」？"
return question
```

---

### SDD规范参考 (必填)

**API端点** (从OpenAPI specs):
- Agent调用端点: `POST /api/v1/agents/{agent_name}/invoke`
  - 规范来源: `[Source: specs/api/agent-api.openapi.yml#L85-L156]`
  - 请求Schema: `AgentInvokeRequest` (node_id, canvas_name, context)
  - 响应Schema: `AgentResponse` (content, status, agent_name)

- Review生成端点: `POST /api/v1/review/generate`
  - 规范来源: `[Source: specs/api/review-api.openapi.yml]`
  - 请求Schema: `ReviewGenerateRequest` (canvas_path, options)
  - 响应Schema: `ReviewGenerateResponse` (canvas_url, concepts)

**数据Schema** (从JSON Schema):

1. **Canvas Node Schema**:
   - Schema来源: `[Source: specs/data/canvas-node.schema.json]`
   - color字段枚举: `["1", "2", "3", "4", "5", "6"]`
   - 项目语义映射:
     - `"4"` = 不理解 (红色语义，JSON Canvas Spec为绿色)
     - `"3"` = 似懂非懂 (紫色语义，JSON Canvas Spec为黄色)
     - `"2"` = 已理解 (绿色语义，JSON Canvas Spec为橙色)

2. **Scoring Response Schema**:
   - Schema来源: `[Source: specs/data/scoring-response.schema.json]`
   - 4维度评分: `accuracy`, `imagery`, `completeness`, `originality` (各0-25分)
   - `total_score`: 0-100
   - `color`: `"1"/"2"/"3"` (评分结果颜色)
   - `recommendations`: 数组，包含推荐的下一步Agent

3. **Agent Invoke Request Schema**:
   - 必填字段: `node_id`, `canvas_name`
   - 可选字段: `context` (RAG上下文对象)
   - context包含: `learning_history`, `textbook_excerpts`, `related_concepts`

---

### ADR决策关联 (必填)

| ADR编号 | 决策标题 | 对Story的影响 |
|---------|----------|---------------|
| ADR-002 | 使用LangGraph实现多Agent协作系统 | Agent调用遵循LangGraph StateGraph模式，scoring-agent集成需符合Agent协作规范 |
| ADR-003 | 使用Graphiti实现时序知识图谱记忆系统 | RAG上下文检索使用Graphiti混合检索 (Graph + Semantic + BM25) |
| ADR-004 | 异步并行执行引擎 | 500ms超时保护使用asyncio.wait_for模式，端到端延迟目标<400ms (P95) |

**关键约束** (从ADR Consequences提取):

- **约束1 (ADR-002)**: Agent状态通过LangGraph StateGraph管理，调用scoring-agent需遵循invoke模式
- **约束2 (ADR-003)**: RAG查询使用Graphiti混合检索能力 (Graph + Semantic + BM25)
- **约束3 (ADR-004)**: 使用asyncio.wait_for实现超时保护 (技术栈: Python 3.11, asyncio)
- **约束4 (ADR-004)**: 端到端延迟目标: <400ms (P95)

**超时与降级策略** (项目通用模式,参考Epic 31):
```python
# 500ms超时保护实现模式
try:
    result = await asyncio.wait_for(ai_call(), timeout=0.5)
except asyncio.TimeoutError:
    logger.warning("AI call timeout, using graceful degradation")
    result = mock_fallback()  # 返回Mock结果
```

**注**: 超时保护和优雅降级为项目通用模式,定义于Epic 31需求。

`[Source: ADR-002, ADR-003, ADR-004]`

---

### 关键实现参考

**1. Canvas文件读取模式** (AC-31.1.1):

参考现有`canvas_service.py`的Canvas读取实现:
```python
# Source: backend/app/services/canvas_service.py
async def read_canvas_file(canvas_path: str) -> dict:
    """读取Canvas JSON文件"""
    with open(canvas_path, 'r', encoding='utf-8') as f:
        canvas_data = json.load(f)
    return canvas_data

def filter_nodes_by_color(nodes: List[dict], colors: List[str]) -> List[dict]:
    """过滤指定颜色的节点"""
    return [n for n in nodes if n.get('color') in colors]
```

**2. Gemini API调用模式** (AC-31.1.2):

参考现有`agent_service.py`的Gemini调用:
```python
# Source: backend/app/services/agent_service.py @ L234-280
async def call_gemini(prompt: str, context: dict = None) -> str:
    """调用Gemini API生成内容"""
    model = genai.GenerativeModel('gemini-2.0-flash-001')
    response = await model.generate_content_async(prompt)
    return response.text
```

**3. scoring-agent集成模式** (AC-31.1.3):

参考现有`agent_service.py`的`score_node`方法:
```python
# Source: backend/app/services/agent_service.py @ score_node method
async def score_node(self, node_id: str, canvas_name: str, user_answer: str) -> ScoringResponse:
    """调用scoring-agent评估回答"""
    request = AgentInvokeRequest(
        node_id=node_id,
        canvas_name=canvas_name,
        context={"user_answer": user_answer}
    )
    return await self.invoke_agent("scoring", request)
```

**4. RAG上下文注入模式** (AC-31.1.4):

参考`context_enrichment_service.py`:
```python
# Source: backend/app/services/context_enrichment_service.py
async def enrich_context(concept: str, canvas_name: str) -> dict:
    """获取RAG上下文"""
    return {
        "learning_history": await get_learning_history(concept),
        "textbook_excerpts": await get_textbook_excerpts(concept),
        "related_concepts": await get_related_concepts(concept)
    }
```

---

### 评分映射规则

**scoring-agent返回 (0-100) → VerificationService使用 (0-40)**:

```python
# 映射公式: verification_score = scoring_score * 0.4
# 示例:
# - scoring_score=100 → verification_score=40
# - scoring_score=60 → verification_score=24
# - scoring_score=40 → verification_score=16

def map_scoring_to_verification(scoring_response: ScoringResponse) -> float:
    """将scoring-agent的0-100分映射到0-40分"""
    return scoring_response.total_score * 0.4
```

**分数阈值** (来自Epic 31定义):
- 分数 >= 32: 掌握良好 (color="2", 绿色)
- 分数 24-31: 部分掌握 (color="3", 黄色)
- 分数 < 24: 需要加强 (color="4", 红色)

---

### Testing

**测试文件位置**: `backend/tests/unit/test_verification_service_activation.py`

**测试框架**: pytest (per ADR-008)

**必需测试用例**:

1. **test_start_session_reads_canvas_file**: 验证从Canvas文件读取节点 (AC-31.1.1)
2. **test_start_session_filters_red_purple_nodes**: 验证只选择color="3"和color="4"的节点 (AC-31.1.1)
3. **test_start_session_extracts_concepts**: 验证从节点文本提取概念名 (AC-31.1.1)
4. **test_generate_question_calls_gemini**: 验证调用Gemini API (AC-31.1.2)
5. **test_generate_question_includes_context**: 验证问题包含RAG上下文 (AC-31.1.2)
6. **test_process_answer_calls_scoring_agent**: 验证调用scoring-agent (AC-31.1.3)
7. **test_process_answer_maps_score_correctly**: 验证0-100到0-40映射 (AC-31.1.3)
8. **test_rag_context_injection**: 验证学习历史注入 (AC-31.1.4)
9. **test_timeout_graceful_degradation**: 验证超时降级到Mock (AC-31.1.5)
10. **test_timeout_500ms_protection**: 验证500ms超时设置 (AC-31.1.5)

**集成测试**: `backend/tests/integration/test_verification_service_e2e.py`

**测试覆盖率目标**: >= 95%

---

## Tasks / Subtasks

### Task 1: 实现start_session()真实Canvas读取 (AC: 31.1.1)

- [x] **1.1** 修改`backend/app/services/verification_service.py` @ L197-199
  - 导入`canvas_service`读取Canvas文件
  - 解析`canvas_data["nodes"]`数组
  - 过滤`color in ["3", "4"]`的节点
  - 从节点`text`字段提取概念名
- [x] **1.2** 添加Canvas路径解析逻辑
  - 接收`canvas_path`参数或从session获取
  - 验证文件存在性
- [x] **1.3** 添加单元测试覆盖Canvas读取

### Task 2: 实现generate_question_with_rag()真实Gemini调用 (AC: 31.1.2)

- [x] **2.1** 修改`verification_service.py` @ L751-753
  - 构建问题生成prompt（包含概念名、上下文）
  - 调用`agent_service.call_gemini()`
  - 解析返回的问题文本
- [x] **2.2** 设计问题生成prompt模板
  ```
  请针对概念"{concept}"生成一个验证问题。
  学习背景: {learning_history}
  相关概念: {related_concepts}
  要求: 问题应验证学生对核心概念的理解，避免简单的定义题。
  ```
- [x] **2.3** 添加单元测试验证Gemini调用

### Task 3: 实现process_answer()集成scoring-agent (AC: 31.1.3)

- [x] **3.1** 修改`verification_service.py` @ L279-292
  - 移除基于字符长度的评分逻辑
  - 调用`agent_service.score_node()`
  - 获取`ScoringResponse`对象
- [x] **3.2** 实现评分映射
  - 将scoring-agent的0-100分映射到0-40
  - 根据分数设置`quality`字段
- [x] **3.3** 添加单元测试验证scoring-agent集成

### Task 4: 实现RAG上下文注入 (AC: 31.1.4)

- [x] **4.1** 集成`context_enrichment_service`
  - 在`start_session()`中预加载学习历史
  - 在`generate_question_with_rag()`中注入上下文
- [x] **4.2** 在`process_answer()`中传递上下文给scoring-agent
  - 包含用户回答、概念背景、相关知识
- [x] **4.3** 添加单元测试验证上下文传递

### Task 5: 实现500ms超时保护和优雅降级 (AC: 31.1.5)

- [x] **5.1** 包装所有AI调用使用`asyncio.wait_for`
  ```python
  try:
      result = await asyncio.wait_for(ai_call(), timeout=0.5)
  except asyncio.TimeoutError:
      result = fallback_mock()
  ```
- [x] **5.2** 实现各方法的降级逻辑
  - `start_session()` 降级: 返回`["默认概念"]`
  - `generate_question_with_rag()` 降级: 返回`f"请解释{concept}"`
  - `process_answer()` 降级: 基于字符长度评分
- [x] **5.3** 添加超时日志记录
- [x] **5.4** 添加单元测试验证降级行为

### Task 6: 环境变量支持Mock降级路径

- [x] **6.1** 添加`USE_MOCK_VERIFICATION`环境变量
  - 当设置为`true`时，强制使用Mock实现
  - 用于开发调试和性能测试
- [x] **6.2** 在config.py中注册配置项

### Task 7: 单元测试和集成测试

- [x] **7.1** 创建`backend/tests/unit/test_verification_service_activation.py`
  - 16个单元测试用例（超过预期的10个）
- [x] **7.2** 创建`backend/tests/integration/test_verification_service_e2e.py`
  - 6个端到端测试: Canvas读取 → 问题生成 → 回答评分
- [x] **7.3** 验证测试覆盖率 >= 95%

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-18 | 0.1 | Initial draft with UltraThink analysis | SM Agent (Bob) |
| 2026-01-20 | 0.2 | 修正ADR引用: ADR-003/004 → ADR-002/003/004 (PO验证Step 8d冲突解决) | PO Agent (Sarah) |

---

## Dev Agent Record

### Agent Model Used

(待实施时填写)

### Debug Log References

(待实施时填写)

### Completion Notes List

(待实施时填写)

### File List

**预计修改文件**:
- `backend/app/services/verification_service.py` (核心修改: L197, L279, L751)
- `backend/app/config.py` (添加USE_MOCK_VERIFICATION配置)

**预计新建文件**:
- `backend/tests/unit/test_verification_service_activation.py`
- `backend/tests/integration/test_verification_service_e2e.py`

---

## QA Results

### Review Date: 2026-01-21

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**Overall: EXCELLENT** - Implementation demonstrates high quality with comprehensive error handling, consistent patterns, and thorough documentation.

**Strengths:**
1. Excellent documentation with `[Source: ...]` references throughout
2. Clear separation of concerns (extraction, scoring, question generation)
3. Consistent timeout wrapping using `asyncio.wait_for()`
4. Fire-and-forget pattern for Graphiti writes (ADR-003 compliant)
5. Environment variable support for mock mode (`USE_MOCK_VERIFICATION`)
6. Graceful degradation paths for all AI calls

**Minor Concerns:**
- File is large (2287 lines) - future refactoring opportunity to split into smaller modules
- Story 31.4/31.5 code mixed in (question deduplication, difficulty adaptation) - acceptable scope expansion

### Requirements Traceability (Given-When-Then)

| AC | Test Cases | Implementation | Status |
|---|---|---|---|
| AC-31.1.1 | `test_start_session_reads_canvas_file`, `test_start_session_filters_red_purple_nodes`, `test_start_session_extracts_concepts` | `_extract_concepts_from_canvas()` @ L872-1006 | ✅ COVERED |
| AC-31.1.2 | `test_generate_question_calls_gemini`, `test_generate_question_includes_context` | `generate_question_with_rag()` @ L1623-1778 | ✅ COVERED |
| AC-31.1.3 | `test_process_answer_calls_scoring_agent`, `test_process_answer_maps_score_correctly`, `test_score_to_quality_mapping` | `_evaluate_answer_with_scoring_agent()` @ L1064-1110 | ✅ COVERED |
| AC-31.1.4 | `test_rag_context_injection` | `_get_rag_context_for_concept()` @ L1450-1514 | ✅ COVERED |
| AC-31.1.5 | `test_timeout_graceful_degradation`, `test_timeout_500ms_protection`, `test_mock_mode_returns_default_concepts` | `VERIFICATION_AI_TIMEOUT = 0.5` @ L57, `asyncio.wait_for()` wrappers | ✅ COVERED |

### Test Execution Results

```
Tests: 22/22 PASSED
- Unit tests: 16 passed
- Integration tests: 6 passed
- Test file: backend/tests/unit/test_verification_service_activation.py
- Test file: backend/tests/integration/test_verification_service_e2e.py
```

### Refactoring Performed

None - Implementation quality is high, no refactoring needed.

### Compliance Check

- Coding Standards: ✅ Follows Python async patterns, proper logging
- Project Structure: ✅ Service in correct location (backend/app/services/)
- Testing Strategy: ✅ Unit + Integration tests, proper mocking
- All ACs Met: ✅ All 5 acceptance criteria fully implemented and tested

### ADR Compliance

| ADR | Decision | Compliance | Evidence |
|---|---|---|---|
| ADR-002 | LangGraph multi-agent | ✅ Compliant | Agent service integration via `_agent_service.call_scoring()` |
| ADR-003 | Graphiti fire-and-forget | ✅ Compliant | `asyncio.create_task()` for `_store_question_to_graphiti()` @ L1748 |
| ADR-004 | Async timeout protection | ✅ Compliant | `asyncio.wait_for(..., timeout=VERIFICATION_AI_TIMEOUT)` throughout |

### Improvements Checklist

- [x] All 5 ACs implemented and verified
- [x] 500ms timeout protection implemented
- [x] Graceful degradation to mock when AI calls fail
- [x] Score mapping (0-100 → 0-40) correctly implemented
- [x] RAG context injection working
- [x] Unit tests comprehensive (16 tests)
- [x] Integration tests comprehensive (6 tests)
- [ ] Consider splitting large file in future (maintainability improvement)

### Security Review

**Status: PASS** - No security vulnerabilities identified.
- No user input directly executed
- File paths validated before reading
- No sensitive data exposure
- Proper error handling without leaking internals

### Performance Considerations

**Status: PASS** - Performance requirements met.
- 500ms timeout enforced via `VERIFICATION_AI_TIMEOUT = 0.5`
- Graceful degradation ensures user doesn't wait indefinitely
- Mock mode available for testing/development
- Fire-and-forget writes don't block main flow

### Files Modified During Review

None - No modifications made during review.

### Gate Status

Gate: **PASS** → docs/qa/gates/31.1-verificationservice-core-activation.yml

### Recommended Status

**✅ Ready for Done** - All acceptance criteria met, tests pass, ADR compliance verified.

---

## 依赖说明

**前置依赖**: 无 (此Story为Epic 31的P0 BLOCKER，无前置Story)

**技术依赖**:
- scoring-agent端点已实现: `POST /api/v1/agents/scoring/invoke`
- Gemini API配置已完成
- canvas_service文件读取功能可用

**被依赖**: Story 31.2, 31.3, 31.4, 31.5均依赖此Story
