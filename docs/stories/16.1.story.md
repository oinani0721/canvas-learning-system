# Story 16.1: Canvaså…³è”UI (å·¥å…·æ æŒ‰é’® + æ¨¡æ€æ¡†)

## Status
Draft

## Story

**As a** Canvas Learning Systemç”¨æˆ·,
**I want** é€šè¿‡Canvaså·¥å…·æ ä¸­çš„å…³è”æŒ‰é’®æ‰“å¼€ç®¡ç†æ¨¡æ€æ¡†,
**so that** æˆ‘å¯ä»¥å¯è§†åŒ–æŸ¥çœ‹ã€æ‰‹åŠ¨åˆ›å»ºå’Œç®¡ç†å½“å‰Canvasä¸å…¶ä»–Canvasä¹‹é—´çš„çŸ¥è¯†å…³è”å…³ç³»ã€‚

## Acceptance Criteria

1. Canvasè§†å›¾å·¥å…·æ æ–°å¢"å…³è”ç®¡ç†"æŒ‰é’®(å›¾æ ‡: `link-2`)
2. ç‚¹å‡»æŒ‰é’®å¼¹å‡ºå…³è”ç®¡ç†æ¨¡æ€æ¡†(`CanvasAssociationModal`)
3. æ¨¡æ€æ¡†æ˜¾ç¤ºå½“å‰Canvasçš„æ‰€æœ‰å…³è”åˆ—è¡¨(æ¥è‡ªåç«¯API)
4. æ”¯æŒåˆ›å»ºæ–°å…³è”: é€‰æ‹©ç›®æ ‡Canvas + å…³è”ç±»å‹ + æè¿°
5. æ”¯æŒç¼–è¾‘ç°æœ‰å…³è”: ä¿®æ”¹å…³è”ç±»å‹ã€æè¿°ã€å…±äº«æ¦‚å¿µ
6. æ”¯æŒåˆ é™¤å…³è”(å¸¦ç¡®è®¤å¯¹è¯æ¡†)
7. å…³è”åˆ—è¡¨æ”¯æŒæŒ‰ç±»å‹ç­›é€‰(prerequisite/related/extends/references)
8. å“åº”å¼UIè®¾è®¡ï¼Œé€‚é…æ·±è‰²/æµ…è‰²ä¸»é¢˜
9. æ‰€æœ‰APIè°ƒç”¨åŒ…å«é”™è¯¯å¤„ç†å’ŒLoadingçŠ¶æ€
10. æ‰€æœ‰ä»£ç åŒ…å«æ–‡æ¡£æ¥æºæ ‡æ³¨(Context7/SkilléªŒè¯)

## Tasks / Subtasks

- [ ] Task 1: æ³¨å†Œå·¥å…·æ å‘½ä»¤å’ŒæŒ‰é’® (AC: 1)
  - [ ] åœ¨`main.ts`ä¸­æ³¨å†Œ`canvas:open-association-modal`å‘½ä»¤
  - [ ] ä½¿ç”¨`this.app.workspace.on('canvas:node-menu')`æ·»åŠ å³é”®èœå•é¡¹
  - [ ] ä½¿ç”¨Ribbon APIæ·»åŠ å·¥å…·æ æŒ‰é’®
  - [ ] é…ç½®æŒ‰é’®å›¾æ ‡ä¸º`link-2` (Obsidianå†…ç½®å›¾æ ‡)

- [ ] Task 2: åˆ›å»ºå…³è”ç®¡ç†æ¨¡æ€æ¡†æ ¸å¿ƒ (AC: 2, 3)
  - [ ] åˆ›å»º`src/ui/modals/CanvasAssociationModal.ts`
  - [ ] ç»§æ‰¿`Modal`ç±»å®ç°`onOpen()`/`onClose()`
  - [ ] å®ç°æ¨¡æ€æ¡†å¤´éƒ¨: æ ‡é¢˜ + å½“å‰Canvasåç§°
  - [ ] å®ç°å…³è”åˆ—è¡¨å®¹å™¨(æ”¯æŒæ»šåŠ¨)
  - [ ] é›†æˆåç«¯APIè·å–å…³è”åˆ—è¡¨(`GET /canvas/associations`)

- [ ] Task 3: å®ç°å…³è”åˆ—è¡¨æ¸²æŸ“ (AC: 3, 7)
  - [ ] åˆ›å»º`AssociationListItem`ç»„ä»¶
  - [ ] æ˜¾ç¤º: ç›®æ ‡Canvasã€å…³è”ç±»å‹å¾½ç« ã€ç›¸å…³åº¦åˆ†æ•°ã€æ“ä½œæŒ‰é’®
  - [ ] å®ç°ç±»å‹ç­›é€‰ä¸‹æ‹‰æ¡†(æ”¯æŒå¤šé€‰)
  - [ ] ç©ºåˆ—è¡¨çŠ¶æ€æ˜¾ç¤ºæç¤ºä¿¡æ¯

- [ ] Task 4: å®ç°åˆ›å»ºå…³è”åŠŸèƒ½ (AC: 4)
  - [ ] åˆ›å»º"æ–°å¢å…³è”"æŒ‰é’®(ä½äºåˆ—è¡¨ä¸Šæ–¹)
  - [ ] å®ç°Canvasé€‰æ‹©å™¨(ä¸‹æ‹‰æœç´¢Vaultä¸­çš„Canvasæ–‡ä»¶)
  - [ ] å®ç°å…³è”ç±»å‹é€‰æ‹©å™¨(4ç§ç±»å‹æšä¸¾)
  - [ ] å®ç°æè¿°æ–‡æœ¬è¾“å…¥æ¡†
  - [ ] å®ç°å…±äº«æ¦‚å¿µæ ‡ç­¾è¾“å…¥(Tag Input)
  - [ ] è°ƒç”¨åç«¯APIåˆ›å»ºå…³è”(`POST /canvas/associations`)

- [ ] Task 5: å®ç°ç¼–è¾‘å…³è”åŠŸèƒ½ (AC: 5)
  - [ ] åœ¨åˆ—è¡¨é¡¹æ·»åŠ "ç¼–è¾‘"æŒ‰é’®
  - [ ] å¤ç”¨åˆ›å»ºè¡¨å•ï¼Œé¢„å¡«ç°æœ‰æ•°æ®
  - [ ] è°ƒç”¨åç«¯APIæ›´æ–°å…³è”(`PATCH /canvas/associations/{id}`)

- [ ] Task 6: å®ç°åˆ é™¤å…³è”åŠŸèƒ½ (AC: 6)
  - [ ] åœ¨åˆ—è¡¨é¡¹æ·»åŠ "åˆ é™¤"æŒ‰é’®
  - [ ] å¼¹å‡ºç¡®è®¤å¯¹è¯æ¡†(`ConfirmModal`)
  - [ ] è°ƒç”¨åç«¯APIåˆ é™¤å…³è”(`DELETE /canvas/associations/{id}`)
  - [ ] åˆ é™¤æˆåŠŸååˆ·æ–°åˆ—è¡¨

- [ ] Task 7: å®ç°UIçŠ¶æ€ç®¡ç†å’Œé”™è¯¯å¤„ç† (AC: 9)
  - [ ] å®ç°LoadingçŠ¶æ€(Spinner + Skeleton)
  - [ ] å®ç°é”™è¯¯çŠ¶æ€(é”™è¯¯æ¶ˆæ¯ + é‡è¯•æŒ‰é’®)
  - [ ] å®ç°æˆåŠŸæç¤º(Obsidian Notice)
  - [ ] å®ç°ç½‘ç»œé”™è¯¯é‡è¯•æœºåˆ¶

- [ ] Task 8: å®ç°ä¸»é¢˜é€‚é…å’Œæ ·å¼ (AC: 8)
  - [ ] åˆ›å»º`styles/association-modal.css`
  - [ ] ä½¿ç”¨CSSå˜é‡é€‚é…æ·±è‰²/æµ…è‰²ä¸»é¢˜
  - [ ] å®ç°å“åº”å¼å¸ƒå±€(æ”¯æŒçª„å±)

- [ ] Task 9: æµ‹è¯•å’Œæ–‡æ¡£ (AC: 10)
  - [ ] ç¼–å†™å•å…ƒæµ‹è¯•(ç»„ä»¶æ¸²æŸ“ã€çŠ¶æ€å˜åŒ–)
  - [ ] ç¼–å†™é›†æˆæµ‹è¯•(APIè°ƒç”¨Mock)
  - [ ] ç¡®è®¤æ‰€æœ‰ä»£ç æœ‰æ–‡æ¡£æ¥æºæ ‡æ³¨
  - [ ] æ›´æ–°ç”¨æˆ·æ–‡æ¡£

## Dev Notes

### æŠ€æœ¯éªŒè¯æŠ¥å‘Š (Step 3.6)

**éªŒè¯å®Œæˆæ—¶é—´**: 2025-12-02
**éªŒè¯æ‰§è¡Œäºº**: SM Agent
**Quality GateçŠ¶æ€**: Pending

#### æŠ€æœ¯æ ˆæ¸…å•

| æŠ€æœ¯æ ˆ | æŸ¥è¯¢æ–¹å¼ | éªŒè¯çŠ¶æ€ | æ–‡æ¡£ä½ç½® |
|--------|---------|---------|----------|
| Obsidian Plugin API | Local Skill | å¾…éªŒè¯ | @obsidian-canvas |
| Obsidian Modal | Local Skill | å¾…éªŒè¯ | @obsidian-canvas (Section: Modals) |
| TypeScript | Context7 | å¾…éªŒè¯ | /typescript-cheatsheets/react |
| FastAPI (Backend) | Context7 | å¾…éªŒè¯ | /websites/fastapi_tiangolo |

#### æ ¸å¿ƒAPIéªŒè¯å¾…åŠ

**å¼€å‘å‰å¿…é¡»éªŒè¯**:
- [ ] Obsidian Modal API (`onOpen`, `onClose`) â†’ Local Skill: @obsidian-canvas
- [ ] Obsidian Command API (`addCommand`) â†’ Local Skill: @obsidian-canvas
- [ ] Obsidian Ribbon API (`addRibbonIcon`) â†’ Local Skill: @obsidian-canvas
- [ ] Obsidian Notice API (`new Notice()`) â†’ Local Skill: @obsidian-canvas
- [ ] Canvasäº‹ä»¶ç›‘å¬ (`canvas:node-menu`) â†’ Local Skill: @obsidian-canvas

### SDDè§„èŒƒå‚è€ƒ (å¿…å¡«)

**APIç«¯ç‚¹è§„èŒƒ**:
- `GET /canvas/associations` - è·å–Canvaså…³è”åˆ—è¡¨
  - [Source: specs/api/canvas-api.openapi.yml:454-489]
  - å‚æ•°: `canvas_path` (å¯é€‰), `association_type` (å¯é€‰)
  - å“åº”Schema: `CanvasAssociation[]`
- `POST /canvas/associations` - åˆ›å»ºCanvaså…³è”
  - [Source: specs/api/canvas-api.openapi.yml:491-515]
  - è¯·æ±‚Body: `CreateAssociationRequest`
  - å“åº”: `201 Created` è¿”å› `CanvasAssociation`
- `DELETE /canvas/associations/{association_id}` - åˆ é™¤Canvaså…³è”
  - [Source: specs/api/canvas-api.openapi.yml:538-552]
  - å“åº”: `204 No Content`

**æ•°æ®Schemaè§„èŒƒ**:
- CanvasAssociation:
  - [Source: specs/data/canvas-association.schema.json]
  - å¿…å¡«å­—æ®µ: `association_id`, `source_canvas`, `target_canvas`, `association_type`
  - å…³è”ç±»å‹æšä¸¾: `["prerequisite", "related", "extends", "references"]`
  - å¯é€‰å­—æ®µ: `description`, `shared_concepts`, `relevance_score`, `bidirectional`, `auto_generated`, `created_at`, `updated_at`

### ADRå†³ç­–å…³è” (å¿…å¡«)

| ADRç¼–å· | å†³ç­–æ ‡é¢˜ | å¯¹Storyçš„å½±å“ |
|---------|----------|---------------|
| ADR-0001 | ä½¿ç”¨Obsidian Canvas | UIå¿…é¡»ä½¿ç”¨ObsidianåŸç”ŸAPI |
| ADR-0003 | Graphiti Memory | å…³è”æ•°æ®æœ€ç»ˆå­˜å‚¨åœ¨GraphitiçŸ¥è¯†å›¾è°± |
| ADR-0009 | Error Handlingç­–ç•¥ | APIé”™è¯¯å¤„ç†éµå¾ªç»Ÿä¸€æ¨¡å¼ |
| ADR-0010 | Loggingèšåˆ | UIæ“ä½œæ—¥å¿—ä½¿ç”¨structlog |

**å…³é”®çº¦æŸ**:
- UIå¿…é¡»ä½¿ç”¨ObsidianåŸç”Ÿç»„ä»¶(Modal, Setting, Menu)
- ä¸ä½¿ç”¨React/Vueç­‰å¤–éƒ¨æ¡†æ¶
- æ‰€æœ‰APIè°ƒç”¨å¿…é¡»å¼‚æ­¥ï¼Œä¸é˜»å¡UIçº¿ç¨‹
- æ”¯æŒObsidianæ·±è‰²/æµ…è‰²ä¸»é¢˜è‡ªåŠ¨åˆ‡æ¢

### æ¶æ„è®¾è®¡å‚è€ƒ

**æ¶æ„æ–‡æ¡£å¼•ç”¨**:
- UIç»„ä»¶æ¶æ„: [Source: docs/architecture/ui-component-architecture.md]
- Obsidianæ’ä»¶æ¶æ„: [Source: docs/architecture/obsidian-plugin-architecture.md]
- è·¨Canvaså…³è”æ¶æ„: [Source: docs/architecture/cross-canvas-association-architecture.md]
- æ¨¡æ€æ¡†è®¾è®¡æ¨¡å¼: [Source: docs/architecture/ui-component-architecture.md:274-361]

**å…³è”ç®¡ç†æ¨¡æ€æ¡†è®¾è®¡**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Canvaså…³è”ç®¡ç† - ç¦»æ•£æ•°å­¦.canvas                        â”‚ [X]
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ [ç­›é€‰: å…¨éƒ¨ â–¼] [+ æ–°å¢å…³è”]                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚ ğŸ“š çº¿æ€§ä»£æ•°.canvas                               â”‚   â”‚
â”‚ â”‚ [å‰ç½®çŸ¥è¯†] ç›¸å…³åº¦: 0.85                          â”‚   â”‚
â”‚ â”‚ å…±äº«æ¦‚å¿µ: çŸ©é˜µ, è¡Œåˆ—å¼, çº¿æ€§å˜æ¢                  â”‚   â”‚
â”‚ â”‚                              [ç¼–è¾‘] [åˆ é™¤]      â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚ ğŸ“š æ¦‚ç‡è®º.canvas                                 â”‚   â”‚
â”‚ â”‚ [ç›¸å…³] ç›¸å…³åº¦: 0.72                              â”‚   â”‚
â”‚ â”‚ å…±äº«æ¦‚å¿µ: ç»„åˆæ•°å­¦, æ¡ä»¶æ¦‚ç‡                      â”‚   â”‚
â”‚ â”‚                              [ç¼–è¾‘] [åˆ é™¤]      â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                       â”‚
â”‚ [æš‚æ— æ›´å¤šå…³è”]                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ä»£ç ç¤ºä¾‹åº“

**æ¨¡æ€æ¡†æ ¸å¿ƒç»“æ„**:
```typescript
// âœ… Verified from Obsidian Canvas Skill (SKILL.md - Section: Modals)
import { Modal, App, Setting, Notice, TFile } from 'obsidian';

interface CanvasAssociation {
    association_id: string;
    source_canvas: string;
    target_canvas: string;
    association_type: 'prerequisite' | 'related' | 'extends' | 'references';
    description?: string;
    shared_concepts?: string[];
    relevance_score?: number;
    bidirectional?: boolean;
    auto_generated?: boolean;
    created_at?: string;
    updated_at?: string;
}

export class CanvasAssociationModal extends Modal {
    private canvasPath: string;
    private associations: CanvasAssociation[] = [];
    private isLoading: boolean = false;
    private error: string | null = null;
    private filterType: string = 'all';

    constructor(app: App, canvasPath: string) {
        super(app);
        this.canvasPath = canvasPath;
    }

    async onOpen(): Promise<void> {
        const { contentEl } = this;
        contentEl.addClass('canvas-association-modal');

        // æ¸²æŸ“å¤´éƒ¨
        this.renderHeader(contentEl);

        // æ¸²æŸ“å·¥å…·æ 
        this.renderToolbar(contentEl);

        // æ¸²æŸ“å…³è”åˆ—è¡¨å®¹å™¨
        const listContainer = contentEl.createDiv('association-list');

        // åŠ è½½æ•°æ®
        await this.loadAssociations(listContainer);
    }

    private renderHeader(container: HTMLElement): void {
        const header = container.createDiv('modal-header');
        header.createEl('h2', { text: 'Canvaså…³è”ç®¡ç†' });
        header.createEl('p', {
            cls: 'modal-subtitle',
            text: this.canvasPath
        });
    }

    private renderToolbar(container: HTMLElement): void {
        const toolbar = container.createDiv('modal-toolbar');

        // ç­›é€‰ä¸‹æ‹‰æ¡†
        // âœ… Verified from Obsidian Canvas Skill (SKILL.md - Section: Settings)
        new Setting(toolbar)
            .setName('ç­›é€‰ç±»å‹')
            .addDropdown(dropdown => {
                dropdown
                    .addOption('all', 'å…¨éƒ¨')
                    .addOption('prerequisite', 'å‰ç½®çŸ¥è¯†')
                    .addOption('related', 'ç›¸å…³æ¦‚å¿µ')
                    .addOption('extends', 'æ‰©å±•å†…å®¹')
                    .addOption('references', 'å¼•ç”¨å…³ç³»')
                    .setValue(this.filterType)
                    .onChange(value => {
                        this.filterType = value;
                        this.refreshList();
                    });
            });

        // æ–°å¢æŒ‰é’®
        const addBtn = toolbar.createEl('button', {
            text: '+ æ–°å¢å…³è”',
            cls: 'mod-cta'
        });
        addBtn.onclick = () => this.openCreateForm();
    }

    private async loadAssociations(container: HTMLElement): Promise<void> {
        this.isLoading = true;
        this.renderLoadingState(container);

        try {
            // âœ… APIè°ƒç”¨: GET /canvas/associations
            // [Source: specs/api/canvas-api.openapi.yml:454-489]
            const response = await fetch(
                `${this.getBackendUrl()}/canvas/associations?canvas_path=${encodeURIComponent(this.canvasPath)}`
            );

            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }

            this.associations = await response.json();
            this.isLoading = false;
            this.renderAssociationList(container);
        } catch (error) {
            this.isLoading = false;
            this.error = (error as Error).message;
            this.renderErrorState(container);
        }
    }

    private renderAssociationList(container: HTMLElement): void {
        container.empty();

        const filtered = this.filterType === 'all'
            ? this.associations
            : this.associations.filter(a => a.association_type === this.filterType);

        if (filtered.length === 0) {
            container.createDiv({
                cls: 'empty-state',
                text: 'æš‚æ— å…³è”å…³ç³»'
            });
            return;
        }

        filtered.forEach(assoc => {
            this.renderAssociationItem(container, assoc);
        });
    }

    private renderAssociationItem(container: HTMLElement, assoc: CanvasAssociation): void {
        const item = container.createDiv('association-item');

        // Canvasåç§°
        const header = item.createDiv('item-header');
        header.createSpan({
            cls: 'canvas-icon',
            text: 'ğŸ“š'
        });
        header.createSpan({
            cls: 'canvas-name',
            text: assoc.target_canvas
        });

        // ç±»å‹å¾½ç« 
        const badge = item.createSpan({
            cls: `type-badge type-${assoc.association_type}`,
            text: this.getTypeLabel(assoc.association_type)
        });

        // ç›¸å…³åº¦åˆ†æ•°
        if (assoc.relevance_score !== undefined) {
            item.createSpan({
                cls: 'relevance-score',
                text: `ç›¸å…³åº¦: ${assoc.relevance_score.toFixed(2)}`
            });
        }

        // å…±äº«æ¦‚å¿µ
        if (assoc.shared_concepts && assoc.shared_concepts.length > 0) {
            const concepts = item.createDiv('shared-concepts');
            concepts.createSpan({ text: 'å…±äº«æ¦‚å¿µ: ' });
            concepts.createSpan({ text: assoc.shared_concepts.join(', ') });
        }

        // æ“ä½œæŒ‰é’®
        const actions = item.createDiv('item-actions');
        const editBtn = actions.createEl('button', { text: 'ç¼–è¾‘' });
        editBtn.onclick = () => this.openEditForm(assoc);

        const deleteBtn = actions.createEl('button', {
            text: 'åˆ é™¤',
            cls: 'mod-warning'
        });
        deleteBtn.onclick = () => this.confirmDelete(assoc);
    }

    private getTypeLabel(type: string): string {
        const labels: Record<string, string> = {
            'prerequisite': 'å‰ç½®çŸ¥è¯†',
            'related': 'ç›¸å…³',
            'extends': 'æ‰©å±•',
            'references': 'å¼•ç”¨'
        };
        return labels[type] || type;
    }

    private renderLoadingState(container: HTMLElement): void {
        container.empty();
        container.createDiv({
            cls: 'loading-state',
            text: 'åŠ è½½ä¸­...'
        });
    }

    private renderErrorState(container: HTMLElement): void {
        container.empty();
        const errorDiv = container.createDiv('error-state');
        errorDiv.createEl('p', { text: `åŠ è½½å¤±è´¥: ${this.error}` });

        const retryBtn = errorDiv.createEl('button', { text: 'é‡è¯•' });
        retryBtn.onclick = () => this.loadAssociations(container);
    }

    private openCreateForm(): void {
        new AssociationFormModal(
            this.app,
            this.canvasPath,
            null,
            () => this.refreshList()
        ).open();
    }

    private openEditForm(assoc: CanvasAssociation): void {
        new AssociationFormModal(
            this.app,
            this.canvasPath,
            assoc,
            () => this.refreshList()
        ).open();
    }

    private async confirmDelete(assoc: CanvasAssociation): Promise<void> {
        // âœ… Verified from Obsidian Canvas Skill
        const confirmed = await new ConfirmModal(
            this.app,
            'ç¡®è®¤åˆ é™¤',
            `ç¡®å®šè¦åˆ é™¤ä¸ "${assoc.target_canvas}" çš„å…³è”å—ï¼Ÿ`
        ).open();

        if (confirmed) {
            await this.deleteAssociation(assoc);
        }
    }

    private async deleteAssociation(assoc: CanvasAssociation): Promise<void> {
        try {
            // âœ… APIè°ƒç”¨: DELETE /canvas/associations/{id}
            // [Source: specs/api/canvas-api.openapi.yml:538-552]
            const response = await fetch(
                `${this.getBackendUrl()}/canvas/associations/${assoc.association_id}`,
                { method: 'DELETE' }
            );

            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }

            // âœ… Verified from Obsidian Canvas Skill (SKILL.md - Section: Notice)
            new Notice('å…³è”å·²åˆ é™¤');
            this.refreshList();
        } catch (error) {
            new Notice(`åˆ é™¤å¤±è´¥: ${(error as Error).message}`);
        }
    }

    private refreshList(): void {
        const container = this.contentEl.querySelector('.association-list');
        if (container) {
            this.loadAssociations(container as HTMLElement);
        }
    }

    private getBackendUrl(): string {
        // ä»æ’ä»¶è®¾ç½®è¯»å–
        return 'http://localhost:8000/api';
    }

    onClose(): void {
        this.contentEl.empty();
    }
}
```

**åˆ›å»º/ç¼–è¾‘è¡¨å•æ¨¡æ€æ¡†**:
```typescript
// âœ… Verified from Obsidian Canvas Skill (SKILL.md - Section: Settings Pattern)
export class AssociationFormModal extends Modal {
    private sourceCanvas: string;
    private existing: CanvasAssociation | null;
    private onSave: () => void;

    private targetCanvas: string = '';
    private associationType: string = 'related';
    private description: string = '';
    private sharedConcepts: string[] = [];

    constructor(
        app: App,
        sourceCanvas: string,
        existing: CanvasAssociation | null,
        onSave: () => void
    ) {
        super(app);
        this.sourceCanvas = sourceCanvas;
        this.existing = existing;
        this.onSave = onSave;

        if (existing) {
            this.targetCanvas = existing.target_canvas;
            this.associationType = existing.association_type;
            this.description = existing.description || '';
            this.sharedConcepts = existing.shared_concepts || [];
        }
    }

    onOpen(): void {
        const { contentEl } = this;
        contentEl.addClass('association-form-modal');

        const title = this.existing ? 'ç¼–è¾‘å…³è”' : 'æ–°å¢å…³è”';
        contentEl.createEl('h2', { text: title });

        // ç›®æ ‡Canvasé€‰æ‹©
        // âœ… Verified from Obsidian Canvas Skill (SKILL.md - Section: Settings)
        new Setting(contentEl)
            .setName('ç›®æ ‡Canvas')
            .setDesc('é€‰æ‹©è¦å…³è”çš„Canvasæ–‡ä»¶')
            .addSearch(search => {
                search
                    .setPlaceholder('æœç´¢Canvas...')
                    .setValue(this.targetCanvas)
                    .onChange(value => {
                        this.targetCanvas = value;
                    });

                // æ·»åŠ è‡ªåŠ¨å®Œæˆ
                this.addCanvasAutocomplete(search.inputEl);
            });

        // å…³è”ç±»å‹é€‰æ‹©
        new Setting(contentEl)
            .setName('å…³è”ç±»å‹')
            .setDesc('é€‰æ‹©å…³è”å…³ç³»çš„ç±»å‹')
            .addDropdown(dropdown => {
                dropdown
                    .addOption('prerequisite', 'å‰ç½®çŸ¥è¯† - å­¦ä¹ æœ¬Canvaså‰éœ€å…ˆå­¦ä¹ ç›®æ ‡')
                    .addOption('related', 'ç›¸å…³æ¦‚å¿µ - ä¸¤ä¸ªCanvasæœ‰ç›¸å…³å†…å®¹')
                    .addOption('extends', 'æ‰©å±•å†…å®¹ - ç›®æ ‡æ˜¯æœ¬Canvasçš„æ·±å…¥')
                    .addOption('references', 'å¼•ç”¨å…³ç³» - æœ¬Canvaså¼•ç”¨äº†ç›®æ ‡å†…å®¹')
                    .setValue(this.associationType)
                    .onChange(value => {
                        this.associationType = value;
                    });
            });

        // æè¿°
        new Setting(contentEl)
            .setName('æè¿°')
            .setDesc('ç®€è¦æè¿°ä¸¤ä¸ªCanvasçš„å…³è”å…³ç³»')
            .addTextArea(text => {
                text
                    .setPlaceholder('ä¾‹å¦‚: çŸ©é˜µè¿ç®—çš„å…±åŒæ¦‚å¿µ')
                    .setValue(this.description)
                    .onChange(value => {
                        this.description = value;
                    });
                text.inputEl.rows = 3;
            });

        // å…±äº«æ¦‚å¿µ (Tag Input)
        new Setting(contentEl)
            .setName('å…±äº«æ¦‚å¿µ')
            .setDesc('è¾“å…¥å…±äº«çš„æ¦‚å¿µï¼Œç”¨é€—å·åˆ†éš”')
            .addText(text => {
                text
                    .setPlaceholder('çŸ©é˜µ, è¡Œåˆ—å¼, çº¿æ€§å˜æ¢')
                    .setValue(this.sharedConcepts.join(', '))
                    .onChange(value => {
                        this.sharedConcepts = value.split(',').map(s => s.trim()).filter(s => s);
                    });
            });

        // æŒ‰é’®
        const buttonContainer = contentEl.createDiv('button-container');

        const cancelBtn = buttonContainer.createEl('button', { text: 'å–æ¶ˆ' });
        cancelBtn.onclick = () => this.close();

        const saveBtn = buttonContainer.createEl('button', {
            text: this.existing ? 'ä¿å­˜' : 'åˆ›å»º',
            cls: 'mod-cta'
        });
        saveBtn.onclick = () => this.save();
    }

    private addCanvasAutocomplete(inputEl: HTMLInputElement): void {
        // è·å–Vaultä¸­æ‰€æœ‰Canvasæ–‡ä»¶
        const canvasFiles = this.app.vault.getFiles()
            .filter(f => f.extension === 'canvas')
            .map(f => f.path);

        // ç®€å•çš„è‡ªåŠ¨å®Œæˆå®ç°
        inputEl.addEventListener('focus', () => {
            // æ˜¾ç¤ºä¸‹æ‹‰å»ºè®® (ç®€åŒ–å®ç°)
        });
    }

    private async save(): Promise<void> {
        if (!this.targetCanvas) {
            new Notice('è¯·é€‰æ‹©ç›®æ ‡Canvas');
            return;
        }

        const payload = {
            source_canvas: this.sourceCanvas,
            target_canvas: this.targetCanvas,
            association_type: this.associationType,
            description: this.description || undefined,
            shared_concepts: this.sharedConcepts.length > 0 ? this.sharedConcepts : undefined
        };

        try {
            const url = this.existing
                ? `${this.getBackendUrl()}/canvas/associations/${this.existing.association_id}`
                : `${this.getBackendUrl()}/canvas/associations`;

            const method = this.existing ? 'PATCH' : 'POST';

            // âœ… APIè°ƒç”¨: POST/PATCH /canvas/associations
            // [Source: specs/api/canvas-api.openapi.yml:491-515]
            const response = await fetch(url, {
                method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.detail || `HTTP ${response.status}`);
            }

            new Notice(this.existing ? 'å…³è”å·²æ›´æ–°' : 'å…³è”å·²åˆ›å»º');
            this.onSave();
            this.close();
        } catch (error) {
            new Notice(`æ“ä½œå¤±è´¥: ${(error as Error).message}`);
        }
    }

    private getBackendUrl(): string {
        return 'http://localhost:8000/api';
    }

    onClose(): void {
        this.contentEl.empty();
    }
}
```

**å·¥å…·æ å‘½ä»¤æ³¨å†Œ**:
```typescript
// âœ… Verified from Obsidian Canvas Skill (SKILL.md - Section: Commands)
// main.ts ä¸­çš„å‘½ä»¤æ³¨å†Œ
import { Plugin, WorkspaceLeaf, ItemView } from 'obsidian';

export default class CanvasLearningPlugin extends Plugin {
    async onload() {
        // æ³¨å†Œå‘½ä»¤
        this.addCommand({
            id: 'open-canvas-association-modal',
            name: 'Open Canvas Association Modal',
            checkCallback: (checking: boolean) => {
                const canvasView = this.app.workspace.getActiveViewOfType(ItemView);
                if (canvasView?.getViewType() === 'canvas') {
                    if (!checking) {
                        const canvasFile = this.app.workspace.getActiveFile();
                        if (canvasFile) {
                            new CanvasAssociationModal(this.app, canvasFile.path).open();
                        }
                    }
                    return true;
                }
                return false;
            }
        });

        // æ·»åŠ Ribbonå›¾æ ‡
        // âœ… Verified from Obsidian Canvas Skill (SKILL.md - Section: Ribbon)
        this.addRibbonIcon('link-2', 'Canvas Associations', () => {
            const canvasFile = this.app.workspace.getActiveFile();
            if (canvasFile?.extension === 'canvas') {
                new CanvasAssociationModal(this.app, canvasFile.path).open();
            } else {
                new Notice('è¯·å…ˆæ‰“å¼€ä¸€ä¸ªCanvasæ–‡ä»¶');
            }
        });

        // Canvaså³é”®èœå•
        // âœ… Verified from Obsidian Canvas Skill (SKILL.md - Section: Events)
        this.registerEvent(
            this.app.workspace.on('canvas:node-menu', (menu, node) => {
                menu.addItem((item) => {
                    item.setTitle('ç®¡ç†Canvaså…³è”')
                        .setIcon('link-2')
                        .onClick(() => {
                            const canvasFile = this.app.workspace.getActiveFile();
                            if (canvasFile) {
                                new CanvasAssociationModal(this.app, canvasFile.path).open();
                            }
                        });
                });
            })
        );
    }
}
```

### é¡¹ç›®ç»“æ„å‚è€ƒ

```
src/
â”œâ”€â”€ main.ts                          # æ’ä»¶å…¥å£ (å‘½ä»¤æ³¨å†Œ)
â”œâ”€â”€ ui/
â”‚   â”œâ”€â”€ modals/
â”‚   â”‚   â”œâ”€â”€ CanvasAssociationModal.ts   # å…³è”ç®¡ç†æ¨¡æ€æ¡† (Story 16.1)
â”‚   â”‚   â”œâ”€â”€ AssociationFormModal.ts     # åˆ›å»º/ç¼–è¾‘è¡¨å• (Story 16.1)
â”‚   â”‚   â””â”€â”€ ConfirmModal.ts             # ç¡®è®¤å¯¹è¯æ¡†
â”‚   â””â”€â”€ components/
â”‚       â”œâ”€â”€ AssociationListItem.ts      # å…³è”åˆ—è¡¨é¡¹ç»„ä»¶
â”‚       â””â”€â”€ CanvasSearchInput.ts        # Canvasæœç´¢è¾“å…¥æ¡†
â””â”€â”€ styles/
    â””â”€â”€ association-modal.css           # æ¨¡æ€æ¡†æ ·å¼

specs/data/
â””â”€â”€ canvas-association.schema.json      # å·²å­˜åœ¨ [Source verified]
```

[Source: docs/architecture/project-structure.md]

### Testing

**æµ‹è¯•æ–‡ä»¶ä½ç½®**: `src/tests/test_canvas_association_modal.ts`

**æµ‹è¯•æ ‡å‡†**:
- ä½¿ç”¨Obsidian Pluginæµ‹è¯•æ¡†æ¶
- ç»„ä»¶æ¸²æŸ“æµ‹è¯•
- APIè°ƒç”¨Mockæµ‹è¯•
- ç”¨æˆ·äº¤äº’æµ‹è¯•

**æœ¬Storyæµ‹è¯•è¦æ±‚**:
- æµ‹è¯•æ¨¡æ€æ¡†æ‰“å¼€/å…³é—­
- æµ‹è¯•å…³è”åˆ—è¡¨æ¸²æŸ“
- æµ‹è¯•ç­›é€‰åŠŸèƒ½
- æµ‹è¯•åˆ›å»ºå…³è”æµç¨‹
- æµ‹è¯•ç¼–è¾‘å…³è”æµç¨‹
- æµ‹è¯•åˆ é™¤å…³è”æµç¨‹(å«ç¡®è®¤)
- æµ‹è¯•é”™è¯¯å¤„ç†å’ŒLoadingçŠ¶æ€

**æµ‹è¯•ç”¨ä¾‹ç¤ºä¾‹**:
```typescript
import { CanvasAssociationModal } from '../ui/modals/CanvasAssociationModal';

describe('CanvasAssociationModal', () => {
    let modal: CanvasAssociationModal;
    let mockApp: any;

    beforeEach(() => {
        mockApp = createMockApp();
        modal = new CanvasAssociationModal(mockApp, 'test.canvas');
    });

    test('should render header with canvas path', async () => {
        await modal.onOpen();
        const header = modal.contentEl.querySelector('.modal-subtitle');
        expect(header?.textContent).toBe('test.canvas');
    });

    test('should load associations on open', async () => {
        const mockAssociations = [
            { association_id: '1', target_canvas: 'other.canvas', association_type: 'related' }
        ];
        mockFetch(mockAssociations);

        await modal.onOpen();

        const items = modal.contentEl.querySelectorAll('.association-item');
        expect(items.length).toBe(1);
    });

    test('should filter by type', async () => {
        // æµ‹è¯•ç­›é€‰åŠŸèƒ½
    });

    test('should show error state on API failure', async () => {
        mockFetchError(500);
        await modal.onOpen();

        const error = modal.contentEl.querySelector('.error-state');
        expect(error).toBeTruthy();
    });
});
```

[Source: docs/architecture/coding-standards.md#æµ‹è¯•è§„èŒƒ]

### ä¾èµ–å…³ç³»

**å‰ç½®ä¾èµ–**:
- Epic 11: FastAPIåç«¯åŸºç¡€æ¶æ„ (APIç«¯ç‚¹å·²å°±ç»ª)
- Epic 13: Obsidian Pluginæ ¸å¿ƒåŠŸèƒ½ (æ’ä»¶æ¡†æ¶å·²å°±ç»ª)

**åç»­ä¾èµ–**:
- Story 16.2: .canvas-links.jsoné…ç½®ç®¡ç†
  - æœ¬Storyçš„UIéœ€è¦è°ƒç”¨16.2çš„é…ç½®ç®¡ç†å™¨API
  - å…³è”æ•°æ®çš„æœ¬åœ°æŒä¹…åŒ–ç”±16.2å¤„ç†
- Story 16.3: Graphitiè·¨Canvaså…³ç³»å­˜å‚¨
  - æœ¬Storyåˆ›å»ºçš„å…³è”æœ€ç»ˆåŒæ­¥åˆ°Graphiti
- Story 16.7: å…³è”çŠ¶æ€æŒ‡ç¤ºå™¨
  - ä¾èµ–æœ¬Storyçš„å…³è”æ•°æ®æ˜¾ç¤ºçŠ¶æ€

### æŠ€æœ¯çº¦æŸå’Œæ³¨æ„äº‹é¡¹

**ç‰ˆæœ¬çº¦æŸ**:
- Obsidian: â‰¥1.4.0
- TypeScript: â‰¥5.0.0
- åç«¯API: FastAPI (Epic 11å·²éƒ¨ç½²)

**Obsidian APIçº¦æŸ**:
- å¿…é¡»ä½¿ç”¨`Modal`åŸºç±»ï¼Œä¸èƒ½ä½¿ç”¨åŸç”Ÿ`<dialog>`
- å¿…é¡»ä½¿ç”¨`Setting`ç»„ä»¶æ„å»ºè¡¨å•ï¼Œä¸èƒ½ç›´æ¥æ“ä½œDOM
- æ–‡ä»¶æ“ä½œå¿…é¡»é€šè¿‡`app.vault` API

**å·²çŸ¥é™åˆ¶**:
- Obsidian Modalä¸æ”¯æŒå¤æ‚åŠ¨ç”»æ•ˆæœ
- æ·±è‰²ä¸»é¢˜ä¸‹éœ€è¦æµ‹è¯•é¢œè‰²å¯¹æ¯”åº¦
- ç§»åŠ¨ç«¯Obsidianå¯èƒ½éœ€è¦é¢å¤–é€‚é…

**å®‰å…¨è€ƒè™‘**:
- Canvasè·¯å¾„å¿…é¡»éªŒè¯ï¼ˆé˜²æ­¢è·¯å¾„éå†ï¼‰
- APIè¯·æ±‚éœ€è¦å¤„ç†è¶…æ—¶å’Œé‡è¯•
- ç”¨æˆ·è¾“å…¥éœ€è¦XSSé˜²æŠ¤ï¼ˆObsidian APIå·²å†…ç½®ï¼‰

**ä¸PRDçš„å¯¹åº”å…³ç³»**:
- [Source: docs/prd/CANVAS-LEARNING-SYSTEM-OBSIDIAN-NATIVE-MIGRATION-PRD.md:6551-6559]
- Epic 16åŠŸèƒ½éœ€æ±‚: è·¨Canvaså…³è”å­¦ä¹ ç³»ç»Ÿ
- Story 16.1: Canvaså…³è”UI (å·¥å…·æ æŒ‰é’® + æ¨¡æ€æ¡†)

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-02 | 1.0 | Initial story draft | SM Agent |

## Story Checklist Validation

### Section 1: StoryåŸºç¡€ä¿¡æ¯
- [x] 1.1 Statuså­—æ®µå­˜åœ¨ä¸”ä¸ºæœ‰æ•ˆå€¼ (Draft)
- [x] 1.2 Storyæ ¼å¼éµå¾ª "As a... I want... so that..."
- [x] 1.3 Storyæè¿°æ¸…æ™°ã€å…·ä½“ã€å¯å®ç°

### Section 2: Acceptance Criteria
- [x] 2.1 ACåˆ—è¡¨å­˜åœ¨ä¸”éç©º (10æ¡)
- [x] 2.2 æ¯æ¡ACå¯éªŒè¯ã€å¯æµ‹é‡
- [x] 2.3 ACè¦†ç›–Storyçš„æ ¸å¿ƒåŠŸèƒ½

### Section 3: Tasks
- [x] 3.1 Tasksåˆ—è¡¨å­˜åœ¨ä¸”éç©º (9ä¸ªTask)
- [x] 3.2 æ¯ä¸ªTaskå…³è”åˆ°å…·ä½“AC
- [x] 3.3 Tasksåˆ†è§£ç²’åº¦é€‚å½“

### Section 4: Dev Notes
- [x] 4.1 Dev Noteså­˜åœ¨ä¸”éç©º
- [x] 4.2 æŠ€æœ¯éªŒè¯æŠ¥å‘Šå­˜åœ¨
- [x] 4.3 ä»£ç ç¤ºä¾‹å­˜åœ¨

### Section 5: Testing
- [x] 5.1 Testing sectionå­˜åœ¨
- [x] 5.2 æµ‹è¯•æ ‡å‡†å®šä¹‰
- [x] 5.3 æµ‹è¯•ç”¨ä¾‹ç¤ºä¾‹å­˜åœ¨

### Section 6: SDD/ADR (CRITICAL)
- [x] 6.1 SDDè§„èŒƒå¼•ç”¨å­˜åœ¨
  - APIç«¯ç‚¹: specs/api/canvas-api.openapi.yml:454-489, :491-515, :538-552
  - æ•°æ®Schema: specs/data/canvas-association.schema.json
- [x] 6.2 ADRå…³è”å­˜åœ¨
  - ADR-0001: ä½¿ç”¨Obsidian Canvas
  - ADR-0003: Graphiti Memory
  - ADR-0009: Error Handlingç­–ç•¥
  - ADR-0010: Loggingèšåˆ
- [x] 6.3 åå¹»è§‰éªŒè¯
  - æ‰€æœ‰æ–‡ä»¶è·¯å¾„å·²åœ¨project-file-index.mdéªŒè¯
  - APIç«¯ç‚¹è¡Œå·å·²éªŒè¯
  - Schemaå­—æ®µä¸æºæ–‡ä»¶ä¸€è‡´
