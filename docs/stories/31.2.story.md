# Story 31.2: 检验白板生成端到端对接

## Status

**Status**: Done

## Story

**As a** Canvas学习系统用户,
**I want** 一键生成与原始Canvas关联的检验白板,
**so that** 我可以通过检验问题验证对概念的理解程度

## Acceptance Criteria

1. **AC-31.2.1**: main.ts实现`generateVerificationCanvas`调用 `POST /review/generate` API
2. **AC-31.2.2**: 创建新检验白板Canvas文件（命名: `{原名}_验证_{timestamp}.canvas`）
3. **AC-31.2.3**: 在VerificationHistoryService中记录原Canvas与检验Canvas的关系
4. **AC-31.2.4**: 生成完成后自动在Obsidian中打开新Canvas
5. **AC-31.2.5**: 显示生成进度条（"正在生成检验白板... 预计30秒"）

## Tasks / Subtasks

- [x] **Task 1: 实现generateVerificationCanvas回调** (AC: 31.2.1, 31.2.5)
  - [x] 1.1: 在main.ts中找到`generateVerificationCanvas`回调（L764-834）
  - [x] 1.2: 替换"功能开发中..."提示为实际API调用
  - [x] 1.3: 使用`this.apiClient.generateReview()`调用后端
  - [x] 1.4: 显示进度Notice："正在生成检验白板... 预计30秒"
  - [x] 1.5: 处理API响应中的`verification_canvas_name`（检验白板名称）

- [x] **Task 2: 构建API请求参数** (AC: 31.2.1)
  - [x] 2.1: 从context获取当前canvas名称
  - [x] 2.2: 构建`GenerateReviewRequest`对象:
    ```typescript
    {
      source_canvas: context.canvasName,  // 注意: 后端字段名为source_canvas
      mode: "fresh"  // 默认fresh模式
    }
    ```
  - [x] 2.3: 可选：支持用户选择`targeted`模式

- [x] **Task 3: 记录Canvas关系** (AC: 31.2.3)
  - [x] 3.1: 调用`verificationHistoryService.addRelation()`
  - [x] 3.2: 传入参数: originalCanvasPath, verificationCanvasPath, reviewMode
  - [x] 3.3: 处理返回的`VerificationCanvasRelation`对象

- [x] **Task 4: 自动打开新Canvas** (AC: 31.2.4)
  - [x] 4.1: 使用`this.app.workspace.openLinkText()`打开新Canvas
  - [x] 4.2: 使用响应中的`verification_canvas_name`构建路径
  - [x] 4.3: 确保在当前tab或新tab中打开（遵循Obsidian设置）

- [x] **Task 5: 错误处理与UI反馈** (AC: 31.2.5)
  - [x] 5.1: 捕获API调用异常
  - [x] 5.2: 显示用户友好的错误提示
  - [x] 5.3: 成功时显示"检验白板生成完成"Notice
  - [x] 5.4: 处理超时情况（使用ApiClient的150s超时）

- [x] **Task 6: 单元测试**
  - [x] 6.1: 测试generateVerificationCanvas调用ApiClient
  - [x] 6.2: 测试VerificationHistoryService.addRelation()被调用
  - [x] 6.3: 测试错误处理流程
  - [x] 6.4: 测试进度提示显示

## Dev Notes

### SDD规范参考 (必填)

**API端点** (从OpenAPI specs):
- 端点路径和方法: `POST /review/generate`
- 规范来源: `[Source: specs/api/review-api.openapi.yml]`
- 请求Schema: `GenerateReviewRequest`
  ```yaml
  requestBody:
    content:
      application/json:
        schema:
          $ref: '#/components/schemas/GenerateCanvasRequest'
  ```
- 响应Schema: `GenerateReviewResponse`
  ```yaml
  responses:
    '201':
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/GenerateCanvasResponse'
  ```

**数据Schema** (从JSON Schema):

1. **请求Schema** `[Source: backend/app/models/schemas.py:471-523]`
   - `source_canvas` (string, required): 原始Canvas文件名
   - `node_ids` (array, optional): 指定节点ID列表，默认所有绿色节点
   - `mode` (string, optional): `"fresh"` | `"targeted"`，默认`"fresh"`
   - `weak_weight` (number, optional): 薄弱节点权重，默认0.7，范围0-1
   - `mastered_weight` (number, optional): 已掌握节点权重，默认0.3，范围0-1

2. **响应Schema** `[Source: backend/app/models/schemas.py:525-545]`
   - `verification_canvas_name` (string, required): 生成的检验白板名称
   - `node_count` (integer, required): 验证节点数量
   - `mode_used` (string, optional): 使用的模式 `"fresh"` | `"targeted"`
   - `weak_concepts` (array, optional): 薄弱概念列表（targeted模式）
   - `weight_config` (object, optional): 权重配置（targeted模式）

### ADR决策关联 (必填)

| ADR编号 | 决策标题 | 对Story的影响 |
|---------|----------|---------------|
| ADR-0001 | 使用Obsidian Canvas | Canvas操作必须使用JSON格式，节点颜色使用"1"-"6"字符串 |

**关键约束** (从ADR Consequences提取):
- 约束1: Canvas文件必须是JSON格式，存储在Vault目录下
- 约束2: 节点颜色使用字符串"1"-"6"表示（"3"=紫色，"4"=红色，"6"=黄色）
- 约束3: 文件操作使用Obsidian Vault API

来源引用: `[Source: ADR-0001-use-obsidian-canvas.md]`

### 关键实现参考

**已存在的API方法** `[Source: ApiClient.ts:550-558]`:
```typescript
async generateReview(
  request: GenerateReviewRequest
): Promise<GenerateReviewResponse> {
  return this.request<GenerateReviewResponse>(
    'POST',
    '/review/generate',
    request
  );
}
```

**已存在的历史记录方法** `[Source: VerificationHistoryService.ts:123-151]`:
```typescript
async addRelation(
  originalCanvasPath: string,
  verificationCanvasPath: string,
  reviewMode: ReviewMode
): Promise<VerificationCanvasRelation>
```

**当前stub实现位置** `[Source: main.ts:751-753]`:
```typescript
generateVerificationCanvas: async (context: MenuContext) => {
    new Notice('生成检验白板功能开发中...');
},
```

**后端实现已完成** `[Source: review.py:217-430]`:
- POST /review/generate 端点完整实现
- 从Canvas读取红色(color="4")+紫色(color="3")节点
- 按主题聚类生成检验问题
- 创建问题节点(cyan, color="5") + 黄色答题节点(color="6")
- 保存Canvas文件并返回路径

### 依赖关系

- **依赖Story 31.1**: VerificationService核心逻辑激活（确保后端问题生成真实可用）
- **已有依赖**: ApiClient, VerificationHistoryService均已实现

### Testing

**测试文件位置**: `canvas-progress-tracker/obsidian-plugin/tests/`

**测试框架**: Vitest

**测试要求**:
1. 单元测试：mock ApiClient验证正确调用
2. 单元测试：验证VerificationHistoryService.addRelation()被调用
3. 集成测试：验证完整流程（需要mock后端响应）
4. 测试覆盖率要求: >= 80%

**测试模式**:
```typescript
// 参考现有测试模式
import { describe, it, expect, vi, beforeEach } from 'vitest';

describe('generateVerificationCanvas', () => {
  it('should call generateReview API with correct parameters', async () => {
    // mock apiClient.generateReview
    // call generateVerificationCanvas
    // verify API call parameters
  });

  it('should add relation after successful generation', async () => {
    // mock successful API response
    // verify addRelation was called
  });

  it('should show error notice on API failure', async () => {
    // mock API error
    // verify error Notice shown
  });
});
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-18 | 1.0 | Initial story creation | SM Agent (Bob) |
| 2026-01-20 | 1.1 | PO验证修复: 更正API字段名(canvas_name→source_canvas, review_canvas_name→verification_canvas_name)以匹配后端实现 | PO Agent (Sarah) |

## Dev Agent Record

### Agent Model Used

_To be filled by Dev Agent_

### Debug Log References

_To be filled by Dev Agent_

### Completion Notes List

_To be filled by Dev Agent_

### File List

| File | Lines | Description |
|------|-------|-------------|
| `canvas-progress-tracker/obsidian-plugin/main.ts` | 764-834 | Core generateVerificationCanvas callback implementation |
| `canvas-progress-tracker/obsidian-plugin/tests/callbacks/generateVerificationCanvas.test.ts` | - | 14 unit tests for verification canvas generation |
| `canvas-progress-tracker/obsidian-plugin/src/services/VerificationHistoryService.ts` | 123-151 | History tracking service with addRelation method |
| `canvas-progress-tracker/obsidian-plugin/src/api/types.ts` | 570-582 | GenerateReviewRequest/Response type definitions |
| `backend/app/api/v1/endpoints/review.py` | 366-434 | Backend POST /review/generate endpoint |
| `backend/app/models/schemas.py` | 645-718 | Backend Pydantic request/response models |

## QA Results

### Review Date: 2026-01-21

### Reviewed By: Quinn (Test Architect)

### Review Type: Pre-Implementation Technical Review (Story Status: Draft)

**⚠️ CRITICAL FINDING: Implementation Already Exists**

This story is marked as "Draft" but **implementation is already complete**. The story metadata is outdated.

---

### Code Quality Assessment

**Overall: GOOD - Implementation is complete and functional**

The `generateVerificationCanvas` callback has been fully implemented at `main.ts:764-834` with all 5 ACs covered:

| AC | Description | Status | Evidence |
|----|-------------|--------|----------|
| AC-31.2.1 | API call to POST /review/generate | ✅ Complete | `main.ts:783-792` |
| AC-31.2.2 | Canvas naming convention | ✅ Complete | Backend `review.py:414` |
| AC-31.2.3 | VerificationHistoryService.addRelation | ✅ Complete | `main.ts:795-806` |
| AC-31.2.4 | Auto-open new Canvas | ✅ Complete | `main.ts:808-820` |
| AC-31.2.5 | Progress/error notices | ✅ Complete | `main.ts:780,823,829` |

### API Contract Analysis

**Frontend ↔ Backend Alignment: ✅ ALIGNED**

| Layer | Request Field | Response Field | Source |
|-------|--------------|----------------|--------|
| Frontend `types.ts` | `source_canvas` | `verification_canvas_name` | L570-582 |
| Backend `schemas.py` | `source_canvas` | `verification_canvas_name` | L651, L706 |
| Backend `review.py` | Uses `GenerateReviewRequest` | Uses `GenerateReviewResponse` | L367-375 |

**⚠️ DOCUMENTATION DRIFT DETECTED:**

OpenAPI spec `review-api.openapi.yml` uses different field names:
- `canvas_path` instead of `source_canvas`
- `review_canvas_path` instead of `verification_canvas_name`

This is a documentation issue only - the code works correctly.

### Test Architecture Assessment

**Test Coverage: GOOD**

| Test File | ACs Covered | Test Count |
|-----------|-------------|------------|
| `generateVerificationCanvas.test.ts` | AC-31.2.1, AC-31.2.3, AC-31.2.5 | 14 tests |

**Test Patterns Used:**
- ✅ Mock ApiClient with configurable responses
- ✅ Mock localStorage for VerificationHistoryService
- ✅ Error handling scenarios (ApiError types)
- ✅ Edge cases (missing filePath, extension handling)

**Coverage Gaps:**
- [ ] AC-31.2.2: Canvas file creation (server-side, needs backend test)
- [ ] AC-31.2.4: Auto-open verification (requires Obsidian integration test)

### Refactoring Performed

**None** - This is a pre-implementation review. Code is already complete and functional.

### Compliance Check

- Coding Standards: ✓ Follows project patterns
- Project Structure: ✓ Correct file locations
- Testing Strategy: ✓ Unit tests exist
- All ACs Met: ✓ Yes (implementation complete)

### Improvements Checklist

**Story Documentation Updates Required:**

- [ ] **CRITICAL**: Update story Status from "Draft" to "Done"
- [ ] Update line reference from "L751-753" to "L764-834" in Dev Notes
- [ ] Update stub code example to show actual implementation
- [ ] Populate File List section with modified files:
  - `canvas-progress-tracker/obsidian-plugin/main.ts`
  - `canvas-progress-tracker/obsidian-plugin/tests/callbacks/generateVerificationCanvas.test.ts`
- [ ] Update OpenAPI spec `review-api.openapi.yml` to use correct field names

**Future Improvements (Non-blocking):**

- [ ] Add integration test for AC-31.2.4 (auto-open Canvas)
- [ ] Add backend test for AC-31.2.2 (file naming convention)
- [ ] Consider adding E2E test for full flow

### Security Review

**No security concerns identified.**

- ✅ No sensitive data exposure
- ✅ Input validation via TypeScript types
- ✅ Error messages don't leak implementation details

### Performance Considerations

- ✅ 150s timeout configured in ApiClient (appropriate for AI generation)
- ✅ Progress notice shown immediately (good UX)
- ⚠️ No cancellation mechanism for long-running generation

### Files Modified During Review

**None** - Pre-implementation review only.

**Files Already Implemented (for Dev to add to File List):**
1. `canvas-progress-tracker/obsidian-plugin/main.ts:764-834` - Core callback
2. `canvas-progress-tracker/obsidian-plugin/tests/callbacks/generateVerificationCanvas.test.ts` - Unit tests
3. `canvas-progress-tracker/obsidian-plugin/src/services/VerificationHistoryService.ts` - History tracking
4. `canvas-progress-tracker/obsidian-plugin/src/api/types.ts:570-582` - Type definitions

### Gate Status

**Gate: CONCERNS** → `docs/qa/gates/31.2-verification-canvas-e2e.yml`

**Reason**: Implementation is complete and functional, but story metadata is severely outdated. Documentation must be synchronized before marking as Done.

### Recommended Status

**✗ Changes Required - See unchecked items above**

Before moving to Done:
1. Update story Status to reflect actual implementation state
2. Fix outdated line references in Dev Notes
3. Populate File List with implemented files
4. Update OpenAPI spec to match actual field names
