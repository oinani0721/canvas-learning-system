# Story 21.4: APIå“åº”è§£ææ—¥å¿—å’Œfallback

## Status
ğŸ”„ In Development

## Story

**As a** å¼€å‘è€…,
**I want** èƒ½å¤Ÿè¿½è¸ªæ¯æ¬¡Agentè°ƒç”¨çš„å®Œæ•´æµç¨‹,
**so that** åœ¨å‡ºç°é—®é¢˜æ—¶å¿«é€Ÿå®šä½åŸå› ã€‚

## Acceptance Criteria

1. AC-21.4.1: æ¯æ¬¡Agentè°ƒç”¨è®°å½•requestå’Œresponseæ‘˜è¦
2. AC-21.4.2: è§£æå¤±è´¥æ—¶è®°å½•å®Œæ•´response (æˆªæ–­åˆ°500å­—ç¬¦)
3. AC-21.4.3: æ·»åŠ ç»“æ„åŒ–æ—¥å¿—å­—æ®µ (agent_type, node_id, success, latency)
4. AC-21.4.4: æ—¥å¿—çº§åˆ«å¯é…ç½® (DEBUG/INFO/WARNING)

## Tasks / Subtasks

- [ ] Task 1: å®ç°ç»“æ„åŒ–æ—¥å¿— (AC: 3)
  - [ ] å®šä¹‰AgentCallLogæ•°æ®ç»“æ„
  - [ ] æ·»åŠ agent_typeå­—æ®µ
  - [ ] æ·»åŠ node_idå­—æ®µ
  - [ ] æ·»åŠ successå­—æ®µ
  - [ ] æ·»åŠ latency_mså­—æ®µ

- [ ] Task 2: æ·»åŠ requestæ—¥å¿— (AC: 1)
  - [ ] è®°å½•è¯·æ±‚å¼€å§‹æ—¶é—´
  - [ ] è®°å½•è¯·æ±‚å‚æ•°æ‘˜è¦
  - [ ] è®°å½•ç›®æ ‡èŠ‚ç‚¹ä¿¡æ¯

- [ ] Task 3: æ·»åŠ responseæ—¥å¿— (AC: 1, 2)
  - [ ] è®°å½•å“åº”æ—¶é—´
  - [ ] è®°å½•å“åº”é•¿åº¦
  - [ ] å¤±è´¥æ—¶è®°å½•å®Œæ•´response (æˆªæ–­)

- [ ] Task 4: å®ç°æ—¥å¿—çº§åˆ«é…ç½® (AC: 4)
  - [ ] æ·»åŠ é…ç½®é¡¹
  - [ ] æ”¯æŒDEBUG/INFO/WARNINGçº§åˆ«
  - [ ] æ”¯æŒç¯å¢ƒå˜é‡è¦†ç›–

- [ ] Task 5: ç¼–å†™æµ‹è¯•
  - [ ] æµ‹è¯•æ­£å¸¸è°ƒç”¨æ—¥å¿—
  - [ ] æµ‹è¯•å¤±è´¥è°ƒç”¨æ—¥å¿—
  - [ ] æµ‹è¯•æ—¥å¿—çº§åˆ«é…ç½®

## Dev Notes

### æ¶æ„ä¸Šä¸‹æ–‡

**é—®é¢˜èƒŒæ™¯** [Source: docs/prd/EPIC-21-AGENT-E2E-FLOW-FIX.md#story-21-4]

å½“Agentä¸è¿”å›ç»“æœæ—¶ï¼Œéš¾ä»¥è¿½è¸ªé—®é¢˜åŸå› ã€‚éœ€è¦ç»“æ„åŒ–æ—¥å¿—æ¥è¾…åŠ©è°ƒè¯•ã€‚

### å®ç°å‚è€ƒ

**ç»“æ„åŒ–æ—¥å¿—ç¤ºä¾‹**:

```python
# backend/app/services/agent_service.py

import time
import logging
from typing import Any, Dict, Optional

logger = logging.getLogger(__name__)

class AgentCallLogger:
    """Agentè°ƒç”¨æ—¥å¿—è®°å½•å™¨"""

    def __init__(self, agent_type: str, node_id: str):
        self.agent_type = agent_type
        self.node_id = node_id
        self.start_time = time.time()
        self.extra = {
            "agent_type": agent_type,
            "node_id": node_id
        }

    def log_request(self, request_params: Dict[str, Any]) -> None:
        """è®°å½•è¯·æ±‚ä¿¡æ¯"""
        logger.info(
            f"Agent call started: {self.agent_type}",
            extra={
                **self.extra,
                "request_params": self._summarize(request_params)
            }
        )

    def log_response(
        self,
        response: Any,
        success: bool,
        response_length: int = 0
    ) -> None:
        """è®°å½•å“åº”ä¿¡æ¯"""
        latency_ms = int((time.time() - self.start_time) * 1000)

        log_data = {
            **self.extra,
            "success": success,
            "latency_ms": latency_ms,
            "response_length": response_length
        }

        if success:
            logger.info(
                f"Agent call completed: {self.agent_type}",
                extra=log_data
            )
        else:
            # å¤±è´¥æ—¶è®°å½•æ›´å¤šè¯¦æƒ…
            log_data["response_preview"] = self._truncate(str(response), 500)
            logger.warning(
                f"Agent call failed: {self.agent_type}",
                extra=log_data
            )

    def log_error(self, error: Exception) -> None:
        """è®°å½•é”™è¯¯ä¿¡æ¯"""
        latency_ms = int((time.time() - self.start_time) * 1000)

        logger.error(
            f"Agent call error: {self.agent_type}",
            extra={
                **self.extra,
                "latency_ms": latency_ms,
                "error_type": type(error).__name__,
                "error_message": str(error)
            },
            exc_info=True
        )

    @staticmethod
    def _summarize(data: Dict[str, Any], max_length: int = 200) -> str:
        """ç”Ÿæˆæ•°æ®æ‘˜è¦"""
        summary = str(data)
        if len(summary) > max_length:
            return summary[:max_length] + "..."
        return summary

    @staticmethod
    def _truncate(text: str, max_length: int = 500) -> str:
        """æˆªæ–­æ–‡æœ¬"""
        if len(text) > max_length:
            return text[:max_length] + "... [truncated]"
        return text
```

**ä½¿ç”¨ç¤ºä¾‹**:

```python
async def decompose_basic(
    self,
    content: str,
    source_x: int,
    source_y: int,
    **kwargs
) -> Dict[str, Any]:
    """åŸºç¡€æ‹†è§£"""
    call_logger = AgentCallLogger("decompose_basic", kwargs.get("node_id", "unknown"))

    try:
        # è®°å½•è¯·æ±‚
        call_logger.log_request({
            "content_length": len(content),
            "source_position": (source_x, source_y)
        })

        # è°ƒç”¨AI
        response = await self._call_ai(content)

        # æå–ç»“æœ
        text, success = extract_explanation_text(response)

        # è®°å½•å“åº”
        call_logger.log_response(
            response=response,
            success=success,
            response_length=len(text) if text else 0
        )

        if not success:
            return create_error_response(...)

        return {...}

    except Exception as e:
        call_logger.log_error(e)
        raise
```

**æ—¥å¿—é…ç½®**:

```python
# backend/app/config.py

class Settings:
    # Agentæ—¥å¿—é…ç½®
    AGENT_LOG_LEVEL: str = os.getenv("AGENT_LOG_LEVEL", "INFO")
    AGENT_LOG_RESPONSE_ON_SUCCESS: bool = os.getenv("AGENT_LOG_RESPONSE_ON_SUCCESS", "false").lower() == "true"
    AGENT_LOG_TRUNCATE_LENGTH: int = int(os.getenv("AGENT_LOG_TRUNCATE_LENGTH", "500"))
```

### å…³é”®æ–‡ä»¶

- `backend/app/services/agent_service.py` - ä¸»è¦ä¿®æ”¹
- `backend/app/utils/logging.py` - æ–°å¢æ—¥å¿—å·¥å…·
- `backend/app/config.py` - æ·»åŠ é…ç½®é¡¹

### æµ‹è¯•è¦æ±‚

**å•å…ƒæµ‹è¯•è¦†ç›–**:
- æµ‹è¯•æ­£å¸¸è°ƒç”¨çš„æ—¥å¿—è®°å½•
- æµ‹è¯•å¤±è´¥è°ƒç”¨çš„æ—¥å¿—è®°å½•
- æµ‹è¯•å¼‚å¸¸çš„æ—¥å¿—è®°å½•
- æµ‹è¯•æ–‡æœ¬æˆªæ–­åŠŸèƒ½
- æµ‹è¯•æ—¥å¿—çº§åˆ«é…ç½®

## SDDè§„èŒƒå¼•ç”¨

- **æ¶æ„æ–‡æ¡£**: `docs/prd/EPIC-21-AGENT-E2E-FLOW-FIX.md#story-21-4`

## ADRå…³è”

æ— ç›´æ¥å…³è”çš„ADRã€‚æ­¤ Story ä¸º Bug Fixï¼Œä¸æ¶‰åŠæ¶æ„å†³ç­–å˜æ›´ã€‚

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-12 | 1.0 | åˆå§‹Storyåˆ›å»º | SM Agent (Bob) |
