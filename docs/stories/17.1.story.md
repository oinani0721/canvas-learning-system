# Story 17.1: 基础监控 - FastAPI性能中间件和Prometheus指标端点

## Status
Draft

## Story

**As a** Canvas Learning System运维人员和开发者,
**I want** 有一个基础的性能监控系统，包括FastAPI请求追踪中间件和Prometheus格式指标端点,
**so that** 我可以实时监控API请求量、响应延迟和错误率，为后续深度监控和告警系统奠定基础。

## Acceptance Criteria

1. FastAPI性能中间件：每个API请求自动记录方法、端点、状态码和响应时间
2. 请求计数指标：`canvas_api_requests_total` Counter指标按method/endpoint/status分组
3. 延迟指标：`canvas_api_request_latency_seconds` Histogram指标按method/endpoint分组
4. 并发请求指标：`canvas_api_concurrent_requests` Gauge指标实时反映并发请求数
5. `/metrics`端点：返回Prometheus格式文本，可被Prometheus服务器抓取
6. `/metrics/summary`端点：返回JSON格式MetricsSummary，包含api字段统计
7. 日志集成：中间件与structlog日志协同记录请求追踪信息（遵循ADR-010）
8. 所有代码包含文档来源标注(Context7/Skill/ADR验证)

## Tasks / Subtasks

- [ ] Task 1: 性能中间件实现 (AC: 1, 2, 3, 4)
  - [ ] 创建 `backend/app/middleware/metrics.py`
  - [ ] 定义 `REQUEST_COUNT` Counter指标 (labels: method, endpoint, status)
  - [ ] 定义 `REQUEST_LATENCY` Histogram指标 (labels: method, endpoint)
  - [ ] 定义 `CONCURRENT_REQUESTS` Gauge指标
  - [ ] 实现 `metrics_middleware` HTTP中间件
  - [ ] 在 `backend/app/main.py` 中注册中间件

- [ ] Task 2: Prometheus指标端点实现 (AC: 5)
  - [ ] 修改 `backend/app/api/v1/endpoints/health.py` 添加metrics端点
  - [ ] 实现 `GET /metrics` 返回Prometheus格式文本
  - [ ] 使用 `prometheus_client.generate_latest()` 生成指标
  - [ ] 配置正确的 `text/plain` Content-Type

- [ ] Task 3: MetricsSummary端点实现 (AC: 6)
  - [ ] 创建 `backend/app/services/metrics_collector.py`
  - [ ] 实现 `get_api_metrics_summary()` 方法
  - [ ] 实现 `GET /metrics/summary` 端点返回JSON
  - [ ] 定义 `MetricsSummary` Pydantic模型（遵循OpenAPI Schema）

- [ ] Task 4: 日志集成 (AC: 7)
  - [ ] 在中间件中使用structlog记录请求开始/完成
  - [ ] 添加request_id上下文变量便于追踪
  - [ ] 确保日志格式符合ADR-010规范

- [ ] Task 5: 测试和验证 (AC: 8)
  - [ ] 创建 `tests/unit/test_metrics_middleware.py`
  - [ ] 创建 `tests/integration/test_metrics_endpoints.py`
  - [ ] 验证Prometheus格式输出正确
  - [ ] 验证MetricsSummary Schema符合OpenAPI规范
  - [ ] 确认所有代码有文档来源标注

## Dev Notes

### 技术验证报告 (Step 3.6)

**验证完成时间**: 2025-12-03
**验证执行人**: SM Agent (Bob)
**Quality Gate状态**: Pending

#### 技术栈清单

| 技术栈 | 查询方式 | 验证状态 | 文档位置 |
|--------|---------|---------|----------|
| prometheus_client | Context7 | 待验证 | /prometheus/client_python |
| FastAPI Middleware | Context7 | 待验证 | /fastapi/fastapi |
| structlog | Local ADR | 已验证 | ADR-010-LOGGING-AGGREGATION-STRUCTLOG.md |
| time.perf_counter | Python stdlib | 已验证 | 标准库 |

#### 核心API验证待办

**开发前必须验证**:
- [ ] prometheus_client Counter, Histogram, Gauge → Context7: /prometheus/client_python
- [ ] prometheus_client generate_latest() → Context7: /prometheus/client_python
- [ ] prometheus_client REGISTRY → Context7: /prometheus/client_python
- [ ] FastAPI app.middleware("http") → Context7: /fastapi/fastapi
- [ ] FastAPI Response with media_type → Context7: /fastapi/fastapi
- [ ] structlog get_logger() and bind() → ADR-010:77-100

### SDD规范参考 (必填)

**API端点规范** (Epic 17 Monitoring):
- `GET /metrics` - 获取Prometheus格式指标
  - [Source: specs/api/canvas-api.openapi.yml:605-628]
  - operationId: `getMetrics`
  - 响应格式: `text/plain` (Prometheus格式)
  - 本Story实现指标:
    - `canvas_api_requests_total` (Counter, labels: method, endpoint, status)
    - `canvas_api_request_latency_seconds` (Histogram, labels: method, endpoint)
    - `canvas_api_concurrent_requests` (Gauge)

- `GET /metrics/summary` - 获取JSON格式指标摘要
  - [Source: specs/api/canvas-api.openapi.yml:630-642]
  - operationId: `getMetricsSummary`
  - 响应Schema: `MetricsSummary`

**MetricsSummary Schema** (本Story实现的字段):
- [Source: specs/api/canvas-api.openapi.yml:987-1060]
- 本Story实现的字段:
  - `timestamp`: ISO8601时间戳 (string, format: date-time)
  - `api.requests_total`: 总请求数 (integer)
  - `api.requests_per_second`: 每秒请求数 (number)
  - `api.avg_latency_ms`: 平均延迟ms (number)
  - `api.p95_latency_ms`: P95延迟ms (number)
  - `api.error_rate`: 错误率 (number)

### ADR决策关联 (必填)

| ADR编号 | 决策标题 | 对Story的影响 |
|---------|----------|---------------|
| ADR-0009 | Error Handling & Retry | 错误状态码遵循ErrorCode体系分类 |
| ADR-0010 | Logging Aggregation | 日志使用structlog JSON+文本双格式 |

**关键约束**:
- 日志格式必须遵循ADR-010: structlog JSON + 文本双格式
- 错误状态码(5xx)记录需要与ADR-009错误体系一致
- 中间件必须不阻塞请求处理

### 架构设计参考

**架构文档引用**:
- 监控架构图: [Source: docs/architecture/performance-monitoring-architecture.md:87-124]
- FastAPI中间件实现: [Source: docs/architecture/performance-monitoring-architecture.md:140-198]
- 指标体系定义: [Source: docs/architecture/performance-monitoring-architecture.md:49-84]
- 实施计划Phase 1: [Source: docs/architecture/performance-monitoring-architecture.md:490-494]

**核心性能指标 (KPIs)**:
| 指标类别 | 指标名称 | 目标值 | 告警阈值 |
|---------|---------|--------|---------|
| API响应 | 单API请求响应时间 | <500ms | >1000ms |
| 错误率 | API错误率 | <1% | >5% |

### 代码示例库

**性能中间件实现** (Source: docs/architecture/performance-monitoring-architecture.md:140-198):
```python
# backend/app/middleware/metrics.py
# ✅ Verified from Architecture Doc (performance-monitoring-architecture.md:140-198)
# ⚠️ prometheus_client API需Context7验证: /prometheus/client_python
import time
from fastapi import Request
from prometheus_client import Counter, Histogram, Gauge
import structlog

logger = structlog.get_logger(__name__)

# 定义Prometheus指标
REQUEST_COUNT = Counter(
    'canvas_api_requests_total',
    'Total API requests',
    ['method', 'endpoint', 'status']
)

REQUEST_LATENCY = Histogram(
    'canvas_api_request_latency_seconds',
    'API request latency',
    ['method', 'endpoint'],
    buckets=[0.01, 0.05, 0.1, 0.25, 0.5, 1.0, 2.5, 5.0, 10.0]
)

CONCURRENT_REQUESTS = Gauge(
    'canvas_api_concurrent_requests',
    'Number of concurrent requests'
)

async def metrics_middleware(request: Request, call_next):
    """性能监控中间件

    [Source: docs/architecture/performance-monitoring-architecture.md:169-197]
    """
    CONCURRENT_REQUESTS.inc()
    start_time = time.perf_counter()

    # 绑定request_id到日志上下文
    request_id = request.headers.get("X-Request-ID", str(id(request)))
    structlog.contextvars.bind_contextvars(request_id=request_id)

    logger.info(
        "request.started",
        method=request.method,
        path=request.url.path
    )

    try:
        response = await call_next(request)
        status = response.status_code
    except Exception as e:
        status = 500
        logger.exception("request.error", error=str(e))
        raise
    finally:
        duration = time.perf_counter() - start_time
        CONCURRENT_REQUESTS.dec()

        # 记录指标
        REQUEST_COUNT.labels(
            method=request.method,
            endpoint=request.url.path,
            status=str(status)
        ).inc()

        REQUEST_LATENCY.labels(
            method=request.method,
            endpoint=request.url.path
        ).observe(duration)

        logger.info(
            "request.completed",
            method=request.method,
            path=request.url.path,
            status=status,
            duration_ms=round(duration * 1000, 2)
        )

    return response
```

**Prometheus指标端点** (Source: specs/api/canvas-api.openapi.yml:605-628):
```python
# backend/app/api/v1/endpoints/health.py (扩展)
# ✅ Verified from OpenAPI Spec (canvas-api.openapi.yml:605-628)
# ⚠️ prometheus_client generate_latest需Context7验证
from fastapi import APIRouter
from fastapi.responses import PlainTextResponse
from prometheus_client import generate_latest, CONTENT_TYPE_LATEST

router = APIRouter()

@router.get(
    "/metrics",
    response_class=PlainTextResponse,
    summary="获取Prometheus格式指标",
    operation_id="getMetrics",
    tags=["Monitoring"]
)
async def get_metrics():
    """
    返回Prometheus格式的性能指标。

    [Source: specs/api/canvas-api.openapi.yml:605-628]
    """
    return PlainTextResponse(
        content=generate_latest(),
        media_type=CONTENT_TYPE_LATEST
    )
```

**MetricsSummary端点** (Source: specs/api/canvas-api.openapi.yml:630-642):
```python
# backend/app/api/v1/endpoints/health.py (扩展)
# ✅ Verified from OpenAPI Spec (canvas-api.openapi.yml:630-642, 987-1060)
from datetime import datetime, timezone
from app.services.metrics_collector import get_api_metrics_summary

@router.get(
    "/metrics/summary",
    response_model=MetricsSummary,
    summary="获取指标摘要",
    operation_id="getMetricsSummary",
    tags=["Monitoring"]
)
async def get_metrics_summary():
    """
    返回JSON格式的性能指标摘要。

    [Source: specs/api/canvas-api.openapi.yml:630-642]
    """
    return MetricsSummary(
        timestamp=datetime.now(timezone.utc),
        api=get_api_metrics_summary()
    )
```

**MetricsSummary Pydantic模型** (Source: specs/api/canvas-api.openapi.yml:987-1011):
```python
# backend/app/models/metrics.py
# ✅ Verified from OpenAPI Spec (canvas-api.openapi.yml:987-1011)
from pydantic import BaseModel
from datetime import datetime
from typing import Optional

class ApiMetrics(BaseModel):
    """API指标摘要"""
    requests_total: int
    requests_per_second: float
    avg_latency_ms: float
    p95_latency_ms: float
    error_rate: float

class MetricsSummary(BaseModel):
    """性能指标摘要 (本Story仅实现api字段)

    [Source: specs/api/canvas-api.openapi.yml:987-1060]
    """
    timestamp: datetime
    api: ApiMetrics
    # 以下字段由后续Story实现:
    # agents: Optional[AgentMetrics] = None  # Story 17.2
    # memory_system: Optional[MemoryMetrics] = None  # Story 17.2
    # resources: Optional[ResourceMetrics] = None  # Story 17.2
```

**MetricsCollector服务** (新增):
```python
# backend/app/services/metrics_collector.py
# ✅ Verified from Architecture Doc + OpenAPI Spec
from prometheus_client import REGISTRY
from typing import Dict, Any
import time

# 记录启动时间用于计算RPS
_start_time = time.time()

def get_api_metrics_summary() -> Dict[str, Any]:
    """获取API指标摘要

    从Prometheus REGISTRY读取指标并计算统计值。

    Returns:
        API指标字典，包含requests_total, requests_per_second等
    """
    requests_total = 0
    error_count = 0
    latency_sum = 0
    latency_count = 0
    latencies = []

    for metric in REGISTRY.collect():
        if metric.name == 'canvas_api_requests_total':
            for sample in metric.samples:
                if sample.name.endswith('_total'):
                    count = int(sample.value)
                    requests_total += count
                    status = sample.labels.get('status', '200')
                    if status.startswith('5'):
                        error_count += count

        elif metric.name == 'canvas_api_request_latency_seconds':
            for sample in metric.samples:
                if sample.name.endswith('_sum'):
                    latency_sum += sample.value
                elif sample.name.endswith('_count'):
                    latency_count += int(sample.value)

    # 计算统计值
    elapsed = time.time() - _start_time
    rps = requests_total / elapsed if elapsed > 0 else 0
    avg_latency = (latency_sum / latency_count * 1000) if latency_count > 0 else 0
    error_rate = error_count / requests_total if requests_total > 0 else 0

    return {
        "requests_total": requests_total,
        "requests_per_second": round(rps, 2),
        "avg_latency_ms": round(avg_latency, 2),
        "p95_latency_ms": 0,  # 需要从Histogram bucket计算，简化实现
        "error_rate": round(error_rate, 4)
    }
```

### 文件路径参考

**需要新增的文件**:
- 新增: `backend/app/middleware/metrics.py` - 性能监控中间件
- 新增: `backend/app/services/metrics_collector.py` - 指标收集服务
- 新增: `backend/app/models/metrics.py` - MetricsSummary模型
- 新增: `tests/unit/test_metrics_middleware.py`
- 新增: `tests/integration/test_metrics_endpoints.py`

**需要修改的文件**:
- 修改: `backend/app/main.py` - 注册metrics_middleware
- 修改: `backend/app/api/v1/endpoints/health.py` - 添加/metrics和/metrics/summary端点
- 修改: `backend/app/api/v1/router.py` - 注册新端点路由

**现有文件参考**:
- 健康检查端点: `backend/app/api/v1/endpoints/health.py`
- 日志配置: `backend/app/core/logging.py`
- 现有中间件: `backend/app/middleware/logging_middleware.py`
- 主应用入口: `backend/app/main.py`

### 依赖关系

**前置Story**:
- 无（本Story是Epic 17的第一个Story）

**后续影响**:
- Story 17.2: 深度监控 - Agent和记忆系统性能追踪（依赖本Story的基础指标和中间件）
- Story 17.3: 告警和Dashboard（依赖本Story的/metrics端点）
- Story 17.4: 性能优化策略实施（依赖本Story的指标识别瓶颈）
- Story 17.5: E2E测试（依赖本Story的完整指标端点）

### Python依赖

**需要添加到pyproject.toml**:
```toml
[project.dependencies]
prometheus-client = ">=0.17.0"  # Prometheus指标库
```

### Definition of Done

- [ ] 所有AC通过验收测试
- [ ] `metrics_middleware` 已注册到FastAPI应用
- [ ] `/metrics` 端点返回正确的Prometheus格式
- [ ] `/metrics/summary` 端点返回符合Schema的JSON
- [ ] 中间件与structlog日志协同工作
- [ ] 单元测试覆盖率≥90%
- [ ] 集成测试通过
- [ ] 代码Review通过
- [ ] 所有代码有文档来源标注

### 风险和缓解

| 风险 | 概率 | 影响 | 缓解措施 |
|------|------|------|---------|
| prometheus_client与FastAPI集成问题 | 低 | 中 | Context7验证API，参考官方示例 |
| 中间件性能开销 | 低 | 低 | 使用time.perf_counter()，避免阻塞 |
| 指标基数过高 | 中 | 低 | 限制endpoint label到路由模式而非完整路径 |
| P95延迟计算复杂 | 中 | 低 | 初始版本简化，后续Story优化 |

### 估算

- **Story Points**: 3
- **预估工时**: 1-2天
- **复杂度**: 低-中（主要是中间件和端点实现）

---

**文档版本**: v1.0.0
**创建时间**: 2025-12-03
**创建者**: SM Agent (Bob)
**Epic**: Epic 17 - 性能优化和监控
