# Story 13.1: Pluginé¡¹ç›®åˆå§‹åŒ–

## Status
Draft

## Story

**As a** Canvas Learning Systemå¼€å‘è€…,
**I want** åˆ›å»ºObsidian Pluginçš„åŸºç¡€é¡¹ç›®ç»“æ„å’Œé…ç½®,
**so that** åç»­çš„PluginåŠŸèƒ½å¼€å‘æœ‰ç»Ÿä¸€çš„é¡¹ç›®æ¡†æ¶å’Œæ„å»ºç³»ç»ŸåŸºç¡€ã€‚

## Acceptance Criteria

1. æ’ä»¶ç›®å½•ç»“æ„å·²åˆ›å»ºï¼Œç¬¦åˆObsidian Pluginæ ‡å‡†è§„èŒƒ
2. `manifest.json`å·²åˆ›å»ºï¼ŒåŒ…å«æ­£ç¡®çš„æ’ä»¶å…ƒæ•°æ®ï¼ˆid, name, version, minAppVersionç­‰ï¼‰
3. `main.ts`å·²åˆ›å»ºï¼ŒåŒ…å«åŸºç¡€Pluginç±»å®šä¹‰ï¼ˆç»§æ‰¿Pluginï¼Œå®ç°onload/onunloadï¼‰
4. TypeScripté…ç½®æ–‡ä»¶ï¼ˆ`tsconfig.json`ï¼‰å·²æ­£ç¡®é…ç½®
5. esbuildæ„å»ºé…ç½®ï¼ˆ`esbuild.config.mjs`ï¼‰å·²å®ç°ï¼Œæ”¯æŒå¼€å‘/ç”Ÿäº§æ„å»º
6. `package.json`å·²åˆ›å»ºï¼ŒåŒ…å«æ‰€æœ‰å¿…éœ€ä¾èµ–å’Œæ„å»ºè„šæœ¬
7. `.gitignore`å·²é…ç½®ï¼Œæ’é™¤node_moduleså’Œæ„å»ºäº§ç‰©
8. æ’ä»¶å¯é€šè¿‡`npm run dev`å¯åŠ¨å¼€å‘æ¨¡å¼
9. æ’ä»¶å¯é€šè¿‡`npm run build`ç”Ÿæˆç”Ÿäº§æ„å»º
10. ç”Ÿæˆçš„`main.js`å¯è¢«ObsidianåŠ è½½å¹¶æ˜¾ç¤ºåœ¨Community Pluginsåˆ—è¡¨ä¸­
11. æ‰€æœ‰ä»£ç åŒ…å«æ–‡æ¡£æ¥æºæ ‡æ³¨ï¼ˆé›¶å¹»è§‰å¼€å‘è§„èŒƒï¼‰

## Tasks / Subtasks

- [ ] Task 1: åˆ›å»ºé¡¹ç›®ç›®å½•ç»“æ„ (AC: 1)
  - [ ] åˆ›å»º `plugin/` ç›®å½•
  - [ ] åˆ›å»º `plugin/src/` æºä»£ç ç›®å½•
  - [ ] åˆ›å»º `plugin/src/types/` ç±»å‹å®šä¹‰ç›®å½•
  - [ ] åˆ›å»º `.gitignore` æ’é™¤é…ç½®

- [ ] Task 2: åˆ›å»ºæ’ä»¶æ¸…å•æ–‡ä»¶ (AC: 2)
  - [ ] åˆ›å»º `plugin/manifest.json`
  - [ ] é…ç½®id: "canvas-learning-system"
  - [ ] é…ç½®name, version, minAppVersion, description, author
  - [ ] è®¾ç½®isDesktopOnlyä¸ºfalseï¼ˆæ”¯æŒç§»åŠ¨ç«¯ï¼‰

- [ ] Task 3: é…ç½®TypeScriptç¯å¢ƒ (AC: 4, 6)
  - [ ] åˆ›å»º `plugin/tsconfig.json`
  - [ ] é…ç½®target: ES6, module: ESNext
  - [ ] é…ç½®strictæ¨¡å¼å’Œå¿…è¦çš„ç¼–è¯‘å™¨é€‰é¡¹
  - [ ] åˆ›å»º `plugin/package.json` åŒ…å«ä¾èµ–

- [ ] Task 4: é…ç½®esbuildæ„å»ºç³»ç»Ÿ (AC: 5, 8, 9)
  - [ ] åˆ›å»º `plugin/esbuild.config.mjs`
  - [ ] é…ç½®å¼€å‘æ¨¡å¼ï¼ˆwatch + sourcemapsï¼‰
  - [ ] é…ç½®ç”Ÿäº§æ¨¡å¼ï¼ˆminifyï¼‰
  - [ ] é…ç½®å¤–éƒ¨ä¾èµ–ï¼ˆobsidian, @codemirror/*ç­‰ï¼‰

- [ ] Task 5: å®ç°åŸºç¡€Pluginç±» (AC: 3, 10)
  - [ ] åˆ›å»º `plugin/src/main.ts`
  - [ ] å®ç°CanvasLearningPluginç±»ï¼ˆç»§æ‰¿Pluginï¼‰
  - [ ] å®ç°async onload()æ–¹æ³•
  - [ ] å®ç°onunload()æ–¹æ³•
  - [ ] æ·»åŠ console.logç¡®è®¤åŠ è½½æˆåŠŸ

- [ ] Task 6: éªŒè¯å’Œæµ‹è¯• (AC: 10, 11)
  - [ ] è¿è¡Œnpm installå®‰è£…ä¾èµ–
  - [ ] è¿è¡Œnpm run buildç”Ÿæˆmain.js
  - [ ] åœ¨Obsidianæµ‹è¯•Vaultä¸­å®‰è£…æ’ä»¶
  - [ ] éªŒè¯æ’ä»¶å‡ºç°åœ¨Community Pluginsåˆ—è¡¨
  - [ ] éªŒè¯æ§åˆ¶å°æ˜¾ç¤ºåŠ è½½æ—¥å¿—
  - [ ] ç¡®è®¤æ‰€æœ‰ä»£ç æœ‰æ–‡æ¡£æ¥æºæ ‡æ³¨

## Dev Notes

### ğŸ“‹ æŠ€æœ¯éªŒè¯æŠ¥å‘Š (Step 3.6)

**éªŒè¯å®Œæˆæ—¶é—´**: 2025-11-30
**éªŒè¯æ‰§è¡Œäºº**: SM Agent
**Quality GateçŠ¶æ€**: âœ… PASSED

#### æŠ€æœ¯æ ˆæ¸…å•

| æŠ€æœ¯æ ˆ | æŸ¥è¯¢æ–¹å¼ | éªŒè¯çŠ¶æ€ | æ–‡æ¡£ä½ç½® |
|--------|---------|---------|----------|
| Obsidian Plugin API | Skill | âœ… å·²éªŒè¯ | @obsidian-canvas Skill |
| TypeScript | å†…ç½®çŸ¥è¯† | âœ… å·²éªŒè¯ | TypeScriptå®˜æ–¹æ–‡æ¡£ |
| esbuild | æ¶æ„æ–‡æ¡£ | âœ… å·²éªŒè¯ | obsidian-plugin-architecture.md |

#### æ ¸å¿ƒAPIéªŒè¯ç»“æœ

**Obsidian PluginåŸºç¡€ç±»**:
- âœ… `Plugin` åŸºç±» â†’ Verified from @obsidian-canvas Skill (SKILL.md - Plugin Development)
  - æ¥æº: `import { Plugin } from 'obsidian';`
  - å¿…é¡»å®ç°: `onload(): Promise<void>`, `onunload(): void`
  - å¯é€‰æ–¹æ³•: `addCommand()`, `addRibbonIcon()`, `addSettingTab()`, `registerEvent()`

**manifest.jsonè§„èŒƒ**:
- âœ… manifestç»“æ„ â†’ Verified from @obsidian-canvas Skill (Quick Reference #9)
  - å¿…éœ€å­—æ®µ: `id`, `name`, `version`, `minAppVersion`
  - å¯é€‰å­—æ®µ: `description`, `author`, `authorUrl`, `isDesktopOnly`
  - minAppVersionè¦æ±‚: â‰¥1.1.0ï¼ˆCanvasæ”¯æŒç‰ˆæœ¬ï¼‰

**æ„å»ºç³»ç»Ÿ**:
- âœ… esbuildé…ç½® â†’ Verified from docs/architecture/obsidian-plugin-architecture.md#æ„å»ºé…ç½®
  - å¤–éƒ¨ä¾èµ–: `['obsidian', 'electron', '@codemirror/*', '@lezer/*']`
  - è¾“å‡ºæ ¼å¼: CommonJS (format: 'cjs')

### SDDè§„èŒƒå‚è€ƒ (å¿…å¡«)

**APIç«¯ç‚¹è§„èŒƒ**:
- N/Aï¼ˆæœ¬Storyä¸ºå‰ç«¯Pluginåˆå§‹åŒ–ï¼Œä¸æ¶‰åŠAPIç«¯ç‚¹ï¼‰

**æ•°æ®Schemaè§„èŒƒ**:
- CanvasDataç»“æ„:
  - [Source: specs/data/canvas-data.schema.json]
  - å­—æ®µ: `nodes: CanvasNode[]`, `edges: CanvasEdge[]`
- CanvasNodeç»“æ„:
  - [Source: specs/data/canvas-node.schema.json]
  - å­—æ®µ: `id`, `type`, `x`, `y`, `width`, `height`, `text?`, `color?`, `file?`

### æŠ€æœ¯çº¦æŸ (æ¶æ„æ–‡æ¡£å¼•ç”¨)

**æ¶æ„è®¾è®¡å‚è€ƒ**:
- æ’ä»¶æ¶æ„: [Source: docs/architecture/obsidian-plugin-architecture.md]
- ç›®å½•ç»“æ„: [Source: docs/architecture/obsidian-plugin-architecture.md#8-ç›®å½•ç»“æ„]
- æ„å»ºç³»ç»Ÿ: [Source: docs/architecture/obsidian-plugin-architecture.md#9-æ„å»ºé…ç½®]

### ADRå†³ç­–å…³è” (å¿…å¡«)

| ADRç¼–å· | å†³ç­–æ ‡é¢˜ | å¯¹Storyçš„å½±å“ |
|---------|----------|---------------|
| ADR-001 | ä½¿ç”¨Obsidian Canvas | ç¡®è®¤ä½¿ç”¨Obsidian Pluginæ–¹å¼é›†æˆ |
| ADR-006 | å®æ—¶é€šä¿¡SSE+HTTP | Pluginéœ€è¦æ”¯æŒä¸åç«¯SSE+HTTPé€šä¿¡ |

**å…³é”®çº¦æŸ**:
- minAppVersionå¿…é¡»â‰¥1.4.0ï¼ˆCanvasäº‹ä»¶APIç¨³å®šç‰ˆæœ¬ï¼Œæ¥æº: obsidian-plugin-architecture.md#9.1ï¼‰
- Plugin IDå¿…é¡»å”¯ä¸€: `canvas-learning-system`
- æ‰€æœ‰æ–‡ä»¶æ“ä½œå¿…é¡»ä½¿ç”¨`app.vault` API

### ä»£ç ç¤ºä¾‹åº“

**manifest.jsonæ¨¡æ¿**:
```json
// âœ… Verified from obsidian-plugin-architecture.md#9.1 (SoT Level 2 - Architecture)
{
    "id": "canvas-learning-system",
    "name": "Canvas Learning System",
    "version": "0.1.0",
    "minAppVersion": "1.4.0",
    "description": "AI-powered learning system using Feynman method with Canvas",
    "author": "Canvas Learning Team",
    "isDesktopOnly": false
}
```

**åŸºç¡€Pluginç±»æ¨¡æ¿**:
```typescript
// âœ… Verified from @obsidian-canvas Skill (Quick Reference #10)
import { Plugin, Notice } from 'obsidian';

export default class CanvasLearningPlugin extends Plugin {
    async onload() {
        console.log('Loading Canvas Learning System plugin');

        // éªŒè¯Canvasæ”¯æŒ
        if (!this.app.workspace) {
            new Notice('Canvas Learning System: Workspace not available');
            return;
        }

        console.log('Canvas Learning System loaded successfully');
    }

    onunload() {
        console.log('Unloading Canvas Learning System plugin');
    }
}
```

**esbuildé…ç½®æ¨¡æ¿**:
```javascript
// âœ… Verified from docs/architecture/obsidian-plugin-architecture.md#9-æ„å»ºé…ç½®
import esbuild from "esbuild";
import process from "process";

const prod = process.argv[2] === "production";

const context = await esbuild.context({
    entryPoints: ["src/main.ts"],
    bundle: true,
    external: [
        "obsidian",
        "electron",
        "@codemirror/autocomplete",
        "@codemirror/collab",
        "@codemirror/commands",
        "@codemirror/language",
        "@codemirror/lint",
        "@codemirror/search",
        "@codemirror/state",
        "@codemirror/view",
        "@lezer/common",
        "@lezer/highlight",
        "@lezer/lr"
    ],
    format: "cjs",
    target: "es2018",
    logLevel: "info",
    sourcemap: prod ? false : "inline",
    treeShaking: true,
    outfile: "main.js",
    minify: prod
});

if (prod) {
    await context.rebuild();
    process.exit(0);
} else {
    await context.watch();
}
```

**tsconfig.jsonæ¨¡æ¿**:
```json
// âœ… Verified from Obsidian Sample Plugin (obsidian-sample-plugin)
{
    "compilerOptions": {
        "baseUrl": ".",
        "inlineSourceMap": true,
        "inlineSources": true,
        "module": "ESNext",
        "target": "ES6",
        "allowJs": true,
        "noImplicitAny": true,
        "moduleResolution": "node",
        "importHelpers": true,
        "isolatedModules": true,
        "strictNullChecks": true,
        "lib": ["DOM", "ES5", "ES6", "ES7"]
    },
    "include": ["src/**/*.ts"]
}
```

**package.jsonæ¨¡æ¿**:
```json
// âœ… Verified from Obsidian Sample Plugin
{
    "name": "canvas-learning-system",
    "version": "0.1.0",
    "description": "AI-powered learning system using Feynman method",
    "main": "main.js",
    "scripts": {
        "dev": "node esbuild.config.mjs",
        "build": "node esbuild.config.mjs production",
        "version": "node version-bump.mjs && git add manifest.json versions.json"
    },
    "devDependencies": {
        "@types/node": "^16.18.0",
        "typescript": "^5.0.0",
        "esbuild": "^0.17.0",
        "obsidian": "latest"
    }
}
```

### é¡¹ç›®ç»“æ„å‚è€ƒ

```
plugin/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ main.ts                    # æ’ä»¶å…¥å£ç‚¹ â­
â”‚   â”œâ”€â”€ types/
â”‚   â”‚   â””â”€â”€ canvas.d.ts            # Canvasç±»å‹å®šä¹‰ (Story 13.2)
â”‚   â”œâ”€â”€ services/                  # æœåŠ¡å±‚ (Story 13.3)
â”‚   â”œâ”€â”€ views/                     # è§†å›¾ç»„ä»¶ (åç»­Story)
â”‚   â””â”€â”€ commands/                  # å‘½ä»¤å®šä¹‰ (Story 13.4)
â”œâ”€â”€ manifest.json                  # æ’ä»¶æ¸…å• â­
â”œâ”€â”€ package.json                   # NPMé…ç½® â­
â”œâ”€â”€ tsconfig.json                  # TypeScripté…ç½® â­
â”œâ”€â”€ esbuild.config.mjs             # æ„å»ºé…ç½® â­
â”œâ”€â”€ .gitignore                     # Gitæ’é™¤ â­
â””â”€â”€ styles.css                     # æ ·å¼æ–‡ä»¶ (åç»­Story)
```

[Source: docs/architecture/obsidian-plugin-architecture.md#8-ç›®å½•ç»“æ„]

### Testing

**æµ‹è¯•æ–‡ä»¶ä½ç½®**: N/Aï¼ˆæœ¬Storyä¸ºé¡¹ç›®åˆå§‹åŒ–ï¼Œæ— å•å…ƒæµ‹è¯•ï¼‰

**é›†æˆæµ‹è¯•æ ‡å‡†**:
- æ’ä»¶èƒ½è¢«Obsidianè¯†åˆ«å¹¶åŠ è½½
- æ§åˆ¶å°æ˜¾ç¤º"Loading Canvas Learning System plugin"æ—¥å¿—
- æ§åˆ¶å°æ˜¾ç¤º"Canvas Learning System loaded successfully"æ—¥å¿—
- æ’ä»¶å‡ºç°åœ¨è®¾ç½®â†’Community Pluginsåˆ—è¡¨ä¸­

**æ‰‹åŠ¨éªŒè¯æ­¥éª¤**:
1. `cd plugin && npm install`
2. `npm run build`
3. å°†`manifest.json`å’Œ`main.js`å¤åˆ¶åˆ°Obsidian Vaultçš„`.obsidian/plugins/canvas-learning-system/`ç›®å½•
4. åœ¨Obsidianä¸­å¯ç”¨æ’ä»¶
5. æ£€æŸ¥å¼€å‘è€…æ§åˆ¶å°ï¼ˆCtrl+Shift+Iï¼‰æ—¥å¿—

[Source: docs/architecture/coding-standards.md#æµ‹è¯•è§„èŒƒ]

### æŠ€æœ¯çº¦æŸå’Œæ³¨æ„äº‹é¡¹

**ç‰ˆæœ¬çº¦æŸ**:
- Obsidian: â‰¥1.4.0 (Canvasäº‹ä»¶APIç¨³å®šç‰ˆæœ¬, æ¥æº: obsidian-plugin-architecture.md)
- Node.js: â‰¥16.0.0
- TypeScript: â‰¥5.0.0
- esbuild: â‰¥0.17.0

**å·²çŸ¥é™åˆ¶**:
- ç§»åŠ¨ç«¯æ”¯æŒéœ€è®¾ç½®`isDesktopOnly: false`
- Canvasäº‹ä»¶APIä»Obsidian 1.4.0+å¼€å§‹æ›´ç¨³å®š

**å®‰å…¨è€ƒè™‘**:
- ä½¿ç”¨`app.vault` APIè¿›è¡Œæ‰€æœ‰æ–‡ä»¶æ“ä½œï¼ˆä¸ä½¿ç”¨fsæ¨¡å—ï¼‰
- ä¸åœ¨manifestä¸­æš´éœ²æ•æ„Ÿä¿¡æ¯

### æ–‡ä»¶è·¯å¾„ç´¢å¼• (åå¹»è§‰éªŒè¯)

| ç›®æ ‡è·¯å¾„ | å­˜åœ¨çŠ¶æ€ | éªŒè¯æ–¹å¼ |
|----------|----------|----------|
| `plugin/` | å¾…åˆ›å»º | mkdir |
| `plugin/src/` | å¾…åˆ›å»º | mkdir |
| `plugin/manifest.json` | å¾…åˆ›å»º | æœ¬Storyåˆ›å»º |
| `plugin/main.ts` | å¾…åˆ›å»º | æœ¬Storyåˆ›å»º |
| `specs/data/canvas-node.schema.json` | âœ… å­˜åœ¨ | GlobéªŒè¯ |
| `docs/architecture/obsidian-plugin-architecture.md` | âœ… å­˜åœ¨ | ReadéªŒè¯ |

## Definition of Done

- [ ] æ‰€æœ‰Acceptance Criteriaæ»¡è¶³
- [ ] ä»£ç ç¬¦åˆdocs/architecture/coding-standards.mdè§„èŒƒ
- [ ] æ‰€æœ‰APIè°ƒç”¨æœ‰æ–‡æ¡£æ¥æºæ ‡æ³¨
- [ ] æ— console.erroræˆ–è­¦å‘Š
- [ ] æ’ä»¶å¯åœ¨Obsidianä¸­æ­£å¸¸åŠ è½½
- [ ] æ„å»ºäº§ç‰©ç”Ÿæˆæ­£ç¡®ï¼ˆmain.js, manifest.jsonï¼‰

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-30 | 1.0 | Initial story draft | SM Agent |

## Dev Agent Record

### Agent Model Used
(To be filled by Dev Agent)

### Debug Log References
(To be filled by Dev Agent)

### Completion Notes List
(To be filled by Dev Agent)

### Commit Info
(To be filled by Dev Agent)

### File List
(To be filled by Dev Agent)

## QA Results

(To be filled by QA Agent)
