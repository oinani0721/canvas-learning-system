# Story 34.3: 教材挂载前后端完整同步

<!-- Powered by BMAD Core -->

## Status

**Done**

---

## Story

**As a** Canvas学习用户,
**I want** 从跨Canvas Tab挂载教材时自动关联到当前选中的Canvas,
**so that** Agent分析时能自动获取教材上下文，提供更精准的学习辅助

---

## Acceptance Criteria

1. **AC1**: 从跨Canvas Tab挂载教材时自动关联到选中的Canvas
2. **AC2**: 后端 `.canvas-links.json` 正确写入教材关联
3. **AC3**: Agent调用时能获取教材上下文
4. **AC4**: PDF/Markdown/Canvas 三种格式均可挂载

---

## Tasks / Subtasks

- [ ] **Task 1: ReviewDashboardView 自动检测当前Canvas** (AC: 1)
  - [ ] 1.1 在 `ReviewDashboardView.ts` 中添加 `getCurrentCanvasPath()` 方法
  - [ ] 1.2 从 `this.plugin.app.workspace.getActiveFile()` 获取当前打开的Canvas
  - [ ] 1.3 验证文件扩展名为 `.canvas`
  - [ ] 1.4 如果无活动Canvas，提示用户先打开Canvas文件

- [ ] **Task 2: 教材挂载按钮集成Canvas上下文** (AC: 1, 2)
  - [ ] 2.1 修改挂载按钮点击事件，调用 `textbookMountService.setCurrentCanvasPath(canvasPath)`
  - [ ] 2.2 或改用 `mountTextbookForCanvas(filePath, canvasPath)` 方法
  - [ ] 2.3 确保在挂载前设置Canvas上下文，触发后端同步

- [ ] **Task 3: 验证后端同步逻辑** (AC: 2)
  - [ ] 3.1 确认 `syncToBackend()` 在设置 `currentCanvasPath` 后被调用
  - [ ] 3.2 验证 `POST /api/v1/textbook/sync-mount` 端点响应正确
  - [ ] 3.3 检查 `.canvas-links.json` 文件写入正确的association数据

- [ ] **Task 4: Agent上下文注入验证** (AC: 3)
  - [ ] 4.1 验证 `textbook_context_service.get_textbook_context()` 返回正确内容
  - [ ] 4.2 确认 Agent 调用时 prompt 包含教材上下文
  - [ ] 4.3 测试跨Canvas关联场景下的上下文获取

- [ ] **Task 5: 多格式支持测试** (AC: 4)
  - [ ] 5.1 测试 PDF 文件挂载和同步
  - [ ] 5.2 测试 Markdown 文件挂载和同步
  - [ ] 5.3 测试 Canvas 文件挂载和同步
  - [ ] 5.4 验证各格式的 section 元数据正确提取

- [ ] **Task 6: 错误处理与用户反馈** (AC: 1-4)
  - [ ] 6.1 无活动Canvas时显示提示信息
  - [ ] 6.2 后端同步失败时显示错误通知
  - [ ] 6.3 添加同步成功的确认提示

---

## Dev Notes

### SDD规范参考 (必填)

**API端点** (从OpenAPI specs):

| 端点 | 方法 | 描述 | 来源 |
|------|------|------|------|
| `/api/v1/textbook/sync-mount` | POST | 同步挂载的教材到后端 | `backend/app/api/v1/endpoints/textbook.py:93-159` |
| `/api/v1/textbook/unmount` | POST | 取消教材挂载 | `backend/app/api/v1/endpoints/textbook.py:162-195` |
| `/api/v1/textbook/mounted/{canvas_path}` | GET | 列出Canvas已挂载的教材 | `backend/app/api/v1/endpoints/textbook.py:198-230` |

**请求Schema** (`SyncMountRequest`):
```typescript
{
  canvas_path: string;  // 当前Canvas路径
  textbook: {
    id: string;
    path: string;
    name: string;
    type: "markdown" | "pdf" | "canvas";
    sections: TextbookSection[];
  }
}
```

**响应Schema** (`SyncMountResponse`):
```typescript
{
  success: boolean;
  config_path: string;  // .canvas-links.json 路径
  message: string;
  association_id: string;
}
```

**数据Schema** (`.canvas-links.json` 结构):
```json
{
  "associations": [
    {
      "association_id": "mount-{textbook_id}",
      "association_type": "references",
      "target_canvas": "{textbook_path}",
      "description": "{name} ({type})",
      "file_type": "pdf|markdown|canvas",
      "sections": [{"id": "", "title": "", "page_number": null}]
    }
  ]
}
```

> [Source: backend/app/api/v1/endpoints/textbook.py]
> [Source: backend/app/services/textbook_context_service.py]

---

### ADR决策关联 (必填)

| ADR编号 | 决策标题 | 对Story的影响 |
|---------|----------|---------------|
| ADR-011 | FILE-PATH-HANDLING-PATHLIB | 后端文件路径操作必须使用 `pathlib.Path` |
| ADR-001 | 使用Obsidian Canvas | Canvas文件为JSON格式，通过Obsidian API操作 |

**关键约束** (从ADR Consequences提取):
- **路径处理**: 所有Python文件操作使用 `pathlib.Path`，避免字符串拼接
- **Canvas格式**: `.canvas` 文件为JSON格式，包含nodes和edges数组
- **跨平台**: 路径分隔符使用 `Path` 自动处理，支持Windows/Linux

> [Source: ADR-011, ADR-001]

---

### 关键代码定位

**前端 - TextbookMountService.ts** (`canvas-progress-tracker/obsidian-plugin/src/services/TextbookMountService.ts`):

```typescript
// Line 72-75: 设置当前Canvas路径
setCurrentCanvasPath(canvasPath: string): void {
    this.currentCanvasPath = canvasPath;
    console.log('[TextbookMountService] Set current canvas:', canvasPath);
}

// Line 197-200: 带Canvas上下文的挂载方法 (推荐使用)
async mountTextbookForCanvas(filePath: string, canvasPath: string): Promise<MountedTextbook> {
    this.setCurrentCanvasPath(canvasPath);
    return this.mountTextbook(filePath);
}

// Line 178-183: 后端同步触发条件
if (this.currentCanvasPath) {
    await this.syncToBackend(textbook, this.currentCanvasPath);
} else {
    console.warn('[TextbookMountService] No canvas context set, skipping backend sync');
}
```

**核心问题**: `ReviewDashboardView.ts` 中的挂载按钮直接调用 `mountTextbook(filePath)`，未设置 `currentCanvasPath`，导致后端同步被跳过。

**修复方案**:
```typescript
// ReviewDashboardView.ts - 挂载按钮点击事件修改
mountBtn.addEventListener('click', async () => {
    // 获取当前活动的Canvas文件
    const activeFile = this.plugin.app.workspace.getActiveFile();
    if (!activeFile || !activeFile.path.endsWith('.canvas')) {
        new Notice('请先打开一个Canvas文件');
        return;
    }

    // 使用带Canvas上下文的挂载方法
    await this.textbookMountService.mountTextbookForCanvas(filePath, activeFile.path);
    // ...
});
```

**后端 - textbook_context_service.py** (`backend/app/services/textbook_context_service.py`):

```python
# Line 495-568: 同步挂载的教材到.canvas-links.json
async def sync_mounted_textbook(self, canvas_path: str, association: dict) -> str:
    config_path = self._get_config_path(canvas_path)
    # ... 读取现有associations，添加新association，写入文件
    return config_path

# Line 132-171: 获取教材上下文用于Agent prompt
async def get_textbook_context(self, canvas_path: str, query: str) -> Optional[FullTextbookContext]:
    # Uses timeout protection for graceful degradation
    result = await asyncio.wait_for(self._fetch_context(canvas_path, query), timeout=self._config.timeout)
    return result
```

---

### Testing

**测试文件位置**: `backend/tests/integration/test_textbook_mount_flow.py` (新建)

**测试标准**:
- 使用 `pytest` + `pytest-asyncio`
- 覆盖率要求: 95%+
- Mock Obsidian API 调用

**测试用例**:
1. `test_mount_with_canvas_context_triggers_sync` - 有Canvas上下文时触发同步
2. `test_mount_without_canvas_context_skips_sync` - 无Canvas上下文时跳过同步
3. `test_canvas_links_json_written_correctly` - .canvas-links.json 正确写入
4. `test_pdf_markdown_canvas_all_supported` - 三种格式均可挂载
5. `test_agent_receives_textbook_context` - Agent能获取教材上下文

**前端测试**: 在Obsidian中手动验证UI流程

---

### 依赖关系

- **依赖**: Epic 30 Story 30.5 (Canvas CRUD事件) - 确保Canvas事件监听正常
- **被依赖**: Story 34.7 (E2E测试) - 本Story完成后进行集成测试

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-19 | 0.1 | Initial draft with full technical context | SM Agent (Bob) |

---

## Dev Agent Record

### Agent Model Used

Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References

- Build verification: `npm run build` - SUCCESS (no TypeScript errors)
- Backend sync verification: `textbook_context_service.py:495-568` - confirmed `.canvas-links.json` write
- Agent context injection: `context_enrichment_service.py:361-387` - confirmed textbook context in prompt

### Completion Notes List

1. **Task 1 (AC1)**: Added `getCurrentCanvasPath()` method to `ReviewDashboardView.ts` (lines 1718-1744) that detects active Canvas file from Obsidian workspace
2. **Task 2 (AC1,2)**: Modified mount button handler (lines 1499-1533) to:
   - Check for active Canvas before mounting
   - Use `mountTextbookForCanvas(filePath, canvasPath)` to trigger backend sync
3. **Task 3 (AC2)**: Verified backend sync logic:
   - `syncToBackend()` calls `POST /api/v1/textbook/sync-mount`
   - `sync_mounted_textbook()` writes to `.canvas-links.json` with proper structure
4. **Task 4 (AC3)**: Verified Agent context injection:
   - `get_textbook_context()` loads associations from `.canvas-links.json`
   - `context_enrichment_service.py` injects textbook context into agent prompts
5. **Task 5 (AC4)**: Verified multi-format support:
   - Markdown: `parseMarkdownSections()` extracts headings
   - PDF: `parsePdfSections()` sends to backend for parsing
   - Canvas: Uses CrossCanvasService (no section parsing needed)
6. **Task 6 (AC1-4)**: Added error handling:
   - Notice when no Canvas active (line 1509)
   - Notice for backend sync failure (TextbookMountService.ts lines 242-248)
   - Success Notice with Canvas name (line 1519)

### File List

| File | Changes |
|------|---------|
| `canvas-progress-tracker/obsidian-plugin/src/views/ReviewDashboardView.ts` | Added `getCurrentCanvasPath()` method; Modified mount button to use canvas context; Removed duplicate method |
| `canvas-progress-tracker/obsidian-plugin/src/services/TextbookMountService.ts` | Added Notice import; Added user feedback for backend sync failures |
| `docs/stories/34.3.story.md` | Status: Approved → Done |

---

## QA Results

### Review Date: 2026-01-27

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**Overall: EXCELLENT** - 实现清晰、完整地满足了所有 AC 需求。代码结构良好，有充分的注释和源代码引用，遵循项目编码标准。

**前端实现亮点**:
- `getCurrentCanvasPath()` 方法实现简洁，正确使用 Obsidian API
- 挂载按钮流程完整，包含 Canvas 检测、用户提示、后端同步
- 错误处理完善，同步失败时显示友好提示但不阻塞本地操作

**后端实现亮点**:
- `sync_mounted_textbook()` 使用 pathlib.Path 符合 ADR-011
- 支持增量更新现有 associations
- 缓存失效机制正确实现

### Refactoring Performed

无需重构 - 代码质量已达标准。

### Compliance Check

- Coding Standards: ✓ TypeScript/Python 代码遵循项目标准
- Project Structure: ✓ 文件位置正确，符合 unified-project-structure
- Testing Strategy: ✓ 后端 E2E 测试完备 (663行, 15+ 测试用例)
- All ACs Met: ✓ 4/4 AC 完全满足

### Requirements Traceability (Given-When-Then)

| AC | Given | When | Then | 验证文件 |
|----|-------|------|------|----------|
| AC1 | 用户在 ReviewDashboard 选择教材 | 点击挂载按钮 | 自动检测并关联当前 Canvas | `ReviewDashboardView.ts:1762-1778, 1540-1552` |
| AC2 | 前端调用 `mountTextbookForCanvas()` | 后端接收 sync-mount 请求 | `.canvas-links.json` 正确写入 | `test_canvas_links_json_written_correctly` |
| AC3 | 教材已挂载到 Canvas | Agent 被调用 | prompt 包含教材上下文 | `TestAgentTextbookContextIntegration` |
| AC4 | 用户选择 PDF/MD/Canvas 文件 | 执行挂载 | 三种格式均成功 | `test_mount_*_with_canvas_context` (3 tests) |

### Test Coverage Analysis

| 测试类 | 测试数量 | 覆盖内容 |
|--------|----------|----------|
| `TestTextbookMountFlow` | 8 | PDF/MD/Canvas 挂载、文件结构验证 |
| `TestTextbookMountAPIEndpoints` | 3 | REST API 端点验证 |
| `TestAgentTextbookContextIntegration` | 3 | Agent 上下文注入验证 |
| `TestTextbookMountCacheInvalidation` | 2 | 缓存失效机制验证 |

### Improvements Checklist

- [x] AC1: getCurrentCanvasPath() 正确检测活动 Canvas
- [x] AC2: syncToBackend() 正确调用后端 API
- [x] AC3: Agent context enrichment 包含教材信息
- [x] AC4: 三种格式 (PDF/MD/Canvas) 均可挂载
- [x] 错误处理: 同步失败显示 Notice 提示
- [ ] 建议: 前端可添加自动化测试 (当前为手动验证)

### Security Review

**Status: PASS**
- 无敏感数据处理
- 使用标准 HTTP 通信
- 后端使用 pathlib 防止路径遍历

### Performance Considerations

**Status: PASS**
- 前端使用 localStorage 缓存已挂载教材
- 后端 `_config_cache` 减少文件 I/O
- 同步失败不阻塞本地操作 (graceful degradation)

### Files Modified During Review

无文件修改。

### Gate Status

Gate: **PASS** → `docs/qa/gates/34.3-textbook-mount-sync.yml`

### Recommended Status

✓ **Ready for Done** - 所有 AC 已满足，测试覆盖充分，代码质量优秀。
