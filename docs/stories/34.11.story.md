# Story 34.11: 测试质量提升至 TEA ≥70

<!-- Powered by BMAD Core -->

## Status

**Review** (2026-02-11) — 代码审查修复完成，待 TEA 重新评分

---

## Story

**As a** 开发者和维护者,
**I want** EPIC-34 的测试文件被合理拆分、重复 fixture 被提取、封装破坏被消除,
**so that** TEA 测试质量评分从 63/100 (D) 提升至 ≥70/100 (C)，测试套件具备可维护性

## 来源

本 Story 基于 R4 对抗性审查发现创建：
- Finding #3: TEA 评分 63/100 (D)，隔离性 56/100 (F)，可维护性 42/100 (F)
- Finding #5: 评分历史降级 86→63 被合理化而非修复
- Finding #12: 1226 行测试文件违反可维护性基线 (阈值的 4 倍)

---

## Acceptance Criteria

### AC1: 拆分测试文件 — 1226 行 → ≤300 行/模块 [P1]

**问题**: `backend/tests/integration/test_review_history_pagination.py` 有 1226 行、10 个 test class，TEA 可维护性评分 42/100 (F)。

**验收标准**:

```gherkin
Given backend/tests/integration/test_review_history_pagination.py (1226 行)
When 按测试关注点拆分为独立模块
Then 生成 3-4 个文件，每个 ≤300 行:
  - test_pagination_basic.py — 基本分页逻辑 (limit, show_all, days)
  - test_pagination_validation.py — 参数验证 (Query ge/le 边界)
  - test_pagination_real_service.py — 真实服务集成测试
  - test_pagination_di_completeness.py — DI 完整性源码检查

And 原始文件删除或重定向 import
And 所有 48 个测试仍然 PASS (0 回归)
```

**代码位置**:
- 拆分: `backend/tests/integration/test_review_history_pagination.py`
- 输出: `backend/tests/integration/review_history_pagination/` 目录

---

### AC2: 提取共享 fixture — ≥10 个重复 mock 消除 [P1]

**问题**: ~15 处重复的 mock 设置 (ReviewService mock, CanvasService mock, BackgroundTaskManager mock)。

**验收标准**:

```gherkin
Given 拆分后的测试模块
When 提取共享 mock fixture
Then conftest.py 包含:
  - mock_review_service fixture (含 _card_states, _review_history 等)
  - mock_canvas_service fixture
  - mock_background_task_manager fixture
  - sample_review_data factory function

And 每个测试文件通过 conftest 获取 fixture，不再内联定义
And 重复 mock 设置减少 ≥10 处
```

**代码位置**:
- 新建: `backend/tests/integration/review_history_pagination/conftest.py`

---

### AC3: 消除封装破坏 — 不再直接修改 service._card_states [P1]

**问题**: 测试直接修改 `service._card_states` 内部属性，TEA 隔离性评分 56/100 (F)。

**验收标准**:

```gherkin
Given 测试代码中所有 service._card_states 直接赋值
When 替换为公开 API 或 test helper
Then 满足以下之一:
  选项 A (推荐): 通过 service 的公开方法设置测试数据
  选项 B: 创建 TestReviewService 子类暴露 set_card_states() 方法
  选项 C: 使用 @property setter 或 configure() 方法

And grep -rn "_card_states\s*=" 在测试文件中返回 0 匹配
And 所有测试仍然 PASS
```

---

### AC4: TEA 重新评分 ≥70/100 [Gate]

**验收标准**:

```gherkin
Given AC1-AC3 全部完成
When 执行 /bmad-tea-testarch-test-review
Then TEA 总分 ≥70/100:
  - 隔离性 ≥65/100 (从 56 提升)
  - 可维护性 ≥60/100 (从 42 提升)
  - 其他维度不回归
```

---

## Tasks / Subtasks

- [x] **Task 1: 创建拆分目录结构** (AC: 1)
  - [x] 1.1 创建 `backend/tests/integration/review_history_pagination/` 目录
  - [x] 1.2 创建 `__init__.py`
  - [x] 1.3 创建 `conftest.py` (AC2 共享 fixture)

- [x] **Task 2: 拆分测试文件** (AC: 1)
  - [x] 2.1 提取基本分页测试 → `test_pagination_basic.py` (264 行)
  - [x] 2.2 提取参数验证测试 → `test_pagination_validation.py` (285 行)
  - [x] 2.3 提取真实服务测试 → `test_pagination_real_service.py` (218 行)
  - [x] 2.4 提取 DI 完整性测试 → `test_pagination_di_completeness.py` (38 行)
  - [x] 2.5 删除原始文件

- [x] **Task 3: 提取共享 fixture** (AC: 2)
  - [x] 3.1 提取 make_mock_review_service helper (conftest.py)
  - [x] 3.2 提取 mock_canvas_service (embedded in make_real_review_service)
  - [x] 3.3 提取 build_card_states_for_history factory
  - [x] 3.4 验证每个测试文件不再有内联 mock 定义

- [x] **Task 4: 消除封装破坏** (AC: 3)
  - [x] 4.1 审计所有 `_card_states` 直接赋值
  - [x] 4.2 实现 AC3 Option B: TestableReviewService 子类 + set_card_states() 公开方法
  - [x] 4.3 grep 验证: 测试方法中 0 匹配，仅 TestableReviewService 定义中 1 处

- [x] **Task 5: 回归验证** (AC: 1, 4)
  - [x] 5.1 `pytest backend/tests/integration/review_history_pagination/ -v` → 48/48 PASS
  - [ ] 5.2 ~~`pytest backend/tests/unit/test_review_history_pagination.py -v` → 17/17 PASS~~ N/A (无此文件)
  - [ ] 5.3 `pytest backend/tests/ -k "review" --co -q | wc -l` → 总数不减少

- [ ] **Task 6: TEA 重新评分** (AC: 4)
  - [ ] 6.1 执行 `/bmad-tea-testarch-test-review`
  - [ ] 6.2 确认 ≥70/100

### Review Follow-ups (AI)

- [x] [AI-Review][HIGH] AC3 `inject_card_states` 使用 setattr 绕过 grep → 替换为 TestableReviewService 子类 Option B [conftest.py:62-68]
- [x] [AI-Review][HIGH] DI 完整性测试 `or "get_review_service"` 导致断言永远为 True → 移除虚假 or 条件 [test_pagination_di_completeness.py:35]
- [x] [AI-Review][MEDIUM] `_patch_service_datetime` fixture 在两个 class 中重复定义 → 提取为模块级 fixture [test_pagination_real_service.py:32,172]
- [x] [AI-Review][LOW] `inject_card_states` 未使用导入 → 移除 [test_pagination_real_service.py:21]
- [x] [AI-Review][LOW] `MAX_HISTORY_RECORDS` 5 处内联 import → 提取到模块级 [test_pagination_real_service.py]

---

## Dev Notes

### 拆分策略

当前 10 个 test class 按关注点分组:

| 现有 Class | 目标文件 | 关注点 |
|-----------|---------|--------|
| TestReviewHistoryPagination | test_pagination_basic.py | 基本 limit/show_all |
| TestReviewHistoryDefault | test_pagination_basic.py | 默认值行为 |
| TestShowAllHardCap | test_pagination_basic.py | MAX_HISTORY_RECORDS |
| TestDaysParameterValidation | test_pagination_validation.py | days 边界 |
| TestLimitParameterValidation | test_pagination_validation.py | limit 边界 |
| TestShowAllParameterValidation | test_pagination_validation.py | show_all 边界 |
| TestRealReviewServiceHistory | test_pagination_real_service.py | 真实服务 |
| TestReviewServiceDICompleteness | test_pagination_di_completeness.py | DI 源码检查 |
| TestHistoryResponseFormat | test_pagination_basic.py | 响应格式 |
| TestHistoryEdgeCases | test_pagination_validation.py | 边界情况 |

### ATDD Evidence

本 Story 为纯重构，现有 48 个测试即为红灯基线 — 拆分后必须全部 PASS。

---

## 依赖关系

**前置依赖**:
- ✅ Story 34.10 (DI 引用已修复，48 测试已恢复)

**被依赖**:
- Story 34.12 (可并行，无直接依赖)
- Story 34.13 (可并行，无直接依赖)
- EPIC 级 TEA 重新评分

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-10 | 0.1 | Initial draft — R4 对抗性审查 Finding #3, #5, #12 | SM Agent (Bob) |
| 2026-02-11 | 0.2 | Code review: 7 issues found (2H/3M/2L), 5 fixed — H1 AC3 setattr→TestableReviewService, H2 vacuous DI test, M2 dup fixture, L1 unused import, L2 inline imports | Code Review (AI) |
