# Story 36.9: å­¦ä¹ è®°å¿†åŒå†™ï¼ˆNeo4j + Graphiti JSONå­˜å‚¨ï¼‰

**Epic**: [EPIC-36: AgentèŠ‚ç‚¹é—´ä¸Šä¸‹æ–‡ç®¡ç†å¢žå¼º](../epics/EPIC-36-AGENT-CONTEXT-MANAGEMENT-ENHANCEMENT.md)
**Story ID**: 36.9
**Priority**: P2
**Status**: Ready for Review
**Created**: 2026-01-20
**Dependency**: EPIC-30 Story 30.4 (Agentè®°å¿†å†™å…¥è§¦å‘æœºåˆ¶)

---

## Story

**As a** Canvas Learning System backend developer,
**I want** automatic dual-write of learning events to Neo4j AND Graphiti JSON storage (via existing `LearningMemoryClient`),
**so that** learning memories are persistently stored to both the direct Neo4j database and the Graphiti-compatible JSON file, providing redundancy and enabling MCP-compatible tooling access to learning history.

---

## Acceptance Criteria

- **AC-36.9.1**: å­¦ä¹ äº‹ä»¶å†™å…¥Neo4jæˆåŠŸåŽè‡ªåŠ¨å°è¯•å†™å…¥ `LearningMemoryClient` (Graphiti JSONæ ¼å¼)
- **AC-36.9.2**: JSONå†™å…¥ä½¿ç”¨fire-and-forgetæ¨¡å¼ï¼Œä¸é˜»å¡žä¸»æµç¨‹
- **AC-36.9.3**: JSONå†™å…¥å¤±è´¥æ—¶é™é»˜é™çº§ï¼Œè®°å½•è­¦å‘Šæ—¥å¿—ä½†ä¸æŠ›å‡ºå¼‚å¸¸
- **AC-36.9.4**: JSONå†™å…¥è¶…æ—¶ä¿æŠ¤ï¼ˆ500msï¼‰ï¼Œè¶…æ—¶åŽæ”¾å¼ƒå†™å…¥
- **AC-36.9.5**: å¯é€šè¿‡çŽ¯å¢ƒå˜é‡ `ENABLE_GRAPHITI_JSON_DUAL_WRITE=true/false` å¼€å…³åŒå†™åŠŸèƒ½

---

## Tasks / Subtasks

- [x] **Task 1: Extend MemoryService with Graphiti JSON Dual-Write Hook** (AC-36.9.1, AC-36.9.2)
  - [x] 1.1 Import `LearningMemoryClient`, `LearningMemory`, `get_learning_memory_client` from `graphiti_client.py`
  - [x] 1.2 Add `_learning_memory: LearningMemoryClient` to `MemoryService.__init__()`
  - [x] 1.3 Add `_write_to_graphiti_json()` private async method in `memory_service.py`
  - [x] 1.4 Call `_write_to_graphiti_json()` via `asyncio.create_task()` after Neo4j write succeeds in `record_learning_event()`
  - [x] 1.5 Call `_write_to_graphiti_json()` via `asyncio.create_task()` after Neo4j write succeeds in `record_temporal_event()`
  - [x] 1.6 Ensure fire-and-forget pattern doesn't block the main return

- [x] **Task 2: Implement Graphiti JSON Write Logic** (AC-36.9.3, AC-36.9.4)
  - [x] 2.1 In `_write_to_graphiti_json()`, create `LearningMemory` dataclass instance
  - [x] 2.2 Call `self._learning_memory.add_learning_episode(memory)`
  - [x] 2.3 Wrap call in `asyncio.wait_for()` with 500ms timeout
  - [x] 2.4 Wrap in try/except for silent degradation with `logger.warning()`
  - [x] 2.5 Log success with `logger.debug()`

- [x] **Task 3: Add Configuration Flag** (AC-36.9.5)
  - [x] 3.1 Add `ENABLE_GRAPHITI_JSON_DUAL_WRITE` to `backend/app/config.py` (default: `false`)
  - [x] 3.2 Check flag before calling `_write_to_graphiti_json()`
  - [x] 3.3 Update `.env.example` with new config option

- [x] **Task 4: Unit Tests**
  - [x] 4.1 Test `_write_to_graphiti_json()` is called after Neo4j write succeeds
  - [x] 4.2 Test fire-and-forget doesn't block `record_learning_event()` return
  - [x] 4.3 Test JSON write failure doesn't affect main flow
  - [x] 4.4 Test timeout protection (500ms)
  - [x] 4.5 Test config flag disables dual-write when `false`

- [x] **Task 5: Integration Tests**
  - [x] 5.1 Test full flow: Agent â†’ memory write â†’ Neo4j + Graphiti JSON dual-write
  - [x] 5.2 Test LearningMemoryClient unavailable scenario (graceful degradation)
  - [x] 5.3 Verify JSON episode format matches LearningMemory schema

---

## Dev Notes

### ðŸ“‹ æŠ€æœ¯éªŒè¯æŠ¥å‘Š (Step 3.6)

**éªŒè¯å®Œæˆæ—¶é—´**: 2026-01-20T00:10:00Z
**éªŒè¯æ‰§è¡Œäºº**: SM Agent (Bob)
**POéªŒè¯ä¿®å¤æ—¶é—´**: 2026-01-20T01:30:00Z
**POéªŒè¯æ‰§è¡Œäºº**: Sarah (PO)
**Quality GateçŠ¶æ€**: âœ… PASSED (ä¿®å¤åŽ)

#### æŠ€æœ¯æ ˆæ¸…å•

| æŠ€æœ¯æ ˆ | æŸ¥è¯¢æ–¹å¼ | éªŒè¯çŠ¶æ€ | æ–‡æ¡£ä½ç½® |
|--------|---------|---------|----------|
| Neo4j | Architecture | âœ… å·²éªŒè¯ | ADR-0003, memory_service.py |
| LearningMemoryClient | ä»£ç éªŒè¯ | âœ… å·²éªŒè¯ | graphiti_client.py:453-754 |
| asyncio | Python stdlib | âœ… å·²éªŒè¯ | ADR-0004 |
| FastAPI | Context7 | âœ… å·²éªŒè¯ | /websites/fastapi_tiangolo |

#### âš ï¸ POéªŒè¯ä¿®å¤è¯´æ˜Ž

**åŽŸé—®é¢˜**: StoryåŽŸè®¾è®¡å‡è®¾å¯ä»¥ä»ŽPythonä»£ç è°ƒç”¨MCPå·¥å…· (`mcp__graphiti-memory__add_episode`)ï¼Œä½†MCPå·¥å…·æ˜¯Claudeä¾§å·¥å…·ï¼Œä¸æ˜¯Pythonå¯è°ƒç”¨çš„APIã€‚

**ä¿®å¤æ–¹æ¡ˆ**: ä½¿ç”¨å·²å­˜åœ¨çš„ `LearningMemoryClient` (graphiti_client.py:453-754)ï¼Œè¯¥ç±»ï¼š
- å·²å®žçŽ° `add_learning_episode()` æ–¹æ³•
- å­˜å‚¨åˆ°JSONæ–‡ä»¶ (å…¼å®¹MCP graphiti-memoryæ ¼å¼)
- MCPæœåŠ¡å™¨å°†æ¥å¯è¯»å–æ­¤JSONæ–‡ä»¶

[Source: PO Validation Report 2026-01-20]

---

### ä¾èµ–Storyä¸Šä¸‹æ–‡ (Story 30.4)

**ä»Ž Story 30.4 ç»§æ‰¿çš„å…³é”®å®žçŽ°**:

1. **Fire-and-forgetæ¨¡å¼** (agent_service.py:2794-2877):
```python
# âœ… Verified from Story 30.4 Dev Notes
asyncio.create_task(
    asyncio.wait_for(
        self.record_learning_episode(...),
        timeout=0.5  # 500ms timeout
    )
)
```

2. **é™é»˜é™çº§æ¨¡å¼**:
```python
try:
    await self._write_to_graphiti_json(...)
except Exception as e:
    logger.warning(f"Graphiti JSON write failed: {e}")
    # Silent degradation - don't raise
```

3. **Agent Memory Mapping** (ä»Ž `core/agent_memory_mapping.py`):
- 14ä¸ªAgentçš„memoryç±»åž‹å·²æ˜ å°„
- æœ¬Storyå¤ç”¨çŽ°æœ‰æ˜ å°„

[Source: docs/stories/30.4.story.md#Dev-Notes]

---

### çŽ°æœ‰ä»£ç å‚è€ƒ (å…³é”®!)

#### LearningMemoryClient (å·²å­˜åœ¨ï¼Œç›´æŽ¥å¤ç”¨!)

**ä½ç½®**: `backend/app/clients/graphiti_client.py:453-754`

```python
# âœ… å·²å­˜åœ¨çš„ç±»ï¼Œæœ¬Storyç›´æŽ¥å¤ç”¨
@dataclass
class LearningMemory:
    canvas_name: str
    node_id: str
    concept: str
    user_understanding: Optional[str] = None
    score: Optional[float] = None
    agent_feedback: Optional[str] = None
    timestamp: Optional[str] = None

class LearningMemoryClient:
    async def add_learning_episode(self, memory: LearningMemory) -> bool:
        """Add a learning episode to memory."""
        # ... å­˜å‚¨åˆ°JSONæ–‡ä»¶ ...

# èŽ·å–å•ä¾‹
def get_learning_memory_client() -> LearningMemoryClient:
    ...
```

**å­˜å‚¨ä½ç½®**: `backend/data/learning_memories.json`

[Source: backend/app/clients/graphiti_client.py#L453-L754]

---

### SDDè§„èŒƒå‚è€ƒ (å¿…å¡«)

#### APIç«¯ç‚¹

**Memoryç«¯ç‚¹** (æœ¬Storyè§¦å‘ç‚¹):
- ç«¯ç‚¹: `POST /api/v1/memory/episodes`
- è§„èŒƒæ¥æº: `[Source: specs/api/fastapi-backend-api.openapi.yml#L233-L277]`
- å“åº”: `LearningEpisodeResponse` with `episode_id`, `status`

#### æ•°æ®Schema

**TemporalEvent Schema**:
- è§„èŒƒæ¥æº: `[Source: specs/data/temporal-event.schema.json]`
- å¿…å¡«å­—æ®µ: `event_id`, `session_id`, `event_type`, `timestamp`
- å¯é€‰å­—æ®µ: `canvas_path`, `node_id`, `agent_type`, `metadata`, `subject`, `group_id`

**LearningMemory Schema** (Graphiti JSONç›®æ ‡æ ¼å¼):
- è§„èŒƒæ¥æº: `[Source: backend/app/clients/graphiti_client.py#L425-L450]`
- å¿…å¡«å­—æ®µ: `canvas_name`, `node_id`, `concept`
- å¯é€‰å­—æ®µ: `user_understanding`, `score`, `agent_feedback`, `timestamp`

---

### ADRå†³ç­–å…³è” (å¿…å¡«)

| ADRç¼–å· | å†³ç­–æ ‡é¢˜ | å¯¹Storyçš„å½±å“ |
|---------|----------|---------------|
| ADR-0003 | Graphiti Memory Architecture | 3å±‚æž¶æž„: Temporal(FSRS) â†’ Graphiti(Neo4j) â†’ Semantic(LanceDB) |
| ADR-0004 | Async Execution Engine | ä½¿ç”¨asyncio.create_task()å®žçŽ°fire-and-forget |

#### å…³é”®çº¦æŸ (ä»ŽADR Consequencesæå–):

**ä»Ž ADR-0003**:
- æ‰€æœ‰GraphitiæŸ¥è¯¢å¿…é¡»æ˜¯å¼‚æ­¥çš„
- Neo4jè¿žæŽ¥å¤±è´¥æ—¶å¿…é¡»ä¼˜é›…é™çº§
- 3å±‚æž¶æž„: Temporal(FSRS) â†’ Graphiti(Neo4j) â†’ Semantic(LanceDB)

**ä»Ž ADR-0004**:
- ä½¿ç”¨ `Semaphore(12)` æŽ§åˆ¶å¹¶å‘
- æ¨¡å¼: `asyncio.gather(*tasks, return_exceptions=True)`
- å•ä¸ªä»»åŠ¡è¶…æ—¶ä¸åº”å½±å“æ•´ä½“æ‰§è¡Œ
- 500ms timeoutæ˜¯æŽ¨èçš„éžé˜»å¡žå†™å…¥è¶…æ—¶

æ¥æºå¼•ç”¨: `[Source: docs/architecture/decisions/0003-graphiti-memory.md]`, `[Source: docs/architecture/decisions/0004-async-execution-engine.md]`

---

### çŽ°æœ‰ä»£ç ä¿®æ”¹ç‚¹

**memory_service.py å…³é”®æ–¹æ³•** (éœ€ä¿®æ”¹):

1. `__init__()` (Line 56-71):
   - å½“å‰: ä»…æ³¨å…¥ `Neo4jClient`
   - ä¿®æ”¹: æ·»åŠ  `LearningMemoryClient` æ³¨å…¥

2. `record_learning_event()` (Line 83-172):
   - å½“å‰: å†™å…¥Neo4j + å†…å­˜ç¼“å­˜
   - ä¿®æ”¹: åœ¨Neo4jå†™å…¥æˆåŠŸåŽæ·»åŠ Graphiti JSONåŒå†™

3. `record_temporal_event()` (å¦‚å­˜åœ¨):
   - å½“å‰: å†™å…¥Neo4j
   - ä¿®æ”¹: åœ¨Neo4jå†™å…¥æˆåŠŸåŽæ·»åŠ Graphiti JSONåŒå†™

[Source: backend/app/services/memory_service.py]

---

### å®žçŽ°æž¶æž„å›¾

```
å­¦ä¹ äº‹ä»¶ (Agentå®Œæˆ)
    â”‚
    â–¼
MemoryService.record_learning_event()
    â”‚
    â”œâ”€â”€â–¶ Neo4jå†™å…¥ (åŒæ­¥ç­‰å¾…) - å·²å­˜åœ¨
    â”‚       âœ“ æˆåŠŸ
    â”‚
    â””â”€â”€â–¶ asyncio.create_task(_write_to_graphiti_json(...))  [fire-and-forget]
            â”‚
            â”œâ”€â”€ asyncio.wait_for(timeout=0.5s)
            â”‚       â”‚
            â”‚       â”œâ”€â”€ LearningMemoryClient.add_learning_episode()  â† å·²å­˜åœ¨!
            â”‚       â”‚       â”‚
            â”‚       â”‚       â””â”€â”€ å†™å…¥ backend/data/learning_memories.json
            â”‚       â”‚               âœ“ æˆåŠŸ â†’ logger.debug("Graphiti JSON write succeeded")
            â”‚       â”‚               âœ— å¤±è´¥ â†’ logger.warning("Graphiti JSON write failed")
            â”‚       â”‚
            â”‚       â””â”€â”€ TimeoutError â†’ logger.warning("Graphiti JSON write timeout")
            â”‚
            â””â”€â”€ ä¸é˜»å¡žä¸»æµç¨‹ï¼Œç«‹å³è¿”å›žepisode_id
```

---

### é…ç½®è¯´æ˜Ž

**æ–°å¢žçŽ¯å¢ƒå˜é‡** (backend/.env):
```env
# æ˜¯å¦å¯ç”¨Graphiti JSONåŒå†™ (Story 36.9)
ENABLE_GRAPHITI_JSON_DUAL_WRITE=false  # é»˜è®¤å…³é—­ï¼Œç”Ÿäº§çŽ¯å¢ƒå¯å¼€å¯
```

**config.py ä¿®æ”¹**:
```python
# Story 36.9: Graphiti JSON Dual-Write Configuration
ENABLE_GRAPHITI_JSON_DUAL_WRITE: bool = os.getenv(
    "ENABLE_GRAPHITI_JSON_DUAL_WRITE", "false"
).lower() == "true"
```

---

### ä»£ç ç¤ºä¾‹

**MemoryService.__init__() ä¿®æ”¹**:
```python
from app.clients.graphiti_client import (
    LearningMemory,
    LearningMemoryClient,
    get_learning_memory_client
)
from app.config import settings

class MemoryService:
    def __init__(
        self,
        neo4j_client: Optional[Neo4jClient] = None,
        learning_memory_client: Optional[LearningMemoryClient] = None  # âœ… æ–°å¢ž
    ):
        self.neo4j = neo4j_client or get_neo4j_client()
        self._learning_memory = learning_memory_client or get_learning_memory_client()  # âœ… æ–°å¢ž
        # ...
```

**_write_to_graphiti_json() å®žçŽ°**:
```python
async def _write_to_graphiti_json(
    self,
    episode_id: str,
    canvas_name: str,
    node_id: str,
    concept: str,
    score: Optional[float] = None,
    agent_feedback: Optional[str] = None
) -> None:
    """
    Fire-and-forget write to Graphiti JSON storage.

    âœ… Story 36.9 AC-36.9.2/AC-36.9.3/AC-36.9.4
    - Uses existing LearningMemoryClient (graphiti_client.py:453)
    - Fire-and-forget pattern
    - Silent degradation on failure
    - 500ms timeout protection

    [Source: backend/app/clients/graphiti_client.py#LearningMemoryClient]
    """
    try:
        # âœ… AC-36.9.4: 500ms timeout
        await asyncio.wait_for(
            self._learning_memory.add_learning_episode(
                LearningMemory(
                    canvas_name=canvas_name,
                    node_id=node_id,
                    concept=concept,
                    score=score,
                    agent_feedback=agent_feedback,
                    timestamp=datetime.now().isoformat()
                )
            ),
            timeout=0.5
        )
        logger.debug(f"Graphiti JSON dual-write succeeded: {episode_id}")
    except asyncio.TimeoutError:
        logger.warning(f"Graphiti JSON dual-write timeout (500ms): {episode_id}")
    except Exception as e:
        # âœ… AC-36.9.3: Silent degradation
        logger.warning(f"Graphiti JSON dual-write failed for {episode_id}: {e}")
```

**record_learning_event() ä¿®æ”¹**:
```python
async def record_learning_event(self, ...):
    # ... çŽ°æœ‰Neo4jå†™å…¥é€»è¾‘ (Line 136-168) ...

    logger.info(f"Recorded learning event: {episode_id}")

    # âœ… Story 36.9: Fire-and-forget dual-write to Graphiti JSON
    if settings.ENABLE_GRAPHITI_JSON_DUAL_WRITE:
        asyncio.create_task(
            self._write_to_graphiti_json(
                episode_id=episode_id,
                canvas_name=canvas_path,  # ä½¿ç”¨canvas_pathä½œä¸ºcanvas_name
                node_id=node_id,
                concept=concept,
                score=float(score) if score else None,
                agent_feedback=None
            )
        )

    return episode_id
```

---

## Testing

### Test File Locations
- Unit tests: `backend/tests/unit/test_graphiti_json_dual_write.py` (æ–°å»º)
- Integration tests: `backend/tests/integration/test_memory_graphiti_integration.py` (æ–°å»º)

### Testing Standards
- Framework: pytest + pytest-asyncio
- Coverage: ç›®æ ‡ > 90%
- Mock: ä½¿ç”¨ `unittest.mock.AsyncMock` mock LearningMemoryClient

### Testing Patterns
```python
@pytest.mark.asyncio
async def test_graphiti_json_dual_write_fire_and_forget():
    """âœ… AC-36.9.2: JSON write doesn't block main flow"""
    # Arrange
    mock_learning_memory = AsyncMock()
    mock_learning_memory.add_learning_episode.return_value = True
    service = MemoryService(learning_memory_client=mock_learning_memory)

    # Act
    start_time = time.time()
    episode_id = await service.record_learning_event(
        user_id="test-user",
        canvas_path="test.canvas",
        node_id="node-123",
        concept="æµ‹è¯•æ¦‚å¿µ",
        agent_type="scoring-agent"
    )
    elapsed = time.time() - start_time

    # Assert
    assert episode_id is not None  # Main flow completed
    assert elapsed < 0.1  # Should return immediately, not wait for JSON write
    # JSON write is fire-and-forget, may not complete yet
    await asyncio.sleep(0.6)  # Wait for fire-and-forget to complete
    mock_learning_memory.add_learning_episode.assert_called_once()
```

### Key Test Cases
1. JSON write triggered after Neo4j success (AC-36.9.1)
2. Fire-and-forget doesn't block return (AC-36.9.2)
3. JSON write failure doesn't affect main flow (AC-36.9.3)
4. Timeout protection works (500ms) (AC-36.9.4)
5. Config flag `ENABLE_GRAPHITI_JSON_DUAL_WRITE=false` disables dual-write (AC-36.9.5)
6. LearningMemoryClient unavailable scenario (graceful degradation)

[Source: docs/architecture/testing-strategy.md]

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-20 | 0.1 | Initial draft created by SM Agent with ultrathink analysis | Bob (SM) |
| 2026-01-20 | 0.2 | **POéªŒè¯ä¿®å¤**: å°†MCPè°ƒç”¨æ”¹ä¸ºä½¿ç”¨å·²å­˜åœ¨çš„LearningMemoryClient; ä¿®å¤AC, Tasks, Dev Notes, æž¶æž„å›¾; è§£å†³"MCPå·¥å…·ä¸å¯ä»ŽPythonè°ƒç”¨"çš„æŠ€æœ¯é˜»å¡ž | Sarah (PO) |
| 2026-01-20 | 1.0 | **Implementation Complete**: All 5 tasks implemented, 18 tests passing (11 unit + 7 integration), Statusâ†’Ready for Review | James (Dev) |

---

## Dev Agent Record

### Agent Model Used
Claude Opus 4.5 (claude-opus-4-5-20251101), James (Full Stack Developer) via `/BMad:agents:dev`

### Debug Log References
- Unit tests: `pytest backend/tests/unit/test_graphiti_json_dual_write.py -v` â†’ 11/11 passed
- Integration tests: `pytest backend/tests/integration/test_memory_graphiti_integration.py -v` â†’ 7/7 passed

### Completion Notes List
1. **Task 1-3 Implementation** (2026-01-20):
   - Added imports for `LearningMemory`, `LearningMemoryClient`, `get_learning_memory_client`, `asyncio`, `settings`
   - Added `GRAPHITI_JSON_WRITE_TIMEOUT = 0.5` constant
   - Updated `MemoryService.__init__()` to accept optional `learning_memory_client` parameter
   - Implemented `_write_to_graphiti_json()` async method with 500ms timeout protection
   - Updated `record_learning_event()` with fire-and-forget dual-write call
   - Updated `record_temporal_event()` with fire-and-forget dual-write call
   - Added `ENABLE_GRAPHITI_JSON_DUAL_WRITE` config flag to `config.py` (default: false)
   - Updated `.env.example` with documentation

2. **Task 4 Unit Tests** (2026-01-20):
   - Created `test_graphiti_json_dual_write.py` with 11 test cases covering all ACs
   - Tests verify fire-and-forget, timeout, config flag, logging

3. **Task 5 Integration Tests** (2026-01-20):
   - Created `test_memory_graphiti_integration.py` with 7 test cases
   - Tests verify full flow, graceful degradation, JSON schema, concurrent writes, Chinese content

### File List
**ä¿®æ”¹çš„æ–‡ä»¶:**
- `backend/app/services/memory_service.py` (æ·»åŠ LearningMemoryClientæ³¨å…¥, æ·»åŠ _write_to_graphiti_json, è°ƒç”¨åŒå†™)
- `backend/app/config.py` (æ·»åŠ ENABLE_GRAPHITI_JSON_DUAL_WRITEé…ç½®)
- `backend/.env.example` (æ·»åŠ ENABLE_GRAPHITI_JSON_DUAL_WRITEç¤ºä¾‹)

**æ–°å»ºçš„æ–‡ä»¶:**
- `backend/tests/unit/test_graphiti_json_dual_write.py` (11 test cases)
- `backend/tests/integration/test_memory_graphiti_integration.py` (7 test cases)

**å¤ç”¨çš„çŽ°æœ‰æ–‡ä»¶ (æ— ä¿®æ”¹):**
- `backend/app/clients/graphiti_client.py` (å·²å­˜åœ¨LearningMemoryClient, ç›´æŽ¥å¤ç”¨)

---

## QA Results

### Review Date: 2026-01-31

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**æ•´ä½“è¯„ä¼°**: ä¼˜ç§€ âœ…

Story 36.9 çš„å®žçŽ°è´¨é‡éžå¸¸é«˜ï¼Œå®Œå…¨ç¬¦åˆ BMad æ ‡å‡†å’Œé¡¹ç›®æž¶æž„è§„èŒƒï¼š

1. **ä»£ç æž¶æž„æ¸…æ™°**: åŒå†™åŠŸèƒ½å®Œç¾Žé›†æˆåˆ°çŽ°æœ‰çš„ `MemoryService` ä¸­ï¼Œéµå¾ªäº†å·²æœ‰çš„å¼‚æ­¥ç¼–ç¨‹æ¨¡å¼
2. **ä¾èµ–æ³¨å…¥è®¾è®¡**: `LearningMemoryClient` é€šè¿‡æž„é€ å‡½æ•°æ³¨å…¥ï¼Œæ”¯æŒæµ‹è¯•æ—¶æ›¿æ¢ mock å¯¹è±¡
3. **é…ç½®ç®¡ç†è§„èŒƒ**: `ENABLE_GRAPHITI_JSON_DUAL_WRITE` éµå¾ª Pydantic Settings æœ€ä½³å®žè·µ
4. **é”™è¯¯å¤„ç†å®Œå–„**: é™é»˜é™çº§æ¨¡å¼ç¡®ä¿ä¸»æµç¨‹ä¸å—å½±å“
5. **æ–‡æ¡£å®Œæ•´**: ä»£ç æ³¨é‡Šè¯¦å°½ï¼ŒåŒ…å«å®Œæ•´çš„ Source å¼•ç”¨

### Refactoring Performed

æ— éœ€é‡æž„ã€‚å®žçŽ°å·²ç¬¦åˆæœ€ä½³å®žè·µã€‚

### Compliance Check

- Coding Standards: âœ“ å®Œå…¨ç¬¦åˆ `docs/architecture/coding-standards.md`
- Project Structure: âœ“ ç¬¦åˆ `docs/architecture/project-structure.md`
- Testing Strategy: âœ“ ç¬¦åˆ `docs/architecture/testing-strategy.md` (18ä¸ªæµ‹è¯•è¦†ç›–å…¨éƒ¨AC)
- All ACs Met: âœ“ 5ä¸ªACå…¨éƒ¨éªŒè¯é€šè¿‡

### Improvements Checklist

- [x] AC-36.9.1: Neo4jæˆåŠŸåŽè°ƒç”¨Graphiti JSONå†™å…¥ (`memory_service.py:299-311`)
- [x] AC-36.9.2: Fire-and-forgetæ¨¡å¼ (`asyncio.create_task()`)
- [x] AC-36.9.3: é™é»˜é™çº§æ—¥å¿— (`_write_to_graphiti_json:209-211`)
- [x] AC-36.9.4: 500msè¶…æ—¶ä¿æŠ¤ (`GRAPHITI_JSON_WRITE_TIMEOUT = 0.5`)
- [x] AC-36.9.5: é…ç½®å¼€å…³ (`ENABLE_GRAPHITI_JSON_DUAL_WRITE` in config.py:409-412)

### Security Review

âœ… æ— å®‰å…¨é—®é¢˜å‘çŽ°

- æ–‡ä»¶æ“ä½œé™å®šåœ¨ `backend/data/` ç›®å½•å†…
- æ— æ•æ„Ÿæ•°æ®æ³„éœ²é£Žé™©
- JSONå†™å…¥ä½¿ç”¨ `ensure_ascii=False` æ­£ç¡®å¤„ç†ä¸­æ–‡

### Performance Considerations

âœ… æ€§èƒ½è®¾è®¡ç¬¦åˆé¢„æœŸ

- Fire-and-forgetæ¨¡å¼ç¡®ä¿ä¸»æµç¨‹ä¸é˜»å¡ž (æµ‹è¯•éªŒè¯: `< 0.5s` è¿”å›ž)
- 500msè¶…æ—¶é˜²æ­¢é•¿æ—¶é—´é˜»å¡žåŽå°ä»»åŠ¡
- å¹¶å‘å†™å…¥æµ‹è¯•é€šè¿‡ (5ä¸ªå¹¶å‘è¯·æ±‚)

### Files Modified During Review

æ— æ–‡ä»¶ä¿®æ”¹ã€‚

### Gate Status

Gate: **PASS** â†’ docs/qa/gates/36.9-graphiti-json-dual-write.yml

### Test Evidence

```
=== Test Results (2026-01-31) ===
Unit Tests: 11/11 PASSED
Integration Tests: 7/7 PASSED
Total: 18/18 PASSED (100%)

Key Test Coverage:
- test_dual_write_called_after_neo4j_success âœ“
- test_fire_and_forget_doesnt_block_return âœ“
- test_json_write_failure_doesnt_affect_main_flow âœ“
- test_timeout_protection âœ“
- test_config_flag_disables_dual_write âœ“
- test_concurrent_dual_writes âœ“
- test_chinese_content_in_dual_write âœ“
```

### Recommended Status

âœ“ Ready for Done

Story 36.9 å®žçŽ°å®Œå…¨ç¬¦åˆéªŒæ”¶æ ‡å‡†ï¼Œæ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼Œä»£ç è´¨é‡ä¼˜ç§€ï¼ŒæŽ¨èæ ‡è®°ä¸ºå®Œæˆã€‚
