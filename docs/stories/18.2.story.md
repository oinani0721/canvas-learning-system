# Story 18.2: Snapshot Manager - Canvas状态快照

## Status
Draft

## Story

**As a** Canvas Learning System用户,
**I want** 创建和管理Canvas快照,
**so that** 我可以恢复到任意保存状态。

## Acceptance Criteria

1. `SnapshotManager`创建快照: auto/manual/checkpoint
2. `Snapshot`包含: id, canvasPath, timestamp, type, canvas数据, 关联操作ID, metadata
3. 自动快照间隔可配置(默认300秒)
4. 每Canvas最大快照数可配置(默认50), 自动清理
5. 快照存储到 `.canvas-learning/snapshots/{canvas_name}/`
6. GET `/api/v1/rollback/snapshots/{canvas_path}` 列出快照
7. POST `/api/v1/rollback/snapshot` 创建手动快照
8. 所有代码有文档来源标注

## Tasks / Subtasks

- [ ] Task 1: 创建Snapshot数据模型 (AC: 2)
  - [ ] 在 `src/rollback/models.py` 添加Snapshot dataclass
  - [ ] 定义SnapshotType枚举 (auto, manual, checkpoint)
  - [ ] 定义Snapshot dataclass (id, canvasPath, timestamp, type, canvasData, lastOperationId, metadata)
  - [ ] 定义SnapshotMetadata dataclass (description, createdBy, tags)

- [ ] Task 2: 实现SnapshotManager核心类 (AC: 1, 3, 4)
  - [ ] 创建 `src/rollback/snapshot_manager.py`
  - [ ] 实现 `SnapshotManager.__init__(auto_interval=300, max_snapshots=50)`
  - [ ] 实现 `create_snapshot(canvas_path, type, description)` 方法
  - [ ] 实现 `get_snapshot(snapshot_id)` 方法
  - [ ] 实现 `list_snapshots(canvas_path, limit, offset)` 方法
  - [ ] 实现 `delete_snapshot(snapshot_id)` 方法
  - [ ] 实现超限自动清理 (_cleanup_old_snapshots)

- [ ] Task 3: 实现自动快照调度器 (AC: 3)
  - [ ] 实现 `_auto_snapshot_scheduler()` asyncio任务
  - [ ] 实现 `start_auto_snapshot(canvas_path)` 方法
  - [ ] 实现 `stop_auto_snapshot(canvas_path)` 方法
  - [ ] 实现 `_should_create_auto_snapshot()` 检测逻辑

- [ ] Task 4: 实现磁盘持久化 (AC: 5)
  - [ ] 实现 `_get_snapshot_path(canvas_path, snapshot_id)` 方法
  - [ ] 实现 `_save_snapshot(snapshot)` 方法 (含Canvas完整数据)
  - [ ] 实现 `_load_snapshot(snapshot_id)` 方法
  - [ ] 实现快照索引文件管理 (snapshots_index.json)
  - [ ] 使用orjson进行JSON序列化

- [ ] Task 5: 添加REST API端点 (AC: 6, 7)
  - [ ] 在 `backend/app/api/v1/endpoints/rollback.py` 添加快照端点
  - [ ] 实现 `GET /api/v1/rollback/snapshots/{canvas_path}` 列出快照
  - [ ] 实现 `POST /api/v1/rollback/snapshot` 创建手动快照
  - [ ] 更新 `backend/app/models/rollback.py` 添加Snapshot schemas

- [ ] Task 6: 集成测试 (AC: 8)
  - [ ] 创建 `src/tests/unit/test_snapshot_manager.py`
  - [ ] 测试3种快照类型创建
  - [ ] 测试自动清理机制
  - [ ] 测试自动快照调度器
  - [ ] 确保测试覆盖率 >90%

## Dev Notes

### 技术验证报告 (Step 3.6)

**验证完成时间**: 2025-12-04
**验证执行人**: SM Agent (Bob)
**Quality Gate状态**: Pending

#### 技术栈清单

| 技术栈 | 查询方式 | 验证状态 | 文档位置 |
|--------|---------|---------|----------|
| asyncio | Context7 | 待验证 | /python/cpython |
| orjson | Context7 | 待验证 | /ijl/orjson |
| shutil | Python stdlib | 已验证 | 标准库 |
| FastAPI BackgroundTasks | Context7 | 待验证 | /fastapi/fastapi |

#### 核心API验证待办

**开发前必须验证**:
- [ ] asyncio.create_task() → Context7: /python/cpython
- [ ] asyncio.sleep() → Context7: /python/cpython
- [ ] asyncio.CancelledError → Context7: /python/cpython
- [ ] shutil.copy2() → Python stdlib
- [ ] FastAPI BackgroundTasks → Context7: /fastapi/fastapi

### SDD规范引用 (必填)

**API端点规范** (Epic 18 Rollback):
- `GET /api/v1/rollback/snapshots/{canvas_path}` - 列出快照
  - [Source: docs/architecture/rollback-recovery-architecture.md:312-326]
  - operationId: `listSnapshots`
  - Query参数: `limit` (int, default=20), `offset` (int, default=0)
  - 响应Schema: `SnapshotListResponse`

- `POST /api/v1/rollback/snapshot` - 创建手动快照
  - [Source: docs/architecture/rollback-recovery-architecture.md:328-342]
  - operationId: `createSnapshot`
  - 请求Body: `CreateSnapshotRequest`
  - 响应Schema: `SnapshotResponse`

**Snapshot数据模型** (Source: docs/architecture/rollback-recovery-architecture.md:212-250):
```typescript
interface Snapshot {
    id: string;                    // UUID
    canvasPath: string;            // Canvas文件路径
    timestamp: Date;               // 快照时间戳
    type: SnapshotType;            // auto | manual | checkpoint
    canvasData: CanvasJSON;        // 完整Canvas数据
    lastOperationId?: string;      // 关联的最后操作ID
    metadata: {
        description?: string;      // 快照描述
        createdBy: string;         // 创建者
        tags?: string[];           // 标签
        sizeBytes: number;         // 快照大小
    };
}

enum SnapshotType {
    AUTO = 'auto',
    MANUAL = 'manual',
    CHECKPOINT = 'checkpoint'      // 回滚前自动创建
}
```

### ADR决策关联 (必填)

| ADR编号 | 决策标题 | 对Story的影响 |
|---------|----------|---------------|
| ADR-0007 | Caching Strategy | 快照索引使用内存缓存加速查询 |
| ADR-0009 | Error Handling | 快照创建失败时的重试策略 |

**关键约束**:
- 自动快照间隔默认300秒，可配置
- 每Canvas最多50个快照，超限自动删除最旧的
- 快照文件使用gzip压缩减少磁盘占用

### 架构设计参考

**架构文档引用**:
- SnapshotManager类设计: [Source: docs/architecture/rollback-recovery-architecture.md:212-290]
- 自动快照调度: [Source: docs/architecture/rollback-recovery-architecture.md:252-280]
- 存储路径结构: [Source: docs/architecture/rollback-recovery-architecture.md:182-210]

**存储路径结构**:
```
.canvas-learning/
├── snapshots/
│   ├── {canvas_name}/
│   │   ├── snapshots_index.json   # 快照索引
│   │   └── snapshots/
│   │       ├── {snapshot_id}.json # 快照数据
```

### 代码示例库

**SnapshotManager类** (Source: docs/architecture/rollback-recovery-architecture.md:212-290):
```python
# src/rollback/snapshot_manager.py
# ✅ Verified from Architecture Doc (rollback-recovery-architecture.md:212-290)
import asyncio
from datetime import datetime, timezone
from pathlib import Path
from typing import List, Optional
import uuid
import orjson

from .models import Snapshot, SnapshotType, SnapshotMetadata

class SnapshotManager:
    """Canvas状态快照管理器

    [Source: docs/architecture/rollback-recovery-architecture.md:212-290]
    """

    def __init__(self,
                 storage_root: Path = Path(".canvas-learning"),
                 auto_interval: int = 300,
                 max_snapshots: int = 50):
        self.storage_root = storage_root
        self.auto_interval = auto_interval
        self.max_snapshots = max_snapshots
        self._auto_tasks: dict[str, asyncio.Task] = {}
        self._index_cache: dict[str, List[dict]] = {}

    async def create_snapshot(self,
                              canvas_path: str,
                              snapshot_type: SnapshotType,
                              description: Optional[str] = None,
                              created_by: str = "system") -> Snapshot:
        """创建Canvas快照

        Args:
            canvas_path: Canvas文件路径
            snapshot_type: 快照类型 (auto/manual/checkpoint)
            description: 快照描述
            created_by: 创建者

        Returns:
            创建的Snapshot对象
        """
        # 读取当前Canvas数据
        canvas_data = await self._read_canvas(canvas_path)

        snapshot = Snapshot(
            id=str(uuid.uuid4()),
            canvas_path=canvas_path,
            timestamp=datetime.now(timezone.utc),
            type=snapshot_type,
            canvas_data=canvas_data,
            metadata=SnapshotMetadata(
                description=description,
                created_by=created_by,
                size_bytes=len(orjson.dumps(canvas_data))
            )
        )

        # 保存快照
        await self._save_snapshot(snapshot)

        # 清理旧快照
        await self._cleanup_old_snapshots(canvas_path)

        return snapshot

    async def start_auto_snapshot(self, canvas_path: str):
        """启动自动快照任务"""
        if canvas_path in self._auto_tasks:
            return

        task = asyncio.create_task(
            self._auto_snapshot_loop(canvas_path)
        )
        self._auto_tasks[canvas_path] = task

    async def _auto_snapshot_loop(self, canvas_path: str):
        """自动快照循环"""
        while True:
            await asyncio.sleep(self.auto_interval)
            try:
                await self.create_snapshot(
                    canvas_path,
                    SnapshotType.AUTO,
                    description="Auto snapshot"
                )
            except Exception as e:
                # 记录错误但继续循环
                pass
```

### 文件路径参考

**需要新增的文件**:
- 新增: `src/rollback/snapshot_manager.py` - SnapshotManager类

**需要修改的文件**:
- 修改: `src/rollback/models.py` - 添加Snapshot模型
- 修改: `backend/app/api/v1/endpoints/rollback.py` - 添加快照端点
- 修改: `backend/app/models/rollback.py` - 添加Snapshot schemas

### 依赖关系

**前置Story**:
- Story 18.1: Operation Tracker（提供lastOperationId关联）

**后续影响**:
- Story 18.3: Rollback Engine（依赖本Story的快照进行恢复）
- Story 18.5: API和配置（依赖本Story的REST端点）

### Definition of Done

- [ ] 所有AC通过验收测试
- [ ] `SnapshotManager` 支持3种快照类型
- [ ] 自动快照调度器工作正常
- [ ] 超限自动清理功能正常
- [ ] REST API端点可用
- [ ] 单元测试覆盖率≥90%
- [ ] 代码Review通过
- [ ] 所有代码有文档来源标注

### 风险和缓解

| 风险 | 概率 | 影响 | 缓解措施 |
|------|------|------|---------|
| 大Canvas快照磁盘占用 | 中 | 中 | 压缩存储 + 限制数量 |
| 自动快照任务泄漏 | 低 | 中 | 使用弱引用 + 清理机制 |
| 并发快照创建冲突 | 低 | 低 | 使用asyncio.Lock |

### 估算

- **Story Points**: 5
- **预估工时**: 2天
- **复杂度**: 中（涉及异步调度、磁盘存储）

---

**文档版本**: v1.0.0
**创建时间**: 2025-12-04
**创建者**: SM Agent (Bob)
**Epic**: Epic 18 - 数据迁移和回滚
