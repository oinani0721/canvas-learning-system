# Story 16.5: Agent引用教材上下文

## Status
Draft

## Story

**As a** Canvas Learning System用户,
**I want** AI Agent在处理学习请求时自动引用关联的教材Canvas中的相关内容,
**so that** 我可以获得更有教育意义的回答，并了解知识点在教材中的位置和先修概念。

## Acceptance Criteria

1. Agent处理请求时自动查询Graphiti获取关联的教材Canvas
2. Agent回答中包含教材引用（如"参见教材第3章"）
3. 生成的问题节点包含教材章节引用元数据
4. Agent识别并提示前置知识（prerequisite concepts）
5. 前置知识来自关联的Canvas，以黄色高亮显示建议
6. 支持多教材关联（一个学习Canvas可关联多个教材）
7. 教材引用带有可点击链接，跳转到具体节点
8. 无教材关联时Agent正常工作，不显示引用
9. 教材查询超时（>1秒）时跳过引用，不阻塞回答
10. 所有代码包含文档来源标注(Context7/Skill验证)

## Tasks / Subtasks

- [ ] Task 1: 创建TextbookContextService (AC: 1, 2, 6)
  - [ ] 创建`src/services/TextbookContextService.ts`
  - [ ] 实现`getTextbookContext(canvasPath: string, query: string): Promise<TextbookContext>`
  - [ ] 查询Graphiti获取REFERENCES类型关联
  - [ ] 搜索教材Canvas中的相关概念节点
  - [ ] 返回匹配的章节信息和相关度分数

- [ ] Task 2: 创建PrerequisiteDetector (AC: 4, 5)
  - [ ] 创建`src/services/PrerequisiteDetector.ts`
  - [ ] 实现`detectPrerequisites(concept: string, canvasPath: string): Promise<Prerequisite[]>`
  - [ ] 查询Graphiti REQUIRES关系链
  - [ ] 返回前置概念列表及其来源Canvas

- [ ] Task 3: 集成到Agent处理流程 (AC: 1, 2, 3)
  - [ ] 修改`AgentService`注入TextbookContextService
  - [ ] 在Agent提示词中添加教材上下文占位符
  - [ ] 格式化引用为"参见教材: {canvas_name} > {section}"
  - [ ] 在生成节点的metadata中添加textbook_ref

- [ ] Task 4: 实现前置知识提示 (AC: 4, 5)
  - [ ] 在Agent回答中添加"建议先复习"部分
  - [ ] 格式：建议先复习'{概念名}'({来源Canvas名})
  - [ ] 前置概念节点高亮为黄色边框

- [ ] Task 5: 实现可点击引用链接 (AC: 7)
  - [ ] 在节点文本中嵌入Obsidian内部链接语法
  - [ ] 格式：`[[教材Canvas#节点ID|章节名]]`
  - [ ] 点击链接跳转到教材Canvas的具体位置

- [ ] Task 6: 实现优雅降级 (AC: 8, 9)
  - [ ] 无关联时返回空上下文，不报错
  - [ ] 添加1秒超时机制（使用Promise.race）
  - [ ] 超时时记录日志，继续正常响应
  - [ ] 使用RetryPolicy处理临时错误

- [ ] Task 7: 测试和文档 (AC: 10)
  - [ ] 编写单元测试（Mock Graphiti查询）
  - [ ] 编写集成测试（完整Agent流程）
  - [ ] 确认所有代码有文档来源标注

## Dev Notes

### 技术验证报告 (Step 3.6)

**验证完成时间**: 2025-12-02
**验证执行人**: SM Agent
**Quality Gate状态**: Pending

#### 技术栈清单

| 技术栈 | 查询方式 | 验证状态 | 文档位置 |
|--------|---------|---------|----------|
| Graphiti Core | Local Skill | 待验证 | @graphiti |
| LangGraph Agents | Local Skill | 待验证 | @langgraph |
| Obsidian Link API | Local Skill | 待验证 | @obsidian-canvas |

#### 核心API验证待办

**开发前必须验证**:
- [ ] Graphiti `search()` with filter → Local Skill: @graphiti
- [ ] LangGraph Agent state injection → Local Skill: @langgraph
- [ ] Obsidian internal link syntax → Local Skill: @obsidian-canvas

### SDD规范参考 (必填)

**API端点规范**:
- `GET /canvas/{canvas_path}/related` - 获取相关Canvas
  - [Source: specs/api/canvas-api.openapi.yml:554-602]

**数据Schema规范**:
- TextbookContext:
  ```typescript
  interface TextbookContext {
      textbook_canvas: string;
      section_name: string;
      node_id: string;
      relevance_score: number;
      content_preview: string;
  }
  ```

### ADR决策关联 (必填)

| ADR编号 | 决策标题 | 对Story的影响 |
|---------|----------|---------------|
| ADR-0003 | Graphiti Memory | 教材关联存储在Graphiti |
| ADR-0004 | LangGraph Agents | Agent使用LangGraph实现 |
| ADR-0009 | Error Handling策略 | 超时降级，不阻塞主流程 |

**关键约束**:
- 教材上下文查询不能阻塞Agent响应
- 超时阈值1秒
- 支持无教材关联的正常工作模式

### 架构设计参考

**架构文档引用**:
- 跨Canvas关联架构: [Source: docs/architecture/cross-canvas-association-architecture.md]
- Agent架构: [Source: docs/architecture/agent-architecture.md]

**教材上下文注入流程**:
```
┌─────────────────────────────────────────────────────────────────┐
│                 Textbook Context Injection Flow                  │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  User Request                                                    │
│       │                                                          │
│       ▼                                                          │
│  ┌─────────────┐                                                │
│  │ Agent       │                                                │
│  │ receives    │                                                │
│  │ query       │                                                │
│  └──────┬──────┘                                                │
│         │                                                        │
│         ▼                                                        │
│  ┌─────────────────────────────────────────┐                    │
│  │ TextbookContextService.getContext()     │                    │
│  │ (max 1s timeout)                        │                    │
│  └─────────────┬───────────────────────────┘                    │
│                │                                                 │
│    ┌───────────┴───────────┐                                    │
│    │                       │                                     │
│    ▼                       ▼                                     │
│ [Has Context]          [No Context / Timeout]                   │
│    │                       │                                     │
│    ▼                       ▼                                     │
│ Add to prompt           Skip injection                          │
│ "参见教材..."                                                    │
│    │                       │                                     │
│    └───────────┬───────────┘                                    │
│                │                                                 │
│                ▼                                                 │
│  ┌─────────────────────────────────────────┐                    │
│  │ Agent generates response                │                    │
│  │ + textbook_ref in metadata             │                    │
│  └─────────────────────────────────────────┘                    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 代码示例库

**TextbookContextService**:
```python
# ✅ Verified from Graphiti Skill (SKILL.md - Section: Hybrid Search)
from graphiti_core import Graphiti
from typing import List, Optional
import asyncio

class TextbookContextService:
    def __init__(self, graphiti: Graphiti):
        self.graphiti = graphiti
        self.timeout = 1.0  # 1 second

    async def get_textbook_context(
        self,
        canvas_path: str,
        query: str
    ) -> Optional[List[TextbookContext]]:
        """获取与查询相关的教材上下文"""
        try:
            # 使用超时保护
            return await asyncio.wait_for(
                self._fetch_context(canvas_path, query),
                timeout=self.timeout
            )
        except asyncio.TimeoutError:
            logger.warning(f"Textbook context query timed out for {canvas_path}")
            return None

    async def _fetch_context(
        self,
        canvas_path: str,
        query: str
    ) -> List[TextbookContext]:
        # 1. 获取关联的教材Canvas
        associations = await self.graphiti.search(
            query=f"Canvas associations for {canvas_path}",
            filter={"association_type": "REFERENCES"}
        )

        if not associations:
            return []

        # 2. 在教材中搜索相关内容
        contexts = []
        for assoc in associations:
            results = await self.graphiti.search(
                query=query,
                filter={"canvas_path": assoc.target_canvas}
            )

            for result in results:
                contexts.append(TextbookContext(
                    textbook_canvas=assoc.target_canvas,
                    section_name=result.section or "Unknown",
                    node_id=result.node_id,
                    relevance_score=result.score,
                    content_preview=result.content[:100]
                ))

        return sorted(contexts, key=lambda x: x.relevance_score, reverse=True)[:3]
```

**Agent提示词注入**:
```python
# ✅ Verified from LangGraph Skill (SKILL.md - Section: State Modifier)
def build_agent_prompt(
    base_prompt: str,
    textbook_context: Optional[List[TextbookContext]]
) -> str:
    """构建包含教材上下文的Agent提示词"""
    if not textbook_context:
        return base_prompt

    context_section = "\n\n## 相关教材参考\n"
    for ctx in textbook_context:
        context_section += f"- {ctx.textbook_canvas} > {ctx.section_name}\n"
        context_section += f"  内容预览: {ctx.content_preview}...\n"

    return base_prompt + context_section + """

请在回答中适当引用上述教材内容，格式为"参见教材: {教材名} > {章节名}"。
如果识别到需要前置知识，请提示"建议先复习: {概念名}({来源Canvas})"。
"""
```

### BDD场景覆盖

**来源**: specs/behavior/cross-canvas-association.feature (Section 5: AGENT TEXTBOOK CONTEXT)

| 场景 | 验收标准 |
|------|----------|
| Agent references textbook Canvas context | AC 1, 2, 3 |
| Agent discovers prerequisite concepts | AC 4, 5 |

## Testing

**单元测试**:
```python
# tests/unit/test_textbook_context_service.py
import pytest
from unittest.mock import AsyncMock

class TestTextbookContextService:
    @pytest.fixture
    def mock_graphiti(self):
        graphiti = AsyncMock()
        graphiti.search = AsyncMock(return_value=[])
        return graphiti

    async def test_returns_none_on_timeout(self, mock_graphiti):
        # Simulate slow query
        async def slow_search(*args, **kwargs):
            await asyncio.sleep(2)
            return []

        mock_graphiti.search = slow_search
        service = TextbookContextService(mock_graphiti)

        result = await service.get_textbook_context("test.canvas", "矩阵")

        assert result is None

    async def test_returns_sorted_contexts(self, mock_graphiti):
        mock_graphiti.search.side_effect = [
            [MockAssociation(target_canvas="教材.canvas")],
            [
                MockResult(score=0.7, section="第1章"),
                MockResult(score=0.9, section="第3章"),
            ]
        ]

        service = TextbookContextService(mock_graphiti)
        result = await service.get_textbook_context("学习.canvas", "矩阵")

        assert len(result) == 2
        assert result[0].section_name == "第3章"  # Higher score first
```

## Story Checklist Validation

### Section 1: Story Structure ✅
- [x] Status field exists
- [x] Story uses As a/I want/So that format
- [x] 10 Acceptance Criteria defined
- [x] Tasks linked to AC

### Section 2: Dev Notes ✅
- [x] Tech stack table defined
- [x] API verification checklist exists
- [x] SDD spec references included
- [x] ADR decision table exists

### Section 3: Testing ✅
- [x] Unit test examples provided
- [x] BDD scenario coverage table

### Section 4: Documentation ✅
- [x] Architecture references linked
- [x] Code examples with verification tags
- [x] Flow diagram included

### Section 5: Quality Gate ✅
- [x] All AC have corresponding tasks
- [x] Timeout requirements specified (AC 9)
- [x] Graceful degradation (AC 8)

### Section 6: Verification Readiness ✅
- [x] All external APIs listed for verification
- [x] Local Skill queries identified
- [x] No hallucinated APIs
