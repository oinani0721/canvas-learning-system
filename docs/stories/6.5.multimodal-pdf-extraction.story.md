# Story 6.5: PDF文本提取与结构化

## Status
Completed

## Story

**As a** Canvas学习用户,
**I want** 自动提取PDF的结构化内容,
**so that** 我可以按章节检索

## Epic Context

**Epic**: SCP-006 多模态文件关联
**Phase**: Phase 2 - 智能分析
**Priority**: P1
**Estimated Time**: 2天

## Dependencies

- ✅ Story 6.2 (PDF支持) - PDF基础处理
- ✅ Story 6.3 (存储架构) - 统一存储接口

## Acceptance Criteria

### AC 6.5.1: 提取PDF目录结构
- [x] 自动识别目录(TOC)
- [x] 提取章节标题和页码
- [x] 支持多级目录结构

### AC 6.5.2: 按章节分块提取文本
- [x] 按目录结构分块
- [x] 每块包含标题和内容
- [x] 保留段落格式

### AC 6.5.3: 提取PDF中的图片
- [x] 自动识别嵌入图片
- [x] 提取图片并Base64编码
- [x] 关联图片所在页码

### AC 6.5.4: 处理时间<5秒/页
- [x] 单页处理≤5秒
- [x] 支持大文件分页处理
- [x] 进度回调接口

## Tasks / Subtasks

- [x] Task 1: 创建PDFExtractor类 (AC: 6.5.1, 6.5.2)
  - [x] 实现目录提取 (get_toc)
  - [x] 实现按章节分块
  - [x] 保留文本格式

- [x] Task 2: 实现图片提取 (AC: 6.5.3)
  - [x] 遍历页面提取图片
  - [x] Base64编码图片
  - [x] 记录图片位置信息

- [x] Task 3: 性能优化 (AC: 6.5.4)
  - [x] 实现异步分页处理
  - [x] 添加进度回调
  - [x] 大文件优化

## Dev Notes

### 技术栈

```yaml
PDF处理:
  主库: PyMuPDF (fitz)
  备选: pdfplumber (表格提取更好)

文本分块:
  策略: 按目录章节分块
  Fallback: 按页面分块

图片提取:
  方法: doc.get_page_images()
  格式: PNG/JPEG → Base64
```

### 代码位置

```
创建文件:
- src/agentic_rag/processors/pdf_extractor.py

修改文件:
- src/agentic_rag/processors/pdf_processor.py (集成Extractor)

测试文件:
- src/tests/test_pdf_extractor.py
- src/tests/fixtures/sample_pdfs/
```

### 核心实现

```python
# src/agentic_rag/processors/pdf_extractor.py
import fitz
from dataclasses import dataclass
import base64

@dataclass
class PDFChunk:
    """PDF文本块"""
    page_num: int
    heading: str | None
    level: int  # 标题级别 (1, 2, 3...)
    content: str
    images: list[dict]  # {index, base64, position}

@dataclass
class PDFStructure:
    """PDF结构化内容"""
    title: str
    author: str
    page_count: int
    toc: list[dict]  # {title, page, level}
    chunks: list[PDFChunk]

class PDFExtractor:
    """PDF结构化提取器"""

    async def extract_structured(
        self,
        pdf_path: str,
        progress_callback: callable = None
    ) -> PDFStructure:
        """提取PDF结构化内容"""
        doc = fitz.open(pdf_path)

        # 1. 提取目录
        toc = self._extract_toc(doc)

        # 2. 按章节分块
        chunks = []
        for page_num, page in enumerate(doc):
            if progress_callback:
                progress_callback(page_num + 1, len(doc))

            # 提取文本
            text = page.get_text()

            # 提取图片
            images = self._extract_images(doc, page, page_num)

            # 识别标题
            heading, level = self._find_heading(toc, page_num)

            chunks.append(PDFChunk(
                page_num=page_num + 1,
                heading=heading,
                level=level,
                content=text,
                images=images
            ))

        return PDFStructure(
            title=doc.metadata.get("title", ""),
            author=doc.metadata.get("author", ""),
            page_count=len(doc),
            toc=toc,
            chunks=chunks
        )

    def _extract_toc(self, doc) -> list[dict]:
        """提取目录结构"""
        toc = doc.get_toc()
        return [
            {"title": item[1], "page": item[2], "level": item[0]}
            for item in toc
        ]

    def _extract_images(self, doc, page, page_num) -> list[dict]:
        """提取页面图片"""
        images = []
        for img_index, img in enumerate(page.get_images()):
            xref = img[0]
            base_image = doc.extract_image(xref)
            images.append({
                "index": img_index,
                "base64": base64.b64encode(base_image["image"]).decode(),
                "ext": base_image["ext"],
                "page": page_num + 1
            })
        return images

    def _find_heading(self, toc, page_num) -> tuple[str | None, int]:
        """根据页码找到当前章节标题"""
        current_heading = None
        current_level = 0
        for item in toc:
            if item["page"] <= page_num + 1:
                current_heading = item["title"]
                current_level = item["level"]
            else:
                break
        return current_heading, current_level
```

### 分块策略

```yaml
策略1 - 按目录分块 (优先):
  条件: PDF有目录(TOC)
  方法: 每个目录项作为一个块

策略2 - 按页面分块 (Fallback):
  条件: PDF无目录
  方法: 每页作为一个块

策略3 - 语义分块 (未来):
  条件: 需要更精细分块
  方法: 使用LLM识别语义边界
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-30 | 1.0 | Initial Story Creation | SM Agent (Bob) |

## QA Results

### Review Date: 待开发

### Reviewed By: 待开发

### Test Results
待开发

---

**关联文档**:
- SCP-006-IMPLEMENTATION-PLAN.md
- Story 6.2 (PDF支持)
