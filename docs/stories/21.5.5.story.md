# Story 21.5.5: æ’ä»¶é”™è¯¯æ˜¾ç¤ºå¢å¼º

## Status
Draft - PO Validated âœ…

## Epic Context & Background

**æ‰€å±Epic**: EPIC-21.5 - Agentç«¯ç‚¹å¯é æ€§ä¿®å¤
**Epicæ–‡æ¡£**: [EPIC-21.5-AGENT-RELIABILITY-FIX.md](../prd/EPIC-21.5-AGENT-RELIABILITY-FIX.md)

**æœ¬Storyåœ¨Epicä¸­çš„å®šä½**:
- Story 21.5.5æ˜¯Epic 21.5çš„ç¬¬5ä¸ªStoryï¼Œè´Ÿè´£å‰ç«¯(Obsidianæ’ä»¶)é”™è¯¯æ˜¾ç¤ºå¢å¼º
- **ä¾èµ–**: Story 21.5.1 (CORSå“åº”å¤´ä¿®å¤), Story 21.5.3 (Bugè¿½è¸ªæ—¥å¿—ç³»ç»Ÿ)
- **é£é™©å£°æ˜**: Stories 21.5.1-21.5.4å°šæœªåˆ›å»ºï¼Œæœ¬Storyæå‰å¼€å‘ï¼Œéœ€æ³¨æ„åç«¯æ¥å£çº¦å®š

**Epicæ ¸å¿ƒé—®é¢˜å›é¡¾**:

### Problem 1: 500é”™è¯¯æ—¶CORSå¤´ç¼ºå¤±
- **ç°è±¡**: `CORS policy: No 'Access-Control-Allow-Origin' header is present`
- **æ ¹å› **: FastAPIåœ¨æœªå¤„ç†å¼‚å¸¸æ—¶ï¼ŒCORSä¸­é—´ä»¶ä¸æ·»åŠ å“åº”å¤´
- **æœ¬Storyå…³è”**: æœ¬Storyéœ€è¦è§£æåç«¯è¿”å›çš„å¢å¼ºé”™è¯¯å“åº”

### Problem 2: ç”¨æˆ·æ— æ³•çŸ¥é“å…·ä½“é”™è¯¯
- **ç°è±¡**: æ’ä»¶åªæ˜¾ç¤º"ç½‘ç»œé”™è¯¯"ï¼Œæ— å…·ä½“ä¿¡æ¯
- **æ ¹å› **: å½“å‰é”™è¯¯å¤„ç†è¿‡äºç®€å•ï¼Œåªæ˜¾ç¤ºåŸºç¡€é”™è¯¯æ¶ˆæ¯
- **æœ¬Storyä¿®å¤**: å¢å¼ºé”™è¯¯è§£æï¼Œæ˜¾ç¤ºerror_typeã€bug_idã€è¯¦ç»†ä¿¡æ¯

---

## Story

**As a** Canvas Learning Systemç”¨æˆ·,
**I want** åœ¨Agentè°ƒç”¨å¤±è´¥æ—¶çœ‹åˆ°è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯,
**so that** æˆ‘èƒ½ç†è§£é—®é¢˜åŸå› ï¼Œå¹¶èƒ½æä¾›bug_idè¿›è¡Œé—®é¢˜æŠ¥å‘Šã€‚

---

## Acceptance Criteria

### AC 1: Agentè°ƒç”¨é”™è¯¯æ˜¾ç¤ºbug_idã€error_typeå’Œç”¨æˆ·å‹å¥½æ¶ˆæ¯ (éªŒè¯Problem 2ä¿®å¤)
- å½“Agentç«¯ç‚¹è¿”å›500é”™è¯¯æ—¶ï¼ŒNoticeæ˜¾ç¤ºåŒ…å«ï¼š
  - é”™è¯¯ç±»å‹ (å¦‚ `ConfigurationError`, `AIProviderError`)
  - è¯¦ç»†é”™è¯¯ä¿¡æ¯ (å¦‚ `Invalid API key format`)
  - bug_id (å¦‚ `BUG-A1B2C3D4`) ç”¨äºé—®é¢˜è¿½è¸ª
- **Epicå…³è”**: ç›´æ¥éªŒè¯Problem 2 "ç”¨æˆ·æ— æ³•çŸ¥é“å…·ä½“é”™è¯¯"çš„ä¿®å¤

### AC 2: ä¸åŒé”™è¯¯ç±»å‹æ˜¾ç¤ºä¸åŒæ ·å¼ (NetworkError, TimeoutError, HttpError5xx, HttpError4xx)
- NetworkError: æ˜¾ç¤ºç½‘ç»œè¿æ¥é—®é¢˜æç¤º
- TimeoutError: æ˜¾ç¤ºè¶…æ—¶æç¤ºï¼Œå»ºè®®é‡è¯•
- HttpError5xx: æ˜¾ç¤ºæœåŠ¡å™¨é”™è¯¯ + bug_id
- HttpError4xx: æ˜¾ç¤ºè¯·æ±‚é”™è¯¯è¯¦æƒ…
- **Epicå…³è”**: å¢å¼ºé”™è¯¯åˆ†ç±»æ˜¾ç¤ºï¼Œæå‡ç”¨æˆ·ä½“éªŒ

### AC 3: å¯é‡è¯•é”™è¯¯æä¾›é‡è¯•æŒ‰é’®
- NetworkErrorã€TimeoutErrorã€HttpError5xxæ˜¾ç¤º"é‡è¯•"æ“ä½œæç¤º
- HttpError4xxä¸æä¾›é‡è¯•ï¼ˆè¯·æ±‚æœ¬èº«æœ‰é—®é¢˜ï¼‰
- **ADRå…³è”**: ADR-009å®šä¹‰çš„RETRYABLE_ERROR_TYPES

### AC 4: é”™è¯¯å†å²å¯åœ¨è®¾ç½®é¢æ¿æŸ¥çœ‹
- è®¾ç½®é¢æ¿æ–°å¢"é”™è¯¯å†å²"Tab
- æ˜¾ç¤ºæœ€è¿‘20æ¡é”™è¯¯è®°å½•
- æ¯æ¡è®°å½•åŒ…å«ï¼šæ—¶é—´ã€é”™è¯¯ç±»å‹ã€bug_idã€é”™è¯¯æ¶ˆæ¯
- **Epicå…³è”**: ä¾¿äºç”¨æˆ·æŸ¥çœ‹å†å²é”™è¯¯è¿›è¡Œé—®é¢˜æŠ¥å‘Š

### AC 5: è‡ªåŠ¨æ¸…ç†è¶…è¿‡7å¤©çš„é”™è¯¯å†å²
- æ’ä»¶å¯åŠ¨æ—¶è‡ªåŠ¨æ¸…ç†è¿‡æœŸé”™è¯¯
- é¿å…æœ¬åœ°å­˜å‚¨è¿‡å¤§
- **NFRå…³è”**: ç¬¦åˆNFR-2æ—¥å¿—å¤§å°æ§åˆ¶è¦æ±‚

---

## Tasks / Subtasks

### ä»»åŠ¡1: å¢å¼ºApiClienté”™è¯¯è§£æ (AC: 1, 2)
- [ ] 1.1: ä¿®æ”¹ `ApiClient.ts` ä¸­çš„ `normalizeError` æ–¹æ³•
  - è§£æåç«¯JSONå“åº”ä¸­çš„ `bug_id`, `error_type`, `detail` å­—æ®µ
  - æ˜ å°„åˆ° `ApiError` ç±»çš„æ–°å±æ€§
- [ ] 1.2: æ‰©å±• `ApiError` ç±»
  - æ–°å¢ `bugId: string` å±æ€§
  - æ–°å¢ `errorType: string` å±æ€§ (åç«¯è¿”å›çš„å…·ä½“ç±»å‹)
  - æ–°å¢ `retryable: boolean` å±æ€§
- [ ] 1.3: å®ç° `handleErrorResponse` æ–¹æ³•å¢å¼º
  - å°è¯•è§£æJSONå“åº”ä½“
  - æå– `bug_id`, `error_type`, `detail` æˆ– `message`
  - å›é€€åˆ°HTTPçŠ¶æ€ç æè¿°

### ä»»åŠ¡2: å®ç°å¢å¼ºNoticeæ˜¾ç¤º (AC: 1, 2, 3)
- [ ] 2.1: åˆ›å»º `ErrorNotificationService.ts` æœåŠ¡ç±»
  - å‚è€ƒADR-009çš„NotificationManagerè®¾è®¡
  - å®ç° `showAgentError(error: ApiError)` æ–¹æ³•
- [ ] 2.2: å®ç°é”™è¯¯ç±»å‹æ ·å¼åŒºåˆ†
  - NetworkError: ä½¿ç”¨ `notice-warning` æ ·å¼
  - TimeoutError: ä½¿ç”¨ `notice-warning` æ ·å¼ + è¶…æ—¶å›¾æ ‡
  - HttpError5xx: ä½¿ç”¨ `notice-error` æ ·å¼ + æ˜¾ç¤ºbug_id
  - HttpError4xx: ä½¿ç”¨ `notice-error` æ ·å¼
- [ ] 2.3: å®ç°å¸¦æŒ‰é’®çš„è‡ªå®šä¹‰Notice (å¯é‡è¯•é”™è¯¯)
  - ä½¿ç”¨ `document.createDocumentFragment()` åˆ›å»ºå¤æ‚å†…å®¹
  - æ·»åŠ "é‡è¯•"æŒ‰é’®ï¼ˆä»…å¯¹å¯é‡è¯•é”™è¯¯ï¼‰
  - æŒ‰é’®ç‚¹å‡»è§¦å‘åŸæ“ä½œé‡è¯•

### ä»»åŠ¡3: å®ç°é”™è¯¯å†å²å­˜å‚¨ (AC: 4, 5)
- [ ] 3.1: åˆ›å»º `ErrorHistoryManager.ts`
  - ä½¿ç”¨æ’ä»¶çš„ `loadData()`/`saveData()` æŒä¹…åŒ–
  - å®šä¹‰ `ErrorRecord` æ¥å£
  - å®ç° `addError()`, `getRecent()`, `cleanup()` æ–¹æ³•
- [ ] 3.2: å®ç°è¿‡æœŸæ¸…ç†é€»è¾‘
  - æ’ä»¶ `onload()` æ—¶è°ƒç”¨ `cleanup()`
  - åˆ é™¤ timestamp > 7å¤©çš„è®°å½•
  - ä¿ç•™æœ€å¤š100æ¡è®°å½•

### ä»»åŠ¡4: è®¾ç½®é¢æ¿é”™è¯¯å†å²Tab (AC: 4)
- [ ] 4.1: ä¿®æ”¹ `PluginSettingsTab.ts`
  - æ–°å¢"é”™è¯¯å†å²"åˆ†åŒº
  - æ˜¾ç¤ºé”™è¯¯è®°å½•åˆ—è¡¨
- [ ] 4.2: å®ç°é”™è¯¯è®°å½•æ¸²æŸ“
  - æ—¶é—´æˆ³æ ¼å¼åŒ–æ˜¾ç¤º
  - é”™è¯¯ç±»å‹å›¾æ ‡
  - bug_idå¯ç‚¹å‡»å¤åˆ¶
  - å±•å¼€æŸ¥çœ‹è¯¦ç»†æ¶ˆæ¯

### ä»»åŠ¡5: é›†æˆåˆ°main.tsé”™è¯¯å¤„ç† (AC: 1, 2, 3)
- [ ] 5.1: é‡æ„æ‰€æœ‰Agentè°ƒç”¨çš„catchå—
  - æ›¿æ¢ç®€å• `new Notice()` ä¸º `ErrorNotificationService`
  - è®°å½•é”™è¯¯åˆ° `ErrorHistoryManager`
- [ ] 5.2: æ›´æ–°ä»¥ä¸‹æ–¹æ³•çš„é”™è¯¯å¤„ç†:
  - `executeBasicDecompose`
  - `executeDeepDecompose`
  - `executeOralExplanation`
  - `executeMemoryAnchor`
  - `executeFourLevelExplanation`
  - `executeComparisonTable`
  - `executeExampleTeaching`
  - `executeScoring`

### ä»»åŠ¡6: å•å…ƒæµ‹è¯• (AC: 1, 2, 3, 4, 5)
- [ ] 6.1: ApiClienté”™è¯¯è§£ææµ‹è¯•
  - æµ‹è¯•å„ç§HTTPé”™è¯¯å“åº”çš„è§£æ
  - æµ‹è¯•bug_idæå–
- [ ] 6.2: ErrorHistoryManageræµ‹è¯•
  - æµ‹è¯•æ·»åŠ ã€è·å–ã€æ¸…ç†åŠŸèƒ½
  - æµ‹è¯•7å¤©è¿‡æœŸé€»è¾‘

---

## Dev Notes

### Dependencies Verification (å‰ç½®ä¾èµ–éªŒè¯)

**Storyä¾èµ–** (å·²ç¡®è®¤å°šæœªåˆ›å»ºï¼Œéœ€æ³¨æ„æ¥å£çº¦å®š):
- [ ] Story 21.5.1 (CORSä¿®å¤) - åç«¯è¿”å›CORSå¤´ - **å°šæœªåˆ›å»º**
- [ ] Story 21.5.3 (Bugè¿½è¸ª) - åç«¯è¿”å›bug_idå­—æ®µ - **å°šæœªåˆ›å»º**

**åç«¯æ¥å£çº¦å®š** (åŸºäºEpic 21.5å®šä¹‰):
```typescript
// åç«¯500é”™è¯¯å“åº”æ ¼å¼ (Story 21.5.1å®ç°å)
interface BackendErrorResponse {
  detail: string;      // é”™è¯¯è¯¦æƒ…
  error_type: string;  // é”™è¯¯ç±»å‹åç§°
  bug_id?: string;     // Bugè¿½è¸ªID (Story 21.5.3å®ç°å)
}
```

**å·²éªŒè¯å­˜åœ¨çš„ç±»/æ¥å£**:
- [x] `ApiError` ç±»: `canvas-progress-tracker/obsidian-plugin/src/api/types.ts:31`
- [x] `ApiClient` ç±»: `canvas-progress-tracker/obsidian-plugin/src/api/ApiClient.ts`
- [x] `ErrorType` ç±»å‹: `canvas-progress-tracker/obsidian-plugin/src/api/types.ts:18`
- [x] `PluginSettingsTab` ç±»: `canvas-progress-tracker/obsidian-plugin/src/settings/PluginSettingsTab.ts`

### SDDè§„èŒƒå¼•ç”¨ (å¿…å¡«)

**OpenAPIè§„èŒƒ** [Source: specs/api/agent-api.openapi.yml]:
```yaml
# Agent API Errorå“åº”å®šä¹‰
Error:
  type: object
  required: [error, message]
  properties:
    error: { type: string, example: "AgentNotFoundError" }
    message: { type: string }
    details: { type: object, additionalProperties: true }
```

**JSON Schema** [Source: specs/data/error-response.schema.json]:
```json
{
  "type": "object",
  "required": ["code", "message"],
  "properties": {
    "code": { "type": "integer", "description": "é”™è¯¯ç " },
    "message": { "type": "string", "description": "é”™è¯¯ä¿¡æ¯" },
    "details": { "type": "object", "description": "é¢å¤–é”™è¯¯è¯¦æƒ…" }
  }
}
```

### ADRå…³è” (å¿…å¡«)

**ADR-009: Error Handling & Retry Strategy** [Source: docs/architecture/decisions/ADR-009-ERROR-HANDLING-RETRY-STRATEGY.md]

å…³é”®å†³ç­–:
1. **é”™è¯¯åˆ†ç±»**: å®šä¹‰ErrorTypeæšä¸¾ (NetworkError, TimeoutError, HttpError5xx, HttpError4xx, UnknownError)
2. **å¯é‡è¯•é”™è¯¯**: RETRYABLE_ERROR_TYPES = ['NetworkError', 'TimeoutError', 'HttpError5xx']
3. **NotificationManageræ¨¡å¼**: ç»Ÿä¸€é”™è¯¯é€šçŸ¥æ˜¾ç¤º

```typescript
// ADR-009å®šä¹‰çš„NotificationManageræ¥å£
export enum NotificationLevel {
  INFO = 'info',
  WARNING = 'warning',
  ERROR = 'error',
  FATAL = 'fatal',
}

// é”™è¯¯é€šçŸ¥æ˜ å°„
export const ERROR_NOTIFICATION_MAP: Record<number, {
  level: NotificationLevel;
  message: string;
  action?: { label: string; settingsTab?: string };
}>
```

### æŠ€æœ¯éªŒè¯æŠ¥å‘Š (Context7/Skills)

**Obsidian API Noticeæ¨¡å¼** [Source: Context7:/obsidianmd/obsidian-api (topic: Notice Modal plugin)]:
```typescript
// ç®€å•Notice
new Notice('This is a simple notice');

// å®šæ—¶Notice (10ç§’)
new Notice('Error message', 10000);

// æŒä¹…Notice (æ‰‹åŠ¨å…³é—­)
const notice = new Notice('Processing...', 0);
notice.hide();

// å¸¦æ ·å¼çš„Notice
const notice = new Notice('', 5000);
notice.noticeEl.addClass('notice-error');
notice.setMessage('Error occurred!');

// å¸¦æŒ‰é’®çš„è‡ªå®šä¹‰Notice
const notice = new Notice('', 0);
const fragment = document.createDocumentFragment();
fragment.createEl('span', { text: 'Error: ' });
const button = fragment.createEl('button', { text: 'Retry' });
button.addEventListener('click', () => {
    // é‡è¯•é€»è¾‘
    notice.hide();
});
notice.setMessage(fragment);
```

### ç°æœ‰ä»£ç åˆ†æ

**å½“å‰ApiErrorç±»** [Source: types.ts:31-42]:
```typescript
export class ApiError extends Error {
  constructor(
    message: string,
    public type: ErrorType,
    public statusCode?: number,
    public details?: Record<string, unknown>
  ) {
    super(message);
    this.name = 'ApiError';
    Object.setPrototypeOf(this, ApiError.prototype);
  }
}
```

**å½“å‰é”™è¯¯å¤„ç†æ¨¡å¼** [Source: main.ts]:
```typescript
// å½“å‰ç®€å•é”™è¯¯æ˜¾ç¤º
} catch (error) {
  const msg = error instanceof Error ? error.message : 'æœªçŸ¥é”™è¯¯';
  new Notice(`æ‹†è§£å¤±è´¥: ${msg}`);
}
```

**éœ€è¦å¢å¼ºä¸º**:
```typescript
// å¢å¼ºåçš„é”™è¯¯æ˜¾ç¤º
} catch (error) {
  if (error instanceof ApiError) {
    this.errorNotificationService.showAgentError(error, {
      operation: 'decompose_basic',
      onRetry: () => this.executeBasicDecompose(context)
    });
    this.errorHistoryManager.addError(error);
  } else {
    new Notice(`æœªçŸ¥é”™è¯¯: ${error.message}`);
  }
}
```

### å®ç°æŒ‡å—

#### 1. æ‰©å±•ApiErrorç±»

```typescript
// types.ts - æ‰©å±•ApiError
export class ApiError extends Error {
  constructor(
    message: string,
    public type: ErrorType,          // ä¿æŒç°æœ‰å±æ€§å
    public statusCode?: number,
    public details?: Record<string, unknown>,
    public bugId?: string,           // æ–°å¢: åç«¯bugè¿½è¸ªID
    public backendErrorType?: string // æ–°å¢: åç«¯é”™è¯¯ç±»å‹åç§°
  ) {
    super(message);
    this.name = 'ApiError';
    Object.setPrototypeOf(this, ApiError.prototype);
  }

  get isRetryable(): boolean {
    return ['NetworkError', 'TimeoutError', 'HttpError5xx'].includes(this.type);
  }
}
```

#### 2. å¢å¼ºnormalizeErroræ–¹æ³•

```typescript
// ApiClient.ts - å¢å¼ºé”™è¯¯è§£æ
private async handleErrorResponse(response: Response): Promise<ApiError> {
  let errorDetail = 'Unknown error';
  let bugId: string | undefined;
  let backendErrorType: string | undefined;

  try {
    const body = await response.json();
    errorDetail = body.detail || body.message || errorDetail;
    bugId = body.bug_id;
    backendErrorType = body.error_type;
  } catch {
    errorDetail = response.statusText;
  }

  const errorType = this.mapStatusToErrorType(response.status);

  return new ApiError(
    errorDetail,
    errorType,
    response.status,
    undefined,
    bugId,
    backendErrorType
  );
}

private mapStatusToErrorType(status: number): ErrorType {
  if (status >= 500) return 'HttpError5xx';
  if (status >= 400) return 'HttpError4xx';
  return 'UnknownError';
}
```

#### 3. ErrorNotificationServiceå®ç°

```typescript
// services/ErrorNotificationService.ts
import { Notice } from 'obsidian';
import { ApiError } from '../api/ApiClient';

export interface RetryOptions {
  operation: string;
  onRetry?: () => void;
}

export class ErrorNotificationService {
  showAgentError(error: ApiError, options?: RetryOptions): void {
    const duration = 10000; // 10ç§’
    const notice = new Notice('', duration);

    // è®¾ç½®æ ·å¼
    if (error.statusCode && error.statusCode >= 500) {
      notice.noticeEl.addClass('notice-error');
    } else if (error.type === 'NetworkError' || error.type === 'TimeoutError') {
      notice.noticeEl.addClass('notice-warning');
    }

    // æ„å»ºæ¶ˆæ¯å†…å®¹
    const fragment = this.buildErrorFragment(error, options);
    notice.setMessage(fragment);
  }

  private buildErrorFragment(error: ApiError, options?: RetryOptions): DocumentFragment {
    const fragment = document.createDocumentFragment();

    // é”™è¯¯ç±»å‹
    const typeEl = fragment.createEl('strong', {
      text: error.backendErrorType || error.type
    });
    fragment.appendChild(typeEl);

    // é”™è¯¯æ¶ˆæ¯
    fragment.createEl('br');
    fragment.createEl('span', { text: error.message });

    // Bug ID (å¦‚æœæœ‰)
    if (error.bugId) {
      fragment.createEl('br');
      const bugEl = fragment.createEl('span', {
        text: `Bug ID: ${error.bugId}`,
        cls: 'error-bug-id'
      });
      bugEl.addEventListener('click', () => {
        navigator.clipboard.writeText(error.bugId!);
        new Notice('Bug IDå·²å¤åˆ¶');
      });
    }

    // é‡è¯•æŒ‰é’® (ä»…å¯¹å¯é‡è¯•é”™è¯¯)
    if (error.isRetryable && options?.onRetry) {
      fragment.createEl('br');
      const retryBtn = fragment.createEl('button', {
        text: 'é‡è¯•',
        cls: 'error-retry-btn'
      });
      retryBtn.addEventListener('click', () => {
        options.onRetry!();
      });
    }

    return fragment;
  }
}
```

#### 4. ErrorHistoryManagerå®ç°

```typescript
// managers/ErrorHistoryManager.ts
import type CanvasReviewPlugin from '../main';

export interface ErrorRecord {
  id: string;
  timestamp: number;
  errorType: string;
  bugId?: string;
  message: string;
  operation: string;
  statusCode: number;
}

export class ErrorHistoryManager {
  private records: ErrorRecord[] = [];
  private readonly MAX_RECORDS = 100;
  private readonly EXPIRY_DAYS = 7;

  constructor(private plugin: CanvasReviewPlugin) {}

  async load(): Promise<void> {
    const data = await this.plugin.loadData();
    this.records = data?.errorHistory || [];
    await this.cleanup();
  }

  async save(): Promise<void> {
    const data = await this.plugin.loadData() || {};
    data.errorHistory = this.records;
    await this.plugin.saveData(data);
  }

  addError(error: ApiError, operation: string): void {
    const record: ErrorRecord = {
      id: `ERR-${Date.now()}`,
      timestamp: Date.now(),
      errorType: error.backendErrorType || error.type,
      bugId: error.bugId,
      message: error.message,
      operation,
      statusCode: error.statusCode
    };

    this.records.unshift(record);

    // ä¿ç•™æœ€å¤šMAX_RECORDSæ¡
    if (this.records.length > this.MAX_RECORDS) {
      this.records = this.records.slice(0, this.MAX_RECORDS);
    }

    this.save();
  }

  getRecent(limit: number = 20): ErrorRecord[] {
    return this.records.slice(0, limit);
  }

  async cleanup(): Promise<void> {
    const expiryTime = Date.now() - (this.EXPIRY_DAYS * 24 * 60 * 60 * 1000);
    this.records = this.records.filter(r => r.timestamp > expiryTime);
    await this.save();
  }
}
```

### Testing Standards

**æµ‹è¯•ä½ç½®**: `canvas-progress-tracker/obsidian-plugin/tests/`

**æµ‹è¯•æ¡†æ¶**: Jest (å·²é…ç½®)

**æµ‹è¯•è¦†ç›–è¦æ±‚**:
- ApiClienté”™è¯¯è§£æ: 100%åˆ†æ”¯è¦†ç›–
- ErrorHistoryManager: 100%åŠŸèƒ½è¦†ç›–
- ErrorNotificationService: Mockæµ‹è¯•

**æµ‹è¯•ç”¨ä¾‹ç¤ºä¾‹**:
```typescript
describe('ApiClient Error Handling', () => {
  it('should parse bug_id from 500 response', async () => {
    const response = new Response(JSON.stringify({
      detail: 'AI Provider error',
      error_type: 'AIProviderError',
      bug_id: 'BUG-A1B2C3D4'
    }), { status: 500 });

    const error = await apiClient.handleErrorResponse(response);

    expect(error.bugId).toBe('BUG-A1B2C3D4');
    expect(error.backendErrorType).toBe('AIProviderError');
    expect(error.isRetryable).toBe(true);
  });
});
```

### Related Documentation

**Epicå’ŒStoryæ–‡æ¡£**:
- [Epic 21.5æ–‡æ¡£](../prd/EPIC-21.5-AGENT-RELIABILITY-FIX.md) - EpicèƒŒæ™¯å’Œé—®é¢˜å®šä¹‰
- [Epic 21æ–‡æ¡£](../prd/EPIC-21-AGENT-E2E-FLOW-FIX.md) - Agent E2Eä¿®å¤èƒŒæ™¯ (çˆ¶Epic)

**æ¶æ„æ–‡æ¡£** [Source: docs/architecture/]:
- [coding-standards.md](../architecture/coding-standards.md) - TypeScriptç¼–ç æ ‡å‡†
- [tech-stack.md](../architecture/tech-stack.md) - æŠ€æœ¯æ ˆå®šä¹‰
- [ADR-009](../architecture/decisions/ADR-009-ERROR-HANDLING-RETRY-STRATEGY.md) - é”™è¯¯å¤„ç†ç­–ç•¥

**SDDè§„èŒƒ**:
- [agent-api.openapi.yml](../../specs/api/agent-api.openapi.yml) - Agent APIå®šä¹‰
- [error-response.schema.json](../../specs/data/error-response.schema.json) - é”™è¯¯å“åº”Schema

**æºä»£ç ä½ç½®**:
- `canvas-progress-tracker/obsidian-plugin/src/api/ApiClient.ts` - HTTPå®¢æˆ·ç«¯
- `canvas-progress-tracker/obsidian-plugin/main.ts` - æ’ä»¶ä¸»å…¥å£
- `canvas-progress-tracker/obsidian-plugin/src/settings/PluginSettingsTab.ts` - è®¾ç½®é¢æ¿

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-14 | 1.0.0 | Initial creation with full Dev Notes | SM Agent (Bob) |
| 2025-12-14 | 1.1.0 | PO validation completed - PASS | PO Agent (Sarah) |

---

## Dev Agent Record

### Agent Model Used
(To be filled by Dev Agent)

### Debug Log References
(To be filled by Dev Agent)

### Completion Notes List
(To be filled by Dev Agent)

### File List
(To be filled by Dev Agent)

---

## PO Validation Results

**Validation Date**: 2025-12-14
**Validated By**: Sarah (PO Agent)
**Validation Task**: `*validate-story-draft 21.5.5`

### Validation Summary

| Step | Category | Status |
|------|----------|--------|
| 0 | Core Configuration | âœ… PASS |
| 1 | Template Completeness | âœ… PASS |
| 2 | File Structure | âœ… PASS |
| 3 | UI/Frontend | âœ… PASS |
| 4 | AC Satisfaction | âœ… PASS |
| 5 | Testing Instructions | âœ… PASS |
| 6 | Security | â¬œ N/A |
| 7 | Task Sequence | âœ… PASS |
| 8a-8d | SDD Alignment | âœ… PASS |
| 9 | Implementation Readiness | âš ï¸ MEDIUM RISK |

### SDD Consistency Verification

| SDD Artifact | Status |
|--------------|--------|
| `specs/api/agent-api.openapi.yml` | âœ… Verified |
| `specs/data/error-response.schema.json` | âœ… Verified |
| `ADR-009-ERROR-HANDLING-RETRY-STRATEGY` | âœ… Verified |
| Context7 Obsidian Notice patterns | âœ… Verified |

### Risk Assessment

| Risk Factor | Level | Notes |
|-------------|-------|-------|
| Dependency on Stories 21.5.1-21.5.4 | âš ï¸ MEDIUM | Story documents expected interfaces; can implement with mocks |
| New Error Format Integration | ğŸŸ¢ LOW | Additive change, backward compatible |
| Obsidian API Usage | ğŸŸ¢ LOW | Context7 verified patterns provided |

### Implementation Readiness Score

| Dimension | Score |
|-----------|-------|
| Requirements Clarity | 9/10 |
| Technical Guidance | 9/10 |
| SDD Reference Quality | 9/10 |
| Dependency Documentation | 7/10 |
| Test Strategy | 8/10 |
| **Overall** | **8.4/10** |

### Final Assessment

| Field | Value |
|-------|-------|
| **Quality Gate** | âœ… **PASS** |
| **Verdict** | **GO** |
| **Confidence Level** | HIGH |
| **Blocked by Conflicts** | NO |
| **Ready for Dev Agent** | YES (with dependency risk awareness) |

### Notes
- Story ACs exceed Epic ACs (more comprehensive)
- Epic 21.5 error format `{detail, error_type, bug_id}` is ADDITIVE extension to existing SDD specs
- Recommended: Implement Stories 21.5.1-21.5.4 first, or use mock interfaces

---

## QA Results
(To be filled by QA Agent)
