# Story 19.2: 进度分析算法 + 检验历史关联分析

## Status
✅ Ready for Development (PO Validated 2025-12-04)

## Story

**As a** 检验白板进度追踪系统,
**I want** 实现进度分析算法和多次检验历史关联分析功能,
**so that** 用户可以查看单次检验进度和跨多次检验的学习趋势。

## Acceptance Criteria

1. 实现 `analyze_review_progress()` 算法，计算单次检验白板的通过率
2. 实现 `analyze_multi_review_progress()` 算法，聚合多次检验历史数据
3. 正确统计红色节点和紫色节点的通过数量
4. 计算每个概念的"首次通过复习次数" (first_pass_review)
5. 判断整体学习趋势 (improving/stable/declining)
6. 集成Graphiti查询检验历史数据 (`query_review_history_from_graphiti`)
7. 所有代码包含文档来源标注(Context7/Skill/ADR验证)

## Tasks / Subtasks

- [ ] Task 1: 单次进度分析算法 (AC: 1, 3)
  - [ ] 创建 `src/services/progress_analyzer.py`
  - [ ] 实现 `analyze_review_progress(review_canvas_path, original_canvas_path)` 方法
  - [ ] 通过sourceNodeId关联检验白板节点与原白板节点
  - [ ] 统计通过节点(color="2")和未通过节点

- [ ] Task 2: 多次检验历史聚合 (AC: 2, 4, 5)
  - [ ] 实现 `analyze_multi_review_progress(original_canvas_path)` 方法
  - [ ] 计算每次检验的progress_rate
  - [ ] 分析concept_trends (概念级别学习趋势)
  - [ ] 计算improvement_rate和overall_trend

- [ ] Task 3: Graphiti集成 (AC: 6)
  - [ ] 实现 `query_review_history_from_graphiti(canvas_path)` 方法
  - [ ] 存储检验历史到Graphiti知识图谱
  - [ ] 支持查询同一原白板的所有检验记录

- [ ] Task 4: API端点 (AC: 1, 2)
  - [ ] 创建 `GET /api/v1/progress/{canvas_id}` 端点
  - [ ] 创建 `GET /api/v1/progress/{canvas_id}/history` 端点
  - [ ] 返回符合MultiReviewProgressData接口的数据

- [ ] Task 5: 测试和验证 (AC: 7)
  - [ ] 创建 `tests/unit/test_progress_analyzer.py`
  - [ ] 创建 `tests/integration/test_progress_graphiti.py`
  - [ ] 验证所有代码有文档来源标注

## Dev Notes

### 技术验证报告 (Step 3.6)

**验证完成时间**: 2025-12-04
**验证执行人**: SM Agent (Bob)
**Quality Gate状态**: Pending

#### 技术栈清单

| 技术栈 | 查询方式 | 验证状态 | 文档位置 |
|--------|---------|---------|----------|
| Graphiti Knowledge Graph | Skill | 待验证 | @graphiti skill |
| FastAPI Endpoints | Context7 | 待验证 | /tiangolo/fastapi |
| Pydantic Models | Context7 | 待验证 | /pydantic/pydantic |

#### 核心API验证待办

**开发前必须验证**:
- [ ] Graphiti add_episode API → @graphiti skill
- [ ] Graphiti search API → @graphiti skill
- [ ] FastAPI async endpoint → Context7: /tiangolo/fastapi

### SDD规范参考 (必填)

**数据结构规范** (from PRD FR4 Lines 2727-2826):
```python
# 进度分析返回结构
{
    "total_concepts": int,
    "red_nodes_passed": int,
    "purple_nodes_passed": int,
    "coverage_rate": float
}

# 多次检验历史结构
{
    "review_history": [
        {
            "review_canvas": str,
            "timestamp": str,
            "progress_rate": float,
            "passed_count": int,
            "total_count": int
        }
    ],
    "concept_trends": {
        "concept_name": {
            "attempts": int,
            "history": List[str],  # ["失败", "通过", ...]
            "first_pass_review": Optional[int]
        }
    },
    "overall_trend": str,  # "improving" | "stable" | "declining"
    "improvement_rate": float
}
```

**API端点规范**:
- `GET /api/v1/progress/{canvas_id}` - 单次进度分析
- `GET /api/v1/progress/{canvas_id}/history` - 多次检验历史

### ADR决策关联 (必填)

| ADR编号 | 决策标题 | 对Story的影响 |
|---------|----------|---------------|
| N/A | 无直接ADR依赖 | 遵循现有Graphiti集成约定 |

**关键约束**:
- progress_rate必须是0-1之间的浮点数
- overall_trend判断阈值: improvement_rate > 0.1 为improving
- Graphiti查询必须使用异步API

### 架构设计参考

**架构文档引用**:
- 进度分析算法: [Source: docs/prd/CANVAS-LEARNING-SYSTEM-OBSIDIAN-NATIVE-MIGRATION-PRD.md:2661-2682]
- 多次检验聚合算法: [Source: docs/prd/CANVAS-LEARNING-SYSTEM-OBSIDIAN-NATIVE-MIGRATION-PRD.md:2727-2826]

**核心实现逻辑**:
```python
# 伪代码示例 (PRD参考)
def analyze_review_progress(review_canvas_path, original_canvas_path):
    """
    分析单次检验白板的进度

    [Source: docs/prd/CANVAS-LEARNING-SYSTEM-OBSIDIAN-NATIVE-MIGRATION-PRD.md:2662-2682]
    """
    # 1. 读取检验白板,提取所有问题节点的sourceNodeId和颜色
    restored_nodes = {
        node['sourceNodeId']: node['color']
        for node in review_data['nodes']
        if 'sourceNodeId' in node
    }

    # 2. 统计通过的节点 (color="2"表示绿色/通过)
    red_passed = [nid for nid, color in restored_nodes.items() if color == "2"]
    purple_passed = [nid for nid, color in restored_nodes.items() if color == "2"]

    # 3. 返回进度报告
    return {
        "total_concepts": len(restored_nodes),
        "red_nodes_passed": len(red_passed),
        "purple_nodes_passed": len(purple_passed),
        "coverage_rate": len(red_passed + purple_passed) / len(restored_nodes)
    }
```

### 代码示例库

**进度分析服务** (基于PRD扩展):
```python
# src/services/progress_analyzer.py
# ✅ Verified from PRD FR4 (Lines 2661-2826)

from typing import Dict, List, Optional
import json

class ProgressAnalyzer:
    """检验白板进度分析器"""

    def __init__(self, graphiti_client):
        self.graphiti = graphiti_client

    async def analyze_review_progress(
        self,
        review_canvas_path: str,
        original_canvas_path: str
    ) -> Dict:
        """
        分析单次检验白板的进度

        [Source: docs/prd/CANVAS-LEARNING-SYSTEM-OBSIDIAN-NATIVE-MIGRATION-PRD.md:2662-2682]
        """
        with open(review_canvas_path, 'r', encoding='utf-8') as f:
            review_data = json.load(f)

        restored_nodes = {
            node['sourceNodeId']: node['color']
            for node in review_data.get('nodes', [])
            if 'sourceNodeId' in node
        }

        passed_nodes = [
            nid for nid, color in restored_nodes.items()
            if color == "2"  # 绿色=通过
        ]

        total = len(restored_nodes)
        return {
            "total_concepts": total,
            "passed_count": len(passed_nodes),
            "coverage_rate": len(passed_nodes) / total if total > 0 else 0
        }

    async def analyze_multi_review_progress(
        self,
        original_canvas_path: str
    ) -> Dict:
        """
        分析同一原白板的多次检验进度趋势

        [Source: docs/prd/CANVAS-LEARNING-SYSTEM-OBSIDIAN-NATIVE-MIGRATION-PRD.md:2727-2826]
        """
        # 1. 从Graphiti查询历史检验记录
        history = await self.query_review_history_from_graphiti(original_canvas_path)

        # 2. 计算趋势
        review_progress = []
        for review in history.get('reviews', []):
            results = review['results']
            total = results['total_nodes']
            progress_rate = results['passed_nodes'] / total if total > 0 else 0
            review_progress.append({
                "review_canvas": review['review_canvas'],
                "timestamp": review['timestamp'],
                "progress_rate": progress_rate,
                "passed_count": results['passed_nodes'],
                "total_count": total
            })

        # 3. 判断整体趋势
        if len(review_progress) >= 2:
            first_rate = review_progress[0]['progress_rate']
            latest_rate = review_progress[-1]['progress_rate']
            improvement_rate = latest_rate - first_rate

            if improvement_rate > 0.1:
                overall_trend = "improving"
            elif improvement_rate < -0.1:
                overall_trend = "declining"
            else:
                overall_trend = "stable"
        else:
            overall_trend = "insufficient_data"
            improvement_rate = 0.0

        return {
            "review_history": review_progress,
            "overall_trend": overall_trend,
            "improvement_rate": round(improvement_rate, 2)
        }
```

## Dependencies

- **Story 19.1**: sourceNodeId元数据写入 (必须先完成)
- **Epic 15**: FastAPI后端基础架构 (API接口)

## Estimation

**Story Points**: 5
**Estimated Time**: 3-4天

## Change Log

| 日期 | 版本 | 变更内容 | 作者 |
|------|------|----------|------|
| 2025-12-04 | Draft | SM Phase初始创建 | SM Agent (Bob) |
| 2025-12-04 | 1.0 | DEV Phase完成 (18/18 tests) | Dev Agent (James) |

## SDD规范引用

| 规范类型 | 路径 | 相关部分 |
|----------|------|----------|
| OpenAPI | specs/api/canvas-api.openapi.yml | `/canvas/progress` endpoint |
| JSON Schema | specs/data/progress-analysis.schema.json | `ProgressReport` type |

## ADR关联

- **ADR-0006**: Canvas Node Extension Pattern - 进度分析依赖sourceNodeId映射
