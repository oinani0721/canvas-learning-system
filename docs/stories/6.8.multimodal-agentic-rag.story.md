# Story 6.8: 多模态Agentic RAG检索

## Status
Completed

## Story

**As a** Canvas学习用户,
**I want** 在检索时同时搜索文本和图片/PDF内容,
**so that** 获得更全面的学习资料

## Epic Context

**Epic**: SCP-006 多模态文件关联
**Phase**: Phase 3 - 关联与检索
**Priority**: P1
**Estimated Time**: 4天

## Dependencies

- ✅ Epic 12 (Agentic RAG) - LangGraph StateGraph基础
- ✅ Story 6.6 (向量化) - 多模态向量存储
- ✅ Story 6.7 (自动关联) - 关联关系

## Acceptance Criteria

### AC 6.8.1: 扩展检索节点支持多模态
- [x] 修改parallel_retrieval节点
- [x] 新增multimodal_retrieval分支
- [x] 返回格式包含media_type

### AC 6.8.2: 多模态结果融合
- [x] 文本结果与多模态结果融合
- [x] 支持RRF/Weighted融合算法
- [x] 可配置多模态权重 (默认0.3)

### AC 6.8.3: 结果格式化
- [x] 图片结果包含缩略图URL
- [x] PDF结果包含页码和章节
- [x] 支持预览链接

### AC 6.8.4: 检索延迟<2秒
- [x] 端到端检索≤2秒
- [x] 多模态检索并行执行
- [x] 支持超时降级

## Tasks / Subtasks

- [x] Task 1: 扩展LangGraph StateGraph (AC: 6.8.1)
  - [x] 添加multimodal_retrieval节点
  - [x] 更新AgenticRAGState定义
  - [x] 配置条件路由

- [x] Task 2: 实现多模态检索器 (AC: 6.8.1, 6.8.3)
  - [x] 创建MultimodalRetriever类
  - [x] 实现retrieve_media()方法
  - [x] 结果格式化

- [x] Task 3: 融合算法扩展 (AC: 6.8.2)
  - [x] 扩展RRF算法支持多模态
  - [x] 添加多模态权重参数
  - [x] 更新FusionEngine

- [x] Task 4: 性能优化 (AC: 6.8.4)
  - [x] 并行检索优化
  - [x] 超时降级处理
  - [x] 结果缓存

## Dev Notes

### 技术栈

```yaml
LangGraph扩展:
  新节点: multimodal_retrieval
  并行: Send模式 (复用Epic 12)

融合算法:
  RRF扩展:
    k: 60
    多模态权重: 0.3

结果格式:
  MultimodalResult:
    - media_type: image|pdf|audio|video
    - content_preview: 缩略图URL或文本摘要
    - source_location: 页码/时间戳
```

### 代码位置

```
修改文件:
- src/agentic_rag/graphs/agentic_rag_graph.py (添加节点)
- src/agentic_rag/retrievers/parallel_retriever.py (扩展)
- src/agentic_rag/fusion/rrf_fusion.py (扩展)

创建文件:
- src/agentic_rag/retrievers/multimodal_retriever.py

测试文件:
- src/tests/test_multimodal_rag.py
```

### 核心实现

```python
# src/agentic_rag/retrievers/multimodal_retriever.py
from dataclasses import dataclass
from typing import Literal

@dataclass
class MultimodalResult:
    """多模态检索结果"""
    id: str
    media_type: Literal["image", "pdf", "audio", "video"]
    file_path: str
    content_preview: str  # 缩略图URL或文本摘要
    source_location: str | None  # 页码/时间戳
    relevance_score: float
    related_concepts: list[str]

class MultimodalRetriever:
    """多模态检索器"""

    def __init__(self, lancedb_client, config: dict = None):
        self.lancedb = lancedb_client
        self.config = config or {
            "top_k": 5,
            "min_score": 0.5
        }

    async def retrieve(
        self,
        query_vector: list[float],
        media_types: list[str] = None
    ) -> list[MultimodalResult]:
        """检索多模态内容"""

        # 1. 向量相似度搜索
        results = await self.lancedb.similarity_search(
            table_name="multimodal_content",
            query_vector=query_vector,
            top_k=self.config["top_k"],
            filter={"media_type": {"$in": media_types}} if media_types else None
        )

        # 2. 格式化结果
        formatted = []
        for r in results:
            if r["_distance"] >= self.config["min_score"]:
                formatted.append(MultimodalResult(
                    id=r["id"],
                    media_type=r["media_type"],
                    file_path=r["file_path"],
                    content_preview=self._get_preview(r),
                    source_location=r.get("source_location"),
                    relevance_score=r["_distance"],
                    related_concepts=r.get("related_concepts", [])
                ))

        return formatted

    def _get_preview(self, result: dict) -> str:
        """获取预览内容"""
        if result["media_type"] == "image":
            return result.get("thumbnail_path", "")
        elif result["media_type"] == "pdf":
            return result.get("description", "")[:200]
        else:
            return result.get("description", "")[:100]
```

### LangGraph StateGraph扩展

```python
# 扩展 AgenticRAGState
class AgenticRAGState(TypedDict):
    query: str
    query_vector: list[float]
    text_results: list[dict]
    graph_results: list[dict]
    multimodal_results: list[MultimodalResult]  # 新增
    fused_results: list[dict]
    response: str

# 添加多模态检索节点
async def multimodal_retrieval_node(state: AgenticRAGState) -> dict:
    """多模态检索节点"""
    retriever = MultimodalRetriever(lancedb_client)
    results = await retriever.retrieve(state["query_vector"])
    return {"multimodal_results": results}

# 更新Graph
graph.add_node("multimodal_retrieval", multimodal_retrieval_node)
graph.add_edge("query_rewrite", "multimodal_retrieval")  # 并行执行
```

### RRF融合扩展

```python
def rrf_fusion_with_multimodal(
    text_results: list,
    graph_results: list,
    multimodal_results: list,
    k: int = 60,
    weights: dict = None
) -> list:
    """扩展RRF支持多模态"""
    weights = weights or {
        "text": 0.4,
        "graph": 0.3,
        "multimodal": 0.3
    }

    scores = {}

    # 文本结果
    for rank, r in enumerate(text_results):
        score = weights["text"] / (k + rank + 1)
        scores[r["id"]] = scores.get(r["id"], 0) + score

    # 图谱结果
    for rank, r in enumerate(graph_results):
        score = weights["graph"] / (k + rank + 1)
        scores[r["id"]] = scores.get(r["id"], 0) + score

    # 多模态结果
    for rank, r in enumerate(multimodal_results):
        score = weights["multimodal"] / (k + rank + 1)
        scores[r.id] = scores.get(r.id, 0) + score

    # 排序返回
    sorted_ids = sorted(scores.keys(), key=lambda x: scores[x], reverse=True)
    return sorted_ids
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-30 | 1.0 | Initial Story Creation | SM Agent (Bob) |

## QA Results

### Review Date: 待开发

### Reviewed By: 待开发

### Test Results
待开发

---

**关联文档**:
- SCP-006-IMPLEMENTATION-PLAN.md
- Epic 12 (Agentic RAG)
- Story 6.6 (向量化)
