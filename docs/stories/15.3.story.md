# Story 15.3: ä¾èµ–æ³¨å…¥ç³»ç»Ÿè®¾è®¡

## Status
Draft

## Story
**As a** Canvas Learning Systemå¼€å‘è€…,
**I want** å®ç°å®Œæ•´çš„ä¾èµ–æ³¨å…¥ç³»ç»Ÿ,
**so that** Serviceå®ä¾‹å¯ä»¥è¢«æ­£ç¡®æ³¨å…¥åˆ°APIç«¯ç‚¹ï¼Œæ”¯æŒèµ„æºç”Ÿå‘½å‘¨æœŸç®¡ç†å’Œå¯æµ‹è¯•æ€§ã€‚

## Acceptance Criteria

1. âœ… åˆ›å»º `app/dependencies.py` æ–‡ä»¶åŒ…å«æ‰€æœ‰ä¾èµ–æä¾›å‡½æ•°
2. âœ… å®ç° `get_settings()` ä¾èµ–è¿”å›é…ç½®å•ä¾‹
3. âœ… å®ç° `get_canvas_service()` ä¾èµ–è¿”å›CanvasServiceå®ä¾‹
4. âœ… å®ç° `get_agent_service()` ä¾èµ–è¿”å›AgentServiceå®ä¾‹
5. âœ… å®ç° `get_review_service()` ä¾èµ–è¿”å›ReviewServiceå®ä¾‹
6. âœ… ä½¿ç”¨yieldè¯­æ³•æ”¯æŒèµ„æºæ¸…ç†ï¼ˆå¦‚éœ€è¦ï¼‰
7. âœ… ä¾èµ–å¯ä»¥è¢«é“¾å¼è°ƒç”¨ï¼ˆServiceä¾èµ–Settingsï¼‰
8. âœ… æ‰€æœ‰ä¾èµ–æ”¯æŒpytestæµ‹è¯•ä¸­çš„override
9. âœ… APIç«¯ç‚¹æ­£ç¡®ä½¿ç”¨Depends()æ³¨å…¥ä¾èµ–

## Tasks / Subtasks

- [ ] **Task 1: åˆ›å»ºä¾èµ–æ³¨å…¥æ–‡ä»¶** (AC: 1)
  - [ ] 1.1 åˆ›å»º `backend/app/dependencies.py`
  - [ ] 1.2 æ·»åŠ å¿…è¦çš„importè¯­å¥

- [ ] **Task 2: å®ç°Settingsä¾èµ–** (AC: 2)
  - [ ] 2.1 åˆ›å»º `get_settings()` å‡½æ•°
  - [ ] 2.2 ä½¿ç”¨ `@lru_cache` è£…é¥°å™¨ç¼“å­˜Settingså®ä¾‹
  - [ ] 2.3 è¿”å›Story 15.1ä¸­åˆ›å»ºçš„Settingsç±»å®ä¾‹

- [ ] **Task 3: å®ç°CanvasServiceä¾èµ–** (AC: 3, 6, 7)
  - [ ] 3.1 åˆ›å»º `get_canvas_service()` å‡½æ•°
  - [ ] 3.2 ä½¿ç”¨ `Depends(get_settings)` è·å–é…ç½®
  - [ ] 3.3 å®ä¾‹åŒ–CanvasServiceå¹¶ä¼ å…¥canvas_base_path
  - [ ] 3.4 ä½¿ç”¨yieldè¯­æ³•æ”¯æŒcleanupï¼ˆå¯é€‰ï¼‰

- [ ] **Task 4: å®ç°AgentServiceä¾èµ–** (AC: 4, 6, 7)
  - [ ] 4.1 åˆ›å»º `get_agent_service()` å‡½æ•°
  - [ ] 4.2 ä¾èµ–Settingsè·å–é…ç½®
  - [ ] 4.3 å®ä¾‹åŒ–AgentService

- [ ] **Task 5: å®ç°ReviewServiceä¾èµ–** (AC: 5, 6, 7)
  - [ ] 5.1 åˆ›å»º `get_review_service()` å‡½æ•°
  - [ ] 5.2 ä¾èµ–Settingså’ŒCanvasService
  - [ ] 5.3 å®ä¾‹åŒ–ReviewService

- [ ] **Task 6: é›†æˆåˆ°APIç«¯ç‚¹** (AC: 9)
  - [ ] 6.1 æ›´æ–°canvas.pyç«¯ç‚¹ä½¿ç”¨ `Depends(get_canvas_service)`
  - [ ] 6.2 æ›´æ–°agents.pyç«¯ç‚¹ä½¿ç”¨ `Depends(get_agent_service)`
  - [ ] 6.3 æ›´æ–°review.pyç«¯ç‚¹ä½¿ç”¨ `Depends(get_review_service)`

- [ ] **Task 7: å•å…ƒæµ‹è¯•** (AC: 8)
  - [ ] 7.1 æµ‹è¯•ä¾èµ–å‡½æ•°è¿”å›æ­£ç¡®ç±»å‹
  - [ ] 7.2 æµ‹è¯•ä¾èµ–é“¾å¼è°ƒç”¨
  - [ ] 7.3 æµ‹è¯•dependency_overridesåŠŸèƒ½

## Dev Notes

### ğŸ“‹ æŠ€æœ¯éªŒè¯æŠ¥å‘Š (Step 3.6)

**éªŒè¯å®Œæˆæ—¶é—´**: 2025-11-24
**éªŒè¯æ‰§è¡Œäºº**: SM Agent
**Quality GateçŠ¶æ€**: âœ… PASSED

#### æŠ€æœ¯æ ˆæ¸…å•

| æŠ€æœ¯æ ˆ | æŸ¥è¯¢æ–¹å¼ | éªŒè¯çŠ¶æ€ | æ–‡æ¡£ä½ç½® |
|--------|---------|---------|----------|
| FastAPI Depends | Context7 | âœ… å·²éªŒè¯ | /websites/fastapi_tiangolo |
| Dependencies with yield | Context7 | âœ… å·²éªŒè¯ | /websites/fastapi_tiangolo |
| Chained dependencies | Context7 | âœ… å·²éªŒè¯ | /websites/fastapi_tiangolo |

#### æ ¸å¿ƒAPIéªŒè¯ç»“æœ

**FastAPI Dependency Injection APIs**:
- âœ… `Depends()` â†’ Verified from Context7
  - ç”¨é€”: å£°æ˜å‡½æ•°å‚æ•°çš„ä¾èµ–
  - è¯­æ³•: `service: CanvasService = Depends(get_canvas_service)`

- âœ… `yield` in dependencies â†’ Verified from Context7
  - ç”¨é€”: èµ„æºç®¡ç†å’Œæ¸…ç†
  - æ¨¡å¼: `try: yield resource finally: resource.close()`

- âœ… Chained dependencies â†’ Verified from Context7
  - ç”¨é€”: ä¾èµ–é“¾å¼è°ƒç”¨
  - è¯­æ³•: `def get_b(a = Depends(get_a))`

#### ä»£ç ç¤ºä¾‹åº“

**ç¤ºä¾‹1: åŸºç¡€ä¾èµ–å‡½æ•°**
```python
# âœ… Verified from Context7:/websites/fastapi_tiangolo (topic: dependencies)
from functools import lru_cache
from app.config import Settings

@lru_cache
def get_settings() -> Settings:
    return Settings()
```

**ç¤ºä¾‹2: å¸¦yieldçš„ä¾èµ–ï¼ˆèµ„æºç®¡ç†ï¼‰**
```python
# âœ… Verified from Context7:/websites/fastapi_tiangolo (topic: dependencies-with-yield)
async def get_db():
    db = DBSession()
    try:
        yield db
    finally:
        db.close()
```

**ç¤ºä¾‹3: é“¾å¼ä¾èµ–**
```python
# âœ… Verified from Context7:/websites/fastapi_tiangolo (topic: chained dependencies)
from typing import Annotated
from fastapi import Depends

async def dependency_a():
    dep_a = generate_dep_a()
    try:
        yield dep_a
    finally:
        dep_a.close()

async def dependency_b(dep_a: Annotated[DepA, Depends(dependency_a)]):
    dep_b = generate_dep_b()
    try:
        yield dep_b
    finally:
        dep_b.close(dep_a)
```

**ç¤ºä¾‹4: åœ¨ç«¯ç‚¹ä¸­ä½¿ç”¨ä¾èµ–**
```python
# âœ… Verified from Context7:/websites/fastapi_tiangolo
from fastapi import APIRouter, Depends
from app.services.canvas_service import CanvasService
from app.dependencies import get_canvas_service

router = APIRouter()

@router.get("/{canvas_name}")
async def read_canvas(
    canvas_name: str,
    service: CanvasService = Depends(get_canvas_service)
):
    return await service.read_canvas(canvas_name)
```

**ç¤ºä¾‹5: ä½¿ç”¨Context Managerçš„ä¾èµ–**
```python
# âœ… Verified from Context7:/websites/fastapi_tiangolo
class MySuperContextManager:
    def __init__(self):
        self.db = DBSession()

    def __enter__(self):
        return self.db

    def __exit__(self, exc_type, exc_value, traceback):
        self.db.close()

async def get_db():
    with MySuperContextManager() as db:
        yield db
```

---

### SDDè§„èŒƒå‚è€ƒ (å¿…å¡«)

**æ³¨æ„**: æœ¬Storyä¸ºå†…éƒ¨æ¶æ„å®ç°ï¼Œæ— ç›´æ¥APIç«¯ç‚¹ã€‚ç›¸å…³APIè§„èŒƒå‚è§:
- [Source: specs/api/fastapi-backend-api.openapi.yml] - ä¾èµ–æ³¨å…¥çš„Serviceè¢«è¿™äº›ç«¯ç‚¹ä½¿ç”¨

**ä¾èµ–å‡½æ•°äº§å‡ºçš„Serviceå¯¹åº”çš„Schema**:
- CanvasService â†’ NodeCreate, NodeRead, EdgeCreate, EdgeRead
  - [Source: specs/data/canvas-node.schema.json]
- AgentService â†’ DecomposeRequest/Response, ScoreRequest/Response
  - [Source: specs/data/decompose-request.schema.json]
  - [Source: specs/data/node-score.schema.json]
- ReviewService â†’ ReviewItem, GenerateReviewRequest/Response
  - [Source: specs/data/review-item.schema.json]

### æŠ€æœ¯çº¦æŸ (æ¶æ„æ–‡æ¡£å¼•ç”¨)

**ä¾èµ–å‡½æ•°è§„èŒƒ**:

| ä¾èµ–å‡½æ•° | è¿”å›ç±»å‹ | ä¾èµ–é¡¹ | ç”¨é€” |
|---------|---------|--------|------|
| `get_settings()` | Settings | None | é…ç½®å•ä¾‹ |
| `get_canvas_service()` | CanvasService | Settings | Canvasæ“ä½œæœåŠ¡ |
| `get_agent_service()` | AgentService | Settings | Agentè°ƒç”¨æœåŠ¡ |
| `get_review_service()` | ReviewService | Settings, CanvasService | æ£€éªŒç™½æ¿æœåŠ¡ |

**ä¾èµ–å…³ç³»å›¾**:
```
Settings (å•ä¾‹, @lru_cache)
    â†“
â”Œâ”€â”€â”€â”´â”€â”€â”€â”
â†“       â†“
CanvasService  AgentService
    â†“
ReviewService
```

**æ¶æ„è®¾è®¡å‚è€ƒ**:
- ä¾èµ–æ³¨å…¥è®¾è®¡: [Source: docs/architecture/EPIC-11-BACKEND-ARCHITECTURE.md#ä¾èµ–æ³¨å…¥è®¾è®¡]
- 4å±‚æ¶æ„è®¾è®¡: [Source: docs/architecture/EPIC-11-BACKEND-ARCHITECTURE.md#æ•´ä½“æ¶æ„]
- é…ç½®ç®¡ç†ç­–ç•¥: [Source: docs/architecture/EPIC-11-BACKEND-ARCHITECTURE.md#é…ç½®ç®¡ç†]

---

### ADRå†³ç­–å…³è” (å¿…å¡«)

| ADRç¼–å· | å†³ç­–æ ‡é¢˜ | å¯¹Storyçš„å½±å“ |
|---------|----------|---------------|
| ADR-008 | Testing Framework - pytest | ä¾èµ–æ³¨å…¥æµ‹è¯•ä½¿ç”¨pytest + dependency_overrides |
| ADR-009 | Error Handling & Retry Strategy | Serviceå±‚é”™è¯¯é€šè¿‡ä¾èµ–æ³¨å…¥ä¼ æ’­ |
| ADR-010 | Logging Aggregation - structlog | ä¾èµ–å‡½æ•°ä¸­çš„æ—¥å¿—ä½¿ç”¨ç»“æ„åŒ–æ ¼å¼ |

**âš ï¸ æ³¨æ„**: ä»¥ä¸‹æ¶æ„å†³ç­–è®°å½•åœ¨æ¶æ„æ–‡æ¡£ä¸­ï¼Œä½†æ— ç‹¬ç«‹ADR:
- FastAPI Dependsæœºåˆ¶ â†’ `docs/architecture/EPIC-11-BACKEND-ARCHITECTURE.md#ä¾èµ–æ³¨å…¥è®¾è®¡`
- 4å±‚æ¶æ„è®¾è®¡ â†’ `docs/architecture/EPIC-11-BACKEND-ARCHITECTURE.md#æ•´ä½“æ¶æ„`
- é…ç½®ç®¡ç†ç­–ç•¥ (Settingså•ä¾‹) â†’ `docs/architecture/EPIC-11-BACKEND-ARCHITECTURE.md#é…ç½®ç®¡ç†`

**å…³é”®çº¦æŸ**:
- çº¦æŸ1: ä¾èµ–å‡½æ•°ä¸åº”åŒ…å«ä¸šåŠ¡é€»è¾‘ï¼Œåªè´Ÿè´£å®ä¾‹åŒ–å’Œèµ„æºç®¡ç†
- çº¦æŸ2: Settingså¿…é¡»ä½¿ç”¨@lru_cacheç¼“å­˜ï¼Œé¿å…é‡å¤è§£æç¯å¢ƒå˜é‡
- çº¦æŸ3: éœ€è¦æ¸…ç†çš„èµ„æºä½¿ç”¨yieldè¯­æ³•ï¼Œç¡®ä¿finallyå—æ‰§è¡Œ
- çº¦æŸ4: ä¾èµ–å‡½æ•°å¿…é¡»æ”¯æŒdependency_overridesç”¨äºæµ‹è¯•

[Source: docs/architecture/EPIC-11-BACKEND-ARCHITECTURE.md]

---

### é¡¹ç›®ç»“æ„å‚è€ƒ

```
backend/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ dependencies.py          # æœ¬Storyä¸»è¦æ–‡ä»¶ â­
â”‚   â”œâ”€â”€ config.py                # Settingsç±» (Story 15.1)
â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â”œâ”€â”€ canvas_service.py    # CanvasServiceç±»
â”‚   â”‚   â”œâ”€â”€ agent_service.py     # AgentServiceç±»
â”‚   â”‚   â””â”€â”€ review_service.py    # ReviewServiceç±»
â”‚   â””â”€â”€ api/v1/endpoints/
â”‚       â”œâ”€â”€ canvas.py            # ä½¿ç”¨get_canvas_service
â”‚       â”œâ”€â”€ agents.py            # ä½¿ç”¨get_agent_service
â”‚       â””â”€â”€ review.py            # ä½¿ç”¨get_review_service
â””â”€â”€ tests/
    â””â”€â”€ test_dependencies.py     # ä¾èµ–æ³¨å…¥æµ‹è¯•
```

[Source: docs/architecture/EPIC-11-BACKEND-ARCHITECTURE.md]

---

### Testing

**æµ‹è¯•æ–‡ä»¶ä½ç½®**: `backend/tests/test_dependencies.py`

**æµ‹è¯•æ¡†æ¶**: pytest + pytest-asyncio

**æµ‹è¯•æ ‡å‡†**:
- æµ‹è¯•æ¯ä¸ªä¾èµ–å‡½æ•°è¿”å›æ­£ç¡®ç±»å‹
- æµ‹è¯•é“¾å¼ä¾èµ–æ­£ç¡®ä¼ é€’
- æµ‹è¯•dependency_overridesåŠŸèƒ½

**æµ‹è¯•ç¤ºä¾‹**:
```python
# âœ… Verified from Context7:/websites/fastapi_tiangolo (topic: testing)
from fastapi.testclient import TestClient
from app.main import app
from app.dependencies import get_settings

def test_get_settings():
    settings = get_settings()
    assert settings.app_name == "Canvas Learning System"

def test_override_dependency():
    def override_get_settings():
        return MockSettings()

    app.dependency_overrides[get_settings] = override_get_settings
    client = TestClient(app)

    response = client.get("/api/v1/health")
    assert response.status_code == 200

    # æ¸…ç†
    app.dependency_overrides.clear()

async def test_canvas_service_dependency():
    from app.dependencies import get_canvas_service
    service = await anext(get_canvas_service())
    assert isinstance(service, CanvasService)
```

---

### æŠ€æœ¯çº¦æŸå’Œæ³¨æ„äº‹é¡¹

**ç‰ˆæœ¬çº¦æŸ**:
- FastAPI: â‰¥0.104.0
- Python: â‰¥3.9 (æ”¯æŒAnnotated)

**æ€§èƒ½è€ƒè™‘**:
- Settingsä½¿ç”¨@lru_cacheé¿å…é‡å¤è¯»å–ç¯å¢ƒå˜é‡
- Serviceå®ä¾‹æŒ‰è¯·æ±‚åˆ›å»ºï¼Œæ”¯æŒæ— çŠ¶æ€è®¾è®¡

**å®‰å…¨è€ƒè™‘**:
- æ•æ„Ÿé…ç½®ï¼ˆAPI keysç­‰ï¼‰é€šè¿‡Settingsä»ç¯å¢ƒå˜é‡è¯»å–
- ä¸åœ¨ä¾èµ–å‡½æ•°ä¸­ç¡¬ç¼–ç æ•æ„Ÿä¿¡æ¯

**æµ‹è¯•è€ƒè™‘**:
- ä½¿ç”¨dependency_overridesè¿›è¡Œmock
- æµ‹è¯•åæ¸…ç†overridesé¿å…æ±¡æŸ“å…¶ä»–æµ‹è¯•

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-24 | 1.0 | åˆå§‹åˆ›å»º | SM Agent |

---

## Dev Agent Record

### Agent Model Used
(å¾…Dev Agentå¡«å†™)

### Debug Log References
(å¾…Dev Agentå¡«å†™)

### Completion Notes List
(å¾…Dev Agentå¡«å†™)

### File List
(å¾…Dev Agentå¡«å†™)

---

## QA Results
(å¾…QA Agentå¡«å†™)
