# Story 30.24: è¾¹ç•Œæµ‹è¯•ä¸é˜²æŠ¤åŠ å›º

**Epic**: [EPIC-30: Memory System Complete Activation](../epics/EPIC-30-MEMORY-SYSTEM-COMPLETE-ACTIVATION.md)
**Priority**: P2
**Estimated Hours**: 6
**Dependencies**: Story 30.20, 30.21 (æ ¸å¿ƒæµ‹è¯•å…ˆå®Œæˆ)

---

## Status

**Done**

---

## Story

**As a** developer,
**I want** boundary tests for edge cases (empty inputs, Unicode, illegal group_id, oversized payloads) and shutdown data safety,
**so that** the memory system is robust against unexpected inputs and doesn't silently lose data.

---

## Problem Statement

å¯¹æŠ—æ€§å®¡æŸ¥ (2026-02-10) å‘ç°:

1. **ç¼ºå¤±è¾¹ç•Œæµ‹è¯• (å‘ç° #13)**: ç©ºäº‹ä»¶åˆ—è¡¨ã€Unicode emojiã€ç‰¹æ®Šå­—ç¬¦ group_idã€è¶…å¤§ payload ç­‰è¾¹ç•Œåœºæ™¯æ— æµ‹è¯•è¦†ç›–ã€‚
2. **Shutdown æ•°æ®å®‰å…¨ (å‘ç° #16)**: `shutdown_memory_service()` è°ƒç”¨ `_flush_pending()` ä½†å¦‚æœ Neo4j ä¸å¯è¾¾ï¼Œpending writes å¯èƒ½ä¸¢å¤±ã€‚
3. **Vault éƒ¨ç½²é˜²å›å½’ (å‘ç° #15)**: `npm run verify` è¿”å› STALE æ—¶æ— éé›¶é€€å‡ºç ï¼Œæ— æ³•ç”¨äºè‡ªåŠ¨åŒ–é˜²æŠ¤ã€‚

---

## Acceptance Criteria

### AC-30.24.1: ç©ºè¾“å…¥è¾¹ç•Œæµ‹è¯•
- **Given** ç©ºäº‹ä»¶åˆ—è¡¨ `[]` è¢«æäº¤åˆ° `record_batch_learning_events()`
- **When** æ‰¹é‡å¤„ç†æ‰§è¡Œ
- **Then** è¿”å› `{processed: 0, errors: []}` (ä¸å´©æºƒ)
- **And** ä¸è°ƒç”¨ Neo4j å†™å…¥

### AC-30.24.2: ç‰¹æ®Šå­—ç¬¦ group_id æµ‹è¯•
- **Given** `group_id` åŒ…å«ä»¥ä¸‹ç‰¹æ®Šå­—ç¬¦ä¹‹ä¸€: `ç©ºå­—ç¬¦ä¸²`, `../`, `<script>`, `ä¸­æ–‡/å­¦ç§‘`, `emoji ğŸ“š`
- **When** ç”¨äº Neo4j æŸ¥è¯¢å‚æ•°
- **Then** å‚æ•°åŒ–æŸ¥è¯¢å®‰å…¨å¤„ç† (æ—  Cypher æ³¨å…¥)
- **And** ç©ºå­—ç¬¦ä¸²è¿”å›åˆç†é»˜è®¤å€¼æˆ–é”™è¯¯
- **And** ä¸­æ–‡å­—ç¬¦æ­£ç¡®ä¿ç•™ï¼›emoji å®‰å…¨å‰¥ç¦»ä¸ºç¨³å®šæ ‡è¯†ç¬¦ï¼ˆ`sanitize_subject_name` ä½¿ç”¨ `\w` åŒ¹é…ï¼Œemoji ä¸åœ¨èŒƒå›´å†…ï¼‰

### AC-30.24.3: è¶…å¤§ payload æµ‹è¯•
- **Given** å•ä¸ª batch åŒ…å« 100 ä¸ªäº‹ä»¶ (è¶…è¿‡ Pydantic max=50 é™åˆ¶)
- **When** POST åˆ° `/api/v1/memory/episodes/batch`
- **Then** è¿”å› 422 Validation Error
- **And** é”™è¯¯æ¶ˆæ¯æ˜ç¡®è¯´æ˜ä¸Šé™

### AC-30.24.4: Shutdown æ•°æ®å®‰å…¨æµ‹è¯•
- **Given** æœ‰ 5 ä¸ª pending writes æœªè½ç›˜
- **When** `shutdown_memory_service()` è¢«è°ƒç”¨
- **And** Neo4j ä¸å¯è¾¾
- **Then** pending writes å†™å…¥ `failed_writes.jsonl`
- **And** `failed_writes.jsonl` åŒ…å« 5 æ¡è®°å½•
- **And** æ¯æ¡è®°å½•åŒ…å« `episode_id`, `timestamp`, `reason`

### AC-30.24.5: Unicode æ¦‚å¿µåç§°æµ‹è¯•
- **Given** concept å­—æ®µåŒ…å«: `"ç›£ç£å­¦ç¿’ ğŸ“Š"`, `"Bayes' Theorem"`, `"é›†åˆè®º âˆ© âˆª âŠ‚"`
- **When** å†™å…¥ Neo4j å¹¶æŸ¥è¯¢
- **Then** æ¦‚å¿µåç§°å®Œæ•´ä¿å­˜ (æ— ä¹±ç , æ— æˆªæ–­)
- **And** æŸ¥è¯¢è¿”å›æ­£ç¡®ç»“æœ

### AC-30.24.6: Vault éƒ¨ç½²éªŒè¯è„šæœ¬é€€å‡ºç 
- **Given** `npm run verify` æ£€æµ‹åˆ° vault main.js è¿‡æ—¶
- **When** æ‰§è¡Œ verify è„šæœ¬
- **Then** è¾“å‡º `ğŸ”´ STALE` å¹¶è¿”å›éé›¶é€€å‡ºç  (exit 1)
- **And** å¯ç”¨äº CI/pre-commit hook è‡ªåŠ¨åŒ–æ£€æŸ¥

---

## Tasks / Subtasks

### Task 1: è¾“å…¥è¾¹ç•Œæµ‹è¯•
- [x] 1.1 åˆ›å»º `test_story_30_24_boundary.py`
- [x] 1.2 å®ç° AC-30.24.1: ç©ºåˆ—è¡¨å¤„ç†
- [x] 1.3 å®ç° AC-30.24.2: ç‰¹æ®Šå­—ç¬¦ group_id (parametrize)
- [x] 1.4 å®ç° AC-30.24.3: è¶…å¤§ payload 422 éªŒè¯
- [x] 1.5 å®ç° AC-30.24.5: Unicode æ¦‚å¿µåç§°

### Task 2: Shutdown æ•°æ®å®‰å…¨
- [x] 2.1 å®ç° AC-30.24.4: shutdown + Neo4j ä¸å¯è¾¾ â†’ failed_writes.jsonl
- [x] 2.2 éªŒè¯ failed_writes.jsonl è®°å½•å®Œæ•´æ€§

### Task 3: Vault éƒ¨ç½²é˜²å›å½’
- [x] 3.1 å®ç° AC-30.24.6: verify è„šæœ¬ STALE æ—¶é€€å‡ºç ä¸º 1 (å·²ç¡®è®¤ verify-vault.mjs å·²æœ‰ process.exit(1))
- [x] 3.2 ä¿®æ”¹ `canvas-progress-tracker/obsidian-plugin/package.json` ä¸­ verify è„šæœ¬ (å·²ç¡®è®¤æ­£ç¡®: `"verify": "node scripts/verify-vault.mjs"`)

---

## Dev Notes

### ç‰¹æ®Šå­—ç¬¦æµ‹è¯•æ•°æ®
```python
SPECIAL_GROUP_IDS = [
    "",              # ç©ºå­—ç¬¦ä¸²
    "../etc/passwd", # è·¯å¾„éå†
    "<script>",      # XSS
    "æ•°å­¦/ç¦»æ•£æ•°å­¦",   # ä¸­æ–‡è·¯å¾„
    "ğŸ“š Math",       # emoji
    "a" * 1000,      # è¶…é•¿å­—ç¬¦ä¸²
]
```

### åŸºç¡€è®¾æ–½ AC æ£€æŸ¥

| ç»´åº¦ | æ£€æŸ¥ | çŠ¶æ€ |
|------|------|------|
| D1 æŒä¹…åŒ– | shutdown æ—¶ pending writes ä¸ä¸¢å¤± | AC-30.24.4 |
| D2 å¼¹æ€§ | Neo4j ä¸å¯è¾¾æ—¶ failed_writes è®°å½• | AC-30.24.4 |
| D3 è¾“å…¥éªŒè¯ | ç©ºè¾“å…¥/ç‰¹æ®Šå­—ç¬¦/è¶…å¤§ payload | AC-30.24.1-3 |
| D5 é™çº§ | verify STALE é€€å‡ºç  | AC-30.24.6 |

---

## File List

| File | Action | Description |
|------|--------|-------------|
| `backend/tests/unit/test_story_30_24_boundary.py` | Created | 36 tests covering all 6 ACs |
| `backend/app/services/memory_service.py` | Modified | Added `_pending_failed_writes`, `_flush_pending_failed_writes()` for AC-30.24.4 |
| `docs/stories/30.24.boundary-test-hardening.story.md` | Modified | Status â†’ Review, tasks marked complete |

---

## Dev Agent Record

**Completion Date**: 2026-02-10
**Tests**: 36/36 passing
**AC Coverage**:
- AC-30.24.1 âœ… â€” 3 tests (empty list returns 0 processed, no Neo4j call, valid timestamp)
- AC-30.24.2 âœ… â€” 11 tests (6 parametrized sanitize + empty default + path traversal + XSS + Chinese + emoji + Neo4j parameterized query)
- AC-30.24.3 âœ… â€” 3 tests (Pydantic max_length=50 enforced, oversized 422, error message clarity)
- AC-30.24.4 âœ… â€” 3 tests (shutdown flushes to failed_writes.jsonl, 5 records, field completeness)
- AC-30.24.5 âœ… â€” 8 tests (4 Unicode concepts stored + 4 queried back)
- AC-30.24.6 âœ… â€” 5 tests (script exists, NOT FOUND exit 1, STALE exit 1, FRESH exit 0, package.json correct)

**Production Code Changes**:
- `memory_service.py`: Added `_pending_failed_writes` list tracking + `_flush_pending_failed_writes()` method called during `cleanup()`. Uses existing `failed_writes_lock` and `FAILED_WRITES_FILE` from `failed_writes_constants.py`.

**Notes**:
- AC-30.24.3: Pydantic `BatchEpisodesRequest.events` already has `max_length=50`, no code change needed.
- AC-30.24.6: `verify-vault.mjs` already had `process.exit(1)` on STALE. `package.json` already had correct verify command. Tests added to prevent regression.
- Windows UTF-8 encoding: subprocess tests use `encoding='utf-8', errors='replace'` to handle emoji in Node.js output on Windows (GBK default codec).

---

## Change Log

| Date | Change | Author |
|------|--------|--------|
| 2026-02-10 | Story åˆ›å»º (å¯¹æŠ—æ€§å®¡æŸ¥ä¿®å¤ Phase 4) | ROG |
| 2026-02-10 | å®ç°å®Œæˆ: 36/36 tests passing, Status â†’ Review | Dev Agent |
| 2026-02-10 | Code Review: 3H/4M/2L â†’ ä¿®å¤ 7 é¡¹ (H1 æ¡ä»¶æ–­è¨€, H2 emoji AC æ¾„æ¸…, H3 å•å…ƒ/é›†æˆåˆ†ç±», M1 æ­£æ–­è¨€, M2 å¯è¯»æ€§, M3 å¥å£®æ–­è¨€, M4 async æ–‡æ¡£). 36/36 é€šè¿‡. Status â†’ Done | Code Review |
