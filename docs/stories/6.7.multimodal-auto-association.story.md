# Story 6.7: 多模态自动关联算法

## Status
Completed

## Story

**As a** Canvas学习用户,
**I want** 系统自动推荐相关的图片/PDF资料,
**so that** 我可以发现概念和资料之间的关联

## Epic Context

**Epic**: SCP-006 多模态文件关联
**Phase**: Phase 3 - 关联与检索
**Priority**: P1
**Estimated Time**: 3天

## Dependencies

- ✅ Story 6.6 (向量化) - 多模态向量存储
- ✅ Epic 12.1 (Graphiti) - 知识图谱支持
- ✅ Story 6.3 (存储架构) - Neo4j关系定义

## Acceptance Criteria

### AC 6.7.1: 概念-资料相似度计算
- [x] 计算概念向量与资料向量相似度
- [x] 支持余弦相似度和欧氏距离
- [x] 相似度阈值可配置 (默认0.7)

### AC 6.7.2: 自动关联推荐
- [x] 对每个概念节点推荐Top-K相关资料
- [x] 推荐结果按相似度排序
- [x] 支持过滤已关联资料

### AC 6.7.3: 建立Neo4j关系
- [x] 创建 (Concept)-[:HAS_MEDIA]->(Media) 关系
- [x] 关系包含relevance_score属性
- [x] 支持批量创建关系

### AC 6.7.4: 推荐延迟≤500ms
- [x] 单概念推荐≤500ms
- [x] 使用向量索引加速
- [x] 支持缓存热门查询

## Tasks / Subtasks

- [x] Task 1: 创建AssociationEngine类 (AC: 6.7.1, 6.7.2)
  - [x] 实现calculate_similarity()
  - [x] 实现recommend_media()
  - [x] Top-K排序逻辑

- [x] Task 2: Neo4j关系管理 (AC: 6.7.3)
  - [x] 实现create_media_relation()
  - [x] 实现batch_create_relations()
  - [x] 更新Graphiti Client

- [x] Task 3: 性能优化 (AC: 6.7.4)
  - [x] LanceDB向量索引配置
  - [x] 查询结果缓存
  - [x] 异步批量处理

## Dev Notes

### 技术栈

```yaml
相似度计算:
  方法: 余弦相似度 (cosine similarity)
  阈值: 0.7 (可配置)
  Top-K: 5 (默认)

向量检索:
  LanceDB:
    索引类型: IVF_PQ
    nprobes: 10
    metric: cosine

关系存储:
  Neo4j:
    关系: HAS_MEDIA
    属性: relevance_score, created_at
```

### 代码位置

```
创建文件:
- src/agentic_rag/processors/association_engine.py

修改文件:
- src/agentic_rag/clients/graphiti_client.py (添加create_media_relation)
- src/agentic_rag/clients/lancedb_client.py (添加similarity_search)

测试文件:
- src/tests/test_association_engine.py
```

### 核心实现

```python
# src/agentic_rag/processors/association_engine.py
from dataclasses import dataclass

@dataclass
class MediaRecommendation:
    """媒体推荐结果"""
    media_id: str
    media_type: str
    file_path: str
    similarity_score: float
    description: str | None

class AssociationEngine:
    """多模态自动关联引擎"""

    def __init__(
        self,
        lancedb_client,
        graphiti_client,
        similarity_threshold: float = 0.7,
        top_k: int = 5
    ):
        self.lancedb = lancedb_client
        self.graphiti = graphiti_client
        self.threshold = similarity_threshold
        self.top_k = top_k

    async def recommend_media_for_concept(
        self,
        concept_id: str,
        concept_vector: list[float]
    ) -> list[MediaRecommendation]:
        """为概念推荐相关媒体资料"""

        # 1. 向量相似度搜索
        results = await self.lancedb.similarity_search(
            table_name="multimodal_content",
            query_vector=concept_vector,
            top_k=self.top_k * 2,  # 获取更多候选
            metric="cosine"
        )

        # 2. 过滤低相似度结果
        recommendations = []
        for result in results:
            if result["_distance"] >= self.threshold:
                recommendations.append(MediaRecommendation(
                    media_id=result["id"],
                    media_type=result["media_type"],
                    file_path=result["file_path"],
                    similarity_score=result["_distance"],
                    description=result.get("description")
                ))

        # 3. 返回Top-K
        return recommendations[:self.top_k]

    async def create_associations(
        self,
        concept_id: str,
        recommendations: list[MediaRecommendation]
    ) -> int:
        """创建概念-媒体关联关系"""
        created_count = 0

        for rec in recommendations:
            await self.graphiti.create_relation(
                source_id=concept_id,
                target_id=rec.media_id,
                relation_type="HAS_MEDIA",
                properties={
                    "relevance_score": rec.similarity_score,
                    "created_at": datetime.now().isoformat()
                }
            )
            created_count += 1

        return created_count
```

### Neo4j Cypher查询

```cypher
// 创建关联关系
MATCH (c:Concept {id: $concept_id})
MATCH (m:Media {id: $media_id})
MERGE (c)-[r:HAS_MEDIA]->(m)
SET r.relevance_score = $score,
    r.created_at = datetime()
RETURN r

// 查询概念的所有关联媒体
MATCH (c:Concept {id: $concept_id})-[r:HAS_MEDIA]->(m:Media)
RETURN m.id, m.type, m.path, r.relevance_score
ORDER BY r.relevance_score DESC
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-30 | 1.0 | Initial Story Creation | SM Agent (Bob) |

## QA Results

### Review Date: 待开发

### Reviewed By: 待开发

### Test Results
待开发

---

**关联文档**:
- SCP-006-IMPLEMENTATION-PLAN.md
- Story 6.6 (向量化)
- Epic 12.1 (Graphiti集成)
