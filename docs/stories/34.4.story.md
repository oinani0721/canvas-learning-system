# Story 34.4: 复习历史分页与默认限制

## Status

**Done**

## Story

**As a** 学习者,
**I want** 复习历史默认只显示最近5条记录，并提供"显示全部"按钮,
**so that** 我能快速查看近期复习情况，同时保持界面简洁，需要时可展开完整历史

## Acceptance Criteria

1. **AC1**: 历史记录默认显示最近5条
   - 复习Dashboard历史Tab加载时，默认仅显示最新5条记录
   - 显示"显示全部 (N条)" 按钮，N为总记录数

2. **AC2**: 点击"显示全部"加载完整历史
   - 点击按钮后加载并显示所有历史记录
   - 按钮文字变为"收起" 或隐藏
   - 支持再次收起回到5条显示

3. **AC3**: API支持 `limit` 和 `show_all` 参数
   - `/review/history` 端点新增 `limit` 参数 (默认值: 5)
   - 新增 `show_all` 参数 (布尔值，覆盖limit)
   - 响应中包含 `total_count` 字段表示总记录数

## Tasks / Subtasks

- [ ] **Task 1: 后端API端点实现** (AC: 3)
  - [ ] 1.1 在 `backend/app/api/v1/endpoints/review.py` 中**创建** `/review/history` 端点 (OpenAPI已定义但后端未实现)
  - [ ] 1.2 实现现有OpenAPI参数: `days`, `canvas_path`, `concept_name`
  - [ ] 1.3 添加 `limit: int = Query(5, ge=1, le=100)` 参数
  - [ ] 1.4 添加 `show_all: bool = Query(False)` 参数
  - [ ] 1.5 更新响应Schema添加 `total_count` 字段
  - [ ] 1.6 添加错误处理: `limit` 超出范围返回 422, 空结果返回 200 with `records: []`

- [ ] **Task 2: 后端服务层分页逻辑** (AC: 3)
  - [ ] 2.1 修改 `backend/app/services/review_service.py` 的历史查询方法
  - [ ] 2.2 实现 `limit` 参数的切片逻辑
  - [ ] 2.3 当 `show_all=True` 时返回全部记录
  - [ ] 2.4 始终计算并返回 `total_count`

- [ ] **Task 3: 前端默认5条显示** (AC: 1)
  - [ ] 3.1 修改 `ReviewDashboardView.ts` 的 `loadHistoryData()` 方法
  - [ ] 3.2 默认请求时带上 `limit=5` 参数
  - [ ] 3.3 存储 `total_count` 到组件状态

- [ ] **Task 4: 前端"显示全部"按钮** (AC: 2)
  - [ ] 4.1 在 `renderHistoryContent()` 中添加"显示全部 (N条)"按钮
  - [ ] 4.2 实现按钮点击处理：请求 `show_all=true`
  - [ ] 4.3 实现"收起"功能：重新请求 `limit=5`
  - [ ] 4.4 按钮状态切换 (显示全部 ↔ 收起)

- [ ] **Task 5: OpenAPI规范更新** (AC: 3)
  - [ ] 5.1 更新 `specs/api/review-api.openapi.yml` 添加新参数
  - [ ] 5.2 更新响应Schema包含 `total_count`

- [ ] **Task 6: 单元测试** (AC: 1, 2, 3)
  - [ ] 6.1 后端测试: `limit` 参数边界测试
  - [ ] 6.2 后端测试: `show_all` 参数覆盖测试
  - [ ] 6.3 后端测试: `total_count` 正确性测试

## Dev Notes

### SDD规范参考 (必填)

**API端点** (从OpenAPI specs):

| 项目 | 内容 |
|------|------|
| 端点路径 | `GET /api/v1/review/history` |
| 规范来源 | `[Source: specs/api/review-api.openapi.yml#L182-L213]` |
| **实现状态** | ⚠️ OpenAPI已定义，后端**尚未实现** - 本Story需创建 |
| 现有参数 (OpenAPI) | `days` (7/30/90), `canvas_path`, `concept_name` |
| **新增参数** | `limit: integer` (default: 5, min: 1, max: 100) |
| **新增参数** | `show_all: boolean` (default: false) |
| 响应Schema | `HistoryResponse` (需扩展添加 `total_count`) |

**当前响应结构** (需扩展):
```yaml
HistoryResponse:
  type: object
  properties:
    period:
      type: string
    total_reviews:
      type: integer
    records:
      type: array
      items:
        $ref: '#/components/schemas/ReviewRecord'
    statistics:
      $ref: '#/components/schemas/HistoryStatistics'
    # 新增字段
    total_count:
      type: integer
      description: 总记录数(用于前端显示"显示全部(N条)")
```

**数据Schema** (分页元数据参考):
- Schema来源: `[Source: specs/data/pagination-meta.schema.json]`
- 可参考字段: `total`, `page`, `page_size`, `has_next`, `has_prev`
- 本Story采用简化分页: 仅用 `limit` + `total_count`
- 设计决策: 使用 `total_count` 而非 `total` 以区分于现有 `total_reviews` 字段

**参数交互逻辑**:
1. `days` 参数先过滤时间范围 (7/30/90天内的记录)
2. `limit` 参数再限制返回的记录条数 (默认5条)
3. `show_all=true` 时忽略 `limit`，返回所有符合 `days` 条件的记录
4. `total_count` 始终返回符合 `days` 条件的**总记录数** (不受 `limit` 影响)

### ADR决策关联 (必填)

| ADR编号 | 决策标题 | 对Story的影响 |
|---------|----------|---------------|
| ADR-0004 | Async Execution Engine | 后端API使用async/await模式，history端点需遵循异步设计 |
| N/A | 缓存策略 | 暂无缓存ADR，建议后续如需缓存history查询，需新建ADR |

**关键约束** (从项目实践提取):
- 约束1: API测试需覆盖边界条件 (limit=1, limit=100, show_all=true/false)
- 约束2: 遵循pytest-asyncio异步测试模式 (参考现有review.py测试)
- 约束3: 新增参数需同步更新OpenAPI规范

来源引用: `[Source: docs/architecture/decisions/0004-async-execution-engine.md]`

> ⚠️ **PO验证说明**: 原Draft引用的ADR-007/008不存在，已更正为实际存在的ADR引用。

### 相关代码位置

**后端**:
- `backend/app/api/v1/endpoints/review.py` - Review Router (~522行)
  - ⚠️ **注意**: `/review/history` 端点在OpenAPI已定义 (`review-api.openapi.yml:L182-L213`)，但后端**尚未实现**
  - 现有端点: `/schedule`, `/generate`, `/record`, `/progress/multi/{path}`
  - **本Story需新建** `/history` 端点 (参考 `/progress/multi` 实现模式)

- `backend/app/services/review_service.py` - Review Service
  - 需新增 `get_history()` 方法支持分页参数
  - 可参考 `get_multi_review_progress()` 方法实现模式

- `backend/app/models/__init__.py` - 响应模型
  - 需新增/更新 `HistoryResponse` 模型包含 `total_count` 字段

**前端**:
- `canvas-progress-tracker/obsidian-plugin/src/views/ReviewDashboardView.ts`
  - `loadHistoryData()` 方法 (L405-L426): 加载历史数据
  - `renderHistoryContent()` 方法 (L487-L500): 渲染历史内容
  - `renderHistoryList()` 方法 (L651-L683): 渲染历史列表 ⚠️ 当前使用 `.slice(0,7)` 显示7天，需改为基于API `limit` 参数
  - 使用 `HistoryService` 进行API调用

- `canvas-progress-tracker/obsidian-plugin/src/services/HistoryService.ts` - 历史服务
  - 需更新API调用方法支持 `limit` 和 `show_all` 参数

### Testing

**测试文件位置**: `backend/tests/`

**测试标准** (来自项目 `core-config.yaml`):
- 框架: pytest + pytest-asyncio
- 覆盖率目标: 99% (项目标准)
- 契约测试: Schemathesis (验证OpenAPI合规)
- 来源引用: `[Source: .bmad-core/core-config.yaml#testing]`

**本Story测试要求**:
1. 单元测试: `tests/unit/test_review_history_pagination.py`
   - 测试 `limit` 参数边界 (1, 5, 100)
   - 测试 `limit` 超出范围时返回422
   - 测试 `show_all=true` 覆盖 `limit`
   - 测试 `total_count` 计算正确性
   - 测试空结果返回 `records: []` 和 `total_count: 0`

2. 集成测试: `tests/integration/test_review_api_pagination.py`
   - 测试完整API调用流程
   - 测试与现有参数 (`days`, `canvas_path`, `concept_name`) 组合
   - 测试 `days` 过滤后再应用 `limit` 的行为

3. 契约测试: 更新Schemathesis配置包含新参数

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-19 | 0.1 | Initial draft | Bob (SM Agent) |
| 2026-01-20 | 0.2 | **PO Validation Fixes**: (1) Removed hallucinated ADR-007/008 refs, replaced with ADR-0004; (2) Corrected Task 1 from "modify" to "create" endpoint; (3) Fixed code location refs; (4) Added parameter interaction logic; (5) Added HistoryService.ts path; (6) Added error handling specs | Sarah (PO Agent) |
| 2026-01-20 | 0.3 | Status changed to **Approved** after successful re-validation (Score: 9/10, GO) | Sarah (PO Agent) |

---

## Dev Agent Record

### Agent Model Used
(To be filled by Dev Agent)

### Debug Log References
(To be filled by Dev Agent)

### Completion Notes List
(To be filled by Dev Agent)

### File List
(To be filled by Dev Agent)

---

## QA Results

### Review Date: 2026-01-31

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

实现质量优秀。所有 3 个验收标准均已完整实现：

1. **AC1 (默认显示5条)**: 后端 `get_review_history` 端点默认 `limit=5`，前端 `loadHistoryData()` 正确传递参数。
2. **AC2 (显示全部/收起)**: 前端实现了 `toggleShowAllHistory()` 方法，按钮文字在"显示全部 (N条)"和"收起"之间正确切换。
3. **AC3 (API参数)**: `/review/history` 端点正确支持 `limit` (1-100) 和 `show_all` 参数，响应包含 `pagination` 信息。

代码结构清晰，遵循项目的 async/await 模式和 Pydantic 模型规范。

### Refactoring Performed

无需重构。代码实现符合项目标准。

### Compliance Check

- Coding Standards: ✓ 遵循 async/await 模式，类型注解完整
- Project Structure: ✓ API端点、服务层、模型分离清晰
- Testing Strategy: ✓ 单元测试17个 + 集成测试20个全部通过
- All ACs Met: ✓ 3/3 验收标准完全满足

### Improvements Checklist

- [x] 后端 API 端点实现 (`backend/app/api/v1/endpoints/review.py:L240-L363`)
- [x] 服务层分页逻辑 (`backend/app/services/review_service.py:L834-L940`)
- [x] Pydantic 响应模型 (`backend/app/models/review_models.py`)
- [x] 前端视图实现 (`ReviewDashboardView.ts:L441-L476, L701-L750`)
- [x] 前端服务层 (`HistoryService.ts`)
- [x] OpenAPI 规范更新 (`specs/api/review-api.openapi.yml:L191-L244`)
- [x] 单元测试 (17个测试通过)
- [x] 集成测试 (20个测试通过)
- [ ] 更新 Story 文件的 Dev Agent Record 和 File List (文档缺失)

### Security Review

无安全问题。分页参数有边界验证 (`limit: ge=1, le=100`)，防止过大请求。

### Performance Considerations

无性能问题。`limit` 参数在服务层正确应用切片，避免返回过多数据。

### Files Modified During Review

无文件修改。代码实现完整且符合标准。

### Gate Status

Gate: **PASS** → docs/qa/gates/34.4-review-history-pagination.yml

### Recommended Status

✓ Ready for Done

**注意**: Story 文件的 Dev Agent Record 和 File List 部分为空，建议 Dev 补充完整以保持文档一致性。
