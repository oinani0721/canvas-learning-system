# Story 21.5: ä¸ªäººç†è§£èŠ‚ç‚¹è‡ªåŠ¨åˆ›å»º

## Status
ğŸ”„ In Development

## Story

**As a** å­¦ä¹ è€…,
**I want** æ¯æ¬¡Agentç”Ÿæˆè§£é‡Šåè‡ªåŠ¨åˆ›å»ºä¸€ä¸ªç©ºç™½é»„è‰²èŠ‚ç‚¹ä¾›æˆ‘å¡«å†™ä¸ªäººç†è§£,
**so that** è·µè¡Œè´¹æ›¼å­¦ä¹ æ³•ã€‚

## Acceptance Criteria

1. AC-21.5.1: æ¯ä¸ªAgentè§£é‡ŠèŠ‚ç‚¹æ—è‡ªåŠ¨åˆ›å»ºé»„è‰²ä¸ªäººç†è§£èŠ‚ç‚¹
2. AC-21.5.2: ä¸ªäººç†è§£èŠ‚ç‚¹åŒ…å«æç¤ºæ–‡å­— "åœ¨æ­¤å¡«å†™ä½ çš„ä¸ªäººç†è§£..."
3. AC-21.5.3: ä¸ªäººç†è§£èŠ‚ç‚¹é€šè¿‡Edgeä¸è§£é‡ŠèŠ‚ç‚¹è¿æ¥
4. AC-21.5.4: æ”¯æŒé…ç½®æ˜¯å¦è‡ªåŠ¨åˆ›å»º (é»˜è®¤å¼€å¯)
5. AC-21.5.5: ä¸ªäººç†è§£èŠ‚ç‚¹ä½ç½®åœ¨è§£é‡ŠèŠ‚ç‚¹ä¸‹æ–¹

## Tasks / Subtasks

- [ ] Task 1: å®šä¹‰ä¸ªäººç†è§£èŠ‚ç‚¹æ¨¡æ¿ (AC: 1, 2)
  - [ ] åˆ›å»ºèŠ‚ç‚¹æ¨¡æ¿å¸¸é‡
  - [ ] è®¾ç½®é»˜è®¤æç¤ºæ–‡å­—
  - [ ] è®¾ç½®é»„è‰²é¢œè‰²å€¼ ("4")
  - [ ] è®¾ç½®é»˜è®¤å°ºå¯¸

- [ ] Task 2: å®ç°èŠ‚ç‚¹ä½ç½®è®¡ç®— (AC: 5)
  - [ ] è®¡ç®—è§£é‡ŠèŠ‚ç‚¹ä¸‹æ–¹ä½ç½®
  - [ ] æ·»åŠ é€‚å½“çš„é—´è· (50px)
  - [ ] é¿å…èŠ‚ç‚¹é‡å 

- [ ] Task 3: å®ç°Edgeè¿æ¥åˆ›å»º (AC: 3)
  - [ ] åˆ›å»ºè§£é‡ŠèŠ‚ç‚¹ â†’ ä¸ªäººç†è§£èŠ‚ç‚¹çš„Edge
  - [ ] è®¾ç½®Edgeæ ‡ç­¾ä¸º"ä¸ªäººç†è§£"
  - [ ] è®¾ç½®æ­£ç¡®çš„è¿æ¥ç‚¹ (bottom â†’ top)

- [ ] Task 4: æ·»åŠ é…ç½®å¼€å…³ (AC: 4)
  - [ ] æ·»åŠ é…ç½®é¡¹ AUTO_CREATE_PERSONAL_NODE
  - [ ] åœ¨åˆ›å»ºé€»è¾‘ä¸­æ£€æŸ¥é…ç½®
  - [ ] æ”¯æŒAPIå‚æ•°è¦†ç›–

- [ ] Task 5: æ›´æ–°æ‰€æœ‰Agentåˆ›å»ºé€»è¾‘ (AC: 1)
  - [ ] æ›´æ–°decompose_basic
  - [ ] æ›´æ–°decompose_deep
  - [ ] æ›´æ–°explain_oral
  - [ ] æ›´æ–°å…¶ä»–Agent

- [ ] Task 6: ç¼–å†™æµ‹è¯•
  - [ ] æµ‹è¯•èŠ‚ç‚¹åˆ›å»º
  - [ ] æµ‹è¯•Edgeè¿æ¥
  - [ ] æµ‹è¯•é…ç½®å¼€å…³
  - [ ] æµ‹è¯•ä½ç½®è®¡ç®—

## Dev Notes

### æ¶æ„ä¸Šä¸‹æ–‡

**è´¹æ›¼å­¦ä¹ æ³•æ ¸å¿ƒ** [Source: CLAUDE.md#project-overview]

Canvas Learning Systemçš„æ ¸å¿ƒåŸåˆ™æ˜¯"Learning by teaching - if you can't explain it simply, you don't understand it"ã€‚

æ¯ä¸ªæ¦‚å¿µè§£é‡ŠèŠ‚ç‚¹éƒ½åº”è¯¥é…æœ‰é»„è‰²çš„ä¸ªäººç†è§£èŠ‚ç‚¹ï¼Œè®©ç”¨æˆ·ç”¨è‡ªå·±çš„è¯å¤è¿°ï¼ŒéªŒè¯çœŸæ­£ç†è§£ã€‚

### å®ç°å‚è€ƒ

**ä¸ªäººç†è§£èŠ‚ç‚¹æ¨¡æ¿** [Source: docs/prd/EPIC-21-AGENT-E2E-FLOW-FIX.md#story-21-5]

```python
# backend/app/services/agent_service.py

import uuid
from typing import Dict, Any

# ä¸ªäººç†è§£èŠ‚ç‚¹æ¨¡æ¿
PERSONAL_UNDERSTANDING_TEMPLATE = {
    "type": "text",
    "text": "åœ¨æ­¤å¡«å†™ä½ çš„ä¸ªäººç†è§£...\n\nğŸ’¡ æç¤ºï¼šç”¨è‡ªå·±çš„è¯è§£é‡Šè¿™ä¸ªæ¦‚å¿µ",
    "width": 400,
    "height": 150,
    "color": "4"  # é»„è‰²
}

def create_personal_understanding_node(
    explanation_node_id: str,
    explanation_x: int,
    explanation_y: int,
    explanation_height: int,
    vertical_offset: int = 50
) -> Dict[str, Any]:
    """
    åˆ›å»ºä¸ªäººç†è§£èŠ‚ç‚¹

    Args:
        explanation_node_id: è§£é‡ŠèŠ‚ç‚¹ID (ç”¨äºåˆ›å»ºEdge)
        explanation_x: è§£é‡ŠèŠ‚ç‚¹Xåæ ‡
        explanation_y: è§£é‡ŠèŠ‚ç‚¹Yåæ ‡
        explanation_height: è§£é‡ŠèŠ‚ç‚¹é«˜åº¦
        vertical_offset: å‚ç›´é—´è· (é»˜è®¤50px)

    Returns:
        ä¸ªäººç†è§£èŠ‚ç‚¹æ•°æ®å­—å…¸
    """
    personal_node_id = str(uuid.uuid4())

    node = {
        "id": personal_node_id,
        **PERSONAL_UNDERSTANDING_TEMPLATE,
        "x": explanation_x,  # ä¸è§£é‡ŠèŠ‚ç‚¹æ°´å¹³å¯¹é½
        "y": explanation_y + explanation_height + vertical_offset  # åœ¨è§£é‡ŠèŠ‚ç‚¹ä¸‹æ–¹
    }

    return node, personal_node_id
```

**Edgeè¿æ¥åˆ›å»º**:

```python
def create_personal_understanding_edge(
    explanation_node_id: str,
    personal_node_id: str
) -> Dict[str, Any]:
    """åˆ›å»ºè§£é‡ŠèŠ‚ç‚¹åˆ°ä¸ªäººç†è§£èŠ‚ç‚¹çš„Edge"""
    return {
        "id": str(uuid.uuid4()),
        "fromNode": explanation_node_id,
        "toNode": personal_node_id,
        "fromSide": "bottom",
        "toSide": "top",
        "label": "ä¸ªäººç†è§£",
        "color": "4"  # é»„è‰²
    }
```

**é…ç½®é¡¹**:

```python
# backend/app/config.py

class Settings:
    # ä¸ªäººç†è§£èŠ‚ç‚¹é…ç½®
    AUTO_CREATE_PERSONAL_NODE: bool = os.getenv("AUTO_CREATE_PERSONAL_NODE", "true").lower() == "true"
    PERSONAL_NODE_VERTICAL_OFFSET: int = int(os.getenv("PERSONAL_NODE_VERTICAL_OFFSET", "50"))
    PERSONAL_NODE_PROMPT_TEXT: str = os.getenv(
        "PERSONAL_NODE_PROMPT_TEXT",
        "åœ¨æ­¤å¡«å†™ä½ çš„ä¸ªäººç†è§£...\n\nğŸ’¡ æç¤ºï¼šç”¨è‡ªå·±çš„è¯è§£é‡Šè¿™ä¸ªæ¦‚å¿µ"
    )
```

**æ›´æ–°Agentåˆ›å»ºé€»è¾‘**:

```python
async def _create_explanation_with_personal_node(
    self,
    explanation_text: str,
    source_x: int,
    source_y: int,
    source_width: int,
    source_height: int,
    source_node_id: str,
    edge_label: str = "è§£é‡Š"
) -> Dict[str, Any]:
    """åˆ›å»ºè§£é‡ŠèŠ‚ç‚¹å’Œä¸ªäººç†è§£èŠ‚ç‚¹"""

    # 1. åˆ›å»ºè§£é‡ŠèŠ‚ç‚¹
    explanation_node_id = str(uuid.uuid4())
    explanation_x = source_x + source_width + 50
    explanation_y = source_y
    explanation_height = 200  # é»˜è®¤é«˜åº¦

    explanation_node = {
        "id": explanation_node_id,
        "type": "text",
        "text": explanation_text,
        "x": explanation_x,
        "y": explanation_y,
        "width": 400,
        "height": explanation_height,
        "color": "3"  # ç»¿è‰²
    }

    # 2. åˆ›å»ºæºèŠ‚ç‚¹åˆ°è§£é‡ŠèŠ‚ç‚¹çš„Edge
    source_edge = {
        "id": str(uuid.uuid4()),
        "fromNode": source_node_id,
        "toNode": explanation_node_id,
        "fromSide": "right",
        "toSide": "left",
        "label": edge_label
    }

    created_nodes = [explanation_node]
    created_edges = [source_edge]

    # 3. å¦‚æœé…ç½®å¼€å¯ï¼Œåˆ›å»ºä¸ªäººç†è§£èŠ‚ç‚¹
    if settings.AUTO_CREATE_PERSONAL_NODE:
        personal_node, personal_node_id = create_personal_understanding_node(
            explanation_node_id=explanation_node_id,
            explanation_x=explanation_x,
            explanation_y=explanation_y,
            explanation_height=explanation_height
        )

        personal_edge = create_personal_understanding_edge(
            explanation_node_id=explanation_node_id,
            personal_node_id=personal_node_id
        )

        created_nodes.append(personal_node)
        created_edges.append(personal_edge)

    return {
        "created_nodes": created_nodes,
        "created_edges": created_edges
    }
```

### å…³é”®æ–‡ä»¶

- `backend/app/services/agent_service.py` - ä¸»è¦ä¿®æ”¹
- `backend/app/services/canvas_service.py` - èŠ‚ç‚¹åˆ›å»ºå·¥å…·
- `backend/app/config.py` - æ·»åŠ é…ç½®é¡¹

### æµ‹è¯•è¦æ±‚

**å•å…ƒæµ‹è¯•è¦†ç›–**:
- æµ‹è¯•ä¸ªäººç†è§£èŠ‚ç‚¹çš„ä½ç½®è®¡ç®—
- æµ‹è¯•Edgeè¿æ¥çš„æ­£ç¡®æ€§
- æµ‹è¯•é…ç½®å¼€å…³çš„ä½œç”¨
- æµ‹è¯•æç¤ºæ–‡å­—çš„æ­£ç¡®æ€§
- æµ‹è¯•é¢œè‰²å€¼çš„æ­£ç¡®æ€§

## SDDè§„èŒƒå¼•ç”¨

- **OpenAPI Spec**: `specs/api/canvas-api.openapi.yml#/components/schemas/CanvasNode`
- **æ¶æ„æ–‡æ¡£**: `docs/prd/EPIC-21-AGENT-E2E-FLOW-FIX.md#story-21-5`
- **é¡¹ç›®åŸåˆ™**: `CLAUDE.md#project-overview`

## ADRå…³è”

æ— ç›´æ¥å…³è”çš„ADRã€‚æ­¤ Story ä¸º Bug Fixï¼Œä¸æ¶‰åŠæ¶æ„å†³ç­–å˜æ›´ã€‚

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-12 | 1.0 | åˆå§‹Storyåˆ›å»º | SM Agent (Bob) |
