# Story 21.5.3: Bug追踪日志系统

## Status
✅ PO Validated - Ready for Development

**PO Validation**: 2025-12-14 | **Result**: APPROVED
- 10/10 validation steps passed
- 2 non-blocking concerns documented (security recommendations)
- Schema extension task noted for implementation

## Story

**As a** 开发者/运维人员,
**I want** 所有500错误自动记录到持久化Bug日志,
**so that** 可以快速诊断和追踪用户遇到的问题。

## Acceptance Criteria

1. AC-21.5.3.1: 所有500错误自动记录到 `backend/data/bug_log.jsonl`
2. AC-21.5.3.2: 记录包含：时间戳、端点、请求参数、错误堆栈、bug_id
3. AC-21.5.3.3: 提供 `/api/v1/debug/bugs` 端点查看最近Bug
4. AC-21.5.3.4: Bug日志支持按数量限制查询 (默认50条)
5. AC-21.5.3.5: 每条Bug记录生成唯一bug_id (格式: BUG-{uuid8})

## Tasks / Subtasks

- [ ] Task 1: 创建BugTracker核心服务 (AC: 1, 2, 5)
  - [ ] 创建 `backend/app/core/bug_tracker.py`
  - [ ] 实现 BugRecord Pydantic模型
  - [ ] 实现 BugTracker.log_error() 方法
  - [ ] 实现 BugTracker.get_recent_bugs() 方法
  - [ ] 确保目录自动创建

- [ ] Task 2: 集成到全局异常处理器 (AC: 1)
  - [ ] 修改 `backend/app/core/exception_handlers.py`
  - [ ] 在 generic_exception_handler (line 196-240) 中调用 bug_tracker.log_error()
  - [ ] 在错误响应中包含 bug_id

- [ ] Task 3: 创建Debug API端点 (AC: 3, 4)
  - [ ] 创建 `backend/app/api/v1/endpoints/debug.py`
  - [ ] 实现 GET `/api/v1/debug/bugs` 端点
  - [ ] 支持 `limit` 查询参数
  - [ ] 注册路由到main app

- [ ] Task 4: 编写单元测试
  - [ ] 测试 BugRecord 模型验证
  - [ ] 测试 BugTracker.log_error() JSONL写入
  - [ ] 测试 BugTracker.get_recent_bugs() 读取
  - [ ] 测试 bug_id 格式正确性
  - [ ] 测试 `/api/v1/debug/bugs` 端点

## Dev Notes

### 架构上下文

**错误处理策略** [Source: ADR-009-ERROR-HANDLING-RETRY-STRATEGY.md]

系统采用分层错误处理策略：
- ErrorCode enum 定义错误类别 (LLM: 1xxx, DB: 2xxx, File: 3xxx, Network: 4xxx, Agent: 5xxx)
- 现有 ErrorStore 使用 SQLite，但 Epic 21.5 明确要求 JSONL 格式以简化调试

**日志策略** [Source: ADR-010-LOGGING-AGGREGATION-STRUCTLOG.md]

系统使用 structlog 进行结构化日志，Bug日志作为独立子系统补充现有日志。

### 实现参考

**BugTracker核心实现** [Source: docs/prd/EPIC-21.5-AGENT-RELIABILITY-FIX.md#story-21-5-3]

```python
# backend/app/core/bug_tracker.py
import json
import traceback
import uuid
from datetime import datetime
from pathlib import Path
from typing import Optional, List

from pydantic import BaseModel


class BugRecord(BaseModel):
    """Bug记录模型 [Source: specs/data/error-response.schema.json]"""
    bug_id: str
    timestamp: datetime
    endpoint: str
    error_type: str
    error_message: str
    request_params: dict
    stack_trace: Optional[str] = None
    user_action: Optional[str] = None


class BugTracker:
    """
    Bug追踪日志服务

    将所有500错误记录到JSONL文件，便于调试和问题追踪。

    [Source: docs/prd/EPIC-21.5-AGENT-RELIABILITY-FIX.md#story-21-5-3]
    """

    def __init__(self, log_path: str = "data/bug_log.jsonl"):
        self.log_path = Path(log_path)
        self.log_path.parent.mkdir(parents=True, exist_ok=True)

    def log_error(
        self,
        endpoint: str,
        error: Exception,
        request_params: dict,
        user_action: Optional[str] = None
    ) -> str:
        """
        记录Bug，返回bug_id

        Args:
            endpoint: 发生错误的API端点路径
            error: 捕获的异常对象
            request_params: 请求参数字典
            user_action: 可选的用户操作描述

        Returns:
            str: 生成的bug_id (格式: BUG-{uuid8})
        """
        bug_id = f"BUG-{uuid.uuid4().hex[:8].upper()}"

        record = BugRecord(
            bug_id=bug_id,
            timestamp=datetime.utcnow(),
            endpoint=endpoint,
            error_type=type(error).__name__,
            error_message=str(error),
            request_params=request_params,
            stack_trace=traceback.format_exc(),
            user_action=user_action
        )

        with open(self.log_path, "a", encoding="utf-8") as f:
            f.write(record.model_dump_json() + "\n")

        return bug_id

    def get_recent_bugs(self, limit: int = 50) -> List[BugRecord]:
        """
        获取最近的Bug记录

        Args:
            limit: 返回的最大记录数

        Returns:
            List[BugRecord]: Bug记录列表，按时间倒序
        """
        if not self.log_path.exists():
            return []

        bugs = []
        with open(self.log_path, "r", encoding="utf-8") as f:
            for line in f:
                if line.strip():
                    bugs.append(BugRecord.model_validate_json(line))

        return bugs[-limit:][::-1]  # 返回最近N条，倒序排列


# 全局单例
bug_tracker = BugTracker()
```

**集成到异常处理器** [Source: backend/app/core/exception_handlers.py:196-240]

```python
# 在 exception_handlers.py 的 generic_exception_handler 中集成

from app.core.bug_tracker import bug_tracker

async def generic_exception_handler(
    request: Request,
    exc: Exception,
) -> JSONResponse:
    """Handle all unhandled exceptions as a fallback."""
    request_id = getattr(request.state, "request_id", "unknown")

    # 提取请求参数用于Bug日志
    request_params = {}
    try:
        if request.method in ["POST", "PUT", "PATCH"]:
            request_params = await request.json()
        request_params["query_params"] = dict(request.query_params)
    except:
        pass

    # 记录到Bug日志 - 新增
    bug_id = bug_tracker.log_error(
        endpoint=str(request.url.path),
        error=exc,
        request_params=request_params
    )

    logger.error(
        "unhandled_exception",
        request_id=request_id,
        bug_id=bug_id,  # 新增
        error_type=type(exc).__name__,
        error_message=str(exc),
        path=str(request.url.path),
        exc_info=True,
    )

    # 响应中包含bug_id - 修改
    body: Dict[str, Any] = {
        "code": 500,
        "message": "Internal server error",
        "bug_id": bug_id,  # 新增
        "error_type": type(exc).__name__,  # 新增 (便于调试)
    }

    return JSONResponse(
        status_code=500,
        content=body,
        headers={"X-Request-ID": request_id},
    )
```

**Debug API端点** [Source: specs/api/agent-api.openapi.yml - 需新增]

```python
# backend/app/api/v1/endpoints/debug.py
from typing import List
from fastapi import APIRouter, Query

from app.core.bug_tracker import bug_tracker, BugRecord

router = APIRouter(prefix="/debug", tags=["Debug"])


@router.get("/bugs", response_model=List[BugRecord])
async def get_recent_bugs(
    limit: int = Query(default=50, ge=1, le=200, description="返回的最大记录数")
) -> List[BugRecord]:
    """
    获取最近的Bug记录

    用于调试和问题追踪，返回最近记录的500错误。

    - **limit**: 返回记录数量 (1-200，默认50)
    """
    return bug_tracker.get_recent_bugs(limit=limit)
```

### 关键文件

| 文件 | 操作 | 说明 |
|------|------|------|
| `backend/app/core/bug_tracker.py` | 新建 | Bug追踪核心服务 |
| `backend/app/core/exception_handlers.py` | 修改 | 集成BugTracker到generic_exception_handler |
| `backend/app/api/v1/endpoints/debug.py` | 新建 | Debug API端点 |
| `backend/app/api/v1/__init__.py` | 修改 | 注册debug路由 |
| `backend/data/bug_log.jsonl` | 自动创建 | Bug日志存储 |

### 测试要求

**单元测试覆盖** [Source: .bmad-core/core-config.yaml#testing]:

```python
# tests/unit/test_bug_tracker.py

import pytest
from datetime import datetime
from pathlib import Path
import tempfile

from app.core.bug_tracker import BugTracker, BugRecord


class TestBugRecord:
    def test_bug_record_required_fields(self):
        """测试BugRecord必填字段"""
        record = BugRecord(
            bug_id="BUG-12345678",
            timestamp=datetime.utcnow(),
            endpoint="/api/v1/test",
            error_type="ValueError",
            error_message="Test error",
            request_params={"key": "value"}
        )
        assert record.bug_id.startswith("BUG-")
        assert len(record.bug_id) == 12  # BUG- + 8 chars

    def test_bug_record_optional_fields(self):
        """测试BugRecord可选字段默认值"""
        record = BugRecord(
            bug_id="BUG-12345678",
            timestamp=datetime.utcnow(),
            endpoint="/api/v1/test",
            error_type="ValueError",
            error_message="Test error",
            request_params={}
        )
        assert record.stack_trace is None
        assert record.user_action is None


class TestBugTracker:
    def test_log_error_creates_file(self, tmp_path):
        """测试log_error自动创建日志文件"""
        log_path = tmp_path / "bugs" / "test.jsonl"
        tracker = BugTracker(log_path=str(log_path))

        bug_id = tracker.log_error(
            endpoint="/api/v1/test",
            error=ValueError("Test"),
            request_params={"test": True}
        )

        assert log_path.exists()
        assert bug_id.startswith("BUG-")

    def test_log_error_appends_jsonl(self, tmp_path):
        """测试log_error追加JSONL格式"""
        log_path = tmp_path / "test.jsonl"
        tracker = BugTracker(log_path=str(log_path))

        tracker.log_error("/api/v1/a", ValueError("A"), {})
        tracker.log_error("/api/v1/b", TypeError("B"), {})

        lines = log_path.read_text().strip().split("\n")
        assert len(lines) == 2

    def test_get_recent_bugs_empty(self, tmp_path):
        """测试get_recent_bugs空文件"""
        log_path = tmp_path / "empty.jsonl"
        tracker = BugTracker(log_path=str(log_path))

        bugs = tracker.get_recent_bugs()
        assert bugs == []

    def test_get_recent_bugs_limit(self, tmp_path):
        """测试get_recent_bugs限制数量"""
        log_path = tmp_path / "test.jsonl"
        tracker = BugTracker(log_path=str(log_path))

        # 记录5个Bug
        for i in range(5):
            tracker.log_error(f"/api/v1/{i}", ValueError(f"Error {i}"), {})

        bugs = tracker.get_recent_bugs(limit=3)
        assert len(bugs) == 3
        # 验证是最新的3条
        assert "Error 4" in bugs[0].error_message
```

### 依赖说明

**Story依赖**:
- Story 21.5.1 (CORS修复) - Bug响应需要CORS头才能被插件读取

**技术依赖**:
- pydantic >= 2.0 (model_dump_json, model_validate_json)
- structlog (现有日志集成)

## SDD规范引用

- **OpenAPI Spec**: `specs/api/agent-api.openapi.yml` (需新增 /debug/bugs 端点)
- **Error Schema**: `specs/data/error-response.schema.json` (bug_id字段扩展)
- **ADR**: `docs/architecture/decisions/ADR-009-ERROR-HANDLING-RETRY-STRATEGY.md`
- **ADR**: `docs/architecture/decisions/ADR-010-LOGGING-AGGREGATION-STRUCTLOG.md`

## ADR关联

- **ADR-009**: 错误处理与重试策略 - Bug日志补充ErrorStore
- **ADR-010**: 日志聚合策略 - Bug日志作为独立子系统

## QA Results

**Review Date**: 2025-12-14
**Reviewer**: Quinn (Test Architect)
**Gate Decision**: CONCERNS

### Acceptance Criteria Validation

| AC | Description | Status | Evidence |
|----|-------------|--------|----------|
| AC-21.5.3.1 | 500错误自动记录到bug_log.jsonl | ✅ PASS | `exception_handlers.py:240-244` calls `bug_tracker.log_error()` |
| AC-21.5.3.2 | 记录包含时间戳、端点、请求参数、错误堆栈、bug_id | ✅ PASS | `BugRecord` model in `bug_tracker.py:30-55` |
| AC-21.5.3.3 | 提供 `/api/v1/debug/bugs` 端点 | ✅ PASS | `debug.py:30-99` with GET endpoint |
| AC-21.5.3.4 | Bug日志支持按数量限制查询 (默认50条) | ✅ PASS | `debug.py:56-61` with Query param (1-200, default 50) |
| AC-21.5.3.5 | 每条Bug记录生成唯一bug_id (格式: BUG-{uuid8}) | ✅ PASS | `bug_tracker.py:128` generates `BUG-{uuid4.hex[:8].upper()}` |

### Code Quality Assessment

**Architecture Compliance**:
- ✅ Follows ADR-009 (Error Handling Strategy) - JSONL separate from ErrorStore
- ✅ Follows ADR-010 (structlog) - Uses structlog for logging
- ✅ Pydantic v2 patterns - model_dump_json, model_validate_json
- ✅ FastAPI best practices - APIRouter, proper response models

**Implementation Quality**:
- ✅ Clean separation of concerns (core service + endpoints)
- ✅ Graceful error handling (logging failures don't affect requests)
- ✅ Timezone-aware timestamps (UTC)
- ✅ Directory auto-creation for log file
- ⭐ Bonus features: get_bug_by_id, get_bug_stats (beyond scope)

### Issues Found

| ID | Severity | Finding | Action Required |
|----|----------|---------|-----------------|
| TEST-001 | HIGH | No unit tests for BugTracker or debug endpoints | Must fix before complete |
| SEC-001 | MEDIUM | Debug endpoint exposes sensitive data without auth | Review for production |
| CODE-001 | LOW | Route ordering may cause /bugs/stats vs /bugs/{bug_id} conflict | Monitor |

### NFR Validation

| NFR | Status | Notes |
|-----|--------|-------|
| Security | ⚠️ CONCERNS | Debug endpoint needs auth in production |
| Performance | ✅ PASS | JSONL append efficient; read acceptable for debug |
| Reliability | ✅ PASS | Graceful degradation; won't fail main requests |
| Maintainability | ✅ PASS | Clean code; Pydantic; structlog; ADR-compliant |

### Recommendations

**Immediate (Must Fix)**:
1. Create `tests/unit/test_bug_tracker.py` with test coverage for:
   - BugRecord model validation
   - BugTracker.log_error() JSONL write
   - BugTracker.get_recent_bugs() read
   - bug_id format correctness
2. Create `backend/tests/test_debug.py` for endpoint tests

**Future (Monitor)**:
- Add authentication to debug endpoints before production
- Implement log rotation for bug_log.jsonl
- Add alerting for high bug frequency

### Quality Score: 72/100

**Gate File**: `docs/qa/gates/21.5.3-bug-tracking-log-system.yml`

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-14 | 1.0 | 初始Story创建 | SM Agent (Bob) |
| 2025-12-14 | 1.1 | PO验证通过 - 10步验证完成 | PO Agent (Sarah) |
| 2025-12-14 | 1.2 | QA Review - CONCERNS (missing tests) | Quinn (Test Architect) |
