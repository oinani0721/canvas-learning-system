# Story 33.10: P0 Runtime Defect Fixes (Adversarial Audit Round 2)

## Status: Review

---

## Story

**As a** Canvas Learning System user,
**I want** the batch processing UI to correctly poll progress, retry failed nodes with real content, and display accurate group status,
**so that** I can monitor batch execution in real-time and retry failures with meaningful results.

---

## Problem Statement

### Adversarial Audit Findings (2026-02-10)

Four P0 runtime defects discovered during adversarial review of EPIC-33:

| # | Finding | Severity | Location |
|---|---------|----------|----------|
| 1 | ProgressMonitorModal polls `/status/{sessionId}` but backend route is `/{session_id}` (no `/status/` segment) | P0 | `ProgressMonitorModal.ts:579` |
| 2 | `retry_single_node()` uses fake prompt `"Process node {node_id} from canvas {canvas_path}"` instead of fetching real node content | P0 | `intelligent_parallel_service.py:503` |
| 3 | `GroupProgress` always returns `completed_nodes=0, status=pending` regardless of actual progress | P0 | `intelligent_parallel_service.py:351-362` |
| 4 | `websocket_url` hardcoded to `ws://localhost:8000/...` — breaks non-localhost deployments | P1 | `intelligent_parallel_service.py:255` |

### Root Cause Analysis

**#1 URL Mismatch**: Backend route is `@intelligent_parallel_router.get("/{session_id}")` (line 410). The router is mounted at `/canvas/intelligent-parallel`, so the full path is `/canvas/intelligent-parallel/{session_id}`. But `ProgressMonitorModal.ts:579` calls `/canvas/intelligent-parallel/status/${this.sessionId}` — the extra `/status/` segment returns 404.

**#2 Fake Prompt**: `intelligent_parallel_service.py:503` constructs `prompt = f"Process node {node_id} from canvas {canvas_path}"` — a meaningless string. The correct pattern exists in `batch_orchestrator.py:643`: `node_content = await self._get_node_content(canvas_path, node_id)` which fetches real node text from the canvas JSON.

**#3 GroupProgress Hardcoded**: `intelligent_parallel_service.py:351-362` iterates `metadata["groups"]` but always constructs `GroupProgress(completed_nodes=0, status=GroupStatus.pending)` without consulting session results. The `BatchOrchestrator` tracks per-node results in `session.results` but `get_session_status()` ignores them.

**#4 Hardcoded WebSocket URL**: `intelligent_parallel_service.py:255` returns `websocket_url=f"ws://localhost:8000/ws/intelligent-parallel/{session_id}"`. This works only in local dev; any real deployment (Docker, remote server, HTTPS) will fail.

---

## Acceptance Criteria

### AC-33.10.1: ProgressMonitorModal URL matches backend route (P0)
- **Given** a batch session has been started
- **When** ProgressMonitorModal polls for progress
- **Then** it calls `GET /canvas/intelligent-parallel/{sessionId}` (no `/status/` segment)
- **And** the backend returns 200 with `ProgressResponse`

### AC-33.10.2: retry_single_node uses real node content (P0)
- **Given** a node has failed during batch processing
- **When** the user retries via `POST /canvas/single-agent`
- **Then** `retry_single_node()` fetches real node content from the canvas file
- **And** the agent receives the actual node text, not a placeholder string
- **And** if the canvas file is unavailable, falls back gracefully with a warning log

### AC-33.10.3: GroupProgress reflects actual session progress (P0)
- **Given** a batch session is running with 3 groups of 5 nodes each
- **When** the user polls `GET /canvas/intelligent-parallel/{session_id}`
- **Then** `GroupProgress.completed_nodes` equals the number of completed nodes in that group
- **And** `GroupProgress.status` is `running` when nodes are being processed, `completed` when all group nodes finish, `failed` when any node has errors

### AC-33.10.4: WebSocket URL derived from configuration (P1)
- **Given** the server is running behind a reverse proxy or on a non-default host
- **When** `start_batch_session()` returns the `SessionResponse`
- **Then** `websocket_url` is constructed from settings or omitted (let frontend build it from the current page origin)

---

## Technical Details

### Files to Modify

| File | Change | Priority |
|------|--------|----------|
| `canvas-progress-tracker/obsidian-plugin/src/modals/ProgressMonitorModal.ts` | Line 579: Remove `/status/` from poll URL | P0 |
| `backend/app/services/intelligent_parallel_service.py` | Line 503: Replace fake prompt with `_get_node_content()` call | P0 |
| `backend/app/services/intelligent_parallel_service.py` | Lines 351-362: Compute GroupProgress from `session.results` | P0 |
| `backend/app/services/intelligent_parallel_service.py` | Line 255: Derive WebSocket URL from settings or remove | P1 |

### Fix #1: ProgressMonitorModal URL (ProgressMonitorModal.ts:579)

**Before:**
```typescript
`${this.apiBaseUrl}/canvas/intelligent-parallel/status/${this.sessionId}`
```

**After:**
```typescript
`${this.apiBaseUrl}/canvas/intelligent-parallel/${this.sessionId}`
```

### Fix #2: Real Node Content (intelligent_parallel_service.py:503)

**Before:**
```python
prompt = f"Process node {node_id} from canvas {canvas_path}"
```

**After (pattern from batch_orchestrator.py:643):**
```python
node_content = await self._get_node_content(canvas_path, node_id)
if node_content:
    prompt = node_content
else:
    logger.warning(f"Could not fetch content for node {node_id}, using fallback prompt")
    prompt = f"Process node {node_id} from canvas {canvas_path}"
```

Requires adding a `_get_node_content()` method to `IntelligentParallelService`, or reusing the one from `BatchOrchestrator` (preferred: inject `canvas_service` and read node text from canvas JSON).

### Fix #3: GroupProgress Computation (intelligent_parallel_service.py:351-362)

**Before:**
```python
GroupProgress(
    group_id=group_id,
    status=GroupStatus.pending,
    completed_nodes=0,
    total_nodes=len(node_ids),
    results=[],
    errors=[],
)
```

**After:**
```python
# Count completed nodes from session results
group_results = [r for r in session_results if r.get("node_id") in node_ids]
group_completed = len([r for r in group_results if r.get("status") == "success"])
group_errors = [r for r in group_results if r.get("status") == "failed"]
group_status = _compute_group_status(group_completed, len(group_errors), len(node_ids))

GroupProgress(
    group_id=group_id,
    status=group_status,
    completed_nodes=group_completed,
    total_nodes=len(node_ids),
    results=group_results,
    errors=[e.get("error", "") for e in group_errors],
)
```

### Fix #4: WebSocket URL (intelligent_parallel_service.py:255)

**Option A (recommended):** Remove `websocket_url` from `SessionResponse` — let frontend construct it from `window.location`.

**Option B:** Accept a `base_url` parameter passed from the endpoint layer (which has access to the `Request` object).

---

## Test Plan

```bash
# 1. Unit tests for GroupProgress computation
cd backend && python -m pytest tests/unit/test_intelligent_parallel_service.py -v -k "group_progress"

# 2. Unit test for retry_single_node with real content
python -m pytest tests/unit/test_intelligent_parallel_service.py -v -k "retry_single_node"

# 3. Full regression
python -m pytest tests/ -v --timeout=120

# 4. Frontend verification (manual)
# Open Obsidian → trigger batch processing → verify ProgressMonitorModal polls succeed
```

---

## Definition of Done

- [x] ProgressMonitorModal polls `/{sessionId}` (no `/status/` segment)
- [x] `retry_single_node()` fetches real node content from canvas file
- [x] `GroupProgress.completed_nodes` reflects actual progress
- [x] `GroupProgress.status` transitions correctly (pending → running → completed/failed)
- [x] WebSocket URL is not hardcoded to `localhost:8000`
- [x] All existing tests pass (zero regressions)
- [x] New unit tests cover all 4 fixes

---

## Tasks / Subtasks

- [x] **Task 1: Fix #1 — ProgressMonitorModal URL mismatch (P0)**
  - [x] Remove `/status/` segment from poll URL in `ProgressMonitorModal.ts:579`
  - [x] Add backend route existence test

- [x] **Task 2: Fix #2 — retry_single_node uses real node content (P0)**
  - [x] Add `canvas_service` parameter to `IntelligentParallelService.__init__()`
  - [x] Implement `_get_node_content()` method (pattern from BatchOrchestrator)
  - [x] Update `retry_single_node()` to fetch real content with graceful fallback
  - [x] Inject `canvas_service` in endpoint layer `_ensure_async_deps()`
  - [x] Add 3 unit tests (real content, fallback, no canvas_service)

- [x] **Task 3: Fix #3 — GroupProgress reflects actual session progress (P0)**
  - [x] Compute `completed_nodes`, `status`, `results`, `errors` from `session.node_results`
  - [x] Build proper `NodeResult` and `NodeError` Pydantic model instances
  - [x] Fix `completed_groups` count in `ProgressResponse`
  - [x] Add 6 unit tests (all_pending, partial, completed, failures, multi-group, completed_groups)

- [x] **Task 4: Fix #4 — WebSocket URL not hardcoded (P1)**
  - [x] Change `websocket_url` from `f"ws://localhost:8000/..."` to `None`
  - [x] Add 2 unit tests (is_none, not_localhost)

- [x] **Task 5: Regression testing**
  - [x] 12 new unit tests pass
  - [x] 50/50 existing + new tests pass (zero regressions)

---

## Dev Agent Record

### Implementation Notes

**Fix #1 (Frontend URL):** Single-line change in `ProgressMonitorModal.ts:579` — removed the extra `/status/` path segment. Backend route is `@intelligent_parallel_router.get("/{session_id}")` mounted at `/canvas/intelligent-parallel`, so full path is `/canvas/intelligent-parallel/{session_id}`.

**Fix #2 (Real Node Content):** Added `canvas_service` as optional dependency to `IntelligentParallelService`. Implemented `_get_node_content()` following the same pattern as `BatchOrchestrator._get_node_content()`. Key detail: `get_node_content()` is imported locally from `context_enrichment_service` to avoid circular imports. The endpoint layer injects `canvas_service` via `_ensure_async_deps()`.

**Fix #3 (GroupProgress Computation):** Replaced hardcoded `GroupProgress(completed_nodes=0, status=pending)` with computation from `session.node_results`. Key challenge: `GroupProgress.results` expects `List[NodeResult]` and `errors` expects `List[NodeError]` (Pydantic models from `intelligent_parallel_models`), not raw dicts/strings. Built proper model instances.

**Fix #4 (WebSocket URL):** Changed `websocket_url=f"ws://localhost:8000/..."` to `websocket_url=None`. Frontend constructs WebSocket URL from `window.location` origin.

### Key Technical Decisions
- `SessionResponse.task_id` has `alias="session_id"` with `populate_by_name=True` — access via `.task_id` in Python
- `session.node_results` is `Dict[str, NodeResult]` from `session_models` (not `intelligent_parallel_models`)
- Graceful degradation: if `canvas_service` is None or content fetch fails, falls back to placeholder prompt with WARNING log

---

## File List

| File | Action | Description |
|------|--------|-------------|
| `canvas-progress-tracker/obsidian-plugin/src/modals/ProgressMonitorModal.ts` | Modified | Fix #1: Removed `/status/` from poll URL (line 579) |
| `backend/app/services/intelligent_parallel_service.py` | Modified | Fix #2: Added `canvas_service` param + `_get_node_content()` method + real content in `retry_single_node()`. Fix #3: GroupProgress computation from `session.node_results`. Fix #4: `websocket_url=None` |
| `backend/app/api/v1/endpoints/intelligent_parallel.py` | Modified | Inject `canvas_service` into service via `_ensure_async_deps()` |
| `backend/tests/unit/test_story_33_10_runtime_defects.py` | Created | 14 unit tests covering all 4 fixes + edge cases |

---

## Change Log

| Date | Change | Author |
|------|--------|--------|
| 2026-02-10 | Story created from adversarial audit findings | Adversarial Reviewer |
| 2026-02-10 | All 4 fixes implemented, 12 tests added, 50/50 regression pass | Dev Agent |
| 2026-02-10 | Code review fixes: H1 NodeError import→module level, M1 sync I/O→asyncio.to_thread, M2 removed 13 unnecessary hasattr checks, M4 added 2 edge case tests (14 total). 82/82 tests pass. | Code Review |
