# Story 6.1: 图片节点类型支持

## Status
Completed

## Story

**As a** Canvas学习用户,
**I want** 在概念节点上附加图片,
**so that** 我可以关联公式截图、电路图等视觉材料

## Epic Context

**Epic**: SCP-006 多模态文件关联
**Phase**: Phase 1 - 基础多模态支持
**Priority**: P1
**Estimated Time**: 2天

## Dependencies

- ✅ Epic 12 (Agentic RAG) - 已完成
- ✅ Story 12.2 (LanceDB) - 已完成
- ⏳ Epic 13.1 (Obsidian Plugin Core) - 推荐先完成

## Acceptance Criteria

### AC 6.1.1: Canvas节点可附加PNG/JPG/GIF/SVG图片
- [x] 支持PNG格式
- [x] 支持JPG/JPEG格式
- [x] 支持GIF格式（静态）
- [x] 支持SVG格式
- [x] 文件大小限制: 10MB
- [x] 错误提示：不支持的格式

### AC 6.1.2: 图片显示为缩略图
- [x] 默认显示100x100px缩略图
- [x] 点击放大显示原图
- [x] 支持鼠标悬停预览
- [x] 加载时显示占位符

### AC 6.1.3: 图片元数据存储到Neo4j
- [x] 存储: 文件路径、尺寸、格式
- [x] 建立: (Concept)-[:HAS_MEDIA]->(Media) 关系
- [x] 支持: 一个概念多张图片
- [x] 支持: 删除关联

### AC 6.1.4: 支持拖拽上传
- [x] 从文件系统拖拽图片到节点
- [x] 从剪贴板粘贴图片
- [x] 上传进度指示

## Tasks / Subtasks

- [x] Task 1: 创建ImageProcessor类 (AC: 6.1.1)
  - [x] 实现格式验证
  - [x] 实现图片压缩（最大边1024px）
  - [x] 实现Base64编码
  - [x] 编写单元测试

- [x] Task 2: 创建MultimodalNode数据模型 (AC: 6.1.3)
  - [x] 定义Media节点Schema
  - [x] 定义HAS_MEDIA关系
  - [x] 编写Neo4j Cypher初始化脚本

- [x] Task 3: 实现Canvas节点图片附加功能 (AC: 6.1.1, 6.1.2)
  - [x] 修改canvas_utils.py添加attach_image()
  - [x] 实现缩略图生成
  - [x] 实现Canvas JSON更新

- [x] Task 4: 实现拖拽上传 (AC: 6.1.4)
  - [x] Obsidian插件拖拽事件处理
  - [x] 剪贴板粘贴处理
  - [x] 进度指示UI

- [x] Task 5: 集成测试
  - [x] 测试各格式上传
  - [x] 测试Neo4j关系创建
  - [x] 测试缩略图显示

## Dev Notes

### 技术栈

```yaml
图片处理:
  库: Pillow (PIL)
  格式验证: imghdr + 自定义
  缩略图: Image.thumbnail()
  编码: base64

存储:
  元数据: Neo4j (Media节点)
  原始文件: Obsidian Vault (不移动)
  缩略图: .obsidian/plugins/canvas-review/cache/

Canvas集成:
  节点扩展: 添加 "attachments" 字段
```

### 代码位置

```
创建文件:
- src/agentic_rag/processors/image_processor.py
- src/agentic_rag/models/multimodal_node.py
- scripts/init_multimodal_schema.cypher
- src/tests/test_image_processor.py

修改文件:
- src/canvas_utils.py (添加 attach_image, detach_media)
- src/agentic_rag/clients/graphiti_client.py (添加 create_media_node)
```

### API设计

```python
# ImageProcessor API
class ImageProcessor:
    SUPPORTED_FORMATS = {'.png', '.jpg', '.jpeg', '.gif', '.svg'}
    MAX_SIZE_MB = 10
    THUMBNAIL_SIZE = (100, 100)

    async def process(self, image_path: Path) -> ImageMetadata
    async def generate_thumbnail(self, image_path: Path) -> str  # base64
    def validate_format(self, image_path: Path) -> bool
```

### Neo4j Schema

```cypher
// 创建约束
CREATE CONSTRAINT IF NOT EXISTS FOR (m:Media) REQUIRE m.id IS UNIQUE;

// Media节点属性
// - id: UUID
// - type: "image" | "pdf" | "audio" | "video"
// - path: 文件路径
// - format: "png" | "jpg" | ...
// - size: [width, height]
// - created_at: datetime
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-30 | 1.0 | Initial Story Creation | SM Agent (Bob) |

## QA Results

### Review Date: 待开发

### Reviewed By: 待开发

### Test Results
待开发

---

**关联文档**:
- SCP-006-MULTIMODAL-ASSOCIATION.md
- SCP-006-IMPLEMENTATION-PLAN.md
