# Story 12.3: ChromaDB → LanceDB数据迁移

## Status: Approved

## Epic Context & Background

**所属Epic**: EPIC-12 - 三层记忆系统 + Agentic RAG
**Epic文档**: [EPIC-12-STORY-MAP.md](../epics/EPIC-12-STORY-MAP.md)

**本Story在Epic中的定位**:
- Phase 1 (基础设施层) 的关键Story
- 实现ChromaDB到LanceDB的零数据丢失迁移
- **依赖**: Story 12.2 (LanceDB POC通过)
- **被依赖**: Story 12.4, 12.5, 12.6, 12.17 (后续Story依赖迁移完成)

**Epic核心问题回顾**:

### Problem 3: 历史数据迁移风险
- **现象**: 系统已有大量ChromaDB向量数据 (canvas_explanations, canvas_concepts)
- **根因**: 直接替换会导致历史数据丢失
- **修复**: 设计迁移脚本 + 双写模式 + Rollback plan
- **本Story验证**: 验证迁移过程零数据丢失，支持快速回滚

### Problem 4: 灰度切换需求
- **现象**: 无法一次性切换所有流量到新数据库
- **根因**: 生产环境需要逐步验证
- **修复**: DualWriteAdapter双写模式
- **本Story验证**: 验证双写模式运行稳定，无写入失败

---

## Story

**As a** Canvas学习系统运维人员,
**I want** 零数据丢失地迁移ChromaDB数据到LanceDB,
**so that** 保留所有历史解释文档向量，用户无感知切换

---

## Acceptance Criteria

### AC 3.1: ChromaDB数据完整导出 (验证Problem 3)
- **导出范围**: 所有collection (`canvas_explanations`, `canvas_concepts`)
- **导出格式**: JSON Lines (每行一个文档 + metadata + embedding)
- **验证方式**: 记录数与ChromaDB一致 (例如: 5000条文档)
- **输出文件**: `data/migration/chromadb_export_*.jsonl`
- **Epic关联**: 确保历史数据不丢失

### AC 3.2: LanceDB数据完整导入 (验证Problem 3)
- **导入来源**: AC 3.1导出的JSON Lines文件
- **Schema映射**: ChromaDB metadata → LanceDB columns
- **验证方式**: 记录数100%对齐
- **Epic关联**: 确保新数据库包含所有历史数据

### AC 3.3: 数据一致性校验 (验证Problem 3核心)
- **抽样方法**: 随机抽样100条文档
- **对比内容**: doc_id, content, metadata
- **向量对比**: 余弦相似度 > 0.99
- **验证结果**: 100%一致通过
- **Epic关联**: 确保数据迁移正确性

### AC 3.4: 双写模式运行验证 (验证Problem 4)
- **适配器**: DualWriteAdapter同时写入ChromaDB + LanceDB
- **测试时长**: 1周稳定运行 (可模拟)
- **验证方式**: 新增文档在两个数据库都存在
- **监控指标**: 无写入失败错误
- **架构文档**: [MIGRATION-CHROMADB-TO-LANCEDB-ADAPTER.md](../architecture/MIGRATION-CHROMADB-TO-LANCEDB-ADAPTER.md)

### AC 3.5: Rollback Plan验证 (验证Problem 3安全)
- **备份格式**: ChromaDB数据备份 (tar.gz格式)
- **模拟场景**: 迁移失败，执行rollback
- **验证结果**: ChromaDB恢复到迁移前状态，无数据丢失
- **Epic关联**: 确保迁移风险可控

---

## Tasks / Subtasks

### 任务1: 创建迁移工具目录结构 (AC: 3.1, 3.2, 3.3, 3.4, 3.5)
- [ ] 1.1: 创建目录 `src/migration/chromadb_to_lancedb/`
- [ ] 1.2: 创建文件结构:
  ```
  src/migration/chromadb_to_lancedb/
  ├── __init__.py
  ├── exporter.py          # ChromaDB导出
  ├── importer.py          # LanceDB导入
  ├── validator.py         # 数据一致性校验
  ├── dual_write_adapter.py # 双写适配器
  └── rollback.py          # 回滚脚本
  ```
- [ ] 1.3: 创建数据目录 `data/migration/`

### 任务2: 实现ChromaDB数据导出 (AC: 3.1)
- [ ] 2.1: 创建 `exporter.py`
  ```python
  # ✅ Verified from Architecture doc - MIGRATION-CHROMADB-TO-LANCEDB-ADAPTER.md
  def export_collection_to_jsonl(
      collection_name: str,
      output_path: str
  ) -> ExportResult
  ```
- [ ] 2.2: 导出所有collection数据
- [ ] 2.3: 记录导出统计 (记录数, 文件大小)
- [ ] 2.4: 测试: 验证JSON Lines格式正确

### 任务3: 实现LanceDB数据导入 (AC: 3.2)
- [ ] 3.1: 创建 `importer.py`
  ```python
  # ✅ Verified from Context7 LanceDB docs
  def import_jsonl_to_lancedb(
      jsonl_path: str,
      table_name: str,
      db_path: str = "~/.lancedb"
  ) -> ImportResult
  ```
- [ ] 3.2: 实现Schema映射逻辑
- [ ] 3.3: 批量导入 (batch_size=1000)
- [ ] 3.4: 测试: 验证记录数100%对齐

### 任务4: 实现数据一致性校验 (AC: 3.3)
- [ ] 4.1: 创建 `validator.py`
  ```python
  def validate_migration(
      chromadb_client: chromadb.Client,
      lancedb_table: lancedb.Table,
      sample_size: int = 100
  ) -> ValidationResult
  ```
- [ ] 4.2: 实现随机抽样逻辑
- [ ] 4.3: 实现余弦相似度计算
- [ ] 4.4: 生成验证报告

### 任务5: 实现双写适配器 (AC: 3.4, Story依赖: 12.2)
- [ ] 5.1: 创建 `dual_write_adapter.py`
  ```python
  # ✅ Verified from Architecture doc - VectorDatabaseAdapter pattern
  class DualWriteAdapter(VectorDatabaseAdapter):
      def __init__(self, chromadb_backend, lancedb_backend):
          self.chromadb = chromadb_backend
          self.lancedb = lancedb_backend

      def store_memory(self, memory_id, content, embedding, metadata):
          # 双写逻辑
          self.chromadb.store_memory(...)
          self.lancedb.store_memory(...)
  ```
- [ ] 5.2: 实现双写失败处理 (重试机制)
- [ ] 5.3: 实现双写监控指标
- [ ] 5.4: 测试: 模拟1周写入场景

### 任务6: 实现Rollback脚本 (AC: 3.5)
- [ ] 6.1: 创建 `rollback.py`
  ```python
  def backup_chromadb(backup_path: str) -> BackupResult
  def restore_chromadb(backup_path: str) -> RestoreResult
  ```
- [ ] 6.2: 测试备份创建
- [ ] 6.3: 测试模拟迁移失败
- [ ] 6.4: 测试恢复验证

### 任务7: 创建迁移测试套件 (AC: 3.1-3.5)
- [ ] 7.1: 创建 `src/tests/migration/test_chromadb_to_lancedb.py`
- [ ] 7.2: 测试导出功能
- [ ] 7.3: 测试导入功能
- [ ] 7.4: 测试一致性校验
- [ ] 7.5: 测试双写适配器
- [ ] 7.6: 测试Rollback流程

---

## Dev Notes

### Dependencies Verification

**前置依赖验证** (必须先完成):
- [ ] **Story 12.2已完成**: LanceDB POC验证通过
- [ ] ChromaDB数据库存在: `./data/memory_db/` 或配置路径
- [ ] LanceDB环境就绪 (from Story 12.2)
- [ ] Python chromadb包已安装

**技术栈依赖**:
- [ ] chromadb >= 0.4.0 (当前使用版本)
- [ ] lancedb >= 0.4.0 (from Story 12.2)
- [ ] pandas (数据处理)
- [ ] numpy (向量计算)
- [ ] pytest (测试框架)

### SDD规范参考

**架构规范** [Source: docs/architecture/MIGRATION-CHROMADB-TO-LANCEDB-ADAPTER.md]:

```python
# ✅ Verified from Architecture doc - VectorDatabaseAdapter抽象基类
from abc import ABC, abstractmethod
from typing import Dict, List, Optional

class VectorDatabaseAdapter(ABC):
    """向量数据库抽象适配器"""

    @abstractmethod
    def store_memory(self, memory_id: str, content: str,
                     embedding: List[float], metadata: Dict) -> str:
        """存储语义记忆"""
        pass

    @abstractmethod
    def search_memory(self, query_embedding: List[float],
                      limit: int) -> List[Dict]:
        """搜索语义记忆"""
        pass
```

**ChromaDB API** [Source: chromadb官方文档]:

```python
# ✅ Verified from Architecture doc - ChromaDB导出模式
collection = client.get_collection("canvas_explanations")
results = collection.get(
    include=["documents", "metadatas", "embeddings"]
)
```

**LanceDB API** [Source: Context7 /lancedb/lancedb]:

```python
# ✅ Verified from Context7 - LanceDB批量导入
import lancedb
import pandas as pd

db = lancedb.connect("~/.lancedb")
table = db.create_table("canvas_memories", data=df)
# 或追加数据
table.add(df)
```

### ADR决策关联

**ADR-002: LanceDB Selection** [Source: docs/architecture/ADR-002-VECTOR-DATABASE-SELECTION.md]:
- **决策**: 选择LanceDB替代ChromaDB
- **迁移策略**: 双写模式 + 灰度切换
- **本Story关系**: 实现迁移策略

**Migration Architecture** [Source: docs/architecture/MIGRATION-CHROMADB-TO-LANCEDB-ADAPTER.md]:
- **DualWriteAdapter**: 双写适配器设计
- **Feature Flag**: `use_lancedb` 控制切换
- **Rollback**: 支持快速回滚

### Testing Standards

**测试文件位置**: `src/tests/migration/`

**测试类型**:
- 单元测试 (导出/导入功能)
- 集成测试 (双写适配器)
- 回归测试 (Rollback验证)

**Mock策略**:
- 创建小规模测试数据 (100条)
- 使用临时目录存储测试数据库
- CI环境跳过长时间运行测试

**覆盖率目标**: ≥80%

### Related Documentation

**Epic和Story文档**:
- [EPIC-12-STORY-MAP.md](../epics/EPIC-12-STORY-MAP.md) - Epic 12完整Story Map
- [12.2.story.md](./12.2.story.md) - LanceDB POC验证 (前置依赖)

**架构文档** [Source: docs/architecture/]:
- [MIGRATION-CHROMADB-TO-LANCEDB-ADAPTER.md](../architecture/MIGRATION-CHROMADB-TO-LANCEDB-ADAPTER.md) - 迁移适配层设计
- [ADR-002-VECTOR-DATABASE-SELECTION.md](../architecture/ADR-002-VECTOR-DATABASE-SELECTION.md) - LanceDB选型决策

**外部文档**:
- Context7 LanceDB: `/lancedb/lancedb` - API参考
- ChromaDB官方文档: https://docs.trychroma.com/

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-28 | 1.0 | 初始创建 - SM Agent *draft | Bob (SM Agent) |
| 2025-11-28 | 1.1 | AC编号统一为Epic Map格式 (AC 1→AC 3.1) - PO验证后修正 | Sarah (PO Agent) |

---

## Dev Agent Record

### Agent Model Used
*待填写*

### Debug Log References
*待填写*

### Completion Notes List
*待填写*

### File List
*待填写*

---

## QA Results

*待QA Agent审查*
