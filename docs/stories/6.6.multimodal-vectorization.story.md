# Story 6.6: 多模态内容向量化存储

## Status
Completed

## Story

**As a** Canvas学习用户,
**I want** 将图片/PDF内容自动转换为向量,
**so that** 可以通过语义搜索找到相关资料

## Epic Context

**Epic**: SCP-006 多模态文件关联
**Phase**: Phase 2 - 智能分析
**Priority**: P1
**Estimated Time**: 3天

## Dependencies

- ✅ Story 6.3 (存储架构) - LanceDB multimodal表
- ✅ Story 6.4 (OCR描述) - 提取的文本内容
- ✅ Story 6.5 (PDF提取) - 结构化PDF内容

## Acceptance Criteria

### AC 6.6.1: 图片内容向量化
- [x] 将OCR文本转换为768维向量
- [x] 将AI描述转换为768维向量
- [x] 支持加权融合多个向量

### AC 6.6.2: PDF内容向量化
- [x] 按章节分别向量化
- [x] 保留章节元数据
- [x] 支持全文和章节两种检索粒度

### AC 6.6.3: 存储到LanceDB
- [x] 使用multimodal_content表
- [x] 支持增量更新
- [x] 支持批量写入

### AC 6.6.4: 向量化速度≤1秒/内容
- [x] 单个内容向量化≤1秒
- [x] 支持批量向量化
- [x] 缓存已计算向量

## Tasks / Subtasks

- [x] Task 1: 创建MultimodalVectorizer类 (AC: 6.6.1, 6.6.2)
  - [x] 实现text_to_vector()方法
  - [x] 实现batch_vectorize()方法
  - [x] 支持多种嵌入模型

- [x] Task 2: 实现向量融合策略 (AC: 6.6.1)
  - [x] OCR文本向量权重: 0.4
  - [x] AI描述向量权重: 0.6
  - [x] 支持自定义权重

- [x] Task 3: LanceDB集成 (AC: 6.6.3)
  - [x] 实现store_vectors()方法
  - [x] 实现update_vectors()方法
  - [x] 批量写入优化

- [x] Task 4: 性能优化 (AC: 6.6.4)
  - [x] 实现向量缓存
  - [x] 异步批量处理
  - [x] 进度回调

## Dev Notes

### 技术栈

```yaml
嵌入模型:
  主模型: sentence-transformers/all-MiniLM-L6-v2 (768维)
  备选: text-embedding-3-small (OpenAI)

向量存储:
  LanceDB:
    表名: multimodal_content
    维度: 768
    索引: IVF_PQ

融合策略:
  加权平均: 0.4 * ocr_vector + 0.6 * description_vector
```

### 代码位置

```
创建文件:
- src/agentic_rag/processors/multimodal_vectorizer.py

修改文件:
- src/agentic_rag/clients/lancedb_client.py (添加multimodal方法)

测试文件:
- src/tests/test_multimodal_vectorizer.py
```

### 核心实现

```python
# src/agentic_rag/processors/multimodal_vectorizer.py
from sentence_transformers import SentenceTransformer
import numpy as np

class MultimodalVectorizer:
    """多模态内容向量化器"""

    def __init__(self, model_name: str = "all-MiniLM-L6-v2"):
        self.model = SentenceTransformer(model_name)
        self.cache = {}  # 向量缓存

    async def vectorize_content(
        self,
        content: dict,
        weights: dict = None
    ) -> np.ndarray:
        """向量化多模态内容"""
        weights = weights or {"ocr": 0.4, "description": 0.6}

        vectors = []
        total_weight = 0

        # OCR文本向量
        if content.get("ocr_text"):
            ocr_vec = self.model.encode(content["ocr_text"])
            vectors.append(ocr_vec * weights["ocr"])
            total_weight += weights["ocr"]

        # AI描述向量
        if content.get("description"):
            desc_vec = self.model.encode(content["description"])
            vectors.append(desc_vec * weights["description"])
            total_weight += weights["description"]

        # 加权融合
        if vectors:
            fused_vector = np.sum(vectors, axis=0) / total_weight
            return fused_vector.tolist()

        return None

    async def batch_vectorize(
        self,
        contents: list[dict],
        progress_callback: callable = None
    ) -> list[np.ndarray]:
        """批量向量化"""
        results = []
        for i, content in enumerate(contents):
            vec = await self.vectorize_content(content)
            results.append(vec)
            if progress_callback:
                progress_callback(i + 1, len(contents))
        return results
```

### LanceDB集成

```python
# 存储向量到LanceDB
async def store_multimodal_vector(
    self,
    content_id: str,
    vector: list[float],
    metadata: dict
) -> None:
    """存储多模态向量"""
    table = self.db.open_table("multimodal_content")
    table.add([{
        "id": content_id,
        "vector": vector,
        **metadata
    }])
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-30 | 1.0 | Initial Story Creation | SM Agent (Bob) |

## QA Results

### Review Date: 待开发

### Reviewed By: 待开发

### Test Results
待开发

---

**关联文档**:
- SCP-006-IMPLEMENTATION-PLAN.md
- Story 6.3 (存储架构)
- Story 6.4 (OCR描述)
