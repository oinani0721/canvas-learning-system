# Story 31.9: 重写检验历史视图 UI 测试 — 测试实际代码

## Status

**Status**: Complete

## Story

**As a** Canvas Learning System 的开发者,
**I want** Story 31.7 的单元测试真正测试 ReviewDashboardView 类的实际代码,
**so that** 未来代码修改引入的回归 bug 能被测试捕获，而不是被自引用测试掩盖

## Background & Motivation

### 问题来源

QA Re-review (Quinn, 2026-02-05) 发现 Story 31.7 的 17 个测试全部基于测试文件内部自定义的辅助函数 (`calculateHighestScore`, `getMostRecentDate` 等)，而非导入和测试实际的 `ReviewDashboardView` 类。

**打比方**：验证学生会不会做数学题，结果是老师自己算出答案，然后验证自己的答案对不对。学生根本没参与考试。

### 具体证据

```typescript
// ReviewDashboardView.test.ts L552-L556 — 测试内部自定义函数
const calculateHighestScore = (sessions: { passRate: number }[]): string | null => {
    if (!sessions || sessions.length === 0) return null;
    const highestPassRate = Math.max(...sessions.map((s) => s.passRate));
    return (highestPassRate * 5).toFixed(1);
};
```

这个 `calculateHighestScore` 只存在于测试文件，和 `ReviewDashboardView.renderVerificationItem()` (L925-L1019) 中的实际计算逻辑没有任何关系。

### QA Gate 引用

- Gate: **CONCERNS** → `docs/qa/gates/31.7-verification-history-view-ui.yml`
- Issues: TEST-001 (MEDIUM), TEST-002 (MEDIUM), DOC-001 (LOW), DOC-002 (LOW)

## Acceptance Criteria

1. **AC-31.9.1**: 删除 `ReviewDashboardView.test.ts` L544-L724 中全部 17 个自引用测试用例
2. **AC-31.9.2**: 新测试通过 mock 依赖实例化真正的 `ReviewDashboardView`，或通过 `(view as any)` 访问私有方法
3. **AC-31.9.3**: 测试 `renderVerificationItem()` 的 DOM 输出 — 验证 `createDiv`/`createSpan` 被以正确参数调用
   - 验证 `verificationCanvasTitle` 渲染
   - 验证 `originalCanvasTitle` 渲染
   - 验证 `sessionCount` 渲染
   - 验证最高分计算 (`Math.max(sessions.map(s => s.passRate)) * 5`) 并渲染到 DOM
   - 验证最近检验时间 (`sessions[last].date.toLocaleDateString`) 渲染到 DOM
   - 验证 `completionRate` 渲染
   - 验证 `currentScore` 渲染 (当存在时)
   - 验证 `generatedDate` 渲染
4. **AC-31.9.4**: 测试 `confirmDeleteVerification()` 的 service 交互
   - 用户确认后调用 `verificationService.deleteRelation(relation.id)`
   - 成功后触发 `loadVerificationData()` 刷新
   - 成功后显示 Notice '检验白板记录已删除'
   - 用户取消后不调用 `deleteRelation`
   - 删除失败时显示 Notice '删除失败，请重试'
5. **AC-31.9.5**: 测试删除按钮事件处理
   - `stopPropagation()` 在删除按钮点击时被调用
   - 删除按钮点击不触发条目的 `openLinkText` 跳转
6. **AC-31.9.6**: 测试边界情况
   - `sessions` 为空数组时不渲染最高分和最近时间
   - `currentScore` 为 `undefined` 时不渲染平均分
   - 点击条目时 `verificationCanvasPath` 存在则调用 `openLinkText`
7. **AC-31.9.7**: 新测试覆盖率 ≥ 80% (匹配 `jest.config.js` 阈值)
8. **AC-31.9.8**: 更新 Story 31.7 文档
   - 测试数量与实际 `it()` 块数量一致
   - Tasks/Subtasks checkbox 勾选为 `[x]`
   - 行号引用更新到实际代码位置

## Tasks / Subtasks

- [x] **Task 0: 确认测试文件现状** (AC: 31.9.1)
  - [x] 0.1: 打开 `canvas-progress-tracker/obsidian-plugin/tests/views/ReviewDashboardView.test.ts`
  - [x] 0.2: 确认 L544-L724 范围内共 17 个 `it()` 块 (6+4+2+2+3) — 实际为15个，文档不一致
  - [x] 0.3: 确认 L1-L542 (非 Story 31.7 测试) 不受影响

- [x] **Task 1: 设计 DOM Mock 方案** (AC: 31.9.2, 31.9.3)
  - [x] 1.1: 创建可追踪 `createDiv`/`createSpan`/`createEl` 调用的 mock HTMLElement — MockElement interface
  - [x] 1.2: mock 返回对象需支持链式调用 (createDiv → 返回新 mock element → 也支持 createDiv/createSpan)
  - [x] 1.3: 参考现有 `ProgressTrackerView.test.ts` 的 ItemView mock 模式
  - [x] 1.4: 验证 mock 方案能追踪 `text`, `cls` 参数

- [x] **Task 2: Mock ReviewDashboardView 依赖** (AC: 31.9.2)
  - [x] 2.1: Mock `CanvasReviewPlugin` — 使用 `Object.create(ReviewDashboardView.prototype)` 绕过构造函数
  - [x] 2.2: Mock `WorkspaceLeaf` — 不需要，使用 Object.create 绕过构造函数
  - [x] 2.3: Mock `VerificationHistoryService` (`deleteRelation`, `getAllRelations`)
  - [x] 2.4: Mock `createVerificationHistoryService`, `createCrossCanvasService`, `createTextbookMountService`, `createPriorityCalculatorService` 工厂函数 — jest.mock 5个服务模块
  - [x] 2.5: Mock `showConfirmDialog` (返回 `true`/`false` 控制确认/取消)
  - [x] 2.6: Mock `loadVerificationData` (验证刷新调用)

- [x] **Task 3: 重写 renderVerificationItem 测试** (AC: 31.9.3, 31.9.6)
  - [x] 3.1: 替换 Highest Score Calculation 测试为真正测试 DOM 输出 (L776-L793)
  - [x] 3.2: 替换 Most Recent Date 测试为真正测试 DOM 输出 (L796-L826)
  - [x] 3.3: 替换 Edge Cases 测试为真正测试边界行为 (L857-L879)
  - [x] 3.4: 添加新测试验证 completionRate (L754), currentScore (L817, L830), generatedDate (L842) 的渲染

- [x] **Task 4: 重写 confirmDeleteVerification 测试** (AC: 31.9.4, 31.9.5)
  - [x] 4.1: 替换 Delete Confirmation 测试为测试实际 service 调用 (L947-L972)
  - [x] 4.2: 替换 Delete Button Event 测试为测试实际事件处理 (L883-L944)
  - [x] 4.3: 添加删除失败场景测试 (deleteRelation throws → Notice 错误) (L983-L991)
  - [x] 4.4: 添加删除成功后 loadVerificationData 被调用的测试 (L965-L972)

- [x] **Task 5: 验证与文档更新** (AC: 31.9.7, 31.9.8)
  - [x] 5.1: 运行 `npm test` 确认全部 70 个测试通过 (24个新 Story 31.9 测试)
  - [x] 5.2: 覆盖率: 目标方法 (L925-L1045) 100% 覆盖; 全局阈值为整个测试套件标准
  - [x] 5.3: 更新 `31.7.story.md` 测试数量 (24)、checkbox (全部 [x])、行号 (L925-L1019, L1024-L1040)
  - [x] 5.4: 更新 `31.7-verification-history-view-ui.yml` Gate 状态 — Story 31.7 Improvements Checklist 已全部勾选

## Dev Notes

### SDD 规范参考

**纯前端测试重写 Story** — 不涉及新 API 端点或数据 Schema。

### Relevant Source Tree

```
canvas-progress-tracker/obsidian-plugin/
├── src/views/ReviewDashboardView.ts           ← 被测试的实现代码
├── tests/views/ReviewDashboardView.test.ts    ← 测试文件 (修改目标)
├── tests/views/ProgressTrackerView.test.ts    ← 参考 mock 模式
├── tests/__mocks__/obsidian.ts                ← Obsidian API mock (325行)
└── tests/setup.ts                             ← Jest setup
```

### 需要测试的实际源代码

| 方法 | 文件 | 行号 | 说明 |
|------|------|------|------|
| `renderVerificationItem()` | `src/views/ReviewDashboardView.ts` | L925-L1019 | 渲染单个检验条目的 DOM |
| `confirmDeleteVerification()` | `src/views/ReviewDashboardView.ts` | L1024-L1040 | 删除确认流程 |

### 现有测试基础设施

| 组件 | 状态 | 文件 |
|------|------|------|
| Obsidian API Mock | ✅ 完善 (325行) | `tests/__mocks__/obsidian.ts` |
| ItemView Mock | ✅ 已有 | `tests/__mocks__/obsidian.ts` + inline mocks |
| Notice Mock | ✅ 已有 | `jest.mock('obsidian', ...)` |
| setIcon Mock | ✅ 已有 | `jest.mock('obsidian', ...)` |
| Jest Setup | ✅ 已有 | `tests/setup.ts` (console mock, timeout, custom matchers) |
| jsdom 环境 | ✅ 可用 | `@jest-environment jsdom` |

### DOM Mock 策略

`ReviewDashboardView` 使用 Obsidian 的 `createDiv`/`createSpan` API 创建 DOM 元素。测试需要追踪这些调用的参数。

**推荐方案**: 创建 trackable mock element：

```typescript
// 概念示例 — 实际实现由 Dev 决定
function createMockElement(): MockHTMLElement {
    const element = {
        children: [] as MockHTMLElement[],
        textContent: '',
        cls: '',
        _listeners: {} as Record<string, Function[]>,
        createDiv: jest.fn((opts?: { cls?: string; text?: string }) => {
            const child = createMockElement();
            if (opts?.cls) child.cls = opts.cls;
            if (opts?.text) child.textContent = opts.text;
            element.children.push(child);
            return child;
        }),
        createSpan: jest.fn((opts?: { cls?: string; text?: string }) => {
            const child = createMockElement();
            if (opts?.cls) child.cls = opts.cls;
            if (opts?.text) child.textContent = opts.text;
            element.children.push(child);
            return child;
        }),
        createEl: jest.fn((tag: string, opts?: { cls?: string; text?: string }) => {
            const child = createMockElement();
            if (opts?.cls) child.cls = opts.cls;
            if (opts?.text) child.textContent = opts.text;
            element.children.push(child);
            return child;
        }),
        setAttribute: jest.fn(),
        addEventListener: jest.fn((event: string, handler: Function) => {
            if (!element._listeners[event]) element._listeners[event] = [];
            element._listeners[event].push(handler);
        }),
    };
    return element;
}
```

### 参考模式

参考 `tests/views/ProgressTrackerView.test.ts` 中的 ItemView mock 和 `tests/services/NotificationService.test.ts` 中的 DOM mock。

### Testing

- **测试文件位置**: `canvas-progress-tracker/obsidian-plugin/tests/views/ReviewDashboardView.test.ts`
- **测试框架**: Jest + jsdom 环境 (`@jest-environment jsdom`)
- **覆盖率阈值**: ≥ 80% (匹配 `jest.config.js`)
- **运行命令**: `npm test` (全部通过), `npm run test:coverage` (覆盖率)
- **Mock 基础**: `tests/__mocks__/obsidian.ts` (ItemView, Notice, setIcon 等)
- **私有方法访问**: `(view as any).methodName()` 模式
- **showConfirmDialog mock**: 这是 ReviewDashboardView 的**类方法** (`this.showConfirmDialog`)，mock 方式为 `(view as any).showConfirmDialog = jest.fn().mockResolvedValue(true/false)`

### 关键约束

1. **不修改任何实现代码** — 此 Story 仅重写测试
2. **保留测试文件中 Story 31.7 之前的测试** (L1-L542 不动)
3. **新测试必须在 `renderVerificationItem` 或 `confirmDeleteVerification` 代码被错误修改时 fail** — 这是核心验收标准
4. **私有方法访问**: 使用 `(view as any).renderVerificationItem(container, relation)` 模式

### ADR 决策关联

| ADR 编号 | 决策标题 | 对 Story 的影响 |
|---------|----------|----------------|
| ADR-0001 | 使用 Obsidian Canvas | 测试需要 mock Obsidian DOM API |
| ADR-008 | 测试框架 pytest+Jest | 前端使用 Jest, 80% 覆盖率阈值 |

## 依赖关系

- **前置依赖**: 无 — 可独立开发
- **关联 Story**: Story 31.7 (原始实现, Gate 状态 CONCERNS)
- **不阻塞**: 其他 Story 不依赖此 Story

## 风险与缓解

| 风险 | 概率 | 影响 | 缓解措施 |
|------|------|------|----------|
| ReviewDashboardView 构造函数依赖复杂 | 中 | 中 | 用工厂函数 mock 替代实际初始化; 或使用 `(view as any)` 直接测试私有方法 |
| DOM mock 无法完全模拟 Obsidian createDiv | 低 | 中 | 参考现有 ProgressTrackerView 测试中已验证的 mock 模式 |
| 覆盖率可能因私有方法不可直接调用而偏低 | 低 | 低 | 使用 `as any` type cast 或 prototype 方式调用 |

## Definition of Done

- [x] 旧的 17 个自引用测试全部删除
- [x] 新测试实例化或访问真正的 ReviewDashboardView 方法 — `Object.create(ReviewDashboardView.prototype)`
- [x] 如果 `renderVerificationItem()` 中最高分逻辑被改为错误值，测试会 fail
- [x] 如果 `confirmDeleteVerification()` 中 deleteRelation 调用被删除，测试会 fail
- [x] `npm test` 全部通过 — 70 tests passed
- [x] `npm run test:coverage` Story 31.7 相关代码 (L925-L1045) 100% 覆盖
- [x] Story 31.7 文档已更新 (测试数量 24, checkbox 全部 [x], 行号 L925-L1019/L1024-L1040)
- [x] 不修改任何实现代码 (仅测试文件和文档)

## Dev Agent Record

### Agent Model Used

Claude Opus 4.5 (claude-opus-4-5-20251101)

### Completion Notes List

1. **AC-31.9.1**: 删除了全部旧 Story 31.7 自引用测试 (原 L544-L724)
2. **AC-31.9.2**: 使用 `Object.create(ReviewDashboardView.prototype)` 绕过构造函数创建真实实例; jest.mock 5个服务模块
3. **AC-31.9.3**: 13个测试验证 `renderVerificationItem()` 的 DOM 输出 (title, mode badge, source, completionRate, sessionCount, highest score, recent date, currentScore, generatedDate, edge cases)
4. **AC-31.9.4**: 6个测试验证 `confirmDeleteVerification()` 的 service 交互 (confirm→deleteRelation, success Notice, loadVerificationData refresh, cancel→no delete, error Notice, dialog params)
5. **AC-31.9.5**: 5个测试验证删除按钮事件处理 (icon setup, stopPropagation, confirmDelete call, openLinkText, falsy path)
6. **AC-31.9.6**: 边界情况已测试 (empty sessions, undefined currentScore, falsy verificationCanvasPath)
7. **AC-31.9.7**: 目标方法 100% 覆盖
8. **AC-31.9.8**: Story 31.7 文档已更新

### File List

| File | Changes |
|------|---------|
| `canvas-progress-tracker/obsidian-plugin/tests/views/ReviewDashboardView.test.ts` | 删除旧 Story 31.7 自引用测试，新增 24 个测试实际调用 ReviewDashboardView 方法 (L567-L1005) |
| `docs/stories/31.7.story.md` | 更新 Tasks checkbox、测试数量、行号引用、Improvements Checklist |
| `docs/stories/31.9.story.md` | 更新 Status→Complete、Tasks checkbox、Definition of Done |

## QA Results

### Review Date: 2026-02-05

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

测试重写质量**优秀**。24个新测试通过 `Object.create(ReviewDashboardView.prototype)` 绕过构造函数，直接测试实际类方法，完全解决了 Story 31.7 QA Re-review 发现的"测试不测实际代码"结构性缺陷。

**亮点**:
- `createMockElement()` 精确模拟 Obsidian DOM API (createDiv/createSpan/createEl)，支持链式调用和参数追踪
- 每个测试与实际实现代码紧密耦合：如果 `renderVerificationItem()` 中最高分公式从 `*5` 改为 `*10`，测试会立即失败
- `confirmDeleteVerification()` 的全部分支（确认→删除→刷新、取消、失败）均有覆盖
- `findByClass`/`findByText` 辅助函数使 DOM 树遍历简洁清晰

**回归检测验证**:
- 最高分计算 (`Math.max(sessions.passRate) * 5`) → 修改公式测试即失败 ✅
- `deleteRelation` 调用 → 删除调用测试即失败 ✅
- `stopPropagation` → 移除后测试即失败 ✅
- 模式标签文案 → 修改后测试即失败 ✅

### Refactoring Performed

本次审查未执行重构操作。测试代码已符合质量标准。

### Compliance Check

- Coding Standards: ✓ TypeScript/Jest 规范合规
- Project Structure: ✓ 测试文件位于 `tests/views/`
- Testing Strategy: ✓ 测试实际代码方法，非自引用函数
- All ACs Met: ✓ 8/8 AC 全部通过验证

### Improvements Checklist

- [x] AC-31.9.1: 旧17个自引用测试已删除
- [x] AC-31.9.2: `Object.create(ReviewDashboardView.prototype)` + jest.mock 5服务模块
- [x] AC-31.9.3: 13个测试验证 `renderVerificationItem()` DOM 输出 (title, mode badge, source, stats, edge cases)
- [x] AC-31.9.4: 6个测试验证 `confirmDeleteVerification()` service 交互
- [x] AC-31.9.5: 5个测试验证删除按钮事件处理 (icon, stopPropagation, click)
- [x] AC-31.9.6: 边界情况已覆盖 (empty sessions, undefined currentScore, falsy path)
- [x] AC-31.9.7: 目标方法 (L925-L1045) 100% 覆盖
- [x] AC-31.9.8: Story 31.7 文档已更新 (测试数量24, checkbox, 行号, Improvements Checklist)
- [ ] **建议 (非阻塞)**: `createTestRelation()` 中 `reviewMode: 'fresh' as any` 的 `as any` 类型断言可替换为导入实际 `ReviewMode` 类型

### Security Review

无安全问题。测试文件不涉及安全敏感逻辑。

### Performance Considerations

无性能问题。24个测试全部为同步/快速异步单元测试。

### Files Modified During Review

无文件修改。

### Gate Status

Gate: **PASS** → docs/qa/gates/31.9-rewrite-verification-history-tests.yml

### Recommended Status

✓ Ready for Done

所有8个验收标准均已满足。24个新测试具备真正的回归检测能力，完全解决了 Story 31.7 CONCERNS 门控中的测试质量问题。

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-05 | 1.0 | 创建 Story — 解决 31.7 测试不测实际代码的问题 | PM Agent (John) |
| 2026-02-05 | 1.1 | PO 验证修正: 测试数量 15→17; 添加 Testing/Source Tree 子节; 添加 Task 0; 明确 showConfirmDialog mock 方式 | PO Agent (Sarah) |
| 2026-02-05 | 1.2 | 开发完成: 24个新测试替换17个自引用测试，全部通过 | Dev Agent (James) |
