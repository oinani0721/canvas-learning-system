# Story 15.2: è·¯ç”±ç³»ç»Ÿå’ŒAPIRouteré…ç½®

## Status
Draft

## Story
**As a** Canvas Learning Systemå¼€å‘è€…,
**I want** å®ç°æ¨¡å—åŒ–çš„è·¯ç”±ç³»ç»Ÿå’ŒAPIRouteré…ç½®,
**so that** APIç«¯ç‚¹å¯ä»¥æŒ‰åŠŸèƒ½åŸŸç»„ç»‡ï¼Œä¾¿äºç»´æŠ¤å’Œæ‰©å±•ï¼Œå¹¶æ”¯æŒAPIç‰ˆæœ¬æ§åˆ¶ã€‚

## Acceptance Criteria

1. âœ… åˆ›å»º3ä¸ªAPIRouteræ¨¡å—ï¼šcanvas.py, agents.py, review.py
2. âœ… æ‰€æœ‰è·¯ç”±å™¨ä½¿ç”¨ç»Ÿä¸€çš„å‰ç¼€æ¨¡å¼ `/api/v1/{domain}`
3. âœ… æ¯ä¸ªè·¯ç”±å™¨é…ç½®é€‚å½“çš„tagsç”¨äºOpenAPIæ–‡æ¡£åˆ†ç»„
4. âœ… ä¸»åº”ç”¨æ­£ç¡®includeæ‰€æœ‰å­è·¯ç”±å™¨
5. âœ… è·¯ç”±å™¨æ”¯æŒå…±äº«dependenciesæ³¨å…¥
6. âœ… å¥åº·æ£€æŸ¥ç«¯ç‚¹ `GET /api/v1/health` å¯æ­£å¸¸è®¿é—®
7. âœ… Swaggeræ–‡æ¡£ `/docs` æ­£ç¡®æ˜¾ç¤ºæ‰€æœ‰ç«¯ç‚¹åˆ†ç»„
8. âœ… æ‰€æœ‰è·¯ç”±å®šä¹‰åŒ…å«é€‚å½“çš„response_modelå£°æ˜

## Tasks / Subtasks

- [ ] **Task 1: åˆ›å»ºè·¯ç”±å™¨ç›®å½•ç»“æ„** (AC: 1)
  - [ ] 1.1 åˆ›å»º `backend/app/api/v1/endpoints/` ç›®å½•
  - [ ] 1.2 åˆ›å»º `__init__.py` æ–‡ä»¶å¯¼å‡ºæ‰€æœ‰è·¯ç”±å™¨
  - [ ] 1.3 åˆ›å»ºç©ºçš„ `canvas.py`, `agents.py`, `review.py` æ–‡ä»¶

- [ ] **Task 2: å®ç°Canvasè·¯ç”±å™¨** (AC: 1, 2, 3, 8)
  - [ ] 2.1 åˆ›å»º `canvas_router = APIRouter(prefix="/canvas", tags=["Canvasæ“ä½œ"])`
  - [ ] 2.2 å®šä¹‰6ä¸ªCanvasç«¯ç‚¹çš„è·¯ç”±è£…é¥°å™¨ï¼ˆæš‚æ—¶è¿”å›å ä½å“åº”ï¼‰
  - [ ] 2.3 æ·»åŠ response_modelå£°æ˜

- [ ] **Task 3: å®ç°Agentè·¯ç”±å™¨** (AC: 1, 2, 3, 8)
  - [ ] 3.1 åˆ›å»º `agents_router = APIRouter(prefix="/agents", tags=["Agentè°ƒç”¨"])`
  - [ ] 3.2 å®šä¹‰9ä¸ªAgentç«¯ç‚¹çš„è·¯ç”±è£…é¥°å™¨
  - [ ] 3.3 æ·»åŠ response_modelå£°æ˜

- [ ] **Task 4: å®ç°Reviewè·¯ç”±å™¨** (AC: 1, 2, 3, 8)
  - [ ] 4.1 åˆ›å»º `review_router = APIRouter(prefix="/review", tags=["æ£€éªŒç™½æ¿"])`
  - [ ] 4.2 å®šä¹‰3ä¸ªReviewç«¯ç‚¹çš„è·¯ç”±è£…é¥°å™¨
  - [ ] 4.3 æ·»åŠ response_modelå£°æ˜

- [ ] **Task 5: å®ç°å¥åº·æ£€æŸ¥ç«¯ç‚¹** (AC: 6)
  - [ ] 5.1 åœ¨ `main.py` æˆ–å•ç‹¬è·¯ç”±å™¨ä¸­æ·»åŠ  `GET /api/v1/health`
  - [ ] 5.2 è¿”å› `HealthCheckResponse` æ¨¡å‹

- [ ] **Task 6: ä¸»åº”ç”¨è·¯ç”±å™¨é›†æˆ** (AC: 4, 5, 7)
  - [ ] 6.1 åœ¨ `main.py` ä¸­å¯¼å…¥æ‰€æœ‰è·¯ç”±å™¨
  - [ ] 6.2 ä½¿ç”¨ `app.include_router()` é›†æˆæ‰€æœ‰è·¯ç”±å™¨
  - [ ] 6.3 é…ç½®å…¨å±€ `/api/v1` å‰ç¼€
  - [ ] 6.4 éªŒè¯Swaggeræ–‡æ¡£æ˜¾ç¤ºæ­£ç¡®

- [ ] **Task 7: å•å…ƒæµ‹è¯•** (AC: 1-8)
  - [ ] 7.1 æµ‹è¯•æ¯ä¸ªè·¯ç”±å™¨çš„ç«¯ç‚¹å¯è®¿é—®æ€§
  - [ ] 7.2 æµ‹è¯•å¥åº·æ£€æŸ¥ç«¯ç‚¹è¿”å›æ­£ç¡®çŠ¶æ€
  - [ ] 7.3 æµ‹è¯•OpenAPI schemaç”Ÿæˆæ­£ç¡®

## Dev Notes

### ğŸ“‹ æŠ€æœ¯éªŒè¯æŠ¥å‘Š (Step 3.6)

**éªŒè¯å®Œæˆæ—¶é—´**: 2025-11-24
**éªŒè¯æ‰§è¡Œäºº**: SM Agent
**Quality GateçŠ¶æ€**: âœ… PASSED

#### æŠ€æœ¯æ ˆæ¸…å•

| æŠ€æœ¯æ ˆ | æŸ¥è¯¢æ–¹å¼ | éªŒè¯çŠ¶æ€ | æ–‡æ¡£ä½ç½® |
|--------|---------|---------|----------|
| FastAPI APIRouter | Context7 | âœ… å·²éªŒè¯ | /websites/fastapi_tiangolo |
| FastAPI include_router | Context7 | âœ… å·²éªŒè¯ | /websites/fastapi_tiangolo |

#### æ ¸å¿ƒAPIéªŒè¯ç»“æœ

**FastAPI APIRouter APIs**:
- âœ… `APIRouter(prefix, tags, dependencies, responses)` â†’ Verified from Context7
  - å‚æ•°: `prefix` (str), `tags` (List[str]), `dependencies` (List[Depends]), `responses` (Dict)
  - ç”¨é€”: åˆ›å»ºæ¨¡å—åŒ–è·¯ç”±å™¨

- âœ… `APIRouter.include_router()` â†’ Verified from Context7
  - å‚æ•°: `router` (APIRouter), `prefix` (str), `tags` (List[str]), `dependencies` (List[Depends])
  - ç”¨é€”: å°†å­è·¯ç”±å™¨é›†æˆåˆ°ä¸»åº”ç”¨æˆ–çˆ¶è·¯ç”±å™¨

- âœ… `app.include_router()` â†’ Verified from Context7
  - å‚æ•°: åŒä¸Š
  - ç”¨é€”: å°†è·¯ç”±å™¨é›†æˆåˆ°FastAPIåº”ç”¨

#### ä»£ç ç¤ºä¾‹åº“

**ç¤ºä¾‹1: åˆ›å»ºå¸¦é…ç½®çš„APIRouter**
```python
# âœ… Verified from Context7:/websites/fastapi_tiangolo (topic: APIRouter)
from fastapi import APIRouter, Depends, HTTPException

router = APIRouter(
    prefix="/items",
    tags=["items"],
    dependencies=[Depends(get_token_header)],
    responses={404: {"description": "Not found"}},
)

@router.get("/")
async def read_items():
    return fake_items_db

@router.get("/{item_id}")
async def read_item(item_id: str):
    if item_id not in fake_items_db:
        raise HTTPException(status_code=404, detail="Item not found")
    return {"name": fake_items_db[item_id]["name"], "item_id": item_id}
```

**ç¤ºä¾‹2: ä¸»åº”ç”¨é›†æˆè·¯ç”±å™¨**
```python
# âœ… Verified from Context7:/websites/fastapi_tiangolo (topic: include_router)
from fastapi import FastAPI, Depends
from .routers import users_router, admin_router

app = FastAPI()

# åŸºç¡€é›†æˆ
app.include_router(users_router, prefix="/users", tags=["users"])

# å¸¦ä¾èµ–çš„é›†æˆ
app.include_router(
    admin_router,
    prefix="/admin",
    tags=["admin"],
    dependencies=[Depends(get_token_header)],
)
```

**ç¤ºä¾‹3: åµŒå¥—è·¯ç”±å™¨**
```python
# âœ… Verified from Context7:/websites/fastapi_tiangolo
from fastapi import APIRouter, FastAPI

app = FastAPI()
internal_router = APIRouter()
users_router = APIRouter()

@users_router.get("/users/")
def read_users():
    return [{"name": "Rick"}, {"name": "Morty"}]

internal_router.include_router(users_router, prefix="/users", tags=["Users Management"])
app.include_router(internal_router)
```

---

### SDDè§„èŒƒå‚è€ƒ (å¿…å¡«)

**å®Œæ•´APIè§„èŒƒ**:
- [Source: specs/api/fastapi-backend-api.openapi.yml]
- åŒ…å«å…¨éƒ¨19ä¸ªç«¯ç‚¹çš„è·¯å¾„ã€å‚æ•°ã€è¯·æ±‚ä½“ã€å“åº”å®šä¹‰

**Canvasç«¯ç‚¹** (6ä¸ª):
- [Source: specs/api/fastapi-backend-api.openapi.yml#/paths/~1api~1v1~1canvas~1{canvas_name}]
- ç›¸å…³Schema: NodeCreate, NodeUpdate, NodeRead, EdgeCreate, EdgeRead

**Agentç«¯ç‚¹** (9ä¸ª):
- [Source: specs/api/fastapi-backend-api.openapi.yml#/paths/~1api~1v1~1agents~1decompose~1basic]
- ç›¸å…³Schema:
  - [Source: specs/data/decompose-request.schema.json]
  - [Source: specs/data/decompose-response.schema.json]
  - [Source: specs/data/node-score.schema.json]

**Reviewç«¯ç‚¹** (3ä¸ª):
- [Source: specs/api/fastapi-backend-api.openapi.yml#/paths/~1api~1v1~1review~1schedule]
- ç›¸å…³Schema:
  - [Source: specs/data/review-item.schema.json]

### æŠ€æœ¯çº¦æŸ (æ¶æ„æ–‡æ¡£å¼•ç”¨)

**æ¶æ„è®¾è®¡å‚è€ƒ**:
- 4å±‚æ¶æ„è®¾è®¡: [Source: docs/architecture/EPIC-11-BACKEND-ARCHITECTURE.md#æ•´ä½“æ¶æ„]
- APIè·¯ç”±è®¾è®¡: [Source: docs/architecture/EPIC-11-BACKEND-ARCHITECTURE.md#APIè·¯ç”±è®¾è®¡]
- æ•°æ®æ¨¡å‹å®šä¹‰: [Source: docs/architecture/EPIC-11-DATA-MODELS.md]

---

### ADRå†³ç­–å…³è” (å¿…å¡«)

| ADRç¼–å· | å†³ç­–æ ‡é¢˜ | å¯¹Storyçš„å½±å“ |
|---------|----------|---------------|
| ADR-008 | Testing Framework - pytest | è·¯ç”±å™¨æµ‹è¯•ä½¿ç”¨pytest + TestClient |
| ADR-009 | Error Handling & Retry Strategy | APIç«¯ç‚¹é”™è¯¯å“åº”éµå¾ªç»Ÿä¸€æ ¼å¼ |
| ADR-010 | Logging Aggregation - structlog | è¯·æ±‚æ—¥å¿—ä½¿ç”¨ç»“æ„åŒ–JSONæ ¼å¼ |

**âš ï¸ æ³¨æ„**: ä»¥ä¸‹æ¶æ„å†³ç­–è®°å½•åœ¨æ¶æ„æ–‡æ¡£ä¸­ï¼Œä½†æ— ç‹¬ç«‹ADR:
- FastAPIæ¡†æ¶é€‰å‹ â†’ `docs/architecture/EPIC-11-BACKEND-ARCHITECTURE.md`
- APIç‰ˆæœ¬æ§åˆ¶ç­–ç•¥ (`/api/v1/`) â†’ `docs/architecture/EPIC-11-BACKEND-ARCHITECTURE.md#APIè·¯ç”±è®¾è®¡`
- 4å±‚æ¶æ„è®¾è®¡ â†’ `docs/architecture/EPIC-11-BACKEND-ARCHITECTURE.md#æ•´ä½“æ¶æ„`

**å…³é”®çº¦æŸ**:
- çº¦æŸ1: è·¯ç”±å™¨åªè´Ÿè´£HTTPè¯·æ±‚å¤„ç†å’Œå‚æ•°éªŒè¯ï¼Œä¸åŒ…å«ä¸šåŠ¡é€»è¾‘
- çº¦æŸ2: æ‰€æœ‰ç«¯ç‚¹å¿…é¡»å£°æ˜response_modelç”¨äºOpenAPIæ–‡æ¡£ç”Ÿæˆ
- çº¦æŸ3: ä½¿ç”¨ä¾èµ–æ³¨å…¥è·å–Serviceå®ä¾‹ï¼Œä¸ç›´æ¥å®ä¾‹åŒ–

[Source: docs/architecture/EPIC-11-BACKEND-ARCHITECTURE.md]

---

### é¡¹ç›®ç»“æ„å‚è€ƒ

```
backend/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ main.py                      # FastAPIåº”ç”¨å…¥å£ï¼Œincludeæ‰€æœ‰è·¯ç”±å™¨
â”‚   â”œâ”€â”€ api/
â”‚   â”‚   â””â”€â”€ v1/
â”‚   â”‚       â”œâ”€â”€ __init__.py          # å¯¼å‡ºv1_router
â”‚   â”‚       â””â”€â”€ endpoints/
â”‚   â”‚           â”œâ”€â”€ __init__.py      # å¯¼å‡ºæ‰€æœ‰å­è·¯ç”±å™¨
â”‚   â”‚           â”œâ”€â”€ canvas.py        # Canvasæ“ä½œè·¯ç”±å™¨
â”‚   â”‚           â”œâ”€â”€ agents.py        # Agentè°ƒç”¨è·¯ç”±å™¨
â”‚   â”‚           â””â”€â”€ review.py        # æ£€éªŒç™½æ¿è·¯ç”±å™¨
â”‚   â””â”€â”€ models/                      # Pydanticæ¨¡å‹ï¼ˆStory 15.1å·²åˆ›å»ºåŸºç¡€ï¼‰
â””â”€â”€ tests/
    â””â”€â”€ test_routers.py              # è·¯ç”±å™¨æµ‹è¯•
```

[Source: docs/architecture/EPIC-11-BACKEND-ARCHITECTURE.md]

---

### Testing

**æµ‹è¯•æ–‡ä»¶ä½ç½®**: `backend/tests/test_routers.py`

**æµ‹è¯•æ¡†æ¶**: pytest + pytest-asyncio + httpx

**æµ‹è¯•æ ‡å‡†**:
- æ¯ä¸ªè·¯ç”±å™¨è‡³å°‘3ä¸ªæµ‹è¯•ç”¨ä¾‹
- æµ‹è¯•ç«¯ç‚¹å¯è®¿é—®æ€§ï¼ˆçŠ¶æ€ç 200/201ï¼‰
- æµ‹è¯•é”™è¯¯å“åº”ï¼ˆ404/400ï¼‰
- æµ‹è¯•OpenAPI schemaç”Ÿæˆ

**æµ‹è¯•ç¤ºä¾‹**:
```python
# âœ… Verified from Context7:/websites/fastapi_tiangolo (topic: testing)
from fastapi.testclient import TestClient
from app.main import app

client = TestClient(app)

def test_health_check():
    response = client.get("/api/v1/health")
    assert response.status_code == 200
    assert response.json()["status"] == "healthy"

def test_canvas_router_included():
    response = client.get("/api/v1/canvas/test")
    # å³ä½¿è¿”å›404ï¼Œä¹Ÿè¯´æ˜è·¯ç”±å™¨å·²æ­£ç¡®æ³¨å†Œ
    assert response.status_code in [200, 404]
```

---

### æŠ€æœ¯çº¦æŸå’Œæ³¨æ„äº‹é¡¹

**ç‰ˆæœ¬çº¦æŸ**:
- FastAPI: â‰¥0.104.0
- Pydantic: â‰¥2.5.0

**æ€§èƒ½è€ƒè™‘**:
- è·¯ç”±å™¨æ³¨å†Œåœ¨åº”ç”¨å¯åŠ¨æ—¶å®Œæˆï¼Œä¸å½±å“è¯·æ±‚å¤„ç†æ€§èƒ½
- ä½¿ç”¨tagså¯ä»¥åœ¨Swaggeræ–‡æ¡£ä¸­æ›´å¥½åœ°ç»„ç»‡ç«¯ç‚¹

**å®‰å…¨è€ƒè™‘**:
- æœ¬Storyæš‚ä¸å®ç°è®¤è¯ï¼Œä½†è·¯ç”±å™¨ç»“æ„æ”¯æŒåç»­æ·»åŠ dependenciesè¿›è¡Œè®¤è¯

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-24 | 1.0 | åˆå§‹åˆ›å»º | SM Agent |

---

## Dev Agent Record

### Agent Model Used
(å¾…Dev Agentå¡«å†™)

### Debug Log References
(å¾…Dev Agentå¡«å†™)

### Completion Notes List
(å¾…Dev Agentå¡«å†™)

### File List
(å¾…Dev Agentå¡«å†™)

---

## QA Results
(å¾…QA Agentå¡«å†™)
