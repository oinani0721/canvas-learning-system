# Story 12.8: 混合Reranking策略

## Status: Approved

## Epic Context & Background

**所属Epic**: EPIC-12 - 三层记忆系统 + Agentic RAG
**Epic文档**: [EPIC-12-STORY-MAP.md](../epics/EPIC-12-STORY-MAP.md)

**本Story在Epic中的定位**:
- Phase 2 (检索融合层) 的关键Story
- 实现Local Cross-Encoder和Cohere API混合Reranking
- **依赖**: Story 12.6 (并行检索完成), Story 12.7 (融合结果可用)
- **被依赖**: Story 12.9, 12.10 (质量控制和Canvas集成依赖Reranking结果)

**Epic核心问题回顾**:

### Problem 13: 融合结果缺乏精排序
- **现象**: RRF/Weighted融合后的结果排序不够精准
- **根因**: Bi-Encoder无法深度理解query-document交互
- **修复**: 使用Cross-Encoder进行第二阶段Reranking
- **本Story验证**: 验证Reranking提升MRR@10 ≥ +0.08

### Problem 14: Reranking成本与质量权衡
- **现象**: Cohere API高质量但有成本，Local免费但精度略低
- **根因**: 无法一刀切选择单一方案
- **修复**: 混合策略 - Local为主，Cohere精调关键场景
- **本Story验证**: 验证hybrid_auto正确选择策略

---

## Story

**As a** Agentic RAG系统,
**I want** 实现Local Cross-Encoder和Cohere API的混合Reranking,
**so that** 在保证质量的同时，最小化API成本

---

## Acceptance Criteria

### AC 1: Local Reranker (bge-reranker-base)正确rerank (验证Problem 13基础)
- **模型**: `BAAI/bge-reranker-base` (中文优化, 102M参数)
- **输入**: query + 10个候选文档
- **输出**: 10个文档，按rerank_score降序排列
- **验证方式**:
  - rerank_score ∈ [0, 1]
  - Top-1 score最高
  - GPU延迟 < 100ms (100 docs)
- **架构来源**: `docs/architecture/RERANKING-STRATEGY-SELECTION.md` Section 3

### AC 2: Cohere Reranker调用成功 (验证Problem 13扩展)
- **API**: `cohere.rerank(model="rerank-multilingual-v3.0")`
- **输入**: query + 10个候选文档
- **输出**: Top-10结果，relevance_score降序
- **验证方式**:
  - API调用成功率 ≥ 99%
  - 中文query正常处理
  - relevance_score ∈ [0, 1]
- **架构来源**: `docs/architecture/RERANKING-STRATEGY-SELECTION.md` Section 2

### AC 3: hybrid_auto正确选择 (验证Problem 14)
- **决策逻辑**:
  - 检验白板生成 (`is_review_canvas=True`) → Cohere
  - 日常检索 (`is_review_canvas=False`) → Local
- **验证方式**: `state.get("is_review_canvas")` flag正确传递
- **架构来源**: `docs/architecture/RERANKING-STRATEGY-SELECTION.md` Section 4

### AC 4: 成本监控 (验证Problem 14)
- **Cohere调用计数**: 使用LangSmith或自定义统计
- **月度限额**: < 50 requests (可配置)
- **告警**: 接近限额时输出warning log
- **验证方式**: 超过80%限额时触发告警

### AC 5: Reranking质量提升 (验证Problem 13核心指标)
- **评估数据集**: 50个测试query + 人工标注相关文档
- **基线**: 融合后无Rerank MRR@10
- **Local Reranker目标**: MRR@10提升 ≥ +0.08
- **Cohere Reranker目标**: MRR@10提升 ≥ +0.12
- **Epic关联**: 确保Reranking提升检索质量

---

## Tasks / Subtasks

### 任务1: 创建Reranking模块结构 (AC: 1, 2, 3, 4)
- [ ] 1.1: 创建目录 `src/agentic_rag/reranking/`
- [ ] 1.2: 创建文件结构:
  ```
  src/agentic_rag/reranking/
  ├── __init__.py
  ├── local_reranker.py      # Local Cross-Encoder
  ├── cohere_reranker.py     # Cohere API
  ├── hybrid_reranker.py     # 混合策略
  ├── strategy.py            # 策略枚举和选择
  └── cost_monitor.py        # 成本监控
  ```
- [ ] 1.3: 安装依赖
  ```bash
  pip install sentence-transformers cohere
  ```

### 任务2: 实现Local Reranker (AC: 1)
- [ ] 2.1: 创建 `local_reranker.py`
  ```python
  # ✅ Verified from docs/architecture/RERANKING-STRATEGY-SELECTION.md Section 3
  from sentence_transformers import CrossEncoder
  import torch
  from typing import List, Dict

  class LocalReranker:
      """
      本地Cross-Encoder Reranker (bge-reranker-base)

      ✅ 支持中文和英文
      ✅ GPU加速
      ✅ 批处理优化
      """

      def __init__(
          self,
          model_name: str = "BAAI/bge-reranker-base",
          device: str = "cuda" if torch.cuda.is_available() else "cpu",
          batch_size: int = 32
      ):
          self.model = CrossEncoder(model_name, device=device)
          self.batch_size = batch_size
          self.device = device

      def rerank(
          self,
          query: str,
          documents: List[str],
          top_k: int = 10
      ) -> List[Dict]:
          """
          Rerank文档

          Returns:
              List of dicts: [{"index": int, "score": float, "document": str}]
          """
          pairs = [(query, doc) for doc in documents]
          scores = self.model.predict(pairs, batch_size=self.batch_size)

          scored_docs = [
              {"index": i, "score": float(score), "document": doc}
              for i, (doc, score) in enumerate(zip(documents, scores))
          ]
          scored_docs.sort(key=lambda x: x["score"], reverse=True)

          return scored_docs[:top_k]
  ```
- [ ] 2.2: 实现批处理优化
- [ ] 2.3: 实现阈值过滤 `rerank_with_threshold()`
- [ ] 2.4: 测试: 验证GPU延迟 < 100ms

### 任务3: 实现Cohere Reranker (AC: 2)
- [ ] 3.1: 创建 `cohere_reranker.py`
  ```python
  # ✅ Verified from docs/architecture/RERANKING-STRATEGY-SELECTION.md Section 2
  import cohere
  from typing import List, Dict

  class CohereReranker:
      """
      Cohere Rerank API封装

      ✅ 多语言支持（含中文）
      ✅ 高精度
      """

      def __init__(
          self,
          api_key: str,
          model: str = "rerank-multilingual-v3.0"
      ):
          self.client = cohere.Client(api_key=api_key)
          self.model = model

      def rerank(
          self,
          query: str,
          documents: List[str],
          top_k: int = 10
      ) -> List[Dict]:
          """
          Cohere Rerank API调用

          Returns:
              List of dicts: [{"index": int, "score": float, "document": str}]
          """
          response = self.client.rerank(
              query=query,
              documents=documents,
              top_n=top_k,
              model=self.model
          )

          results = []
          for r in response.results:
              results.append({
                  "index": r.index,
                  "score": r.relevance_score,
                  "document": documents[r.index]
              })

          return results
  ```
- [ ] 3.2: 实现错误处理和重试
- [ ] 3.3: 测试: 验证中文query正常处理

### 任务4: 实现混合策略 (AC: 3)
- [ ] 4.1: 创建 `strategy.py`
  ```python
  # ✅ Verified from docs/architecture/RERANKING-STRATEGY-SELECTION.md Section 4
  from enum import Enum

  class RerankStrategy(str, Enum):
      """Reranking策略"""
      LOCAL = "local"
      COHERE = "cohere"
      HYBRID_AUTO = "hybrid_auto"

  def select_rerank_strategy(context: Dict) -> RerankStrategy:
      """自动选择Reranking策略"""
      if context.get("is_review_canvas", False):
          return RerankStrategy.COHERE
      else:
          return RerankStrategy.LOCAL
  ```
- [ ] 4.2: 创建 `hybrid_reranker.py`
  ```python
  class HybridReranker:
      """混合Reranker: Local + Cohere"""

      def __init__(self, local: LocalReranker, cohere: CohereReranker):
          self.local = local
          self.cohere = cohere

      def rerank(
          self,
          query: str,
          documents: List[str],
          top_k: int = 10,
          strategy: RerankStrategy = RerankStrategy.HYBRID_AUTO,
          context: Dict = None
      ) -> Tuple[List[Dict], Dict]:
          """混合Reranking"""
          if strategy == RerankStrategy.HYBRID_AUTO:
              strategy = select_rerank_strategy(context or {})

          if strategy == RerankStrategy.LOCAL:
              results = self.local.rerank(query, documents, top_k)
              metadata = {"strategy": "local", "cost": 0.0}
          else:
              results = self.cohere.rerank(query, documents, top_k)
              metadata = {"strategy": "cohere", "cost": 0.002}  # $2/1000次

          return results, metadata
  ```
- [ ] 4.3: 测试: 验证hybrid_auto选择逻辑

### 任务5: 实现成本监控 (AC: 4)
- [ ] 5.1: 创建 `cost_monitor.py`
  ```python
  import logging
  from datetime import datetime, timedelta

  class CostMonitor:
      """Cohere API成本监控"""

      def __init__(
          self,
          monthly_limit: int = 50,
          warning_threshold: float = 0.8
      ):
          self.monthly_limit = monthly_limit
          self.warning_threshold = warning_threshold
          self.current_month = datetime.now().month
          self.call_count = 0

      def record_call(self) -> None:
          """记录Cohere调用"""
          # 月份重置
          if datetime.now().month != self.current_month:
              self.current_month = datetime.now().month
              self.call_count = 0

          self.call_count += 1

          # 告警检查
          if self.call_count >= self.monthly_limit * self.warning_threshold:
              logging.warning(
                  f"Cohere API usage approaching limit: "
                  f"{self.call_count}/{self.monthly_limit}"
              )

      def can_use_cohere(self) -> bool:
          """检查是否可以使用Cohere"""
          return self.call_count < self.monthly_limit
  ```
- [ ] 5.2: 集成到HybridReranker
- [ ] 5.3: 测试: 验证告警触发

### 任务6: 集成到rerank_results节点 (AC: 1-4)
- [ ] 6.1: 修改 `src/agentic_rag/nodes/rerank_results.py`
  ```python
  # ✅ Integration with StateGraph
  from ..reranking.hybrid_reranker import HybridReranker
  from ..reranking.strategy import RerankStrategy

  def rerank_results(state: CanvasRAGState) -> dict:
      """Rerank融合结果"""
      context = {
          "is_review_canvas": state.get("is_review_canvas", False)
      }

      reranked, metadata = hybrid_reranker.rerank(
          query=state["query"],
          documents=[r.content for r in state["fused_results"]],
          top_k=10,
          context=context
      )

      return {
          "reranked_results": reranked,
          "rerank_metadata": metadata
      }
  ```
- [ ] 6.2: 测试: 端到端验证

### 任务7: 实现MRR评估 (AC: 5)
- [ ] 7.1: 创建评估脚本 `scripts/evaluate_reranking.py`
- [ ] 7.2: 准备50个测试query + 标注
- [ ] 7.3: 运行评估，验证MRR提升目标

### 任务8: 创建测试套件 (AC: 1-5)
- [ ] 8.1: 创建 `src/tests/agentic_rag/test_reranking.py`
- [ ] 8.2: 测试Local Reranker
- [ ] 8.3: 测试Cohere Reranker (需要Mock API)
- [ ] 8.4: 测试混合策略选择
- [ ] 8.5: 测试成本监控
- [ ] 8.6: 测试MRR评估

---

## Dev Notes

### Dependencies Verification

**前置依赖验证** (必须先完成):
- [ ] **Story 12.6已完成**: 并行检索结果可用
- [ ] **Story 12.7已完成**: 融合结果可用
- [ ] `state["fused_results"]` 字段存在

**技术栈依赖**:
- [ ] sentence-transformers >= 2.2.0
- [ ] cohere >= 4.0.0
- [ ] torch (CUDA支持)
- [ ] pytest (测试框架)

**环境要求**:
- [ ] CUDA GPU (推荐: NVIDIA RTX 3060+, 12GB VRAM)
- [ ] `COHERE_API_KEY` 环境变量

### SDD规范参考

**Local Reranker模型选择** [Source: docs/architecture/RERANKING-STRATEGY-SELECTION.md Section 3.1]:

| 模型 | 参数量 | 延迟 (100 docs) | 中文支持 | GPU需求 |
|------|--------|----------------|---------|---------|
| ms-marco-MiniLM-L-6-v2 | 22M | ~50ms | ❌ | 2GB |
| **bge-reranker-base** | 102M | ~100ms | ✅ | 4GB |
| bge-reranker-large | 326M | ~200ms | ✅ | 8GB |

**推荐**: `BAAI/bge-reranker-base` (中文优化, 平衡性能)

**Cohere API定价** [Source: docs/architecture/RERANKING-STRATEGY-SELECTION.md Section 2.3]:

- 定价: $2.00/1000次
- 免费额度: 100次/月
- Canvas检验白板估算: ~$12/年 (20次/天)

**混合策略决策树** [Source: docs/architecture/RERANKING-STRATEGY-SELECTION.md Section 4.1]:

```
Canvas Query
     ↓
┌────────────────────────────────┐
│ is_review_canvas == True?      │
├────────────────────────────────┤
│ Yes → Cohere (高精度)          │
│ No → Local (低成本)            │
└────────────────────────────────┘
```

### ADR决策关联

**Reranking策略设计文档** [Source: docs/architecture/RERANKING-STRATEGY-SELECTION.md]:
- **核心决策**: Local为主，Cohere精调关键场景
- **成本优化**: 日常检索用Local ($4/年), 检验白板用Cohere ($12/年)
- **本Story关系**: 直接实现该架构文档定义的混合策略

**ADR-002: LangGraph Multi-Agent System** [Source: docs/architecture/decisions/0002-langgraph-agents.md]:
- **决策**: 使用LangGraph作为多Agent编排框架
- **本Story关系**: Reranking节点集成到StateGraph中

### Testing Standards

**测试文件位置**: `src/tests/agentic_rag/`

**测试类型**:
- 单元测试 (Local/Cohere Reranker)
- 集成测试 (HybridReranker)
- 评估测试 (MRR@10基准)

**Mock策略**:
- Cohere API使用pytest-mock
- Local Reranker使用真实模型 (小规模测试)

**覆盖率目标**: ≥80%

### Performance Benchmarks

**延迟目标** (from Architecture doc):

| Reranker | 10 docs | 100 docs | Canvas目标 |
|----------|---------|----------|-----------|
| Local (GPU) | 15ms | 85ms | < 100ms |
| Cohere API | 110ms | 150ms | < 200ms |

**MRR提升目标**:
- Local: +0.08 (vs 无Rerank)
- Cohere: +0.12 (vs 无Rerank)

### Related Documentation

**Epic和Story文档**:
- [EPIC-12-STORY-MAP.md](../epics/EPIC-12-STORY-MAP.md) - Epic 12完整Story Map
- [12.7.story.md](./12.7.story.md) - 3种融合算法实现 (前置依赖)
- [12.9.story.md](./12.9.story.md) - 质量控制循环 (后续Story)

**架构文档** [Source: docs/architecture/]:
- [RERANKING-STRATEGY-SELECTION.md](../architecture/RERANKING-STRATEGY-SELECTION.md) - Reranking策略选型详细分析
- [ADR-001-local-model-vs-api.md](../architecture/decisions/ADR-001-local-model-vs-api.md) - 本地模型优先ADR

**外部文档**:
- Cohere Rerank API: https://cohere.com/rerank
- BAAI/bge-reranker-base: https://huggingface.co/BAAI/bge-reranker-base

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-28 | 1.0 | 初始创建 - SM Agent *draft | Bob (SM Agent) |

---

## Dev Agent Record

### Agent Model Used
*待填写*

### Debug Log References
*待填写*

### Completion Notes List
*待填写*

### File List
*待填写*

---

## QA Results

*待QA Agent审查*
