# Story 12.6: 并行检索实现 (Send模式)

## Status: Approved

## Epic Context & Background

**所属Epic**: EPIC-12 - 三层记忆系统 + Agentic RAG
**Epic文档**: [EPIC-12-STORY-MAP.md](../epics/EPIC-12-STORY-MAP.md)

**本Story在Epic中的定位**:
- Phase 2 (检索融合层) 的核心Story
- 实现LangGraph Send模式的并行检索
- **依赖**: Story 12.5 (LangGraph StateGraph构建完成)
- **被依赖**: Story 12.7, 12.8 (融合算法和Reranking依赖并行检索结果)

**Epic核心问题回顾**:

### Problem 9: 串行检索延迟过高
- **现象**: Graphiti和LanceDB串行检索，总延迟 = Graphiti延迟 + LanceDB延迟
- **根因**: 没有并行检索机制
- **修复**: 使用LangGraph Send模式实现并行dispatch
- **本Story验证**: 验证并行检索延迟 < max(单独延迟) + 开销

### Problem 10: 检索失败无重试机制
- **现象**: 网络抖动导致检索失败，整体流程中断
- **根因**: 缺乏RetryPolicy
- **修复**: 添加RetryPolicy，支持自动重试和指数退避
- **本Story验证**: 验证ConnectionError自动重试3次

---

## Story

**As a** Agentic RAG系统,
**I want** 并行调用Graphiti和LanceDB检索,
**so that** 减少总延迟，提升用户体验

---

## Acceptance Criteria

### AC 1: fan_out_retrieval()正确dispatch (验证Problem 9基础)
- **函数签名**: `fan_out_retrieval(state: CanvasRAGState) -> List[Send]`
- **返回值**:
  ```python
  [
      Send("retrieve_graphiti", {"query": state["query"], ...}),
      Send("retrieve_lancedb", {"query": state["query"], ...})
  ]
  ```
- **验证方式**: 单元测试验证两个Send对象的payload正确
- **Context7来源**: LangGraph Skill - "Pattern: Parallel Processing"

### AC 2: 并行查询延迟 < 100ms (验证Problem 9核心)
- **基准测试**:
  - Graphiti单独查询: ~45ms (P95)
  - LanceDB单独查询: ~52ms (P95)
- **并行目标**: 总延迟 < 60ms (理论最大值)
- **实际目标**: P95 < 100ms (含并发开销、序列化开销)
- **测试方法**: 运行100次并行查询，计算P95延迟
- **Epic关联**: 确保用户体验无明显等待

### AC 3: RetryPolicy处理异常 (验证Problem 10)
- **配置**:
  ```python
  RetryPolicy(
      retry_on=ConnectionError,
      max_attempts=3,
      backoff_factor=2.0
  )
  ```
- **测试场景**: 模拟Graphiti ConnectionError
- **预期行为**:
  - 第1次失败 → 等待2秒 → 重试
  - 第2次失败 → 等待4秒 → 重试
  - 第3次成功 或 抛出最终异常
- **Context7来源**: LangGraph Skill - "Adding Retry Policies"

### AC 4: 结果正确汇聚到fuse_results节点 (验证Problem 9完整性)
- **state更新**:
  - `state["graphiti_results"]`: List[Dict] 包含10个结果
  - `state["lancedb_results"]`: List[Dict] 包含10个结果
- **汇聚逻辑**: fuse_results节点收到两个结果集后执行融合
- **验证方式**: 集成测试验证state字段正确填充

---

## Tasks / Subtasks

### 任务1: 实现fan_out_retrieval函数 (AC: 1)
- [ ] 1.1: 创建 `src/agentic_rag/nodes/fan_out.py`
  ```python
  # ✅ Verified from LangGraph Skill - Pattern: Parallel Processing
  from langgraph.graph import Send
  from ..state import CanvasRAGState

  def fan_out_retrieval(state: CanvasRAGState) -> list[Send]:
      """并行dispatch到Graphiti和LanceDB检索节点"""
      query = state.get("query", "")
      canvas_path = state.get("canvas_path", "")

      return [
          Send("retrieve_graphiti", {
              "query": query,
              "canvas_path": canvas_path,
              "num_results": 10
          }),
          Send("retrieve_lancedb", {
              "query": query,
              "canvas_path": canvas_path,
              "num_results": 10
          })
      ]
  ```
- [ ] 1.2: 测试: 验证Send对象payload正确

### 任务2: 更新StateGraph添加并行边 (AC: 1, 4)
- [ ] 2.1: 修改 `src/agentic_rag/graph.py`
  ```python
  # ✅ Verified from LangGraph Skill - Conditional edges with Send
  from .nodes.fan_out import fan_out_retrieval

  # 替换原来的两条边:
  # builder.add_edge(START, "retrieve_graphiti")
  # builder.add_edge(START, "retrieve_lancedb")

  # 使用条件边实现并行:
  builder.add_conditional_edges(START, fan_out_retrieval)
  ```
- [ ] 2.2: 测试: 验证图结构正确编译

### 任务3: 添加RetryPolicy (AC: 3)
- [ ] 3.1: 修改retrieve_graphiti节点添加RetryPolicy
  ```python
  # ✅ Verified from LangGraph Skill - Adding Retry Policies
  from langgraph.types import RetryPolicy

  builder.add_node(
      "retrieve_graphiti",
      retrieve_graphiti,
      retry_policy=RetryPolicy(
          retry_on=ConnectionError,
          max_attempts=3,
          backoff_factor=2.0
      )
  )
  ```
- [ ] 3.2: 修改retrieve_lancedb节点添加RetryPolicy
- [ ] 3.3: 测试: 模拟ConnectionError验证重试行为

### 任务4: 实现结果汇聚逻辑 (AC: 4)
- [ ] 4.1: 确保retrieve_graphiti返回正确格式
  ```python
  def retrieve_graphiti(state: dict) -> dict:
      # ... 检索逻辑
      return {"graphiti_results": results}  # List[Dict]
  ```
- [ ] 4.2: 确保retrieve_lancedb返回正确格式
  ```python
  def retrieve_lancedb(state: dict) -> dict:
      # ... 检索逻辑
      return {"lancedb_results": results}  # List[Dict]
  ```
- [ ] 4.3: 验证fuse_results节点能访问两个结果集

### 任务5: 性能基准测试 (AC: 2)
- [ ] 5.1: 创建 `src/tests/agentic_rag/test_parallel_retrieval_latency.py`
- [ ] 5.2: 实现100次查询P95计算
  ```python
  import time
  import numpy as np

  latencies = []
  for _ in range(100):
      start = time.perf_counter()
      result = graph.invoke(initial_state)
      end = time.perf_counter()
      latencies.append((end - start) * 1000)  # ms

  p95 = np.percentile(latencies, 95)
  assert p95 < 100, f"P95延迟 {p95:.2f}ms 超过100ms"
  ```
- [ ] 5.3: 生成性能报告

### 任务6: 创建测试套件 (AC: 1-4)
- [ ] 6.1: 创建 `src/tests/agentic_rag/test_parallel_retrieval.py`
- [ ] 6.2: 测试fan_out_retrieval返回值
- [ ] 6.3: 测试并行执行正确性
- [ ] 6.4: 测试RetryPolicy行为
- [ ] 6.5: 测试结果汇聚正确性

---

## Dev Notes

### Dependencies Verification

**前置依赖验证** (必须先完成):
- [ ] **Story 12.5已完成**: LangGraph StateGraph构建完成
- [ ] CanvasRAGState schema可用
- [ ] retrieve_graphiti节点已实现 (from 12.5)
- [ ] retrieve_lancedb节点已实现 (from 12.5)

**技术栈依赖**:
- [ ] langgraph >= 0.2.55
- [ ] graphiti-core (Graphiti客户端)
- [ ] lancedb (LanceDB客户端)
- [ ] numpy (性能统计)
- [ ] pytest-asyncio (异步测试)

### SDD规范参考

**LangGraph Send API** [Source: LangGraph Skill - Pattern: Parallel Processing]:

```python
# ✅ Verified from LangGraph Skill - Send for parallel processing
from langgraph.graph import Send

def fan_out(state):
    """Send to multiple nodes in parallel"""
    return [
        Send("process_a", state),
        Send("process_b", state),
        Send("process_c", state)
    ]

builder.add_conditional_edges("start", fan_out)
```

**LangGraph RetryPolicy** [Source: LangGraph Skill - Adding Retry Policies]:

```python
# ✅ Verified from LangGraph Skill - RetryPolicy
from langgraph.types import RetryPolicy

builder.add_node(
    "query_database",
    query_database,
    retry_policy=RetryPolicy(
        retry_on=sqlite3.OperationalError,
        max_attempts=5
    )
)
```

**State更新模式** [Source: LangGraph Skill]:

```python
# ✅ Verified from LangGraph Skill - Node return values
def my_node(state: MyState) -> dict:
    # 返回dict，LangGraph自动merge到state
    return {"my_field": new_value}
```

### ADR决策关联

**ADR-002: LangGraph Multi-Agent System** [Source: docs/architecture/decisions/0002-langgraph-agents.md]:
- **决策**: 使用LangGraph作为多Agent编排框架
- **并行处理**: Send模式支持并行dispatch
- **本Story关系**: 直接使用ADR-002推荐的Send模式

**ADR-009: Error Handling & Retry Strategy** [Source: docs/architecture/decisions/ADR-009-ERROR-HANDLING-RETRY-STRATEGY.md]:
- **决策**: 使用指数退避重试策略
- **配置**: max_attempts=3, backoff_factor=2.0
- **本Story关系**: RetryPolicy配置遵循ADR-009

### Testing Standards

**测试文件位置**: `src/tests/agentic_rag/`

**测试类型**:
- 单元测试 (fan_out_retrieval函数)
- 集成测试 (并行检索端到端)
- 性能测试 (P95延迟基准)
- 故障注入测试 (RetryPolicy验证)

**Mock策略**:
- Graphiti使用Mock客户端
- LanceDB使用内存数据库
- 使用pytest-mock模拟ConnectionError

**覆盖率目标**: ≥80%

### Performance Benchmarks

**基准数据** (from Epic 12 PRD):

| 检索方式 | 预期延迟 (P95) |
|----------|----------------|
| Graphiti单独 | ~45ms |
| LanceDB单独 | ~52ms |
| 串行总计 | ~97ms |
| **并行目标** | **< 60ms** |
| **实际目标** | **< 100ms** |

**性能测试方法**:
1. 预热: 运行10次查询
2. 测试: 运行100次查询
3. 统计: 计算P50, P95, P99
4. 验证: P95 < 100ms

### Related Documentation

**Epic和Story文档**:
- [EPIC-12-STORY-MAP.md](../epics/EPIC-12-STORY-MAP.md) - Epic 12完整Story Map
- [12.5.story.md](./12.5.story.md) - LangGraph StateGraph构建 (前置依赖)
- [12.7.story.md](./12.7.story.md) - 3种融合算法实现 (后续Story)

**架构文档** [Source: docs/architecture/]:
- [LANGGRAPH-MEMORY-INTEGRATION-DESIGN.md](../architecture/LANGGRAPH-MEMORY-INTEGRATION-DESIGN.md) - LangGraph集成设计
- [0002-langgraph-agents.md](../architecture/decisions/0002-langgraph-agents.md) - LangGraph ADR
- [ADR-009-ERROR-HANDLING-RETRY-STRATEGY.md](../architecture/decisions/ADR-009-ERROR-HANDLING-RETRY-STRATEGY.md) - 重试策略ADR

**外部文档**:
- LangGraph Skill: `.claude/skills/langgraph/SKILL.md`
- Graphiti Skill: `.claude/skills/graphiti/SKILL.md`

---

## Conflict Resolutions (Step 8d)

| # | Conflict | Decision | Action | Resolved By | Timestamp |
|---|----------|----------|--------|-------------|-----------|
| 1 | Story使用`query`字段但langgraph-state.schema.json未定义 | C (同时修改两者) | Schema已添加query字段定义 | User | 2025-11-28 |

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-28 | 1.1 | PO验证 - 添加冲突解决记录，Schema已更新 | Sarah (PO Agent) |
| 2025-11-28 | 1.0 | 初始创建 - SM Agent *draft | Bob (SM Agent) |

---

## Dev Agent Record

### Agent Model Used
*待填写*

### Debug Log References
*待填写*

### Completion Notes List
*待填写*

### File List
*待填写*

---

## QA Results

*待QA Agent审查*
