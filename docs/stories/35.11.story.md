# Story 35.11: å¤šæ¨¡æ€æœç´¢é™çº§é€æ˜åŒ–ï¼ˆå‰ç«¯æ„ŸçŸ¥ï¼‰

**Status**: done

---

## Epic Context & Background

**æ‰€å±Epic**: EPIC-35 - å¤šæ¨¡æ€åŠŸèƒ½å®Œæ•´æ¿€æ´» (Multimodal Activation)
**Epicæ–‡æ¡£**: [EPIC-35-MULTIMODAL-ACTIVATION.md](../epics/EPIC-35-MULTIMODAL-ACTIVATION.md)

**æœ¬Storyåœ¨Epicä¸­çš„å®šä½**:
- EPIC-35 å¯¹æŠ—æ€§å®¡æŸ¥äº§ç”Ÿçš„ç”¨æˆ·ä½“éªŒä¿®å¤ Story
- ä¿®å¤ P0-2: å‰ç«¯ä¸æ„ŸçŸ¥æœç´¢é™çº§ + P0-1 éƒ¨åˆ†: é™çº§çŠ¶æ€ç¼ºä¹ç”¨æˆ·ä¾§é€æ˜æ€§
- **ä¾èµ–**: Story 35.2 (æœç´¢API), Story 35.3 (ApiClienté›†æˆ)

**å®¡æŸ¥æ¥æº**:
- å¯¹æŠ—æ€§ä»£ç å®¡æŸ¥æŠ¥å‘Š (2026-02-09)
- P0-1: MultimodalStore ä¸å¯ç”¨æ—¶é™é»˜é™çº§ä¸º JSON æ–‡ä»¶å­˜å‚¨ï¼Œåç«¯æœ‰ WARNING æ—¥å¿—ä½† EPIC æœªå‘ŠçŸ¥ç”¨æˆ·åŠŸèƒ½é™è‡³çº¦ 30%
- P0-2: å‘é‡æœç´¢é™çº§ä¸º `query_lower in description.lower()` ç®€å•å…³é”®å­—åŒ¹é…ï¼ŒAPI å“åº”æœ‰ `search_mode` å­—æ®µä½†å‰ç«¯æœªæ£€æŸ¥

---

## Story

**As a** Canvas Learning Systemç”¨æˆ·,
**I want** å½“å¤šæ¨¡æ€æœç´¢é™çº§ä¸ºå…³é”®å­—åŒ¹é…æ—¶åœ¨æœç´¢ç»“æœä¸­çœ‹åˆ°æ˜ç¡®æç¤º,
**so that** æˆ‘çŸ¥é“æœç´¢ç»“æœå¯èƒ½ä¸å®Œæ•´ï¼Œå¹¶ç†è§£å½“å‰çš„ç³»ç»Ÿèƒ½åŠ›çŠ¶æ€ã€‚

---

## Acceptance Criteria

### AC 35.11.1: å‰ç«¯ ApiClient è¯»å– search_mode å­—æ®µ (ä¿®å¤P0-2 æ ¸å¿ƒ)

**Given** åç«¯æœç´¢è¿”å›å“åº”åŒ…å« `search_mode: "text"` (é™çº§) æˆ– `search_mode: "vector"` (æ­£å¸¸)
**When** å‰ç«¯è°ƒç”¨ `searchMultimodal()` æ–¹æ³•
**Then** è¿”å›ç»“æœåŒ…å« `searchMode` å±æ€§ï¼Œå‰ç«¯ç»„ä»¶å¯æ®æ­¤æ˜¾ç¤ºé™çº§æç¤º

**ä»£ç ç°å®æ£€æŸ¥**:
- âœ… åç«¯å·²æœ‰ `search_mode` å­—æ®µ:
  - å‘é‡æœç´¢æˆåŠŸ: `search_mode="vector"` (`multimodal_service.py:1275`)
  - é™çº§æœç´¢: `search_mode="text"` (`multimodal_service.py:1318`)
- ğŸ”´ å‰ç«¯ç¼ºå¤±: `ApiClient.ts` çš„ `searchMultimodal()` æ–¹æ³•æœªè§£æ `search_mode` å­—æ®µ
- ğŸ”´ å‰ç«¯ç¼ºå¤±: æœç´¢ç»“æœ UI æ— é™çº§æç¤º

**ä¿®å¤æ–¹æ¡ˆ**:

**ApiClient.ts** â€” `searchMultimodal()` è¿”å›ç±»å‹æ‰©å±•:
```typescript
interface MultimodalSearchResult {
  results: MediaItem[];
  total: number;
  searchMode: "vector" | "text";  // æ–°å¢
}
```

### AC 35.11.2: æœç´¢ç»“æœé™çº§ UI æç¤º

**Given** `searchMode` ä¸º `"text"` (é™çº§æ¨¡å¼)
**When** ç”¨æˆ·æŸ¥çœ‹æœç´¢ç»“æœ
**Then** æœç´¢ç»“æœåŒºåŸŸé¡¶éƒ¨æ˜¾ç¤ºé»„è‰²æç¤º: "å½“å‰ä½¿ç”¨å…³é”®å­—æœç´¢ï¼ˆè¯­ä¹‰æœç´¢ä¸å¯ç”¨ï¼‰ï¼Œç»“æœå¯èƒ½ä¸å®Œæ•´"

**æŠ€æœ¯æ–¹æ¡ˆ**:
- åœ¨ `MediaPanel.ts` æœç´¢ç»“æœæ¸²æŸ“ä¸­æ·»åŠ æ¡ä»¶æç¤º
- ä½¿ç”¨ Obsidian `Notice` æˆ–å†…è” `callout` æ ·å¼
- ä»…åœ¨ `searchMode === "text"` æ—¶æ˜¾ç¤º

### AC 35.11.3: å¥åº·çŠ¶æ€é¢æ¿æ˜¾ç¤ºå­˜å‚¨åç«¯çŠ¶æ€ (ä¿®å¤P0-1 é€æ˜æ€§)

**Given** ç”¨æˆ·æˆ–å¼€å‘è€…éœ€è¦äº†è§£å¤šæ¨¡æ€ç³»ç»Ÿè¿è¡ŒçŠ¶æ€
**When** è°ƒç”¨ `GET /api/v1/multimodal/health`
**Then** å¥åº·å“åº”æ˜ç¡®æ˜¾ç¤º:
  - `storage_backend`: `"multimodal_store"` æˆ– `"json_fallback"`
  - `vector_search_available`: `true` æˆ– `false`
  - `capability_level`: `"full"` (100%) æˆ– `"degraded"` (çº¦30%)

**ä»£ç ç°å®æ£€æŸ¥**:
- âœ… åç«¯å·²æœ‰ health ç«¯ç‚¹: `multimodal.py:236-252`
- âš ï¸ éœ€æ£€æŸ¥ `MultimodalHealthResponse` æ˜¯å¦å·²åŒ…å«è¿™äº›å­—æ®µ
- âš ï¸ éœ€æ£€æŸ¥ `get_health_status()` æ˜¯å¦è¿”å›è¶³å¤Ÿçš„é™çº§ä¿¡æ¯

### AC 35.11.4: é™çº§æ—¥å¿—æ ‡å‡†åŒ–

**Given** MultimodalStore ä¸å¯ç”¨ï¼Œç³»ç»Ÿé™çº§åˆ° JSON å­˜å‚¨
**When** æœç´¢è¯·æ±‚åˆ°è¾¾
**Then** æ—¥å¿—åŒ…å«ç»“æ„åŒ–çš„é™çº§ä¿¡æ¯:
  - `logger.warning("å¤šæ¨¡æ€æœç´¢é™çº§", extra={"search_mode": "text", "reason": "..."})`

**ä»£ç ç°å®æ£€æŸ¥**:
- âœ… å·²æœ‰: `dependencies.py:928-938` åˆå§‹åŒ–æ—¶æœ‰ WARNING æ—¥å¿—
- âœ… å·²æœ‰: `multimodal_service.py:1281-1283` æœç´¢é™çº§æ—¶æœ‰ WARNING æ—¥å¿—
- ğŸŸ¢ å½“å‰æ—¥å¿—å·²åˆè§„ â€” æœ¬ AC ç¡®è®¤ç°æœ‰æ—¥å¿—æ»¡è¶³ D5 é™çº§é€æ˜æ€§è¦æ±‚

---

## Tasks / Subtasks

### ä»»åŠ¡1: ApiClient æœç´¢ç»“æœç±»å‹æ‰©å±• (AC: 1)

- [x] 1.1: åœ¨ `types/` ä¸­æ›´æ–° `MultimodalSearchResult` æ¥å£æ·»åŠ  `searchMode` å­—æ®µ
- [x] 1.2: ä¿®æ”¹ `ApiClient.ts` çš„ `searchMultimodal()` æ–¹æ³•è§£æ `search_mode` å­—æ®µ
- [x] 1.3: ç¡®ä¿å­—æ®µåæ˜ å°„æ­£ç¡® (åç«¯ `search_mode` â†’ å‰ç«¯ `searchMode`)

### ä»»åŠ¡2: æœç´¢é™çº§ UI æç¤º (AC: 2)

- [x] 2.1: åœ¨ `MediaPanel.ts` æœç´¢ç»“æœåŒºåŸŸæ·»åŠ é™çº§æç¤ºæ¡ä»¶æ¸²æŸ“
- [x] 2.2: åœ¨ `styles.css` ä¸­æ·»åŠ é™çº§æç¤ºæ ·å¼ (é»„è‰²èƒŒæ™¯ callout)
- [x] 2.3: é™çº§æç¤ºæ–‡æ¡ˆå›½é™…åŒ– (ä¸­æ–‡)

### ä»»åŠ¡3: å¥åº·çŠ¶æ€å¢å¼º (AC: 3)

- [x] 3.1: æ£€æŸ¥ `MultimodalHealthResponse` æ¨¡å‹æ˜¯å¦å·²åŒ…å«å­˜å‚¨åç«¯ä¿¡æ¯
- [x] 3.2: åœ¨ `multimodal_schemas.py` ä¸­æ·»åŠ  `storage_backend`, `vector_search_available`, `capability_level` å­—æ®µ
- [x] 3.3: æ›´æ–° `multimodal_service.py` çš„ `get_health_status()` æ–¹æ³•è¿”å›é™çº§ä¿¡æ¯

### ä»»åŠ¡4: æµ‹è¯• (AC: 1, 2, 3)

- [x] 4.1: å‰ç«¯å•å…ƒæµ‹è¯•: `searchMultimodal()` åœ¨ text å’Œ vector æ¨¡å¼ä¸‹æ­£ç¡®è¿”å› `searchMode`
- [ ] 4.2: å‰ç«¯ UI æµ‹è¯•: é™çº§æç¤ºåœ¨ `searchMode="text"` æ—¶æ˜¾ç¤ºï¼Œ`searchMode="vector"` æ—¶éšè—
- [x] 4.3: åç«¯æµ‹è¯•: health ç«¯ç‚¹è¿”å›æ­£ç¡®çš„ `storage_backend` å’Œ `capability_level`

### Review Follow-ups (AI)

- [ ] [AI-Review][MEDIUM] 4.2 éœ€è¦ DOM æµ‹è¯•æ¡†æ¶ (jsdom/happy-dom) éªŒè¯é™çº§æç¤ºæ¸²æŸ“
- [x] [AI-Review][LOW] `MediaPanel.ts` çš„ `(container as any).__performApiSearch` æ¨¡å¼ç±»å‹ä¸å®‰å…¨ â€” å·²ç”¨ `MediaPanelContainer` æ¥å£æ›¿ä»£ (2026-02-10 adversarial fix)
- [x] [AI-Review][LOW] `multimodal_service.py` ä¸­ f-string æ—¥å¿—æ”¹ä¸º lazy `%s` æ ¼å¼ â€” å·²è½¬æ¢å…¨éƒ¨ 20 å¤„ (2026-02-10 adversarial fix)

---

## Dev Notes

### ä»£ç ç°å®æ£€æŸ¥è¡¨

| å£°ç§°çš„åŠŸèƒ½ | ä»£ç ä½ç½® | çŠ¶æ€ |
|-----------|----------|------|
| åç«¯ search_mode å­—æ®µ | `multimodal_service.py:1275, 1318` | âœ… å·²å­˜åœ¨ |
| å‰ç«¯è§£æ search_mode | `ApiClient.ts:searchMultimodal()` | ğŸ”´ ç¼ºå¤± â€” éœ€æ·»åŠ  |
| é™çº§ UI æç¤º | `MediaPanel.ts` | ğŸ”´ ç¼ºå¤± â€” éœ€æ·»åŠ  |
| é™çº§ WARNING æ—¥å¿— | `dependencies.py:928+, multimodal_service.py:1281+` | âœ… å·²å­˜åœ¨ |
| health ç«¯ç‚¹é™çº§ä¿¡æ¯ | `multimodal.py:236-252` | âš ï¸ éœ€éªŒè¯å­—æ®µ |

### å‰ç«¯æ–‡ä»¶ä½ç½®

| æ–‡ä»¶ | ç”¨é€” |
|------|------|
| `canvas-progress-tracker/obsidian-plugin/src/api/ApiClient.ts` | æœç´¢ API è°ƒç”¨ |
| `canvas-progress-tracker/obsidian-plugin/src/components/MediaPanel.ts` | æœç´¢ç»“æœ UI |
| `canvas-progress-tracker/obsidian-plugin/src/types/settings.ts` | ç±»å‹å®šä¹‰ |
| `canvas-progress-tracker/obsidian-plugin/styles.css` | æ ·å¼ |

### å½±å“èŒƒå›´

- **åç«¯**: `multimodal_schemas.py` (å¥åº·å“åº”æ¨¡å‹), `multimodal_service.py` (å¥åº·çŠ¶æ€æ–¹æ³•) â€” å°å¹…ä¿®æ”¹
- **å‰ç«¯**: `ApiClient.ts` (æœç´¢ç»“æœè§£æ), `MediaPanel.ts` (é™çº§æç¤º), `styles.css` (æ ·å¼)
- **æµ‹è¯•**: å‰ç«¯ + åç«¯å„ 2-3 ä¸ªæ–°æµ‹è¯•ç”¨ä¾‹

---

## Dev Agent Record

### File List

| File | Change Type | Description |
|------|------------|-------------|
| `backend/app/models/multimodal_schemas.py` | Modified | æ·»åŠ  health é™çº§å­—æ®µ + search_mode åˆ° SearchResponse |
| `backend/app/services/multimodal_service.py` | Modified | health è¿”å›é™çº§ä¿¡æ¯ + search è¿”å› search_mode |
| `canvas-progress-tracker/obsidian-plugin/src/api/types.ts` | Modified | æ·»åŠ  search_mode ç±»å‹ + MultimodalSearchResultWithMode |
| `canvas-progress-tracker/obsidian-plugin/src/api/ApiClient.ts` | Modified | searchMultimodal è¿”å› searchMode |
| `canvas-progress-tracker/obsidian-plugin/src/components/MediaPanel.ts` | Modified | é™çº§æç¤º UI + performApiSearch è¿æ¥æœç´¢æµ |
| `canvas-progress-tracker/obsidian-plugin/styles.css` | Modified | é™çº§æç¤ºé»„è‰² callout æ ·å¼ |
| `backend/tests/api/v1/endpoints/test_multimodal.py` | Modified | æ·»åŠ  health é™çº§å€¼éªŒè¯æµ‹è¯• |
| `canvas-progress-tracker/obsidian-plugin/tests/api/ApiClient.multimodal.test.ts` | Modified | ä¿®å¤è¿”å›ç±»å‹æ–­è¨€ + æ·»åŠ  searchMode æµ‹è¯• |

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-09 | 1.0 | åŸºäºå¯¹æŠ—æ€§å®¡æŸ¥æŠ¥å‘Šåˆ›å»º | John (PM Agent) |
| 2026-02-09 | 1.1 | Code Review ä¿®å¤: C1 æµ‹è¯•æ–­è£‚, C2 æœç´¢æµè¿æ¥, M1-M5 æµ‹è¯•+ç±»å‹ä¿®æ­£ | AI Code Review |
