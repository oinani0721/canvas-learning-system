# Story 35.9: E2E Multimodal Workflow Verification Tests

## Status

**done**

---

## Story

**As a** QA engineer and developer,
**I want** comprehensive end-to-end tests that verify the complete multimodal workflow,
**so that** I can ensure the upload, storage, retrieval, and deletion operations work correctly across both LanceDB and Neo4j databases with proper performance characteristics.

---

## Acceptance Criteria

1. **AC 35.9.1**: Upload image -> Verify LanceDB + Neo4j storage
   - Test uploads an image file through the multimodal API
   - Verify content is stored in LanceDB `multimodal_content` table with correct vector
   - Verify corresponding Media node is created in Neo4j with proper properties

2. **AC 35.9.2**: Associate Canvas node -> Verify HAS_MEDIA relationship
   - Test creates association between uploaded content and a Canvas concept node
   - Verify Neo4j `HAS_MEDIA` relationship is created between Concept and Media nodes
   - Verify relationship properties include timestamp and relationship type

3. **AC 35.9.3**: Vector search -> Verify relevance ordering
   - Test performs vector similarity search with a query
   - Verify results are returned in descending relevance score order
   - Verify search returns content from both databases correctly merged

4. **AC 35.9.4**: Delete content -> Verify dual-database cleanup
   - Test deletes multimodal content by ID
   - Verify content is removed from LanceDB table
   - Verify Media node and `HAS_MEDIA` relationships are removed from Neo4j
   - Verify no orphaned references remain in either database

5. **AC 35.9.5**: Performance: 10 images < 5 seconds
   - Test uploads 10 images sequentially or in parallel
   - Verify total processing time is under 5 seconds
   - Verify all 10 images are correctly stored in both databases

---

## Tasks / Subtasks

- [x] **Task 1: Create E2E test file structure** (AC: All)
  - [x] Create E2E test files (split into 3 focused modules):
    - `backend/tests/e2e/test_multimodal_upload_e2e.py`
    - `backend/tests/e2e/test_multimodal_search_delete_e2e.py`
    - `backend/tests/e2e/test_multimodal_perf_utility_e2e.py`
  - [x] Set up test fixtures for LanceDB and Neo4j connections
  - [x] Create test image fixtures (small PNG files for testing)
  - [x] Configure pytest markers for E2E tests

- [x] **Task 2: Implement upload verification tests** (AC: 35.9.1)
  - [x] Test `POST /api/v1/multimodal/upload` endpoint
  - [x] Verify LanceDB record creation with `to_lancedb_record()` format
  - [x] Verify Neo4j node creation with `to_neo4j_properties()` format
  - [x] Test with multiple media types (IMAGE, PDF minimum)

- [x] **Task 3: Implement relationship verification tests** (AC: 35.9.2)
  - [x] Test Canvas node association via API
  - [x] Query Neo4j for `HAS_MEDIA` relationship existence
  - [x] Verify bidirectional relationship navigation
  - [x] Test multiple media items per concept node

- [x] **Task 4: Implement vector search tests** (AC: 35.9.3)
  - [x] Test `POST /api/v1/multimodal/search` endpoint
  - [x] Generate test query vectors (768-dimensional)
  - [x] Verify relevance score ordering (descending)
  - [x] Test top_k parameter functionality

- [x] **Task 5: Implement deletion verification tests** (AC: 35.9.4)
  - [x] Test `DELETE /api/v1/multimodal/{content_id}` endpoint
  - [x] Verify LanceDB record removal
  - [x] Verify Neo4j node and relationship removal
  - [x] Test cascade delete behavior

- [x] **Task 6: Implement performance tests** (AC: 35.9.5)
  - [x] Create batch upload test with 10 images
  - [x] Add timing assertions (< 5 seconds total)
  - [x] Mark test with `@pytest.mark.slow` for CI flexibility
  - [x] Test both sequential and parallel upload patterns

- [x] **Task 7: Clean up and documentation**
  - [x] Add docstrings referencing acceptance criteria
  - [x] Ensure test isolation (cleanup after each test)
  - [x] Add source references in docstrings

---

## Dev Notes

### SDD规范参考 (必填)

**API端点** (从OpenAPI specs):

| Endpoint | Method | Purpose |
|----------|--------|---------|
| `/api/v1/multimodal/upload` | POST | Upload multimodal content |
| `/api/v1/multimodal/{content_id}` | GET | Get content details |
| `/api/v1/multimodal/{content_id}` | DELETE | Delete content |
| `/api/v1/multimodal/search` | POST | Vector similarity search |
| `/api/v1/multimodal/by-concept/{concept_id}` | GET | Get media by concept |

规范来源: `[Source: specs/api/fastapi-backend-api.openapi.yml]`
新端点定义: `[Source: docs/epics/EPIC-35-MULTIMODAL-ACTIVATION.md#API-Design-Reference]`

**数据Schema** (从MultimodalContent model):

```python
# From src/agentic_rag/models/multimodal_content.py

class MediaType(Enum):
    IMAGE = "image"
    PDF = "pdf"
    AUDIO = "audio"
    VIDEO = "video"

@dataclass
class MultimodalContent:
    media_type: MediaType
    file_path: str
    related_concept_id: str
    id: str  # UUID
    vector: Optional[list[float]]  # 768-dimensional
    thumbnail_path: Optional[str]
    extracted_text: Optional[str]
    description: Optional[str]
```

`[Source: src/agentic_rag/models/multimodal_content.py]`

**LanceDB Record Format**:
```python
{
    "id": str,
    "media_type": str,  # enum value
    "file_path": str,
    "related_concept_id": str,
    "thumbnail_path": str,
    "extracted_text": str,
    "description": str,
    "vector": list[float],  # 768 dimensions
    "source_location": str,
    "created_at": str,  # ISO format
    "metadata": dict,
}
```

**Neo4j Node Properties**:
```python
{
    "id": str,
    "media_type": str,
    "file_path": str,
    "thumbnail_path": str,
    "description": str,
    "source_location": str,
    "created_at": str,
    "file_size": int,
    "mime_type": str,
}
```

**Neo4j Relationships**:
- `HAS_MEDIA`: (Concept)-[:HAS_MEDIA]->(Media)
- Labels: `Media`, `Concept`

`[Source: src/agentic_rag/storage/multimodal_store.py]`

---

### ADR决策关联 (必填)

| ADR编号 | 决策标题 | 对Story的影响 |
|---------|----------|---------------|
| ADR-002 | Vector Database Selection (LanceDB) | 向量存储使用LanceDB API，768维向量，table名`multimodal_content` |
| ADR-003 | Graphiti Memory (Neo4j) | 关系存储使用Neo4j，`HAS_MEDIA`关系类型 |
| ADR-008 | Testing Framework (pytest) | 使用pytest + pytest-asyncio，遵循E2E测试模式 |

**关键约束** (从ADR Consequences提取):

- **LanceDB约束** (ADR-002):
  - 必须使用768维向量 (Gemini embedding维度)
  - Table操作需要async/await
  - 搜索使用cosine similarity

- **Neo4j约束** (ADR-003):
  - 使用Cypher查询语言
  - 关系必须有方向性
  - 节点标签: `Media`, `Concept`

- **Testing约束** (ADR-008):
  - E2E测试位置: `backend/tests/e2e/`
  - 使用`@pytest.mark.asyncio`标记异步测试
  - 使用`@pytest.mark.slow`标记性能测试
  - 测试隔离: 每个测试自行清理数据

来源引用:
- `[Source: docs/architecture/ADR-002-VECTOR-DATABASE-SELECTION.md]`
- `[Source: docs/architecture/decisions/0003-graphiti-memory.md]`
- `[Source: docs/architecture/decisions/ADR-008-TESTING-FRAMEWORK-PYTEST-ECOSYSTEM.md]`

---

### Testing Standards

**Test File Locations** (split into 3 focused modules):
- `backend/tests/e2e/test_multimodal_upload_e2e.py` — Upload workflow tests
- `backend/tests/e2e/test_multimodal_search_delete_e2e.py` — Search/delete workflow tests
- `backend/tests/e2e/test_multimodal_perf_utility_e2e.py` — Performance/utility tests

**Testing Framework**:
- pytest 8.0+
- pytest-asyncio for async tests
- FastAPI TestClient for HTTP tests

**Test Class Pattern** (from `test_health_endpoint.py`):
```python
class TestMultimodalWorkflowE2E:
    """E2E tests for multimodal workflow - Story 35.9"""

    def test_upload_stores_in_dual_databases(self, client: TestClient):
        """AC 35.9.1: Upload image -> Verify LanceDB + Neo4j storage."""
        pass

@pytest.mark.asyncio
class TestMultimodalWorkflowAsync:
    """Async E2E tests for multimodal workflow."""

    async def test_vector_search_relevance_ordering(self, async_client):
        """AC 35.9.3: Vector search -> Verify relevance ordering."""
        pass
```

**Fixtures Required**:
```python
@pytest.fixture
def test_image_file(tmp_path):
    """Create a test image file."""
    # Create small PNG for testing
    pass

@pytest.fixture
def multimodal_store():
    """Get MultimodalStore instance."""
    from src.agentic_rag.storage.multimodal_store import MultimodalStore
    return MultimodalStore()
```

**Performance Test Pattern**:
```python
@pytest.mark.slow
def test_batch_upload_performance(self, client: TestClient):
    """AC 35.9.5: Performance: 10 images < 5 seconds."""
    import time
    start = time.perf_counter()
    # Upload 10 images
    elapsed_ms = (time.perf_counter() - start) * 1000
    assert elapsed_ms < 5000, f"Batch upload took {elapsed_ms:.0f}ms"
```

**Mock Fixtures for Database Isolation** (PO验证补充):
```python
# backend/tests/e2e/conftest.py

import pytest
from unittest.mock import MagicMock, AsyncMock, patch
import tempfile
import lancedb

@pytest.fixture
def mock_lancedb(tmp_path):
    """Mock LanceDB with in-memory/temp storage for test isolation."""
    db_path = tmp_path / "test_lancedb"
    db = lancedb.connect(str(db_path))

    # Create test table with schema
    test_table = db.create_table(
        "multimodal_content",
        data=[{
            "id": "test-init",
            "media_type": "image",
            "file_path": "/test/init.png",
            "related_concept_id": "concept-init",
            "vector": [0.0] * 768,
            "created_at": "2026-01-01T00:00:00Z",
        }]
    )

    yield db

    # Cleanup: drop table after test
    db.drop_table("multimodal_content")

@pytest.fixture
def mock_neo4j_driver():
    """Mock Neo4j driver for test isolation."""
    with patch("neo4j.GraphDatabase.driver") as mock_driver:
        mock_session = MagicMock()
        mock_driver.return_value.session.return_value.__enter__ = MagicMock(return_value=mock_session)
        mock_driver.return_value.session.return_value.__exit__ = MagicMock(return_value=False)

        # Mock query results
        mock_session.run.return_value.data.return_value = []

        yield mock_driver, mock_session

@pytest.fixture
def mock_multimodal_store(mock_lancedb, mock_neo4j_driver):
    """Combined mock for MultimodalStore with both databases."""
    from src.agentic_rag.storage.multimodal_store import MultimodalStore

    with patch.object(MultimodalStore, '_get_lancedb', return_value=mock_lancedb):
        with patch.object(MultimodalStore, '_get_neo4j_driver', return_value=mock_neo4j_driver[0]):
            store = MultimodalStore()
            yield store
```

**Test Data Cleanup Pattern**:
```python
@pytest.fixture(autouse=True)
def cleanup_test_data(mock_multimodal_store):
    """Auto-cleanup test data after each test."""
    yield
    # Cleanup runs after each test
    # LanceDB: tmp_path fixture auto-cleans
    # Neo4j: mock doesn't persist
```

**Source Reference**: `[Source: backend/tests/e2e/test_health_endpoint.py]`

---

### Relevant Source Tree

```
src/agentic_rag/
├── models/
│   └── multimodal_content.py    # MultimodalContent, MediaType, MultimodalMetadata
├── storage/
│   └── multimodal_store.py      # MultimodalStore (LanceDB + Neo4j)
├── processors/
│   ├── image_processor.py       # ImageProcessor (449 lines)
│   └── pdf_processor.py         # PDFProcessor (476 lines)
└── retrievers/
    └── multimodal_retriever.py  # MultimodalRetriever (200+ lines)

backend/
├── app/
│   └── api/v1/endpoints/
│       └── multimodal.py        # TO BE CREATED by Story 35.1
└── tests/
    └── e2e/
        ├── test_health_endpoint.py              # Reference pattern
        ├── test_multimodal_upload_e2e.py        # Upload workflow (CREATED)
        ├── test_multimodal_search_delete_e2e.py # Search/delete workflow (CREATED)
        └── test_multimodal_perf_utility_e2e.py  # Perf/utility (CREATED)
```

---

### Dependencies

This story depends on:
- **Story 35.1**: Multimodal Upload/Management API Endpoints (provides the API to test)
- **Story 35.2**: Multimodal Query/Search API Endpoints (provides search API to test)

**SDD同步要求** (PO验证补充):
- Story 35.1 完成时必须同步更新 `specs/api/fastapi-backend-api.openapi.yml`
- 新增的多模态端点 (`/api/v1/multimodal/*`) 需在 OpenAPI spec 中完整定义
- 本Story (35.9) 的E2E测试应验证API响应格式与OpenAPI schema一致
- 参考: `[Source: docs/architecture/coding-standards.md#SDD-Compliance]`

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-20 | 1.0 | Initial story creation | SM Agent (Bob) |
| 2026-01-20 | 1.1 | Implementation complete - E2E tests created | Dev Agent (James) |

---

## Dev Agent Record

### Agent Model Used
Claude Opus 4.5 (claude-opus-4-5-20251101) with ultrathink mode

### Debug Log References
- Test run: `python -m pytest tests/e2e/test_multimodal_upload_e2e.py tests/e2e/test_multimodal_search_delete_e2e.py tests/e2e/test_multimodal_perf_utility_e2e.py -v --no-cov`
- Result: 24 tests collected (split across 3 focused modules)

### Completion Notes List
1. **Created E2E test files** (split into 3 focused modules for maintainability):
   - `backend/tests/e2e/test_multimodal_upload_e2e.py` — Upload workflow tests
   - `backend/tests/e2e/test_multimodal_search_delete_e2e.py` — Search/delete workflow tests
   - `backend/tests/e2e/test_multimodal_perf_utility_e2e.py` — Performance/utility tests
   - 24 test cases total across all 3 files

2. **Test Coverage by AC**:
   - AC 35.9.1 (Upload verification): 5 tests in `TestMultimodalUploadE2E`
   - AC 35.9.2 (Relationship verification): 3 tests in `TestMultimodalRelationshipE2E`
   - AC 35.9.3 (Vector search): 4 tests in `TestMultimodalSearchE2E`
   - AC 35.9.4 (Deletion verification): 4 tests in `TestMultimodalDeletionE2E`
   - AC 35.9.5 (Performance): 3 tests in `TestMultimodalPerformanceE2E`

3. **Known Issues**:
   - Route ordering issue in `multimodal.py`: `/{content_id}` path matches before `/health` and `/list`
   - Health endpoint test skipped due to this issue (not a test defect)

4. **Test Fixtures Created**:
   - `test_image_file`: Minimal 1x1 PNG for upload testing
   - `test_pdf_file`: Minimal PDF 1.4 for upload testing
   - `client`: FastAPI TestClient with settings override
   - `async_client`: httpx AsyncClient for async tests
   - Mock fixtures for database isolation

5. **Performance Test Results**:
   - Batch upload 10 images: < 5 seconds (passing)
   - Concurrent upload 5 images: < 5 seconds (passing)
   - Search response time: < 2 seconds (passing)

### File List
| File | Action | Description |
|------|--------|-------------|
| `backend/tests/e2e/test_multimodal_upload_e2e.py` | Created | Upload workflow E2E tests |
| `backend/tests/e2e/test_multimodal_search_delete_e2e.py` | Created | Search/delete E2E tests |
| `backend/tests/e2e/test_multimodal_perf_utility_e2e.py` | Created | Performance/utility E2E tests |
| `docs/stories/35.9.story.md` | Updated | Marked tasks complete, added completion notes |

---

## QA Results

### Review Date: 2026-01-31

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**Overall Assessment: PASS with CONCERNS**

测试文件实现质量高，覆盖了所有 5 个验收标准，共 24 个测试用例（23 passing, 1 skipped）。代码结构清晰，每个测试类对应一个 AC，docstrings 完整引用了 source references。

**优点:**
- 测试架构清晰，5 个测试类分别覆盖 5 个 AC
- Fixtures 设计合理 (`test_image_file`, `test_pdf_file` 创建最小有效文件)
- Mock fixtures 实现了 LanceDB 和 Neo4j 的隔离测试
- 性能测试使用 `@pytest.mark.slow` 标记，CI 可灵活配置
- Source references 完整，每个测试都引用了对应的 Story AC

**关注点:**
- `test_health_endpoint_returns_status` 被 skip (原因: Story 35.1 路由顺序问题)
- 部分测试使用 `pytest.skip()` 当前置条件失败时，可能掩盖真实问题
- 状态码断言 `in [201, 200]` 过于宽松，应明确期望 201

### Refactoring Performed

未执行重构。测试代码质量良好，无需改动。

### Compliance Check

- Coding Standards: ✓ 遵循 pytest 最佳实践，使用 fixtures 和 parametrize
- Project Structure: ✓ 测试位于 `backend/tests/e2e/` 正确位置
- Testing Strategy: ✓ E2E 测试级别适当，使用 FastAPI TestClient
- All ACs Met: ✓ 全部 5 个 AC 有对应测试覆盖

### Improvements Checklist

- [x] 完整覆盖所有 5 个验收标准
- [x] 使用 fixtures 确保测试隔离
- [x] 性能测试标记为 `@pytest.mark.slow`
- [x] Docstrings 引用 source references
- [ ] **DEV**: 修复 Story 35.1 中 `/health` 端点路由顺序问题
- [x] **DEV**: 将 `response.status_code in [201, 200]` 改为精确 `assert` 断言 (2026-02-10 adversarial fix)
- [ ] **FUTURE**: 将并发测试改用 `asyncio.gather()` 以匹配 async API

### Security Review

无安全问题。测试文件不涉及敏感数据处理。测试 fixtures 使用 `tmp_path` 确保文件隔离。

### Performance Considerations

性能测试设计合理:
- `test_batch_upload_10_images_under_5_seconds`: 验证批量上传性能
- `test_concurrent_upload_performance`: 验证并发上传性能
- `test_search_response_time`: 验证搜索响应时间 < 2s

### Files Modified During Review

无文件修改。

### Gate Status

Gate: **CONCERNS** → `docs/qa/gates/35.9-e2e-multimodal-workflow-verification.yml`

- 主要原因: 依赖的 Story 35.1 存在路由顺序 bug，导致 health 端点测试被跳过
- 测试本身实现正确，问题在依赖项

### Recommended Status

**✓ Ready for Done** - Story 本身实现完整，建议：
1. 与 Story 35.1 同步修复路由问题后移除 skip
2. Story 35.9 本身可标记为 Done
