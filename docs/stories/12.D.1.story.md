# Story 12.D.1: 前端支持 FILE 类型节点内容读取

## Status

InProgress

> **PO Validation**: 2025-12-15 | Score: 9/10 | All SDD/ADR refs verified | No conflicts
> **Dev Started**: 2025-12-15 | Build: SUCCESS | Deployed to vault

---

## Story

**As a** Canvas Learning System 用户,
**I want** 右键点击 FILE 类型节点时能正确获取链接的 MD 文件内容,
**so that** AI Agent 能基于正确的节点内容生成相关的解释，而不是产生幻觉。

---

## Acceptance Criteria

1. **AC1**: FILE 类型节点的右键菜单能正确读取链接 MD 文件内容并传递给 API
2. **AC2**: TEXT 类型节点功能保持不变（回归测试通过）
3. **AC3**: 当 FILE 节点链接的文件不存在时，优雅降级为空字符串并记录警告日志
4. **AC4**: 控制台日志显示 `[Story 12.D.1] Read FILE node content: {filePath}, length: {n}`

---

## Tasks / Subtasks

- [ ] **Task 1**: 修改 FILE 类型节点内容读取逻辑 (AC: 1, 3, 4)
  - [ ] 1.1 在 `ContextMenuManager.ts` 中定位 BUG 代码 (第 871-880 行)
  - [ ] 1.2 添加 FILE 类型节点处理分支
  - [ ] 1.3 使用 `this.app.vault.getAbstractFileByPath()` 获取文件引用
  - [ ] 1.4 使用 `TFile` 类型检查和 `this.app.vault.cachedRead()` 读取内容
  - [ ] 1.5 添加文件不存在的优雅降级处理
  - [ ] 1.6 添加日志输出 `[Story 12.D.1] Read FILE node content: ...`

- [ ] **Task 2**: 处理异步读取 (AC: 1)
  - [ ] 2.1 将 `handleCanvasNodeContextMenu` 方法标记为 `async`（如尚未标记）
  - [ ] 2.2 确保 `nodeContent` 提取代码使用 `await`
  - [ ] 2.3 验证 `MenuContext` 能正确接收异步读取的内容

- [ ] **Task 3**: 回归测试 TEXT 类型节点 (AC: 2)
  - [ ] 3.1 手动测试 TEXT 类型节点右键菜单功能
  - [ ] 3.2 验证 TEXT 节点 API 调用包含正确的 `node_content`
  - [ ] 3.3 确认 TEXT 节点日志输出不变

- [ ] **Task 4**: 构建和部署验证 (AC: 1, 2, 3, 4)
  - [ ] 4.1 运行 `npm run build` 构建插件
  - [ ] 4.2 复制 `main.js` 到正确的 Obsidian 插件目录
  - [ ] 4.3 重启 Obsidian 加载新插件
  - [ ] 4.4 执行 kp01 (Level Set) 测试用例

---

## Dev Notes

### SDD规范参考 (必填)

**数据Schema** (从JSON Schema):

| Schema | 来源 | 关键定义 |
|--------|------|----------|
| CanvasNode | `specs/data/canvas-node.schema.json` | `type: enum["text", "file", "group", "link"]`<br>`file: string` (当 type=file 时必填) |
| MenuContext | `src/types/menu.ts:72-102` | `nodeType?: 'text' \| 'file' \| 'link' \| 'group'`<br>`nodeContent?: string` |

**节点类型处理规范**:
```json
// [Source: specs/data/canvas-node.schema.json#L24-L113]
{
  "type": {
    "enum": ["text", "file", "group", "link"],
    "description": "节点类型: text(文本节点), file(文件节点), group(分组节点), link(链接节点)"
  },
  "text": {
    "type": "string",
    "description": "文本内容，当type=text时必填"
  },
  "file": {
    "type": "string",
    "description": "文件路径，当type=file时必填，相对路径"
  }
}
```

**API端点** (从OpenAPI specs):
- 本 Story 不涉及新 API 端点，修改的是前端向已有端点传递的 `node_content` 参数
- 受影响端点: `POST /api/v1/agents/{agent_type}` 系列端点
- [Source: specs/api/canvas-api.openapi.yml#L709-L745 - CanvasNode schema]

---

### ADR决策关联 (必填)

| ADR编号 | 决策标题 | 对Story的影响 |
|---------|----------|---------------|
| ADR-0001 | 使用Obsidian Canvas作为可视化载体 | Canvas操作必须使用JSON格式，FILE节点`file`属性为相对路径 |

**关键约束** (从ADR Consequences提取):
- **约束1**: FILE节点的`file`属性是相对于Vault根目录的相对路径 [Source: ADR-0001#Consequences]
- **约束2**: 使用Obsidian Vault API读取文件，不能直接使用Node.js文件系统API [Source: ADR-0001#技术实现]

**⚠️ 注意**: 以下架构决策记录在架构文档中，但无独立ADR:
- Obsidian API `vault.read()` vs `vault.cachedRead()` 选择 → `docs/architecture/tech-stack.md#Obsidian`

---

### 技术验证报告 (Step 3.6)

**验证完成时间**: 2025-12-15T21:30:00Z
**验证执行人**: SM Agent
**Quality Gate状态**: PASSED

#### 技术栈清单

| 技术栈 | 查询方式 | 验证状态 | 文档位置 |
|--------|---------|---------|----------|
| Obsidian API | Skill | Verified | `.claude/skills/obsidian-canvas/SKILL.md` |
| TypeScript | 内置 | N/A | TypeScript标准 |
| JSON Canvas Format | Skill | Verified | `.claude/skills/obsidian-canvas/SKILL.md:24-60` |

#### 核心API验证结果

**Obsidian Vault API**:
- `this.app.vault.getAbstractFileByPath(path: string)`
  - Verified from @obsidian-canvas Skill (SKILL.md:587)
  - 用途: 根据路径获取文件对象
  - 返回: `TAbstractFile | null`

- `this.app.vault.read(file: TFile): Promise<string>`
  - Verified from @obsidian-canvas Skill (SKILL.md:84, 159, 217)
  - 用途: 异步读取文件内容
  - 返回: 文件内容字符串

- `file instanceof TFile`
  - Verified from @obsidian-canvas Skill (SKILL.md:65, 410, 590, 616)
  - 用途: 类型检查，确保是文件而非文件夹

**Epic 12.D 建议使用 cachedRead**:
- `this.app.vault.cachedRead(file: TFile): Promise<string>`
  - 来源: Epic 12.D PRD 建议 (性能优化)
  - 用途: 使用缓存版本读取文件，比 read() 更快
  - 注意: Skill 文档中未明确记录此 API，但 Obsidian API 类型定义中存在

#### 代码示例库

**示例1: 读取文件内容 (来自 @obsidian-canvas Skill)**
```typescript
// Verified from @obsidian-canvas Skill (SKILL.md:83-86)
import { TFile } from 'obsidian';

async readCanvas(file: TFile) {
  const content = await this.app.vault.read(file);
  return JSON.parse(content);
}
```

**示例2: 获取文件引用并检查类型 (来自 @obsidian-canvas Skill)**
```typescript
// Verified from @obsidian-canvas Skill (SKILL.md:587-591)
const file = app.vault.getAbstractFileByPath(filePath);
if (file instanceof TFile) {
  const content = await app.vault.read(file);
  // 处理内容...
}
```

---

### BUG 代码定位

**文件**: `canvas-progress-tracker/obsidian-plugin/src/managers/ContextMenuManager.ts`
**行号**: 871-880

**当前 BUG 代码**:
```typescript
// Story 12.B.2: Extract real-time node content for API calls
// Text nodes store content in .text property
// File nodes reference a file path, we can't easily get content here
const nodeContent: string | undefined =
  nodeInfo.nodeData?.type === 'text' && nodeInfo.nodeData?.text
    ? nodeInfo.nodeData.text
    : undefined;  // FILE 类型被忽略！
```

**修复后代码** (参考实现):
```typescript
// Story 12.D.1: Support both TEXT and FILE node types
// ✅ Verified from @obsidian-canvas Skill (SKILL.md:83-86, 587-591)
let nodeContent: string | undefined;

if (nodeInfo.nodeData?.type === 'text' && nodeInfo.nodeData?.text) {
  // TEXT 类型：直接从 JSON 读取
  nodeContent = nodeInfo.nodeData.text;
  if (nodeContent) {
    const preview = nodeContent.length > 100 ? nodeContent.substring(0, 100) + '...' : nodeContent;
    console.log('[DEBUG-CANVAS] Extracted TEXT node content:', preview);
  }
} else if (nodeInfo.nodeData?.type === 'file' && nodeInfo.nodeData?.file) {
  // FILE 类型：读取链接的 MD 文件内容
  // ✅ Verified from @obsidian-canvas Skill (SKILL.md:587-591)
  const filePath = nodeInfo.nodeData.file;
  const abstractFile = this.app.vault.getAbstractFileByPath(filePath);
  if (abstractFile instanceof TFile) {
    try {
      // 使用 cachedRead 提高性能 (Epic 12.D PRD 建议)
      nodeContent = await this.app.vault.cachedRead(abstractFile);
      console.log(`[Story 12.D.1] Read FILE node content: ${filePath}, length: ${nodeContent.length}`);
    } catch (error) {
      console.error(`[Story 12.D.1] Failed to read FILE node: ${filePath}`, error);
      nodeContent = undefined;
    }
  } else {
    console.warn(`[Story 12.D.1] File not found: ${filePath}`);
    nodeContent = undefined;
  }
}
```

**需要添加的 import**:
```typescript
import { TFile } from 'obsidian';  // 如尚未导入
```

---

### 部署路径

| 位置 | 路径 | 说明 |
|------|------|------|
| 源代码 | `canvas-progress-tracker/obsidian-plugin/src/managers/ContextMenuManager.ts` | 修改位置 |
| 构建输出 | `canvas-progress-tracker/obsidian-plugin/main.js` | npm run build 输出 |
| **部署目标** | `C:\Users\ROG\托福\Canvas\笔记库\.obsidian\plugins\canvas-review-system\` | 正确路径 |

**部署命令**:
```powershell
cd canvas-progress-tracker/obsidian-plugin && npm run build
Copy-Item main.js "C:\Users\ROG\托福\Canvas\笔记库\.obsidian\plugins\canvas-review-system\" -Force
Copy-Item manifest.json "C:\Users\ROG\托福\Canvas\笔记库\.obsidian\plugins\canvas-review-system\" -Force
```

---

### Testing

**测试文件位置**: 手动测试（前端 UI 功能）

**测试用例1: FILE 类型节点 (kp01)**
```
Canvas: Math53/Lecture5.canvas (或含有 FILE 节点的任意 Canvas)
节点: kp01 (type=file, file=KP01-Level-Set定义.md)
操作: 右键点击 → 四层次解释 / 口语化解释

预期结果:
✅ 控制台显示: [Story 12.D.1] Read FILE node content: ...KP01-Level-Set定义.md, length: XXXX
✅ AI 生成内容包含 "Level Set" / "水平集" / "等高线" 相关主题
❌ AI 生成内容不包含 "Transformer" / "特征值" 等无关主题
```

**测试用例2: TEXT 类型节点 (回归)**
```
Canvas: 任意含有 TEXT 节点的 Canvas
节点: 任意 type=text 节点
操作: 右键点击 → 口语化解释

预期结果:
✅ 控制台显示: [DEBUG-CANVAS] Extracted TEXT node content: ...
✅ AI 生成内容与节点文本相关
✅ 功能与修改前完全一致
```

**测试用例3: FILE 不存在 (优雅降级)**
```
Canvas: 创建一个 FILE 节点指向不存在的文件
节点: type=file, file=不存在的文件.md
操作: 右键点击

预期结果:
✅ 控制台显示: [Story 12.D.1] File not found: 不存在的文件.md
✅ 不崩溃，菜单正常显示
✅ API 调用仍然发出（node_content 为空）
```

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-15 | 1.0 | Initial story creation | SM Agent (Bob) |

---

## Dev Agent Record

### Agent Model Used

(To be filled by Dev Agent)

### Debug Log References

(To be filled by Dev Agent)

### Completion Notes List

(To be filled by Dev Agent)

### File List

**Expected files to be modified**:
- `canvas-progress-tracker/obsidian-plugin/src/managers/ContextMenuManager.ts`

---

## QA Results

### Review Date: 2025-12-15

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**Overall: EXCELLENT** - Implementation is clean, well-documented, and follows all ADR constraints.

| Aspect | Rating | Notes |
|--------|--------|-------|
| Code Structure | ✅ Excellent | Clear separation of TEXT vs FILE handling |
| Error Handling | ✅ Excellent | Try/catch + graceful degradation |
| Documentation | ✅ Excellent | Source verification comments present |
| ADR Compliance | ✅ Full | Uses Vault API per ADR-0001 |

### Requirements Traceability (Given-When-Then)

| AC | Status | Implementation Evidence |
|----|--------|------------------------|
| AC1: FILE reads MD content | ✅ PASS | Lines 879-896: `getAbstractFileByPath()` + `cachedRead()` |
| AC2: TEXT unchanged | ✅ PASS | Lines 872-878: Same logic preserved |
| AC3: Graceful degradation | ✅ PASS | Lines 893-896: `console.warn` + `nodeContent = undefined` |
| AC4: Console log format | ✅ PASS | Line 888: `[Story 12.D.1] Read FILE node content: ${filePath}, length: ${nodeContent.length}` |

### Compliance Check

- Coding Standards: ✅ TypeScript best practices followed
- Project Structure: ✅ Modification in correct file
- Testing Strategy: ✅ Manual testing appropriate for UI interaction
- All ACs Met: ✅ All 4 acceptance criteria verified in code

### ADR Compliance Verification

| ADR | Requirement | Implementation | Status |
|-----|-------------|----------------|--------|
| ADR-0001 | Use Obsidian Vault API | `this.app.vault.cachedRead()` | ✅ |
| ADR-0001 | FILE path is relative | Used directly from `nodeInfo.nodeData.file` | ✅ |
| ADR-0001 | No Node.js fs API | No `fs` imports, Vault API only | ✅ |

### Technical Verification

| Check | Status | Evidence |
|-------|--------|----------|
| Method async | ✅ | Line 836: `private async handleCanvasNodeContextMenu` |
| TFile imported | ✅ | Line 15: `import { TFile } from 'obsidian'` |
| await used | ✅ | Line 887: `await this.app.vault.cachedRead()` |
| Error logged | ✅ | Line 890: `console.error()` |
| File not found logged | ✅ | Line 894: `console.warn()` |

### NFR Validation

| NFR | Status | Notes |
|-----|--------|-------|
| Security | ✅ PASS | Vault sandbox enforced, no external file access |
| Performance | ✅ PASS | Uses `cachedRead()` per Epic 12.D recommendation |
| Reliability | ✅ PASS | Graceful degradation on errors |
| Maintainability | ✅ PASS | Clear comments, source references |

### Test Architecture Assessment

- **Test Type**: Manual testing (appropriate for frontend UI)
- **Coverage**: All 3 test scenarios defined in story
- **Gaps**: None identified for this scope

### Improvements Checklist

- [x] FILE type handling added correctly
- [x] TEXT type regression preserved
- [x] Error handling implemented
- [x] Logging format matches AC4
- [x] Story 12.D.3 bonus logging added (lines 909-926)
- [ ] Future: Consider adding Playwright e2e test for canvas interactions

### Security Review

No security concerns. Implementation uses Obsidian Vault API which provides sandboxed file access within the vault only.

### Performance Considerations

Uses `cachedRead()` instead of `read()` for better performance, as recommended in Epic 12.D PRD.

### Files Modified During Review

No modifications made - implementation meets all requirements.

### Gate Status

**Gate: PASS** → `docs/qa/gates/12.D.1-file-node-support.yml`

### Recommended Status

**✅ Ready for Done** - All acceptance criteria met, code quality excellent, ADR compliant.

Manual testing required:
1. Test FILE node (kp01) → verify AI response mentions "Level Set"
2. Test TEXT node → verify regression
3. Test missing file → verify graceful degradation
