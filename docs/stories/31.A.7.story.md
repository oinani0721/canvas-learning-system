# Story 31.A.7: TTLCache ä¼šè¯å­˜å‚¨é™çº§é€æ˜åŒ–

## å…ƒæ•°æ®

| å±æ€§ | å€¼ |
|------|------|
| Story ID | 31.A.7 |
| EPIC | EPIC-31 - æ£€éªŒç™½æ¿æ™ºèƒ½å¼•å¯¼ç³»ç»Ÿ |
| ä¼˜å…ˆçº§ | P1 - High |
| çŠ¶æ€ | Done |
| æ¥æº | å¯¹æŠ—æ€§å®¡æ ¸ 2026-02-10 å‘ç° #1 (ğŸ”´ Severity) |
| ç±»å‹ | æŠ€æœ¯å€ºåŠ¡ / é™çº§é€æ˜åŒ– |

---

## 0. ä»£ç ç°å®æ£€æŸ¥ç»“æœ (2026-02-10)

> æœ¬ Story æ¥æºäºå¯¹æŠ—æ€§å®¡æ ¸å‘ç°ï¼šå›é¡¾æ–‡æ¡£å£°ç§° "âœ… ä¼šè¯è·¨è¿›ç¨‹æŒä¹…åŒ–ï¼ˆNeo4j ç›´æ¥ï¼‰"ï¼Œ
> ä½†å®é™…ä»£ç ä½¿ç”¨ `cachetools.TTLCache`ï¼ˆå†…å­˜å­˜å‚¨ï¼‰ï¼ŒæœåŠ¡é‡å¯ä¸¢å¤±æ‰€æœ‰ä¼šè¯ã€‚

### 0.1 å·²éªŒè¯çš„ä»£ç äº‹å®

| é¡¹ç›® | ä»£ç ä½ç½® | å®é™…æƒ…å†µ |
|------|---------|---------|
| ä¼šè¯å­˜å‚¨ | `verification_service.py:457` | `self._sessions: TTLCache = TTLCache(maxsize=500, ttl=3600)` |
| è¿›åº¦å­˜å‚¨ | `verification_service.py:459` | `self._progress: TTLCache = TTLCache(maxsize=500, ttl=3600)` |
| TTL | åŒä¸Š | 3600 ç§’ (1 å°æ—¶) åè‡ªåŠ¨è¿‡æœŸ |
| maxsize | åŒä¸Š | 500 ä¸ªä¼šè¯ä¸Šé™ï¼Œè¶…å‡º LRU æ·˜æ±° |
| æŒä¹…åŒ– | å…¨æ–‡æœç´¢ `persist\|save_session\|dump` | **ä¸å­˜åœ¨** â€” æ— ä»»ä½•æŒä¹…åŒ–ä»£ç  |
| é‡å¯è¡Œä¸º | ä»£ç åˆ†æ | æœåŠ¡é‡å¯ = æ‰€æœ‰ä¼šè¯ä¸¢å¤± |

### 0.2 å½“å‰æ—¥å¿—æƒ…å†µ

| äº‹ä»¶ | æ˜¯å¦æœ‰æ—¥å¿— | çº§åˆ« |
|------|----------|------|
| ä¼šè¯åˆ›å»º | âœ… æœ‰ | INFO |
| ä¼šè¯è¿‡æœŸ (TTL) | âœ… æœ‰ (Story 31.A.7) | WARNING |
| ä¼šè¯è¢« LRU æ·˜æ±° | âœ… æœ‰ (Story 31.A.7) | WARNING |
| æœåŠ¡å¯åŠ¨æ—¶å­˜å‚¨æ¨¡å¼å£°æ˜ | âœ… æœ‰ (Story 31.A.7) | WARNING |
| ç”¨æˆ·è®¿é—®å·²è¿‡æœŸä¼šè¯ | âœ… æœ‰ (Story 31.A.7) | WARNING |

---

## 1. é—®é¢˜æè¿°

### 1.1 æ ¸å¿ƒé—®é¢˜

VerificationService çš„ä¼šè¯å­˜å‚¨ä½¿ç”¨å†…å­˜ TTLCacheï¼Œå­˜åœ¨ä»¥ä¸‹**é™é»˜**é—®é¢˜ï¼š

1. **æœåŠ¡é‡å¯ä¸¢å¤±**: æ‰€æœ‰è¿›è¡Œä¸­çš„æ£€éªŒä¼šè¯åœ¨æœåŠ¡é‡å¯åæ¶ˆå¤±ï¼Œç”¨æˆ·æ”¶åˆ° "Session not found" é”™è¯¯ï¼Œæ²¡æœ‰ä»»ä½•é¢„è­¦
2. **TTL è¿‡æœŸé™é»˜**: ç”¨æˆ·ç¦»å¼€ 1 å°æ—¶åå›æ¥ï¼Œä¼šè¯å·²è¢« TTLCache æ¸…é™¤ï¼Œä½†æ²¡æœ‰æ—¥å¿—è®°å½•è¿‡æœŸäº‹ä»¶
3. **LRU æ·˜æ±°é™é»˜**: å½“å¹¶å‘ä¼šè¯è¶…è¿‡ 500 æ—¶ï¼Œæœ€æ—©çš„ä¼šè¯è¢«æ·˜æ±°ï¼Œæ²¡æœ‰æ—¥å¿—
4. **å›é¡¾æ–‡æ¡£å¹»è§‰**: åŸå›é¡¾å£°ç§° "Neo4j æŒä¹…åŒ–"ï¼Œå®é™…ä¸å­˜åœ¨ï¼Œè¯´æ˜å¼€å‘è€…è‡ªèº«ä¹Ÿä¸æ¸…æ¥šå­˜å‚¨çš„å±€é™æ€§

### 1.2 å½±å“èŒƒå›´

- **ç”¨æˆ·ä½“éªŒ**: é•¿æ—¶é—´æ£€éªŒä¼šè¯å¯èƒ½ä¸­é€”ä¸¢å¤±ï¼Œç”¨æˆ·éœ€è¦é‡æ–°å¼€å§‹
- **è¿ç»´å¯è§‚æµ‹æ€§**: æ— æ³•ä»æ—¥å¿—ä¸­äº†è§£ä¼šè¯å­˜å‚¨çš„å¥åº·çŠ¶æ€
- **æ–‡æ¡£å‡†ç¡®æ€§**: æ¶æ„æ–‡æ¡£ä¸å®é™…å®ç°ä¸ä¸€è‡´

---

## 2. ç›®æ ‡

åœ¨**ä¸æ”¹å˜å­˜å‚¨æ¶æ„**çš„å‰æä¸‹ï¼Œè®© TTLCache çš„å±€é™æ€§å¯¹å¼€å‘è€…å’Œè¿ç»´å®Œå…¨é€æ˜ï¼š

| ç›®æ ‡ | è¯´æ˜ |
|------|------|
| å¯åŠ¨æ—¥å¿— | æœåŠ¡å¯åŠ¨æ—¶æ˜ç¡®å£°æ˜å­˜å‚¨æ¨¡å¼å’Œé™åˆ¶ |
| è¿‡æœŸæ—¥å¿— | TTL è¿‡æœŸå’Œ LRU æ·˜æ±°æœ‰æ—¥å¿—è®°å½• |
| ä»£ç æ³¨é‡Š | å…³é”®ä½ç½®æœ‰æ¸…æ™°çš„æ¶æ„é™åˆ¶æ³¨é‡Š |
| API å“åº” | ä¼šè¯ç›¸å…³ API è¿”å›å­˜å‚¨ç±»å‹ä¿¡æ¯ï¼ˆå¯é€‰ï¼‰ |

---

## 3. éªŒæ”¶æ ‡å‡†

### AC-31.A.7.1: æœåŠ¡å¯åŠ¨æ—¶å‘å‡ºå­˜å‚¨æ¨¡å¼è­¦å‘Šæ—¥å¿—

**ä¿®æ”¹æ–‡ä»¶**: `backend/app/services/verification_service.py`

**ä¿®æ”¹ä½ç½®**: `__init__` æ–¹æ³• (çº¦ L455-460)

**é¢„æœŸè¡Œä¸º**:
```python
logger.warning(
    "VerificationService using IN-MEMORY TTLCache for session storage "
    f"(maxsize={500}, ttl={3600}s). "
    "Sessions will be LOST on service restart. "
    "This is a known limitation â€” see Story 31.A.7."
)
```

**éªŒæ”¶æ¡ä»¶**:
- [x] æœåŠ¡å¯åŠ¨æ—¶åœ¨æ—¥å¿—ä¸­è¾“å‡º WARNING çº§åˆ«çš„å­˜å‚¨æ¨¡å¼å£°æ˜
- [x] æ—¥å¿—åŒ…å« maxsizeã€ttlã€"will be LOST on restart" å…³é”®ä¿¡æ¯
- [x] ä»…åœ¨é¦–æ¬¡åˆå§‹åŒ–æ—¶è¾“å‡ºï¼ˆä¸é‡å¤ï¼‰

---

### AC-31.A.7.2: ä¼šè¯è¿‡æœŸ/æ·˜æ±°äº‹ä»¶æ—¥å¿—

**ä¿®æ”¹æ–‡ä»¶**: `backend/app/services/verification_service.py`

**æ–¹æ¡ˆ**: ä½¿ç”¨è‡ªå®šä¹‰ TTLCache å­ç±»æˆ–åœ¨å…³é”®è®¿é—®ç‚¹æ·»åŠ æ£€æµ‹

**é¢„æœŸè¡Œä¸º**:
```python
# åœ¨ pause_session / resume_session / get_progress / process_answer ä¸­ï¼Œ
# å½“ session_id not in self._sessions æ—¶ï¼ŒåŒºåˆ†"ä»æœªå­˜åœ¨"å’Œ"å·²è¿‡æœŸ"
if session_id not in self._sessions:
    logger.warning(
        f"Session {session_id} not found â€” may have expired (TTL=3600s) "
        "or been evicted (LRU maxsize=500). "
        "User will need to start a new session."
    )
    raise ValueError(f"Session not found: {session_id}")
```

**éªŒæ”¶æ¡ä»¶**:
- [x] è®¿é—®ä¸å­˜åœ¨çš„ä¼šè¯æ—¶ï¼Œæ—¥å¿— WARNING åŒ…å«å¯èƒ½çš„è¿‡æœŸ/æ·˜æ±°åŸå› 
- [x] æ—¥å¿—åŒ…å« TTL å’Œ maxsize å‚æ•°ï¼Œå¸®åŠ©è¿ç»´åˆ¤æ–­åŸå› 
- [x] ç°æœ‰ ValueError è¡Œä¸ºä¸å˜ï¼ˆå‘åå…¼å®¹ï¼‰

---

### AC-31.A.7.3: ä»£ç æ³¨é‡Šæ ‡æ³¨æ¶æ„é™åˆ¶

**ä¿®æ”¹æ–‡ä»¶**: `backend/app/services/verification_service.py`

**ä¿®æ”¹ä½ç½®**: `_sessions` å’Œ `_progress` å£°æ˜å¤„ (L456-459)

**é¢„æœŸå†…å®¹**:
```python
# âš ï¸ ARCHITECTURE LIMITATION (Story 31.A.7):
# Sessions are stored in-memory TTLCache. This means:
# 1. Service restart = ALL sessions lost (no persistence)
# 2. Sessions auto-expire after 3600s (1 hour) of inactivity
# 3. Max 500 concurrent sessions (LRU eviction beyond limit)
# 4. No cross-process sharing (single-instance only)
#
# This is a KNOWN LIMITATION, not a bug.
# Future improvement: Story 31.A.10 (Redis/DB persistence)
self._sessions: TTLCache = TTLCache(maxsize=500, ttl=3600)
self._progress: TTLCache = TTLCache(maxsize=500, ttl=3600)
```

**éªŒæ”¶æ¡ä»¶**:
- [x] `_sessions` å’Œ `_progress` å£°æ˜å¤„æœ‰å®Œæ•´çš„æ¶æ„é™åˆ¶æ³¨é‡Š
- [x] æ³¨é‡ŠåŒ…å« 4 ä¸ªå·²çŸ¥é™åˆ¶å’Œæœªæ¥æ”¹è¿›æŒ‡å‘

---

### AC-31.A.7.4: get_progress è¿”å›å­˜å‚¨ç±»å‹ä¿¡æ¯ï¼ˆå¯é€‰å¢å¼ºï¼‰

**ä¿®æ”¹æ–‡ä»¶**: `backend/app/services/verification_service.py`

**ä¿®æ”¹ä½ç½®**: `get_progress()` æ–¹æ³•è¿”å›å€¼

**é¢„æœŸè¡Œä¸º**: åœ¨ progress å“åº”ä¸­æ·»åŠ  `storage_info` å­—æ®µ:
```python
{
    "session_id": "...",
    "status": "in_progress",
    "total_concepts": 5,
    "completed_concepts": 2,
    "storage_info": {
        "type": "in_memory_ttl_cache",
        "ttl_seconds": 3600,
        "warning": "Session will expire after 1 hour of inactivity"
    }
}
```

**éªŒæ”¶æ¡ä»¶**:
- [x] `get_progress` è¿”å›åŒ…å« `storage_info` å­—æ®µ
- [x] å‰ç«¯å¯åˆ©ç”¨æ­¤å­—æ®µæé†’ç”¨æˆ·ä¼šè¯æœ‰æ•ˆæœŸ
- [x] ä¸å½±å“ç°æœ‰å­—æ®µï¼ˆå‘åå…¼å®¹ï¼‰

---

## 4. æŠ€æœ¯å®ç°

### 4.1 ä¿®æ”¹æ–‡ä»¶æ¸…å•

| æ–‡ä»¶ | ä¿®æ”¹ç±»å‹ | å·¥ä½œé‡ |
|------|---------|--------|
| `backend/app/services/verification_service.py` | ä¿®æ”¹ â€” æ·»åŠ æ—¥å¿—å’Œæ³¨é‡Š | ~30 è¡Œ |
| `backend/tests/unit/test_ttlcache_transparency.py` | æ–°å»º â€” é€æ˜åŒ–æµ‹è¯• | ~80 è¡Œ |

### 4.2 æµ‹è¯•è®¡åˆ’

```python
# test_ttlcache_transparency.py

class TestTTLCacheTransparency:
    """Story 31.A.7: TTLCache é€æ˜åŒ–æµ‹è¯•"""

    def test_startup_warning_logged(self, caplog):
        """AC-31.A.7.1: å¯åŠ¨æ—¶è¾“å‡º WARNING æ—¥å¿—"""
        with caplog.at_level(logging.WARNING):
            svc = VerificationService(canvas_base_path="/tmp")
        assert "IN-MEMORY TTLCache" in caplog.text
        assert "LOST on service restart" in caplog.text

    async def test_expired_session_warning(self, caplog, verification_service):
        """AC-31.A.7.2: è¿‡æœŸä¼šè¯æœ‰ WARNING æ—¥å¿—"""
        with caplog.at_level(logging.WARNING):
            with pytest.raises(ValueError, match="Session not found"):
                await verification_service.get_progress("expired-id")
        assert "may have expired" in caplog.text

    async def test_progress_includes_storage_info(self, verification_service, temp_canvas_file):
        """AC-31.A.7.4: progress åŒ…å« storage_info"""
        session = await verification_service.start_session(
            canvas_name="test", canvas_path=temp_canvas_file
        )
        progress = await verification_service.get_progress(session["session_id"])
        assert "storage_info" in progress
        assert progress["storage_info"]["type"] == "in_memory_ttl_cache"
```

---

## 5. é£é™©ä¸ç¼“è§£

| é£é™© | æ¦‚ç‡ | å½±å“ | ç¼“è§£æªæ–½ |
|------|------|------|---------|
| æ—¥å¿—å™ªéŸ³ | ä½ | ä½ | å¯åŠ¨ WARNING åªè¾“å‡ºä¸€æ¬¡ï¼›ä¼šè¯è¿‡æœŸ WARNING æ¯ä¼šè¯æœ€å¤šä¸€æ¬¡ |
| API å“åº”è†¨èƒ€ | ä½ | ä½ | `storage_info` æ˜¯å¯é€‰å¢å¼º (AC-31.A.7.4) |
| å‘åå…¼å®¹ | æ—  | æ—  | åªå¢åŠ æ—¥å¿—å’Œæ³¨é‡Šï¼Œä¸æ”¹å˜å­˜å‚¨è¡Œä¸º |

---

## 6. Definition of Done

- [x] AC-31.A.7.1: å¯åŠ¨ WARNING æ—¥å¿—åŒ…å«å­˜å‚¨æ¨¡å¼å’Œé™åˆ¶
- [x] AC-31.A.7.2: ä¼šè¯è¿‡æœŸ/æ·˜æ±°æœ‰ WARNING æ—¥å¿—
- [x] AC-31.A.7.3: ä»£ç æ³¨é‡Šæ ‡æ³¨ 4 ä¸ªæ¶æ„é™åˆ¶
- [x] AC-31.A.7.4 (å¯é€‰): `get_progress` è¿”å› `storage_info`
- [x] æ–°å¢æµ‹è¯•è¦†ç›– AC-31.A.7.1 ~ AC-31.A.7.4
- [x] ç°æœ‰æµ‹è¯•æ— å›å½’

---

## 7. ä¾èµ–å…³ç³»

```
31.A.7 TTLCache é€æ˜åŒ– (æœ¬ Story)
    â”œâ”€â”€ æ— å‰ç½®ä¾èµ–
    â””â”€â”€ åç»­: 31.A.10 (Redis/DB æŒä¹…åŒ– â€” Phase D æ¶æ„å€ºåŠ¡)
```

---

## Dev Agent Record

### Implementation Plan
- AC-31.A.7.3: åœ¨ `_sessions` å’Œ `_progress` å£°æ˜å¤„æ·»åŠ  ARCHITECTURE LIMITATION æ³¨é‡Š
- AC-31.A.7.1: åœ¨ `__init__` æœ«å°¾æ·»åŠ  `logger.warning()` å¯åŠ¨æ—¥å¿—
- AC-31.A.7.2: åˆ›å»º `_raise_session_not_found()` è¾…åŠ©æ–¹æ³•ï¼Œæ›¿æ¢æ‰€æœ‰ 6 å¤„ session-not-found æ£€æŸ¥ç‚¹
- AC-31.A.7.4: åœ¨ `get_progress()` è¿”å›å€¼ä¸­è¿½åŠ  `storage_info` å­—æ®µ

### Completion Notes
- æ‰€æœ‰ 4 ä¸ª AC å·²å®ç°å¹¶æµ‹è¯•é€šè¿‡
- ä½¿ç”¨ `_raise_session_not_found()` è¾…åŠ©æ–¹æ³•æ¶ˆé™¤é‡å¤ä»£ç ï¼Œ6 ä¸ªå…¥å£ç‚¹ç»Ÿä¸€ä½¿ç”¨
- 11 ä¸ªæ–°æµ‹è¯•å…¨éƒ¨é€šè¿‡ï¼Œ1721 ä¸ªç°æœ‰å•å…ƒæµ‹è¯•æ— å›å½’ï¼ˆ9 ä¸ªå¤±è´¥ä¸ºé¢„å…ˆå­˜åœ¨çš„ä¸ç›¸å…³æµ‹è¯•ï¼‰
- å®ç°å®Œå…¨å‘åå…¼å®¹ï¼šValueError è¡Œä¸ºä¸å˜ï¼Œä»…å¢åŠ æ—¥å¿— + æ³¨é‡Š + storage_info å­—æ®µ

### Code Review Fixes (2026-02-10)
- **H1 ä¿®å¤**: æå– `SESSION_TTL=3600` / `SESSION_MAXSIZE=500` ä¸ºæ¨¡å—å¸¸é‡ï¼Œæ¶ˆé™¤ 7+ å¤„ç¡¬ç¼–ç é­”æ³•æ•°å­—
- **H2 ä¿®å¤**: 5 ä¸ªæ–¹æ³•çš„ session æ£€æŸ¥ä» `_sessions` å•ç¼“å­˜æ”¹ä¸º `_sessions or _progress` åŒç¼“å­˜ä¸€è‡´æ€§æ£€æŸ¥ï¼Œé˜²æ­¢ KeyError
- **M1 ä¿®å¤**: `test_valueerror_backward_compatible` ä» deprecated `asyncio.get_event_loop().run_until_complete()` æ”¹ä¸º `@pytest.mark.asyncio` + `await`
- **M2 ä¿®å¤**: å¯åŠ¨æ—¥å¿—ä¸­æ— æ•ˆ f-string å‰ç¼€ç°åœ¨æ­£ç¡®ä½¿ç”¨å¸¸é‡æ’å€¼
- **M3 ä¿®å¤**: `_raise_session_not_found` è¿”å›ç±»å‹ä» `-> None` æ”¹ä¸º `-> NoReturn`
- **L1 ä¿®å¤**: æ¶æ„é™åˆ¶æ³¨é‡Šè¡¥å…… Story 31.A.10 å¼•ç”¨

## File List

| æ–‡ä»¶ | æ“ä½œ |
|------|------|
| `backend/app/services/verification_service.py` | ä¿®æ”¹ |
| `backend/tests/unit/test_ttlcache_transparency.py` | æ–°å»º |

## Change Log

| æ—¥æœŸ | å˜æ›´ |
|------|------|
| 2026-02-10 | Story 31.A.7 å®ç°å®Œæˆ â€” TTLCache é™çº§é€æ˜åŒ– (4 ACs, 11 tests) |
| 2026-02-10 | Code Review ä¿®å¤ â€” 2H/3M/1L issues fixed (å¸¸é‡æå–ã€åŒç¼“å­˜æ£€æŸ¥ã€deprecated APIã€NoReturn ç±»å‹) |

---

## ç‰ˆæœ¬å†å²

| ç‰ˆæœ¬ | æ—¥æœŸ | å˜æ›´ |
|------|------|------|
| 1.0 | 2026-02-10 | åˆå§‹åˆ›å»º â€” æ¥æºäºå¯¹æŠ—æ€§å®¡æ ¸å‘ç° #1 (å›é¡¾æ–‡æ¡£å¹»è§‰: TTLCache è¢«è¯¯ç§°ä¸º Neo4j æŒä¹…åŒ–) |
| 1.1 | 2026-02-10 | å®ç°å®Œæˆ â€” æ‰€æœ‰ 4 ACs å·²å®ç°ï¼Œ11 ä¸ªæµ‹è¯•é€šè¿‡ï¼ŒçŠ¶æ€æ›´æ–°ä¸º Review |
| 1.2 | 2026-02-10 | Code Review ä¿®å¤ â€” H1(å¸¸é‡æå–) H2(åŒç¼“å­˜æ£€æŸ¥) M1(deprecated API) M2(f-string) M3(NoReturn) L1(æ³¨é‡Šå¼•ç”¨) |
