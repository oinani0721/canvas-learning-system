# Story 6.3: 多模态内容存储架构

## Status
Completed

## Story

**As a** 系统开发者,
**I want** 设计统一的多模态存储架构,
**so that** 图片/PDF/音视频可以一致地存储和检索

## Epic Context

**Epic**: SCP-006 多模态文件关联
**Phase**: Phase 1 - 基础多模态支持
**Priority**: P0 (基础架构)
**Estimated Time**: 3天

## Dependencies

- ✅ Epic 12 (Agentic RAG) - LanceDB + Graphiti基础
- ✅ Story 12.2 (LanceDB POC) - 向量存储已验证
- ✅ Story 12.1 (Graphiti集成) - 知识图谱已就绪

## Acceptance Criteria

### AC 6.3.1: LanceDB表支持multimodal=True
- [x] 创建multimodal_content表
- [x] 支持768维向量存储
- [x] 支持多种media_type

### AC 6.3.2: Neo4j Schema包含多模态节点类型
- [x] 新增Media节点标签
- [x] 新增HAS_MEDIA关系类型
- [x] 新增ILLUSTRATES关系类型
- [x] 新增REFERENCES关系类型

### AC 6.3.3: 统一的MultimodalContent接口
- [x] 定义MediaType枚举 (IMAGE, PDF, AUDIO, VIDEO)
- [x] 定义MultimodalContent数据类
- [x] 实现store()和retrieve()方法

### AC 6.3.4: 文件存储路径规范化
- [x] 定义存储目录结构
- [x] 实现路径解析工具
- [x] 支持相对路径和绝对路径

## Tasks / Subtasks

- [x] Task 1: 创建MultimodalStore类 (AC: 6.3.1, 6.3.3)
  - [x] 初始化LanceDB multimodal表
  - [x] 实现store()方法
  - [x] 实现retrieve()方法
  - [x] 实现search()方法

- [x] Task 2: 设计Neo4j多模态Schema (AC: 6.3.2)
  - [x] 创建Media节点约束
  - [x] 定义关系类型
  - [x] 编写初始化Cypher脚本

- [x] Task 3: 实现统一接口 (AC: 6.3.3)
  - [x] 定义MediaType枚举
  - [x] 定义MultimodalContent dataclass
  - [x] 实现类型转换工具

- [x] Task 4: 文件路径管理 (AC: 6.3.4)
  - [x] 定义存储目录结构
  - [x] 实现PathResolver类
  - [x] 编写单元测试

## Dev Notes

### 技术栈

```yaml
向量存储:
  LanceDB:
    表名: multimodal_content
    向量维度: 768
    支持类型: image, pdf, audio, video

知识图谱:
  Neo4j/Graphiti:
    节点: Media
    关系: HAS_MEDIA, ILLUSTRATES, REFERENCES

文件存储:
  结构:
    .obsidian/plugins/canvas-review/
    ├── cache/
    │   ├── thumbnails/
    │   ├── extracted/
    │   └── vectors/
    └── media/
        ├── images/
        ├── pdfs/
        ├── audio/
        └── video/
```

### 代码位置

```
创建文件:
- src/agentic_rag/storage/multimodal_store.py
- src/agentic_rag/models/multimodal_content.py
- specs/data/multimodal-content.schema.json
- scripts/init_multimodal_schema.cypher

修改文件:
- src/agentic_rag/clients/graphiti_client.py (添加create_media_node)
- src/agentic_rag/clients/lancedb_client.py (添加multimodal表)

测试文件:
- src/tests/test_multimodal_store.py
```

### 核心数据模型

```python
from enum import Enum
from dataclasses import dataclass
from datetime import datetime

class MediaType(Enum):
    IMAGE = "image"
    PDF = "pdf"
    AUDIO = "audio"
    VIDEO = "video"

@dataclass
class MultimodalContent:
    """统一的多模态内容模型"""
    id: str
    media_type: MediaType
    file_path: str
    thumbnail_path: str | None
    extracted_text: str | None
    description: str | None  # AI生成的描述
    vector: list[float] | None  # 768维向量
    related_concept_id: str  # 关联的Canvas概念节点
    created_at: datetime
    metadata: dict  # 类型特定元数据
```

### LanceDB Schema

```python
import pyarrow as pa

MULTIMODAL_SCHEMA = pa.schema([
    pa.field("id", pa.string()),
    pa.field("media_type", pa.string()),
    pa.field("file_path", pa.string()),
    pa.field("extracted_text", pa.string()),
    pa.field("description", pa.string()),
    pa.field("vector", pa.list_(pa.float32(), 768)),
    pa.field("related_concept_id", pa.string()),
    pa.field("created_at", pa.timestamp("us")),
])
```

### Neo4j Schema

```cypher
// 创建约束
CREATE CONSTRAINT IF NOT EXISTS FOR (m:Media) REQUIRE m.id IS UNIQUE;

// 关系类型定义
// (Concept)-[:HAS_MEDIA {attached_at: datetime}]->(Media)
// (Media)-[:ILLUSTRATES {relevance: float}]->(Concept)
// (Media)-[:REFERENCES]->(Media)

// 示例查询
MATCH (c:Concept {id: $concept_id})-[:HAS_MEDIA]->(m:Media)
RETURN m.id, m.type, m.path
```

### JSON Schema (specs/data/multimodal-content.schema.json)

```json
{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "multimodal-content.schema.json",
  "title": "MultimodalContent",
  "type": "object",
  "required": ["id", "media_type", "file_path", "related_concept_id"],
  "properties": {
    "id": { "type": "string", "format": "uuid" },
    "media_type": { "enum": ["image", "pdf", "audio", "video"] },
    "file_path": { "type": "string" },
    "thumbnail_path": { "type": ["string", "null"] },
    "extracted_text": { "type": ["string", "null"] },
    "description": { "type": ["string", "null"] },
    "vector": {
      "type": ["array", "null"],
      "items": { "type": "number" },
      "minItems": 768,
      "maxItems": 768
    },
    "related_concept_id": { "type": "string" },
    "created_at": { "type": "string", "format": "date-time" },
    "metadata": { "type": "object" }
  }
}
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-30 | 1.0 | Initial Story Creation | SM Agent (Bob) |

## QA Results

### Review Date: 待开发

### Reviewed By: 待开发

### Test Results
待开发

---

**关联文档**:
- SCP-006-MULTIMODAL-ASSOCIATION.md
- SCP-006-IMPLEMENTATION-PLAN.md
- ADR-002-VECTOR-DATABASE-SELECTION.md (LanceDB选型)
