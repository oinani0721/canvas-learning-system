# Story 24.4: Multi-Review Trend Analysis and History Visualization

## Status
- [x] Draft
- [ ] Ready for Dev
- [ ] In Progress
- [ ] QA Review
- [ ] Done

---

## Epic Context & Background

**Epic ID**: EPIC-24
**Epic Title**: Verification Canvas Redesign
**Story Priority**: P1 (High)
**Estimated Points**: 5

**Epic Objective**: Redesign the verification canvas (检验白板) generation system to support dual review modes (fresh/targeted), integrate with Graphiti for history tracking, and improve the overall generation workflow.

**This Story's Role**: Story 24.4 implements the multi-review trend analysis endpoint that tracks progress across multiple verification canvas sessions for the same original canvas. This enables learners to visualize their improvement over time and identify weak concepts that need continued focus.

**Dependencies**:
- Story 24.1 (Mode Support in Generation Engine) - Provides mode metadata for trend analysis
- Story 24.2 (Single Review Progress Tracking) - Provides per-review progress data
- Story 24.3 (Sync Results) - Ensures review data is synced to Graphiti
- Epic 22 (Memory System) - Graphiti infrastructure

---

## Story Overview

**As a** Canvas Learning System learner,
**I want** to view trend analysis of my multiple verification canvas sessions for a specific original canvas,
**So that** I can understand my learning progress over time, identify weak concepts that need continued focus, and see quantitative evidence of my improvement.

---

## Acceptance Criteria

### AC1: Multi-Review Progress API Endpoint
- **Given**: The `/review/progress/multi/{original_canvas_path}` endpoint is implemented
- **When**: A request is made with a valid original canvas path
- **Then**: The system returns a list of all verification canvases generated from that original canvas with their individual progress data
- **Verification**: API response matches `MultiReviewProgressResponse` schema from specs/api/review-api.openapi.yml#L725-805

### AC2: Pass Rate Trend Data
- **Given**: Multiple verification canvases exist for an original canvas
- **When**: The trend analysis is requested
- **Then**: The response includes `pass_rate_trend` array with date and pass_rate for each review session
- **Verification**: Chart-ready data format (date, pass_rate) for frontend visualization

### AC3: Weak Concept Improvement Tracking
- **Given**: Historical review data exists in Graphiti
- **When**: The trend analysis is requested
- **Then**: The response includes `weak_concepts_improvement` array showing:
  - concept_name
  - improvement_rate (0-1 scale)
  - current_status (weak/improving/mastered)
- **Verification**: Graphiti query returns concept-level statistics; status transition logic validated

### AC4: Overall Progress Metrics
- **Given**: Multiple review sessions have been completed
- **When**: The trend analysis is requested
- **Then**: The response includes `overall_progress` object with:
  - progress_rate (0-1 scale)
  - trend_direction (up/stable/down)
- **Verification**: Progress rate calculation validated against known test data

### AC5: Graphiti Query for Historical Data
- **Given**: Review canvas relationships exist in Graphiti with `(ReviewCanvas)-[:GENERATED_FROM {mode}]->(OriginalCanvas)` pattern
- **When**: Multi-review analysis is requested
- **Then**: System queries Graphiti to find all related verification canvases and their review data
- **Verification**: Cypher query executes successfully; relationship traversal returns correct data

### AC6: Empty State Handling
- **Given**: No verification canvases exist for the requested original canvas
- **When**: Multi-review analysis is requested
- **Then**: System returns HTTP 404 with message "无检验历史" (No review history)
- **Verification**: Error response matches Error schema; appropriate status code returned

---

## Dev Notes (CRITICAL - Self-Contained)

### Technical Context

This story implements the `/review/progress/multi/{original_canvas_path}` endpoint that aggregates data from multiple verification canvas sessions. The implementation requires:

1. **Graphiti Integration**: Query historical review relationships
2. **Trend Calculation**: Aggregate pass rates across sessions
3. **Weak Concept Analysis**: Track concept-level improvement
4. **Progress Metrics**: Calculate overall learning trajectory

**Current State** (backend/app/api/v1/endpoints/review.py):
- Three endpoints exist: `/schedule`, `/generate`, `/record`
- No multi-review analysis endpoint
- No Graphiti integration for historical queries

**Target State**:
- New endpoint: `GET /review/progress/multi/{original_canvas_path}`
- Graphiti client integration for relationship queries
- Trend calculation service methods
- Chart-ready response format

### API Endpoint

**Endpoint**: `GET /review/progress/multi/{original_canvas_path}`
- **File**: `backend/app/api/v1/endpoints/review.py`
- **OpenAPI Spec**: `specs/api/review-api.openapi.yml#L346-378`

**Path Parameter**:
```yaml
original_canvas_path:
  type: string
  description: Original Canvas file path
  example: "离散数学.canvas"
```

**Response Schema** (from specs/api/review-api.openapi.yml#L725-805):
```yaml
MultiReviewProgressResponse:
  type: object
  required: [original_canvas_path, review_count, reviews]
  properties:
    original_canvas_path:
      type: string
    review_count:
      type: integer
    reviews:
      type: array
      items:
        type: object
        properties:
          review_canvas_path: string
          date: string (date-time)
          mode: enum [fresh, targeted]
          pass_rate: number
          total_concepts: integer
          passed_concepts: integer
    trends:
      type: object
      properties:
        pass_rate_trend: array
        weak_concepts_improvement: array
        overall_progress: object
```

### Data Models

**Response Schema**: `specs/api/review-api.openapi.yml#L725-805`
- Lines 725-736: Root response structure
- Lines 737-762: Individual review entries
- Lines 763-805: Trend analysis objects

**Review Progress Schema**: `specs/data/review-progress-response.schema.json`
- Used for individual review progress data

### SDD References

| Type | File | Lines | Description |
|------|------|-------|-------------|
| OpenAPI | specs/api/review-api.openapi.yml | L346-378 | Multi-review endpoint definition |
| OpenAPI | specs/api/review-api.openapi.yml | L725-805 | MultiReviewProgressResponse schema |
| Schema | specs/data/review-progress-response.schema.json | Full | Individual review progress |
| Behavior | specs/behavior/verification-canvas.feature | L96-105 | Historical review scenario |

### ADR References

| ADR | Description | Relevance |
|-----|-------------|-----------|
| docs/architecture/decisions/0003-graphiti-memory.md | Graphiti integration | Historical data queries, relationship traversal |
| docs/architecture/decisions/0002-langgraph-agents.md | LangGraph architecture | Agent coordination if needed |
| docs/architecture/decisions/0004-async-execution-engine.md | Async patterns | Service implementation patterns |

### Implementation Guidelines

**Step 1: Create Pydantic Models**
```python
# backend/app/models/review_models.py
from pydantic import BaseModel
from typing import List, Optional
from datetime import datetime
from enum import Enum

class TrendDirection(str, Enum):
    UP = "up"
    STABLE = "stable"
    DOWN = "down"

class ConceptStatus(str, Enum):
    WEAK = "weak"
    IMPROVING = "improving"
    MASTERED = "mastered"

class ReviewEntry(BaseModel):
    review_canvas_path: str
    date: datetime
    mode: str  # "fresh" or "targeted"
    pass_rate: float
    total_concepts: int
    passed_concepts: int

class PassRateTrend(BaseModel):
    date: str  # ISO date format
    pass_rate: float

class WeakConceptImprovement(BaseModel):
    concept_name: str
    improvement_rate: float  # 0-1 scale
    current_status: ConceptStatus

class OverallProgress(BaseModel):
    progress_rate: float  # 0-1 scale
    trend_direction: TrendDirection

class TrendAnalysis(BaseModel):
    pass_rate_trend: List[PassRateTrend]
    weak_concepts_improvement: List[WeakConceptImprovement]
    overall_progress: OverallProgress

class MultiReviewProgressResponse(BaseModel):
    original_canvas_path: str
    review_count: int
    reviews: List[ReviewEntry]
    trends: Optional[TrendAnalysis] = None
```

**Step 2: Add Graphiti Query Methods to ReviewService**
```python
# backend/app/services/review_service.py

async def get_multi_review_progress(
    self,
    original_canvas_path: str
) -> Dict[str, Any]:
    """
    Get multi-review trend analysis for an original canvas.

    Queries Graphiti for all verification canvases generated from
    this original canvas and calculates trend metrics.

    Args:
        original_canvas_path: Path to the original canvas file

    Returns:
        MultiReviewProgressResponse dict with reviews and trends

    Raises:
        CanvasNotFoundException: If no review history exists
    """
    # Query Graphiti for review relationships
    reviews = await self._query_review_history_from_graphiti(original_canvas_path)

    if not reviews:
        raise CanvasNotFoundException(f"No review history for: {original_canvas_path}")

    # Calculate trends
    trends = self._calculate_trend_analysis(reviews)

    return {
        "original_canvas_path": original_canvas_path,
        "review_count": len(reviews),
        "reviews": reviews,
        "trends": trends
    }

async def _query_review_history_from_graphiti(
    self,
    original_canvas_path: str
) -> List[Dict[str, Any]]:
    """
    Query Graphiti for all verification canvases linked to original.

    Cypher Query Pattern:
    MATCH (review:ReviewCanvas)-[r:GENERATED_FROM]->(original:Canvas {path: $path})
    RETURN review, r.mode, r.generated_at
    ORDER BY r.generated_at DESC
    """
    # ✅ Verified from Graphiti Skill (SKILL.md - Section: Cypher Queries)
    query = """
    MATCH (review:ReviewCanvas)-[r:GENERATED_FROM]->(original:Canvas)
    WHERE original.path = $canvas_path OR original.name = $canvas_path
    OPTIONAL MATCH (review)-[:CONTAINS]->(concept:Concept)-[:HAS_SCORE]->(score:Score)
    RETURN review.path AS review_canvas_path,
           r.generated_at AS date,
           r.mode AS mode,
           count(CASE WHEN score.value >= 60 THEN 1 END) AS passed_concepts,
           count(concept) AS total_concepts
    ORDER BY r.generated_at DESC
    """

    results = await self.graphiti_client.execute_query(
        query,
        {"canvas_path": original_canvas_path}
    )

    # Transform results to ReviewEntry format
    reviews = []
    for row in results:
        if row["total_concepts"] > 0:
            pass_rate = row["passed_concepts"] / row["total_concepts"]
        else:
            pass_rate = 0.0

        reviews.append({
            "review_canvas_path": row["review_canvas_path"],
            "date": row["date"],
            "mode": row["mode"] or "fresh",
            "pass_rate": pass_rate,
            "total_concepts": row["total_concepts"],
            "passed_concepts": row["passed_concepts"]
        })

    return reviews

def _calculate_trend_analysis(
    self,
    reviews: List[Dict[str, Any]]
) -> Dict[str, Any]:
    """
    Calculate trend metrics from review history.

    Includes:
    - pass_rate_trend: Time series of pass rates
    - weak_concepts_improvement: Per-concept improvement tracking
    - overall_progress: Aggregate progress metrics
    """
    if not reviews:
        return None

    # Pass rate trend (newest first, reverse for chronological)
    pass_rate_trend = [
        {"date": r["date"].split("T")[0], "pass_rate": r["pass_rate"]}
        for r in reversed(reviews)
    ]

    # Calculate overall progress
    if len(reviews) >= 2:
        first_pass_rate = reviews[-1]["pass_rate"]  # Oldest
        last_pass_rate = reviews[0]["pass_rate"]   # Newest
        progress_rate = last_pass_rate - first_pass_rate

        if progress_rate > 0.05:
            trend_direction = "up"
        elif progress_rate < -0.05:
            trend_direction = "down"
        else:
            trend_direction = "stable"
    else:
        progress_rate = 0.0
        trend_direction = "stable"

    return {
        "pass_rate_trend": pass_rate_trend,
        "weak_concepts_improvement": [],  # Populated by separate query
        "overall_progress": {
            "progress_rate": progress_rate,
            "trend_direction": trend_direction
        }
    }
```

**Step 3: Add API Endpoint**
```python
# backend/app/api/v1/endpoints/review.py

from app.models.review_models import MultiReviewProgressResponse

@review_router.get(
    "/progress/multi/{original_canvas_path:path}",
    response_model=MultiReviewProgressResponse,
    summary="Get multi-review trend analysis",
    operation_id="get_multi_review_progress",
    responses={
        404: {"model": ErrorResponse, "description": "No review history"}
    }
)
async def get_multi_review_progress(
    original_canvas_path: str
) -> MultiReviewProgressResponse:
    """
    Get trend analysis for multiple verification canvas sessions.

    Returns:
    - List of all verification canvases for this original canvas
    - Pass rate trend over time
    - Weak concept improvement tracking
    - Overall progress metrics

    [Source: specs/api/review-api.openapi.yml#L346-378]
    [Source: docs/prd/v118-检验白板历史关联与可选复习模式-2025-11-14-必读.md - FR4扩展]
    """
    try:
        result = await review_service.get_multi_review_progress(original_canvas_path)
        return MultiReviewProgressResponse(**result)
    except CanvasNotFoundException:
        return ErrorResponse(
            error="NoReviewHistoryError",
            message=f"无检验历史: {original_canvas_path}"
        )
```

**Step 4: Add Weak Concept Analysis**
```python
# backend/app/services/review_service.py

async def _query_weak_concepts_improvement(
    self,
    original_canvas_path: str
) -> List[Dict[str, Any]]:
    """
    Query Graphiti for weak concept improvement over time.

    Tracks concepts that were weak (score < 60) in early reviews
    and their current status.
    """
    # ✅ Verified from Graphiti Skill (SKILL.md - Section: Temporal Queries)
    query = """
    MATCH (review:ReviewCanvas)-[:GENERATED_FROM]->(original:Canvas)
    WHERE original.path = $canvas_path
    MATCH (review)-[:CONTAINS]->(concept:Concept)-[:HAS_SCORE]->(score:Score)
    WITH concept.name AS concept_name,
         collect({date: review.date, score: score.value}) AS scores
    WHERE size([s IN scores WHERE s.score < 60]) > 0
    RETURN concept_name,
           scores[0].score AS first_score,
           scores[-1].score AS last_score
    """

    results = await self.graphiti_client.execute_query(
        query,
        {"canvas_path": original_canvas_path}
    )

    improvements = []
    for row in results:
        first_score = row["first_score"] or 0
        last_score = row["last_score"] or 0
        improvement = (last_score - first_score) / 100  # Normalize to 0-1

        if last_score >= 80:
            status = "mastered"
        elif last_score > first_score:
            status = "improving"
        else:
            status = "weak"

        improvements.append({
            "concept_name": row["concept_name"],
            "improvement_rate": max(0, improvement),
            "current_status": status
        })

    return improvements
```

### Key Files to Modify

| File Path | Change Type | Description |
|-----------|-------------|-------------|
| `backend/app/models/review_models.py` | Create | Pydantic models for multi-review response |
| `backend/app/services/review_service.py` | Modify | Add get_multi_review_progress and helper methods |
| `backend/app/api/v1/endpoints/review.py` | Modify | Add multi-review endpoint |
| `src/tests/test_multi_review_progress.py` | Create | Test cases for multi-review functionality |

### Existing Code References

| Location | Line Range | Purpose |
|----------|------------|---------|
| backend/app/services/review_service.py | 90-100 | ReviewService class definition |
| backend/app/api/v1/endpoints/review.py | 1-50 | Existing imports and setup |
| backend/app/api/v1/endpoints/review.py | 173-214 | Existing endpoint pattern |
| specs/api/review-api.openapi.yml | 346-378 | Endpoint specification |
| specs/api/review-api.openapi.yml | 725-805 | Response schema |

### Graphiti Query Patterns

**Pattern 1: Find all review canvases for an original**
```cypher
MATCH (review:ReviewCanvas)-[r:GENERATED_FROM]->(original:Canvas)
WHERE original.path = $canvas_path
RETURN review, r
ORDER BY r.generated_at DESC
```

**Pattern 2: Get concept-level scores across reviews**
```cypher
MATCH (review:ReviewCanvas)-[:CONTAINS]->(concept:Concept)-[:HAS_SCORE]->(score:Score)
WHERE review.original_canvas_path = $canvas_path
RETURN concept.name, avg(score.value) AS avg_score, count(*) AS review_count
```

**Pattern 3: Get weak concept improvement**
```cypher
MATCH path = (earliest:ReviewCanvas)-[:GENERATED_FROM]->(original:Canvas)<-[:GENERATED_FROM]-(latest:ReviewCanvas)
WHERE original.path = $canvas_path
AND earliest.date < latest.date
MATCH (earliest)-[:CONTAINS]->(concept:Concept)-[:HAS_SCORE]->(early_score:Score)
MATCH (latest)-[:CONTAINS]->(concept)-[:HAS_SCORE]->(late_score:Score)
WHERE early_score.value < 60
RETURN concept.name,
       early_score.value AS first_score,
       late_score.value AS last_score,
       late_score.value - early_score.value AS improvement
```

---

## Testing Requirements

### Unit Tests

**Test File**: `src/tests/test_multi_review_progress.py`

```python
import pytest
from datetime import datetime, timedelta
from backend.app.services.review_service import ReviewService

class TestMultiReviewProgress:

    @pytest.mark.asyncio
    async def test_multi_review_returns_all_sessions(self, review_service, mock_graphiti):
        """AC1: Endpoint returns all verification canvases for original."""
        mock_graphiti.execute_query.return_value = [
            {
                "review_canvas_path": "离散数学-检验白板-20250115.canvas",
                "date": "2025-01-15T10:00:00Z",
                "mode": "fresh",
                "passed_concepts": 5,
                "total_concepts": 8
            },
            {
                "review_canvas_path": "离散数学-检验白板-20250118.canvas",
                "date": "2025-01-18T14:00:00Z",
                "mode": "targeted",
                "passed_concepts": 7,
                "total_concepts": 8
            }
        ]

        result = await review_service.get_multi_review_progress("离散数学.canvas")

        assert result["review_count"] == 2
        assert len(result["reviews"]) == 2
        assert result["reviews"][0]["mode"] == "targeted"  # Most recent first

    @pytest.mark.asyncio
    async def test_pass_rate_trend_calculation(self, review_service, mock_graphiti):
        """AC2: Pass rate trend data is chart-ready."""
        mock_graphiti.execute_query.return_value = [
            {"date": "2025-01-15T10:00:00Z", "passed_concepts": 5, "total_concepts": 10},
            {"date": "2025-01-18T10:00:00Z", "passed_concepts": 7, "total_concepts": 10},
            {"date": "2025-01-21T10:00:00Z", "passed_concepts": 9, "total_concepts": 10}
        ]

        result = await review_service.get_multi_review_progress("test.canvas")

        trend = result["trends"]["pass_rate_trend"]
        assert len(trend) == 3
        assert trend[0]["date"] == "2025-01-15"  # Chronological order
        assert trend[0]["pass_rate"] == 0.5
        assert trend[2]["pass_rate"] == 0.9

    @pytest.mark.asyncio
    async def test_weak_concept_improvement_tracking(self, review_service, mock_graphiti):
        """AC3: Weak concepts show improvement and status."""
        # Configure mock for weak concept query
        mock_graphiti.execute_query.side_effect = [
            # First call: review history
            [{"date": "2025-01-15", "passed_concepts": 5, "total_concepts": 10}],
            # Second call: weak concept improvement
            [
                {"concept_name": "逆否命题", "first_score": 45, "last_score": 85},
                {"concept_name": "集合运算", "first_score": 50, "last_score": 55}
            ]
        ]

        result = await review_service.get_multi_review_progress("test.canvas")

        weak_improvements = result["trends"]["weak_concepts_improvement"]
        assert len(weak_improvements) == 2
        assert weak_improvements[0]["current_status"] == "mastered"
        assert weak_improvements[1]["current_status"] == "improving"

    @pytest.mark.asyncio
    async def test_overall_progress_up_trend(self, review_service, mock_graphiti):
        """AC4: Overall progress correctly identifies upward trend."""
        mock_graphiti.execute_query.return_value = [
            {"date": "2025-01-21", "passed_concepts": 9, "total_concepts": 10},
            {"date": "2025-01-18", "passed_concepts": 7, "total_concepts": 10},
            {"date": "2025-01-15", "passed_concepts": 5, "total_concepts": 10}
        ]

        result = await review_service.get_multi_review_progress("test.canvas")

        overall = result["trends"]["overall_progress"]
        assert overall["trend_direction"] == "up"
        assert overall["progress_rate"] > 0

    @pytest.mark.asyncio
    async def test_graphiti_relationship_query(self, review_service, mock_graphiti):
        """AC5: Graphiti query uses correct relationship pattern."""
        await review_service.get_multi_review_progress("test.canvas")

        call_args = mock_graphiti.execute_query.call_args
        query = call_args[0][0]

        assert "GENERATED_FROM" in query
        assert "ReviewCanvas" in query
        assert "Canvas" in query

    @pytest.mark.asyncio
    async def test_no_history_returns_404(self, review_service, mock_graphiti):
        """AC6: Empty history returns 404 error."""
        mock_graphiti.execute_query.return_value = []

        with pytest.raises(CanvasNotFoundException) as exc_info:
            await review_service.get_multi_review_progress("nonexistent.canvas")

        assert "无检验历史" in str(exc_info.value) or "No review history" in str(exc_info.value)
```

### Integration Tests

**Test File**: `src/tests/integration/test_multi_review_integration.py`

```python
@pytest.mark.integration
async def test_full_multi_review_flow():
    """E2E test for multi-review trend analysis."""
    # Setup: Create original canvas with review history in Neo4j
    # Execute: Call GET /review/progress/multi/{path}
    # Verify: Response contains correct trend data
    pass

@pytest.mark.integration
async def test_multi_review_with_real_graphiti():
    """Integration test with real Graphiti connection."""
    # Requires Neo4j running
    pass
```

### API Contract Tests

**Test with Schemathesis**:
```bash
schemathesis run specs/api/review-api.openapi.yml --endpoint "/review/progress/multi"
```

---

## Dependencies

### Story Dependencies
- **Story 24.1** (Mode Support) - Required for mode metadata in reviews
- **Story 24.2** (Single Review Progress) - Provides per-review data
- **Story 24.3** (Sync Results) - Ensures data is in Graphiti

### Technical Dependencies
- Neo4j running for Graphiti queries
- Graphiti client available (`src/agentic_rag/clients/graphiti_client.py`)
- Existing ReviewService (`backend/app/services/review_service.py`)

### External Dependencies
- `neo4j>=5.0.0` - Graph database
- `graphiti-core>=0.6.0` - Knowledge graph SDK

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-13 | 1.0 | Initial draft - SM Agent automated batch mode | Bob (SM Agent) |

---

## Dev Agent Record

### Agent Model Used
*To be filled by Dev Agent*

### Debug Log References
*To be filled by Dev Agent*

### Completion Notes List
*To be filled by Dev Agent*

### File List
*To be filled by Dev Agent*

---

## QA Results

*Pending QA Agent review*

---

## Related Documentation

**Epic Documentation**:
- Epic 24: Verification Canvas Redesign

**PRD References**:
- docs/prd/v118-检验白板历史关联与可选复习模式-2025-11-14-必读.md - Core requirements (FR4扩展)
- docs/prd/FULL-PRD-REFERENCE.md - Epic 4, FR4

**Architecture Documentation**:
- docs/architecture/decisions/0003-graphiti-memory.md - Graphiti ADR
- docs/architecture/ebbinghaus-review-system-architecture.md - Review system design
- docs/architecture/EPIC-11-BACKEND-ARCHITECTURE.md - Backend layer structure

**API Specifications**:
- specs/api/review-api.openapi.yml#L346-378 - Endpoint specification
- specs/api/review-api.openapi.yml#L725-805 - Response schema

**Behavior Specifications**:
- specs/behavior/verification-canvas.feature#L96-105 - Historical review scenario

**Skills References**:
- .claude/skills/graphiti/SKILL.md - Graphiti documentation (Cypher queries, temporal queries)
