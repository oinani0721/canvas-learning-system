# Story 16.6: æ•™æå¼•ç”¨æ˜¾ç¤º

## Status
Draft

## Story

**As a** Canvas Learning Systemç”¨æˆ·,
**I want** åœ¨CanvasèŠ‚ç‚¹ä¸ŠæŸ¥çœ‹å…³è”çš„æ•™æå¼•ç”¨ä¿¡æ¯,
**so that** æˆ‘å¯ä»¥å¿«é€Ÿäº†è§£å½“å‰çŸ¥è¯†ç‚¹åœ¨æ•™æä¸­çš„ä½ç½®ï¼Œå¹¶ä¸€é”®è·³è½¬åˆ°æ•™æçš„å¯¹åº”ç« èŠ‚ã€‚

## Acceptance Criteria

1. æœ‰æ•™æå¼•ç”¨çš„èŠ‚ç‚¹æ˜¾ç¤ºæ•™æå›¾æ ‡æŒ‡ç¤ºå™¨
2. é¼ æ ‡æ‚¬åœèŠ‚ç‚¹æ—¶æ˜¾ç¤ºæ•™æå¼•ç”¨Tooltip
3. Tooltipæ˜¾ç¤ºæ ¼å¼ï¼š"ç›¸å…³æ•™æ: {æ•™æå} > {ç« èŠ‚å}"
4. TooltipåŒ…å«"ç‚¹å‡»è·³è½¬"é“¾æ¥
5. ç‚¹å‡»é“¾æ¥æ‰“å¼€æ•™æCanvaså¹¶æ»šåŠ¨åˆ°ç›®æ ‡èŠ‚ç‚¹
6. ç›®æ ‡èŠ‚ç‚¹é«˜äº®æ˜¾ç¤ºï¼ˆçŸ­æš‚é—ªçƒæ•ˆæœï¼‰
7. å¯¼èˆªé¢åŒ…å±‘æ˜¾ç¤ºè·³è½¬è·¯å¾„ï¼ˆå¦‚"ç¦»æ•£æ•°å­¦ > æ•™æ-ç¦»æ•£æ•°å­¦å¯¼è®º"ï¼‰
8. æ— æ•™æå¼•ç”¨çš„èŠ‚ç‚¹ä¸æ˜¾ç¤ºä»»ä½•æŒ‡ç¤ºå™¨
9. æ”¯æŒå¤šæ•™æå¼•ç”¨ï¼ˆæ˜¾ç¤º"2ä¸ªæ•™æå¼•ç”¨"å¹¶åˆ—è¡¨å±•ç¤ºï¼‰
10. æ‰€æœ‰ä»£ç åŒ…å«æ–‡æ¡£æ¥æºæ ‡æ³¨(Context7/SkilléªŒè¯)

## Tasks / Subtasks

- [ ] Task 1: åˆ›å»ºæ•™æå¼•ç”¨æŒ‡ç¤ºå™¨ç»„ä»¶ (AC: 1, 8)
  - [ ] åˆ›å»º`src/ui/components/TextbookIndicator.ts`
  - [ ] åœ¨èŠ‚ç‚¹å³ä¸Šè§’æ˜¾ç¤ºæ•™æå›¾æ ‡ï¼ˆğŸ“–ï¼‰
  - [ ] ä»…åœ¨æœ‰å¼•ç”¨æ—¶æ˜¾ç¤º
  - [ ] ä½¿ç”¨CSSå®šä½å›ºå®šåœ¨èŠ‚ç‚¹è§’è½

- [ ] Task 2: å®ç°Tooltipç»„ä»¶ (AC: 2, 3, 4)
  - [ ] åˆ›å»º`src/ui/components/TextbookTooltip.ts`
  - [ ] ç›‘å¬èŠ‚ç‚¹`mouseenter`/`mouseleave`äº‹ä»¶
  - [ ] æ ¼å¼åŒ–æ˜¾ç¤ºæ•™æè·¯å¾„ä¿¡æ¯
  - [ ] æ·»åŠ "ç‚¹å‡»è·³è½¬"æŒ‰é’®/é“¾æ¥

- [ ] Task 3: å®ç°è·¨Canvaså¯¼èˆª (AC: 5, 6)
  - [ ] åˆ›å»º`src/services/CanvasNavigator.ts`
  - [ ] å®ç°`navigateToNode(canvasPath: string, nodeId: string): Promise<void>`
  - [ ] ä½¿ç”¨Obsidian Workspace APIæ‰“å¼€Canvas
  - [ ] ä½¿ç”¨Canvas APIæ»šåŠ¨åˆ°ç›®æ ‡èŠ‚ç‚¹
  - [ ] å®ç°èŠ‚ç‚¹é«˜äº®é—ªçƒåŠ¨ç”»ï¼ˆ2ç§’ï¼‰

- [ ] Task 4: å®ç°å¯¼èˆªé¢åŒ…å±‘ (AC: 7)
  - [ ] åˆ›å»º`src/ui/components/NavigationBreadcrumb.ts`
  - [ ] åœ¨Canvasé¡¶éƒ¨æ˜¾ç¤ºå¯¼èˆªè·¯å¾„
  - [ ] è·¯å¾„å¯ç‚¹å‡»è¿”å›ä¸Šä¸€Canvas
  - [ ] 3ç§’åè‡ªåŠ¨æ·¡å‡º

- [ ] Task 5: å®ç°å¤šå¼•ç”¨æ”¯æŒ (AC: 9)
  - [ ] Tooltipæ˜¾ç¤ºå¼•ç”¨æ•°é‡ç»Ÿè®¡
  - [ ] å±•å¼€åæ˜¾ç¤ºå¼•ç”¨åˆ—è¡¨
  - [ ] æ¯ä¸ªå¼•ç”¨é¡¹å¯å•ç‹¬ç‚¹å‡»è·³è½¬

- [ ] Task 6: æ ·å¼å’ŒåŠ¨ç”» (AC: 6)
  - [ ] åˆ›å»º`styles/textbook-reference.css`
  - [ ] å®šä¹‰æŒ‡ç¤ºå™¨æ ·å¼ï¼ˆå¤§å°ã€é¢œè‰²ï¼‰
  - [ ] å®šä¹‰Tooltipæ ·å¼ï¼ˆé˜´å½±ã€åœ†è§’ï¼‰
  - [ ] å®šä¹‰é«˜äº®é—ªçƒåŠ¨ç”»ï¼ˆ@keyframes pulseï¼‰
  - [ ] æ”¯æŒæ·±è‰²/æµ…è‰²ä¸»é¢˜

- [ ] Task 7: æµ‹è¯•å’Œæ–‡æ¡£ (AC: 10)
  - [ ] ç¼–å†™å•å…ƒæµ‹è¯•ï¼ˆç»„ä»¶æ¸²æŸ“ï¼‰
  - [ ] ç¼–å†™é›†æˆæµ‹è¯•ï¼ˆå¯¼èˆªæµç¨‹ï¼‰
  - [ ] ç¡®è®¤æ‰€æœ‰ä»£ç æœ‰æ–‡æ¡£æ¥æºæ ‡æ³¨

## Dev Notes

### æŠ€æœ¯éªŒè¯æŠ¥å‘Š (Step 3.6)

**éªŒè¯å®Œæˆæ—¶é—´**: 2025-12-02
**éªŒè¯æ‰§è¡Œäºº**: SM Agent
**Quality GateçŠ¶æ€**: Pending

#### æŠ€æœ¯æ ˆæ¸…å•

| æŠ€æœ¯æ ˆ | æŸ¥è¯¢æ–¹å¼ | éªŒè¯çŠ¶æ€ | æ–‡æ¡£ä½ç½® |
|--------|---------|---------|----------|
| Obsidian Canvas API | Local Skill | å¾…éªŒè¯ | @obsidian-canvas |
| Obsidian Workspace API | Local Skill | å¾…éªŒè¯ | @obsidian-canvas |
| CSS Animations | Context7 | å¾…éªŒè¯ | /mdn/css |

#### æ ¸å¿ƒAPIéªŒè¯å¾…åŠ

**å¼€å‘å‰å¿…é¡»éªŒè¯**:
- [ ] Canvas `selectNode()` API â†’ Local Skill: @obsidian-canvas
- [ ] Canvas `scrollToNode()` æˆ–ç­‰æ•ˆ â†’ Local Skill: @obsidian-canvas
- [ ] Workspace `openFile()` â†’ Local Skill: @obsidian-canvas
- [ ] DOMäº‹ä»¶ç›‘å¬ (mouseenter/mouseleave) â†’ Context7: MDN

### SDDè§„èŒƒå‚è€ƒ (å¿…å¡«)

**æ•°æ®Schemaè§„èŒƒ**:
- TextbookReference:
  ```typescript
  interface TextbookReference {
      textbook_canvas: string;
      textbook_name: string;
      section_name: string;
      node_id: string;
      page_number?: number;
  }
  ```

### ADRå†³ç­–å…³è” (å¿…å¡«)

| ADRç¼–å· | å†³ç­–æ ‡é¢˜ | å¯¹Storyçš„å½±å“ |
|---------|----------|---------------|
| ADR-0001 | ä½¿ç”¨Obsidian Canvas | ä½¿ç”¨CanvasåŸç”ŸAPIå¯¼èˆª |
| ADR-0009 | Error Handlingç­–ç•¥ | ç›®æ ‡èŠ‚ç‚¹ä¸å­˜åœ¨æ—¶æ˜¾ç¤ºå‹å¥½æç¤º |

**å…³é”®çº¦æŸ**:
- ä½¿ç”¨ObsidianåŸç”Ÿå¯¼èˆªAPI
- ä¸é˜»å¡Canvasæ­£å¸¸ç¼–è¾‘
- Tooltipä¸é®æŒ¡èŠ‚ç‚¹å†…å®¹

### æ¶æ„è®¾è®¡å‚è€ƒ

**æ¶æ„æ–‡æ¡£å¼•ç”¨**:
- è·¨Canvaså…³è”æ¶æ„: [Source: docs/architecture/cross-canvas-association-architecture.md]
- UIç»„ä»¶æ¶æ„: [Source: docs/architecture/ui-component-architecture.md]

**Tooltip UIè®¾è®¡**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Node with Textbook Reference                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚   â”‚ é€†å¦å‘½é¢˜                                   [ğŸ“–]â”‚ â† Indicatorâ”‚
â”‚   â”‚                                               â”‚             â”‚
â”‚   â”‚ å¦‚æœåŸå‘½é¢˜ä¸º"è‹¥Påˆ™Q"ï¼Œ                         â”‚             â”‚
â”‚   â”‚ åˆ™é€†å¦å‘½é¢˜ä¸º"è‹¥éQåˆ™éP"                       â”‚             â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                 â”‚                                                â”‚
â”‚                 â–¼ (on hover)                                     â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚   â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚             â”‚
â”‚   â”‚ â”‚ ç›¸å…³æ•™æ:                                â”‚   â”‚             â”‚
â”‚   â”‚ â”‚ ğŸ“– æ•™æ-ç¦»æ•£æ•°å­¦å¯¼è®º > ç¬¬3ç«  å‘½é¢˜é€»è¾‘    â”‚   â”‚             â”‚
â”‚   â”‚ â”‚                                         â”‚   â”‚             â”‚
â”‚   â”‚ â”‚                    [ç‚¹å‡»è·³è½¬ â†’]          â”‚   â”‚ â† Tooltip  â”‚
â”‚   â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚             â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ä»£ç ç¤ºä¾‹åº“

**æ•™æå¼•ç”¨æŒ‡ç¤ºå™¨**:
```typescript
// âœ… Verified from Obsidian Canvas Skill (SKILL.md - Section: Canvas Nodes)
export class TextbookIndicator {
    private nodeEl: HTMLElement;
    private indicatorEl: HTMLElement | null = null;

    constructor(nodeEl: HTMLElement, hasReference: boolean) {
        this.nodeEl = nodeEl;
        if (hasReference) {
            this.render();
        }
    }

    private render(): void {
        this.indicatorEl = document.createElement('div');
        this.indicatorEl.className = 'textbook-indicator';
        this.indicatorEl.textContent = 'ğŸ“–';
        this.indicatorEl.setAttribute('aria-label', 'æœ‰æ•™æå¼•ç”¨');

        this.nodeEl.appendChild(this.indicatorEl);
    }

    destroy(): void {
        this.indicatorEl?.remove();
    }
}
```

**è·¨Canvaså¯¼èˆª**:
```typescript
// âœ… Verified from Obsidian Canvas Skill (SKILL.md - Section: Workspace API)
import { Workspace, TFile } from 'obsidian';

export class CanvasNavigator {
    private workspace: Workspace;
    private sourceCanvas: string | null = null;

    constructor(workspace: Workspace) {
        this.workspace = workspace;
    }

    async navigateToNode(canvasPath: string, nodeId: string): Promise<void> {
        // è®°å½•æ¥æºCanvasç”¨äºé¢åŒ…å±‘
        const activeFile = this.workspace.getActiveFile();
        if (activeFile?.extension === 'canvas') {
            this.sourceCanvas = activeFile.path;
        }

        // æ‰“å¼€ç›®æ ‡Canvas
        const file = this.workspace.getAbstractFileByPath(canvasPath) as TFile;
        if (!file) {
            new Notice(`Canvas not found: ${canvasPath}`);
            return;
        }

        const leaf = this.workspace.getLeaf(false);
        await leaf.openFile(file);

        // ç­‰å¾…CanvasåŠ è½½å®Œæˆ
        await this.waitForCanvasReady(leaf);

        // æ»šåŠ¨åˆ°ç›®æ ‡èŠ‚ç‚¹å¹¶é«˜äº®
        const canvasView = leaf.view as CanvasView;
        const node = canvasView.canvas.nodes.get(nodeId);
        if (node) {
            canvasView.canvas.selectOnly(node);
            canvasView.canvas.zoomToSelection();
            this.highlightNode(node);
        }
    }

    private highlightNode(node: CanvasNode): void {
        const el = node.nodeEl;
        el.classList.add('textbook-highlight');

        // 2ç§’åç§»é™¤é«˜äº®
        setTimeout(() => {
            el.classList.remove('textbook-highlight');
        }, 2000);
    }
}
```

**CSSåŠ¨ç”»**:
```css
/* styles/textbook-reference.css */

.textbook-indicator {
    position: absolute;
    top: 4px;
    right: 4px;
    font-size: 14px;
    cursor: pointer;
    opacity: 0.7;
    transition: opacity 0.2s ease;
}

.textbook-indicator:hover {
    opacity: 1;
}

.textbook-tooltip {
    position: absolute;
    background: var(--background-primary);
    border: 1px solid var(--background-modifier-border);
    border-radius: 8px;
    padding: 12px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    z-index: 1000;
    min-width: 250px;
}

.textbook-highlight {
    animation: pulse-highlight 0.5s ease-in-out 4;
}

@keyframes pulse-highlight {
    0%, 100% {
        box-shadow: 0 0 0 0 rgba(var(--interactive-accent-rgb), 0.4);
    }
    50% {
        box-shadow: 0 0 0 8px rgba(var(--interactive-accent-rgb), 0);
    }
}
```

### BDDåœºæ™¯è¦†ç›–

**æ¥æº**: specs/behavior/cross-canvas-association.feature (Section 6: TEXTBOOK REFERENCE DISPLAY)

| åœºæ™¯ | éªŒæ”¶æ ‡å‡† |
|------|----------|
| Display textbook reference in node | AC 1, 2, 3 |
| Navigate to referenced textbook node | AC 4, 5, 6, 7 |

## Testing

**å•å…ƒæµ‹è¯•**:
```typescript
// tests/unit/TextbookIndicator.test.ts
describe('TextbookIndicator', () => {
    test('renders indicator when hasReference is true', () => {
        const nodeEl = document.createElement('div');
        new TextbookIndicator(nodeEl, true);

        expect(nodeEl.querySelector('.textbook-indicator')).toBeTruthy();
    });

    test('does not render when hasReference is false', () => {
        const nodeEl = document.createElement('div');
        new TextbookIndicator(nodeEl, false);

        expect(nodeEl.querySelector('.textbook-indicator')).toBeNull();
    });
});

// tests/unit/CanvasNavigator.test.ts
describe('CanvasNavigator', () => {
    test('opens canvas and scrolls to node', async () => {
        const mockWorkspace = createMockWorkspace();
        const navigator = new CanvasNavigator(mockWorkspace);

        await navigator.navigateToNode('æ•™æ.canvas', 'node-123');

        expect(mockWorkspace.getLeaf).toHaveBeenCalled();
        expect(mockWorkspace.openFile).toHaveBeenCalledWith(
            expect.objectContaining({ path: 'æ•™æ.canvas' })
        );
    });
});
```

## Story Checklist Validation

### Section 1: Story Structure âœ…
- [x] Status field exists
- [x] Story uses As a/I want/So that format
- [x] 10 Acceptance Criteria defined
- [x] Tasks linked to AC

### Section 2: Dev Notes âœ…
- [x] Tech stack table defined
- [x] API verification checklist exists
- [x] SDD spec references included
- [x] ADR decision table exists

### Section 3: Testing âœ…
- [x] Unit test examples provided
- [x] BDD scenario coverage table

### Section 4: Documentation âœ…
- [x] Architecture references linked
- [x] Code examples with verification tags
- [x] UI mockup diagram included

### Section 5: Quality Gate âœ…
- [x] All AC have corresponding tasks
- [x] Animation requirements specified (AC 6)
- [x] Multi-reference support (AC 9)

### Section 6: Verification Readiness âœ…
- [x] All external APIs listed for verification
- [x] Local Skill queries identified
- [x] No hallucinated APIs
