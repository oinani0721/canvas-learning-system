# Story 33.12: Code Quality — sys.path Hack Removal + Magic Number Extraction

## Status: Done

---

## Story

**As a** Canvas Learning System maintainer,
**I want** the `sys.path.insert()` hack removed and magic confidence numbers extracted into named constants,
**so that** the codebase follows standard Python import practices and routing thresholds are self-documenting and configurable.

---

## Problem Statement

### Adversarial Audit Findings (2026-02-10)

| # | Finding | Severity | Location |
|---|---------|----------|----------|
| 1 | `intelligent_grouping_service.py:283-286` uses `sys.path.insert(0, ...)` to import `canvas_utils.py` from `src/` directory | P1 | `intelligent_grouping_service.py:283` |
| 2 | `agent_routing_engine.py` uses hardcoded confidence thresholds (0.85, 0.7, 0.6, 0.4, etc.) without named constants | P1 | `agent_routing_engine.py:287-333` |

### Root Cause Analysis

**#1 sys.path Hack**: `canvas_utils.py` lives in `src/` (the Obsidian plugin source tree), not in the `backend/app/` Python package. The grouping service needs `CanvasBusinessLogic.cluster_canvas_nodes()` from it. Rather than properly structuring the import, the developer used `sys.path.insert()` which:
- Pollutes the global module search path
- Can cause import conflicts with identically-named modules
- Makes the dependency invisible to tools (mypy, pylint, IDE)
- Breaks if the relative directory structure changes

**#2 Magic Numbers**: The routing engine uses many inline numeric constants for confidence scoring:
```python
base_confidence = 0.6 + (top_score * 0.3)    # Line 320
base_confidence += 0.15  # Clear dominance     # Line 324
base_confidence += 0.08  # Moderate dominance   # Line 326
base_confidence -= 0.05 * (...)                 # Line 331
max(min(base_confidence, 0.98), 0.4)           # Line 333
```
These thresholds are not discoverable, not configurable, and their purpose is only clear from inline comments.

---

## Acceptance Criteria

### AC-33.12.1: sys.path hack removed (P1)
- **Given** `intelligent_grouping_service.py` imports `CanvasBusinessLogic` from `src/canvas_utils.py`
- **When** the import is refactored
- **Then** `sys.path.insert()` is no longer used anywhere in `intelligent_grouping_service.py`
- **And** `CanvasBusinessLogic.cluster_canvas_nodes()` still works correctly
- **And** the import is visible to standard Python tooling

### AC-33.12.2: Confidence thresholds extracted to named constants (P1)
- **Given** `agent_routing_engine.py` uses inline numeric thresholds
- **When** the constants are extracted
- **Then** all confidence-related numbers are defined as module-level named constants
- **And** each constant has a descriptive name explaining its purpose
- **And** the routing behavior is unchanged

---

## Tasks / Subtasks

- [x] **Task 1**: Remove `sys.path.insert()` from `intelligent_grouping_service.py`
  - [x] Replace `sys.path.insert(0, str(src_path))` + `from canvas_utils import ...` with `importlib.util.spec_from_file_location()`
  - [x] Use `sys.modules` cache for test compatibility (monkeypatch fixtures)
  - [x] Verify all 11 `test_perform_clustering.py` tests pass
  - [x] Verify 2 integration tests in `test_batch_processing.py::TestGroupingServiceIntegration` pass

- [x] **Task 2**: Extract magic numbers in `agent_routing_engine.py`
  - [x] Define 25 module-level named constants for all confidence/scoring parameters
  - [x] Replace magic numbers in `_calculate_confidence()` with named constants
  - [x] Replace magic numbers in `_calculate_match_quality()` with named constants
  - [x] Replace magic numbers in `analyze_content()` pattern bonus with named constants
  - [x] Replace magic numbers in `route_single_node()` fallback confidence with named constants
  - [x] Replace magic numbers in `route_batch()` accuracy weights with named constants
  - [x] Update `__all__` exports with key new constants
  - [x] Verify all 58 routing engine unit tests pass
  - [x] Verify all 40 benchmark accuracy tests pass

- [x] **Task 3**: Regression verification
  - [x] `sys.path.insert` no longer appears in `intelligent_grouping_service.py`
  - [x] 109 total routing + grouping + benchmark tests pass
  - [x] 2 pre-existing failures in `TestRetryWorkflow` confirmed unrelated

---

## Technical Details

### Files to Modify

| File | Change | Priority |
|------|--------|----------|
| `backend/app/services/intelligent_grouping_service.py` | Replace `sys.path.insert()` with proper import | P1 |
| `backend/app/services/agent_routing_engine.py` | Extract magic numbers to named constants | P1 |

### Fix #1: sys.path Removal — Chosen Approach (Option C Enhanced)

Used `importlib.util.spec_from_file_location()` with `sys.modules` cache:
- `sys.path` is NOT modified — no global path pollution
- `sys.modules["canvas_utils"]` is used as cache — standard Python behavior
- Tests can still mock via `monkeypatch.setitem(sys.modules, "canvas_utils", ...)` — full backward compatibility
- `CanvasBusinessLogic` is loaded lazily from explicit file path — no path search ambiguity

### Fix #2: Named Constants (agent_routing_engine.py)

Extracted 25 module-level constants covering:
- Confidence scoring parameters (`CONFIDENCE_BASE`, `CONFIDENCE_SCORE_WEIGHT`, etc.)
- Dominance detection thresholds (`DOMINANCE_RATIO_HIGH`, `DOMINANCE_RATIO_MODERATE`)
- Competing pattern penalties (`COMPETING_SCORE_RATIO`, `COMPETING_THRESHOLD`)
- Match quality scoring (`MATCH_QUALITY_BASE`, `MATCH_QUALITY_*_BONUS`)
- Pattern count bonus (`PATTERN_COUNT_BONUS_PER_EXTRA`, `PATTERN_COUNT_BONUS_MAX`)
- Batch accuracy weights (`BATCH_ACCURACY_*_WEIGHT`)

---

## Test Plan

```bash
# 1. Verify clustering still works after import refactor
cd backend && python -m pytest tests/ -v -k "grouping or cluster"

# 2. Verify routing behavior unchanged
python -m pytest tests/ -v -k "routing"

# 3. Full regression
python -m pytest tests/ -v --timeout=120

# 4. Verify no sys.path.insert remains
grep -rn "sys.path.insert" backend/app/ --include="*.py"
# Expected: 0 hits in intelligent_grouping_service.py
```

---

## Definition of Done

- [x] `sys.path.insert()` removed from `intelligent_grouping_service.py`
- [x] `CanvasBusinessLogic.cluster_canvas_nodes()` works via importlib + sys.modules cache
- [x] All confidence thresholds in `agent_routing_engine.py` are named constants
- [x] Routing behavior is unchanged (same outputs for same inputs) — 58 unit + 40 benchmark tests pass
- [x] All existing tests pass (zero regressions introduced) — 109 related tests pass
- [x] No `sys.path.insert` calls remain in `intelligent_grouping_service.py`

---

## Dev Agent Record

### Implementation Plan
- **Fix #1**: Option C Enhanced — `importlib.util.spec_from_file_location()` with `sys.modules` cache. Chosen over Option A (extracting 3000+ line class is impractical) and Option B (modifying PYTHONPATH affects all imports globally).
- **Fix #2**: Comprehensive extraction of 25 constants covering all magic numbers in `_calculate_confidence()`, `_calculate_match_quality()`, `analyze_content()`, `route_single_node()`, and `route_batch()`.

### Debug Log
- Initial importlib approach without `sys.modules` cache broke test fixtures that mock via `monkeypatch.setitem(sys.modules, "canvas_utils", ...)`. Added `sys.modules` check-first pattern to maintain backward compatibility.
- Confirmed 2 pre-existing failures in `TestRetryWorkflow` (same failure with git stash, unrelated to this story).

### Completion Notes
- ✅ AC-33.12.1: `sys.path.insert()` completely removed from `intelligent_grouping_service.py`. Uses `importlib.util.spec_from_file_location()` + `sys.modules` cache.
- ✅ AC-33.12.2: All 25 magic numbers extracted to descriptive module-level constants in `agent_routing_engine.py`.
- ✅ 109 related tests pass (58 routing unit + 40 grouping unit + 11 benchmark accuracy).
- ✅ Zero regressions introduced.

---

## File List

| File | Action | Description |
|------|--------|-------------|
| `backend/app/services/intelligent_grouping_service.py` | Modified | Replaced `sys.path.insert()` with `importlib.util.spec_from_file_location()` + `sys.modules` cache + threading.Lock + cache poisoning protection |
| `backend/app/services/agent_routing_engine.py` | Modified | Extracted 29 magic numbers to module-level named constants (incl. ORAL_EXPLANATION_WEIGHT), complete __all__ exports |
| `docs/stories/33.12.story.md` | Modified | Updated status, tasks, dev record, change log |

---

## Change Log

| Date | Change | Author |
|------|--------|--------|
| 2026-02-10 | Story created from adversarial audit findings | PM |
| 2026-02-10 | Implemented: sys.path hack removed + magic numbers extracted. 109 tests pass, zero regressions. | Dev Agent |
| 2026-02-10 | Adversarial code review: 5 MEDIUM issues found and fixed — (1) sys.modules cache poisoning protection, (2) threading.Lock for thread-safe module loading, (3) extracted missed `weight: 0.9` to ORAL_EXPLANATION_WEIGHT, (4) clarifying comment for redundant MEDIUM/LOW thresholds, (5) complete __all__ exports (28 constants). 58 routing unit tests pass. | Code Review |
