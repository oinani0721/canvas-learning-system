# Story 34.9: 对抗性审查 P0 Hotfix — API 验证 + DI 对齐 + 测试可信度修复

## Status

**In Progress**

## Story

**As a** 开发者和学习者,
**I want** EPIC-34 对抗性审查发现的 P0 问题被修复：API 参数验证补全、模块级单例 DI 对齐、测试断言可信度恢复,
**so that** API 不再接受非法参数、CanvasService 获得完整依赖注入、测试结果真实反映系统健康状态

## 来源

本 Story 基于 EPIC-34 第二轮对抗性审查报告（2026-02-09）中发现的 6 个问题创建。
对应审查发现 #3, #4, #5, #6, #10, #12。

---

## Acceptance Criteria

### AC1: limit 参数添加 Query() 验证

**问题**: `review.py:678` 的 `limit: int = 5` 是裸参数，无 FastAPI Query() 约束。用户可传 `limit=-999` 或 `limit=99999999`。

**验收标准**:

```gherkin
Given GET /api/v1/review/history endpoint
When limit 参数被声明
Then limit 使用 Query(5, ge=1, le=100) 包装
And limit=0 返回 422 Validation Error
And limit=-1 返回 422 Validation Error
And limit=101 返回 422 Validation Error
And limit=50 返回 200
```

---

### AC2: show_all 参数添加 Query() 包装

**问题**: `show_all: bool = False` 缺少 Query() 包装，虽然布尔值风险较低但应保持一致性。

**验收标准**:

```gherkin
Given GET /api/v1/review/history endpoint
When show_all 参数被声明
Then show_all 使用 Query(False, description="...") 包装
```

---

### AC3: review.py 模块级单例注入 memory_client 到 CanvasService

**问题**: `review.py:99` 的 `_get_or_create_review_service()` 创建 `CanvasService(canvas_base_path=...)` 但未注入 `memory_client`，导致 EPIC-36 P0 修复的 edge sync 功能在此路径被静默跳过。

**验收标准**:

```gherkin
Given review.py 的 _get_or_create_review_service() 函数
When 创建 CanvasService 实例
Then memory_client 被注入（对齐 dependencies.py:get_canvas_service()）
And 如果 MemoryService 不可用 → memory_client=None（降级可接受）
And 降级时在日志中输出 WARNING
```

---

### AC4: 移除测试中接受 HTTP 500 的断言

**问题**: `test_review_history_pagination.py (unit):122` 使用 `assert response.status_code in [200, 500]`，将服务端崩溃视为合法行为。

**验收标准**:

```gherkin
Given 单元测试 test_endpoint_default_limit
When 断言 response.status_code
Then 仅接受 200（不接受 500）
```

---

### AC5: 移除条件断言（消除假阴性）

**问题**: `test_review_history_pagination.py (integration):354,389` 使用 `if data.get(...)` 包裹断言，条件为 False 时断言被跳过。

**验收标准**:

```gherkin
Given 集成测试中的 statistics 字段验证
When 验证 average_rating 和 by_canvas
Then 使用无条件断言（如果字段应该存在则 assert 而非 if/skip）
And 不使用 pytest.skip() 跳过核心验证逻辑
```

---

### AC6: 替换 date.today() 为固定常量

**问题**: `_build_card_states_for_history()` 已经使用固定日期 `date(2025, 6, 15)`（H3 fix），但如果有其他位置仍使用 `date.today()` 需要统一。验证并确保一致性。

**验收标准**:

```gherkin
Given 集成测试辅助函数 _build_card_states_for_history()
When 构建测试数据
Then 使用固定日期常量（不调用 date.today()）
And 文件中不存在非 mock 的 date.today() 调用
```

---

## Dev Agent Record

### 修改文件列表

| 文件 | 修改类型 | AC |
|------|---------|-----|
| `backend/app/api/v1/endpoints/review.py` | 修改 | AC1, AC2, AC3 |
| `backend/tests/unit/test_review_history_pagination.py` | 修改 | AC4 |
| `backend/tests/integration/test_review_history_pagination.py` | 修改 | AC5, AC6 |

### 测试验证

- 运行 `pytest backend/tests/unit/test_review_history_pagination.py -v`
- 运行 `pytest backend/tests/integration/test_review_history_pagination.py -v`
- 新增 limit 边界测试验证 422 返回
