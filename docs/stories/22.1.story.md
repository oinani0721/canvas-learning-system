# Story 22.1: Neo4j配置与连接

## Status
⏳ Ready for Development

## Story

**As a** 系统管理员,
**I want** 能够配置Neo4j数据库连接,
**so that** 系统能够存储和查询知识图谱数据。

## Acceptance Criteria

1. AC-22.1.1: config.py包含完整Neo4j配置 (URI, USERNAME, PASSWORD)
2. AC-22.1.2: .env.example包含Neo4j配置模板
3. AC-22.1.3: 启动时验证Neo4j连接
4. AC-22.1.4: 连接失败时有友好错误提示
5. AC-22.1.5: 支持连接池配置
6. AC-22.1.6: 单元测试覆盖Neo4jClient

## Tasks / Subtasks

- [ ] Task 1: 扩展config.py (AC: 1)
  - [ ] 添加NEO4J_URI配置项
  - [ ] 添加NEO4J_USERNAME配置项
  - [ ] 添加NEO4J_PASSWORD配置项
  - [ ] 添加NEO4J_DATABASE配置项
  - [ ] 添加NEO4J_MAX_POOL_SIZE配置项

- [ ] Task 2: 创建Neo4jClient类 (AC: 3, 4, 5)
  - [ ] 定义类结构和初始化方法
  - [ ] 实现verify_connectivity方法
  - [ ] 实现run_query方法
  - [ ] 添加连接池配置

- [ ] Task 3: 更新.env.example (AC: 2)
  - [ ] 添加Neo4j配置模板
  - [ ] 添加配置说明注释

- [ ] Task 4: 添加启动验证 (AC: 3, 4)
  - [ ] 在应用启动时验证连接
  - [ ] 实现友好错误提示
  - [ ] 添加日志记录

- [ ] Task 5: 编写单元测试 (AC: 6)
  - [ ] 测试配置加载
  - [ ] 测试连接验证
  - [ ] 测试查询执行
  - [ ] Mock Neo4j driver

## Dev Notes

### 架构上下文

**问题根因** [Source: docs/prd/EPIC-22-MEMORY-SYSTEM-NEO4J-GRAPHITI.md#问题分析]

Neo4j数据库配置和客户端不存在，导致无法存储知识图谱数据:

```
预期文件: backend/app/clients/neo4j_client.py
实际状态: 文件不存在

后果:
- 无法连接Neo4j数据库
- 无法存储用户-概念关系
- 记忆系统无法工作
```

### 实现参考

**config.py扩展** [Source: docs/prd/EPIC-22-MEMORY-SYSTEM-NEO4J-GRAPHITI.md#Story-22.1]

```python
# backend/app/config.py 新增

from pydantic import Field

class Settings(BaseSettings):
    # ... existing settings ...

    # Neo4j Configuration
    NEO4J_URI: str = Field(default="bolt://localhost:7687")
    NEO4J_USERNAME: str = Field(default="neo4j")
    NEO4J_PASSWORD: str = Field(default="")
    NEO4J_DATABASE: str = Field(default="neo4j")
    NEO4J_MAX_POOL_SIZE: int = Field(default=50)
```

**Neo4jClient实现**:

```python
# backend/app/clients/neo4j_client.py

from neo4j import AsyncGraphDatabase
from typing import Any, Dict, List, Optional
import logging

logger = logging.getLogger(__name__)

class Neo4jClient:
    """Neo4j异步客户端"""

    def __init__(
        self,
        uri: str,
        username: str,
        password: str,
        database: str = "neo4j",
        max_pool_size: int = 50
    ):
        self._driver = AsyncGraphDatabase.driver(
            uri,
            auth=(username, password),
            max_connection_pool_size=max_pool_size
        )
        self._database = database

    async def verify_connectivity(self) -> bool:
        """验证数据库连接"""
        try:
            await self._driver.verify_connectivity()
            logger.info("Neo4j connection verified successfully")
            return True
        except Exception as e:
            logger.error(f"Neo4j connection failed: {e}")
            return False

    async def run_query(
        self,
        query: str,
        **params
    ) -> List[Dict[str, Any]]:
        """执行Cypher查询"""
        async with self._driver.session(database=self._database) as session:
            result = await session.run(query, params)
            return [record.data() async for record in result]

    async def close(self):
        """关闭连接"""
        await self._driver.close()
```

**.env.example模板**:

```bash
# Neo4j Configuration
NEO4J_URI=bolt://localhost:7687
NEO4J_USERNAME=neo4j
NEO4J_PASSWORD=your_password_here
NEO4J_DATABASE=neo4j
NEO4J_MAX_POOL_SIZE=50
```

### 关键文件

- `backend/app/config.py` - 修改，添加Neo4j配置
- `backend/app/clients/neo4j_client.py` - 新增客户端
- `backend/app/clients/__init__.py` - 导出Neo4jClient
- `backend/.env.example` - 修改，添加配置模板
- `tests/unit/test_neo4j_client.py` - 新增测试文件

### 依赖安装

```bash
pip install neo4j>=5.0.0
```

### 测试要求

**单元测试覆盖**:
- 测试配置项加载
- 测试连接验证成功场景
- 测试连接失败错误处理
- 测试查询执行
- Mock AsyncGraphDatabase.driver

## SDD规范引用

- **架构文档**: `docs/prd/EPIC-22-MEMORY-SYSTEM-NEO4J-GRAPHITI.md#Neo4j知识图谱架构`
- **Neo4j文档**: Neo4j Python Driver官方文档

## ADR关联

- ADR-0005: 选择Neo4j作为知识图谱数据库 (如存在)

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-12 | 1.0 | 初始Story创建 | Manual Creation |
