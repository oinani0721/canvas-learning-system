# Story 21.5.6: 增量测试验证流程

## Status
✅ Done

## Story

**As a** 开发者,
**I want** 一个标准化的Agent端点测试脚本，能够快速测试所有Agent端点的可用性,
**so that** 每个Story完成后可立即验证功能正确性，快速定位问题。

## Acceptance Criteria

1. AC-21.5.6.1: 每个Story完成后可使用测试脚本立即测试
2. AC-21.5.6.2: 测试结果清晰显示成功(✅)/失败(❌)状态
3. AC-21.5.6.3: 失败时显示具体错误信息(HTTP状态码、错误详情)
4. AC-21.5.6.4: 支持测试单个端点或全部端点
5. AC-21.5.6.5: 测试脚本支持自定义base URL和verbose模式

## Tasks / Subtasks

- [x] Task 1: 创建测试脚本骨架 (AC: 1, 4)
  - [x] 创建 `scripts/test-agent-endpoint.py` 文件
  - [x] 实现命令行参数解析 (argparse)
  - [x] 定义端点映射字典 ENDPOINTS

- [x] Task 2: 实现单端点测试功能 (AC: 2, 3, 5)
  - [x] 实现 `test_endpoint()` 函数
  - [x] 使用 httpx 发送 POST 请求
  - [x] 解析响应状态码和JSON body
  - [x] 格式化输出成功/失败结果

- [x] Task 3: 实现批量测试功能 (AC: 1, 2, 4)
  - [x] 实现 `--all` 参数循环测试所有端点
  - [x] 汇总测试结果 (passed/total)
  - [x] 根据测试结果设置退出码

- [x] Task 4: 添加健康检查测试 (AC: 1)
  - [x] 测试 `/api/v1/health` 端点
  - [x] 测试 `/api/v1/health/ai` 端点 (如存在)
  - [x] 测试 `/api/v1/health/full` 端点 (如存在)

- [x] Task 5: 编写使用文档 (AC: 1)
  - [x] 在脚本头部添加使用说明
  - [x] 更新Epic文档中的测试命令

## Dev Notes

### 架构上下文

**Story定位** [Source: EPIC-21.5-AGENT-RELIABILITY-FIX.md#story-21-5-6]

此Story为Epic 21.5的最后一个Story，建立标准化的测试验证流程，确保前5个Story的修复可被快速验证。

**增量开发流程** [Source: EPIC-21.5-AGENT-RELIABILITY-FIX.md#开发模式]

```
1. SM创建Story → 用户确认
2. Dev实现代码
3. 构建后端: python start_server.py
4. 测试单个Agent端点: python scripts/test-agent-endpoint.py --endpoint memory
5. 测试所有端点: python scripts/test-agent-endpoint.py --all -v
6. 修复 → 重复测试直到通过
```

### SDD规范参考 (必填)

**API端点** (从OpenAPI specs):

| 端点 | 方法 | 规范来源 |
|------|------|----------|
| `/api/v1/agents/decompose/basic` | POST | `[Source: specs/api/fastapi-backend-api.openapi.yml#L267-L292]` |
| `/api/v1/agents/decompose/deep` | POST | `[Source: specs/api/fastapi-backend-api.openapi.yml#L293-L312]` |
| `/api/v1/agents/explain/oral` | POST | `[Source: specs/api/fastapi-backend-api.openapi.yml#L333-L352]` |
| `/api/v1/agents/explain/memory` | POST | `[Source: specs/api/fastapi-backend-api.openapi.yml#L393-L412]` |
| `/api/v1/agents/explain/four-level` | POST | `[Source: specs/api/fastapi-backend-api.openapi.yml#L413-L432]` |
| `/api/v1/health` | GET | `[Source: specs/api/fastapi-backend-api.openapi.yml#L50-L80]` |
| `/api/v1/health/ai` | GET | `[Source: EPIC-21.5 Story 21.5.4 - 新增端点]` |
| `/api/v1/health/full` | GET | `[Source: EPIC-21.5 Story 21.5.4 - 新增端点]` |

**请求Schema** [Source: specs/api/fastapi-backend-api.openapi.yml#DecomposeRequest]:
```yaml
DecomposeRequest:  # 同样适用于 ExplainRequest
  type: object
  required:
    - canvas_name
    - node_id
  properties:
    canvas_name:
      type: string
      description: Canvas文件名
    node_id:
      type: string
      description: 目标节点ID
```

**响应Schema** [Source: specs/api/agent-api.openapi.yml]:
```yaml
# 成功响应 (200)
AgentTaskResponse:
  type: object
  properties:
    task_id:
      type: string
    status:
      type: string
      enum: [pending, processing, completed, failed]

# 错误响应 (500) - Epic 21.5.1 新增
ErrorResponse:
  type: object
  properties:
    detail:
      type: string
    error_type:
      type: string
    bug_id:
      type: string  # Epic 21.5.3 新增
```

### ADR决策关联 (必填)

| ADR编号 | 决策标题 | 对Story的影响 |
|---------|----------|---------------|
| ADR-008 | Testing Framework - pytest Ecosystem | 使用httpx作为HTTP客户端进行端点测试 |
| ADR-009 | Error Handling and Retry Strategy | 错误码分类：1xxx LLM, 2xxx DB, 3xxx File, 4xxx Network, 5xxx Agent |

**关键约束** (从ADR Consequences提取):

1. **httpx客户端** [Source: ADR-008]:
   - 测试脚本使用 `httpx.post()` 发送请求
   - 设置合理的timeout (推荐30秒，Agent调用可能较慢)

2. **错误码解析** [Source: ADR-009]:
   - 5xxx错误表示Agent内部问题
   - 1xxx错误表示LLM Provider问题
   - 测试脚本应能区分不同类型的错误

### 实现参考代码

**端点映射** [Source: EPIC-21.5-AGENT-RELIABILITY-FIX.md#story-21-5-6]:
```python
ENDPOINTS = {
    "memory": "/api/v1/agents/explain/memory",
    "oral": "/api/v1/agents/explain/oral",
    "four-level": "/api/v1/agents/explain/four-level",
    "basic": "/api/v1/agents/decompose/basic",
    "deep": "/api/v1/agents/decompose/deep",
}
```

**测试请求payload**:
```python
payload = {
    "canvas_name": "test.canvas",
    "node_id": "test-node-001"
}
```

**输出格式**:
```
✅ memory: SUCCESS
✅ oral: SUCCESS
❌ basic: FAILED (500)
   Detail: {"error_type": "AIProviderError", "detail": "Rate limit exceeded"}

总计: 2/3 通过
```

### 关键文件

| 文件 | 用途 | 状态 |
|------|------|------|
| `scripts/test-agent-endpoint.py` | Agent端点测试脚本 | **新建** |
| `backend/app/api/v1/endpoints/health.py` | 健康检查端点 | 参考 |
| `backend/app/main.py` | CORS异常处理 | 依赖Story 21.5.1 |

### Testing

**测试文件位置**: `scripts/test-agent-endpoint.py` (本身即测试工具)

**测试标准** [Source: ADR-008]:
- 脚本应能作为独立工具运行
- 退出码: 0=全部通过, 1=有失败
- 支持CI/CD集成

**手动验证步骤**:
```bash
# 1. 启动后端
cd backend && python start_server.py

# 2. 测试单个端点
python scripts/test-agent-endpoint.py --endpoint memory -v

# 3. 测试所有端点
python scripts/test-agent-endpoint.py --all -v

# 4. 验证退出码
echo $?  # 应返回0(成功)或1(有失败)
```

**预期行为**:
- 后端未启动时: 显示连接错误
- 端点返回200: 显示 ✅ SUCCESS
- 端点返回4xx/5xx: 显示 ❌ FAILED + 详情
- verbose模式: 显示完整响应JSON

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-14 | 1.0 | 初始Story创建 | SM Agent (Bob) |

## QA Results

### Review Date: 2025-12-14

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**Overall: EXCELLENT** - The implementation significantly exceeds Story requirements.

The `scripts/test-agent-endpoint.py` script is a well-architected, production-quality test tool that:
- Follows Python best practices with proper type hints and docstrings
- Includes Windows Unicode handling for emoji output (lines 38-40)
- Implements clean separation of concerns (endpoint config, test functions, main entry)
- Provides comprehensive error handling with detailed user feedback
- Exceeds minimum requirements (11 agent endpoints vs 5 specified)

**Key Strengths**:
1. **ADR Compliance**: Full compliance with ADR-008 (httpx client) and ADR-009 (error classification)
2. **Source Attribution**: Every major code block includes `[Source: ...]` comments per project standards
3. **Error Handling**: Distinguishes connection errors, timeouts, and API errors per ADR-009
4. **Extensibility**: Modular design allows easy addition of new endpoints

### Refactoring Performed

No refactoring required - implementation is clean and well-structured.

### Requirements Traceability

| AC | Requirement | Test Coverage | Status |
|----|-------------|---------------|--------|
| AC-21.5.6.1 | Each Story completion can use test script immediately | `--all` flag tests all endpoints | ✅ PASS |
| AC-21.5.6.2 | Results show ✅/❌ status clearly | `print(f"  ✅ {name}: {message}")` (lines 174, 224) | ✅ PASS |
| AC-21.5.6.3 | Failures show HTTP status + error details | `msg = f"FAILED ({status_code})"` + bug_id (lines 136-138) | ✅ PASS |
| AC-21.5.6.4 | Supports single endpoint or all endpoints | `--endpoint` and `--all` flags (mutually exclusive group) | ✅ PASS |
| AC-21.5.6.5 | Supports custom base URL and verbose mode | `--base-url` and `--verbose` arguments (lines 326-336) | ✅ PASS |

**Given-When-Then Traceability**:

```gherkin
Feature: Agent Endpoint Testing

  Scenario: Test single endpoint successfully
    Given the backend server is running at http://localhost:8000
    When I run: python scripts/test-agent-endpoint.py --endpoint memory
    Then I see "✅ memory: SUCCESS"
    And exit code is 0

  Scenario: Test all endpoints with verbose output
    Given the backend server is running
    When I run: python scripts/test-agent-endpoint.py --all -v
    Then I see health check results section
    And I see agent endpoints results section
    And I see summary with passed/total count

  Scenario: Handle server not running
    Given the backend server is NOT running
    When I run: python scripts/test-agent-endpoint.py --endpoint memory
    Then I see "❌ memory: CONNECTION_ERROR (server not running?)"
    And exit code is 1
```

### Compliance Check

- Coding Standards: ✓ Full compliance - type hints, docstrings, proper imports
- Project Structure: ✓ Script in correct location `scripts/test-agent-endpoint.py`
- Testing Strategy: ✓ This IS the test tool; self-validates via --help
- All ACs Met: ✓ 5/5 Acceptance Criteria satisfied

### ADR Compliance Check

| ADR | Decision | Implementation | Status |
|-----|----------|----------------|--------|
| ADR-008 | Use httpx for HTTP client | `import httpx` (line 43), `httpx.Client` (line 356) | ✅ |
| ADR-008 | 30s timeout for agent calls | `DEFAULT_TIMEOUT = 30.0` (line 81) | ✅ |
| ADR-009 | Error code classification | Parses `error_type`, `bug_id` from response (lines 134-138) | ✅ |
| ADR-009 | 5xxx = Agent errors, 1xxx = LLM | Script displays error codes clearly | ✅ |

### Improvements Checklist

- [x] All acceptance criteria implemented
- [x] ADR-008 compliance (httpx + timeout)
- [x] ADR-009 compliance (error classification)
- [x] Windows Unicode handling
- [x] Comprehensive CLI help
- [ ] Consider adding JSON output mode for CI integration (enhancement, not required)
- [ ] Story status should be updated to "Review" (currently "Draft")
- [ ] Story tasks should be checked off as completed

### Security Review

**Status: PASS** - No security concerns.
- No authentication/authorization code
- No sensitive data handling
- No external dependencies with known vulnerabilities
- Read-only test operations

### Performance Considerations

**Status: PASS** - No performance concerns.
- 30s timeout appropriate for LLM-backed agents
- Sequential endpoint testing (appropriate for diagnostic tool)
- Minimal memory footprint

### Files Modified During Review

None - no modifications required.

### Gate Status

**Gate: PASS** → docs/qa/gates/21.5.6-incremental-test-validation.yml

**Risk Profile**: LOW
- No security-sensitive code
- Simple HTTP client tool
- Comprehensive error handling

**NFR Assessment**:
- Security: PASS (no sensitive operations)
- Performance: PASS (appropriate timeouts)
- Reliability: PASS (robust error handling)
- Maintainability: PASS (clean code, good docs)

### Recommended Status

**✅ Ready for Done**

The implementation is complete, well-documented, and exceeds requirements. Story owner should:
1. Update Story status from "Draft" to "Done"
2. Check off all tasks in the Tasks/Subtasks section
3. Update File List with `scripts/test-agent-endpoint.py`

**Note**: This is the final Story in Epic 21.5. Upon completion, the entire Epic can be marked as Done.
