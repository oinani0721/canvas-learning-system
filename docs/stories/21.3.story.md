# Story 21.3: ä¿®å¤explanation_textä¸ºç©ºé—®é¢˜

## Status
ğŸ”„ In Development

## Story

**As a** AgentæœåŠ¡,
**I want** å³ä½¿APIå“åº”æ ¼å¼ä¸å®Œå…¨åŒ¹é…ä¹Ÿèƒ½å°½æœ€å¤§åŠªåŠ›æå–æœ‰æ•ˆå†…å®¹,
**so that** ç”¨æˆ·å§‹ç»ˆèƒ½çœ‹åˆ°Agentçš„è¾“å‡ºã€‚

## Acceptance Criteria

1. AC-21.3.1: explanation_textæå–æœ‰å¤šé‡fallbackæœºåˆ¶
2. AC-21.3.2: æ¯æ¬¡æå–å¤±è´¥éƒ½æœ‰è¯¦ç»†æ—¥å¿—
3. AC-21.3.3: å¦‚æœæ‰€æœ‰æå–éƒ½å¤±è´¥ï¼Œè¿”å›å‹å¥½é”™è¯¯ä¿¡æ¯è€Œéç©ºç»“æœ
4. AC-21.3.4: æ·»åŠ responseæ ¼å¼éªŒè¯

## Tasks / Subtasks

- [ ] Task 1: é‡æ„explanation_textæå–é€»è¾‘ (AC: 1)
  - [ ] å®šä¹‰å¤šé‡æå–å™¨åˆ—è¡¨
  - [ ] å®ç°hasattræ£€æŸ¥æå–
  - [ ] å®ç°dict.getæå–
  - [ ] å®ç°contentå­—æ®µæå–
  - [ ] å®ç°str()æœ€ç»ˆfallback

- [ ] Task 2: æ·»åŠ è¯¦ç»†æ—¥å¿— (AC: 2)
  - [ ] è®°å½•ä½¿ç”¨çš„æå–å™¨ç´¢å¼•
  - [ ] è®°å½•æå–å¤±è´¥çš„åŸå› 
  - [ ] è®°å½•responseç±»å‹ä¿¡æ¯

- [ ] Task 3: å®ç°å‹å¥½é”™è¯¯å¤„ç† (AC: 3)
  - [ ] å®šä¹‰é”™è¯¯æ¶ˆæ¯æ¨¡æ¿
  - [ ] è¿”å›ç”¨æˆ·å‹å¥½çš„é”™è¯¯èŠ‚ç‚¹
  - [ ] è®°å½•å®Œæ•´é”™è¯¯ä¸Šä¸‹æ–‡

- [ ] Task 4: æ·»åŠ responseæ ¼å¼éªŒè¯ (AC: 4)
  - [ ] éªŒè¯responseéç©º
  - [ ] éªŒè¯responseç±»å‹
  - [ ] è®°å½•æ„å¤–æ ¼å¼

- [ ] Task 5: ç¼–å†™å•å…ƒæµ‹è¯•
  - [ ] æµ‹è¯•æ­£å¸¸å“åº”æå–
  - [ ] æµ‹è¯•dictå“åº”æå–
  - [ ] æµ‹è¯•fallbackæå–
  - [ ] æµ‹è¯•ç©ºå“åº”å¤„ç†

## Dev Notes

### æ¶æ„ä¸Šä¸‹æ–‡

**é—®é¢˜æ ¹å› ** [Source: docs/prd/EPIC-21-AGENT-E2E-FLOW-FIX.md#bug-8-agentä¸è¿”å›ç»“æœ]

```
Agent APIè¿”å›response
            â”‚
            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ agent_service.py:994-1008 - æå–explanation_text        â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚ explanation_text = ""                                   â”‚
â”‚ if hasattr(response, 'text'):                          â”‚
â”‚     explanation_text = response.text                    â”‚
â”‚ elif isinstance(response, dict):                        â”‚
â”‚     explanation_text = response.get('text', '')         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ agent_service.py:1036 - å…³é”®æ£€æŸ¥ç‚¹                       â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚ if explanation_text:  # â† å¦‚æœä¸ºç©ºï¼Œè·³è¿‡æ•´ä¸ªèŠ‚ç‚¹åˆ›å»º!    â”‚
â”‚     created_nodes.append({...})                         â”‚
â”‚     created_edges.append({...})                         â”‚
â”‚                                                         â”‚
â”‚ # å¦‚æœexplanation_textä¸ºç©ºï¼Œç›´æ¥è¿”å›ç©ºæ•°ç»„               â”‚
â”‚ return {                                                â”‚
â”‚     "created_nodes": [],   # â† ç©º!                      â”‚
â”‚     "created_edges": [],   # â† ç©º!                      â”‚
â”‚ }                                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å®ç°å‚è€ƒ

**å¤šé‡fallbackæå–å‡½æ•°** [Source: docs/prd/EPIC-21-AGENT-E2E-FLOW-FIX.md#story-21-3]

```python
# backend/app/services/agent_service.py

import logging
from typing import Any, Tuple

logger = logging.getLogger(__name__)

def extract_explanation_text(response: Any) -> Tuple[str, bool]:
    """
    æå–explanation_textï¼Œå¸¦å¤šé‡fallback

    Returns:
        (text, success) - textä¸ºæå–çš„å†…å®¹ï¼Œsuccessè¡¨ç¤ºæ˜¯å¦æˆåŠŸ
    """
    extractors = [
        # ä¼˜å…ˆçº§1: ç›´æ¥å±æ€§è®¿é—®
        lambda r: r.text if hasattr(r, 'text') and r.text else None,
        # ä¼˜å…ˆçº§2: dictçš„textå­—æ®µ
        lambda r: r.get('text') if isinstance(r, dict) else None,
        # ä¼˜å…ˆçº§3: dictçš„contentå­—æ®µ
        lambda r: r.get('content') if isinstance(r, dict) else None,
        # ä¼˜å…ˆçº§4: dictçš„responseå­—æ®µ
        lambda r: r.get('response') if isinstance(r, dict) else None,
        # ä¼˜å…ˆçº§5: dictçš„messageå­—æ®µ
        lambda r: r.get('message') if isinstance(r, dict) else None,
        # ä¼˜å…ˆçº§6: å­—ç¬¦ä¸²åŒ– (æœ€ç»ˆfallback)
        lambda r: str(r) if r else None,
    ]

    for i, extractor in enumerate(extractors):
        try:
            text = extractor(response)
            if text and text.strip():
                if i > 0:
                    logger.warning(
                        f"Used fallback extractor #{i} for response type: {type(response).__name__}"
                    )
                return text.strip(), True
        except Exception as e:
            logger.debug(f"Extractor #{i} failed: {e}")

    # æ‰€æœ‰æå–å™¨éƒ½å¤±è´¥
    logger.error(
        "All extractors failed",
        extra={
            "response_type": type(response).__name__,
            "response_preview": str(response)[:500] if response else "None"
        }
    )
    return "", False
```

**å‹å¥½é”™è¯¯å¤„ç†**:

```python
def create_error_response(
    error_message: str,
    source_node_id: str,
    agent_type: str
) -> Dict[str, Any]:
    """åˆ›å»ºå‹å¥½çš„é”™è¯¯å“åº”"""
    return {
        "created_nodes": [{
            "id": str(uuid.uuid4()),
            "type": "text",
            "text": f"âš ï¸ Agentå¤„ç†å¤±è´¥\n\n{error_message}\n\nè¯·é‡è¯•æˆ–è”ç³»æ”¯æŒã€‚",
            "color": "1",  # çº¢è‰²è¡¨ç¤ºé”™è¯¯
            "x": 0,
            "y": 0,
            "width": 400,
            "height": 150
        }],
        "created_edges": [],
        "error": True,
        "error_message": error_message,
        "agent_type": agent_type,
        "source_node_id": source_node_id
    }
```

**æ›´æ–°èŠ‚ç‚¹åˆ›å»ºé€»è¾‘**:

```python
# åŸæ¥çš„é€»è¾‘:
if explanation_text:
    created_nodes.append({...})

# ä¿®æ”¹åçš„é€»è¾‘:
explanation_text, success = extract_explanation_text(response)

if success and explanation_text:
    # æ­£å¸¸åˆ›å»ºèŠ‚ç‚¹
    created_nodes.append({...})
    created_edges.append({...})
else:
    # åˆ›å»ºé”™è¯¯æç¤ºèŠ‚ç‚¹
    error_response = create_error_response(
        error_message="æ— æ³•ä»Agentå“åº”ä¸­æå–å†…å®¹",
        source_node_id=source_node_id,
        agent_type=agent_type
    )
    return error_response
```

### å…³é”®æ–‡ä»¶

- `backend/app/services/agent_service.py` - ä¸»è¦ä¿®æ”¹ (lines 994-1036)
- `backend/tests/unit/test_text_extraction.py` - æ–°å¢æµ‹è¯•

### æµ‹è¯•è¦æ±‚

**å•å…ƒæµ‹è¯•è¦†ç›–**:
- æµ‹è¯•response.textå±æ€§æå–
- æµ‹è¯•dict['text']æå–
- æµ‹è¯•dict['content']æå–
- æµ‹è¯•str()fallback
- æµ‹è¯•Noneå“åº”
- æµ‹è¯•ç©ºå­—ç¬¦ä¸²å“åº”
- æµ‹è¯•é”™è¯¯å“åº”åˆ›å»º

## SDDè§„èŒƒå¼•ç”¨

- **æ¶æ„æ–‡æ¡£**: `docs/prd/EPIC-21-AGENT-E2E-FLOW-FIX.md#bug-8-agentä¸è¿”å›ç»“æœ`
- **ä»£ç ä½ç½®**: `backend/app/services/agent_service.py:994-1036`

## ADRå…³è”

æ— ç›´æ¥å…³è”çš„ADRã€‚æ­¤ Story ä¸º Bug Fixï¼Œä¸æ¶‰åŠæ¶æ„å†³ç­–å˜æ›´ã€‚

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-12 | 1.0 | åˆå§‹Storyåˆ›å»º | SM Agent (Bob) |
