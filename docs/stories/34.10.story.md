# Story 34.10: é›†æˆæµ‹è¯•å›å½’ä¿®å¤ + åˆ†é¡µè¯­ä¹‰æ–‡æ¡£åŒ– + DI è·¯å¾„æ•´ç†

<!-- Powered by BMAD Core -->

## Status

**Done** (2026-02-10) â€” 48/48 é›†æˆæµ‹è¯•æ¢å¤ PASSï¼ŒåŒå±‚åˆ†é¡µæ–‡æ¡£åŒ–ï¼ŒDI è·¯å¾„æ³¨é‡Šæ•´ç†

---

## Story

**As a** å¼€å‘è€…å’Œç»´æŠ¤è€…,
**I want** EPIC-34 çš„ 48 ä¸ªé›†æˆæµ‹è¯•æ¢å¤é€šè¿‡ã€å‰åç«¯åˆ†é¡µè¯­ä¹‰è¢«æ˜ç¡®æ–‡æ¡£åŒ–ã€ReviewService DI è·¯å¾„è¢«ç»Ÿä¸€,
**so that** æµ‹è¯•èƒ½çœŸå®åæ˜ ç³»ç»Ÿå¥åº·çŠ¶æ€ï¼Œæ–°å¼€å‘è€…èƒ½ç†è§£åˆ†é¡µæ¶æ„è®¾è®¡ï¼ŒDI è·¯å¾„ä¸å†æ˜¯ç»´æŠ¤éšæ‚£

## æ¥æº

æœ¬ Story åŸºäº EPIC-34 å¯¹æŠ—æ€§å®¡æŸ¥ (2026-02-10) ä¸­å‘ç°çš„ 3 é¡¹é—®é¢˜åˆ›å»ºï¼š
- Finding #1 (ğŸ”´): é›†æˆæµ‹è¯•æ–‡ä»¶ 48 ä¸ª ERROR â€” Story 38.9 DI é‡æ„æœªåŒæ­¥æ›´æ–°æµ‹è¯•
- Finding #4 (ğŸŸ¡): å‰ç«¯ `slice(0,7)` vs API `limit=5` è¯­ä¹‰ä¸ä¸€è‡´æœªæ–‡æ¡£åŒ–
- Finding #10 (ğŸŸ¡): review.py ç›´æ¥ import singleton vs dependencies.py Depends åŒè·¯å¾„

---

## Acceptance Criteria

### AC1: é›†æˆæµ‹è¯•å›å½’ä¿®å¤ â€” 48 ä¸ª ERROR æ¢å¤ä¸º PASS [P0]

**é—®é¢˜**: `backend/tests/integration/test_review_history_pagination.py` æ‰€æœ‰ 48 ä¸ªæµ‹è¯•å›  Story 38.9 DI é‡æ„è€ŒæŠ¥ `AttributeError: module 'app.api.v1.endpoints.review' has no attribute '_review_service_instance'`ã€‚

**æ ¹å› **:
- æµ‹è¯• Line 40: `REVIEW_SERVICE_PATCH = "app.api.v1.endpoints.review._get_or_create_review_service"` â€” å‡½æ•°å·²ä¸å­˜åœ¨
- æµ‹è¯• Line 47: `review_module._review_service_instance` â€” å±æ€§å·²ä¸å­˜åœ¨
- Story 38.9 å°† ReviewService é‡æ„ä¸º canonical singleton factoryï¼Œä½†æœªåŒæ­¥æ›´æ–°æ­¤æµ‹è¯•æ–‡ä»¶

**æ­£ç¡®æ¨¡å¼** (å·²åœ¨å…¶ä»–æµ‹è¯•æ–‡ä»¶ä¸­éªŒè¯):
- `tests/integration/review_history/conftest.py` â€” æ­£ç¡®ä½¿ç”¨ `reset_review_service_singleton()`
- `tests/integration/review_history/helpers.py` â€” æ­£ç¡® patch target `"app.api.v1.endpoints.review._get_review_service_singleton"`
- `tests/unit/test_fsrs_state_query.py` â€” åŒæ ·çš„æ­£ç¡®æ¨¡å¼

**éªŒæ”¶æ ‡å‡†**:

```gherkin
Given backend/tests/integration/test_review_history_pagination.py
When è¿è¡Œ pytest backend/tests/integration/test_review_history_pagination.py -v
Then 48/48 æµ‹è¯•å…¨éƒ¨ PASSï¼ˆ0 ERROR, 0 FAILï¼‰

And autouse fixture ä½¿ç”¨ reset_review_service_singleton() è€Œé _review_service_instance ç›´æ¥æ“ä½œ:
  - import from: app.services.review_service
  - è°ƒç”¨: reset_review_service_singleton()
  - å‚è€ƒ: tests/integration/review_history/conftest.py

And REVIEW_SERVICE_PATCH æ›´æ–°ä¸º:
  - "app.api.v1.endpoints.review._get_review_service_singleton"
  - å‚è€ƒ: tests/integration/review_history/helpers.py

And å›å½’æµ‹è¯•é€šè¿‡:
  - pytest backend/tests/unit/test_review_history_pagination.py â†’ å…¨ PASS
  - pytest backend/tests/unit/test_review_service_fsrs.py â†’ å…¨ PASS
```

**ä»£ç ä½ç½®**:
- ä¿®æ”¹: `backend/tests/integration/test_review_history_pagination.py` â€” Line 40 (REVIEW_SERVICE_PATCH) + Line 43-51 (autouse fixture)
- å‚è€ƒ: `backend/tests/integration/review_history/conftest.py` â€” æ­£ç¡®çš„ fixture æ¨¡å¼
- å‚è€ƒ: `backend/tests/integration/review_history/helpers.py` â€” æ­£ç¡®çš„ patch target

**åŸºç¡€è®¾æ–½ç»´åº¦ (D6 é›†æˆ)**:
- ä¿®å¤åæµ‹è¯•å¿…é¡»ä½¿ç”¨ä¸ç”Ÿäº§ä»£ç ä¸€è‡´çš„ DI æœºåˆ¶ï¼Œä¸èƒ½å¼•ç”¨å·²åºŸå¼ƒçš„å†…éƒ¨å±æ€§

---

### AC2: å‰åç«¯åˆ†é¡µè¯­ä¹‰æ–‡æ¡£åŒ– [P1]

**é—®é¢˜**: Story 34.4 AC1 å£°ç§°"é»˜è®¤æ˜¾ç¤ºæœ€è¿‘5æ¡"ï¼Œä½†å®é™…å­˜åœ¨ä¸¤å±‚ç‹¬ç«‹åˆ†é¡µï¼š
- **åç«¯ API**: `limit: int = Query(5, ge=1, le=100)` â€” æ§åˆ¶**è¿”å›çš„è®°å½•æ¡æ•°**
- **å‰ç«¯ UI**: `.slice(0, showAll ? undefined : 7)` â€” æ§åˆ¶**æ˜¾ç¤ºçš„æ—¥æœŸåˆ†ç»„æ•°**ï¼ˆ7å¤©ï¼‰

ä¸¤ä¸ªç»´åº¦ç‹¬ç«‹è¿ä½œï¼Œç”¨æˆ·æ”¹ API `limit` ä¸å½±å“å‰ç«¯æ˜¾ç¤ºçš„å¤©æ•°ï¼Œç”¨æˆ·ç‚¹"æ˜¾ç¤ºå…¨éƒ¨"åŒæ—¶è§£é™¤ä¸¤å±‚é™åˆ¶ã€‚

**éªŒæ”¶æ ‡å‡†**:

```gherkin
Given Story 34.4 çš„ Dev Notes æˆ– EPIC-34 æ–‡æ¡£
When å¼€å‘è€…æŸ¥é˜…åˆ†é¡µè®¾è®¡
Then æ–‡æ¡£ä¸­æ˜ç¡®è¯´æ˜åŒå±‚åˆ†é¡µæ¶æ„:
  - åç«¯å±‚: API limit å‚æ•°æ§åˆ¶è®°å½•æ¡æ•°ï¼ˆé»˜è®¤ 5ï¼‰
  - å‰ç«¯å±‚: slice(0, 7) æ§åˆ¶æ—¥æœŸåˆ†ç»„æ•°ï¼ˆé»˜è®¤ 7 å¤©ï¼‰
  - show_all=true åŒæ—¶è§£é™¤ä¸¤å±‚é™åˆ¶
  - total_count åæ˜ åç«¯çœŸå®æ€»æ•°ï¼Œä¸å—å‰ç«¯ slice å½±å“
```

**ä»£ç ä½ç½®**:
- ä¿®æ”¹: `docs/stories/34.4.story.md` â€” Dev Notes æ–°å¢"åŒå±‚åˆ†é¡µæ¶æ„è¯´æ˜"æ®µè½
- å‚è€ƒ: `backend/app/api/v1/endpoints/review.py:L626-L753` â€” API å±‚ limit
- å‚è€ƒ: `canvas-progress-tracker/obsidian-plugin/src/views/ReviewDashboardView.ts:L870` â€” å‰ç«¯å±‚ slice

---

### AC3: ReviewService DI è·¯å¾„æ•´ç† [P2 â€” å¯å»¶æœŸ]

**é—®é¢˜**: ReviewService å­˜åœ¨ä¸¤æ¡å¹¶è¡Œ DI è·¯å¾„ï¼š
- **è·¯å¾„ A (å®é™…ä½¿ç”¨)**: `review.py:L83` ç›´æ¥ `from app.services.review_service import get_review_service as _get_review_service_singleton`ï¼Œåœ¨ endpoint å†… `await _get_review_service_singleton()`
- **è·¯å¾„ B (æœªä½¿ç”¨)**: `dependencies.py:L272` å®šä¹‰ `get_review_service()` + `ReviewServiceDep = Annotated[ReviewService, Depends(get_review_service)]`

`ReviewServiceDep` åœ¨ review.py çš„æ‰€æœ‰ endpoint ä¸­**é›¶ä½¿ç”¨**ï¼ˆgrep éªŒè¯ï¼‰ã€‚å®ƒæ˜¯ Story 38.9 é‡æ„åçš„é—ç•™æ­»ä»£ç ã€‚

**éªŒæ”¶æ ‡å‡†**:

```gherkin
Given dependencies.py å’Œ review.py
When æ£€æŸ¥ ReviewService DI è·¯å¾„
Then æ»¡è¶³ä»¥ä¸‹ä¹‹ä¸€:
  é€‰é¡¹ A (æ¨è â€” æœ€å°å˜æ›´):
    - dependencies.py ä¿ç•™ get_review_service() ä¾›å…¶ä»– router ä½¿ç”¨
    - æ·»åŠ æ³¨é‡Šè¯´æ˜ review.py ä¸ºä½•ä¸ä½¿ç”¨ Depends() (å›  try/except éœ€æ±‚)
    - ReviewServiceDep å¦‚æœç¡®è®¤æ— ä½¿ç”¨è€…åˆ™åˆ é™¤

  é€‰é¡¹ B (å®Œæ•´é‡æ„ â€” å¦‚æœ‰ä½™åŠ›):
    - review.py æ‰€æœ‰ endpoint æ”¹ç”¨ Depends(get_review_service) æ³¨å…¥
    - ç§»é™¤ç›´æ¥ import _get_review_service_singleton
    - try/except é€»è¾‘ç§»åˆ° dependencies.py çš„ get_review_service() ä¸­
```

**ä»£ç ä½ç½®**:
- ä¿®æ”¹: `backend/app/dependencies.py` â€” æ·»åŠ æ³¨é‡Šæˆ–åˆ é™¤ ReviewServiceDep
- å¯èƒ½ä¿®æ”¹: `backend/app/api/v1/endpoints/review.py` â€” å¦‚é€‰æ‹©é€‰é¡¹ B

---

## Tasks / Subtasks

- [x] **Task 1: ä¿®å¤ autouse fixture** (AC: 1)
  - [x] 1.1 æ›¿æ¢ `_reset_review_service_singleton` fixtureï¼Œä½¿ç”¨ `reset_review_service_singleton()` from services å±‚
  - [x] 1.2 åˆ é™¤ `import app.api.v1.endpoints.review as review_module` å’Œ `_review_service_instance` å¼•ç”¨

- [x] **Task 2: ä¿®å¤ REVIEW_SERVICE_PATCH** (AC: 1)
  - [x] 2.1 å°† `"app.api.v1.endpoints.review._get_or_create_review_service"` æ”¹ä¸º `"app.api.v1.endpoints.review._get_review_service_singleton"`

- [x] **Task 2.5: ä¿®å¤ TestReviewServiceDICompleteness** (AC: 1 é¢å¤–å‘ç°)
  - [x] 2.5.1 `test_dependencies_get_review_service_passes_graphiti_client` â†’ æ”¹ä¸ºéªŒè¯ canonical singleton
  - [x] 2.5.2 `test_review_module_singleton_passes_graphiti_client` â†’ æ”¹ä¸ºéªŒè¯ dependencies å§”æ‰˜æ¨¡å¼

- [x] **Task 3: è¿è¡Œå…¨éƒ¨æµ‹è¯•éªŒè¯** (AC: 1)
  - [x] 3.1 `pytest backend/tests/integration/test_review_history_pagination.py -v` â†’ 48/48 PASS âœ…
  - [x] 3.2 `pytest backend/tests/unit/test_review_history_pagination.py -v` â†’ 17/17 PASS âœ…
  - [x] 3.3 `pytest backend/tests/unit/test_review_service_fsrs.py -v` â†’ 43/43 PASS âœ…
  - [x] 3.4 `pytest backend/tests/integration/test_review_singleton_di.py -v` â†’ 5/5 PASS âœ…
  - [x] æ€»è®¡: 113/113 PASS

- [x] **Task 4: åˆ†é¡µè¯­ä¹‰æ–‡æ¡£åŒ–** (AC: 2)
  - [x] 4.1 åœ¨ Story 34.4 Dev Notes ä¸­æ·»åŠ "åŒå±‚åˆ†é¡µæ¶æ„è¯´æ˜"æ®µè½
  - [x] 4.2 åœ¨ ReviewDashboardView.ts:L870 çš„ slice å¤„æ·»åŠ ä»£ç æ³¨é‡Š

- [x] **Task 5: DI è·¯å¾„æ•´ç†** (AC: 3, é€‰é¡¹ A â€” æœ€å°å˜æ›´)
  - [x] 5.1 ç¡®è®¤ ReviewServiceDep åœ¨æ•´ä¸ª codebase æ— ä¸šåŠ¡ä»£ç ä½¿ç”¨è€…ï¼ˆä»…å®šä¹‰+å¯¼å‡º+æµ‹è¯•ï¼‰
  - [x] 5.2 ä¿ç•™ ReviewServiceDepï¼Œåœ¨ dependencies.py æ·»åŠ æ³¨é‡Šè¯´æ˜ review.py ä¸ä½¿ç”¨çš„åŸå› 
  - [x] 5.3 åœ¨ review.py é¡¶éƒ¨æ·»åŠ æ³¨é‡Šè¯´æ˜ä¸ºä½•ç›´æ¥ import è€Œéä½¿ç”¨ Depends()

---

## Dev Notes

### SDD è§„èŒƒå‚è€ƒ (å¿…å¡«)

**æ­£ç¡®çš„ DI æ¨¡å¼** (Story 38.9 å®šä¹‰):

```python
# review_service.py â€” Canonical singleton factory
async def get_review_service() -> ReviewService:
    global _review_service_singleton
    if _review_service_singleton is not None:
        return _review_service_singleton
    async with _review_service_singleton_lock:
        if _review_service_singleton is not None:
            return _review_service_singleton
        _review_service_singleton = ReviewService(...)
        return _review_service_singleton

def reset_review_service_singleton() -> None:
    global _review_service_singleton
    _review_service_singleton = None
```

**æ­£ç¡®çš„æµ‹è¯• fixture æ¨¡å¼** (å·²éªŒè¯):

```python
# From tests/integration/review_history/conftest.py
@pytest.fixture(autouse=True)
def _reset_review_service_singleton():
    from app.services.review_service import reset_review_service_singleton
    reset_review_service_singleton()
    try:
        yield
    finally:
        reset_review_service_singleton()
```

**æ­£ç¡®çš„ patch target** (å·²éªŒè¯):

```python
# From tests/integration/review_history/helpers.py
REVIEW_SERVICE_PATCH = "app.api.v1.endpoints.review._get_review_service_singleton"
```

### ADR å†³ç­–å…³è” (å¿…å¡«)

| ADR ç¼–å· | å†³ç­–æ ‡é¢˜ | å¯¹ Story çš„å½±å“ |
|---------|----------|---------------|
| ADR-008 | Testing Framework (pytest) | æµ‹è¯• fixture å¿…é¡»ä½¿ç”¨ pytest æ ‡å‡† fixture æ¨¡å¼ |
| Story 38.9 | ReviewService Canonical Singleton | æ‰€æœ‰æµ‹è¯•å¿…é¡»ä½¿ç”¨ `reset_review_service_singleton()` éš”ç¦» |

### å¯¹æŠ—æ€§çº¦æŸ (Code Review æ—¶å¿…é¡»éªŒè¯)

1. **ç¦æ­¢å¼•ç”¨ `_review_service_instance`** â€” æ­¤å±æ€§å·²ä¸å­˜åœ¨ï¼Œä»»ä½•å¼•ç”¨éƒ½ä¼š AttributeError
2. **ç¦æ­¢å¼•ç”¨ `_get_or_create_review_service`** â€” æ­¤å‡½æ•°å·²ä¸å­˜åœ¨
3. **æµ‹è¯•å¿…é¡»å®é™…è¿è¡Œé€šè¿‡** â€” Code Review æ—¶å¿…é¡»æ‰§è¡Œ `pytest` å¹¶æˆªå–ç»“æœ
4. **ä¸æ”¹å˜æµ‹è¯•é€»è¾‘** â€” åªä¿®å¤ DI å¼•ç”¨ï¼Œä¸æ”¹å˜æµ‹è¯•çš„ä¸šåŠ¡æ–­è¨€

---

## ä¾èµ–å…³ç³»

**å‰ç½®ä¾èµ–**:
- âœ… Story 38.9 (ReviewService Canonical Singleton) â€” å·²å®Œæˆï¼Œå®šä¹‰äº†æ–°çš„ DI æ¨¡å¼
- âœ… Story 34.8/34.9 (å¯¹æŠ—æ€§ä¿®å¤) â€” å·²å®Œæˆï¼Œæµ‹è¯•å†…å®¹æœ¬èº«æ˜¯æ­£ç¡®çš„

**è¢«ä¾èµ–**:
- Wave 2 TEA è´¨é‡é—¨æ§ (`/bmad-tea-testarch-trace`, `/bmad-tea-testarch-test-review`) ä¾èµ–æœ¬ Story ä¿®å¤æµ‹è¯•åé‡æ–°è¯„ä¼°

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-10 | 0.1 | Initial draft â€” åŸºäºå¯¹æŠ—æ€§å®¡æŸ¥ Finding #1, #4, #10 åˆ›å»º | SM Agent (Bob) |
| 2026-02-10 | 1.0 | å…¨éƒ¨ AC å®ç°å®Œæˆ â€” 48 æµ‹è¯•æ¢å¤ PASS, æ–‡æ¡£åŒ–, DI æ³¨é‡Š | Dev Agent (Amelia) |

---

## Dev Agent Record

### Agent Model Used

Claude Opus 4.6 (claude-opus-4-6)

### Debug Log References

- AC1 ä¿®å¤: `test_review_history_pagination.py` Line 38-51 (fixture + patch target)
- AC1 é¢å¤–: `TestReviewServiceDICompleteness` ä¸¤ä¸ªæµ‹è¯•æ›´æ–°ä¸ºéªŒè¯ canonical singleton
- AC2 æ–‡æ¡£: `docs/stories/34.4.story.md` "åŒå±‚åˆ†é¡µæ¶æ„è¯´æ˜" æ®µè½
- AC2 ä»£ç æ³¨é‡Š: `ReviewDashboardView.ts:L870` slice æ³¨é‡Š
- AC3 æ³¨é‡Š: `dependencies.py:L299-304`, `review.py:L80-85`

### Completion Notes List

1. **Task 1+2 (AC1)**: ä¿®å¤ autouse fixture å’Œ REVIEW_SERVICE_PATCH å¼•ç”¨
2. **Task 2.5 (AC1 é¢å¤–)**: ä¿®å¤ TestReviewServiceDICompleteness ä¸­å¼•ç”¨å·²åºŸå¼ƒ `_get_or_create_review_service` çš„ 2 ä¸ªæµ‹è¯•
3. **Task 3 (AC1 éªŒè¯)**: 113/113 PASS (48 é›†æˆ + 17 å•å…ƒ + 43 FSRS + 5 singleton DI)
4. **Task 4 (AC2)**: Story 34.4 Dev Notes æ–°å¢"åŒå±‚åˆ†é¡µæ¶æ„è¯´æ˜"ï¼ŒReviewDashboardView.ts slice å¤„æ·»åŠ æ³¨é‡Š
5. **Task 5 (AC3)**: é€‰æ‹©é€‰é¡¹ A â€” ä¿ç•™ ReviewServiceDep + åŒä¾§æ³¨é‡Š

### File List

| File | Changes |
|------|---------|
| `backend/tests/integration/test_review_history_pagination.py` | ä¿®å¤ REVIEW_SERVICE_PATCH, autouse fixture, TestReviewServiceDICompleteness |
| `docs/stories/34.4.story.md` | æ–°å¢"åŒå±‚åˆ†é¡µæ¶æ„è¯´æ˜"æ®µè½ |
| `canvas-progress-tracker/obsidian-plugin/src/views/ReviewDashboardView.ts` | slice å¤„æ·»åŠ åŒå±‚åˆ†é¡µæ³¨é‡Š |
| `backend/app/dependencies.py` | ReviewServiceDep æ·»åŠ è¯´æ˜æ³¨é‡Š |
| `backend/app/api/v1/endpoints/review.py` | æ·»åŠ ç›´æ¥ import åŸå› æ³¨é‡Š |
