# Story 12.13: 回归测试

## Status: Draft

## Epic Context & Background

**所属Epic**: EPIC-12 - 三层记忆系统 + Agentic RAG
**Epic文档**: [EPIC-12-STORY-MAP.md](../epics/EPIC-12-STORY-MAP.md)

**本Story在Epic中的定位**:
- Phase 3 (Testing & Monitoring) 的回归验证Story
- 验证Epic 12集成后Epic 1-10核心功能无退化
- **依赖**: Story 12.10 (Canvas检验白板生成集成完成)
- **可并行**: Story 12.11, 12.12

**Epic核心问题回顾**:

### Problem 15: 功能退化风险
- **现象**: 新系统集成可能破坏现有Epic 1-10功能
- **根因**: 三层记忆系统引入新依赖，可能与现有代码冲突
- **修复**: 执行完整回归测试套件，确保360+测试全部通过
- **本Story验证**: 验证所有现有测试通过，无新增失败

### 关联EAC-6: Canvas集成无缝
- **要求**: Epic 4集成成功, 360+测试通过, E2E通过
- **本Story贡献**: 确保360+测试全部通过

### 关联EAC-9: 测试覆盖
- **要求**: 单元测试≥80%, 集成测试2场景, 回归测试360+
- **本Story贡献**: 回归测试360+通过验证

---

## Story

**As a** Canvas学习系统质量保证工程师,
**I want** 完整的回归测试验证,
**so that** 确保Epic 12集成后Epic 1-10所有核心功能正常工作，用户体验无退化

---

## Acceptance Criteria

### AC 1: Epic 1-5核心功能测试通过 (验证EAC-6)
- **测试范围**:
  - Epic 1: 基础学习系统 (红色节点拆解、AI解释生成)
  - Epic 2: 4维评分系统 (Accuracy/Imagery/Completeness/Originality)
  - Epic 3: 颜色流转机制 (红→紫→绿)
  - Epic 4: 检验白板生成 (12个测试)
  - Epic 5: 14 Agent协作系统
- **验证方式**: `pytest src/tests/ -k "epic1 or epic2 or epic3 or epic4 or epic5"` 全部通过
- **通过标准**: 0 failures, 0 errors

### AC 2: Epic 6-10核心功能测试通过 (验证EAC-6)
- **测试范围**:
  - Epic 6: Graphiti知识图谱集成
  - Epic 10: 异步并行执行引擎 (8x性能提升)
  - Epic 11: FastAPI后端基础架构
- **验证方式**: `pytest src/tests/ -k "epic6 or epic10 or epic11"` 全部通过
- **通过标准**: 0 failures, 0 errors

### AC 3: 360+测试全部通过 (验证EAC-9)
- **测试数量**: ≥360个测试用例
- **执行命令**: `pytest src/tests/ --tb=short -v`
- **通过标准**:
  - Pass Rate = 100%
  - 允许Skip (如环境依赖测试)，但不允许Fail
- **验证方式**: CI/CD pipeline报告

### AC 4: 无功能退化 (验证EAC-6)
- **对比基线**: Epic 12开发前的测试结果 (保存在`baseline_test_report.json`)
- **退化检测**:
  - 新增失败: 0
  - 性能退化: 关键路径延迟增加<10%
- **验证方式**:
  - `pytest --json-report --json-report-file=current_report.json`
  - 对比脚本: `python scripts/compare_test_reports.py baseline current`

### AC 5: 测试覆盖率维持 (验证EAC-9)
- **覆盖率目标**: ≥80% (与Epic 12开发前一致)
- **执行命令**: `pytest --cov=src --cov-report=html`
- **验证方式**: 覆盖率报告显示≥80%
- **注意**: 新增Epic 12代码不计入本AC，仅验证现有代码覆盖率

---

## Tasks / Subtasks

### 任务1: 准备测试环境 (AC: 1-5)
- [ ] 1.1: 确保所有依赖已安装
  ```bash
  pip install -r requirements.txt
  pip install pytest pytest-cov pytest-json-report pytest-asyncio
  ```
- [ ] 1.2: 验证数据库连接
  ```bash
  # Neo4j连接验证
  python -c "from neo4j import GraphDatabase; print('Neo4j OK')"

  # LanceDB验证
  python -c "import lancedb; print('LanceDB OK')"
  ```
- [ ] 1.3: 创建测试基线报告 (如不存在)
  ```bash
  pytest src/tests/ --json-report --json-report-file=baseline_test_report.json
  ```

### 任务2: 执行Epic 1-5回归测试 (AC: 1)
- [ ] 2.1: 运行Epic 1测试
  ```bash
  pytest src/tests/ -k "epic1" -v --tb=short
  ```
- [ ] 2.2: 运行Epic 2测试 (评分系统)
  ```bash
  pytest src/tests/ -k "scoring" -v --tb=short
  ```
- [ ] 2.3: 运行Epic 3测试 (颜色系统)
  ```bash
  pytest src/tests/ -k "color" -v --tb=short
  ```
- [ ] 2.4: 运行Epic 4测试 (检验白板)
  ```bash
  pytest src/tests/ -k "verification" -v --tb=short
  ```
- [ ] 2.5: 运行Epic 5测试 (Agent系统)
  ```bash
  pytest src/tests/ -k "agent" -v --tb=short
  ```
- [ ] 2.6: 记录结果到回归报告

### 任务3: 执行Epic 6-10回归测试 (AC: 2)
- [ ] 3.1: 运行Epic 6测试 (知识图谱)
  ```bash
  pytest src/tests/ -k "graphiti or knowledge_graph" -v --tb=short
  ```
- [ ] 3.2: 运行Epic 10测试 (并行执行)
  ```bash
  pytest src/tests/ -k "parallel or async" -v --tb=short
  ```
- [ ] 3.3: 运行Epic 11测试 (FastAPI)
  ```bash
  pytest backend/tests/ -v --tb=short
  ```
- [ ] 3.4: 记录结果到回归报告

### 任务4: 执行完整测试套件 (AC: 3)
- [ ] 4.1: 运行全部测试
  ```bash
  pytest src/tests/ backend/tests/ -v --tb=short --json-report --json-report-file=current_report.json
  ```
- [ ] 4.2: 验证测试数量≥360
  ```bash
  pytest src/tests/ backend/tests/ --collect-only | grep "test session starts"
  ```
- [ ] 4.3: 确认Pass Rate = 100% (允许Skip)

### 任务5: 退化检测和覆盖率验证 (AC: 4, 5)
- [ ] 5.1: 创建对比脚本 `scripts/compare_test_reports.py`
  ```python
  #!/usr/bin/env python3
  """测试报告对比脚本"""
  import json
  import sys

  def compare_reports(baseline_path: str, current_path: str) -> bool:
      """对比测试报告，检测退化"""
      with open(baseline_path) as f:
          baseline = json.load(f)
      with open(current_path) as f:
          current = json.load(f)

      baseline_passed = baseline.get("summary", {}).get("passed", 0)
      current_passed = current.get("summary", {}).get("passed", 0)

      baseline_failed = baseline.get("summary", {}).get("failed", 0)
      current_failed = current.get("summary", {}).get("failed", 0)

      print(f"Baseline: {baseline_passed} passed, {baseline_failed} failed")
      print(f"Current:  {current_passed} passed, {current_failed} failed")

      # 检测新增失败
      if current_failed > baseline_failed:
          print(f"REGRESSION DETECTED: {current_failed - baseline_failed} new failures!")
          return False

      print("No regression detected.")
      return True

  if __name__ == "__main__":
      if len(sys.argv) != 3:
          print("Usage: python compare_test_reports.py <baseline.json> <current.json>")
          sys.exit(1)

      success = compare_reports(sys.argv[1], sys.argv[2])
      sys.exit(0 if success else 1)
  ```
- [ ] 5.2: 运行对比脚本
  ```bash
  python scripts/compare_test_reports.py baseline_test_report.json current_report.json
  ```
- [ ] 5.3: 运行覆盖率测试
  ```bash
  pytest src/tests/ --cov=src --cov-report=html --cov-report=term
  ```
- [ ] 5.4: 验证覆盖率≥80%

### 任务6: 生成回归测试报告 (AC: 1-5)
- [ ] 6.1: 创建回归测试报告模板
- [ ] 6.2: 填写测试结果
- [ ] 6.3: 保存到 `docs/qa/regression-test-report-epic12.md`

---

## Dev Notes

### Dependencies Verification

**前置依赖验证** (必须先完成):
- [ ] **Story 12.10已完成**: Canvas检验白板生成集成完成
- [ ] **Epic 12核心功能可用**: 至少12.1-12.10完成

**技术栈依赖**:
- [ ] pytest >= 7.0.0
- [ ] pytest-cov >= 4.0.0
- [ ] pytest-json-report >= 1.5.0
- [ ] pytest-asyncio >= 0.21.0

### SDD规范参考 (必填)

**本Story特殊性说明**: 回归测试Story不涉及新API端点或数据模型开发，主要执行现有测试套件验证功能不退化。

**适用的SDD规范**:

| 规范类型 | 文件 | 说明 |
|----------|------|------|
| 测试配置 | `pytest.ini` | pytest配置标准 |
| 覆盖率配置 | `pyproject.toml` | 覆盖率≥80%要求 |
| 契约测试 | `specs/api/*.openapi.yml` | 回归测试包含契约验证 |

**测试执行标准** [Source: docs/architecture/coding-standards.md]:
```bash
# 标准测试执行
pytest src/tests/ -v --tb=short

# 带覆盖率
pytest src/tests/ --cov=src --cov-report=html --cov-fail-under=80

# 带JSON报告 (用于回归对比)
pytest src/tests/ --json-report --json-report-file=report.json
```

**回归测试专用标准** [Source: ADR-008]:
- 使用 `pytest-json-report` 生成机器可读报告
- 对比脚本验证无新增失败
- Pass Rate必须为100% (允许Skip)

### ADR决策关联 (必填)

| ADR编号 | 决策标题 | 对Story的影响 |
|---------|----------|---------------|
| ADR-008 | Testing Framework - pytest ecosystem | 使用pytest作为测试框架，pytest-cov计算覆盖率，pytest-json-report生成回归报告 |

**关键约束** [Source: ADR-008]:
1. **覆盖率目标**: ≥80% (`fail_under = 80`)
2. **并行执行**: 支持 `pytest-xdist` 并行 (`-n auto`)
3. **报告格式**: JSON格式便于自动化对比
4. **测试分类**: 使用markers区分 `unit`, `integration`, `contract`

**ADR-008核心决策摘要**:
- pytest生态系统作为核心测试框架
- Schemathesis用于契约测试
- pytest-xdist用于CI并行加速
- 80%覆盖率作为质量门禁

### Testing Standards

**测试文件位置**: `src/tests/`, `backend/tests/`

**测试类型**:
- 单元测试 (各Epic模块)
- 集成测试 (跨模块)
- 端到端测试 (E2E)

**预期测试分布**:
| Epic | 测试数量 | 位置 |
|------|----------|------|
| Epic 1-5 | ~200 | `src/tests/` |
| Epic 6 | ~30 | `src/tests/test_graphiti*.py` |
| Epic 10 | ~60 | `src/tests/test_parallel*.py`, `src/tests/test_async*.py` |
| Epic 11 | ~40 | `backend/tests/` |
| Epic 12 | ~30 | `src/tests/epic12/` (新增，不计入回归) |
| **总计** | **≥360** | - |

### Related Documentation

**Epic和Story文档**:
- [EPIC-12-STORY-MAP.md](../epics/EPIC-12-STORY-MAP.md) - Epic 12完整Story Map
- [12.10.story.md](./12.10.story.md) - Canvas检验白板生成集成 (前置依赖)
- [12.14.story.md](./12.14.story.md) - 性能基准测试 (后续Story)
- [12.15.story.md](./12.15.story.md) - E2E集成测试 (后续Story)

**QA文档**:
- [test-execution-guide.md](../test-execution-guide.md) - 测试执行指南
- [qa-gate-tmpl.yaml](../../.bmad-core/templates/qa-gate-tmpl.yaml) - QA门禁模板

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-28 | 1.0 | 初始创建 - SM Agent *draft | Bob (SM Agent) |
| 2025-11-28 | 1.1 | 补充SDD规范参考和ADR决策关联section (PO验证修复) | Sarah (PO Agent) |

---

## Dev Agent Record

### Agent Model Used
*待填写*

### Debug Log References
*待填写*

### Completion Notes List
*待填写*

### File List
*待填写*

---

## QA Results

### Review Date: 2025-11-29

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**Overall: PASS with CONCERNS** - Story 12.13回归测试设计合理，但需注意测试数量验证。

**优点**:
- ✅ AC 1-5 覆盖Epic 1-10全部功能
- ✅ 360+测试验证要求明确
- ✅ 退化检测脚本设计完整
- ✅ ADR-008测试框架引用正确
- ✅ 覆盖率目标≥80%

**关注点**:
- ⚠️ Epic 12新增测试不应计入回归基数
- ⚠️ 需确认baseline_test_report.json存在

### Requirements Traceability (Given-When-Then)

| AC | Given | When | Then | 覆盖 |
|----|-------|------|------|------|
| AC1 | Epic 1-5测试套件 | 执行pytest | 0 failures | ✅ |
| AC2 | Epic 6-10测试套件 | 执行pytest | 0 failures | ✅ |
| AC3 | 完整测试套件 | 执行pytest | ≥360 tests, 100% pass | ✅ |
| AC4 | Baseline报告 | 对比Current报告 | 无新增失败 | ✅ |
| AC5 | 代码覆盖率 | 执行pytest --cov | ≥80% | ✅ |

### Compliance Check

- Coding Standards: ✓ pytest规范正确
- Project Structure: ✓ 测试文件位置正确
- Testing Strategy: ✓ 符合ADR-008
- All ACs Met: ✓ 5个AC全部可验证
- ADR Compliance: ✓ ADR-008引用完整

### NFR Validation

| NFR | Status | Notes |
|-----|--------|-------|
| Security | ✅ PASS | N/A |
| Performance | ✅ PASS | 支持pytest-xdist并行 |
| Reliability | ✅ PASS | JSON报告可自动对比 |
| Maintainability | ✅ PASS | 脚本可复用 |

### Improvements Checklist

- [x] SDD规范参考已添加
- [x] ADR决策关联已添加
- [ ] **建议**: 添加CI/CD集成配置示例
- [ ] **注意**: 确保baseline报告在Epic 12开发前生成

### Gate Status

**Gate: PASS** → `docs/qa/gates/12.13-regression-tests.yml`

### Recommended Status

✅ **Ready for Done** - Story规格完整，可进入开发
