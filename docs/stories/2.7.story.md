# Story 2.7: æ™ºèƒ½èŠ‚ç‚¹å®šä½ç®—æ³•

## Status
Done

## Story

**As a** ç³»ç»Ÿ,
**I want** æ™ºèƒ½è®¡ç®—æ–°èŠ‚ç‚¹çš„ä½ç½®,
**so that** ç™½æ¿å¸ƒå±€æ•´æ´æ˜“è¯»ã€‚

## Acceptance Criteria

1. æ–°èŠ‚ç‚¹ä¸ä¸ç°æœ‰èŠ‚ç‚¹é‡å 
2. ç›¸åŒå…³ç³»ç±»å‹ä¿æŒä¸€è‡´å¸ƒå±€
3. å­é—®é¢˜çºµå‘æ’åˆ—
4. ä¸ªäººç†è§£æ¨ªå‘æ’åˆ—
5. å®šä½è®¡ç®—è€—æ—¶<50ms

## Tasks / Subtasks

- [x] Task 1: å®ç°æ™ºèƒ½å®šä½ç®—æ³•æ ¸å¿ƒå‡½æ•° (AC: 1, 2)
  - [x] åœ¨CanvasBusinessLogicç±»ä¸­å®ç°`calculate_smart_position()`æ–¹æ³•
  - [x] å®ç°relationship_typeå‚æ•°æ”¯æŒ("decomposition", "personal_understanding", "explanation")
  - [x] å®ç°é¿å…é‡å çš„æ£€æµ‹é€»è¾‘
  - [x] æ·»åŠ è¯¦ç»†çš„Google Styleæ–‡æ¡£å­—ç¬¦ä¸²

- [x] Task 2: å®ç°æ‹†è§£å­é—®é¢˜çš„çºµå‘æ’åˆ—é€»è¾‘ (AC: 3)
  - [x] è®¡ç®—æ‹†è§£å­é—®é¢˜çš„åŸºç¡€ä½ç½®ï¼ˆçˆ¶èŠ‚ç‚¹ä¸‹æ–¹ï¼‰
  - [x] å®ç°å¤šä¸ªå­èŠ‚ç‚¹æ¨ªå‘é”™å¼€é€»è¾‘
  - [x] ä½¿ç”¨VERTICAL_GAPå¸¸é‡æ§åˆ¶å‚ç›´é—´è·

- [x] Task 3: å®ç°ä¸ªäººç†è§£çš„æ¨ªå‘æ’åˆ—é€»è¾‘ (AC: 4)
  - [x] è®¡ç®—ä¸ªäººç†è§£èŠ‚ç‚¹çš„æ¨ªå‘ä½ç½®ï¼ˆçˆ¶èŠ‚ç‚¹å³ä¾§ï¼‰
  - [x] ä½¿ç”¨HORIZONTAL_GAPå¸¸é‡æ§åˆ¶æ°´å¹³é—´è·
  - [x] ç¡®ä¿ä¸v1.1å¸ƒå±€ç®—æ³•å…¼å®¹

- [x] Task 4: å®ç°è¡¥å……è§£é‡Šçš„é“¾å¼å±•å¼€é€»è¾‘ (AC: 2)
  - [x] è®¡ç®—è§£é‡ŠèŠ‚ç‚¹ä½ç½®ï¼ˆç•¥å¾®åä¸‹å’Œåå³ï¼‰
  - [x] å®ç°å¤šä¸ªè§£é‡ŠèŠ‚ç‚¹çš„é“¾å¼æ’åˆ—
  - [x] ä½¿ç”¨EXPLANATION_CHAIN_SPACINGå¸¸é‡

- [x] Task 5: å®ç°é¿å…é‡å çš„ç®—æ³• (AC: 1)
  - [x] å®ç°`_check_overlap()`è¾…åŠ©æ–¹æ³•æ£€æµ‹èŠ‚ç‚¹é‡å 
  - [x] å®ç°`_avoid_overlap()`æ–¹æ³•è°ƒæ•´ä½ç½®é¿å…é‡å 
  - [x] å¤„ç†è¾¹ç•Œæƒ…å†µï¼ˆCanvasè¾¹ç•Œã€å¯†é›†åŒºåŸŸï¼‰

- [x] Task 6: æ€§èƒ½ä¼˜åŒ–å’Œæµ‹è¯• (AC: 5)
  - [x] ä¼˜åŒ–ç®—æ³•å¤æ‚åº¦ï¼Œç¡®ä¿<50mså“åº”æ—¶é—´
  - [x] æ·»åŠ æ€§èƒ½åŸºå‡†æµ‹è¯•
  - [x] æµ‹è¯•ä¸åŒè§„æ¨¡Canvasçš„æ€§èƒ½è¡¨ç°

- [x] Task 7: ç¼–å†™å•å…ƒæµ‹è¯•
  - [x] åˆ›å»ºæµ‹è¯•fixtureæ–‡ä»¶
    - [x] test-positioning.canvasï¼ˆç®€å•åœºæ™¯ï¼‰
    - [x] test-large-canvas.canvasï¼ˆ100èŠ‚ç‚¹æ€§èƒ½æµ‹è¯•ï¼‰
    - [x] test-v11-compatibility.canvasï¼ˆåŒ…å«materialèŠ‚ç‚¹ç”¨äºv1.1æµ‹è¯•ï¼‰
  - [x] æµ‹è¯•ç”¨ä¾‹1ï¼šéªŒè¯æ‹†è§£å­é—®é¢˜çºµå‘æ’åˆ—
  - [x] æµ‹è¯•ç”¨ä¾‹2ï¼šéªŒè¯ä¸ªäººç†è§£æ¨ªå‘æ’åˆ—
  - [x] æµ‹è¯•ç”¨ä¾‹3ï¼šéªŒè¯è§£é‡ŠèŠ‚ç‚¹é“¾å¼å±•å¼€
  - [x] æµ‹è¯•ç”¨ä¾‹4ï¼šéªŒè¯é¿å…é‡å é€»è¾‘
  - [x] æµ‹è¯•ç”¨ä¾‹5ï¼šéªŒè¯æ€§èƒ½è¦æ±‚ï¼ˆ<50msï¼‰
  - [x] æµ‹è¯•ç”¨ä¾‹6ï¼šéªŒè¯å¤šä¸ªå­èŠ‚ç‚¹æ¨ªå‘é”™å¼€
  - [x] æµ‹è¯•ç”¨ä¾‹7ï¼šéªŒè¯ä¸v1.1å¸ƒå±€å…¼å®¹æ€§

## Dev Notes

### Previous Story Insights

ä» Story 2.6 (æ ‡å‡†å­¦ä¹ å•å…ƒç»“æ„) ä¸­å­¦åˆ°çš„å…³é”®ç»éªŒï¼š

âœ… **v1.1å¸ƒå±€ç®—æ³•å·²å®ç°** [Source: docs/stories/2.6.story.md#Dev Notes#æ¶æ„èƒŒæ™¯]
- é»„è‰²èŠ‚ç‚¹ä½äºé—®é¢˜èŠ‚ç‚¹æ­£ä¸‹æ–¹ï¼ˆYELLOW_OFFSET_X = 0ï¼‰
- å‚ç›´é—´è·ï¼šYELLOW_OFFSET_Y = 30px
- å¤šä¸ªé—®é¢˜å‚ç›´é—´è·ï¼šVERTICAL_SPACING_BASE = 380px
- å¸ƒå±€å¸¸é‡å·²æå–åˆ°æ¨¡å—çº§ï¼ˆcanvas_utils.py:123-132ï¼‰

âœ… **Canvas 3å±‚æ¶æ„å·²å®Œå…¨å®ç°** [Source: docs/stories/2.6.story.md#Dev Agent Record]
- Layer 1 (CanvasJSONOperator): CRUDæ“ä½œ
- Layer 2 (CanvasBusinessLogic): ä¸šåŠ¡é€»è¾‘å’Œå¸ƒå±€ç®—æ³•
- Layer 3 (CanvasOrchestrator): é«˜çº§æ¥å£

âœ… **å¸ƒå±€ç›¸å…³æ–¹æ³•å·²å­˜åœ¨**
- `_calculate_question_position()`: è®¡ç®—é—®é¢˜èŠ‚ç‚¹ä½ç½®
- `_count_child_questions()`: ç»Ÿè®¡å­é—®é¢˜æ•°é‡
- `add_sub_question_with_yellow_node()`: é—®é¢˜+é»„è‰²èŠ‚ç‚¹é…å¯¹åˆ›å»º

**é‡è¦æç¤º**: æœ¬Storyåº”æ‰©å±•ç°æœ‰å¸ƒå±€ç³»ç»Ÿï¼Œè€Œéæ›¿æ¢å®ƒã€‚æ–°çš„`calculate_smart_position()`æ–¹æ³•åº”è¯¥æ˜¯ä¸€ä¸ªé€šç”¨çš„å®šä½å·¥å…·ï¼Œå¯è¢«å…¶ä»–ä¸šåŠ¡é€»è¾‘æ–¹æ³•è°ƒç”¨ã€‚

### æ¶æ„èƒŒæ™¯

**Canvas 3å±‚æ¶æ„** [Source: docs/architecture/canvas-3-layer-architecture.md#æ¶æ„æ¦‚è¿°]

æœ¬Storyå±äºLayer 2å®ç°ï¼š
- æ–‡ä»¶ä½ç½®ï¼š`canvas_utils.py` ä¸­çš„ `CanvasBusinessLogic` ç±»
- æ–°å¢æ–¹æ³•ï¼š`calculate_smart_position()` å’Œç›¸å…³è¾…åŠ©æ–¹æ³•
- è¯¥æ–¹æ³•å°†è¢«Layer 2çš„å…¶ä»–æ–¹æ³•è°ƒç”¨ï¼Œä¹Ÿå¯èƒ½è¢«Layer 3è°ƒç”¨

**v1.1å¸ƒå±€ç®—æ³•èƒŒæ™¯** [Source: docs/architecture/canvas-layout-v1.1.md#v1.1å¸ƒå±€ç‰¹ç‚¹]

å½“å‰å·²å®ç°çš„å¸ƒå±€ç‰¹ç‚¹ï¼š
- âœ… é»„è‰²ç†è§£èŠ‚ç‚¹åœ¨é—®é¢˜èŠ‚ç‚¹æ­£ä¸‹æ–¹ï¼ˆå‚ç›´å¯¹é½ï¼‰
- âœ… æ°´å¹³åç§»ä¸º0ï¼ˆä¸å‘å³åç§»ï¼‰
- âœ… è§†è§‰æ¸…æ™°ï¼ˆä¸€çœ¼çœ‹åˆ°é—®é¢˜-ç†è§£å¯¹åº”å…³ç³»ï¼‰

**æœ¬Storyçš„å®šä½**: æä¾›æ›´é€šç”¨ã€æ›´çµæ´»çš„æ™ºèƒ½å®šä½ç®—æ³•ï¼Œæ”¯æŒå¤šç§èŠ‚ç‚¹å…³ç³»ç±»å‹ï¼ˆæ‹†è§£ã€ä¸ªäººç†è§£ã€è¡¥å……è§£é‡Šï¼‰ã€‚

### æ•°æ®æ¨¡å‹

**æ™ºèƒ½å®šä½å‡½æ•°æ¥å£** [Source: docs/prd/FULL-PRD-REFERENCE.md#Story 2.7]

```python
def calculate_smart_position(
    parent_node: Dict,
    relationship_type: str,
    existing_nodes: List[Dict]
) -> Dict[str, int]:
    """æ™ºèƒ½è®¡ç®—æ–°èŠ‚ç‚¹çš„ä½ç½®

    Args:
        parent_node: çˆ¶èŠ‚ç‚¹æ•°æ®ï¼ˆåŒ…å«x, y, width, heightï¼‰
        relationship_type: å…³ç³»ç±»å‹
            - "decomposition": æ‹†è§£å­é—®é¢˜ï¼ˆçºµå‘æ’åˆ—ï¼‰
            - "personal_understanding": ä¸ªäººç†è§£ï¼ˆæ¨ªå‘æ’åˆ—ï¼‰
            - "explanation": è¡¥å……è§£é‡Šï¼ˆåä¸‹åå³ï¼‰
        existing_nodes: ç°æœ‰èŠ‚ç‚¹åˆ—è¡¨ï¼ˆç”¨äºé¿å…é‡å ï¼‰

    Returns:
        Dict[str, int]: {"x": int, "y": int}
    """
    pass
```

**èŠ‚ç‚¹å…³ç³»ç±»å‹å®šä¹‰** [Source: docs/prd/FULL-PRD-REFERENCE.md#Story 2.7]

1. **decompositionï¼ˆæ‹†è§£å­é—®é¢˜ï¼‰**
   - çºµå‘æ’åˆ—ï¼šå­é—®é¢˜ä½äºçˆ¶èŠ‚ç‚¹ä¸‹æ–¹
   - å‚ç›´é—´è·ï¼šVERTICAL_GAP (80px)
   - å¤šä¸ªå­èŠ‚ç‚¹ï¼šæ¨ªå‘é”™å¼€ï¼Œé¿å…é‡å 

2. **personal_understandingï¼ˆä¸ªäººç†è§£ï¼‰**
   - æ¨ªå‘æ’åˆ—ï¼šç†è§£èŠ‚ç‚¹ä½äºçˆ¶èŠ‚ç‚¹å³ä¾§
   - æ°´å¹³é—´è·ï¼šHORIZONTAL_GAP (50px)
   - æ³¨æ„ï¼šä¸v1.1å¸ƒå±€çš„å·®å¼‚ï¼ˆv1.1å°†é»„è‰²èŠ‚ç‚¹æ”¾åœ¨ä¸‹æ–¹ï¼‰

3. **explanationï¼ˆè¡¥å……è§£é‡Šï¼‰**
   - ç•¥å¾®åä¸‹å’Œåå³ï¼šxåç§» + HORIZONTAL_GAP, yåç§» + 100px
   - é“¾å¼å±•å¼€ï¼šå¤šä¸ªè§£é‡ŠèŠ‚ç‚¹ä¾æ¬¡å‘å³æ’åˆ—

**é‡è¦å†²çªè¯´æ˜**:
PRDä¸­çš„"personal_understanding"æè¿°ä¸ºæ¨ªå‘æ’åˆ—ï¼Œä½†v1.1å¸ƒå±€ç®—æ³•å°†é»„è‰²ç†è§£èŠ‚ç‚¹æ”¾åœ¨é—®é¢˜ä¸‹æ–¹ï¼ˆå‚ç›´å¯¹é½ï¼‰ã€‚å®é™…å®ç°åº”éµå¾ªv1.1å¸ƒå±€è§„èŒƒï¼Œæˆ–è€…å°†æ­¤æ–¹æ³•ç”¨äºå…¶ä»–åœºæ™¯ï¼ˆå¦‚æ·±åº¦æ‹†è§£ã€è§£é‡Šç¬”è®°ï¼‰ã€‚

âš ï¸ **AC4å®ç°è¯´æ˜**ï¼š
`calculate_smart_position()`çš„`personal_understanding`å‚æ•°**ä¸ç”¨äº**v1.1çš„é—®é¢˜-é»„è‰²ç†è§£é…å¯¹ã€‚
v1.1çš„é»„è‰²èŠ‚ç‚¹ä»ä½¿ç”¨`add_sub_question_with_yellow_node()`æ–¹æ³•ï¼ˆå‚ç›´å¸ƒå±€ï¼‰ã€‚
`personal_understanding`å‚æ•°ä¸ºæ·±åº¦æ‹†è§£ç­‰æœªæ¥åœºæ™¯é¢„ç•™ï¼Œæ­¤æ—¶ä½¿ç”¨æ¨ªå‘å¸ƒå±€ã€‚

### APIè§„æ ¼

**æ–¹æ³•ç­¾å** [Source: docs/architecture/canvas-3-layer-architecture.md#Layer 2å®ç°]

```python
class CanvasBusinessLogic:
    def calculate_smart_position(
        self,
        parent_node: Dict,
        relationship_type: str,
        existing_nodes: Optional[List[Dict]] = None
    ) -> Dict[str, int]:
        """æ™ºèƒ½è®¡ç®—æ–°èŠ‚ç‚¹çš„ä½ç½®

        v1.1å¸ƒå±€å…¼å®¹ï¼šè¯¥æ–¹æ³•åº”è¯¥ä¸ç°æœ‰v1.1å¸ƒå±€ç®—æ³•ååŒå·¥ä½œï¼Œ
        ä¸åº”ç ´åé—®é¢˜-é»„è‰²ç†è§£çš„é…å¯¹å…³ç³»ã€‚

        Args:
            parent_node: çˆ¶èŠ‚ç‚¹æ•°æ®
                {
                    "id": str,
                    "x": int,
                    "y": int,
                    "width": int,
                    "height": int,
                    "type": str,
                    "color": Optional[str]
                }
            relationship_type: å…³ç³»ç±»å‹
                - "decomposition": æ‹†è§£å­é—®é¢˜
                - "explanation": è¡¥å……è§£é‡Š
                - "review_question": æ£€éªŒé—®é¢˜ï¼ˆæœªæ¥æ‰©å±•ï¼‰
            existing_nodes: ç°æœ‰èŠ‚ç‚¹åˆ—è¡¨ï¼ˆç”¨äºé¿å…é‡å ï¼‰
                å¦‚æœä¸ºNoneï¼Œä½¿ç”¨self.canvas_data["nodes"]

        Returns:
            Dict[str, int]: {"x": int, "y": int}

        Raises:
            ValueError: å¦‚æœrelationship_typeä¸æ”¯æŒ
        """
        pass
```

**è¾…åŠ©æ–¹æ³•**

```python
def _check_overlap(
    self,
    pos: Dict[str, int],
    width: int,
    height: int,
    existing_nodes: List[Dict]
) -> bool:
    """æ£€æŸ¥æŒ‡å®šä½ç½®æ˜¯å¦ä¸ç°æœ‰èŠ‚ç‚¹é‡å 

    Args:
        pos: å¾…æ£€æŸ¥çš„ä½ç½® {"x": int, "y": int}
        width: èŠ‚ç‚¹å®½åº¦
        height: èŠ‚ç‚¹é«˜åº¦
        existing_nodes: ç°æœ‰èŠ‚ç‚¹åˆ—è¡¨

    Returns:
        bool: Trueè¡¨ç¤ºæœ‰é‡å ï¼ŒFalseè¡¨ç¤ºæ— é‡å 
    """
    pass

def _avoid_overlap(
    self,
    base_pos: Dict[str, int],
    width: int,
    height: int,
    existing_nodes: List[Dict],
    max_attempts: int = 10
) -> Dict[str, int]:
    """è°ƒæ•´ä½ç½®ä»¥é¿å…ä¸ç°æœ‰èŠ‚ç‚¹é‡å 

    ç­–ç•¥ï¼š
    1. å°è¯•å‘ä¸‹åç§»ï¼ˆy += 50ï¼‰
    2. å°è¯•å‘å³åç§»ï¼ˆx += 50ï¼‰
    3. æœ€å¤šå°è¯•max_attemptsæ¬¡
    4. å¦‚æœä»æ— æ³•é¿å…ï¼Œè¿”å›base_posï¼ˆè­¦å‘Šï¼‰

    Args:
        base_pos: åŸºç¡€ä½ç½®
        width: èŠ‚ç‚¹å®½åº¦
        height: èŠ‚ç‚¹é«˜åº¦
        existing_nodes: ç°æœ‰èŠ‚ç‚¹åˆ—è¡¨
        max_attempts: æœ€å¤§å°è¯•æ¬¡æ•°

    Returns:
        Dict[str, int]: è°ƒæ•´åçš„ä½ç½®
    """
    pass
```

### ç»„ä»¶è§„æ ¼

**å¸ƒå±€å¸¸é‡** [Source: docs/architecture/canvas-layout-v1.1.md#é—´è·å‚æ•°]

å·²å­˜åœ¨çš„å¸¸é‡ï¼ˆcanvas_utils.py:123-132ï¼‰:
```python
HORIZONTAL_SPACING = 450  # ææ–™åˆ°é—®é¢˜çš„æ°´å¹³é—´è·
VERTICAL_SPACING_BASE = 380  # é—®é¢˜+é»„è‰²ç»„åˆçš„å‚ç›´é—´è·
YELLOW_OFFSET_X = 0  # é»„è‰²èŠ‚ç‚¹æ°´å¹³åç§»
YELLOW_OFFSET_Y = 30  # é»„è‰²èŠ‚ç‚¹å‚ç›´åç§»
QUESTION_NODE_HEIGHT = 120  # é—®é¢˜èŠ‚ç‚¹é«˜åº¦
YELLOW_NODE_WIDTH = 350  # é»„è‰²ç†è§£èŠ‚ç‚¹å®½åº¦
YELLOW_NODE_HEIGHT = 150  # é»„è‰²ç†è§£èŠ‚ç‚¹é«˜åº¦
```

**éœ€è¦æ–°å¢çš„å¸¸é‡** [Source: docs/prd/FULL-PRD-REFERENCE.md#Story 2.7]:
```python
# æ™ºèƒ½å®šä½ç®—æ³•ä¸“ç”¨å¸¸é‡
VERTICAL_GAP = 80  # æ‹†è§£å­é—®é¢˜çš„å‚ç›´é—´è·
HORIZONTAL_GAP = 50  # ä¸€èˆ¬æ¨ªå‘é—´è·
EXPLANATION_OFFSET_Y = 100  # è§£é‡ŠèŠ‚ç‚¹çš„å‚ç›´åç§»
OVERLAP_AVOIDANCE_STEP = 50  # é¿å…é‡å æ—¶çš„ç§»åŠ¨æ­¥é•¿
```

**å¸ƒå±€ç®—æ³•ä¼ªä»£ç ** [Source: docs/prd/FULL-PRD-REFERENCE.md#Story 2.7]

```python
def calculate_smart_position(parent_node, relationship_type, existing_nodes):
    if relationship_type == "decomposition":
        # æ‹†è§£å­é—®é¢˜ï¼šçºµå‘æ’åˆ—
        base_pos = {
            "x": parent_node["x"],
            "y": parent_node["y"] + parent_node["height"] + VERTICAL_GAP
        }
        # å¤šä¸ªå­èŠ‚ç‚¹æ¨ªå‘é”™å¼€
        return offset_for_siblings(base_pos, existing_nodes)

    elif relationship_type == "personal_understanding":
        # æ³¨æ„ï¼šæ­¤é€»è¾‘ä¸v1.1å†²çªï¼Œå®é™…åº”éµå¾ªv1.1
        # æ¨ªå‘æ’åˆ—
        return {
            "x": parent_node["x"] + parent_node["width"] + HORIZONTAL_GAP,
            "y": parent_node["y"]
        }

    elif relationship_type == "explanation":
        # è¡¥å……è§£é‡Šï¼šç•¥å¾®åä¸‹å’Œåå³
        return {
            "x": parent_node["x"] + parent_node["width"] + HORIZONTAL_GAP,
            "y": parent_node["y"] + EXPLANATION_OFFSET_Y
        }

    # é¿å…é‡å 
    return avoid_overlap(calculated_pos, existing_nodes)
```

**æ¨ªå‘é”™å¼€é€»è¾‘** (offset_for_siblings):
```python
def _offset_for_siblings(
    self,
    base_pos: Dict[str, int],
    parent_node_id: str
) -> Dict[str, int]:
    """ä¸ºåŒçº§å…„å¼ŸèŠ‚ç‚¹æ¨ªå‘é”™å¼€

    è®¡ç®—é€»è¾‘ï¼š
    1. ç»Ÿè®¡çˆ¶èŠ‚ç‚¹å·²æœ‰å¤šå°‘ä¸ªå­èŠ‚ç‚¹
    2. æ¯ä¸ªå­èŠ‚ç‚¹æ¨ªå‘åç§» sibling_count * 50px

    Args:
        base_pos: åŸºç¡€ä½ç½®
        parent_node_id: çˆ¶èŠ‚ç‚¹ID

    Returns:
        Dict[str, int]: è°ƒæ•´åçš„ä½ç½®
    """
    sibling_count = self._count_child_questions(parent_node_id)
    return {
        "x": base_pos["x"] + (sibling_count * 50),
        "y": base_pos["y"]
    }
```

### æ–‡ä»¶ä½ç½®

**å®ç°ä½ç½®** [Source: docs/architecture/unified-project-structure.md#å®Œæ•´ç›®å½•ç»“æ„]

```
C:/Users/ROG/æ‰˜ç¦/
â”œâ”€â”€ canvas_utils.py              # â­ åœ¨æ­¤æ–‡ä»¶çš„CanvasBusinessLogicç±»ä¸­å®ç°
```

å…·ä½“ä½ç½®ï¼š
- Class: `CanvasBusinessLogic` (Layer 2)
- æ–°å¢æ–¹æ³•:
  - `calculate_smart_position()`
  - `_check_overlap()`
  - `_avoid_overlap()`
  - `_offset_for_siblings()`
- æ–°å¢å¸¸é‡: åœ¨æ¨¡å—çº§å¸¸é‡åŒºåŸŸæ·»åŠ ï¼ˆcanvas_utils.py:123-132é™„è¿‘ï¼‰

**æµ‹è¯•æ–‡ä»¶ä½ç½®** [Source: docs/architecture/coding-standards.md#æµ‹è¯•è§„èŒƒ]

```
C:/Users/ROG/æ‰˜ç¦/
â”œâ”€â”€ tests/
â”‚   â”œâ”€â”€ test_canvas_utils.py     # åœ¨TestCanvasBusinessLogicç±»ä¸­æ·»åŠ æµ‹è¯•
```

### æŠ€æœ¯çº¦æŸ

**æ€§èƒ½è¦æ±‚** [Source: docs/prd/FULL-PRD-REFERENCE.md#Story 2.7]

å®šä½è®¡ç®—è€—æ—¶å¿…é¡»<50msï¼š
- é¿å…åµŒå¥—å¾ªç¯ï¼ˆO(nÂ²)å¤æ‚åº¦ï¼‰
- é‡å æ£€æµ‹åº”ä¼˜åŒ–ä¸ºO(n)
- æœ€å¤šå°è¯•10æ¬¡é¿å…é‡å ï¼ˆmax_attempts=10ï¼‰

**ä¸v1.1å¸ƒå±€å…¼å®¹** [Source: docs/architecture/canvas-layout-v1.1.md]

âš ï¸ **å…³é”®çº¦æŸ**:
- æœ¬Storyæ·»åŠ çš„æ™ºèƒ½å®šä½ç®—æ³•**ä¸åº”ç ´å**v1.1å¸ƒå±€çš„é—®é¢˜-é»„è‰²ç†è§£é…å¯¹é€»è¾‘
- `calculate_smart_position()`åº”è¯¥æ˜¯ä¸€ä¸ª**è¾…åŠ©å·¥å…·**ï¼Œç”¨äºæ‰©å±•åœºæ™¯ï¼ˆå¦‚æ·±åº¦æ‹†è§£ã€è§£é‡Šç¬”è®°é“¾å¼å±•å¼€ï¼‰
- å¯¹äºé—®é¢˜-é»„è‰²ç†è§£é…å¯¹ï¼Œä»åº”ä½¿ç”¨`add_sub_question_with_yellow_node()`æ–¹æ³•

**é¿å…é‡å ç®—æ³•çº¦æŸ**

ç¢°æ’æ£€æµ‹é€»è¾‘ï¼š
```python
def _check_overlap(pos, width, height, existing_node):
    """æ£€æŸ¥ä¸¤ä¸ªçŸ©å½¢æ˜¯å¦é‡å """
    # çŸ©å½¢1ï¼šæ–°èŠ‚ç‚¹
    x1_left = pos["x"]
    x1_right = pos["x"] + width
    y1_top = pos["y"]
    y1_bottom = pos["y"] + height

    # çŸ©å½¢2ï¼šç°æœ‰èŠ‚ç‚¹
    x2_left = existing_node["x"]
    x2_right = existing_node["x"] + existing_node["width"]
    y2_top = existing_node["y"]
    y2_bottom = existing_node["y"] + existing_node["height"]

    # æ— é‡å æ¡ä»¶ï¼šå®Œå…¨åˆ†ç¦»
    if (x1_right < x2_left or x1_left > x2_right or
        y1_bottom < y2_top or y1_top > y2_bottom):
        return False  # æ— é‡å 

    return True  # æœ‰é‡å 
```

**åæ ‡ç³»ç»Ÿ** [Source: docs/architecture/tech-stack.md#Canvasæ–‡ä»¶æ ¼å¼]

- åæ ‡åŸç‚¹ï¼šCanvaså·¦ä¸Šè§’(0, 0)
- æ­£æ–¹å‘ï¼šxå‘å³ï¼Œyå‘ä¸‹
- å•ä½ï¼šåƒç´ ï¼ˆæ•´æ•°ï¼‰
- æ‰€æœ‰åæ ‡å¿…é¡»æ˜¯æ•´æ•°ï¼Œä¸èƒ½æ˜¯æµ®ç‚¹æ•°

### Project Structure Notes

**æ–‡ä»¶ç»„ç»‡**:
- æ–°å¢æ–¹æ³•åº”æ”¾åœ¨CanvasBusinessLogicç±»ä¸­ï¼Œä½äºç°æœ‰å¸ƒå±€æ–¹æ³•é™„è¿‘
- å»ºè®®é¡ºåºï¼š
  1. ç°æœ‰æ–¹æ³•ï¼ˆ`add_sub_question_with_yellow_node()`, etc.ï¼‰
  2. **æ–°å¢**: `calculate_smart_position()` ï¼ˆå…¬å…±æ¥å£ï¼‰
  3. **æ–°å¢**: `_offset_for_siblings()` ï¼ˆç§æœ‰è¾…åŠ©ï¼‰
  4. **æ–°å¢**: `_check_overlap()` ï¼ˆç§æœ‰è¾…åŠ©ï¼‰
  5. **æ–°å¢**: `_avoid_overlap()` ï¼ˆç§æœ‰è¾…åŠ©ï¼‰

**ä¸ç°æœ‰ä»£ç çš„å…³ç³»**:
- `calculate_smart_position()`å¯ä»¥è°ƒç”¨`_count_child_questions()`æ¥ç»Ÿè®¡å…„å¼ŸèŠ‚ç‚¹
- æœªæ¥çš„æ‹†è§£Agentå’Œè§£é‡ŠAgentå¯ä»¥è°ƒç”¨æ­¤æ–¹æ³•è®¡ç®—ä½ç½®
- ä¸å½±å“ç°æœ‰çš„Story 2.6å®ç°ï¼ˆ`add_sub_question_with_yellow_node()`ï¼‰

## Testing

### æµ‹è¯•æ ‡å‡†

**æµ‹è¯•æ–‡ä»¶ä½ç½®** [Source: docs/architecture/coding-standards.md#æµ‹è¯•è§„èŒƒ]
- æ–‡ä»¶è·¯å¾„ï¼š`tests/test_canvas_utils.py`
- æµ‹è¯•ç±»ï¼š`TestCanvasBusinessLogic`
- æµ‹è¯•æ–¹æ³•å‘½åï¼š`test_calculate_smart_position_{scenario}`

**æµ‹è¯•æ¡†æ¶** [Source: docs/architecture/coding-standards.md#æ¨èå·¥å…·]
- ä½¿ç”¨pytestæ¡†æ¶
- ä½¿ç”¨pytest-covç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
- ä½¿ç”¨timeæ¨¡å—éªŒè¯æ€§èƒ½è¦æ±‚

**æµ‹è¯•è¦†ç›–ç‡ç›®æ ‡** [Source: docs/architecture/coding-standards.md#æµ‹è¯•è¦†ç›–ç‡ç›®æ ‡]
- Layer 2 (CanvasBusinessLogic): â‰¥ 85%
- æ–°å¢æ–¹æ³•è¦†ç›–ç‡: â‰¥ 90%

### æµ‹è¯•ç”¨ä¾‹

**æµ‹è¯•ç”¨ä¾‹1ï¼šéªŒè¯æ‹†è§£å­é—®é¢˜çºµå‘æ’åˆ—**
```python
def test_calculate_smart_position_decomposition_vertical():
    """æµ‹è¯•æ‹†è§£å­é—®é¢˜çºµå‘æ’åˆ—é€»è¾‘"""
    # Arrange
    canvas_path = "tests/fixtures/test-positioning.canvas"
    logic = CanvasBusinessLogic(canvas_path)
    parent_node = {
        "id": "parent-123",
        "x": 100,
        "y": 200,
        "width": 400,
        "height": 300
    }

    # Act
    pos = logic.calculate_smart_position(
        parent_node=parent_node,
        relationship_type="decomposition",
        existing_nodes=[]
    )

    # Assert
    assert pos["x"] == 100, "æ‹†è§£å­é—®é¢˜xåæ ‡åº”ä¸çˆ¶èŠ‚ç‚¹ç›¸åŒ"
    assert pos["y"] == 200 + 300 + 80, "yåæ ‡åº”ä¸ºçˆ¶èŠ‚ç‚¹åº•éƒ¨ + VERTICAL_GAP"
    assert pos["y"] == 580
```

**æµ‹è¯•ç”¨ä¾‹2ï¼šéªŒè¯å¤šä¸ªå­èŠ‚ç‚¹æ¨ªå‘é”™å¼€**
```python
def test_calculate_smart_position_siblings_offset():
    """æµ‹è¯•å¤šä¸ªå…„å¼ŸèŠ‚ç‚¹æ¨ªå‘é”™å¼€é€»è¾‘"""
    # Arrange
    canvas_path = "tests/fixtures/test-positioning.canvas"
    logic = CanvasBusinessLogic(canvas_path)
    parent_id = "parent-123"

    # é¢„å…ˆæ·»åŠ 1ä¸ªå­é—®é¢˜
    logic.canvas_data["edges"].append({
        "id": "edge-1",
        "fromNode": parent_id,
        "toNode": "child-1",
        "fromSide": "bottom",
        "toSide": "top"
    })
    logic.canvas_data["nodes"].append({
        "id": "child-1",
        "x": 100,
        "y": 580,
        "color": "1"  # çº¢è‰²
    })

    parent_node = {"id": parent_id, "x": 100, "y": 200, "width": 400, "height": 300}

    # Act - æ·»åŠ ç¬¬2ä¸ªå­èŠ‚ç‚¹
    pos = logic.calculate_smart_position(
        parent_node=parent_node,
        relationship_type="decomposition",
        existing_nodes=logic.canvas_data["nodes"]
    )

    # Assert
    assert pos["x"] == 100 + 50, "ç¬¬2ä¸ªå­èŠ‚ç‚¹åº”æ¨ªå‘åç§»50px"
    assert pos["y"] == 580
```

**æµ‹è¯•ç”¨ä¾‹3ï¼šéªŒè¯è§£é‡ŠèŠ‚ç‚¹åä¸‹åå³**
```python
def test_calculate_smart_position_explanation():
    """æµ‹è¯•è¡¥å……è§£é‡ŠèŠ‚ç‚¹ä½ç½®ï¼ˆåä¸‹åå³ï¼‰"""
    # Arrange
    canvas_path = "tests/fixtures/test-positioning.canvas"
    logic = CanvasBusinessLogic(canvas_path)
    parent_node = {
        "id": "question-123",
        "x": 500,
        "y": 200,
        "width": 400,
        "height": 120
    }

    # Act
    pos = logic.calculate_smart_position(
        parent_node=parent_node,
        relationship_type="explanation",
        existing_nodes=[]
    )

    # Assert
    assert pos["x"] == 500 + 400 + 50, "xåæ ‡åº”ä¸ºçˆ¶èŠ‚ç‚¹å³ä¾§ + HORIZONTAL_GAP"
    assert pos["y"] == 200 + 100, "yåæ ‡åº”ä¸ºçˆ¶èŠ‚ç‚¹é¡¶éƒ¨ + EXPLANATION_OFFSET_Y"
```

**æµ‹è¯•ç”¨ä¾‹4ï¼šéªŒè¯é¿å…é‡å é€»è¾‘**
```python
def test_avoid_overlap_detects_collision():
    """æµ‹è¯•é¿å…é‡å åŠŸèƒ½èƒ½æ£€æµ‹ç¢°æ’"""
    # Arrange
    canvas_path = "tests/fixtures/test-positioning.canvas"
    logic = CanvasBusinessLogic(canvas_path)

    # åˆ›å»ºç°æœ‰èŠ‚ç‚¹ï¼ˆå æ®ä½ç½® 100, 200, å®½400, é«˜300ï¼‰
    existing_nodes = [{
        "id": "existing-1",
        "x": 100,
        "y": 200,
        "width": 400,
        "height": 300
    }]

    # Act - å°è¯•åœ¨é‡å ä½ç½®åˆ›å»ºèŠ‚ç‚¹
    base_pos = {"x": 150, "y": 250}  # ä¼šä¸existing-1é‡å 
    adjusted_pos = logic._avoid_overlap(
        base_pos=base_pos,
        width=400,
        height=300,
        existing_nodes=existing_nodes
    )

    # Assert - ä½ç½®åº”è¢«è°ƒæ•´
    assert adjusted_pos != base_pos, "ä½ç½®åº”è¢«è°ƒæ•´ä»¥é¿å…é‡å "

    # éªŒè¯è°ƒæ•´åçš„ä½ç½®ä¸å†é‡å 
    has_overlap = logic._check_overlap(
        pos=adjusted_pos,
        width=400,
        height=300,
        existing_nodes=existing_nodes
    )
    assert not has_overlap, "è°ƒæ•´ååº”æ— é‡å "
```

**æµ‹è¯•ç”¨ä¾‹5ï¼šéªŒè¯æ€§èƒ½è¦æ±‚ï¼ˆ<50msï¼‰**
```python
import time

def test_calculate_smart_position_performance():
    """æµ‹è¯•å®šä½è®¡ç®—æ€§èƒ½ï¼ˆå¿…é¡»<50msï¼‰"""
    # Arrange
    canvas_path = "tests/fixtures/test-large-canvas.canvas"
    logic = CanvasBusinessLogic(canvas_path)

    # åˆ›å»ºå¤§é‡ç°æœ‰èŠ‚ç‚¹ï¼ˆæ¨¡æ‹Ÿå¤æ‚Canvasï¼‰
    existing_nodes = []
    for i in range(100):
        existing_nodes.append({
            "id": f"node-{i}",
            "x": (i % 10) * 500,
            "y": (i // 10) * 400,
            "width": 400,
            "height": 300
        })

    parent_node = {
        "id": "parent-test",
        "x": 2500,
        "y": 2000,
        "width": 400,
        "height": 300
    }

    # Act - æµ‹é‡æ‰§è¡Œæ—¶é—´
    start_time = time.time()
    pos = logic.calculate_smart_position(
        parent_node=parent_node,
        relationship_type="decomposition",
        existing_nodes=existing_nodes
    )
    end_time = time.time()

    elapsed_ms = (end_time - start_time) * 1000

    # Assert
    assert elapsed_ms < 50, f"æ‰§è¡Œæ—¶é—´{elapsed_ms:.2f}msè¶…è¿‡50msé™åˆ¶"
    assert pos is not None
```

**æµ‹è¯•ç”¨ä¾‹6ï¼šéªŒè¯ä¸æ”¯æŒçš„å…³ç³»ç±»å‹æŠ›å‡ºå¼‚å¸¸**
```python
def test_calculate_smart_position_invalid_relationship_type():
    """æµ‹è¯•ä¸æ”¯æŒçš„å…³ç³»ç±»å‹æŠ›å‡ºValueError"""
    # Arrange
    canvas_path = "tests/fixtures/test-positioning.canvas"
    logic = CanvasBusinessLogic(canvas_path)
    parent_node = {"id": "p1", "x": 100, "y": 200, "width": 400, "height": 300}

    # Act & Assert
    with pytest.raises(ValueError, match="ä¸æ”¯æŒçš„å…³ç³»ç±»å‹"):
        logic.calculate_smart_position(
            parent_node=parent_node,
            relationship_type="invalid_type",
            existing_nodes=[]
        )
```

**æµ‹è¯•ç”¨ä¾‹7ï¼šéªŒè¯ä¸v1.1å¸ƒå±€å…¼å®¹æ€§**
```python
def test_smart_position_does_not_break_v11_layout():
    """éªŒè¯æ™ºèƒ½å®šä½ä¸ç ´åv1.1å¸ƒå±€çš„é—®é¢˜-é»„è‰²é…å¯¹"""
    # Arrange
    canvas_path = "tests/fixtures/test-v11-compatibility.canvas"
    logic = CanvasBusinessLogic(canvas_path)
    material_id = "material-123"

    # å…ˆä½¿ç”¨v1.1æ–¹æ³•åˆ›å»ºé—®é¢˜+é»„è‰²é…å¯¹
    q_id, y_id = logic.add_sub_question_with_yellow_node(
        material_node_id=material_id,
        question_text="æµ‹è¯•é—®é¢˜"
    )

    q_node = CanvasJSONOperator.get_node_by_id(logic.canvas_data, q_id)
    y_node = CanvasJSONOperator.get_node_by_id(logic.canvas_data, y_id)

    # éªŒè¯v1.1å¸ƒå±€ç‰¹ç‚¹ï¼šé»„è‰²èŠ‚ç‚¹åœ¨é—®é¢˜ä¸‹æ–¹ï¼Œæ°´å¹³å¯¹é½
    assert y_node["x"] == q_node["x"], "é»„è‰²èŠ‚ç‚¹åº”ä¸é—®é¢˜èŠ‚ç‚¹æ°´å¹³å¯¹é½"
    assert y_node["y"] == q_node["y"] + 120 + 30, "é»„è‰²èŠ‚ç‚¹åº”åœ¨é—®é¢˜èŠ‚ç‚¹ä¸‹æ–¹"

    # ç°åœ¨ä½¿ç”¨æ™ºèƒ½å®šä½æ·»åŠ è§£é‡ŠèŠ‚ç‚¹
    explanation_pos = logic.calculate_smart_position(
        parent_node=q_node,
        relationship_type="explanation",
        existing_nodes=logic.canvas_data["nodes"]
    )

    # éªŒè¯è§£é‡ŠèŠ‚ç‚¹ä½ç½®ä¸å¹²æ‰°é—®é¢˜-é»„è‰²é…å¯¹
    assert explanation_pos["x"] > y_node["x"] + y_node["width"], \
        "è§£é‡ŠèŠ‚ç‚¹åº”åœ¨é»„è‰²èŠ‚ç‚¹å³ä¾§ï¼Œä¸è¦†ç›–"
```

### è´¨é‡æ ‡å‡†

- æ‰€æœ‰5ä¸ªACå¿…é¡»æ»¡è¶³
- æ‰€æœ‰7ä¸ªæµ‹è¯•ç”¨ä¾‹å¿…é¡»é€šè¿‡
- æµ‹è¯•è¦†ç›–ç‡â‰¥85%
- æ€§èƒ½æµ‹è¯•éªŒè¯<50ms
- ä»£ç é€šè¿‡pylintæ£€æŸ¥ï¼ˆè¯„åˆ†â‰¥8.0ï¼‰
- ä»£ç é€šè¿‡mypyç±»å‹æ£€æŸ¥
- ä»£ç ç¬¦åˆPEP 8è§„èŒƒ
- æ‰€æœ‰å…¬å…±æ–¹æ³•æœ‰å®Œæ•´çš„Google Style Docstring

## Dev Agent Record

### Agent Model Used
claude-sonnet-4.5 (claude-sonnet-4-5-20250929)

### Debug Log References
æ— è°ƒè¯•é—®é¢˜ã€‚æ‰€æœ‰æµ‹è¯•ä¸€æ¬¡æ€§é€šè¿‡ï¼ˆ8/8ï¼‰ã€‚

### Completion Notes
- âœ… æˆåŠŸæ·»åŠ æ™ºèƒ½å®šä½ç®—æ³•å¸¸é‡ï¼ˆVERTICAL_GAP, HORIZONTAL_GAP, EXPLANATION_OFFSET_Yç­‰ï¼‰
- âœ… å®ç° calculate_smart_position() æ–¹æ³•ï¼Œæ”¯æŒ3ç§å…³ç³»ç±»å‹
- âœ… å®ç° _check_overlap() æ–¹æ³•ï¼ˆçŸ©å½¢ç¢°æ’æ£€æµ‹ï¼‰
- âœ… å®ç° _avoid_overlap() æ–¹æ³•ï¼ˆæ™ºèƒ½é¿è®©é‡å ï¼Œä½¿ç”¨å¤§æ­¥é•¿ç­–ç•¥ï¼‰
- âœ… å®ç° _offset_for_siblings() æ–¹æ³•ï¼ˆå…„å¼ŸèŠ‚ç‚¹æ¨ªå‘é”™å¼€ï¼‰
- âœ… åˆ›å»º3ä¸ªæµ‹è¯•fixtureæ–‡ä»¶ï¼ˆtest-positioning.canvas, test-large-canvas.canvas, test-v11-compatibility.canvasï¼‰
- âœ… æ–°å¢8ä¸ªæµ‹è¯•ç”¨ä¾‹ï¼Œå…¨éƒ¨é€šè¿‡
- âœ… æµ‹è¯•è¦†ç›–ç‡ï¼š**93%**ï¼ˆè¶…è¿‡85%ç›®æ ‡ ğŸ¯ï¼‰
- âœ… æ€§èƒ½æµ‹è¯•éªŒè¯ï¼š100èŠ‚ç‚¹Canvaså®šä½è®¡ç®— < 50ms
- âœ… æ‰€æœ‰5ä¸ªéªŒæ”¶æ ‡å‡† (AC1-AC5) å‡å·²æ»¡è¶³
- âœ… å®Œå…¨éµå¾ªPEP 8è§„èŒƒå’Œé¡¹ç›®ç¼–ç æ ‡å‡†
- âœ… ä¸v1.1å¸ƒå±€ç®—æ³•å…¼å®¹ï¼ˆä¸ç ´åé—®é¢˜-é»„è‰²ç†è§£é…å¯¹ï¼‰

### File List
**ä¿®æ”¹çš„æ–‡ä»¶ï¼š**
- `canvas_utils.py` - æ·»åŠ æ™ºèƒ½å®šä½ç®—æ³•å®ç°
  - æ–°å¢å¸¸é‡ï¼šVERTICAL_GAP, HORIZONTAL_GAP, EXPLANATION_OFFSET_Y, OVERLAP_AVOIDANCE_STEP, MAX_OVERLAP_ATTEMPTS, SIBLING_OFFSET_X
  - CanvasBusinessLogicç±»æ–°å¢æ–¹æ³•ï¼š
    - calculate_smart_position() (å…¬å…±æ¥å£)
    - _offset_for_siblings() (ç§æœ‰è¾…åŠ©)
    - _check_overlap() (ç§æœ‰è¾…åŠ©)
    - _avoid_overlap() (ç§æœ‰è¾…åŠ©)
- `tests/test_canvas_utils.py` - æ·»åŠ å®Œæ•´æµ‹è¯•å¥—ä»¶
  - æ–°å¢8ä¸ªæµ‹è¯•ç”¨ä¾‹ï¼ˆTestCanvasBusinessLogicç±»ï¼‰
  - æ·»åŠ CanvasBusinessLogicå¯¼å…¥

**æ–°åˆ›å»ºçš„æ–‡ä»¶ï¼š**
- `tests/fixtures/test-positioning.canvas` - ç®€å•å®šä½æµ‹è¯•åœºæ™¯
- `tests/fixtures/test-large-canvas.canvas` - 100èŠ‚ç‚¹æ€§èƒ½æµ‹è¯•
- `tests/fixtures/test-v11-compatibility.canvas` - v1.1å¸ƒå±€å…¼å®¹æ€§æµ‹è¯•

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-15 | 1.0 | åˆå§‹Storyåˆ›å»º | SM Agent (Bob) |
| 2025-10-15 | 1.1 | POéªŒè¯ï¼šæ·»åŠ AC4å®ç°è¯´æ˜æ¾„æ¸…personal_understandingç”¨é€”ï¼›æ·»åŠ æµ‹è¯•fixtureæ–‡ä»¶åˆ›å»ºæŒ‡å¯¼ | PO Agent (Sarah) |
| 2025-10-15 | 2.0 | å®ç°å®Œæˆï¼šæ·»åŠ æ™ºèƒ½èŠ‚ç‚¹å®šä½ç®—æ³•åŠå®Œæ•´æµ‹è¯•å¥—ä»¶ï¼Œæ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼ˆè¦†ç›–ç‡93%ï¼‰ï¼ŒçŠ¶æ€æ›´æ–°ä¸ºReady for Review | Dev Agent (James) |

## QA Results

### Review Date: 2025-10-15

### Reviewed By: Quinn (Senior Developer QA)

### Code Quality Assessment

**Overall Assessment: Excellent â­**

The implementation demonstrates strong software engineering practices with clean, maintainable code. The developer has successfully implemented a comprehensive smart positioning algorithm that meets all acceptance criteria while maintaining backward compatibility with v1.1 layout.

**Key Strengths:**
- âœ… Clean architecture with proper separation of concerns (public interface + private helpers)
- âœ… Comprehensive Google Style docstrings with clear examples
- âœ… Proper type hints throughout all methods
- âœ… Robust error handling with meaningful error messages
- âœ… Well-structured test suite covering all scenarios
- âœ… Performance-conscious implementation (meets <50ms requirement)
- âœ… Excellent code readability and maintainability

**Code Structure:**
The implementation follows the 3-layer Canvas architecture perfectly:
- `calculate_smart_position()` - Clean public interface (Layer 2)
- `_offset_for_siblings()` - Sibling positioning logic
- `_check_overlap()` - Collision detection
- `_avoid_overlap()` - Intelligent overlap avoidance

### Refactoring Performed

**No refactoring required.**

The code is production-ready as-is. All methods are well-implemented, properly documented, and tested. The developer followed best practices throughout:
- Proper constant definitions (VERTICAL_GAP, HORIZONTAL_GAP, etc.)
- Clean separation of positioning logic by relationship type
- Efficient overlap detection using rectangle intersection algorithm
- Pragmatic overlap avoidance strategy using alternating vertical/horizontal offsets

**Minor Enhancement Opportunity (Non-blocking):**
The `_avoid_overlap()` method uses a practical alternating down/right search pattern. A potential future enhancement could implement a more sophisticated 2D grid search for extremely dense canvases, but the current approach is pragmatic and works well for the intended use case (canvas_utils.py:2318-2345).

### Compliance Check

- **Coding Standards (docs/architecture/coding-standards.md)**: âœ“ **Full Compliance**
  - PEP 8 compliant (proper naming, 4-space indentation, snake_case/PascalCase)
  - Google Style docstrings with Args/Returns/Raises/Example sections
  - Type hints on all parameters and return values
  - Proper error handling with specific exception types
  - Module-level constants properly defined (lines 136-141)

- **Project Structure (docs/architecture/unified-project-structure.md)**: âœ“ **Full Compliance**
  - Implementation correctly placed in `canvas_utils.py` CanvasBusinessLogic class
  - Tests properly organized in `tests/test_canvas_utils.py` TestCanvasBusinessLogic class
  - Fixture files created in `tests/fixtures/` directory
  - Follows Layer 2 architecture patterns

- **Testing Strategy**: âœ“ **Full Compliance**
  - Comprehensive test coverage (93% - exceeds 85% target)
  - All 8 tests passing (100% pass rate)
  - Performance test validates <50ms requirement
  - Unit tests cover edge cases and error conditions
  - Integration test confirms v1.1 compatibility

- **All ACs Met**: âœ“ **All 5 Acceptance Criteria Satisfied**
  - AC1: âœ“ No overlap with existing nodes (_check_overlap + _avoid_overlap)
  - AC2: âœ“ Consistent layout for same relationship types (relationship_type parameter)
  - AC3: âœ“ Sub-questions vertically arranged ("decomposition" type)
  - AC4: âœ“ Personal understanding horizontally arranged ("personal_understanding" type)
  - AC5: âœ“ Positioning calculation <50ms (verified by performance test)

### Test Coverage Review

**Test Coverage: 93%** ğŸ¯ *Exceeds 85% target*

**Test Suite Summary:**
- Total tests for Story 2.7: **8 tests**
- Pass rate: **100%** (8/8 passing)
- Execution time: **<0.1s** (excellent performance)

**Test Cases:**
1. âœ… `test_calculate_smart_position_decomposition_vertical` - Verifies AC3 (vertical arrangement)
2. âœ… `test_calculate_smart_position_siblings_offset` - Verifies multi-child horizontal offset
3. âœ… `test_calculate_smart_position_explanation` - Verifies explanation node positioning
4. âœ… `test_check_overlap_detects_collision` - Verifies AC1 (overlap detection)
5. âœ… `test_avoid_overlap_adjusts_position` - Verifies AC1 (overlap avoidance)
6. âœ… `test_calculate_smart_position_performance` - Verifies AC5 (<50ms with 100 nodes)
7. âœ… `test_calculate_smart_position_invalid_relationship_type` - Verifies error handling
8. âœ… `test_smart_position_does_not_break_v11_layout` - Verifies AC2 + v1.1 compatibility

**Test Quality:**
- Comprehensive edge case coverage
- Clear test documentation
- Performance validated with realistic data (100-node canvas)
- Integration testing confirms backward compatibility

### Security Review

**No security concerns identified.**

The implementation:
- Performs only read operations on canvas data structures
- Uses proper input validation (relationship_type validation)
- No external dependencies or network calls
- No file system modifications beyond intended canvas updates
- No injection vulnerabilities (all inputs are validated)

### Performance Considerations

**Performance: Excellent âœ“**

- **Positioning calculation**: <50ms with 100 nodes (AC5 satisfied)
- **Algorithm complexity**: O(n) for overlap detection, O(n*m) for overlap avoidance where m is max_attempts (10)
- **Optimization opportunities**:
  - Current performance exceeds requirements by wide margin
  - Relationship graph is rebuilt per call in `_offset_for_siblings`, but impact is negligible
  - No optimization needed at this time

**Performance Test Results:**
```
Test: test_calculate_smart_position_performance
Canvas size: 100 nodes
Execution time: <50ms âœ“
Status: PASS
```

### Documentation Quality

**Documentation: Excellent âœ“**

All methods have comprehensive Google Style docstrings including:
- Clear description of purpose and v1.1 compatibility notes
- Complete Args section with type information and descriptions
- Returns section with type and description
- Raises section documenting exceptions
- Example section demonstrating usage

**Code Comments:**
- Inline comments explain complex logic (overlap detection, avoidance strategy)
- Constants are well-documented with clear purpose
- Algorithm strategies documented in method docstrings

### Final Status

**âœ“ Approved - Ready for Done**

**Summary:**
Story 2.7 implementation is production-ready with excellent code quality. All 5 acceptance criteria are fully satisfied, test coverage exceeds targets (93% vs 85% goal), and the code follows all project standards. The smart positioning algorithm provides a solid foundation for future enhancements (deep decomposition, explanation chains) while maintaining full v1.1 layout compatibility.

**Outstanding Work:**
- Zero test failures (8/8 passing)
- Zero refactoring required
- Zero blocking issues
- Performance exceeds requirements
- Standards compliance: 100%

**Recommendation:** Update story status to "Done"
