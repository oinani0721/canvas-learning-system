# Story 13.6 - Pluginè®¾ç½®é¢æ¿å®ç°

**Epic**: Epic 13 - Obsidian Pluginæ ¸å¿ƒåŠŸèƒ½
**Story ID**: Story 13.6
**åˆ›å»ºæ—¥æœŸ**: 2025-11-30
**Storyç‚¹æ•°**: 5 Points
**é¢„ä¼°æ—¶é—´**: 4å¤©
**ä¼˜å…ˆçº§**: P1
**ä¾èµ–**: Story 13.1 (Pluginé¡¹ç›®åˆå§‹åŒ–), Story 13.3 (APIå®¢æˆ·ç«¯å®ç°)

---

## ğŸ“‹ Storyæè¿°

å®ç°Canvas Learning System Obsidian Pluginçš„å®Œæ•´è®¾ç½®é¢æ¿ï¼ŒåŒ…æ‹¬åç«¯æœåŠ¡å™¨URLé…ç½®ã€é»˜è®¤Agentå‚æ•°è®¾ç½®ã€ä¸»é¢˜å’Œæ˜¾ç¤ºè®¾ç½®ï¼Œä»¥åŠè¿æ¥çŠ¶æ€æ£€æµ‹åŠŸèƒ½ã€‚

**æ ¸å¿ƒç›®æ ‡**:
- åˆ›å»ºPluginè®¾ç½®é¡µé¢ï¼ˆPluginSettingTabï¼‰
- å®ç°åç«¯URLé…ç½®ï¼Œæ”¯æŒè¿æ¥çŠ¶æ€å®æ—¶æ£€æµ‹
- æä¾›é»˜è®¤Agentå‚æ•°è®¾ç½®ï¼ˆå¹¶å‘æ•°ã€è¶…æ—¶æ—¶é—´ç­‰ï¼‰
- æ”¯æŒä¸»é¢˜å’Œæ˜¾ç¤ºè®¾ç½®ï¼ˆèŠ‚ç‚¹é¢œè‰²è¯­ä¹‰ã€å¸ƒå±€å‚æ•°ï¼‰
- ä½¿ç”¨`loadData()`å’Œ`saveData()`æŒä¹…åŒ–é…ç½®

---

## ğŸ¯ ç”¨æˆ·æ•…äº‹ (User Story)

```
ä½œä¸ºObsidianç”¨æˆ·
å½“æˆ‘å®‰è£…Canvas Learning Systemæ’ä»¶å
æˆ‘å¸Œæœ›èƒ½å¤Ÿé€šè¿‡è®¾ç½®é¢æ¿é…ç½®åç«¯æœåŠ¡å™¨åœ°å€
å¹¶æµ‹è¯•è¿æ¥æ˜¯å¦æ­£å¸¸
åŒæ—¶è‡ªå®šä¹‰é»˜è®¤çš„å¤„ç†å‚æ•°å’Œæ˜¾ç¤ºåå¥½
è¿™æ ·æˆ‘å°±å¯ä»¥æ ¹æ®è‡ªå·±çš„ç¯å¢ƒå’Œä¹ æƒ¯ä¸ªæ€§åŒ–ä½¿ç”¨æ’ä»¶
```

---

## ğŸ›  æŠ€æœ¯èƒŒæ™¯

### Obsidian Plugin Settings API

**æ¥æº**: @obsidian-canvas Skill (references/README.md:50-52)

Obsidian Plugin API æä¾›ä»¥ä¸‹è®¾ç½®ç›¸å…³åŠŸèƒ½ï¼š
- `this.addSettingTab()` - æ·»åŠ æ’ä»¶è®¾ç½®é¡µç­¾
- `this.loadData()` - åŠ è½½å·²ä¿å­˜çš„æ’ä»¶æ•°æ®
- `this.saveData()` - ä¿å­˜æ’ä»¶æ•°æ®åˆ°æœ¬åœ°

**Settings Tab æ¨¡å¼**:
```typescript
// âœ… Verified from @obsidian-canvas Skill (README.md#Plugin-Architecture)
import { App, PluginSettingTab, Setting } from 'obsidian';

class CanvasLearningSettingTab extends PluginSettingTab {
  plugin: CanvasLearningPlugin;

  constructor(app: App, plugin: CanvasLearningPlugin) {
    super(app, plugin);
    this.plugin = plugin;
  }

  display(): void {
    const { containerEl } = this;
    containerEl.empty();
    // Add settings UI here
  }
}
```

### åç«¯APIç«¯ç‚¹

**æ¥æº**: specs/api/fastapi-backend-api.openapi.yml

ç”¨äºè¿æ¥æµ‹è¯•çš„å¥åº·æ£€æŸ¥ç«¯ç‚¹ï¼š
```yaml
# âœ… Verified from specs/api/fastapi-backend-api.openapi.yml#L49-68
GET /api/v1/health
Response:
  status: "healthy"
  app_name: "Canvas Learning System"
  version: "1.0.0"
  timestamp: "2025-11-24T10:30:00Z"
```

### å·²æœ‰ä¾èµ–

**Story 13.1**: Pluginé¡¹ç›®ç»“æ„å·²åˆå§‹åŒ–
- TypeScripté…ç½®
- æ„å»ºè„šæœ¬
- manifest.json

**Story 13.3**: APIå®¢æˆ·ç«¯å·²å®ç°
- HTTPè¯·æ±‚å°è£…
- é”™è¯¯å¤„ç†æœºåˆ¶
- é‡è¯•é€»è¾‘

---

## âœ… éªŒæ”¶æ ‡å‡† (Acceptance Criteria)

### åŠŸèƒ½éªŒæ”¶

**AC1**: Settings Tabæ­£ç¡®æ³¨å†Œ
- [ ] æ’ä»¶åŠ è½½åï¼Œè®¾ç½®é¡µé¢å‡ºç°åœ¨"è®¾ç½® â†’ ç¬¬ä¸‰æ–¹æ’ä»¶ â†’ Canvas Learning System"
- [ ] Settings Tabæ ‡é¢˜ä¸º"Canvas Learning System"
- [ ] Settings Tabå›¾æ ‡ä¸ºCanvasç›¸å…³å›¾æ ‡

**AC2**: åç«¯URLé…ç½®
- [ ] æä¾›æ–‡æœ¬è¾“å…¥æ¡†é…ç½®åç«¯æœåŠ¡å™¨URL
- [ ] é»˜è®¤å€¼ä¸º`http://localhost:8000`
- [ ] æ”¯æŒè‡ªå®šä¹‰ç«¯å£å’Œè·¯å¾„
- [ ] è¾“å…¥å˜åŒ–æ—¶è‡ªåŠ¨ä¿å­˜
- [ ] URLæ ¼å¼éªŒè¯ï¼ˆå¿…é¡»ä»¥http://æˆ–https://å¼€å¤´ï¼‰

**AC3**: è¿æ¥çŠ¶æ€æµ‹è¯•
- [ ] æä¾›"æµ‹è¯•è¿æ¥"æŒ‰é’®
- [ ] ç‚¹å‡»åè°ƒç”¨`GET /api/v1/health`ç«¯ç‚¹
- [ ] æˆåŠŸæ—¶æ˜¾ç¤ºç»¿è‰²çŠ¶æ€ï¼š"âœ… è¿æ¥æˆåŠŸ (version: x.x.x)"
- [ ] å¤±è´¥æ—¶æ˜¾ç¤ºçº¢è‰²çŠ¶æ€ï¼š"âŒ è¿æ¥å¤±è´¥: [é”™è¯¯ä¿¡æ¯]"
- [ ] æµ‹è¯•è¿‡ç¨‹ä¸­æ˜¾ç¤ºLoadingçŠ¶æ€

**AC4**: Agenté»˜è®¤å‚æ•°è®¾ç½®
- [ ] æœ€å¤§å¹¶å‘æ•°é…ç½®ï¼ˆ1-20ï¼Œé»˜è®¤12ï¼‰
- [ ] è¯·æ±‚è¶…æ—¶æ—¶é—´é…ç½®ï¼ˆ5-120ç§’ï¼Œé»˜è®¤30ç§’ï¼‰
- [ ] é»˜è®¤Agenté€‰æ‹©ï¼ˆä¸‹æ‹‰åˆ—è¡¨ï¼Œ6ç§è§£é‡ŠAgentï¼‰
- [ ] è‡ªåŠ¨é‡è¯•æ¬¡æ•°é…ç½®ï¼ˆ0-5æ¬¡ï¼Œé»˜è®¤3æ¬¡ï¼‰

**AC5**: ä¸»é¢˜å’Œæ˜¾ç¤ºè®¾ç½®
- [ ] é¢œè‰²è¯­ä¹‰è¯´æ˜ï¼ˆåªè¯»å±•ç¤ºï¼Œä¸å¯ä¿®æ”¹ï¼‰
- [ ] èŠ‚ç‚¹é»˜è®¤å®½åº¦é…ç½®ï¼ˆ200-800pxï¼Œé»˜è®¤400pxï¼‰
- [ ] èŠ‚ç‚¹é»˜è®¤é«˜åº¦é…ç½®ï¼ˆ100-600pxï¼Œé»˜è®¤300pxï¼‰
- [ ] æ°´å¹³é—´è·é…ç½®ï¼ˆ100-800pxï¼Œé»˜è®¤450pxï¼‰
- [ ] å‚ç›´é—´è·é…ç½®ï¼ˆ100-600pxï¼Œé»˜è®¤380pxï¼‰

**AC6**: æ•°æ®æŒä¹…åŒ–
- [ ] æ‰€æœ‰è®¾ç½®ä½¿ç”¨`saveData()`æŒä¹…åŒ–
- [ ] æ’ä»¶é‡æ–°åŠ è½½åè®¾ç½®ä¿ç•™
- [ ] æä¾›"æ¢å¤é»˜è®¤è®¾ç½®"æŒ‰é’®
- [ ] æ¢å¤é»˜è®¤æ—¶éœ€è¦ç¡®è®¤å¯¹è¯æ¡†

### éåŠŸèƒ½éªŒæ”¶

**AC7**: ç”¨æˆ·ä½“éªŒ
- [ ] è®¾ç½®é¡¹åˆ†ç»„æ¸…æ™°ï¼ˆæœåŠ¡å™¨é…ç½®/Agentå‚æ•°/æ˜¾ç¤ºè®¾ç½®ï¼‰
- [ ] æ¯ä¸ªè®¾ç½®é¡¹æœ‰è¯´æ˜æ–‡å­—
- [ ] è¾“å…¥éªŒè¯å®æ—¶åé¦ˆ
- [ ] æ— æ•ˆå€¼ä¸å…è®¸ä¿å­˜

**AC8**: æ€§èƒ½è¦æ±‚
- [ ] Settings Tabæ‰“å¼€æ—¶é—´<200ms
- [ ] è®¾ç½®ä¿å­˜æ—¶é—´<100ms
- [ ] è¿æ¥æµ‹è¯•è¶…æ—¶æ—¶é—´å¯é…ç½®

---

## ğŸ“ ä»»åŠ¡æ¸…å• (Task Checklist)

### Task 1: Settingsæ¥å£å’Œé»˜è®¤å€¼å®šä¹‰ â±ï¸ 0.5å¤©

**æè¿°**: å®šä¹‰Settings TypeScriptæ¥å£å’Œé»˜è®¤é…ç½®å€¼

**å®ç°æ­¥éª¤**:
1. [ ] åˆ›å»º`src/settings/types.ts`å®šä¹‰Settingsæ¥å£
2. [ ] åˆ›å»º`src/settings/defaults.ts`å®šä¹‰é»˜è®¤å€¼
3. [ ] å®šä¹‰Agentç±»å‹æšä¸¾
4. [ ] æ·»åŠ ç±»å‹å¯¼å‡º

**ä»£ç ç¤ºä¾‹**:
```typescript
// âœ… Verified from @obsidian-canvas Skill (Pattern: Plugin Settings)
// src/settings/types.ts

export interface CanvasLearningSettings {
  // æœåŠ¡å™¨é…ç½®
  backendUrl: string;
  connectionTimeout: number;
  maxRetries: number;

  // Agentå‚æ•°
  maxConcurrency: number;
  defaultAgent: AgentType;
  requestTimeout: number;

  // æ˜¾ç¤ºè®¾ç½®
  defaultNodeWidth: number;
  defaultNodeHeight: number;
  horizontalSpacing: number;
  verticalSpacing: number;
}

export type AgentType =
  | 'clarification-path'
  | 'oral-explanation'
  | 'memory-anchor'
  | 'comparison-table'
  | 'four-level-explanation'
  | 'example-teaching';

// src/settings/defaults.ts
export const DEFAULT_SETTINGS: CanvasLearningSettings = {
  // æœåŠ¡å™¨é…ç½®
  backendUrl: 'http://localhost:8000',
  connectionTimeout: 5000,
  maxRetries: 3,

  // Agentå‚æ•°
  maxConcurrency: 12,
  defaultAgent: 'oral-explanation',
  requestTimeout: 30000,

  // æ˜¾ç¤ºè®¾ç½®
  defaultNodeWidth: 400,
  defaultNodeHeight: 300,
  horizontalSpacing: 450,
  verticalSpacing: 380,
};
```

**éªŒæ”¶**:
- [ ] TypeScriptç¼–è¯‘é€šè¿‡
- [ ] ç±»å‹å®šä¹‰å®Œæ•´
- [ ] é»˜è®¤å€¼ç¬¦åˆä¸šåŠ¡éœ€æ±‚

---

### Task 2: PluginSettingTabå®ç° â±ï¸ 1.5å¤©

**æè¿°**: åˆ›å»ºè®¾ç½®é¡µé¢UIç»„ä»¶

**æŠ€æœ¯ç»†èŠ‚**:
- ç»§æ‰¿`PluginSettingTab`ç±»
- ä½¿ç”¨Obsidian `Setting` APIæ„å»ºUI
- åˆ†ç»„å±•ç¤ºè®¾ç½®é¡¹

**å®ç°æ­¥éª¤**:
1. [ ] åˆ›å»º`src/settings/SettingTab.ts`
2. [ ] å®ç°`display()`æ–¹æ³•
3. [ ] æ·»åŠ æœåŠ¡å™¨é…ç½®Section
4. [ ] æ·»åŠ Agentå‚æ•°Section
5. [ ] æ·»åŠ æ˜¾ç¤ºè®¾ç½®Section
6. [ ] æ·»åŠ æµ‹è¯•è¿æ¥æŒ‰é’®
7. [ ] æ·»åŠ æ¢å¤é»˜è®¤æŒ‰é’®

**ä»£ç ç¤ºä¾‹**:
```typescript
// âœ… Verified from @obsidian-canvas Skill (README.md#Plugin-Architecture)
// src/settings/SettingTab.ts

import { App, PluginSettingTab, Setting, Notice } from 'obsidian';
import CanvasLearningPlugin from '../main';
import { DEFAULT_SETTINGS, AgentType } from './types';

export class CanvasLearningSettingTab extends PluginSettingTab {
  plugin: CanvasLearningPlugin;

  constructor(app: App, plugin: CanvasLearningPlugin) {
    super(app, plugin);
    this.plugin = plugin;
  }

  display(): void {
    const { containerEl } = this;
    containerEl.empty();

    // Header
    containerEl.createEl('h1', { text: 'Canvas Learning System è®¾ç½®' });

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // Section 1: æœåŠ¡å™¨é…ç½®
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    containerEl.createEl('h2', { text: 'ğŸŒ æœåŠ¡å™¨é…ç½®' });

    new Setting(containerEl)
      .setName('åç«¯æœåŠ¡å™¨URL')
      .setDesc('FastAPIåç«¯æœåŠ¡å™¨åœ°å€ï¼ˆå¦‚ï¼šhttp://localhost:8000ï¼‰')
      .addText(text => text
        .setPlaceholder('http://localhost:8000')
        .setValue(this.plugin.settings.backendUrl)
        .onChange(async (value) => {
          // URLæ ¼å¼éªŒè¯
          if (this.isValidUrl(value)) {
            this.plugin.settings.backendUrl = value;
            await this.plugin.saveSettings();
          }
        }));

    // è¿æ¥æµ‹è¯•æŒ‰é’®
    new Setting(containerEl)
      .setName('è¿æ¥çŠ¶æ€')
      .setDesc('æµ‹è¯•ä¸åç«¯æœåŠ¡å™¨çš„è¿æ¥')
      .addButton(button => button
        .setButtonText('æµ‹è¯•è¿æ¥')
        .onClick(async () => {
          await this.testConnection(button);
        }));

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // Section 2: Agentå‚æ•°
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    containerEl.createEl('h2', { text: 'ğŸ¤– Agentå‚æ•°' });

    new Setting(containerEl)
      .setName('æœ€å¤§å¹¶å‘æ•°')
      .setDesc('åŒæ—¶å¤„ç†çš„æœ€å¤§Agentæ•°é‡ï¼ˆ1-20ï¼‰')
      .addSlider(slider => slider
        .setLimits(1, 20, 1)
        .setValue(this.plugin.settings.maxConcurrency)
        .setDynamicTooltip()
        .onChange(async (value) => {
          this.plugin.settings.maxConcurrency = value;
          await this.plugin.saveSettings();
        }));

    new Setting(containerEl)
      .setName('è¯·æ±‚è¶…æ—¶')
      .setDesc('å•ä¸ªè¯·æ±‚çš„è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰')
      .addSlider(slider => slider
        .setLimits(5, 120, 5)
        .setValue(this.plugin.settings.requestTimeout / 1000)
        .setDynamicTooltip()
        .onChange(async (value) => {
          this.plugin.settings.requestTimeout = value * 1000;
          await this.plugin.saveSettings();
        }));

    new Setting(containerEl)
      .setName('é»˜è®¤Agent')
      .setDesc('å•èŠ‚ç‚¹å¤„ç†æ—¶çš„é»˜è®¤Agent')
      .addDropdown(dropdown => {
        const agents: Record<AgentType, string> = {
          'clarification-path': 'ğŸ” æ¾„æ¸…è·¯å¾„',
          'oral-explanation': 'ğŸ—£ï¸ å£è¯­åŒ–è§£é‡Š',
          'memory-anchor': 'âš“ è®°å¿†é”šç‚¹',
          'comparison-table': 'ğŸ“Š å¯¹æ¯”è¡¨',
          'four-level-explanation': 'ğŸ¯ å››å±‚æ¬¡è§£é‡Š',
          'example-teaching': 'ğŸ“š ä¾‹é¢˜æ•™å­¦'
        };

        Object.entries(agents).forEach(([value, name]) => {
          dropdown.addOption(value, name);
        });

        dropdown
          .setValue(this.plugin.settings.defaultAgent)
          .onChange(async (value: AgentType) => {
            this.plugin.settings.defaultAgent = value;
            await this.plugin.saveSettings();
          });
      });

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // Section 3: æ˜¾ç¤ºè®¾ç½®
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    containerEl.createEl('h2', { text: 'ğŸ¨ æ˜¾ç¤ºè®¾ç½®' });

    // é¢œè‰²è¯­ä¹‰è¯´æ˜ï¼ˆåªè¯»ï¼‰
    const colorInfo = containerEl.createDiv({ cls: 'canvas-learning-color-info' });
    colorInfo.createEl('p', { text: 'é¢œè‰²è¯­ä¹‰è¯´æ˜ï¼ˆä¸å¯ä¿®æ”¹ï¼‰ï¼š' });
    colorInfo.createEl('p', { text: 'ğŸ”´ çº¢è‰² (1) = ä¸ç†è§£/æœªé€šè¿‡' });
    colorInfo.createEl('p', { text: 'ğŸŸ¢ ç»¿è‰² (2) = å®Œå…¨ç†è§£/å·²é€šè¿‡' });
    colorInfo.createEl('p', { text: 'ğŸŸ£ ç´«è‰² (3) = ä¼¼æ‡‚éæ‡‚/å¾…æ£€éªŒ' });
    colorInfo.createEl('p', { text: 'ğŸ”µ è“è‰² (5) = AIè§£é‡Šæ–‡æ¡£' });
    colorInfo.createEl('p', { text: 'ğŸŸ¡ é»„è‰² (6) = ä¸ªäººç†è§£è¾“å‡ºåŒº' });

    new Setting(containerEl)
      .setName('èŠ‚ç‚¹é»˜è®¤å®½åº¦')
      .setDesc('æ–°å»ºèŠ‚ç‚¹çš„é»˜è®¤å®½åº¦ï¼ˆpxï¼‰')
      .addSlider(slider => slider
        .setLimits(200, 800, 50)
        .setValue(this.plugin.settings.defaultNodeWidth)
        .setDynamicTooltip()
        .onChange(async (value) => {
          this.plugin.settings.defaultNodeWidth = value;
          await this.plugin.saveSettings();
        }));

    new Setting(containerEl)
      .setName('èŠ‚ç‚¹é»˜è®¤é«˜åº¦')
      .setDesc('æ–°å»ºèŠ‚ç‚¹çš„é»˜è®¤é«˜åº¦ï¼ˆpxï¼‰')
      .addSlider(slider => slider
        .setLimits(100, 600, 50)
        .setValue(this.plugin.settings.defaultNodeHeight)
        .setDynamicTooltip()
        .onChange(async (value) => {
          this.plugin.settings.defaultNodeHeight = value;
          await this.plugin.saveSettings();
        }));

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // Section 4: æ“ä½œ
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    containerEl.createEl('h2', { text: 'âš™ï¸ æ“ä½œ' });

    new Setting(containerEl)
      .setName('æ¢å¤é»˜è®¤è®¾ç½®')
      .setDesc('å°†æ‰€æœ‰è®¾ç½®æ¢å¤ä¸ºé»˜è®¤å€¼')
      .addButton(button => button
        .setButtonText('æ¢å¤é»˜è®¤')
        .setWarning()
        .onClick(async () => {
          await this.resetToDefaults();
        }));
  }

  private isValidUrl(url: string): boolean {
    try {
      new URL(url);
      return url.startsWith('http://') || url.startsWith('https://');
    } catch {
      return false;
    }
  }

  private async testConnection(button: any): Promise<void> {
    // Implementation in Task 3
  }

  private async resetToDefaults(): Promise<void> {
    // Implementation in Task 4
  }
}
```

**éªŒæ”¶**:
- [ ] Settings Tabæ­£ç¡®æ˜¾ç¤º
- [ ] æ‰€æœ‰è®¾ç½®é¡¹å¯äº¤äº’
- [ ] UIå¸ƒå±€æ¸…æ™°

---

### Task 3: è¿æ¥æµ‹è¯•åŠŸèƒ½å®ç° â±ï¸ 1å¤©

**æè¿°**: å®ç°åç«¯æœåŠ¡å™¨è¿æ¥çŠ¶æ€æ£€æµ‹

**æŠ€æœ¯ç»†èŠ‚**:
- è°ƒç”¨`GET /api/v1/health`ç«¯ç‚¹
- å¤„ç†æˆåŠŸ/å¤±è´¥/è¶…æ—¶æƒ…å†µ
- æ›´æ–°UIçŠ¶æ€æ˜¾ç¤º

**å®ç°æ­¥éª¤**:
1. [ ] å®ç°`testConnection()`æ–¹æ³•
2. [ ] æ·»åŠ LoadingçŠ¶æ€
3. [ ] å¤„ç†æˆåŠŸå“åº”
4. [ ] å¤„ç†é”™è¯¯å“åº”
5. [ ] æ·»åŠ çŠ¶æ€æ˜¾ç¤ºå…ƒç´ 

**ä»£ç ç¤ºä¾‹**:
```typescript
// âœ… Verified from specs/api/fastapi-backend-api.openapi.yml#L49-68
// Health check response handling

private async testConnection(button: any): Promise<void> {
  const statusEl = button.buttonEl.parentElement?.querySelector('.connection-status');

  // æ˜¾ç¤ºLoadingçŠ¶æ€
  button.setButtonText('æµ‹è¯•ä¸­...');
  button.setDisabled(true);

  try {
    const response = await fetch(
      `${this.plugin.settings.backendUrl}/api/v1/health`,
      {
        method: 'GET',
        headers: { 'Accept': 'application/json' },
        signal: AbortSignal.timeout(this.plugin.settings.connectionTimeout)
      }
    );

    if (response.ok) {
      // âœ… Verified from specs/api/fastapi-backend-api.openapi.yml#L62-67
      const data = await response.json();
      this.showStatus(statusEl, 'success',
        `âœ… è¿æ¥æˆåŠŸ (ç‰ˆæœ¬: ${data.version})`);
    } else {
      this.showStatus(statusEl, 'error',
        `âŒ æœåŠ¡å™¨é”™è¯¯: ${response.status}`);
    }
  } catch (error) {
    if (error.name === 'TimeoutError') {
      this.showStatus(statusEl, 'error', 'âŒ è¿æ¥è¶…æ—¶');
    } else {
      this.showStatus(statusEl, 'error',
        `âŒ è¿æ¥å¤±è´¥: ${error.message}`);
    }
  } finally {
    button.setButtonText('æµ‹è¯•è¿æ¥');
    button.setDisabled(false);
  }
}

private showStatus(el: Element | null, type: 'success' | 'error', message: string): void {
  if (!el) return;
  el.textContent = message;
  el.className = `connection-status ${type}`;
}
```

**éªŒæ”¶**:
- [ ] è¿æ¥æˆåŠŸæ˜¾ç¤ºç»¿è‰²çŠ¶æ€
- [ ] è¿æ¥å¤±è´¥æ˜¾ç¤ºçº¢è‰²çŠ¶æ€
- [ ] è¶…æ—¶æƒ…å†µæ­£ç¡®å¤„ç†
- [ ] LoadingçŠ¶æ€æ­£ç¡®æ˜¾ç¤º

---

### Task 4: æ•°æ®æŒä¹…åŒ–å’Œæ¢å¤é»˜è®¤ â±ï¸ 0.5å¤©

**æè¿°**: å®ç°è®¾ç½®çš„ä¿å­˜ã€åŠ è½½å’Œæ¢å¤é»˜è®¤åŠŸèƒ½

**æŠ€æœ¯ç»†èŠ‚**:
- ä½¿ç”¨`this.loadData()`å’Œ`this.saveData()`
- åˆå¹¶å·²ä¿å­˜è®¾ç½®å’Œé»˜è®¤å€¼
- æ¢å¤é»˜è®¤éœ€è¦ç¡®è®¤

**å®ç°æ­¥éª¤**:
1. [ ] åœ¨Pluginä¸»ç±»ä¸­å®ç°`loadSettings()`
2. [ ] åœ¨Pluginä¸»ç±»ä¸­å®ç°`saveSettings()`
3. [ ] å®ç°`resetToDefaults()`æ–¹æ³•
4. [ ] æ·»åŠ ç¡®è®¤å¯¹è¯æ¡†

**ä»£ç ç¤ºä¾‹**:
```typescript
// âœ… Verified from @obsidian-canvas Skill (README.md#Save-Load-Data)
// main.ts

export default class CanvasLearningPlugin extends Plugin {
  settings: CanvasLearningSettings;

  async onload() {
    await this.loadSettings();
    this.addSettingTab(new CanvasLearningSettingTab(this.app, this));
  }

  async loadSettings() {
    // åˆå¹¶å·²ä¿å­˜è®¾ç½®å’Œé»˜è®¤å€¼
    this.settings = Object.assign({}, DEFAULT_SETTINGS, await this.loadData());
  }

  async saveSettings() {
    await this.saveData(this.settings);
  }
}

// SettingTab.ts - resetToDefaults
private async resetToDefaults(): Promise<void> {
  const confirmed = await this.confirmReset();
  if (confirmed) {
    this.plugin.settings = { ...DEFAULT_SETTINGS };
    await this.plugin.saveSettings();
    new Notice('è®¾ç½®å·²æ¢å¤ä¸ºé»˜è®¤å€¼');
    // åˆ·æ–°Settings Tab
    this.display();
  }
}

private async confirmReset(): Promise<boolean> {
  return new Promise((resolve) => {
    const modal = new ConfirmModal(
      this.app,
      'ç¡®è®¤æ¢å¤é»˜è®¤è®¾ç½®',
      'æ­¤æ“ä½œå°†é‡ç½®æ‰€æœ‰è®¾ç½®ä¸ºé»˜è®¤å€¼ï¼Œç¡®å®šç»§ç»­å—ï¼Ÿ',
      () => resolve(true),
      () => resolve(false)
    );
    modal.open();
  });
}
```

**éªŒæ”¶**:
- [ ] è®¾ç½®ä¿å­˜åé‡æ–°åŠ è½½ä¿ç•™
- [ ] æ¢å¤é»˜è®¤æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†
- [ ] æ¢å¤åUIæ­£ç¡®åˆ·æ–°

---

### Task 5: æ ·å¼å’ŒCSS â±ï¸ 0.5å¤©

**æè¿°**: æ·»åŠ Settings Tabçš„è‡ªå®šä¹‰æ ·å¼

**å®ç°æ­¥éª¤**:
1. [ ] åˆ›å»º`src/styles/settings.css`
2. [ ] æ·»åŠ é¢œè‰²ä¿¡æ¯åŒºåŸŸæ ·å¼
3. [ ] æ·»åŠ è¿æ¥çŠ¶æ€æ ·å¼
4. [ ] æ·»åŠ åˆ†ç»„æ ‡é¢˜æ ·å¼

**ä»£ç ç¤ºä¾‹**:
```css
/* src/styles/settings.css */

/* é¢œè‰²ä¿¡æ¯åŒºåŸŸ */
.canvas-learning-color-info {
  background-color: var(--background-secondary);
  padding: 10px 15px;
  border-radius: 5px;
  margin-bottom: 15px;
  font-size: 0.9em;
}

.canvas-learning-color-info p {
  margin: 5px 0;
}

/* è¿æ¥çŠ¶æ€ */
.connection-status {
  margin-top: 8px;
  padding: 5px 10px;
  border-radius: 4px;
  font-size: 0.85em;
}

.connection-status.success {
  background-color: var(--background-modifier-success);
  color: var(--text-success);
}

.connection-status.error {
  background-color: var(--background-modifier-error);
  color: var(--text-error);
}

/* Sectionæ ‡é¢˜ */
.setting-item-heading h2 {
  margin-top: 20px;
  padding-bottom: 5px;
  border-bottom: 1px solid var(--background-modifier-border);
}
```

**éªŒæ”¶**:
- [ ] æ ·å¼æ­£ç¡®åŠ è½½
- [ ] æ·±è‰²/æµ…è‰²ä¸»é¢˜å…¼å®¹
- [ ] è§†è§‰æ•ˆæœç¬¦åˆObsidiané£æ ¼

---

## ğŸ”— ä¾èµ–å…³ç³»

### ä¾èµ–çš„Story

**Story 13.1**: Pluginé¡¹ç›®åˆå§‹åŒ–
- å¿…é¡»å…ˆå®Œæˆï¼Œæä¾›TypeScripté¡¹ç›®ç»“æ„
- æä¾›manifest.jsonå’Œæ„å»ºé…ç½®

**Story 13.3**: APIå®¢æˆ·ç«¯å®ç°
- æä¾›HTTPè¯·æ±‚å°è£…
- æä¾›é”™è¯¯å¤„ç†æœºåˆ¶

### è¢«ä¾èµ–çš„Story

**Story 13.4**: æ ¸å¿ƒå‘½ä»¤å®ç°
- ä¾èµ–Settingsè·å–backendUrl
- ä¾èµ–Settingsè·å–defaultAgent

**Story 13.7**: é”™è¯¯å¤„ç†
- ä¾èµ–Settingsè·å–maxRetries
- ä¾èµ–Settingsè·å–requestTimeout

---

## ğŸ“Š æµ‹è¯•è®¡åˆ’

### å•å…ƒæµ‹è¯•

**Test 1**: Settingsæ¥å£æµ‹è¯•
- [ ] DEFAULT_SETTINGSç¬¦åˆæ¥å£å®šä¹‰
- [ ] AgentTypeæšä¸¾å€¼å®Œæ•´

**Test 2**: URLéªŒè¯æµ‹è¯•
- [ ] æœ‰æ•ˆURLè¿”å›true
- [ ] æ— æ•ˆURLè¿”å›false
- [ ] ç©ºå­—ç¬¦ä¸²è¿”å›false

**Test 3**: æ•°æ®æŒä¹…åŒ–æµ‹è¯•
- [ ] saveSettingsæ­£ç¡®ä¿å­˜
- [ ] loadSettingsæ­£ç¡®åŠ è½½
- [ ] éƒ¨åˆ†è®¾ç½®ç¼ºå¤±æ—¶ä½¿ç”¨é»˜è®¤å€¼

### é›†æˆæµ‹è¯•

**Test 4**: E2Eæµ‹è¯• - æ­£å¸¸æµç¨‹
1. æ‰“å¼€è®¾ç½®é¡µé¢
2. ä¿®æ”¹åç«¯URL
3. ç‚¹å‡»æµ‹è¯•è¿æ¥
4. éªŒè¯è¿æ¥çŠ¶æ€æ˜¾ç¤º
5. å…³é—­è®¾ç½®é¡µé¢
6. é‡æ–°æ‰“å¼€ï¼ŒéªŒè¯è®¾ç½®ä¿ç•™

**Test 5**: E2Eæµ‹è¯• - æ¢å¤é»˜è®¤
1. ä¿®æ”¹å¤šä¸ªè®¾ç½®é¡¹
2. ç‚¹å‡»æ¢å¤é»˜è®¤
3. ç¡®è®¤å¯¹è¯æ¡†ç‚¹å‡»ç¡®è®¤
4. éªŒè¯æ‰€æœ‰è®¾ç½®æ¢å¤ä¸ºé»˜è®¤å€¼

**Test 6**: E2Eæµ‹è¯• - è¿æ¥å¤±è´¥
1. è®¾ç½®é”™è¯¯çš„åç«¯URL
2. ç‚¹å‡»æµ‹è¯•è¿æ¥
3. éªŒè¯æ˜¾ç¤ºé”™è¯¯çŠ¶æ€

---

## ğŸ“š æŠ€æœ¯æ–‡æ¡£

### SDDè§„èŒƒå¼•ç”¨

| è§„èŒƒæ–‡ä»¶ | ç”¨é€” | å¼•ç”¨ä½ç½® |
|---------|------|----------|
| `specs/api/fastapi-backend-api.openapi.yml#L49-68` | å¥åº·æ£€æŸ¥APIå®šä¹‰ | Task 3 è¿æ¥æµ‹è¯• |
| `specs/data/canvas-node.schema.json#/properties/color` | èŠ‚ç‚¹é¢œè‰²å€¼å®šä¹‰ | Task 2 é¢œè‰²è¯´æ˜ |

### ADRå¼•ç”¨

| ADR | å†³ç­–å†…å®¹ | ç›¸å…³æ€§ |
|-----|---------|--------|
| `ADR-0001-use-obsidian-canvas.md` | ä½¿ç”¨Obsidian Canvasä½œä¸ºå¯è§†åŒ–è½½ä½“ | é¢œè‰²ç³»ç»Ÿè¯­ä¹‰æ˜ å°„ |

### Skillå¼•ç”¨

| Skill | ç”¨é€” | å¼•ç”¨ä½ç½® |
|-------|------|----------|
| `@obsidian-canvas` | Obsidian Plugin API (PluginSettingTab, loadData, saveData) | Task 1-4 |

---

## ğŸš€ éƒ¨ç½²è¯´æ˜

### å¼€å‘ç¯å¢ƒ

```bash
# 1. è¿›å…¥Pluginç›®å½•
cd obsidian-plugin

# 2. å®‰è£…ä¾èµ–
npm install

# 3. å¼€å‘æ¨¡å¼æ„å»º
npm run dev

# 4. åœ¨Obsidianä¸­å¯ç”¨Plugin
# è®¾ç½® â†’ ç¬¬ä¸‰æ–¹æ’ä»¶ â†’ Canvas Learning System â†’ å¯ç”¨
# ç„¶åè®¿é—® è®¾ç½® â†’ Canvas Learning System æŸ¥çœ‹è®¾ç½®é¢æ¿
```

### æ–‡ä»¶ç»“æ„

```
obsidian-plugin/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ main.ts                  # Pluginä¸»å…¥å£
â”‚   â”œâ”€â”€ settings/
â”‚   â”‚   â”œâ”€â”€ types.ts             # Settingsæ¥å£å®šä¹‰
â”‚   â”‚   â”œâ”€â”€ defaults.ts          # é»˜è®¤è®¾ç½®å€¼
â”‚   â”‚   â””â”€â”€ SettingTab.ts        # Settings UIç»„ä»¶
â”‚   â””â”€â”€ styles/
â”‚       â””â”€â”€ settings.css         # Settingsæ ·å¼
â”œâ”€â”€ manifest.json
â””â”€â”€ package.json
```

---

## âš ï¸ é£é™©å’Œç¼“è§£ç­–ç•¥

### é£é™©1: Obsidian APIå˜æ›´ âš ï¸ ä½é£é™©

**æè¿°**: Obsidianæ›´æ–°å¯èƒ½å¯¼è‡´Settings APIå˜æ›´

**ç¼“è§£ç­–ç•¥**:
- ä½¿ç”¨å®˜æ–¹æ¨èçš„PluginSettingTabæ¨¡å¼
- ç›‘æ§Obsidianæ›´æ–°æ—¥å¿—
- æ·»åŠ APIç‰ˆæœ¬æ£€æŸ¥

### é£é™©2: è®¾ç½®è¿ç§» âš ï¸ ä½é£é™©

**æè¿°**: æœªæ¥ç‰ˆæœ¬å¯èƒ½éœ€è¦è¿ç§»æ—§è®¾ç½®æ ¼å¼

**ç¼“è§£ç­–ç•¥**:
- ä½¿ç”¨ç‰ˆæœ¬å·æ ‡è®°è®¾ç½®æ ¼å¼
- å®ç°è®¾ç½®è¿ç§»é€»è¾‘
- ä¿ç•™å‘åå…¼å®¹æ€§

---

## ğŸ“ Storyå®Œæˆå®šä¹‰ (Definition of Done)

- [ ] æ‰€æœ‰5ä¸ªTaskå®Œæˆå¹¶é€šè¿‡Code Review
- [ ] æ‰€æœ‰6ä¸ªåŠŸèƒ½éªŒæ”¶æ ‡å‡†é€šè¿‡
- [ ] æ‰€æœ‰2ä¸ªéåŠŸèƒ½éªŒæ”¶æ ‡å‡†é€šè¿‡
- [ ] å•å…ƒæµ‹è¯•è¦†ç›–ç‡â‰¥80%
- [ ] é›†æˆæµ‹è¯•é€šè¿‡ï¼ˆè‡³å°‘3ä¸ªE2Eåœºæ™¯ï¼‰
- [ ] æ·±è‰²/æµ…è‰²ä¸»é¢˜å…¼å®¹æµ‹è¯•é€šè¿‡
- [ ] æŠ€æœ¯æ–‡æ¡£æ›´æ–°
- [ ] Code Reviewé€šè¿‡ï¼ˆè‡³å°‘1ä¸ªå®¡é˜…è€…æ‰¹å‡†ï¼‰
- [ ] éƒ¨ç½²åˆ°æµ‹è¯•ç¯å¢ƒå¹¶éªŒè¯

---

## ğŸ‰ Storyä»·å€¼

**ç”¨æˆ·ä»·å€¼**:
- æä¾›ä¸ªæ€§åŒ–é…ç½®èƒ½åŠ›
- ç®€åŒ–åç«¯æœåŠ¡å™¨è¿æ¥é…ç½®
- å¯è§†åŒ–è¿æ¥çŠ¶æ€åé¦ˆ

**æŠ€æœ¯ä»·å€¼**:
- å»ºç«‹ç»Ÿä¸€çš„é…ç½®ç®¡ç†æ¨¡å¼
- ä¸ºå…¶ä»–åŠŸèƒ½æä¾›é…ç½®åŸºç¡€
- æé«˜ä»£ç å¯ç»´æŠ¤æ€§

**å•†ä¸šä»·å€¼**:
- é™ä½ç”¨æˆ·ä¸Šæ‰‹é—¨æ§›
- æå‡äº§å“ä¸“ä¸šåº¦
- æ”¯æŒå¤šç¯å¢ƒéƒ¨ç½²åœºæ™¯

---

## ğŸ”„ Dev Notes (å¼€å‘å¤‡æ³¨)

### å…³é”®æŠ€æœ¯ç‚¹

1. **Obsidian Plugin Settings API**
   - æ¥æº: @obsidian-canvas Skill (README.md#Plugin-Architecture)
   - `this.addSettingTab(new PluginSettingTab())` æ³¨å†Œè®¾ç½®é¡µç­¾
   - `this.loadData()` / `this.saveData()` æŒä¹…åŒ–æ•°æ®

2. **Setting UIç»„ä»¶**
   - ä½¿ç”¨ `new Setting(containerEl)` åˆ›å»ºè®¾ç½®é¡¹
   - `.addText()` æ–‡æœ¬è¾“å…¥
   - `.addSlider()` æ»‘å—
   - `.addDropdown()` ä¸‹æ‹‰é€‰æ‹©
   - `.addButton()` æŒ‰é’®

3. **å¥åº·æ£€æŸ¥API**
   - æ¥æº: specs/api/fastapi-backend-api.openapi.yml#L49-68
   - ç«¯ç‚¹: `GET /api/v1/health`
   - å“åº”: `{ status, app_name, version, timestamp }`

4. **é¢œè‰²ç³»ç»Ÿ**
   - æ¥æº: ADR-0001-use-obsidian-canvas.md#L60-62
   - çº¢(1)=ä¸ç†è§£, ç»¿(2)=å®Œå…¨ç†è§£, ç´«(3)=ä¼¼æ‡‚éæ‡‚
   - è“(5)=AIè§£é‡Š, é»„(6)=ä¸ªäººç†è§£

### åå¹»è§‰éªŒè¯

| æŠ€æœ¯ç‚¹ | éªŒè¯æ¥æº | éªŒè¯çŠ¶æ€ |
|-------|---------|---------|
| PluginSettingTab API | @obsidian-canvas Skill | âœ… |
| loadData/saveData | @obsidian-canvas Skill | âœ… |
| Setting UIç»„ä»¶ | @obsidian-canvas Skill | âœ… |
| Health Check API | specs/api/fastapi-backend-api.openapi.yml | âœ… |
| é¢œè‰²ä»£ç æ˜ å°„ | ADR-0001-use-obsidian-canvas.md | âœ… |

---

**Storyåˆ›å»ºæ—¥æœŸ**: 2025-11-30
**Storyä½œè€…**: SM Agent (Bob)
**å®¡æ‰¹çŠ¶æ€**: â³ å¾…ç”¨æˆ·å®¡æ‰¹
