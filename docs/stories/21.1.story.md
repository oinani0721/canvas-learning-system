# Story 21.1: ç»Ÿä¸€ä½ç½®ä¿¡æ¯æå–

## Status
ğŸ”„ In Development

## Story

**As a** AgentæœåŠ¡,
**I want** æ‰€æœ‰Agentç«¯ç‚¹éƒ½èƒ½æ­£ç¡®æå–æºèŠ‚ç‚¹ä½ç½®ä¿¡æ¯,
**so that** ç”Ÿæˆçš„æ–°èŠ‚ç‚¹èƒ½å¤Ÿæ­£ç¡®æ”¾ç½®åœ¨Canvasä¸Šã€‚

## Acceptance Criteria

1. AC-21.1.1: decompose_basic æå–å®Œæ•´ä½ç½®ä¿¡æ¯ (x, y, width, height)
2. AC-21.1.2: decompose_deep æå–å®Œæ•´ä½ç½®ä¿¡æ¯
3. AC-21.1.3: explain_oral ä¿æŒç°æœ‰æ­£ç¡®å®ç°
4. AC-21.1.4: æ‰€æœ‰Agentç«¯ç‚¹ä½¿ç”¨ç»Ÿä¸€çš„ä½ç½®æå–å‡½æ•°
5. AC-21.1.5: å•å…ƒæµ‹è¯•è¦†ç›–ä½ç½®æå–é€»è¾‘

## Tasks / Subtasks

- [ ] Task 1: åˆ›å»ºç»Ÿä¸€ä½ç½®æå–å‡½æ•° (AC: 4)
  - [ ] å®šä¹‰ extract_node_position å‡½æ•°
  - [ ] æå– x, y, width, height å‚æ•°
  - [ ] æä¾›åˆç†çš„é»˜è®¤å€¼ (0, 0, 400, 200)
  - [ ] æ·»åŠ ç±»å‹æ³¨è§£

- [ ] Task 2: æ›´æ–° decompose_basic ç«¯ç‚¹ (AC: 1)
  - [ ] å¯¼å…¥ä½ç½®æå–å‡½æ•°
  - [ ] è°ƒç”¨æå–å‡½æ•°è·å–ä½ç½®
  - [ ] å°†ä½ç½®å‚æ•°ä¼ é€’ç»™æœåŠ¡å±‚

- [ ] Task 3: æ›´æ–° decompose_deep ç«¯ç‚¹ (AC: 2)
  - [ ] å¯¼å…¥ä½ç½®æå–å‡½æ•°
  - [ ] è°ƒç”¨æå–å‡½æ•°è·å–ä½ç½®
  - [ ] å°†ä½ç½®å‚æ•°ä¼ é€’ç»™æœåŠ¡å±‚

- [ ] Task 4: éªŒè¯ explain_oral å®ç° (AC: 3)
  - [ ] æ£€æŸ¥ç°æœ‰å®ç°æ˜¯å¦æ­£ç¡®
  - [ ] ç¡®ä¿ä½¿ç”¨ç»Ÿä¸€çš„æå–å‡½æ•°
  - [ ] æ·»åŠ å›å½’æµ‹è¯•

- [ ] Task 5: æ›´æ–°å…¶ä»–Agentç«¯ç‚¹ (AC: 4)
  - [ ] clarification_path
  - [ ] comparison_table
  - [ ] memory_anchor
  - [ ] example_teaching
  - [ ] question_decomposition
  - [ ] verification_question

- [ ] Task 6: ç¼–å†™å•å…ƒæµ‹è¯• (AC: 5)
  - [ ] æµ‹è¯•æ­£å¸¸ä½ç½®æå–
  - [ ] æµ‹è¯•ç¼ºå¤±å­—æ®µæ—¶çš„é»˜è®¤å€¼
  - [ ] æµ‹è¯•è¾¹ç•Œæƒ…å†µ

## Dev Notes

### æ¶æ„ä¸Šä¸‹æ–‡

**é—®é¢˜æ ¹å› ** [Source: docs/prd/EPIC-21-AGENT-E2E-FLOW-FIX.md#é—®é¢˜åˆ†æ]

å››å±‚çº§è§£é‡Šæ­£å¸¸å·¥ä½œï¼Œè€Œå…¶ä»–Agentä¸å·¥ä½œçš„å…³é”®å·®å¼‚ä¹‹ä¸€æ˜¯ä½ç½®ä¿¡æ¯æå–:

```python
# âœ… å››å±‚çº§è§£é‡Š - æ­£ç¡®æå–ä½ç½®
source_x = enriched_context.target_node.get("x", 0)
source_y = enriched_context.target_node.get("y", 0)
source_width = enriched_context.target_node.get("width", 400)
source_height = enriched_context.target_node.get("height", 200)

# âŒ å…¶ä»–Agent - ä½¿ç”¨é»˜è®¤å€¼æˆ–ä¸æå–
# å¯¼è‡´æ–°èŠ‚ç‚¹ä½ç½®åœ¨(0,0)ï¼Œå¯èƒ½ä¸Canvaså¤–åŒºåŸŸäº¤äº’
```

### å®ç°å‚è€ƒ

**ç»Ÿä¸€ä½ç½®æå–å‡½æ•°** [Source: docs/prd/EPIC-21-AGENT-E2E-FLOW-FIX.md#æŠ€æœ¯æ¶æ„]

```python
# backend/app/api/v1/endpoints/agents.py

from typing import Tuple, Dict, Any

def extract_node_position(node: Dict[str, Any]) -> Tuple[int, int, int, int]:
    """
    ç»Ÿä¸€æå–èŠ‚ç‚¹ä½ç½®ä¿¡æ¯

    Args:
        node: CanvasèŠ‚ç‚¹æ•°æ®å­—å…¸

    Returns:
        Tuple[x, y, width, height] - ä½ç½®å’Œå°ºå¯¸ä¿¡æ¯
    """
    return (
        node.get("x", 0),
        node.get("y", 0),
        node.get("width", 400),
        node.get("height", 200)
    )
```

**ç«¯ç‚¹æ›´æ–°ç¤ºä¾‹**:

```python
@agents_router.post("/decompose/basic")
async def decompose_basic(request: DecomposeRequest):
    # è·å–Canvasæ•°æ®å’Œç›®æ ‡èŠ‚ç‚¹
    canvas_data = await load_canvas(request.canvas_path)
    node = find_node_by_id(canvas_data, request.node_id)

    # âœ… ä½¿ç”¨ç»Ÿä¸€å‡½æ•°æå–ä½ç½®
    source_x, source_y, source_width, source_height = extract_node_position(node)

    content = node.get("text", "")
    result = await agent_service.decompose_basic(
        content=content,
        source_x=source_x,
        source_y=source_y,
        source_width=source_width,
        source_height=source_height
    )
    return result
```

### å…³é”®æ–‡ä»¶

- `backend/app/api/v1/endpoints/agents.py` - ä¸»è¦ä¿®æ”¹æ–‡ä»¶
- `backend/tests/unit/test_agent_position.py` - æ–°å¢æµ‹è¯•æ–‡ä»¶

### æµ‹è¯•è¦æ±‚

**å•å…ƒæµ‹è¯•è¦†ç›–**:
- æµ‹è¯•æ­£å¸¸èŠ‚ç‚¹çš„ä½ç½®æå–
- æµ‹è¯•ç¼ºå¤±x/yæ—¶çš„é»˜è®¤å€¼
- æµ‹è¯•ç¼ºå¤±width/heightæ—¶çš„é»˜è®¤å€¼
- æµ‹è¯•ç©ºèŠ‚ç‚¹çš„å¤„ç†
- æµ‹è¯•è´Ÿå€¼åæ ‡çš„å¤„ç†

## SDDè§„èŒƒå¼•ç”¨

- **OpenAPI Spec**: `specs/api/canvas-api.openapi.yml#/components/schemas/NodePosition`
- **æ¶æ„æ–‡æ¡£**: `docs/prd/EPIC-21-AGENT-E2E-FLOW-FIX.md#æŠ€æœ¯æ¶æ„`

## ADRå…³è”

æ— ç›´æ¥å…³è”çš„ADRã€‚æ­¤ Story ä¸º Bug Fixï¼Œä¸æ¶‰åŠæ¶æ„å†³ç­–å˜æ›´ã€‚

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-12 | 1.0 | åˆå§‹Storyåˆ›å»º | SM Agent (Bob) |
