# Story 21.5.4: Agentç«¯ç‚¹å¥åº·æ£€æŸ¥å¢å¼º

## Status
ğŸ†• Ready for Development

## Story

**As a** å¼€å‘è€…æˆ–è¿ç»´äººå‘˜,
**I want** èƒ½å¤Ÿé€šè¿‡å¥åº·æ£€æŸ¥ç«¯ç‚¹å¿«é€Ÿè¯Šæ–­AgentåŠŸèƒ½çŠ¶æ€,
**so that** å¯ä»¥åœ¨é—®é¢˜å‘ç”Ÿæ—¶å¿«é€Ÿå®šä½æ˜¯AIè¿æ¥ã€é…ç½®è¿˜æ˜¯æœåŠ¡æœ¬èº«çš„é—®é¢˜ã€‚

## Acceptance Criteria

1. AC-21.5.4.1: `/health/agents` ç«¯ç‚¹è¿”å›æ‰€æœ‰Agentç«¯ç‚¹çš„å¯ç”¨çŠ¶æ€
2. AC-21.5.4.2: `/health/ai` ç«¯ç‚¹æµ‹è¯•AI APIè¿æ¥å¹¶è¿”å›ç»“æœ
3. AC-21.5.4.3: `/health/full` ç«¯ç‚¹è¿”å›å®Œæ•´ç³»ç»Ÿè¯Šæ–­ä¿¡æ¯
4. AC-21.5.4.4: ä¸€æ¬¡è¯·æ±‚å³å¯çŸ¥é“æ‰€æœ‰æœåŠ¡çŠ¶æ€
5. AC-21.5.4.5: å¥åº·æ£€æŸ¥å“åº”æ—¶é—´ < 500ms (NFR-3)

## Tasks / Subtasks

- [ ] Task 1: å®ç° `/health/agents` ç«¯ç‚¹ (AC: 1, 4)
  - [ ] å®šä¹‰æ‰€æœ‰Agentç«¯ç‚¹åˆ—è¡¨
  - [ ] å®ç°ç«¯ç‚¹çŠ¶æ€æ£€æŸ¥é€»è¾‘
  - [ ] è¿”å›ç»“æ„åŒ–çŠ¶æ€å“åº”

- [ ] Task 2: å®ç° `/health/ai` ç«¯ç‚¹ (AC: 2, 4)
  - [ ] æ³¨å…¥AgentServiceä¾èµ–
  - [ ] è°ƒç”¨ `test_ai_connection()` æ–¹æ³•
  - [ ] å¤„ç†è¿æ¥æˆåŠŸ/å¤±è´¥æƒ…å†µ

- [ ] Task 3: å®ç° `/health/full` ç«¯ç‚¹ (AC: 3, 4, 5)
  - [ ] æ³¨å…¥AgentServiceå’ŒCanvasServiceä¾èµ–
  - [ ] èšåˆæ‰€æœ‰ç»„ä»¶å¥åº·çŠ¶æ€
  - [ ] è¿”å›è¯¦ç»†è¯Šæ–­ä¿¡æ¯
  - [ ] åŒ…å«CORSé…ç½®å’ŒAIé…ç½®ä¿¡æ¯

- [ ] Task 4: æ·»åŠ Pydanticå“åº”æ¨¡å‹ (AC: 1, 2, 3)
  - [ ] åˆ›å»º AgentsHealthResponse æ¨¡å‹
  - [ ] åˆ›å»º AIHealthResponse æ¨¡å‹
  - [ ] åˆ›å»º FullHealthResponse æ¨¡å‹

- [ ] Task 5: ç¼–å†™å•å…ƒæµ‹è¯•
  - [ ] æµ‹è¯• `/health/agents` å“åº”æ ¼å¼
  - [ ] æµ‹è¯• `/health/ai` æˆåŠŸ/å¤±è´¥åœºæ™¯
  - [ ] æµ‹è¯• `/health/full` å“åº”å®Œæ•´æ€§
  - [ ] æµ‹è¯•å“åº”æ—¶é—´ < 500ms

## Dev Notes

### æ¶æ„ä¸Šä¸‹æ–‡

**ç°æœ‰å¥åº·æ£€æŸ¥ç«¯ç‚¹** [Source: backend/app/api/v1/endpoints/health.py]

å½“å‰ `health.py` å·²å®ç°ä»¥ä¸‹ç«¯ç‚¹:
- `GET /health` - åŸºç¡€å¥åº·æ£€æŸ¥ (HealthCheckResponse)
- `GET /health/metrics` - Prometheusæ ¼å¼æŒ‡æ ‡
- `GET /health/metrics/summary` - JSONæ ¼å¼æŒ‡æ ‡æ‘˜è¦

æœ¬Storyéœ€åœ¨åŒä¸€æ–‡ä»¶ä¸­æ·»åŠ 3ä¸ªæ–°ç«¯ç‚¹ã€‚

**Agentç±»å‹æšä¸¾** [Source: backend/app/services/agent_service.py:33-52]

```python
class AgentType(str, Enum):
    BASIC_DECOMPOSITION = "basic-decomposition"
    DEEP_DECOMPOSITION = "deep-decomposition"
    QUESTION_DECOMPOSITION = "question-decomposition"
    ORAL_EXPLANATION = "oral-explanation"
    FOUR_LEVEL_EXPLANATION = "four-level-explanation"
    FOUR_LEVEL = "four-level"  # Alias
    CLARIFICATION_PATH = "clarification-path"
    COMPARISON_TABLE = "comparison-table"
    EXAMPLE_TEACHING = "example-teaching"
    MEMORY_ANCHOR = "memory-anchor"
    SCORING_AGENT = "scoring-agent"
    SCORING = "scoring"  # Alias
    VERIFICATION_QUESTION = "verification-question-agent"
    CANVAS_ORCHESTRATOR = "canvas-orchestrator"
```

### ä¾èµ–å…³ç³»

**å‰ç½®Story**: Story 21.5.2 (AI Provideré…ç½®éªŒè¯)
- æä¾› `AgentService.test_ai_connection()` æ–¹æ³•
- å¦‚æœ21.5.2æœªå®Œæˆï¼Œéœ€å…ˆå®ç°è¯¥æ–¹æ³•

### SDDè§„èŒƒå‚è€ƒ

**å¥åº·æ£€æŸ¥å“åº”Schema** [Source: specs/data/health-check-response.schema.json]

```json
{
  "required": ["status", "app_name", "version", "timestamp"],
  "properties": {
    "status": {"type": "string", "enum": ["healthy", "unhealthy"]},
    "app_name": {"type": "string"},
    "version": {"type": "string"},
    "timestamp": {"type": "string", "format": "date-time"}
  }
}
```

**é”™è¯¯å“åº”Schema** [Source: specs/data/error-response.schema.json]

```json
{
  "required": ["code", "message"],
  "properties": {
    "code": {"type": "integer"},
    "message": {"type": "string"},
    "details": {"type": "object"}
  }
}
```

### å®ç°å‚è€ƒ

**æ–°å¢ç«¯ç‚¹å®ç°** [Source: docs/prd/EPIC-21.5-AGENT-RELIABILITY-FIX.md#story-21-5-4]

```python
# backend/app/api/v1/endpoints/health.py

from typing import Dict, Any, Annotated
from fastapi import Depends
from app.services.agent_service import AgentService
from app.services.canvas_service import CanvasService
from app.config import get_settings, Settings

# ä¾èµ–æ³¨å…¥ç±»å‹åˆ«å
AgentServiceDep = Annotated[AgentService, Depends(get_agent_service)]
CanvasServiceDep = Annotated[CanvasService, Depends(get_canvas_service)]
SettingsDep = Annotated[Settings, Depends(get_settings)]

# Agentç«¯ç‚¹æ˜ å°„ (ç”¨äºçŠ¶æ€æ£€æŸ¥)
AGENT_ENDPOINTS = {
    "decompose_basic": "/api/v1/agents/decompose/basic",
    "decompose_deep": "/api/v1/agents/decompose/deep",
    "decompose_question": "/api/v1/agents/decompose/question",
    "explain_oral": "/api/v1/agents/explain/oral",
    "explain_four_level": "/api/v1/agents/explain/four-level",
    "explain_memory": "/api/v1/agents/explain/memory",
    "clarification_path": "/api/v1/agents/clarification/path",
    "comparison_table": "/api/v1/agents/comparison/table",
    "example_teaching": "/api/v1/agents/example/teaching",
    "scoring": "/api/v1/agents/scoring",
    "verification": "/api/v1/agents/verification/question",
}


@router.get(
    "/health/agents",
    summary="Agentç«¯ç‚¹çŠ¶æ€æ£€æŸ¥",
    description="æ£€æŸ¥æ‰€æœ‰Agentç«¯ç‚¹çš„å¯ç”¨çŠ¶æ€",
    operation_id="check_agents_health",
    responses={
        200: {
            "description": "Agentç«¯ç‚¹çŠ¶æ€",
            "content": {
                "application/json": {
                    "example": {
                        "status": "ok",
                        "agents": {
                            "decompose_basic": "available",
                            "explain_oral": "available"
                        },
                        "total_agents": 11,
                        "available_count": 11
                    }
                }
            }
        }
    }
)
async def check_agents_health() -> Dict[str, Any]:
    """
    æ£€æŸ¥æ‰€æœ‰Agentç«¯ç‚¹çŠ¶æ€ã€‚

    è¿”å›æ¯ä¸ªAgentç«¯ç‚¹çš„å¯ç”¨æ€§çŠ¶æ€ã€‚
    æ³¨æ„ï¼šæ­¤ç«¯ç‚¹ä¸å®é™…è°ƒç”¨Agentï¼Œåªæ£€æŸ¥è·¯ç”±æ˜¯å¦æ³¨å†Œã€‚

    [Source: docs/prd/EPIC-21.5-AGENT-RELIABILITY-FIX.md#story-21-5-4]

    Returns:
        Dict containing agent endpoint availability status
    """
    logger.debug("Agent health check requested")

    # æ‰€æœ‰ç«¯ç‚¹é»˜è®¤å¯ç”¨ï¼ˆè·¯ç”±å·²æ³¨å†Œï¼‰
    agents_status = {name: "available" for name in AGENT_ENDPOINTS}

    return {
        "status": "ok",
        "agents": agents_status,
        "total_agents": len(AGENT_ENDPOINTS),
        "available_count": len(agents_status)
    }


@router.get(
    "/health/ai",
    summary="AI APIè¿æ¥æµ‹è¯•",
    description="æµ‹è¯•AI Provider (Gemini/Anthropic) APIè¿æ¥çŠ¶æ€",
    operation_id="check_ai_health",
    responses={
        200: {
            "description": "AIè¿æ¥çŠ¶æ€",
            "content": {
                "application/json": {
                    "examples": {
                        "success": {
                            "value": {
                                "status": "ok",
                                "model": "gemini-2.5-pro",
                                "provider": "google"
                            }
                        },
                        "failure": {
                            "value": {
                                "status": "error",
                                "error": "Invalid API key",
                                "model": "gemini-2.5-pro"
                            }
                        }
                    }
                }
            }
        }
    }
)
async def check_ai_health(
    agent_service: AgentServiceDep
) -> Dict[str, Any]:
    """
    æµ‹è¯•AI APIè¿æ¥ã€‚

    å‘é€ç®€å•æµ‹è¯•è¯·æ±‚åˆ°AI Providerï¼ŒéªŒè¯APIå¯†é’¥å’Œè¿æ¥æ˜¯å¦æœ‰æ•ˆã€‚

    [Source: docs/prd/EPIC-21.5-AGENT-RELIABILITY-FIX.md#story-21-5-4]

    Args:
        agent_service: AgentæœåŠ¡å®ä¾‹ (ä¾èµ–æ³¨å…¥)

    Returns:
        Dict containing AI connection status
    """
    logger.debug("AI health check requested")

    result = await agent_service.test_ai_connection()
    return result


@router.get(
    "/health/full",
    summary="å®Œæ•´ç³»ç»Ÿè¯Šæ–­",
    description="è¿”å›æ‰€æœ‰ç»„ä»¶çš„å®Œæ•´å¥åº·çŠ¶æ€å’Œé…ç½®ä¿¡æ¯",
    operation_id="full_health_check",
    responses={
        200: {
            "description": "å®Œæ•´è¯Šæ–­ä¿¡æ¯",
            "content": {
                "application/json": {
                    "example": {
                        "status": "ok",
                        "components": {
                            "api": "ok",
                            "ai_provider": {"status": "ok", "model": "gemini-2.5-pro"},
                            "canvas_service": "ok"
                        },
                        "config": {
                            "ai_model": "gemini-2.5-pro",
                            "ai_provider": "google",
                            "cors_origins": ["app://obsidian.md"]
                        },
                        "timestamp": "2025-12-14T10:00:00Z"
                    }
                }
            }
        }
    }
)
async def full_health_check(
    agent_service: AgentServiceDep,
    settings: SettingsDep
) -> Dict[str, Any]:
    """
    å®Œæ•´ç³»ç»Ÿè¯Šæ–­ã€‚

    ä¸€æ¬¡è¯·æ±‚è·å–æ‰€æœ‰æœåŠ¡ç»„ä»¶çŠ¶æ€ã€AIè¿æ¥çŠ¶æ€å’Œå…³é”®é…ç½®ä¿¡æ¯ã€‚
    ç”¨äºå¿«é€Ÿè¯Šæ–­ç³»ç»Ÿé—®é¢˜ã€‚

    [Source: docs/prd/EPIC-21.5-AGENT-RELIABILITY-FIX.md#story-21-5-4]

    Args:
        agent_service: AgentæœåŠ¡å®ä¾‹
        settings: åº”ç”¨é…ç½®

    Returns:
        Dict containing full system diagnostic info
    """
    logger.debug("Full health check requested")

    # æµ‹è¯•AIè¿æ¥
    ai_status = await agent_service.test_ai_connection()

    # ç¡®å®šæ€»ä½“çŠ¶æ€
    overall_status = "ok" if ai_status.get("status") == "ok" else "degraded"

    return {
        "status": overall_status,
        "components": {
            "api": "ok",
            "ai_provider": ai_status,
            "canvas_service": "ok"
        },
        "config": {
            "ai_model": settings.AI_MODEL_NAME,
            "ai_provider": settings.AI_PROVIDER,
            "cors_origins": settings.cors_origins_list
        },
        "timestamp": datetime.now(timezone.utc).isoformat()
    }
```

### ADRå†³ç­–å…³è”

**ADR-009: Error Handling** [Source: docs/architecture/decisions/ADR-009-ERROR-HANDLING-RETRY-STRATEGY.md]

å¥åº·æ£€æŸ¥ç«¯ç‚¹åº”ä½¿ç”¨ä»¥ä¸‹é”™è¯¯åˆ†ç±»:
- `RETRYABLE`: AIè¿æ¥æš‚æ—¶å¤±è´¥ (ç½‘ç»œé—®é¢˜)
- `NON_RETRYABLE`: é…ç½®é”™è¯¯ (æ— æ•ˆAPIå¯†é’¥)

```python
from app.core.error_codes import ErrorCode, ErrorCategory

# AIè¿æ¥æµ‹è¯•å¤±è´¥æ—¶çš„é”™è¯¯åˆ†ç±»
if "invalid api key" in error_message.lower():
    return {"status": "error", "error_code": ErrorCode.LLM_AUTH_FAILED.value}
elif "timeout" in error_message.lower():
    return {"status": "error", "error_code": ErrorCode.LLM_TIMEOUT.value}
```

**ADR-010: Logging** [Source: docs/architecture/decisions/ADR-010-LOGGING-AGGREGATION-STRUCTLOG.md]

ä½¿ç”¨structlogè¿›è¡Œç»“æ„åŒ–æ—¥å¿—:

```python
import structlog
logger = structlog.get_logger(__name__)

# åœ¨å¥åº·æ£€æŸ¥ä¸­è®°å½•è¯Šæ–­ä¿¡æ¯
logger.info("health_check_completed",
    check_type="full",
    ai_status=ai_status.get("status"),
    response_time_ms=elapsed_ms
)
```

### å…³é”®æ–‡ä»¶

| æ–‡ä»¶ | ç”¨é€” |
|------|------|
| `backend/app/api/v1/endpoints/health.py` | ä¸»è¦ä¿®æ”¹ - æ·»åŠ 3ä¸ªæ–°ç«¯ç‚¹ |
| `backend/app/services/agent_service.py` | ä¾èµ– - `test_ai_connection()` æ–¹æ³• |
| `backend/app/config.py` | ä¾èµ– - Settingsé…ç½® |
| `backend/app/models/common.py` | å¯é€‰ - æ·»åŠ å“åº”æ¨¡å‹ |

### æµ‹è¯•è¦æ±‚

**å•å…ƒæµ‹è¯•è¦†ç›–**:

```python
# tests/unit/test_health_endpoints.py

import pytest
from fastapi.testclient import TestClient
from app.main import app

client = TestClient(app)


def test_health_agents_returns_all_endpoints():
    """æµ‹è¯• /health/agents è¿”å›æ‰€æœ‰Agentç«¯ç‚¹çŠ¶æ€"""
    response = client.get("/api/v1/health/agents")
    assert response.status_code == 200
    data = response.json()
    assert data["status"] == "ok"
    assert "agents" in data
    assert len(data["agents"]) >= 10  # è‡³å°‘10ä¸ªAgentç«¯ç‚¹


def test_health_ai_success_response():
    """æµ‹è¯• /health/ai æˆåŠŸå“åº”æ ¼å¼"""
    response = client.get("/api/v1/health/ai")
    assert response.status_code == 200
    data = response.json()
    assert "status" in data
    assert data["status"] in ["ok", "error"]


def test_health_full_contains_all_components():
    """æµ‹è¯• /health/full åŒ…å«æ‰€æœ‰ç»„ä»¶çŠ¶æ€"""
    response = client.get("/api/v1/health/full")
    assert response.status_code == 200
    data = response.json()
    assert "status" in data
    assert "components" in data
    assert "config" in data
    assert "timestamp" in data
    assert "ai_provider" in data["components"]


def test_health_full_response_time():
    """æµ‹è¯• /health/full å“åº”æ—¶é—´ < 500ms (NFR-3)"""
    import time
    start = time.time()
    response = client.get("/api/v1/health/full")
    elapsed = (time.time() - start) * 1000
    assert response.status_code == 200
    assert elapsed < 500, f"Response time {elapsed}ms exceeds 500ms limit"
```

### éªŒè¯æ¸…å•

åœ¨PRæäº¤å‰ï¼Œç¡®ä¿ä»¥ä¸‹æ£€æŸ¥é€šè¿‡:

- [ ] æ‰€æœ‰3ä¸ªæ–°ç«¯ç‚¹å¯è®¿é—®
- [ ] `/health/agents` è¿”å›æ‰€æœ‰Agentç«¯ç‚¹çŠ¶æ€
- [ ] `/health/ai` æ­£ç¡®åæ˜ AIè¿æ¥çŠ¶æ€
- [ ] `/health/full` åŒ…å«å®Œæ•´è¯Šæ–­ä¿¡æ¯
- [ ] å“åº”æ—¶é—´ < 500ms
- [ ] å•å…ƒæµ‹è¯•å…¨éƒ¨é€šè¿‡
- [ ] ä»£ç æœ‰é€‚å½“çš„Context7/SDDæ¥æºæ³¨é‡Š

## SDDè§„èŒƒå¼•ç”¨

- **OpenAPI Spec**: `specs/api/fastapi-backend-api.openapi.yml#/paths/~1api~1v1~1health`
- **Health Schema**: `specs/data/health-check-response.schema.json`
- **Error Schema**: `specs/data/error-response.schema.json`
- **Epic PRD**: `docs/prd/EPIC-21.5-AGENT-RELIABILITY-FIX.md#story-21-5-4`

## ADRå…³è”

- **ADR-009**: Error Handling - é”™è¯¯åˆ†ç±»å’Œå“åº”æ ¼å¼
- **ADR-010**: Logging - ç»“æ„åŒ–æ—¥å¿—è®°å½•

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-14 | 1.0 | åˆå§‹Storyåˆ›å»º (ultrathinkæ¨¡å¼) | SM Agent (Bob) |
