# Story 18.4: Graph Sync Service - Graphiti知识图谱同步

## Status
Completed

## Story

**As a** Canvas Learning System用户,
**I want** Canvas回滚同步到Graphiti知识图谱,
**so that** 学习进度追踪与Canvas状态一致。

## Acceptance Criteria

1. `GraphSyncService`集成现有`GraphitiClient`
2. 回滚后使用`add_episode()`同步节点状态
3. 已删除节点在图谱中标记`deleted_at`(软删除)
4. 回滚结果包含`graphSyncStatus`: synced/pending/skipped
5. `preserveGraph`选项跳过图谱同步
6. 图谱同步失败不阻塞回滚成功(优雅降级)
7. Graphiti操作超时200ms
8. 所有代码有文档来源标注

## Tasks / Subtasks

- [ ] Task 1: 创建GraphSyncService类 (AC: 1)
  - [ ] 创建 `src/rollback/graph_sync_service.py`
  - [ ] 集成现有 `src/agentic_rag/clients/graphiti_client.py`
  - [ ] 实现 `GraphSyncService.__init__(graphiti_client, timeout=200)`
  - [ ] 实现连接健康检查

- [ ] Task 2: 实现节点同步逻辑 (AC: 2, 3)
  - [ ] 实现 `sync_canvas_state(canvas_path, canvas_data)` 方法
  - [ ] 实现 `_sync_node(node_data)` 方法 (使用add_episode)
  - [ ] 实现 `_mark_deleted(node_id)` 方法 (软删除标记)
  - [ ] 实现节点状态差异检测

- [ ] Task 3: 实现回滚同步集成 (AC: 4, 5)
  - [ ] 实现 `sync_after_rollback(rollback_result)` 方法
  - [ ] 添加 `preserveGraph` 参数支持
  - [ ] 返回 `graphSyncStatus` (synced/pending/skipped)

- [ ] Task 4: 实现超时和降级 (AC: 6, 7)
  - [ ] 实现 `_execute_with_timeout(coroutine, timeout_ms)` 方法
  - [ ] 实现超时处理 (asyncio.timeout)
  - [ ] 实现优雅降级 (同步失败返回pending状态)
  - [ ] 记录同步失败日志

- [ ] Task 5: 更新RollbackEngine集成 (AC: 4)
  - [ ] 在 `RollbackEngine` 中集成 `GraphSyncService`
  - [ ] 在回滚成功后调用 `sync_after_rollback`
  - [ ] 更新 `RollbackResult` 包含 `graphSyncStatus`

- [ ] Task 6: 集成测试 (AC: 8)
  - [ ] 创建 `src/tests/unit/test_graph_sync_service.py`
  - [ ] Mock GraphitiClient进行测试
  - [ ] 测试超时处理
  - [ ] 测试优雅降级
  - [ ] 测试preserveGraph选项
  - [ ] 确保测试覆盖率 >90%

## Dev Notes

### 技术验证报告 (Step 3.6)

**验证完成时间**: 2025-12-04
**验证执行人**: SM Agent (Bob)
**Quality Gate状态**: Pending

#### 技术栈清单

| 技术栈 | 查询方式 | 验证状态 | 文档位置 |
|--------|---------|---------|----------|
| Graphiti | Local Skill | 待验证 | @graphiti |
| asyncio.timeout | Context7 | 待验证 | /python/cpython |
| structlog | Local ADR | 已验证 | ADR-010 |

#### 核心API验证待办

**开发前必须验证**:
- [ ] GraphitiClient.add_episode() → Local Skill: @graphiti
- [ ] asyncio.timeout() (Python 3.11+) → Context7: /python/cpython
- [ ] asyncio.wait_for() (fallback) → Context7: /python/cpython

### SDD规范引用 (必填)

**GraphSyncService接口** (Source: docs/architecture/rollback-recovery-architecture.md:482-540):
```typescript
interface GraphSyncService {
    syncAfterRollback(rollbackResult: RollbackResult): Promise<GraphSyncStatus>;
    syncCanvasState(canvasPath: string, canvasData: CanvasJSON): Promise<void>;
    markNodeDeleted(nodeId: string): Promise<void>;
}

type GraphSyncStatus = 'synced' | 'pending' | 'skipped';
```

**Graphiti集成** (Source: docs/architecture/rollback-recovery-architecture.md:500-520):
- 使用现有 `GraphitiClient.add_episode()` 添加回滚事件
- 节点删除使用软删除 (添加 `deleted_at` 属性)
- 超时200ms，失败不阻塞

### ADR决策关联 (必填)

| ADR编号 | 决策标题 | 对Story的影响 |
|---------|----------|---------------|
| ADR-0009 | Error Handling | 图谱同步失败时的优雅降级策略 |
| ADR-0010 | Logging Aggregation | 同步状态日志使用structlog格式 |

**关键约束**:
- Graphiti操作超时200ms
- 同步失败不阻塞回滚成功
- preserveGraph选项跳过同步

### 架构设计参考

**架构文档引用**:
- GraphSyncService设计: [Source: docs/architecture/rollback-recovery-architecture.md:482-560]
- Graphiti集成模式: [Source: docs/architecture/rollback-recovery-architecture.md:500-520]
- 超时和降级策略: [Source: docs/architecture/rollback-recovery-architecture.md:540-560]

### 代码示例库

**GraphSyncService类** (Source: docs/architecture/rollback-recovery-architecture.md:482-560):
```python
# src/rollback/graph_sync_service.py
# ✅ Verified from Architecture Doc (rollback-recovery-architecture.md:482-560)
import asyncio
from datetime import datetime, timezone
from typing import Optional
import structlog

from src.agentic_rag.clients.graphiti_client import GraphitiClient

logger = structlog.get_logger(__name__)

class GraphSyncStatus:
    SYNCED = "synced"
    PENDING = "pending"
    SKIPPED = "skipped"

class GraphSyncService:
    """Graphiti知识图谱同步服务

    [Source: docs/architecture/rollback-recovery-architecture.md:482-560]
    """

    def __init__(self,
                 graphiti_client: Optional[GraphitiClient] = None,
                 timeout_ms: int = 200):
        self.client = graphiti_client
        self.timeout = timeout_ms / 1000  # Convert to seconds

    async def sync_after_rollback(self,
                                   rollback_result: dict,
                                   preserve_graph: bool = False) -> str:
        """回滚后同步到知识图谱

        Args:
            rollback_result: 回滚结果
            preserve_graph: 是否跳过同步

        Returns:
            GraphSyncStatus: synced | pending | skipped
        """
        if preserve_graph:
            logger.info("graph_sync.skipped", reason="preserve_graph=True")
            return GraphSyncStatus.SKIPPED

        if not self.client:
            logger.warning("graph_sync.skipped", reason="no_client")
            return GraphSyncStatus.SKIPPED

        try:
            await self._execute_with_timeout(
                self._sync_rollback_event(rollback_result)
            )
            return GraphSyncStatus.SYNCED
        except asyncio.TimeoutError:
            logger.warning("graph_sync.timeout", timeout_ms=self.timeout_ms)
            return GraphSyncStatus.PENDING
        except Exception as e:
            logger.error("graph_sync.failed", error=str(e))
            return GraphSyncStatus.PENDING

    async def _execute_with_timeout(self, coro):
        """执行带超时的协程"""
        return await asyncio.wait_for(coro, timeout=self.timeout)

    async def _sync_rollback_event(self, rollback_result: dict):
        """同步回滚事件到图谱"""
        content = f"Canvas rollback: {rollback_result['rollback_type']} " \
                  f"on {rollback_result['canvas_path']}"

        # 使用add_episode记录回滚事件
        await self.client.add_episode(content)

    async def mark_node_deleted(self, node_id: str):
        """标记节点为已删除 (软删除)"""
        if not self.client:
            return

        try:
            await self._execute_with_timeout(
                self.client.add_episode(
                    f"Node {node_id} marked as deleted at {datetime.now(timezone.utc)}"
                )
            )
        except Exception as e:
            logger.warning("graph_sync.mark_deleted_failed", node_id=node_id, error=str(e))
```

### 文件路径参考

**需要新增的文件**:
- 新增: `src/rollback/graph_sync_service.py` - GraphSyncService类
- 新增: `src/tests/unit/test_graph_sync_service.py` - 单元测试

**需要修改的文件**:
- 修改: `src/rollback/rollback_engine.py` - 集成GraphSyncService

**现有文件参考**:
- Graphiti客户端: `src/agentic_rag/clients/graphiti_client.py`

### 依赖关系

**前置Story**:
- Story 18.2: Snapshot Manager（提供回滚后的Canvas状态）

**后续影响**:
- Story 18.5: API和配置（完成graphSyncStatus集成）

**可并行开发**:
- 本Story可与Story 18.3并行开发（两者独立）

### Definition of Done

- [ ] 所有AC通过验收测试
- [ ] `GraphSyncService` 集成现有GraphitiClient
- [ ] 回滚事件同步到图谱
- [ ] 超时和降级机制正常
- [ ] preserveGraph选项正常
- [ ] 单元测试覆盖率≥90%
- [ ] 代码Review通过
- [ ] 所有代码有文档来源标注

### 风险和缓解

| 风险 | 概率 | 影响 | 缓解措施 |
|------|------|------|---------|
| Graphiti服务不可用 | 中 | 低 | 优雅降级，返回pending |
| 超时设置不合理 | 中 | 低 | 可配置超时，监控调整 |
| 同步数据不一致 | 低 | 中 | 后续可添加重试队列 |

### 估算

- **Story Points**: 5
- **预估工时**: 2天
- **复杂度**: 中（主要是集成现有Graphiti客户端）

---

**文档版本**: v1.0.0
**创建时间**: 2025-12-04
**创建者**: SM Agent (Bob)
**Epic**: Epic 18 - 数据迁移和回滚
