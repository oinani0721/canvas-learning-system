# Story 33.13: EPIC Documentation Sync + E2E Test Coverage

## Status: Done

---

## Story

**As a** Canvas Learning System developer and QA,
**I want** the EPIC-33 document to accurately reflect the current implementation status and have E2E tests covering the full batch processing pipeline,
**so that** the team has trustworthy documentation and regression protection for the entire flow.

---

## Problem Statement

### Adversarial Audit Findings (2026-02-10)

| # | Finding | Severity | Location |
|---|---------|----------|----------|
| 1 | EPIC-33 status table claims "Backend REST API ❌ 0%" — but all 5 endpoints + WebSocket + Session Management + Grouping + Routing + Orchestrator are fully implemented | P1 | `EPIC-33-AGENT-POOL-BATCH-PROCESSING.md:34-44` |
| 2 | DoD says "8个Stories全部完成" but there are 9 stories (33.1-33.9) | P1 | `EPIC-33-AGENT-POOL-BATCH-PROCESSING.md:405` |
| 3 | No E2E test exists — only `test_epic33_di_completeness.py` (integration) covers EPIC-33 | P1 | `backend/tests/` |
| 4 | Story table lists 8 stories but 33.9 (DI Chain Repair) was added later and is not in the table | P1 | `EPIC-33-AGENT-POOL-BATCH-PROCESSING.md:103-112` |

### Impact

- **Stale documentation** misleads new developers and auditors into thinking the system is unimplemented
- **Missing E2E tests** means the full pipeline (POST analyze → POST confirm → GET progress → POST cancel) has no automated regression protection
- **Story count mismatch** undermines confidence in project tracking

---

## Acceptance Criteria

### AC-33.13.1: EPIC status table reflects code reality (P1)
- **Given** all 9 stories (33.1-33.9) have been implemented
- **When** the EPIC document is updated
- **Then** the status table shows accurate status for each component:
  - Backend REST API: ✅ 100%
  - WebSocket: ✅ 100%
  - Session Management: ✅ 100%
  - Intelligent Grouping: ✅ 100%
  - Agent Routing: ✅ 100%
  - Result Merging: ⚠️ Implemented but unused (pending Story 33.11 decision)

### AC-33.13.2: Story table includes all stories (P1)
- **Given** stories 33.1-33.9 exist plus 33.10-33.13 from adversarial review
- **When** the EPIC document is updated
- **Then** the Stories table lists all stories with accurate status
- **And** newly added stories (33.10-33.13) are marked with their origin (adversarial audit)

### AC-33.13.3: DoD story count corrected (P1)
- **Given** the DoD says "8个Stories全部完成"
- **When** the EPIC document is updated
- **Then** the DoD says "13个Stories全部完成" (or dynamically references the Stories table)

### AC-33.13.4: E2E test covers full batch pipeline (P1)
- **Given** no E2E test exists for EPIC-33
- **When** a new E2E test is created
- **Then** it covers the complete flow:
  1. `POST /canvas/intelligent-parallel` — analyze and group nodes
  2. `POST /canvas/intelligent-parallel/confirm` — start batch processing
  3. `GET /canvas/intelligent-parallel/{session_id}` — poll progress until complete
  4. Verify final session status is `completed`
  5. Verify result files were created
- **And** the test runs without external dependencies (mocked GeminiClient)

### AC-33.13.5: E2E test covers cancel flow (P1)
- **Given** the cancel endpoint exists
- **When** an E2E test covers cancellation
- **Then** it:
  1. Starts a batch session
  2. Immediately calls `POST /cancel/{session_id}`
  3. Verifies session status becomes `cancelled`

### AC-33.13.6: Change log updated (P2)
- **Given** the EPIC change log ends at v0.2
- **When** updated
- **Then** a new entry records:
  - v0.3: Story 33.9 DI Chain Repair (2026-02-09)
  - v0.4: Stories 33.10-33.13 from adversarial audit (2026-02-10)
  - v0.5: Status table sync with code reality (2026-02-10)

---

## Technical Details

### Files to Modify/Create

| File | Action | Priority |
|------|--------|----------|
| `docs/epics/EPIC-33-AGENT-POOL-BATCH-PROCESSING.md` | Update status table, story table, DoD, change log | P1 |
| `backend/tests/e2e/test_epic33_batch_pipeline.py` | **NEW** — E2E test for full batch flow | P1 |

### EPIC Document Updates

**Status Table (lines 34-44) — Before:**
```markdown
| Backend REST API | ❌ 0% | N/A | **主阻塞 - 6端点不存在** |
| WebSocket | ❌ 0% | N/A | **次阻塞** |
| Session管理 | ❌ 0% | N/A | **次阻塞** |
| 智能路由 | ❌ 0% | N/A | 算法存在但未集成 |
| 结果合并 | ❌ 0% | N/A | 未实现 |
```

**Status Table — After:**
```markdown
| Backend REST API | ✅ 100% | `backend/app/api/v1/endpoints/intelligent_parallel.py` | 5 REST + 1 WebSocket |
| WebSocket | ✅ 100% | `backend/app/api/v1/endpoints/websocket.py` | ConnectionManager + session broadcasting |
| Session管理 | ✅ 100% | `backend/app/services/session_manager.py` | Singleton + state machine + cleanup |
| 智能路由 | ✅ 100% | `backend/app/services/agent_routing_engine.py` | Regex + confidence scoring |
| 结果合并 | ⚠️ 已实现未集成 | `backend/app/services/result_merger.py` | 809行代码，无调用方 (Story 33.11 待决) |
```

**Stories Table — Add:**
```markdown
| **33.9** | P0 DI Chain Repair | P0 | 修复 batch_orchestrator/agent_service 未注入 |
| **33.10** | P0 Runtime Defect Fixes | P0 | URL不匹配 + 假prompt + GroupProgress硬编码 |
| **33.11** | Dead Code Removal + DI Consolidation | P1 | ResultMerger清理 + DI去重 |
| **33.12** | Code Quality Fixes | P1 | sys.path hack + magic numbers |
| **33.13** | EPIC Doc Sync + E2E Tests | P1 | 文档同步 + E2E覆盖 |
```

### E2E Test Design

```python
# backend/tests/e2e/test_epic33_batch_pipeline.py

@pytest.mark.asyncio
class TestEPIC33BatchPipeline:
    """E2E test for the full EPIC-33 batch processing pipeline."""

    async def test_full_batch_flow(self, client, mock_gemini):
        """POST analyze → POST confirm → GET progress → completed"""
        # Step 1: Analyze nodes
        resp = client.post("/api/v1/canvas/intelligent-parallel", json={
            "canvas_path": "test.canvas",
            "target_color": "#FFFF00",
        })
        assert resp.status_code == 200
        groups = resp.json()["groups"]

        # Step 2: Confirm batch processing
        resp = client.post("/api/v1/canvas/intelligent-parallel/confirm", json={
            "canvas_path": "test.canvas",
            "groups": groups,
        })
        assert resp.status_code == 202
        session_id = resp.json()["session_id"]

        # Step 3: Poll until complete (with timeout)
        for _ in range(30):
            resp = client.get(f"/api/v1/canvas/intelligent-parallel/{session_id}")
            assert resp.status_code == 200
            if resp.json()["status"] in ("completed", "partial_failure"):
                break
            await asyncio.sleep(0.5)

        # Step 4: Verify completion
        assert resp.json()["status"] == "completed"
        assert resp.json()["completed_nodes"] > 0

    async def test_cancel_flow(self, client, mock_gemini):
        """Start batch → Cancel → Verify cancelled status"""
        # Start
        resp = client.post("/api/v1/canvas/intelligent-parallel/confirm", json={...})
        session_id = resp.json()["session_id"]

        # Cancel
        resp = client.post(f"/api/v1/canvas/intelligent-parallel/cancel/{session_id}")
        assert resp.status_code == 200
        assert resp.json()["status"] == "cancelled"
```

---

## Test Plan

```bash
# 1. New E2E tests
cd backend && python -m pytest tests/e2e/test_epic33_batch_pipeline.py -v

# 2. Full regression
python -m pytest tests/ -v --timeout=120

# 3. Verify EPIC doc accuracy (manual)
# Read EPIC-33 doc and confirm every status claim against code
```

---

## Definition of Done

- [x] EPIC-33 status table matches code reality
- [x] Stories table includes all 13 stories (33.1-33.13)
- [x] DoD story count corrected
- [x] Change log updated with v0.3-v0.5 entries
- [x] E2E test covers full batch pipeline (analyze → confirm → poll → complete)
- [x] E2E test covers cancel flow
- [x] All existing tests pass (zero regressions)
