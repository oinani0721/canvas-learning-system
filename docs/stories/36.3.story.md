# Story 36.3: Canvas Edge自动同步到Neo4j

## Status

Complete

## Story

**As a** Canvas Learning System developer,
**I want** Canvas edge creation to automatically sync to Neo4j in the background,
**so that** the knowledge graph stays updated without blocking Canvas operations.

## Acceptance Criteria

1. When `add_edge()` completes successfully, an async `sync_edge_to_neo4j()` is triggered
2. The sync uses fire-and-forget pattern - Canvas operation returns immediately without waiting
3. Retry mechanism implements 3 attempts with exponential backoff (1s, 2s, 4s)
4. Sync failure logs error but does not affect Canvas operation result
5. Edge relationship `CONNECTS_TO` is created in Neo4j with proper edge metadata
6. Existing `_trigger_memory_event()` integration point is reused (no new event types needed)

## Tasks / Subtasks

- [x] Task 1: Create `sync_edge_to_neo4j()` method in canvas_service.py (AC: 1, 2)
  - [x] 1.1 Add method signature with edge_id, from_node_id, to_node_id, canvas_path, edge_label parameters
  - [x] 1.2 Implement fire-and-forget pattern using `asyncio.create_task()`
  - [x] 1.3 Call Neo4jClient's existing `create_edge_relationship()` method

- [x] Task 2: Implement retry mechanism with tenacity (AC: 3)
  - [x] 2.1 Add `@retry` decorator with `stop=stop_after_attempt(3)`
  - [x] 2.2 Configure `wait=wait_exponential(multiplier=1, min=1, max=4)`
  - [x] 2.3 Add `retry_if_exception_type(Exception)` for selective retry

- [x] Task 3: Integrate into existing `add_edge()` flow (AC: 1, 4, 6)
  - [x] 3.1 Call `sync_edge_to_neo4j()` after existing `_trigger_memory_event(EDGE_CREATED)` at line 592
  - [x] 3.2 Wrap sync call in try-except to ensure Canvas operation completes regardless
  - [x] 3.3 Log sync failures with full edge context for debugging

- [x] Task 4: Add unit and integration tests (AC: 1-6)
  - [x] 4.1 Unit test: verify fire-and-forget pattern (sync runs in background)
  - [x] 4.2 Unit test: verify retry mechanism triggers on Neo4j failures
  - [x] 4.3 Integration test: verify edge appears in Neo4j after Canvas add_edge()
  - [x] 4.4 Integration test: verify Canvas operation succeeds even if Neo4j sync fails

## Dev Notes

### SDD规范参考 (必填)

**API端点** (从OpenAPI specs):
- 端点路径和方法: `POST /canvas/{canvas_path}/edges`
- 规范来源: `[Source: specs/api/canvas-api.openapi.yml#L354-L382]`
- 请求Schema: `EdgeInput` (L844-847)
- 操作ID: `createEdge`

**数据Schema** (从JSON Schema):
- 模型名称: `CanvasEdge`
- Schema来源: `[Source: specs/data/canvas-edge.schema.json]`
- 必填字段: `id`, `fromNode`, `toNode`
- 可选字段: `fromSide`, `toSide`, `label`
- ID验证规则: UUID格式 `^[a-f0-9]{8}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{12}$`

**Neo4j关系Schema**:
- 关系类型: `CONNECTS_TO` (用于节点间连接)
- 属性: `edge_id`, `label`, `created_at`
- 来源: `[Source: backend/app/clients/neo4j_client.py#L847-893]`

### ADR决策关联 (必填)

| ADR编号 | 决策标题 | 对Story的影响 |
|---------|----------|---------------|
| ADR-0003 | Graphiti Memory系统 | Neo4j存储架构，异步执行要求，使用CanvasEventType枚举 |
| ADR-0004 | 异步执行引擎 | fire-and-forget模式：`asyncio.create_task()` + try-except包裹 |
| ADR-009 | 错误处理重试策略 | tenacity库，3次指数退避(1s,2s,4s)，`retry_if_exception_type` |

**关键约束** (从ADR Consequences提取):
- **ADR-0004**: fire-and-forget任务必须在try-except中调用，失败不影响主流程
- **ADR-009**: 重试仅针对可恢复错误（连接超时、临时不可用），不重试业务逻辑错误
- **Story 30.3 AC-30.3.10**: 批量写入延迟目标 < 500ms (P95，参考性能基准)

### 现有代码集成点

**canvas_service.py** (`backend/app/services/canvas_service.py`):
```python
# Line 485-522: 现有add_edge()方法
async def add_edge(self, canvas_name: str, edge_data: Dict[str, Any]) -> Dict[str, Any]:
    # ... 创建edge逻辑 ...
    await self._trigger_memory_event(
        event_type=CanvasEventType.EDGE_CREATED,  # Line 517
        canvas_name=canvas_name,
        edge_id=new_edge["id"],
        edge_data=new_edge
    )
    # ⬇️ 在此处添加 sync_edge_to_neo4j() 调用
    return new_edge

# Line 138: 复用现有fire-and-forget模式
async def _trigger_memory_event(self, event_type, ...):
    # 已有的asyncio.create_task()模式
```

**neo4j_client.py** (`backend/app/clients/neo4j_client.py`):
```python
# Line 847-893: 已有的create_edge_relationship()方法 (Story 30.5 实现)
async def create_edge_relationship(
    self, canvas_path, edge_id, from_node_id, to_node_id, edge_label=None
) -> bool:
    # 使用MERGE创建CONNECTS_TO关系
    # 已有retry机制和JSON fallback
```

### 实现参考代码

```python
# 在canvas_service.py中添加
from tenacity import retry, stop_after_attempt, wait_exponential, retry_if_exception_type

class CanvasService:
    @retry(
        stop=stop_after_attempt(3),
        wait=wait_exponential(multiplier=1, min=1, max=4),
        retry=retry_if_exception_type(Exception),  # 具体异常类型待确认
        reraise=False  # 不抛出异常，符合fire-and-forget
    )
    async def _sync_edge_to_neo4j(
        self,
        canvas_path: str,
        edge_id: str,
        from_node_id: str,
        to_node_id: str,
        edge_label: Optional[str] = None
    ) -> bool:
        """Fire-and-forget同步edge到Neo4j"""
        return await self.neo4j_client.create_edge_relationship(
            canvas_path=canvas_path,
            edge_id=edge_id,
            from_node_id=from_node_id,
            to_node_id=to_node_id,
            edge_label=edge_label
        )

    async def add_edge(self, canvas_name: str, edge_data: Dict[str, Any]) -> Dict[str, Any]:
        # ... 现有逻辑 ...
        await self._trigger_memory_event(...)  # Line 517

        # 新增：Fire-and-forget Neo4j同步
        try:
            asyncio.create_task(
                self._sync_edge_to_neo4j(
                    canvas_path=canvas_name,
                    edge_id=new_edge["id"],
                    from_node_id=new_edge["fromNode"],
                    to_node_id=new_edge["toNode"],
                    edge_label=new_edge.get("label")
                )
            )
        except Exception as e:
            logger.warning(f"Failed to schedule edge sync: {e}")

        return new_edge  # 不等待sync完成
```

### Testing

**测试文件位置**: `backend/tests/unit/test_canvas_edge_sync.py`, `backend/tests/integration/test_edge_neo4j_sync.py`

**测试标准**:
- pytest框架 + pytest-asyncio
- 使用现有Mock模式：`@pytest.fixture` + `AsyncMock`
- 集成测试需要Neo4j Docker运行 (`NEO4J_MOCK=false`)

**测试场景**:
1. 单元测试：mock Neo4jClient，验证`create_task()`被调用
2. 单元测试：模拟Neo4j失败，验证3次重试后静默失败
3. 集成测试：真实Neo4j，验证edge关系创建成功
4. 集成测试：Neo4j不可用时，Canvas操作仍然成功返回

## Dependencies

- **EPIC-30 Story 30.2**: Neo4jClient真实驱动 (已完成，提供Neo4j连接池和重试机制)
- **EPIC-30 Story 30.5**: `create_edge_relationship()` 方法 (已完成，提供边关系创建功能)

> **注意**: 经 UltraThink 深度分析验证，原声明的 Story 36.1/36.2 依赖为虚假依赖。
> `create_edge_relationship()` 方法已在 Story 30.5 中实现并集成到 MemoryService。
> 本 Story 的任务是添加显式的 fire-and-forget 包装器，而非实现底层方法。

## Estimated Effort

~300行新代码（含测试）

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-20 | 0.1 | Initial draft with full Dev Notes | SM Agent (Bob) |
| 2026-01-20 | 0.2 | **UltraThink验证修正**: 移除虚假依赖(36.1/36.2)，修正ADR-0003 500ms引用为Story 30.3性能目标，更新行号引用(847-893)，确认真实依赖为Story 30.2/30.5 | PO Agent (Sarah) |

## Dev Agent Record

### Agent Model Used

Claude Opus 4.5 (claude-opus-4-5-20251101) with ultrathink

### Debug Log References

- Unit test run: 9/9 tests passed
- Tests validate: fire-and-forget pattern, retry mechanism (3 attempts), silent failure handling
- Integration tests require real Neo4j (skipped in mock mode)

### Completion Notes List

1. **Task 1-3**: Implemented `_sync_edge_to_neo4j()` method in `canvas_service.py` (lines 247-319)
   - Uses inner function with `@retry` decorator for tenacity integration
   - Accesses Neo4jClient through `self._memory_client.neo4j`
   - Returns `True` (success), `False` (skipped), or `None` (failed after retries)

2. **Fire-and-forget integration**: Added `asyncio.create_task()` call in `add_edge()` (lines 600-616)
   - Wrapped in try-except for AC-4 compliance (Canvas operation succeeds regardless)

3. **Retry mechanism**: Configured with tenacity
   - 3 attempts: `stop_after_attempt(3)`
   - Exponential backoff: 1s, 2s, 4s via `wait_exponential(multiplier=1, min=1, max=4)`
   - Silent failure after exhausting retries (returns `None`, no exception raised)

4. **Tests created**:
   - `backend/tests/unit/test_canvas_edge_sync.py` (9 unit tests)
   - `backend/tests/integration/test_edge_neo4j_sync.py` (4 integration tests)

### File List

| File | Action | Lines Changed |
|------|--------|---------------|
| `backend/app/services/canvas_service.py` | Modified | +80 lines (tenacity import, `_sync_edge_to_neo4j()` method, `add_edge()` integration) |
| `backend/tests/unit/test_canvas_edge_sync.py` | Created | ~280 lines (9 unit tests) |
| `backend/tests/integration/test_edge_neo4j_sync.py` | Created | ~180 lines (4 integration tests) |

## QA Results

### Review Date: 2026-01-31

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**总体评价: 优秀** ✅

实现完全符合 Story 需求和所有 ADR 决策。代码结构清晰，文档注释完整，所有 6 个 Acceptance Criteria 均已满足。

**关键实现亮点**:
1. `_sync_edge_to_neo4j()` 方法 (lines 248-320) 正确实现了 fire-and-forget 模式
2. 使用内部函数 `_do_sync()` + `@retry` 装饰器的设计模式优雅解决了 tenacity 与异步方法的集成
3. 优雅降级处理：memory_client 或 neo4j 不可用时返回 `False` 而非抛出异常
4. `add_edge()` 中的 `asyncio.create_task()` 调用正确包裹在 try-except 中，确保 Canvas 操作不受影响

### Refactoring Performed

无需重构。代码质量良好，符合项目标准。

### Compliance Check

- Coding Standards: ✓ 符合 - 类型注解完整，docstring 格式规范，来源引用完整
- Project Structure: ✓ 符合 - 测试文件放置在正确位置 (`tests/unit/`, `tests/integration/`)
- Testing Strategy: ✓ 符合 - 单元测试使用 Mock，集成测试正确标记 `@pytest.mark.integration`
- All ACs Met: ✓ 全部满足 - 详见下方验证表

### AC Verification Matrix

| AC# | 描述 | 实现位置 | 测试覆盖 | 状态 |
|-----|------|----------|----------|------|
| AC-1 | add_edge() 后触发 sync | `canvas_service.py:708-720` | `test_add_edge_triggers_sync_task` | ✅ |
| AC-2 | Fire-and-forget 模式 | `canvas_service.py:712` (`create_task`) | `test_add_edge_returns_immediately` | ✅ |
| AC-3 | 3次重试 + 指数退避 | `canvas_service.py:289-292` (tenacity) | `test_retry_on_neo4j_failure`, `test_silent_failure_after_max_retries` | ✅ |
| AC-4 | 同步失败不影响 Canvas 操作 | `canvas_service.py:711-724` (try-except) | `test_add_edge_succeeds_when_sync_fails` | ✅ |
| AC-5 | CONNECTS_TO 关系创建 | `canvas_service.py:296-302` 调用 `create_edge_relationship()` | `test_sync_edge_calls_neo4j_client` | ✅ |
| AC-6 | 复用 `_trigger_memory_event()` | `canvas_service.py:700-706` | N/A (集成点验证) | ✅ |

### ADR Compliance Check

| ADR | 决策要点 | 实现合规性 |
|-----|----------|-----------|
| ADR-0003 | Neo4j 存储架构，异步执行 | ✅ 使用 `create_edge_relationship()` 写入 Neo4j |
| ADR-0004 | fire-and-forget: `asyncio.create_task()` + try-except | ✅ Line 711-724 完全符合 |
| ADR-009 | tenacity 3次指数退避 (1s,2s,4s) | ✅ Line 289-292 完全符合 |

### Improvements Checklist

- [x] 所有 AC 验证完成
- [x] ADR 合规性验证完成
- [x] 测试执行验证 (9/9 passed)
- [ ] (建议) 考虑添加监控指标记录同步成功/失败次数
- [ ] (建议) 考虑添加配置项允许禁用 Neo4j 同步（用于开发环境）

### Security Review

无安全问题。Edge 数据同步不涉及敏感信息，且已正确处理异常避免信息泄露。

### Performance Considerations

- Fire-and-forget 模式确保 Canvas 操作不被 Neo4j 延迟影响
- 指数退避 (1s, 2s, 4s) 避免在 Neo4j 不可用时过度重试
- 测试 `test_add_edge_returns_immediately` 验证操作 < 1s 完成

### Files Modified During Review

无文件修改。

### Gate Status

Gate: **PASS** → `docs/qa/gates/36.3-canvas-edge-auto-sync-neo4j.yml`

### Recommended Status

✓ **Ready for Done** - 所有验收标准满足，代码质量优秀，测试充分。
