# Story 21.5.2.2: 添加缓存清理与边界处理

> **Epic**: [21.5.2 - Context传递机制修复](../prd/EPIC-21.5.2-CONTEXT-CACHE-FIX.md)
> **Type**: Brownfield Enhancement (Bug Fix)
> **Priority**: P1
> **前置Story**: Story 21.5.2.1 (实现Canvas Context缓存机制)

---

## Status

**Draft**

---

## Story

**As a** Canvas Learning System 用户,
**I want** Canvas右键菜单的context缓存在各种边界情况下正确清理和处理,
**so that** 快速连续操作、菜单关闭等场景不会导致context混乱或内存泄漏。

---

## Acceptance Criteria

1. **AC-1**: 菜单关闭时清除缓存 - 使用`menu.onHide()`回调清除`cachedCanvasContext`，防止缓存残留
2. **AC-2**: 快速连续右键不同节点时，每次都使用最新的context - 缓存在每次`handleCanvasNodeContextMenu()`调用时被覆盖
3. **AC-3**: 编辑器右键菜单不受缓存影响 - 编辑器context流程完全独立于Canvas缓存
4. **AC-4**: 添加调试日志 - 记录缓存设置、使用和清除事件，便于问题追踪

---

## Tasks / Subtasks

- [ ] **Task 1: 实现菜单关闭时的缓存清理** (AC: 1)
  - [ ] 1.1: 在`handleCanvasNodeContextMenu()`中，`menu.showAtMouseEvent(evt)`之前添加`menu.onHide()`回调
  - [ ] 1.2: 在回调中将`this.cachedCanvasContext`设置为`null`
  - [ ] 1.3: 添加调试日志记录缓存清除事件

- [ ] **Task 2: 验证快速连续右键场景** (AC: 2)
  - [ ] 2.1: 确认每次`handleCanvasNodeContextMenu()`调用时缓存被重新设置
  - [ ] 2.2: 添加调试日志记录缓存设置事件（包含filePath）
  - [ ] 2.3: 手动测试：快速右键节点A → 右键节点B → 验证两次都使用正确context

- [ ] **Task 3: 确保编辑器菜单隔离** (AC: 3)
  - [ ] 3.1: 审查编辑器右键菜单代码路径，确认不经过Canvas缓存逻辑
  - [ ] 3.2: 手动测试：右键Canvas节点 → 关闭菜单 → 右键编辑器 → 验证编辑器菜单正常

- [ ] **Task 4: 添加完整的调试日志** (AC: 4)
  - [ ] 4.1: 缓存设置日志：`ContextMenuManager: Canvas context cache set - filePath={path}`
  - [ ] 4.2: 缓存使用日志：`ContextMenuManager: Using cached canvas context - filePath={path}`
  - [ ] 4.3: 缓存清除日志：`ContextMenuManager: Canvas context cache cleared (menu hidden)`
  - [ ] 4.4: 回退日志：`ContextMenuManager: No cached context, using getActiveFile()`

- [ ] **Task 5: 集成测试** (AC: 1-4)
  - [ ] 5.1: 构建插件 (`npm run build`)
  - [ ] 5.2: 部署到Obsidian插件目录
  - [ ] 5.3: 执行完整测试场景矩阵

---

## Dev Notes

### SDD规范参考 (必填)

**注意**: 本Story为Obsidian插件端TypeScript代码修改，无后端API变更。规范来源为PRD和Obsidian官方API。

#### Obsidian Menu API

| 方法 | 签名 | 说明 | 来源 |
|------|------|------|------|
| `onHide` | `onHide(callback: () => any): void` | 注册菜单关闭时的回调函数 | [Source: obsidian.d.ts - Menu class] |
| `showAtMouseEvent` | `showAtMouseEvent(evt: MouseEvent): this` | 在鼠标位置显示菜单 | [Source: obsidian.d.ts - Menu class] |
| `hide` | `hide(): this` | 隐藏菜单 | [Source: obsidian.d.ts - Menu class] |

#### MenuContext接口

```typescript
// ✅ Verified from existing code: ContextMenuManager.ts
interface MenuContext {
    type: MenuContextType;          // 'editor' | 'canvas-node' | 'canvas-edge'
    filePath?: string;              // Canvas文件路径 (如 "Canvas/Math/lecture5.canvas")
    nodeId?: string;                // Canvas节点ID
    nodeColor?: CanvasNodeColor;    // 节点颜色
    nodeType?: string;              // 节点类型
}
```

[Source: PRD EPIC-21.5.2-CONTEXT-CACHE-FIX.md#Story-21.5.2.2]

---

### ADR决策关联 (必填)

| ADR编号 | 决策标题 | 对Story的影响 |
|---------|----------|---------------|
| ADR-0001 | 使用Obsidian Canvas作为可视化知识图谱载体 | Canvas操作必须使用Obsidian API (Menu, Canvas类) |

**关键约束** (从ADR-0001 Consequences提取):
- **格式依赖性**: Canvas格式没有官方公开规范，依赖逆向工程。需编写完整的单元测试覆盖Canvas格式解析。
- **Obsidian依赖**: 用户必须安装Obsidian才能查看和编辑Canvas。
- **插件API限制**: `getActiveFile()`在Canvas视图中返回节点链接的文件，而非canvas文件本身 (社区Issue: obsidian-tasks#2971)。

[Source: ADR-0001 - docs/architecture/decisions/0001-use-obsidian-canvas.md]

---

### 技术实现细节

#### 1. Menu.onHide()回调实现

```typescript
// ✅ Verified from Obsidian API (obsidian.d.ts - Menu class)
// 位置: ContextMenuManager.ts, handleCanvasNodeContextMenu() ~第857行后
const menu = new Menu();

// 注册菜单关闭回调 (AC-1: 缓存清理)
menu.onHide(() => {
    this.cachedCanvasContext = null;
    this.log('ContextMenuManager: Canvas context cache cleared (menu hidden)');
});

// ... 添加菜单项 ...

menu.showAtMouseEvent(evt);
```

**重要**: `menu.onHide()`必须在`menu.showAtMouseEvent()`之前调用，因为回调注册必须在菜单显示前完成。

#### 2. 缓存设置日志

```typescript
// 位置: handleCanvasNodeContextMenu() 中设置缓存后
// ✅ Verified from PRD EPIC-21.5.2-CONTEXT-CACHE-FIX.md
const context: MenuContext = {
    type: 'canvas-node',
    filePath: canvasView.file.path,
    nodeId: nodeInfo.nodeId,
    nodeColor: nodeInfo.nodeData?.color as CanvasNodeColor,
    nodeType: nodeInfo.nodeData?.type,
};

// Epic 21.5.2: 缓存当前 canvas context 供 action 使用
this.cachedCanvasContext = context;
this.log(`ContextMenuManager: Canvas context cache set - filePath=${context.filePath}`);
```

#### 3. getCurrentContext()修改 (需与Story 21.5.2.1协调)

```typescript
// ✅ Verified from PRD EPIC-21.5.2-CONTEXT-CACHE-FIX.md
// 位置: getCurrentContext() ~第961-968行
private getCurrentContext(): MenuContext {
    // Epic 21.5.2: 优先返回缓存的 canvas context
    if (this.cachedCanvasContext) {
        const cached = this.cachedCanvasContext;
        this.cachedCanvasContext = null; // 使用后立即清除
        this.log(`ContextMenuManager: Using cached canvas context - filePath=${cached.filePath}`);
        return cached;
    }

    // 回退到原有逻辑 (AC-3: 编辑器不受影响)
    this.log('ContextMenuManager: No cached context, using getActiveFile()');
    const activeFile = this.app.workspace.getActiveFile();
    return { type: 'editor', filePath: activeFile?.path };
}
```

#### 4. 边界情况处理

| 边界情况 | 处理方式 | 验证方法 |
|----------|----------|----------|
| 菜单关闭但action未执行 | `onHide()`回调清除缓存 | 右键 → 点击外部关闭 → 检查日志 |
| 快速连续右键 | 每次`handleCanvasNodeContextMenu()`覆盖缓存 | 快速右键A/B → 检查action收到的context |
| 编辑器右键 | 不经过`handleCanvasNodeContextMenu()` | 右键编辑器 → 检查无Canvas缓存日志 |
| action执行后 | `getCurrentContext()`中`cached = ...; cache = null;` | 执行action → 检查缓存已清除 |

---

### 依赖关系

**前置条件** (Story 21.5.2.1 必须完成):
- `cachedCanvasContext: MenuContext | null` 属性已添加到`ContextMenuManager`类
- `getCurrentContext()`已修改为支持缓存逻辑

**如果Story 21.5.2.1未完成**:
本Story需要先添加以下代码:
```typescript
// 类属性
private cachedCanvasContext: MenuContext | null = null;
```

---

### Testing

#### 测试标准 (从Architecture提取)

| 项目 | 标准 |
|------|------|
| 测试类型 | 手动集成测试 (Obsidian插件无自动化单元测试框架) |
| 测试环境 | Obsidian桌面应用 + 开发者控制台 |
| 日志验证 | 使用`console.log`在开发者控制台查看 |

#### 测试场景矩阵

| # | 场景 | 操作步骤 | 预期结果 | 验证方式 |
|---|------|----------|----------|----------|
| T1 | 正常Canvas右键 | 右键Canvas节点 → 选择Agent功能 | API收到正确canvas_name | 检查网络请求/bug_log |
| T2 | 菜单关闭不执行 | 右键Canvas节点 → 点击外部关闭 | 日志显示"cache cleared" | 开发者控制台 |
| T3 | 快速连续右键 | 右键节点A → 立即右键节点B → 选择功能 | 使用节点B的context | 日志显示B的filePath |
| T4 | Canvas后编辑器 | 右键Canvas节点 → 关闭 → 右键编辑器 | 编辑器功能正常 | 编辑器菜单可用 |
| T5 | 子目录Canvas | 打开`Canvas/Math/lecture5.canvas` → 右键节点 | 正确的canvas_name | API参数检查 |

#### 构建与部署命令

```bash
# 构建
cd canvas-progress-tracker/obsidian-plugin
npm run build

# 部署 (调整路径为实际Vault位置)
cp main.js manifest.json styles.css "你的笔记库/.obsidian/plugins/canvas-review-system/"

# 在Obsidian中重载
# Ctrl+P → "Reload app without saving"
```

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-14 | 1.0 | Initial story creation with ultrathink analysis | SM Agent (Bob) |

---

## Dev Agent Record

### Agent Model Used
*(To be filled by Dev Agent)*

### Debug Log References
*(To be filled by Dev Agent)*

### Completion Notes List
*(To be filled by Dev Agent)*

### File List
*(To be filled by Dev Agent)*

---

## QA Results

### Review Summary

| Metric | Result |
|--------|--------|
| **Review Date** | 2025-12-14 |
| **Reviewer** | Quinn (QA Agent) |
| **Review Type** | Standard Review (ultrathink) |
| **Risk Level** | Medium |
| **Gate Decision** | **PASS** |

### Step-by-Step Results

| Step | Check | Status | Notes |
|------|-------|--------|-------|
| 1 | Risk Assessment | MEDIUM | Dependency on Story 21.5.2.1, manual testing only |
| 2 | Requirements Traceability | PASS | 4/4 ACs have Given-When-Then coverage |
| 3 | Code Quality (Pre-impl) | PASS | Proposed patterns are sound, 8/10 |
| 4 | Test Architecture | PASS | 5 test scenarios, 7/10 |
| 5 | NFR Validation | PASS | Security, Performance, Reliability all pass |
| 6 | ADR Compliance | PASS | Directly addresses ADR-0001 API limitation |

### AC Coverage Matrix

| AC | Given-When-Then | Test Scenario | Coverage |
|----|-----------------|---------------|----------|
| AC-1 | Menu close clears cache | T2 | Complete |
| AC-2 | Rapid right-clicks use latest context | T3 | Complete |
| AC-3 | Editor menu isolation | T4 | Complete |
| AC-4 | Debug logging | T1-T5 | Complete |

### NFR Validation

| NFR | Status | Notes |
|-----|--------|-------|
| Security | PASS | No sensitive data handling |
| Performance | PASS | O(1) pointer operations only |
| Reliability | PASS | Dual cache cleanup mechanism |
| Maintainability | PASS | Complete debug logging |

### Issues Found

| ID | Severity | Finding | Suggested Action |
|----|----------|---------|------------------|
| TEST-001 | low | No automated unit tests | Accept: Obsidian plugin limitation |
| TEST-002 | low | T3 (rapid click) reproducibility | Document time interval for testers |

### Recommendations

**None blocking** - Story is ready for implementation.

### Gate Decision Rationale

Story 21.5.2.2 passes quality gate because:
1. All 4 ACs have complete test coverage via Given-When-Then mapping
2. Proposed code patterns are verified against Obsidian API documentation
3. NFR validation shows no security, performance, or reliability concerns
4. ADR-0001 compliance verified - directly addresses known API limitation
5. Risk level is manageable with existing mitigation (fallback code for dependency)
