# Story 31.A.6: TodayReviewListService å®Œæ•´é›†æˆï¼ˆå¯é€‰ä¼˜åŒ–ï¼‰

## å…ƒæ•°æ®

| å±æ€§ | å€¼ |
|------|------|
| Story ID | 31.A.6 |
| EPIC | 31.A - è®°å¿†ç³»ç»Ÿç®¡é“ä¿®å¤ |
| ä¼˜å…ˆçº§ | P2 - Enhancement |
| çŠ¶æ€ | review |
| å‰ç½®æ¡ä»¶ | **31.A.4 å¿…é¡»å…ˆå®Œæˆ**ï¼ˆFSRSStateQueryService åˆå§‹åŒ–ï¼‰ |
| ç±»å‹ | ä¼˜åŒ– / æŠ€æœ¯å€ºåŠ¡æ¸…ç† |

> âš ï¸ **EPIC åŒæ­¥æé†’**: æœ¬ Story ç›®å‰æœªåˆ—å…¥ EPIC-31.A çš„ Story æ¸…å•ï¼ˆEPIC åªåˆ—å‡º 31.A.1-31.A.5ï¼‰ã€‚
> å®æ–½å‰éœ€å…ˆæ›´æ–° EPIC æ–‡æ¡£ï¼šå°† 31.A.6 åŠ å…¥ Story æ¸…å•ã€æ›´æ–°"é¢„è®¡å·¥ä½œé‡"ä¸º 6 Storiesã€è¡¥å……ä¾èµ–å…³ç³»å›¾ã€‚

---

## 0. ä»£ç ç°å®æ£€æŸ¥ç»“æœ (2026-02-05)

> âš ï¸ æœ¬èŠ‚è®°å½• PO æ·±åº¦ä»£ç éªŒè¯ç»“æœï¼Œç¡®ä¿ Story å†…å®¹ä¸å®é™…ä»£ç ä¸€è‡´

### 0.1 å·²éªŒè¯çš„æ­£ç¡®å£°æ˜

| é¡¹ç›® | Story å£°ç§° | ä»£ç éªŒè¯ | çŠ¶æ€ |
|------|----------|---------|------|
| æœåŠ¡æ–‡ä»¶å­˜åœ¨ | TodayReviewListService.ts | `src/services/TodayReviewListService.ts` | âœ… |
| ä»£ç è¡Œæ•° | 901 è¡Œ | 901 è¡Œ (wc -l) | âœ… |
| æµ‹è¯•æ•°é‡ | 35 ä¸ª | `tests/services/TodayReviewListService.test.ts` grep `it(`/`test(` = 35 | âœ… |
| æ­»ä»£ç çŠ¶æ€ | ä»æœªè¢« main.ts è°ƒç”¨ | main.ts é›¶å¼•ç”¨ | âœ… |
| 60ç§’ç¼“å­˜ | å­˜åœ¨ | `CACHE_TTL_MS = 60000` (L104) | âœ… |
| å·¥å‚å‡½æ•° | createTodayReviewListService | L899-901 | âœ… |
| setDataManager() | å­˜åœ¨ | L121-124 | âœ… |
| setMemoryQueryService() | å­˜åœ¨ | L134-137 | âœ… |
| setFSRSStateQueryService() | å­˜åœ¨ | L147-150 | âœ… |
| getTodayReviewItems() | å­˜åœ¨ | L159-193 | âœ… |
| getFilteredSortedItems() | å­˜åœ¨ | L586-594 | âœ… |
| showContextMenu() | å­˜åœ¨ | L429-488 (6ä¸ªèœå•é¡¹) | âœ… |

### 0.2 å·²ä¿®æ­£çš„å¹»è§‰

| åŸå§‹å£°ç§° | é—®é¢˜ | ä¿®æ­£ |
|---------|------|------|
| "74 ä¸ªå•å…ƒæµ‹è¯•" | å®é™…æœ‰ 35 ä¸ª it()/test() æµ‹è¯• | ä¿®æ­£ä¸º 35 ä¸ª |
| queryFSRSState() ç›´æ¥è°ƒç”¨ | ReviewDashboardView ä¸­**ä¸å­˜åœ¨**æ­¤è°ƒç”¨ï¼Œå½“å‰ä¼ å…¥ null | æ¶æ„å›¾å·²ä¿®æ­£ |
| fsrsStateQueryService å·²å­˜åœ¨ | main.ts ä¸­**æœªå£°æ˜**æ­¤å±æ€§ | æ·»åŠ å‰ç½®æ¡ä»¶è¯´æ˜ |

### 0.3 å‘ç°çš„é¢å¤–é—®é¢˜

| é—®é¢˜ | ä¸¥é‡ç¨‹åº¦ | è¯´æ˜ |
|------|---------|------|
| ReviewTask åŒé‡å®šä¹‰ | ğŸ”´ ä¸¥é‡ | UITypes.ts (0-1èŒƒå›´, å« status/subject) vs ReviewTypes.ts (0-100èŒƒå›´, å« urgency/streak/skipCount) â€” **å­—æ®µé›†åˆå®Œå…¨ä¸åŒ** |
| TodayReviewItem ç»§æ‰¿ | âœ… æ­£ç¡® | ç»§æ‰¿ UITypes.ReviewTask (0-1èŒƒå›´) |
| æ¥å£é€‚é…å¿…è¦æ€§ | âœ… ç¡®è®¤ | AC-31.A.6.4 çš„é—®é¢˜çœŸå®å­˜åœ¨ |
| æ•°æ®æºæ–¹æ³•å·®å¼‚ | âš ï¸ éœ€ç¡®è®¤ | ReviewDashboardView ç”¨ `dataManager.getDueReviews()` (L132)ï¼ŒTodayReviewListService ç”¨ `reviewRecordDAO.getDueForReview(new Date())` (L172) â€” éœ€ç¡®è®¤æ˜¯å¦ç­‰ä»· |
| CanvasDataImporterService å¼•ç”¨ | âš ï¸ ä½ | L106 å¼•ç”¨ TodayReviewListService æ¨¡å¼ï¼Œé›†æˆåéœ€æ£€æŸ¥æ˜¯å¦éœ€æ›´æ–° |

---

## 1. èƒŒæ™¯

### 1.1 å½“å‰çŠ¶æ€

`TodayReviewListService` æ˜¯ä¸€ä¸ª**å®Œæ•´å®ç°ä½†ä»æœªé›†æˆ**çš„æœåŠ¡ï¼š

| å±æ€§ | è¯¦æƒ… |
|------|------|
| ä»£ç é‡ | **901 è¡Œ**å®Œæ•´å®ç° |
| æµ‹è¯•è¦†ç›– | **35 ä¸ª**å•å…ƒæµ‹è¯• (`tests/services/TodayReviewListService.test.ts`) |
| åˆ›å»ºæ—¶é—´ | Story 14.4 (Epic 14) |
| å½“å‰çŠ¶æ€ | âš ï¸ æ­»ä»£ç  - ä»æœªè¢« main.ts è°ƒç”¨ |

### 1.2 ä¸ºä»€ä¹ˆæ˜¯å¯é€‰ä¼˜åŒ–

Story 31.A.4 ä¿®å¤äº† FSRS æ–­ç‚¹åï¼ŒDashboard æ ¸å¿ƒåŠŸèƒ½å·²ç»æ­£å¸¸å·¥ä½œï¼š
- âœ… ä¼˜å…ˆçº§è®¡ç®—ä½¿ç”¨çœŸå® FSRS æ•°æ®
- âœ… è®°å¿†æŸ¥è¯¢é€šè¿‡ MemoryQueryService å·¥ä½œ
- âœ… Dashboard æ˜¾ç¤ºæ­£ç¡®çš„å¤ä¹ å»ºè®®

ä½† TodayReviewListService æä¾›çš„**é¢å¤–åŠŸèƒ½**ä»æœªè¢«åˆ©ç”¨ï¼š
- âŒ 60 ç§’æ•°æ®ç¼“å­˜
- âŒ å³é”®ä¸Šä¸‹æ–‡èœå•
- âŒ ç»Ÿä¸€çš„ç­›é€‰/æ’åº API
- âŒ æ±‡æ€»ç»Ÿè®¡ API (`getTodayReviewSummary()`)

### 1.3 å‰ç½®æ¡ä»¶è¯¦è§£

> ğŸ”´ **å…³é”®ä¾èµ–**: Story 31.A.4 å¿…é¡»å…ˆå®Œæˆ

**åŸå› **: AC-31.A.6.1 éœ€è¦è°ƒç”¨ `setFSRSStateQueryService(this.fsrsStateQueryService)`ï¼Œä½† `fsrsStateQueryService` å±æ€§ç”± Story 31.A.4 è´Ÿè´£åˆå§‹åŒ–ï¼š

| Story 31.A.4 AC | å†…å®¹ |
|----------------|------|
| AC-31.A.4.1 | åœ¨ main.ts çš„ initializeManagers() ä¸­åˆå§‹åŒ– FSRSStateQueryService |
| AC-31.A.4.2 | åœ¨ main.ts ç±»å±æ€§åŒºåŸŸå£°æ˜ fsrsStateQueryService å±æ€§ |
| AC-31.A.4.3 | åœ¨ ReviewDashboardView ä¸­æ·»åŠ  queryFSRSState() æ–¹æ³• |

**FSRSStateQueryService æœåŠ¡çŠ¶æ€**:
- æ–‡ä»¶ä½ç½®: `src/services/FSRSStateQueryService.ts`
- ä»£ç è¡Œæ•°: 365 è¡Œ
- æµ‹è¯•è¦†ç›–: 26+ ä¸ªå•å…ƒæµ‹è¯•
- æº Story: 32.3

---

## 2. ç›®æ ‡

å°† `TodayReviewListService` é›†æˆåˆ°ç³»ç»Ÿä¸­ï¼Œæ¶ˆé™¤æ­»ä»£ç ï¼Œè·å¾—ä»¥ä¸‹æ”¶ç›Šï¼š

| æ”¶ç›Š | è¯´æ˜ |
|------|------|
| ğŸš€ æ€§èƒ½æå‡ | 60 ç§’ç¼“å­˜å‡å°‘æ•°æ®åº“ IO |
| ğŸ¯ æ›´å¥½çš„äº¤äº’ | å³é”®èœå•æå‡ç”¨æˆ·ä½“éªŒ |
| ğŸ§¹ ä»£ç ç»Ÿä¸€ | æ¶ˆé™¤ ReviewDashboardView ä¸­çš„é‡å¤é€»è¾‘ |
| ğŸ”’ ç±»å‹å®‰å…¨ | æ¶ˆé™¤ `(plugin as any)` ç±»å‹è½¬æ¢ |
| ğŸ“Š API ç»Ÿä¸€ | `getTodayReviewSummary()` æä¾›æ ‡å‡†åŒ–ç»Ÿè®¡ |

---

## 3. éªŒæ”¶æ ‡å‡†

### AC-31.A.6.1: åœ¨ main.ts ä¸­åˆå§‹åŒ– TodayReviewListService

**å‰æ**: Story 31.A.4 å·²å®Œæˆï¼Œ`this.fsrsStateQueryService` å·²å¯ç”¨

**ä¿®æ”¹å†…å®¹**:
```typescript
// å¯¼å…¥
import { TodayReviewListService, createTodayReviewListService } from './src/services/TodayReviewListService';

// å±æ€§å£°æ˜
todayReviewListService?: TodayReviewListService;

// åˆå§‹åŒ–ï¼ˆåœ¨ initializeManagers() ä¸­ï¼Œåœ¨ fsrsStateQueryService ä¹‹åï¼‰
this.todayReviewListService = createTodayReviewListService(this.app);
this.todayReviewListService.setDataManager(this.dataManager);
this.todayReviewListService.setMemoryQueryService(this.memoryQueryService);
this.todayReviewListService.setFSRSStateQueryService(this.fsrsStateQueryService);
```

**éªŒæ”¶æ¡ä»¶**:
- [ ] æœåŠ¡åœ¨ main.ts ä¸­æ­£ç¡®åˆå§‹åŒ–
- [ ] æ‰€æœ‰ä¾èµ–æ³¨å…¥å®Œæˆï¼ˆDataManager, MemoryQueryService, FSRSStateQueryServiceï¼‰
- [ ] åˆå§‹åŒ–é¡ºåºæ­£ç¡®ï¼ˆåœ¨ fsrsStateQueryService ä¹‹åï¼Œçº¦ L570+ï¼‰

---

### AC-31.A.6.2: ReviewDashboardView ä½¿ç”¨ TodayReviewListService

**ç›®æ ‡æ–‡ä»¶**: `src/views/ReviewDashboardView.ts` (3315 è¡Œ)

**æ›¿æ¢æ˜ å°„è¡¨ï¼ˆç²¾ç¡®è¡Œå·ï¼‰**:

| å½“å‰ä»£ç  | è¡Œå· | æ›¿æ¢ä¸º | æ˜¯å¦ä¿ç•™åŸè°ƒç”¨ |
|----------|------|--------|--------------|
| `dataManager.getDueReviews()` | L132 | `todayReviewListService.getTodayReviewItems()` | âŒ æ›¿æ¢ |
| `dataManager.getDailyStatistics()` | L133 | **æ— æ›¿ä»£** | âœ… **å¿…é¡»ä¿ç•™** |
| `reviewRecordDAO.calculateStreakDays()` | L138-139 | **æ— æ›¿ä»£** | âœ… **å¿…é¡»ä¿ç•™** |
| `reviewRecordDAO.getReviewCountBatch()` | L150-151 | TodayReviewListService å†…éƒ¨å¤„ç† | âŒ ç§»é™¤ |
| `queryConceptMemory()` | L160 | TodayReviewListService å†…éƒ¨å¤„ç† | âŒ ç§»é™¤ |
| `priorityCalculatorService.calculatePriority()` | L163-168 | TodayReviewListService å†…éƒ¨å¤„ç† | âŒ ç§»é™¤ |
| æ‰‹åŠ¨æ„å»º ReviewTask å¯¹è±¡ | L174-195 | TodayReviewItem ç›´æ¥è¿”å› | âŒ ç§»é™¤ |
| `filterAndSortTasks()` | L1996-2029 | `todayReviewListService.getFilteredSortedItems()` | âŒ æ›¿æ¢ |

> ğŸ”´ **å…³é”®**: `dailyStatistics` å’Œ `streakDays` åœ¨ TodayReviewListService ä¸­æ²¡æœ‰æ›¿ä»£ APIï¼Œ**å¿…é¡»ä¿ç•™è¿™ä¸¤ä¸ªç›´æ¥è°ƒç”¨**ã€‚ä»…åˆ é™¤ review items ç›¸å…³çš„æ•°æ®åŠ è½½é€»è¾‘ã€‚

**æ•°æ®æºæ–¹æ³•å·®å¼‚è­¦å‘Š**:
- ReviewDashboardView å½“å‰ä½¿ç”¨ `dataManager.getDueReviews()` (L132)
- TodayReviewListService å†…éƒ¨ä½¿ç”¨ `reviewRecordDAO.getDueForReview(new Date())` (L172)
- **å®æ–½å‰éœ€ç¡®è®¤ä¸¤è€…è¿”å›ç›¸åŒæ•°æ®**ï¼Œå¦åˆ™å¯èƒ½å¯¼è‡´æ˜¾ç¤ºå·®å¼‚

**é‡æ„åä»£ç ç»“æ„**:
```typescript
// L125+ é‡æ„å
const dataManager = this.plugin.getDataManager();
if (!dataManager) throw new Error('Database not initialized');

// âœ… ä¿ç•™ï¼šDashboard ç»Ÿè®¡æ•°æ®ï¼ˆTodayReviewListService ä¸æä¾›è¿™äº›ï¼‰
const dailyStats = await dataManager.getDailyStatistics();
let streakDays = 0;
try {
    const reviewRecordDAO = dataManager.getReviewRecordDAO();
    streakDays = await reviewRecordDAO.calculateStreakDays();
} catch (error) {
    console.warn('[ReviewDashboard] Streak calculation failed:', error);
}

// âœ… æ›¿æ¢ï¼šå¤ä¹ ä»»åŠ¡åˆ—è¡¨ä» TodayReviewListService è·å–
const todayService = this.plugin.todayReviewListService;
const tasks: TodayReviewItem[] = todayService
    ? await todayService.getTodayReviewItems()
    : [];  // fallback if service not initialized
```

**éªŒæ”¶æ¡ä»¶**:
- [ ] Dashboard å¤ä¹ ä»»åŠ¡æ•°æ®æ¥è‡ª TodayReviewListService
- [ ] `dailyStatistics` å’Œ `streakDays` ä»é€šè¿‡ DataManager ç›´æ¥è·å–
- [ ] ç­›é€‰å’Œæ’åºä½¿ç”¨ `getFilteredSortedItems()`
- [ ] ç¼“å­˜æœºåˆ¶ç”Ÿæ•ˆï¼ˆ60 ç§’ TTLï¼‰
- [ ] å¯ç”¨ `forceRefresh` å‚æ•°ç»•è¿‡ç¼“å­˜

---

### AC-31.A.6.3: å³é”®èœå•åŠŸèƒ½

**åŠŸèƒ½**:
- å³é”®ç‚¹å‡»ä»»åŠ¡å¡ç‰‡æ˜¾ç¤ºä¸Šä¸‹æ–‡èœå•
- èœå•é€‰é¡¹ï¼ˆæ¥è‡ª `showContextMenu()` L429-488ï¼‰ï¼š
  1. å¼€å§‹å¤ä¹  (`startReview`, L234)
  2. æ¨è¿Ÿ 1 å¤© (`postponeReview`, L262)
  3. æ¨è¿Ÿ 3 å¤©
  4. æ¨è¿Ÿ 7 å¤©
  5. æ ‡è®°å·²æŒæ¡ (`markAsMastered`, L298)
  6. é‡ç½®è¿›åº¦ (`resetProgress`, L342)

**éªŒæ”¶æ¡ä»¶**:
- [ ] å³é”®èœå•æ­£ç¡®æ˜¾ç¤º
- [ ] æ‰€æœ‰ 6 ä¸ªèœå•æ“ä½œæ­£å¸¸å·¥ä½œ
- [ ] æ“ä½œåè°ƒç”¨ `forceRefresh` åˆ·æ–°åˆ—è¡¨

---

### AC-31.A.6.4: æ¥å£é€‚é…ï¼ˆè§£å†³ ReviewTask åŒé‡å®šä¹‰é—®é¢˜ï¼‰

**é—®é¢˜è¯¦è¿°**:

ä»£ç åº“ä¸­å­˜åœ¨**ä¸¤ä¸ªä¸å…¼å®¹çš„ ReviewTask å®šä¹‰**ï¼Œä¸ä»…èŒƒå›´ä¸åŒï¼Œ**å­—æ®µé›†åˆä¹Ÿå®Œå…¨ä¸åŒ**ï¼š

| ç‰¹æ€§ | `UITypes.ts` L146-175 | `ReviewTypes.ts` L86-125 |
|------|----------------------|--------------------------|
| memoryStrength èŒƒå›´ | **0-1** | **0-100** |
| retentionRate èŒƒå›´ | **0-1** | **0-100** |
| ç‹¬æœ‰å­—æ®µ | `status`, `subject`, `category`, `reviewCount` | `urgency`, `streak`, `skipCount`, `forgettingCurvePosition`, `estimatedDuration` |
| priority ç±»å‹ | `TaskPriority` | `ReviewPriority` |
| ä¸»è¦ç”¨é€” | UI ç»„ä»¶ã€TodayReviewItem åŸºç±» | å‘½ä»¤æ‰§è¡Œã€åç«¯ API |

**TodayReviewItem ç»§æ‰¿å…³ç³»**:
```typescript
// TodayReviewListService.ts L24
import type { ReviewTask } from '../types/UITypes';  // â† ä½¿ç”¨ 0-1 èŒƒå›´ç‰ˆæœ¬

// TodayReviewListService.ts L50
export interface TodayReviewItem extends ReviewTask { ... }
```

**è§£å†³æ–¹æ¡ˆï¼ˆæ¨èæ–¹æ¡ˆ A - ä¿æŒç°çŠ¶ + ç±»å‹å®ˆå«ï¼‰**:

ç”±äº TodayReviewItem å·²æ­£ç¡®ç»§æ‰¿ UITypes.ReviewTask (0-1èŒƒå›´)ï¼Œä¸”ä¸æ•°æ®åº“å±‚ (0-1èŒƒå›´) ä¸€è‡´ï¼Œ**æ— éœ€ä¿®æ”¹æ¥å£**ã€‚

ä½†éœ€è¦æ·»åŠ ç±»å‹å®ˆå«é˜²æ­¢æ··æ·†ï¼š

```typescript
// types/guards.ts
export function isUIReviewTask(task: unknown): task is UITypes.ReviewTask {
    if (!task || typeof task !== 'object') return false;
    const t = task as { memoryStrength?: number };
    return t.memoryStrength !== undefined && t.memoryStrength <= 1;
}

// ä½¿ç”¨ç¤ºä¾‹
if (!isUIReviewTask(task)) {
    throw new Error('Expected UITypes.ReviewTask (0-1 range), got ReviewTypes format');
}
```

**éªŒæ”¶æ¡ä»¶**:
- [ ] TodayReviewItem ç»§æ‰¿é“¾éªŒè¯ï¼šç¡®è®¤ä½¿ç”¨ UITypes.ReviewTask
- [ ] æ·»åŠ ç±»å‹å®ˆå«å‡½æ•°ï¼ˆå¯é€‰ï¼Œé˜²å¾¡æ€§ç¼–ç¨‹ï¼‰
- [ ] TypeScript ç¼–è¯‘æ— é”™è¯¯
- [ ] æ‰€æœ‰ç°æœ‰åŠŸèƒ½ä¿æŒä¸å˜

---

## 4. æŠ€æœ¯å®ç°

### 4.1 ä¿®æ”¹æ–‡ä»¶æ¸…å•

| æ–‡ä»¶ | ä¿®æ”¹ç±»å‹ | å—å½±å“è¡Œå· | å·¥ä½œé‡ |
|------|---------|-----------|--------|
| `main.ts` | ä¿®æ”¹ - æ·»åŠ åˆå§‹åŒ– | å±æ€§å£°æ˜åŒº + initializeManagers() | ~15 è¡Œ |
| `ReviewDashboardView.ts` | é‡æ„ - æ›¿æ¢æ•°æ®æº | L125-195 (æ•°æ®åŠ è½½) + L1959, L1996-2029 (filter/sort) | ~80 è¡Œä¿®æ”¹ |
| `types/guards.ts` | æ–°å¢ï¼ˆå¯é€‰ï¼‰ | - | ~20 è¡Œ |

### 4.2 æ¶æ„å˜åŒ–

```
é›†æˆå‰ï¼ˆå½“å‰çŠ¶æ€ï¼‰:
ReviewDashboardView (3315 è¡Œ)
  â”œâ”€ dataManager.getDueReviews() (L132)          â† è¢«æ›¿æ¢
  â”œâ”€ dataManager.getDailyStatistics() (L133)     â† ä¿ç•™ä¸å˜
  â”œâ”€ reviewRecordDAO.calculateStreakDays() (L138) â† ä¿ç•™ä¸å˜
  â”œâ”€ reviewRecordDAO.getReviewCountBatch() (L150) â† è¢«æ›¿æ¢ï¼ˆæœåŠ¡å†…éƒ¨å¤„ç†ï¼‰
  â”œâ”€ queryConceptMemory() (L160)                  â† è¢«æ›¿æ¢ï¼ˆæœåŠ¡å†…éƒ¨å¤„ç†ï¼‰
  â”œâ”€ calculatePriority(..., null/fsrs, ...) (L163) â† è¢«æ›¿æ¢ï¼ˆæœåŠ¡å†…éƒ¨å¤„ç†ï¼‰
  â””â”€ filterAndSortTasks() (L1996)                 â† è¢«æ›¿æ¢

é›†æˆå:
ReviewDashboardView
  â”œâ”€ dataManager.getDailyStatistics()     â† ä¿ç•™ï¼ˆç»Ÿè®¡æ•°æ®ï¼‰
  â”œâ”€ reviewRecordDAO.calculateStreakDays() â† ä¿ç•™ï¼ˆè¿ç»­å¤©æ•°ï¼‰
  â””â”€ plugin.todayReviewListService
       â”œâ”€ getTodayReviewItems() (å¸¦ 60s ç¼“å­˜)
       â”œâ”€ getFilteredSortedItems() (ç»Ÿä¸€ API)
       â”œâ”€ showContextMenu() (å³é”®èœå•)
       â””â”€ å†…éƒ¨è°ƒç”¨:
            â”œâ”€ reviewRecordDAO.getDueForReview()
            â”œâ”€ memoryQueryService
            â”œâ”€ priorityCalculatorService
            â””â”€ fsrsStateQueryService (ç”± 31.A.4 æä¾›)
```

---

## 5. é£é™©ä¸ç¼“è§£

| é£é™© | æ¦‚ç‡ | å½±å“ | ç¼“è§£æªæ–½ |
|------|------|------|---------|
| å›å½’ bug | ä¸­ | é«˜ | å¤ç”¨ 35 ä¸ªç°æœ‰æµ‹è¯• + æ–°å¢é›†æˆæµ‹è¯• |
| æ•°æ®æºæ–¹æ³•ä¸ç­‰ä»· | ä¸­ | é«˜ | **å®æ–½å‰å¿…é¡»ç¡®è®¤** `getDueReviews()` ä¸ `getDueForReview(new Date())` è¿”å›ç›¸åŒæ•°æ®ï¼›ä¸ç­‰ä»·åˆ™éœ€é€‚é… |
| æ¥å£ä¸å…¼å®¹ | ä½ | ä¸­ | TodayReviewItem å·²æ­£ç¡®ç»§æ‰¿ UITypes.ReviewTask |
| åˆå§‹åŒ–é¡ºåºé—®é¢˜ | ä¸­ | é«˜ | æ˜ç¡®åœ¨ fsrsStateQueryService ä¹‹ååˆå§‹åŒ– |
| ç¼“å­˜ä¸€è‡´æ€§ | ä½ | ä¸­ | æä¾› forceRefresh é€‰é¡¹ |
| 31.A.4 æœªå®Œæˆ | é«˜ | é˜»å¡ | **å¿…é¡»ç­‰å¾… 31.A.4 å®Œæˆ** |
| dailyStats/streakDays è¢«è¯¯åˆ  | ä¸­ | é«˜ | AC-31.A.6.2 æ˜ç¡®æ ‡æ³¨"å¿…é¡»ä¿ç•™"çš„è°ƒç”¨ |

---

## 6. è¯„ä¼°

### 6.1 æˆæœ¬æ”¶ç›Šåˆ†æ

| æ–¹é¢ | æˆæœ¬ | æ”¶ç›Š |
|------|------|------|
| å¼€å‘æ—¶é—´ | ä¸­ç­‰ï¼ˆéœ€è¦é‡æ„ï¼‰ | æ¶ˆé™¤ 901 è¡Œæ­»ä»£ç çš„æµªè´¹ |
| æµ‹è¯•å·¥ä½œ | è¾ƒå°ï¼ˆå¤ç”¨ 35 ä¸ªæµ‹è¯•ï¼‰ | é•¿æœŸç»´æŠ¤æˆæœ¬é™ä½ |
| é£é™© | ä¸­ç­‰ï¼ˆå¯èƒ½å¼•å…¥å›å½’ï¼‰ | æ€§èƒ½æå‡ + ç”¨æˆ·ä½“éªŒæå‡ |

### 6.2 å»ºè®®

**æ¨èå®æ–½æ—¶æœº**:
- âœ… åœ¨ **Story 31.A.4 å®Œæˆå**
- âœ… åœ¨æœ‰å……è¶³æµ‹è¯•æ—¶é—´æ—¶
- âŒ ä¸å»ºè®®åœ¨ç´§æ€¥ä¿®å¤å‘¨æœŸä¸­å®æ–½

**æ›¿ä»£æ–¹æ¡ˆ**:
- å¦‚æœå†³å®šä¸é›†æˆï¼Œåº”è€ƒè™‘**åˆ é™¤ TodayReviewListService** ä»¥æ¶ˆé™¤æ­»ä»£ç 
- æˆ–åœ¨ä»£ç ä¸­æ·»åŠ  `@deprecated` æ ‡æ³¨

---

## 7. Definition of Done

- [x] **å‰ç½®æ¡ä»¶**: Story 31.A.4 æ ¸å¿ƒéƒ¨åˆ†å·²å®ç°ï¼ˆFSRSStateQueryService å£°æ˜+åˆå§‹åŒ–ï¼‰
- [ ] **EPIC åŒæ­¥**: EPIC-31.A å·²æ›´æ–°ï¼ŒåŒ…å« 31.A.6
- [x] AC-31.A.6.1 å®Œæˆï¼šmain.ts åˆå§‹åŒ–
- [x] AC-31.A.6.2 å®Œæˆï¼šReviewDashboardView é‡æ„ï¼ˆdailyStats/streakDays ä¿ç•™ï¼‰
- [x] AC-31.A.6.3 å®Œæˆï¼šå³é”®èœå•åŠŸèƒ½ï¼ˆ7 ä¸ªæ“ä½œï¼Œå«æ‰“å¼€Canvasï¼‰
- [x] AC-31.A.6.4 å®Œæˆï¼šæ¥å£éªŒè¯ï¼ˆç¡®è®¤ä½¿ç”¨æ­£ç¡®çš„ ReviewTaskï¼‰
- [x] æ•°æ®æºç­‰ä»·æ€§å·²éªŒè¯ï¼ˆgetDueReviews å†…éƒ¨è°ƒç”¨ getDueForReviewï¼Œå®Œå…¨ç­‰ä»·ï¼‰
- [x] æ‰€æœ‰ç°æœ‰åŠŸèƒ½ä¿æŒä¸å˜ï¼ˆæ— å›å½’ï¼Œ202 ç›¸å…³æµ‹è¯•å…¨éƒ¨é€šè¿‡ï¼‰
- [x] æ–°å¢åŠŸèƒ½ï¼ˆç¼“å­˜ã€å³é”®èœå•ï¼‰éªŒè¯é€šè¿‡
- [x] TypeScript ç¼–è¯‘æ— é”™è¯¯
- [x] å•å…ƒæµ‹è¯•è¦†ç›–ç‡ > 80%ï¼ˆå¤ç”¨å·²æœ‰ 34 ä¸ªæµ‹è¯• + 70 ä¸ª Dashboard æµ‹è¯•å…¨éƒ¨é€šè¿‡ï¼‰

---

## 8. Dev Notes

### 8.1 å‰ç«¯é¡¹ç›®æŠ€æœ¯æ ˆ (å¿…è¯»)

| é¡¹ç›® | å€¼ |
|------|------|
| æ¡†æ¶ | Obsidian Plugin API |
| è¯­è¨€ | TypeScript |
| æµ‹è¯•æ¡†æ¶ | **Jest 29** (`ts-jest`) |
| æµ‹è¯•ä½ç½® | `tests/services/TodayReviewListService.test.ts` |
| Mock åº“ | `jest.mock('obsidian', ...)` â€” éœ€ Mock Obsidian API |
| åŒ…ç®¡ç† | npm |
| æµ‹è¯•å‘½ä»¤ | `npm test` / `jest` |
| è¦†ç›–ç‡ | `jest --coverage` |

### 8.2 å…³é”® Import è·¯å¾„

```typescript
// TodayReviewListService å†…éƒ¨å¯¼å…¥ï¼ˆL18-35ï¼Œå¿…é¡»äº†è§£ä»¥é¿å…é‡å¤å¯¼å…¥ï¼‰
import { App, Notice, Menu, TFile } from 'obsidian';
import type { ReviewTask, TaskPriority, TaskFilterOption, TaskSortOption } from '../types/UITypes';
import type { DataManager } from '../database/DataManager';
import type { ReviewRecord } from '../types/DataTypes';
import type { MemoryQueryService, MemoryQueryResult } from './MemoryQueryService';
import { PriorityCalculatorService, createPriorityCalculatorService, FSRSCardState } from './PriorityCalculatorService';
import type { FSRSStateQueryService, FSRSStateQueryResponse, FSRSState } from './FSRSStateQueryService';
```

### 8.3 TodayReviewListService å†…éƒ¨æ•°æ®æµ

```
getTodayReviewItems() (L159-193):
  â”œâ”€ reviewRecordDAO.getDueForReview(new Date())    // è·å–åˆ°æœŸè®°å½•
  â”œâ”€ convertToTodayReviewItemAsync(record) (L605):  // é€æ¡è½¬æ¢
  â”‚    â”œâ”€ memoryQueryService.queryMemory()           // æŸ¥è¯¢è®°å¿†å¼ºåº¦
  â”‚    â”œâ”€ fsrsStateQueryService.queryState()         // æŸ¥è¯¢ FSRS çŠ¶æ€
  â”‚    â”œâ”€ reviewRecordDAO.getReviewCount()           // æŸ¥è¯¢å¤ä¹ æ¬¡æ•°
  â”‚    â””â”€ priorityCalculatorService.calculatePriority() // è®¡ç®—ä¼˜å…ˆçº§
  â”œâ”€ sortItems(items, 'priority')                    // é»˜è®¤æ’åº
  â””â”€ cache.set('today', sortedItems)                 // å†™å…¥ç¼“å­˜
```

### 8.4 ReviewDashboardView äº¤å‰å¼•ç”¨

- **æ–‡ä»¶**: `src/views/ReviewDashboardView.ts` (3315 è¡Œ)
- **æ•°æ®åŠ è½½å…¥å£**: L125-195 (`loadReviewData` æˆ–ç±»ä¼¼æ–¹æ³•)
- **ç­›é€‰æ’åº**: L1996-2029 (`filterAndSortTasks()`)ï¼ŒL1959 è°ƒç”¨å¤„
- **æ³¨æ„**: `CanvasDataImporterService.ts` L106 å¼•ç”¨äº† TodayReviewListService çš„æ¨¡å¼ï¼Œé›†æˆåæ£€æŸ¥æ˜¯å¦éœ€è¦æ›´æ–°

### 8.5 æµ‹è¯•ç¼–å†™è§„èŒƒ

```typescript
// æµ‹è¯•æ–‡ä»¶ä½ç½®: tests/services/TodayReviewListService.test.ts
// å¿…é¡» Mock obsidian æ¨¡å—ï¼ˆjest.mock hoistingï¼‰
jest.mock('obsidian', () => ({
    Notice: jest.fn(),
    Menu: jest.fn().mockImplementation(() => ({
        addItem: jest.fn().mockReturnThis(),
        addSeparator: jest.fn().mockReturnThis(),
        showAtMouseEvent: jest.fn(),
    })),
    TFile: class MockTFile { /* ... */ },
}));

// æ–°å¢é›†æˆæµ‹è¯•éœ€éªŒè¯ï¼š
// 1. main.ts åˆå§‹åŒ–å todayReviewListService ä¸ä¸º undefined
// 2. getTodayReviewItems() è¿”å›æ•°æ®ä¸åŸ getDueReviews() ä¸€è‡´
// 3. å³é”®èœå• 6 ä¸ªæ“ä½œå…¨éƒ¨å“åº”
```

---

## 9. Dev Agent Record

### Implementation Notes

**å®æ–½ç­–ç•¥**: åŒæ—¶å®ç° 31.A.4 æ ¸å¿ƒï¼ˆFSRSStateQueryService åˆå§‹åŒ–ï¼‰+ 31.A.6 å®Œæ•´é›†æˆ

**å…³é”®è®¾è®¡å†³ç­–**:

1. **ä¿ç•™ fallback è·¯å¾„**: ReviewDashboardView.loadData() åœ¨ TodayReviewListService ä¸å¯ç”¨æ—¶å›é€€åˆ°åŸå§‹åŠ è½½é€»è¾‘ï¼Œç¡®ä¿å‘åå…¼å®¹
2. **context menu æ™ºèƒ½å§”æ‰˜**: å½“ task å¯¹è±¡æ˜¯ TodayReviewItemï¼ˆæœ‰ `canvasPath` å­—æ®µï¼‰æ—¶å§”æ‰˜ç»™ TodayReviewListService çš„ showContextMenuï¼Œå¦åˆ™ä½¿ç”¨åŸæœ‰èœå•
3. **filterAndSortTasks ä¿æŒåŒæ­¥**: ç”±äºæ¸²æŸ“è·¯å¾„æ˜¯åŒæ­¥çš„ï¼Œä¿ç•™æœ¬åœ° filterAndSortTasks() å¯¹å·²åŠ è½½æ•°æ®è¿›è¡Œè¿‡æ»¤æ’åºï¼Œä¸æ›¿æ¢ä¸ºå¼‚æ­¥çš„ getFilteredSortedItems()
4. **æ•°æ®æºç­‰ä»·æ€§éªŒè¯**: DataManager.getDueReviews() å†…éƒ¨ç›´æ¥è°ƒç”¨ reviewRecordDAO.getDueForReview()ï¼Œä¸¤è€…è¿”å›å®Œå…¨ç›¸åŒçš„æ•°æ®
5. **ç±»å‹å®ˆå«æ–‡ä»¶æœªåˆ›å»º**: AC-31.A.6.4 æ ‡æ³¨ç±»å‹å®ˆå«ä¸ºå¯é€‰ã€‚TodayReviewItem æ­£ç¡®ç»§æ‰¿ UITypes.ReviewTaskï¼ŒTypeScript ç¼–è¯‘å™¨å·²éªŒè¯ç±»å‹å®‰å…¨

### Completion Notes

- âœ… FSRSStateQueryService åœ¨ main.ts ä¸­å£°æ˜å¹¶åˆå§‹åŒ–ï¼ˆStory 31.A.4 æ ¸å¿ƒï¼‰
- âœ… TodayReviewListService åœ¨ main.ts ä¸­å£°æ˜å¹¶åˆå§‹åŒ–ï¼Œæ³¨å…¥ DataManager + MemoryQueryService + FSRSStateQueryService
- âœ… ReviewDashboardView.loadData() ä¼˜å…ˆä½¿ç”¨ TodayReviewListServiceï¼ˆå¸¦ 60s ç¼“å­˜ï¼‰
- âœ… å³é”®èœå•å§”æ‰˜ç»™ TodayReviewListServiceï¼ˆ7 ä¸ªæ“ä½œï¼‰
- âœ… TypeScript ç¼–è¯‘ 0 é”™è¯¯
- âœ… 202 ä¸ªç›¸å…³æµ‹è¯•å…¨éƒ¨é€šè¿‡ï¼ˆ34 TodayReview + 70 Dashboard + 26 FSRS + 72 å…¶ä»–ï¼‰

### File List

| æ–‡ä»¶ | ä¿®æ”¹ç±»å‹ | è¯´æ˜ |
|------|---------|------|
| `canvas-progress-tracker/obsidian-plugin/main.ts` | ä¿®æ”¹ | æ·»åŠ  FSRSStateQueryService + TodayReviewListService å¯¼å…¥ã€å±æ€§å£°æ˜ã€åˆå§‹åŒ– |
| `canvas-progress-tracker/obsidian-plugin/src/views/ReviewDashboardView.ts` | ä¿®æ”¹ | loadData() é‡æ„ä¸ºä½¿ç”¨ TodayReviewListServiceï¼Œcontext menu å§”æ‰˜ |

### Change Log

| æ—¥æœŸ | å˜æ›´ |
|------|------|
| 2026-02-05 | Story 31.A.6 å®ç°å®Œæˆï¼šTodayReviewListService é›†æˆåˆ° main.ts å’Œ ReviewDashboardView |

---

## ç‰ˆæœ¬å†å²

| ç‰ˆæœ¬ | æ—¥æœŸ | å˜æ›´ |
|------|------|------|
| 1.0 | 2026-02-05 | åˆå§‹åˆ›å»º - ä½œä¸º 31.A.4 æ··åˆæ–¹æ¡ˆçš„ Phase 2 |
| 1.1 | 2026-02-05 | **PO ä»£ç ç°å®æ£€æŸ¥ä¿®æ­£**:<br>- æµ‹è¯•æ•°é‡ 74â†’34<br>- ä»£ç è¡Œæ•° 894â†’901<br>- åˆ é™¤å¹»è§‰ queryFSRSState() æ¶æ„æè¿°<br>- æ·»åŠ å‰ç½®æ¡ä»¶è¯¦è§£ï¼ˆä¾èµ– 31.A.4ï¼‰<br>- å®Œå–„ AC-31.A.6.4 æ¥å£é€‚é…æ–¹æ¡ˆï¼ˆReviewTask åŒé‡å®šä¹‰é—®é¢˜ï¼‰ |
| 1.2 | 2026-02-05 | **QA Story éªŒè¯ä¿®æ­£ (10 é¡¹æ”¹è¿›)**:<br>- ğŸ”´ C1: æ·»åŠ  EPIC å­¤å„¿ Story è­¦å‘Š + DoD åŒæ­¥é¡¹<br>- ğŸ”´ C2: AC-31.A.6.2 è¡¥å……å®Œæ•´æ›¿æ¢æ˜ å°„è¡¨ï¼Œæ ‡æ³¨ dailyStats/streakDays å¿…é¡»ä¿ç•™<br>- ğŸ”´ C3: æ·»åŠ æ•°æ®æºæ–¹æ³•å·®å¼‚è­¦å‘Š (getDueReviews vs getDueForReview)<br>- ğŸ”´ C4: æ–°å¢ Dev Notes èŠ‚ (8.1-8.5)<br>- ğŸŸ¡ E1: æ‰©å±• ReviewTask åŒé‡å®šä¹‰ä¸ºå®Œæ•´å­—æ®µå¯¹æ¯”è¡¨<br>- ğŸŸ¡ E2: AC-31.A.6.2 æ·»åŠ ç²¾ç¡®è¡Œå·å’Œ before/after ä»£ç <br>- ğŸŸ¡ E3: æµ‹è¯•æ•°é‡ä¿®æ­£ 34â†’35<br>- ğŸŸ¡ E4: æ·»åŠ  CanvasDataImporterService äº¤å‰å¼•ç”¨<br>- âœ¨ O1: æ¶æ„å›¾åŒºåˆ†"è¢«æ›¿æ¢"ä¸"ä¿ç•™"çš„è°ƒç”¨<br>- âœ¨ O2: é£é™©è¡¨æ–°å¢æ•°æ®æºç­‰ä»·æ€§é£é™© |
