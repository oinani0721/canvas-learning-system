# Story 34.13: 教材挂载真实 E2E 验证

<!-- Powered by BMAD Core -->

## Status

**Ready** (2026-02-10) — R4 对抗性审查创建

---

## Story

**As a** 用户和 QA 工程师,
**I want** 教材挂载功能有真实的端到端测试（通过 HTTP 请求而非 TestClient），覆盖完整的前后端同步路径,
**so that** 我有信心教材挂载功能在真实环境中能正常工作，而不仅仅是后端自测通过

## 来源

本 Story 基于 R4 对抗性审查发现创建：
- Finding #4: Story 34.3 教材挂载 E2E 同步路径未端到端验证 — 插件和后端各自存在但完整同步未被测试
- Finding #9: E2E 测试与 Integration 测试概念混用 — tests/integration/ 中的测试使用 TestClient 不是真正 E2E
- EPIC 34 的核心价值主张是"修复前后端集成断连"，但验证方式只是后端自测

---

## Acceptance Criteria

### AC1: 创建真实 E2E 测试文件 [P2]

**问题**: 现有 `tests/e2e/test_textbook_mount_flow.py` 可能使用 TestClient（进程内），而非真实 HTTP E2E。

**验收标准**:

```gherkin
Given 需要验证教材挂载前后端完整同步路径
When 创建 tests/e2e/test_textbook_mount_e2e.py
Then 测试满足以下条件:
  - 使用 httpx.AsyncClient 或 requests（真实 HTTP 请求）
  - 或使用 TestClient 但配合真实的文件 I/O 验证 .canvas-links.json
  - 不 mock TextbookMountService 核心逻辑
  - 不 mock 文件系统操作

And 测试文件位于 tests/e2e/ 目录（非 tests/integration/）
```

**基础设施维度 (D6 集成)**:
- E2E 测试必须验证完整数据流：请求 → 服务处理 → 文件写入 → 读回验证

---

### AC2: 完整同步路径覆盖 [P2]

**验收标准**:

```gherkin
Given E2E 测试
When 测试教材挂载完整路径
Then 覆盖以下步骤:
  Step 1: POST 挂载请求（指定 canvas_id + 教材路径 + 格式类型）
  Step 2: 验证后端返回 200/201
  Step 3: 验证 .canvas-links.json 文件被正确写入（包含教材关联）
  Step 4: GET 请求读回教材关联列表
  Step 5: 验证返回的列表包含 Step 1 中挂载的教材
  Step 6: 验证教材上下文可被 Agent 获取（GET context 端点）

And 每个步骤有独立的断言
And 失败时能定位到具体哪个步骤断开
```

---

### AC3: 三种格式覆盖 [P2]

**验收标准**:

```gherkin
Given 系统支持 PDF/Markdown/Canvas 三种教材格式
When 分别测试三种格式挂载
Then:
  - test_mount_pdf_textbook: PDF 格式挂载 → 关联正确 → 上下文可获取
  - test_mount_markdown_textbook: Markdown 格式挂载 → 关联正确 → 上下文可获取
  - test_mount_canvas_textbook: Canvas 格式挂载 → 关联正确 → 上下文可获取

And 每种格式至少 1 个正向测试 + 1 个负向测试（无效文件路径）
```

---

### AC4: 不影响现有测试 [Gate]

**验收标准**:

```gherkin
Given 新增 E2E 测试
When 运行完整测试套件
Then:
  - 现有 tests/integration/ 和 tests/e2e/ 教材相关测试全部 PASS
  - 新增 E2E 测试全部 PASS
  - 无命名冲突或 fixture 干扰
```

---

## Tasks / Subtasks

- [ ] **Task 1: 调研现有测试覆盖** (准备)
  - [ ] 1.1 读取 `tests/e2e/test_textbook_mount_flow.py` 确认实际使用的 client 类型
  - [ ] 1.2 读取 `tests/integration/` 中教材相关测试
  - [ ] 1.3 确定现有测试的覆盖盲区

- [ ] **Task 2: ATDD 红灯测试** (先于实现!)
  - [ ] 2.1 创建 `tests/e2e/test_textbook_mount_e2e.py` 测试骨架
  - [ ] 2.2 写 3 个格式挂载测试（预期 FAIL 如果端点不存在或行为不符）
  - [ ] 2.3 写 3 个负向测试
  - [ ] 2.4 确认红灯

- [ ] **Task 3: 修复使测试绿灯** (如需)
  - [ ] 3.1 如果 E2E 测试发现 bug → 修复后端代码
  - [ ] 3.2 如果 E2E 测试发现断连 → 补充缺失的集成逻辑
  - [ ] 3.3 如果全部绿灯 → 无需修复（功能已正确）

- [ ] **Task 4: 回归验证** (AC: 4)
  - [ ] 4.1 运行全部教材相关测试
  - [ ] 4.2 确认无命名冲突或 fixture 干扰

---

## Dev Notes

### 现有测试文件参考

| 文件 | 类型 | 覆盖范围 |
|------|------|---------|
| `tests/e2e/test_textbook_mount_flow.py` | E2E (待确认 client 类型) | 教材挂载流程 |
| `tests/integration/test_cross_canvas_injection.py` | Integration | 跨 Canvas 注入 |

### E2E 测试模式参考

```python
# 真实 E2E 模式 (使用 httpx)
import httpx
import pytest
import tempfile
import json

@pytest.fixture
def base_url():
    return "http://localhost:8000"

@pytest.fixture
def temp_canvas_dir(tmp_path):
    """创建临时 .canvas-learning 目录用于测试"""
    canvas_dir = tmp_path / ".canvas-learning"
    canvas_dir.mkdir()
    return canvas_dir

class TestTextbookMountE2E:
    async def test_mount_pdf_textbook(self, base_url, temp_canvas_dir):
        async with httpx.AsyncClient(base_url=base_url) as client:
            # Step 1: POST 挂载
            response = await client.post("/api/v1/textbook/mount", json={
                "canvas_id": "test-canvas",
                "textbook_path": "/path/to/textbook.pdf",
                "format": "pdf"
            })
            assert response.status_code in [200, 201]

            # Step 2: 验证文件写入
            links_file = temp_canvas_dir / ".canvas-links.json"
            assert links_file.exists()
            links = json.loads(links_file.read_text())
            assert any(t["path"].endswith(".pdf") for t in links.get("textbooks", []))

            # Step 3: GET 读回验证
            response = await client.get(f"/api/v1/textbook/list?canvas_id=test-canvas")
            assert response.status_code == 200
            data = response.json()
            assert len(data["textbooks"]) >= 1
```

### ATDD Evidence

- [ ] 红灯测试文件: `tests/e2e/test_textbook_mount_e2e.py` (新建)
- [ ] 红灯 commit hash: (待填)
- [ ] 绿灯 commit hash: (待填)

---

## 依赖关系

**前置依赖**:
- ✅ Story 34.3 (教材挂载功能已实现)
- ✅ Story 34.7 (现有 E2E 测试已创建)

**被依赖**:
- EPIC 级 TEA 追踪矩阵更新

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-10 | 0.1 | Initial draft — R4 对抗性审查 Finding #4, #9 | SM Agent (Bob) |
