# Story 19.1: sourceNodeId元数据写入

## Status
✅ Ready for Development (PO Validated 2025-12-04)

## Story

**As a** 检验白板生成系统,
**I want** 在生成检验白板时自动为每个问题节点写入sourceNodeId元数据,
**so that** 进度追踪系统可以关联检验白板节点与原白板节点，实现精确的进度追踪。

## Acceptance Criteria

1. 生成检验白板时，每个问题节点必须包含sourceNodeId字段，指向原白板对应节点ID
2. sourceNodeId必须是有效的UUID格式，与原白板节点ID完全匹配
3. 支持批量生成场景，所有问题节点都正确写入sourceNodeId
4. 检验白板JSON结构符合Obsidian Canvas规范，新增字段不破坏现有功能
5. 提供sourceNodeId验证API，可检查sourceNodeId是否有效
6. 写入操作必须是原子性的，确保数据一致性
7. 所有代码包含文档来源标注(Context7/Skill/ADR验证)

## Tasks / Subtasks

- [ ] Task 1: Canvas节点元数据扩展 (AC: 1, 2, 4)
  - [ ] 修改 `src/canvas_utils.py` 的节点创建函数
  - [ ] 添加 sourceNodeId 字段到节点数据结构
  - [ ] 确保JSON序列化正确处理新字段
  - [ ] 验证Obsidian Canvas兼容性

- [ ] Task 2: 检验白板生成器集成 (AC: 1, 3)
  - [ ] 修改 verification-question-agent 生成逻辑
  - [ ] 在生成问题节点时传入原节点ID
  - [ ] 实现批量节点的sourceNodeId映射

- [ ] Task 3: sourceNodeId验证服务 (AC: 5)
  - [ ] 创建 `src/services/source_node_validator.py`
  - [ ] 实现 `validate_source_node_id(canvas_path, source_node_id)` 方法
  - [ ] 添加批量验证API

- [ ] Task 4: 原子性写入保证 (AC: 6)
  - [ ] 使用FileLock确保并发安全
  - [ ] 实现写入事务（全成功或全回滚）
  - [ ] 添加写入失败恢复机制

- [ ] Task 5: 测试和验证 (AC: 7)
  - [ ] 创建 `tests/unit/test_source_node_id.py`
  - [ ] 创建 `tests/integration/test_review_canvas_generation.py`
  - [ ] 验证所有代码有文档来源标注

## Dev Notes

### 技术验证报告 (Step 3.6)

**验证完成时间**: 2025-12-04
**验证执行人**: SM Agent (Bob)
**Quality Gate状态**: Pending

#### 技术栈清单

| 技术栈 | 查询方式 | 验证状态 | 文档位置 |
|--------|---------|---------|----------|
| Obsidian Canvas JSON | Local PRD | 已验证 | PRD FR4 Lines 2647-2674 |
| FileLock | Context7 | 待验证 | /pypi/filelock |
| UUID | Python stdlib | 已验证 | 标准库 |

#### 核心API验证待办

**开发前必须验证**:
- [ ] Obsidian Canvas JSON格式 → PRD FR4 sourceNodeId技术方案
- [ ] FileLock acquire/release → Context7: /pypi/filelock
- [ ] canvas_utils.py create_node API → 本地代码审查

### SDD规范参考 (必填)

**数据结构规范** (from PRD FR4):
```json
// 检验白板节点结构 (PRD Lines 2651-2658)
{
  "id": "question-abc123",
  "type": "text",
  "text": "什么是逆否命题？",
  "color": "2",
  "sourceNodeId": "original-node-xyz789"  // 新增字段，指向原白板节点
}
```

**API端点规范**:
- 无新增API端点，此Story专注于Canvas文件内部元数据写入

### ADR决策关联 (必填)

| ADR编号 | 决策标题 | 对Story的影响 |
|---------|----------|---------------|
| N/A | 无直接ADR依赖 | 遵循现有Canvas JSON格式约定 |

**关键约束**:
- sourceNodeId必须是有效UUID，与原白板节点ID格式一致
- 不能破坏现有Obsidian Canvas解析功能
- 必须支持向后兼容（旧检验白板无此字段仍可正常使用）

### 架构设计参考

**架构文档引用**:
- 进度追踪算法: [Source: docs/prd/CANVAS-LEARNING-SYSTEM-OBSIDIAN-NATIVE-MIGRATION-PRD.md:2662-2674]
- sourceNodeId技术方案: [Source: docs/prd/CANVAS-LEARNING-SYSTEM-OBSIDIAN-NATIVE-MIGRATION-PRD.md:2647-2658]

**核心实现逻辑**:
```python
# 伪代码示例 (PRD参考)
def create_review_node(original_node_id: str, question_text: str) -> dict:
    """创建带sourceNodeId的检验白板问题节点"""
    return {
        "id": str(uuid.uuid4()),
        "type": "text",
        "text": question_text,
        "color": "4",  # 初始为红色(待回答)
        "sourceNodeId": original_node_id,  # 关联原白板节点
        "x": 0,
        "y": 0,
        "width": 400,
        "height": 200
    }
```

### 代码示例库

**Canvas节点创建** (基于现有canvas_utils.py扩展):
```python
# src/canvas_utils.py 扩展
# ✅ Verified from PRD FR4 (Lines 2647-2658)

def create_review_question_node(
    original_node_id: str,
    question_text: str,
    x: float = 0,
    y: float = 0
) -> dict:
    """
    创建检验白板问题节点，包含sourceNodeId元数据

    Args:
        original_node_id: 原白板节点ID (必须是有效UUID)
        question_text: 问题文本内容
        x, y: 节点位置坐标

    Returns:
        符合Obsidian Canvas规范的节点字典

    [Source: docs/prd/CANVAS-LEARNING-SYSTEM-OBSIDIAN-NATIVE-MIGRATION-PRD.md:2647-2658]
    """
    import uuid

    return {
        "id": str(uuid.uuid4()),
        "type": "text",
        "text": question_text,
        "color": "4",  # 红色 - 待回答
        "sourceNodeId": original_node_id,
        "x": x,
        "y": y,
        "width": 400,
        "height": 200
    }
```

## Dependencies

- **Epic 15**: FastAPI后端基础架构 (API接口)
- **Epic 14**: 艾宾浩斯复习系统 (检验白板生成触发)

## Estimation

**Story Points**: 3
**Estimated Time**: 2-3天

## Change Log

| 日期 | 版本 | 变更内容 | 作者 |
|------|------|----------|------|
| 2025-12-04 | Draft | SM Phase初始创建 | SM Agent (Bob) |
| 2025-12-04 | 1.0 | DEV Phase完成 (14/14 tests) | Dev Agent (James) |

## SDD规范引用

| 规范类型 | 路径 | 相关部分 |
|----------|------|----------|
| OpenAPI | specs/api/canvas-api.openapi.yml | `/canvas/verify-source-node` |
| JSON Schema | specs/data/canvas-node.schema.json | `sourceNodeId` field |

## ADR关联

- **ADR-0006**: Canvas Node Extension Pattern - 定义了扩展Canvas节点字段的标准方式
