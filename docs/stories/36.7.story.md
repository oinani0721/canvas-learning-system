# Story 36.7: Agent上下文注入增强（Neo4j数据源）

## Status

Dev Complete

## Story

**As a** Canvas学习系统的AI Agent,
**I want** 通过Neo4j查询真实的历史学习记忆并注入到上下文中,
**so that** 我能基于用户的真实学习历史提供更精准的个性化指导和评估。

## Acceptance Criteria

1. **AC1: Neo4jClient注入** - `_get_learning_memories()` 方法通过依赖注入获取 `Neo4jClient` 实例（复用EPIC-30 Story 30.2实现），禁止直接创建Neo4j连接
2. **AC2: 真实Neo4j查询** - 使用 `Neo4jClient.run_query()` 执行Cypher查询获取学习记忆，替代当前的JSON/Mock数据源
3. **AC3: Relevance排序** - 查询结果按相关度(`relevance`)降序排序，返回top 5条最相关记忆
4. **AC4: 30秒缓存** - 保持现有30秒缓存机制（`self._memory_cache`），避免重复查询Neo4j
5. **AC5: 500ms超时** - 保持现有500ms查询超时，超时时优雅降级返回空字符串
6. **AC6: Fallback机制** - 当Neo4j不可用时（`NEO4J_MOCK=true`，与Story 30.2一致），自动fallback到JSON存储

## Dependencies

- **Story 30.2** (Complete): Neo4jClient真实驱动实现 - 提供 `Neo4jClient` 类和 `run_query()` 方法
- **Epic 36 Phase 1-3** (Optional): Stories 36.1-36.6 不是硬依赖，但如果已完成可复用GraphitiClient

## Tasks / Subtasks

- [x] **Task 0: 创建Neo4jClient依赖注入函数** (Prerequisite for AC1) - ALREADY DONE in Story 36.1
  - [x] 0.1 在 `backend/app/dependencies.py` 添加 `get_neo4j_client()` 函数: **已存在于lines 608-639**
  - [x] 0.2 创建类型别名: `Neo4jClientDep = Annotated[Neo4jClient, Depends(get_neo4j_client)]` **已存在**
  - [x] 0.3 添加到 `__all__` 导出列表: `"get_neo4j_client"`, `"Neo4jClientDep"` **已存在**
  - [x] 0.4 添加单元测试: 已在Story 36.1测试中覆盖

- [x] **Task 1: 修改AgentService依赖注入** (AC1)
  - [x] 1.1 在 `agent_service.py` 构造函数添加 `neo4j_client: Optional[Neo4jClient] = None` 参数
  - [x] 1.2 更新 `backend/app/dependencies.py` 的 `get_agent_service()` 函数，注入 `Neo4jClient`
  - [x] 1.3 复用 Task 0 创建的 `get_neo4j_client()` 依赖函数

- [x] **Task 2: 实现Neo4j学习记忆查询** (AC2, AC3)
  - [x] 2.1 在 `_get_learning_memories()` 中构建Cypher查询语句
  - [x] 2.2 使用 `self._neo4j_client.run_query()` 执行查询
  - [x] 2.3 查询语句需包含 `ORDER BY relevance DESC LIMIT 5`
  - [x] 2.4 解析Neo4j返回结果，映射到现有 `LearningMemory` 数据结构

- [x] **Task 3: 保持缓存和超时机制** (AC4, AC5)
  - [x] 3.1 验证现有 `self._memory_cache` 30秒TTL缓存逻辑正确工作
  - [x] 3.2 验证 `asyncio.wait_for(..., timeout=0.5)` 超时逻辑正确工作
  - [x] 3.3 添加缓存命中率日志用于调试

- [x] **Task 4: 实现Fallback机制** (AC6)
  - [x] 4.1 检测 `NEO4J_MOCK` 环境变量状态（通过 `self._neo4j_client._use_json_fallback`）
  - [x] 4.2 当Neo4j禁用时（`NEO4J_MOCK=true`），调用现有 `self._memory_client.search_memories()` 作为fallback
  - [x] 4.3 添加日志记录fallback触发情况

- [x] **Task 5: 单元测试** (AC1-AC6)
  - [x] 5.1 测试Neo4jClient正确注入
  - [x] 5.2 测试Neo4j查询返回正确格式
  - [x] 5.3 测试relevance排序和top 5限制
  - [x] 5.4 测试30秒缓存生效
  - [x] 5.5 测试500ms超时降级
  - [x] 5.6 测试`NEO4J_MOCK=true`时fallback到JSON存储

- [x] **Task 6: 集成测试**
  - [x] 6.1 端到端测试Agent调用时包含Neo4j学习记忆
  - [x] 6.2 验证与现有ContextEnrichmentService集成正常

## Dev Notes

### SDD规范参考 (必填)

**API端点** (从OpenAPI specs):
- 端点路径: `POST /agents/{agentName}/invoke`
- 规范来源: `[Source: specs/api/agent-api.openapi.yml#L205-L263]`
- 请求Schema: `AgentInvokeRequest` (L230)
- 响应Schema: `TaskCreated` (L237)

**数据Schema** (从JSON Schema):
- 模型名称: `TemporalEvent` (学习事件记录)
- Schema来源: `[Source: specs/data/temporal-event.schema.json]`
- 必填字段: `event_id`, `session_id`, `event_type`, `timestamp` (L121)
- 可选元数据: `metadata.concept`, `metadata.score` (L78-85)

**Neo4j Cypher查询参考**:
```cypher
MATCH (m:LearningMemory)
WHERE m.canvas_name = $canvas_name
  AND m.content CONTAINS $query_text
RETURN m.concept, m.timestamp, m.relevance, m.score, m.user_understanding
ORDER BY m.relevance DESC
LIMIT 5
```

### ADR决策关联 (必填)

| ADR编号 | 决策标题 | 对Story的影响 |
|---------|----------|---------------|
| ADR-003 | Graphiti Memory Architecture | 3层架构：Temporal + Graphiti + Semantic，本Story实现Temporal层Neo4j查询 |
| ADR-007 | TieredCache Strategy | L1内存缓存用于30秒TTL，减少Neo4j查询压力 |
| ADR-010 | Structured Logging | 使用structlog记录缓存命中、查询耗时、fallback触发 |

**关键约束** (从ADR Consequences提取):
- 约束1: Neo4jClient必须通过依赖注入获取，禁止在service内直接创建连接 [Source: ADR-003]
- 约束2: 30秒缓存TTL是固定值，不可配置 [Source: ADR-007]
- 约束3: 500ms超时是硬限制，超时后返回空上下文而非抛异常 [Source: Epic 36]

### LearningMemory数据结构 (必填)

**从Neo4j查询结果映射的数据结构**:

```python
from dataclasses import dataclass
from datetime import datetime
from typing import Optional

@dataclass
class LearningMemory:
    """
    学习记忆数据结构，用于Neo4j查询结果映射。

    [Source: specs/data/temporal-event.schema.json]
    """
    concept: str              # 概念名称 (来自 m.concept)
    timestamp: datetime       # 学习时间 (来自 m.timestamp)
    relevance: float          # 相关度 0.0-1.0 (来自 m.relevance)
    score: Optional[int]      # 评分 0-100 (来自 m.score)
    user_understanding: Optional[str]  # 用户理解描述 (来自 m.user_understanding)
```

**格式化为Agent上下文的方法**:
```python
def format_memories_for_context(memories: List[LearningMemory]) -> str:
    """将学习记忆列表格式化为Agent prompt上下文。"""
    if not memories:
        return ""
    lines = ["## 历史学习记忆"]
    for m in memories:
        lines.append(f"- [{m.timestamp:%Y-%m-%d}] {m.concept}: 相关度{m.relevance:.1%}, 评分{m.score or 'N/A'}")
    return "\n".join(lines)
```

### 现有实现分析

**当前 `_get_learning_memories()` 位置**: `backend/app/services/agent_service.py:1020-1086`

**当前实现特点**:
```python
async def _get_learning_memories(
    self,
    content: str,
    canvas_name: Optional[str] = None,
    node_id: Optional[str] = None
) -> str:
    # 使用 self._memory_client.search_memories() 查询
    # 已实现30秒缓存 (self._memory_cache)
    # 已实现500ms超时 (asyncio.wait_for)
    # 返回格式化字符串用于Agent prompt
```

**需要修改的点**:
1. 添加 `self._neo4j_client` 依赖注入
2. 新增Neo4j查询路径，复用缓存/超时逻辑
3. 添加fallback条件判断

**依赖文件**:
- `backend/app/clients/neo4j_client.py` - Story 30.2已完成的Neo4jClient (968行)
- `backend/app/api/dependencies.py` - 依赖注入配置
- `backend/app/services/context_enrichment_service.py` - 上下文融合服务

### Testing

**测试文件位置**: `backend/tests/unit/test_agent_service_neo4j_memory.py`

**测试标准**:
- pytest + pytest-asyncio
- Mock Neo4jClient用于单元测试
- 真实Neo4j Docker用于集成测试

**测试框架和模式**:
- `@pytest.mark.asyncio` 装饰器用于异步测试
- `unittest.mock.AsyncMock` 用于mock Neo4jClient
- `pytest.fixture` 用于设置测试环境

**覆盖率要求**: 新增代码覆盖率 >= 80%

### Conflict Resolutions (Step 8d)

| # | Conflict | Decision | Action | Resolved By | Timestamp |
|---|----------|----------|--------|-------------|-----------|
| 1 | Story 36.7 vs dependencies.py: `get_neo4j_client()` missing | A (Expand Scope) | Add Task 0 to create dependency injection function | User | 2026-01-20 |

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-20 | 0.1 | Initial draft | SM Agent (Bob) |
| 2026-01-20 | 0.2 | **PO Validation修订**: (1) 添加Task 0创建`get_neo4j_client()`依赖注入函数; (2) 添加LearningMemory数据结构; (3) 修正AC6/Task 4.1/Task 5.6环境变量为`NEO4J_MOCK`; (4) 添加Dependencies section | Sarah (PO Agent) |

## Dev Agent Record

### Agent Model Used

Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References

- All 32 tests passed (23 unit + 9 integration)
- Test run: `pytest tests/unit/test_agent_service_neo4j_memory.py tests/integration/test_agent_neo4j_memory_integration.py -v`

### Completion Notes List

1. **Task 0 was already completed** in Story 36.1 - `get_neo4j_client_dep()` and `Neo4jClientDep` already exist in dependencies.py (lines 608-639)
2. **Task 1**: Added `neo4j_client` parameter to AgentService constructor (line 945) and updated `get_agent_service()` to inject it (line 147)
3. **Task 2-4**: Implemented complete Neo4j memory query system with:
   - `_get_learning_memories()`: Main method with cache check, Neo4j/fallback logic, and timeout handling
   - `_query_neo4j_memories()`: Cypher query builder with relevance sorting and LIMIT 5
   - `_format_learning_memories()`: Formats Neo4j results for Agent prompt context
4. **Fallback Detection**: Uses `self._neo4j_client._use_json_fallback` to detect NEO4J_MOCK mode
5. **32 Tests Cover**:
   - AC1: Neo4jClient injection (3 tests)
   - AC2: Cypher query structure (2 tests)
   - AC3: Relevance sorting (2 tests)
   - AC4: 30s cache mechanism (2 tests)
   - AC5: 500ms timeout (2 tests)
   - AC6: Fallback to JSON storage (2 tests)
   - Memory formatting (4 tests)
   - Edge cases (4 tests)
   - Dependency integration (2 tests)
   - Integration tests (9 tests)

### File List

| File | Action | Lines Changed | Description |
|------|--------|---------------|-------------|
| `backend/app/services/agent_service.py` | Modified | ~200 | Added neo4j_client param, implemented _get_learning_memories, _query_neo4j_memories, _format_learning_memories |
| `backend/app/dependencies.py` | Modified | ~20 | Added neo4j_client injection to get_agent_service() |
| `backend/tests/unit/test_agent_service_neo4j_memory.py` | Created | 358 | Unit tests for AC1-AC6 |
| `backend/tests/integration/test_agent_neo4j_memory_integration.py` | Created | 245 | Integration tests for end-to-end flow |
| `docs/stories/36.7.story.md` | Modified | - | Updated tasks and dev record |

## QA Results

### Review Date: 2026-01-31

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**Overall: Excellent** - Implementation is clean, well-documented, and follows established patterns. All 6 Acceptance Criteria are fully implemented with comprehensive test coverage. Code adheres to ADR-003 (Memory Architecture) and ADR-007 (Cache Strategy) guidelines.

### Refactoring Performed

None required - implementation quality is high with no code improvements needed.

### Compliance Check

- Coding Standards: ✓ Proper docstrings with `[Source:]` references, type hints, consistent naming
- Project Structure: ✓ Files in correct locations, proper module organization
- Testing Strategy: ✓ Comprehensive test suite with 23 unit + 9 integration tests
- All ACs Met: ✓ All 6 Acceptance Criteria verified (see detailed breakdown below)

### AC Verification Details

| AC | Description | Status | Evidence |
|----|-------------|--------|----------|
| AC1 | Neo4jClient注入 | ✅ PASS | Constructor param (L945), DI in dependencies.py (L147) |
| AC2 | 真实Neo4j查询 | ✅ PASS | `_query_neo4j_memories()` with Cypher (L1126-1186) |
| AC3 | Relevance排序 | ✅ PASS | `ORDER BY m.relevance DESC LIMIT 5` (L1166-1167) |
| AC4 | 30秒缓存 | ✅ PASS | Cache check with 30s TTL (L1069-1080) |
| AC5 | 500ms超时 | ✅ PASS | `asyncio.wait_for(..., timeout=0.5)` (L1089) |
| AC6 | Fallback机制 | ✅ PASS | `_use_json_fallback` detection (L1083), fallback to memory_client |

### Improvements Checklist

- [x] All acceptance criteria implemented correctly
- [x] Test coverage comprehensive (32 tests)
- [x] Proper error handling with graceful degradation
- [x] ADR compliance verified
- [ ] Consider migrating to TieredCache (ADR-007) for L2 persistence in future

### Security Review

**Status: PASS**
- Cypher queries use parameterized queries (`$query_text`, `$canvas_name`) - no injection risk
- Error handling returns empty string, no sensitive info leakage
- Timeout prevents DoS from slow queries

### Performance Considerations

**Status: PASS**
- 30-second cache reduces Neo4j query load
- 500ms timeout ensures UI responsiveness
- Content truncation to 100 chars prevents excessive query text
- Cache key design prevents memory bloat

### Files Modified During Review

None - no modifications required.

### Gate Status

Gate: **PASS** → docs/qa/gates/36.7-agent-neo4j-context-injection.yml

### Recommended Status

✓ **Ready for Done** - All acceptance criteria met, comprehensive testing, clean implementation.
