# Story 30.19: SubjectMapping 学科映射配置 UI
# SubjectMapping Configuration UI

**Epic**: [EPIC-30: Memory System Complete Activation](../epics/EPIC-30-MEMORY-SYSTEM-COMPLETE-ACTIVATION.md)
**Story ID**: 30.19
**Priority**: P2
**Estimated Hours**: 6
**Dependencies**: 无 (后端 group_id 学科隔离已实现，此 Story 为前端配置界面)

---

## Status

**Ready for Implementation**

---

## Story

**As a** Canvas Learning System user studying multiple subjects,
**I want** to configure custom subject mapping rules in the plugin settings,
**so that** my learning data is automatically isolated by subject based on Canvas file paths.

---

## Problem Statement (代码现实检查 2026-02-10)

### 已正确实现的部分

后端 `memory_service.py` 已实现完整的学科隔离逻辑：
- `extract_subject_from_canvas_path()` + `build_group_id()` — 自动从路径推断学科
- Neo4j MERGE 存储 group_id — 数据隔离已生效
- API 支持 `?subject=` 查询参数 — 过滤已生效

插件 settings.ts 已有基础字段：
```typescript
enableSubjectIsolation: boolean;  // 默认: false
defaultSubject: string;           // 默认: 'general'
```

### 实际存在的缺口

AC-30.8.4 要求"手动覆盖：设置面板可配置学科映射"，但：
1. **无 SubjectMapping 类型定义** — settings.ts 缺少映射规则的类型
2. **无映射规则 UI** — PluginSettingsTab 无添加/编辑/删除映射的界面
3. **无自定义规则存储** — 用户无法配置 "数学/*.canvas → 数学" 之类的规则

用户只能依赖后端自动推断，无法手动修正错误推断。

---

## 代码现实检查

| 声称的功能 | 代码位置 | 状态 |
|-----------|----------|------|
| enableSubjectIsolation | settings.ts:L313 | ✅ 存在 |
| defaultSubject | settings.ts:L314 | ✅ 存在 |
| SubjectMappingRule 类型 | - | ❌ 缺失 |
| subjectMappings 配置字段 | - | ❌ 缺失 |
| PluginSettingsTab 映射 UI | - | ❌ 缺失 |
| 后端 group_id 隔离 | memory_service.py:L413-417 | ✅ 存在 |
| 后端 subject 查询参数 | memory.py:L133,157,255 | ✅ 存在 |

---

## Acceptance Criteria

1. **AC-30.19.1**: SubjectMapping 类型定义
   - **Given** settings.ts 已有 `enableSubjectIsolation` 和 `defaultSubject`
   - **When** Story 完成
   - **Then** settings.ts 添加：
     ```typescript
     subjectMappings: SubjectMappingRule[];
     ```
     其中 `SubjectMappingRule = { pattern: string; subject: string; }`
   - **And** pattern 支持 glob 格式（如 `数学/**`、`**/离散数学*`）

2. **AC-30.19.2**: 默认映射规则
   - **Given** 用户未配置任何映射规则
   - **When** 插件加载
   - **Then** `subjectMappings` 默认为空数组 `[]`
   - **And** 后端自动推断逻辑继续生效（从 Canvas 路径第一级目录提取学科）

3. **AC-30.19.3**: 映射规则编辑 UI
   - **Given** 用户打开插件设置面板的"学科隔离"区域
   - **When** 启用 `enableSubjectIsolation`
   - **Then** 显示映射规则列表 + "添加规则"按钮
   - **And** 每条规则显示 pattern 输入框 + subject 输入框 + 删除按钮
   - **And** 规则变更实时保存到 settings

4. **AC-30.19.4**: 映射规则验证
   - **Given** 用户输入映射规则
   - **When** pattern 或 subject 为空
   - **Then** 显示红色错误提示，不保存该规则
   - **And** subject 长度限制 50 字符

5. **AC-30.19.5**: 映射规则传递到 API
   - **Given** 用户配置了映射规则 `数学/** → 数学`
   - **When** NodeColorChangeWatcher 检测到 `数学/离散数学.canvas` 的变化
   - **Then** recordLearningEvent 调用包含 `subject: "数学"` 参数
   - **And** 优先使用用户配置的映射，其次使用后端自动推断

---

## 修改文件

- `canvas-progress-tracker/obsidian-plugin/src/types/settings.ts` (添加 SubjectMappingRule 类型 + subjectMappings 字段 ~15行)
- `canvas-progress-tracker/obsidian-plugin/src/settings/PluginSettingsTab.ts` (添加映射规则 UI ~80行)
- `canvas-progress-tracker/obsidian-plugin/src/services/NodeColorChangeWatcher.ts` (读取 settings 中的映射规则 ~20行)

---

## 技术备注

### 设计决策

1. **Glob 匹配而非正则**: 用户友好度优先，`数学/**` 比 `^数学/.*` 易理解
2. **本地配置优先**: 映射规则存储在插件 settings 中（JSON），不需要后端端点
3. **后端 fallback**: 用户未配置映射 → 后端 `extract_subject_from_canvas_path()` 自动推断
4. **UI 参考**: 遵循 Obsidian 设置面板的列表编辑模式（类似 Hotkey 设置）

### glob 匹配参考

```typescript
// 简易 glob 匹配 (不依赖外部库)
function matchGlob(pattern: string, path: string): boolean {
    const regex = pattern
        .replace(/\*\*/g, '.*')
        .replace(/\*/g, '[^/]*');
    return new RegExp(`^${regex}$`).test(path);
}
```
