# Quality Gate: Story 30.8
# Generated by Quinn (Test Architect) - 2026-01-17
# Last Reviewed: 2026-02-05 (3rd deep review - overrides 2026-02-03 PASS)
# <!-- Powered by BMAD™ Core -->

schema: 1
story: "30.8"
story_title: "多学科隔离与group_id支持"
gate: CONCERNS
status_reason: >
  第3次深度审查推翻第2次PASS结论。关键发现：
  (1) Neo4j Concept节点不存储group_id，导致review-suggestions学科过滤失效 [C1]
  (2) AC-30.8.4的SubjectMapping接口完全缺失 [C2]
  (3) 端口配置三方矛盾：.env=7689, docker-compose=7688, 代码默认=7687 [H3]
  4个AC中仅AC-30.8.2完全通过。
reviewer: "Quinn (Test Architect)"
updated: "2026-02-05T10:00:00Z"

waiver: { active: false }

top_issues:
  - id: "C1-GROUP-ID-NOT-PERSISTED"
    severity: critical
    finding: >
      _create_neo4j_learning_relationship(user_id, concept, score) 不传递 group_id。
      Neo4j Concept 节点缺少 group_id 属性，导致 get_review_suggestions() 的
      WHERE c.group_id = $group_id 过滤永远匹配不到数据。
      第1次QA(2026-01-17)已标记此CONCERN，第2次QA(2026-02-03)未验证修复就给了PASS。
    suggested_action: "修改 _create_neo4j_learning_relationship() 传递 group_id，并在 create_learning_relationship Cypher 中 SET c.group_id"
    suggested_owner: dev
    file: "backend/app/services/memory_service.py:268-272"

  - id: "C2-SUBJECT-MAPPING-MISSING"
    severity: critical
    finding: >
      AC-30.8.4 要求 SubjectMapping { pattern: string; subject: string } 接口和
      subjectMappings: SubjectMapping[] 字段。settings.ts 中完全不存在。
      第2次QA声称 "Task 4 ✅ 完成" 但 SubjectMapping 接口实际不存在。
    suggested_action: "在 settings.ts 中添加 SubjectMapping 接口和 subjectMappings 字段到 PluginSettings"
    suggested_owner: dev
    file: "canvas-progress-tracker/obsidian-plugin/src/types/settings.ts"

  - id: "H1-STORY-CHECKLIST-STALE"
    severity: high
    finding: >
      Story文件中 Tasks 2.1, 2.2, 4.1, 4.2, 5.2, 6.3 仍标记 [ ] 未完成，
      但实际已有部分/完全实现。文档与代码严重不同步。
    suggested_action: "更新 Story 30.8 的 Task checklist 与实际实现状态一致"
    suggested_owner: dev

  - id: "H2-STUB-COMMENT"
    severity: high
    finding: >
      subject_config.py 文件头仍标记 "STUB: Full implementation in Story 30.x"，
      但功能已实现。
    suggested_action: "更新模块注释反映实际实现状态"
    suggested_owner: dev
    file: "backend/app/core/subject_config.py:1-11"

  - id: "H3-PORT-CONFIG-MISMATCH"
    severity: high
    finding: >
      Neo4j端口配置三方矛盾：
      backend/.env = 7689 (运行时), docker-compose.yml = 7688, 代码默认 = 7687,
      README = 7688。用户确认7689为正确端口。
    suggested_action: "统一 docker-compose.yml, README, 代码默认值到 7689"
    suggested_owner: dev

  - id: "M1-MEMORY-ONLY-QUERY"
    severity: medium
    finding: "get_learning_history() 仅查询内存列表 self._episodes，不查 Neo4j。重启后数据丢失。"
    suggested_action: "改为查询 Neo4j 持久化数据"
    suggested_owner: dev
    file: "memory_service.py:355-404"

  - id: "M2-FUZZY-MATCH"
    severity: medium
    finding: "Subject过滤使用 'in' 模糊匹配，'math' 会匹配 'mathematics'"
    suggested_action: "改用精确匹配 == 或 startswith"
    suggested_owner: dev
    file: "memory_service.py:383-387"

risk_summary:
  totals: { critical: 2, high: 3, medium: 2, low: 0 }
  recommendations:
    must_fix:
      - "[P0] 修复 _create_neo4j_learning_relationship() 传递 group_id (C1)"
      - "[P0] 实现 SubjectMapping 接口到 settings.ts (C2)"
    should_fix:
      - "[P1] 统一端口配置到 7689 (H3)"
      - "[P1] 更新 Story Task checklist (H1)"
      - "[P1] 清理 subject_config.py STUB 注释 (H2)"
    monitor:
      - "get_learning_history() 内存查询 (M1)"
      - "Subject 过滤模糊匹配 (M2)"

quality_score: 52  # 100 - (2*20) - (3*3) - 1 = 52 (2 critical, 3 high, 2 medium)
expires: "2026-03-05T00:00:00Z"

evidence:
  tests_reviewed: 48
  tests_passing: 43
  risks_identified: 7
  trace:
    ac_covered: [2]  # Only AC-30.8.2 fully passes
    ac_partial: [1, 3]  # AC-30.8.1, AC-30.8.3 partially implemented
    ac_gaps: [4]  # AC-30.8.4 SubjectMapping missing
  task_completion:
    completed: ["1.1", "1.2", "2.1", "2.2", "3.1", "3.2", "5.1", "5.2", "6.1", "6.2", "6.3"]
    incomplete: ["4.1", "4.2"]  # SubjectMapping interface missing
    needs_fix: ["3.1"]  # group_id not passed to Neo4j

nfr_validation:
  security:
    status: PASS
    notes: "Subject isolation enhances data privacy between disciplines"
  performance:
    status: PASS
    notes: "Subject filtering adds minimal query overhead"
  reliability:
    status: CONCERNS
    notes: "group_id not persisted = review suggestions filtering broken; in-memory only episodes"
  maintainability:
    status: CONCERNS
    notes: "STUB comments misleading; Story checklist stale; port config fragmented"

recommendations:
  immediate:
    - action: "[P0] Fix _create_neo4j_learning_relationship() to pass group_id"
      refs: ["backend/app/services/memory_service.py:268-272", "backend/app/clients/neo4j_client.py"]
    - action: "[P0] Implement SubjectMapping interface in settings.ts"
      refs: ["canvas-progress-tracker/obsidian-plugin/src/types/settings.ts"]
    - action: "[P1] Unify Neo4j port to 7689 across docker-compose, README, code defaults"
      refs: ["docker-compose.yml", "README.md", "backend/app/config.py:330", "backend/app/clients/neo4j_client.py:77"]
  future:
    - action: "Migrate get_learning_history() from in-memory to Neo4j query"
      refs: ["backend/app/services/memory_service.py:355-404"]

# ADR Compliance Check
adr_compliance:
  ADR-003:
    status: CONCERNS
    notes: "group_id not persisted to Neo4j Concept nodes - violates data consistency requirement"
  ADR-004:
    status: PASS
    notes: "All Graphiti/Neo4j operations are async with await"

# Files Reviewed (2026-02-05 deep review)
files_reviewed:
  - path: "backend/app/core/subject_config.py"
    status: CONCERNS
    notes: "Implementation correct but STUB comments misleading (H2)"
  - path: "backend/app/services/memory_service.py"
    status: CONCERNS
    notes: "group_id not passed to Neo4j (C1); in-memory only queries (M1); fuzzy match (M2)"
  - path: "backend/app/api/v1/endpoints/memory.py"
    status: PASS
    notes: "API layer correctly extended with subject parameter"
  - path: "backend/app/clients/neo4j_client.py"
    status: CONCERNS
    notes: "group_id filtering in queries but never SET on Concept creation"
  - path: "src/agentic_rag/clients/graphiti_temporal_client.py"
    status: PASS
    notes: "group_id support properly implemented with _build_group_id helper"
  - path: "canvas-progress-tracker/obsidian-plugin/src/types/settings.ts"
    status: CONCERNS
    notes: "Missing SubjectMapping interface and subjectMappings field (C2)"
  - path: "backend/tests/unit/test_subject_isolation.py"
    status: PASS
    notes: "Comprehensive unit tests for subject extraction and sanitization"
  - path: "backend/tests/integration/test_memory_subject_filter.py"
    status: PASS
    notes: "25 integration tests covering API subject filtering"
  - path: "backend/app/config.py"
    status: CONCERNS
    notes: "NEO4J_URI default=7687 but .env=7689 (H3)"
  - path: "backend/.env"
    status: PASS
    notes: "Correctly configured with port 7689 and warning comments"
  - path: "docker-compose.yml"
    status: CONCERNS
    notes: "Port mapping 7688:7687 conflicts with .env port 7689 (H3)"
