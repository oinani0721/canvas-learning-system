# ============================================================================
# Story 12.B.4 Quality Gate - Canvas Node Color Mapping Fix
# ============================================================================
# Generated by: Quinn (Test Architect)
# Review Type: Comprehensive (ultrathink)
# ============================================================================

schema: 1
story: '12.B.4'
story_title: 'Canvas Node Color Mapping Fix'
gate: CONCERNS
status_reason: 'Core fix implemented correctly, but 6+ test files still validate color codes incorrectly, excluding valid color "4" (red)'
reviewer: 'Quinn (Test Architect)'
updated: '2025-12-15T18:35:00+08:00'

# ============================================================================
# Story Context (No Formal Story File)
# ============================================================================
# Story 12.B.4 is an informal bugfix story implemented directly in code.
# Source documentation: docs/issues/canvas-layout-lessons-learned.md
# Implementation reference: menu.ts L57 comment
#
# Original Bug:
#   - COLOR_CODE_RED = "1" was WRONG
#   - Caused color selection errors in Canvas operations
#
# Correct Mapping (per Obsidian Canvas):
#   "1" = Gray (灰色)
#   "2" = Green (绿色 - 完全理解)
#   "3" = Purple (紫色 - 似懂非懂)
#   "4" = Red (红色 - 不理解)  ← KEY FIX
#   "5" = Blue (蓝色 - AI解释)
#   "6" = Yellow (黄色 - 个人理解)
# ============================================================================

top_issues:
  - severity: medium
    category: 'test-consistency'
    description: 'Multiple test files incorrectly mark color "4" as invalid'
    suggested_owner: dev
    refs:
      - 'src/tests/contract/test_canvas_contracts.py:325'
      - 'src/tests/unit/test_canvas_validator.py:264-270'
      - 'src/tests/contract/mock_api_server.py:296'
      - 'src/tests/contract/conftest.py:255'

  - severity: low
    category: 'documentation'
    description: 'TypeScript type comment says "1=红" which is incorrect'
    suggested_owner: dev
    refs:
      - 'canvas-progress-tracker/obsidian-plugin/src/api/types.ts:159'

  - severity: low
    category: 'documentation'
    description: 'API docs reference incorrect color mapping'
    suggested_owner: dev
    refs:
      - 'docs/architecture/canvas-progress-tracker/context-menu-api.md:140'

waiver:
  active: false

# ============================================================================
# Quality Metrics
# ============================================================================
quality_score: 70  # 100 - (0*20 FAILs) - (3*10 CONCERNS) = 70
expires: '2025-12-29T18:35:00+08:00'

evidence:
  tests_reviewed: 6
  risks_identified: 3
  implementation_files:
    - path: 'canvas-progress-tracker/obsidian-plugin/src/types/menu.ts'
      lines: '55-67'
      status: 'CORRECT'
      note: 'CANVAS_COLOR_NAMES properly maps "4" to 红色'

    - path: 'src/canvas_utils.py'
      lines: '259-274'
      status: 'CORRECT'
      note: 'COLOR_CODE_RED = "4" correctly defined'

  inconsistent_files:
    - path: 'src/tests/contract/test_canvas_contracts.py'
      line: 325
      issue: 'invalid_colors list includes "4" which is actually valid red'
      current: 'invalid_colors = ["0", "4", "7", "red", ""]'
      expected: 'invalid_colors = ["0", "7", "red", ""]'

    - path: 'src/tests/unit/test_canvas_validator.py'
      lines: '264-270'
      issue: 'valid_colors missing "4"'
      current: "valid_colors = ['1', '2', '3', '5', '6']"
      expected: "valid_colors = ['1', '2', '3', '4', '5', '6']"

    - path: 'src/tests/contract/mock_api_server.py'
      line: 296
      issue: 'valid_colors missing "4"'

    - path: 'src/tests/contract/conftest.py'
      line: 255
      issue: 'valid_colors missing "4"'

    - path: 'canvas-progress-tracker/obsidian-plugin/src/api/types.ts'
      line: 159
      issue: 'Comment says "1=红" but should be "4=红"'

    - path: 'docs/architecture/canvas-progress-tracker/context-menu-api.md'
      line: 140
      issue: 'Documentation shows "1" as red'

  trace:
    ac_covered: [1, 2]  # Color mapping fix implemented and documented
    ac_gaps: [3]  # Test synchronization incomplete

# ============================================================================
# NFR Validation
# ============================================================================
nfr_validation:
  security:
    status: PASS
    notes: 'No security implications for color code mapping'

  performance:
    status: PASS
    notes: 'Color constant lookup is O(1), no performance impact'

  reliability:
    status: CONCERNS
    notes: 'Inconsistent test validation may mask future color-related bugs'

  maintainability:
    status: CONCERNS
    notes: 'Color constants defined in multiple places without single source of truth'

# ============================================================================
# Recommendations
# ============================================================================
recommendations:
  immediate:
    - action: 'Fix test_canvas_contracts.py line 325 - remove "4" from invalid_colors'
      refs: ['src/tests/contract/test_canvas_contracts.py']
      priority: P1

    - action: 'Fix test_canvas_validator.py lines 264-270 - add "4" to valid_colors'
      refs: ['src/tests/unit/test_canvas_validator.py']
      priority: P1

    - action: 'Fix mock_api_server.py line 296 - add "4" to valid_colors'
      refs: ['src/tests/contract/mock_api_server.py']
      priority: P1

    - action: 'Fix conftest.py line 255 - add "4" to valid_colors'
      refs: ['src/tests/contract/conftest.py']
      priority: P1

  future:
    - action: 'Create centralized COLOR_CONSTANTS module imported by all files'
      refs: ['src/constants/', 'canvas-progress-tracker/obsidian-plugin/src/constants/']
      priority: P3

    - action: 'Fix TypeScript comment in types.ts line 159'
      refs: ['canvas-progress-tracker/obsidian-plugin/src/api/types.ts']
      priority: P3

    - action: 'Update context-menu-api.md documentation'
      refs: ['docs/architecture/canvas-progress-tracker/context-menu-api.md']
      priority: P3

# ============================================================================
# Summary
# ============================================================================
# Story 12.B.4 CORE FIX: PASS
#   - menu.ts CANVAS_COLOR_NAMES correctly maps colors
#   - canvas_utils.py COLOR_CODE_* constants are correct
#
# TEST SYNCHRONIZATION: CONCERNS
#   - 4 test files still treat color "4" as invalid
#   - This could cause false test failures or mask real bugs
#
# DOCUMENTATION: CONCERNS
#   - 2 documentation files have outdated color mappings
#
# GATE DECISION: CONCERNS
#   - Core implementation is correct
#   - Test and documentation inconsistencies need to be addressed
#   - No blocking issues for production, but should be fixed soon
# ============================================================================
