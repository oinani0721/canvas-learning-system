# Story 21.5.1.1 - Requirements Trace

**QA Agent**: Quinn (Test Architect) - Automated
**Review Date**: 2025-12-14
**Story**: 修复前端canvas_name参数构建

---

## Acceptance Criteria Trace

### AC 1: 创建辅助函数extractCanvasFileName

**Status**: ✅ PASS

**Evidence**:
- **File**: canvas-progress-tracker/obsidian-plugin/main.ts:1497-1515
- **Implementation**: Private method `extractCanvasFileName()` created
- **Validation**:
  - ✅ Function signature matches spec: `extractCanvasFileName(filePath: string | undefined): string`
  - ✅ Supports `/` and `\` path separators via regex `/[/\\]/`
  - ✅ Returns empty string for `undefined` or empty input
  - ✅ JSDoc documentation included
  - ✅ Correctly uses `split(/[/\\]/).pop() || ''`

**Test Evidence**:
```typescript
// Test case from tests/utils/extractCanvasFileName.test.ts
extractCanvasFileName("笔记库/子目录/test.canvas") // Returns "test.canvas" ✅
```

**Verification Method**: Unit tests + code inspection

---

### AC 2: 修改9处API调用使用该函数

**Status**: ✅ PASS

**Evidence**:
All 9 locations updated to use `this.extractCanvasFileName(context.filePath)`:

| Line | Function | Before | After | Status |
|------|----------|--------|-------|--------|
| 300 | executeDecomposition | `context.filePath \|\| ''` | `this.extractCanvasFileName(context.filePath)` | ✅ |
| 320 | executeOralExplanation | `context.filePath \|\| ''` | `this.extractCanvasFileName(context.filePath)` | ✅ |
| 340 | executeFourLevelExplanation | `context.filePath \|\| ''` | `this.extractCanvasFileName(context.filePath)` | ✅ |
| 359 | executeScoring | `context.filePath \|\| ''` | `this.extractCanvasFileName(context.filePath)` | ✅ |
| 430 | executeDeepDecomposition | `context.filePath \|\| ''` | `this.extractCanvasFileName(context.filePath)` | ✅ |
| 450 | executeClarificationPath | `context.filePath \|\| ''` | `this.extractCanvasFileName(context.filePath)` | ✅ |
| 470 | executeExampleTeaching | `context.filePath \|\| ''` | `this.extractCanvasFileName(context.filePath)` | ✅ |
| 490 | executeMemoryAnchor | `context.filePath \|\| ''` | `this.extractCanvasFileName(context.filePath)` | ✅ |
| 511 | generateVerificationQuestions | `context.filePath \|\| ''` | `this.extractCanvasFileName(context.filePath)` | ✅ |

**Verification Method**: Code inspection with line-by-line trace

---

### AC 3: 单元测试覆盖边界情况

**Status**: ✅ PASS

**Evidence**:
- **File**: canvas-progress-tracker/obsidian-plugin/tests/utils/extractCanvasFileName.test.ts
- **Test Results**: 16/16 tests passed
- **Coverage**: All 7 specified test scenarios covered

**Test Scenario Trace**:

| Scenario | Input | Expected | Test Status |
|----------|-------|----------|-------------|
| 无路径输入 | `""` | `""` | ✅ PASS |
| 纯文件名 | `"test.canvas"` | `"test.canvas"` | ✅ PASS |
| Unix路径 | `"笔记库/子目录/test.canvas"` | `"test.canvas"` | ✅ PASS |
| Windows路径 | `"笔记库\\子目录\\test.canvas"` | `"test.canvas"` | ✅ PASS |
| 深层路径 | `"a/b/c/d/e.canvas"` | `"e.canvas"` | ✅ PASS |
| undefined输入 | `undefined` | `""` | ✅ PASS |
| 混合路径分隔符 | `"a/b\\c/d.canvas"` | `"d.canvas"` | ✅ PASS (bonus) |

**Additional Edge Cases Covered** (beyond requirements):
- ✅ Filename with special characters (测试-文件_2024.canvas)
- ✅ Filename with spaces (my test file.canvas)
- ✅ Path ending with separator (edge case)
- ✅ Very long path (26-level deep)
- ✅ Backend path traversal validation (no / or \\ in result)

**Verification Method**: Automated test suite

---

## Given-When-Then Verification

### Scenario 1: User right-clicks Canvas node to invoke Agent

**Given**: User has an open Canvas file at path `"笔记库/子目录/test.canvas"`

**When**: User right-clicks a node and selects "基础拆解" (Basic Decomposition)

**Then**:
- ✅ `extractCanvasFileName()` is called with `"笔记库/子目录/test.canvas"`
- ✅ Function returns `"test.canvas"`
- ✅ API request contains `{"canvas_name": "test.canvas", "node_id": "xxx"}`
- ✅ Backend validates `canvas_name` successfully (no "/" detected)
- ✅ Agent responds with decomposition results

**Evidence**: Implementation trace from main.ts:298-301

---

### Scenario 2: Cross-platform compatibility

**Given**: User runs plugin on Windows OR Unix-like system

**When**: Canvas file path contains OS-specific separators

**Then**:
- ✅ Windows path `"C:\\Users\\笔记\\test.canvas"` → `"test.canvas"`
- ✅ Unix path `"/home/user/笔记库/test.canvas"` → `"test.canvas"`
- ✅ Result has NO path separators (safe for backend validation)

**Evidence**: Unit tests AC2.4, AC2.5, AC2.7

---

### Scenario 3: Edge case handling

**Given**: User has unusual file paths (mixed separators, special chars)

**When**: Plugin extracts filename

**Then**:
- ✅ Handles mixed separators correctly
- ✅ Preserves Chinese characters in filename
- ✅ Preserves spaces and special characters
- ✅ Returns empty string for invalid input (null safety)

**Evidence**: Unit tests AC2.6

---

## Requirements Coverage Summary

| Requirement | Implementation | Tests | Trace | Status |
|-------------|----------------|-------|-------|--------|
| AC1 - Helper function | main.ts:1497-1515 | 16 tests | ✅ | **PASS** |
| AC2 - Update 9 calls | main.ts (9 locations) | Integration | ✅ | **PASS** |
| AC3 - Unit tests | extractCanvasFileName.test.ts | 16/16 ✅ | ✅ | **PASS** |

**Overall Coverage**: 100%

**Uncovered Requirements**: None

---

## SDD Compliance Check

### JSON Schema Compliance

**Schema**: specs/data/decompose-request.schema.json

**Required Field**: `canvas_name` (type: string, description: "Canvas文件名")

**Compliance**:
- ✅ All 9 API calls now send filename-only (no path)
- ✅ Matches schema examples: `["离散数学", "线性代数"]`
- ✅ No path separators in output (verified by tests AC2.7)

**Evidence**: Implementation ensures `canvas_name` contains no "/" or "\\"

---

### OpenAPI Spec Compliance

**Endpoints**: All 9 Agent endpoints (POST /api/v1/agents/*)

**Request Body**: Requires `canvas_name` as filename

**Compliance**:
- ✅ executeDecomposition → POST /api/v1/agents/decompose
- ✅ executeOralExplanation → POST /api/v1/agents/explain/oral
- ✅ executeFourLevelExplanation → POST /api/v1/agents/explain/four-level
- ✅ executeClarificationPath → POST /api/v1/agents/explain/clarification
- ✅ executeScoring → POST /api/v1/agents/score
- ✅ executeDeepDecomposition → POST /api/v1/agents/decompose (deep)
- ✅ executeExampleTeaching → POST /api/v1/agents/example-teaching
- ✅ executeMemoryAnchor → POST /api/v1/agents/memory-anchor
- ✅ generateVerificationQuestions → POST /api/v1/agents/verification-question

**Evidence**: All API calls use `this.extractCanvasFileName()` to format `canvas_name`

---

## Backend Validation Compatibility

**Backend Check**: `_validate_canvas_name()` in backend rejects paths with "/" or "\\"

**Frontend Fix**: `extractCanvasFileName()` removes all path components

**Validation**:
- ✅ Test AC2.7: Verifies result has no path separators
- ✅ Test case: `"笔记库/子目录/test.canvas"` → `"test.canvas"` (no "/" in result)
- ✅ Backend will accept the modified parameter

**Evidence**: Unit tests explicitly check `result.split(/[/\\]/).length === 1`

---

## Conclusion

**Requirements Coverage**: ✅ **100% (3/3 ACs PASS)**

**SDD Compliance**: ✅ **PASS**

**Test Coverage**: ✅ **16/16 tests passed**

**Backend Compatibility**: ✅ **PASS**

**Recommendation**: **READY FOR QUALITY GATE**
