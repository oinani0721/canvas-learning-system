# Risk Profile: Story 12.H.4 - Frontend Request Cancel Support

**Date**: 2025-12-17
**Reviewer**: Quinn (Test Architect)
**Analysis Mode**: UltraThink (Deep Analysis)

---

## Executive Summary

| Metric | Value |
|--------|-------|
| **Total Risks Identified** | 9 |
| **Critical Risks** | 0 |
| **High Risks** | 2 |
| **Medium Risks** | 4 |
| **Low Risks** | 3 |
| **Risk Score** | 68/100 (Moderate) |

**Overall Assessment**: This story implements a well-designed AbortController-based request cancellation system. The primary risks center around **race conditions** in cancel/complete timing, **missing unit tests**, and **state consistency** across multiple tracking structures. No critical risks identified, but high-priority items require attention before production.

---

## Risk Matrix

| Risk ID | Description | Probability | Impact | Score | Priority |
|---------|-------------|-------------|--------|-------|----------|
| TECH-001 | Race condition in cancel vs complete timing | Medium (2) | High (3) | **6** | High |
| TECH-002 | Dual AbortController state management inconsistency | Medium (2) | High (3) | **6** | High |
| TECH-003 | Map memory leak on failed cleanup | Low (1) | Medium (2) | 2 | Low |
| OPS-001 | No automated unit tests for AbortController logic | High (3) | Medium (2) | **6** | High* |
| OPS-002 | Manual testing not yet completed (Task 5) | Medium (2) | Medium (2) | 4 | Medium |
| PERF-001 | Timeout race with user cancel | Low (1) | Medium (2) | 2 | Low |
| DATA-001 | Partial state on cancel during Canvas write | Low (1) | High (3) | 3 | Low |
| SEC-001 | No rate limiting on cancel operations | Low (1) | Low (1) | 1 | Minimal |
| BUS-001 | User confusion on cancel vs timeout messages | Medium (2) | Low (1) | 2 | Low |

*Note: OPS-001 marked High priority due to Story Definition of Done requirement for testing

---

## Critical Risks Requiring Immediate Attention

### None Identified

No score-9 critical risks were found. The implementation follows established patterns from ADR-009.

---

## High Risks (Score 6)

### 1. [TECH-001]: Race Condition in Cancel vs Complete Timing

**Score: 6 (High)**

**Probability**: Medium - Race conditions are inherently timing-dependent. In normal usage, requests complete in 10-30 seconds. Cancel button is user-triggered, creating a window for race.

**Impact**: High - If cancel fires just as response arrives, user may see inconsistent state (cancel notice + successful node creation, or neither).

**Affected Components**:
- `ApiClient.callAgentWithCancel()` (lines 713-778)
- `main.ts:cancelTask()` (lines 2398-2419)
- All 11 Agent handlers

**Detection Method**: Code review revealed the `abortControllers.delete()` in `finally` block (line 778) runs regardless of cancel state, potentially conflicting with `cancelRequest()` delete (line 798).

**Mitigation**:
```yaml
strategy: preventive
actions:
  - Add a 'cancelled' flag to track user-initiated cancels explicitly
  - Consider using WeakMap or adding timestamps for stale detection
  - Document the "delete first, then abort" pattern more clearly
testing_requirements:
  - Concurrent cancel + response arrival test
  - Stress test with rapid cancel/retry cycles
residual_risk: Low - Pattern is sound, edge cases need explicit handling
owner: dev
timeline: Before manual testing (Task 5)
```

---

### 2. [TECH-002]: Dual AbortController State Management Inconsistency

**Score: 6 (High)**

**Probability**: Medium - The code maintains AbortControllers in two places:
1. `ApiClient.abortControllers` Map (line 116)
2. `PendingRequest.abortController` in `taskRegistry` (main.ts line 191)

**Impact**: High - Cancellation may only trigger one, leaving the other in inconsistent state.

**Evidence from Code**:
```typescript
// main.ts:2401-2415 - Attempts to cancel BOTH
if (this.apiClient) {
    const cancelled = this.apiClient.cancelRequest(lockKey);  // Method 1
}
if (task.abortController) {
    task.abortController.abort();  // Method 2
}
```

**Affected Components**:
- `ApiClient.abortControllers` (ApiClient.ts:116)
- `taskRegistry` with `PendingRequest` (main.ts:191)
- `cancelTask()` (main.ts:2398)

**Mitigation**:
```yaml
strategy: corrective
actions:
  - Single Source of Truth: Remove PendingRequest.abortController, rely solely on ApiClient
  - Alternative: Ensure both are ALWAYS the same AbortController instance
  - Add invariant check in debug mode
testing_requirements:
  - Verify cancel triggers only ONE abort (not double-abort)
  - Test that UI updates correctly regardless of which cancel path fires
residual_risk: Medium - Current dual-cancel works but is fragile
owner: dev
timeline: P1 - Fix in follow-up story
```

---

### 3. [OPS-001]: No Automated Unit Tests for AbortController Logic

**Score: 6 (High)**
*Elevated priority due to Definition of Done requirement*

**Probability**: High - Glob search confirmed NO test files exist in `obsidian-plugin/src/`:
```
Glob: canvas-progress-tracker/obsidian-plugin/src/**/*.test.ts
Result: No files found
```

**Impact**: Medium - Without tests, regressions in cancel logic may go undetected. The story specifies automated tests in `Testing` section (lines 387-440).

**Affected Components**:
- `ApiClient.callAgentWithCancel()` - untested
- `ApiClient.cancelRequest()` - untested
- `ApiClient.cancelAllRequests()` - untested
- `ApiClient.isRequestPending()` - untested
- `ApiClient.getPendingRequests()` - untested

**Mitigation**:
```yaml
strategy: corrective
actions:
  - Create test file: src/api/__tests__/ApiClient.test.ts (as specified in story)
  - Implement 4 test cases from story lines 391-440
  - Mock fetch API with jest.fn() or vitest.mock()
testing_requirements:
  - AC3 cancel test
  - AC1/AC2 pending tracking test
  - Cancel all requests test
  - Cancel non-existent request test
residual_risk: Low - Story includes test specification
owner: dev
timeline: Before Definition of Done sign-off
```

---

## Medium Risks (Score 4)

### 4. [OPS-002]: Manual Testing Not Yet Completed

**Score: 4 (Medium)**

**Probability**: Medium - Task 5 (manual testing) shows all 4 subtasks unchecked.

**Impact**: Medium - Real-world issues like UI glitches, timing problems, or edge cases remain unverified.

**Mitigation**:
```yaml
strategy: detective
actions:
  - Execute all 4 manual test scenarios from story (lines 380-386)
  - Document results in story file
  - Record any issues found for follow-up
residual_risk: Low - After testing completion
```

---

## Low Risks (Score 2-3)

### 5. [TECH-003]: Map Memory Leak on Failed Cleanup

**Score: 2 (Low)**

**Probability**: Low - The `finally` block cleanup is robust.

**Impact**: Medium - Accumulated AbortControllers could consume memory over long sessions.

**Evidence**: `abortControllers.delete(lockKey)` in finally (line 778) should always run, but JavaScript error edge cases exist.

**Mitigation**: Add periodic cleanup in plugin `onunload()` via `cancelAllRequests()`.

---

### 6. [PERF-001]: Timeout Race with User Cancel

**Score: 2 (Low)**

**Probability**: Low - Timeout (60s) is much longer than typical user patience.

**Impact**: Medium - User cancels at t=59s, timeout fires at t=60s, both could trigger.

**Mitigation**: Current implementation handles this via single AbortController (abort is idempotent).

---

### 7. [DATA-001]: Partial State on Cancel During Canvas Write

**Score: 3 (Low)**

**Probability**: Low - Window between null check and `createNewNode()` is minimal.

**Impact**: High - Orphaned nodes or partial writes.

**Evidence** (main.ts Agent handler pattern):
```typescript
if (response === null) {
    return;  // AC5: Cancel check
}
if (response.success) {
    await this.createNewNode(...);  // No cancel check during write
}
```

**Mitigation**: The atomic nature of `createNewNode()` makes partial writes unlikely. Consider adding `isCancelled` check inside.

---

### 8. [SEC-001]: No Rate Limiting on Cancel Operations

**Score: 1 (Minimal)**

**Probability**: Low - This is a local plugin, not a server.

**Impact**: Low - Rapid cancel spam is self-limiting (nothing to cancel if requests are cancelled).

**Mitigation**: None required for local plugin context.

---

### 9. [BUS-001]: User Confusion on Cancel vs Timeout Messages

**Score: 2 (Low)**

**Probability**: Medium - Two different abort scenarios, same underlying mechanism.

**Impact**: Low - User sees "请求已取消" vs "请求超时 (60秒)".

**Evidence** (ApiClient.ts:767-770):
```typescript
userCancelled = !this.abortControllers.has(lockKey);
console.log(`Request "${lockKey}" was ${userCancelled ? 'cancelled by user' : 'timed out'}`);
```

**Mitigation**: Current implementation correctly distinguishes via "delete first, then abort" pattern. Consider user-facing message enhancement in future.

---

## Risk Distribution

### By Category

| Category | Count | High | Medium | Low |
|----------|-------|------|--------|-----|
| Technical (TECH) | 3 | 2 | 0 | 1 |
| Operational (OPS) | 2 | 1 | 1 | 0 |
| Performance (PERF) | 1 | 0 | 0 | 1 |
| Data (DATA) | 1 | 0 | 0 | 1 |
| Security (SEC) | 1 | 0 | 0 | 1 |
| Business (BUS) | 1 | 0 | 0 | 1 |

### By Component

| Component | Risk Count |
|-----------|------------|
| ApiClient.ts | 5 |
| main.ts | 4 |
| Agent Handlers (11) | 2 |
| Test Infrastructure | 1 |

---

## Risk-Based Testing Strategy

### Priority 1: High Risk Tests (MUST before production)

| Test | Risk Coverage | Type |
|------|---------------|------|
| Cancel during active request | TECH-001 | Manual + Unit |
| Verify single AbortController triggers | TECH-002 | Unit |
| Implement ApiClient unit test suite | OPS-001 | Automated |
| Cancel + immediate re-request | TECH-001 | Manual |

### Priority 2: Medium Risk Tests

| Test | Risk Coverage | Type |
|------|---------------|------|
| Execute all 4 manual test cases | OPS-002 | Manual |
| Stress test with 10+ concurrent requests | TECH-001 | Manual |

### Priority 3: Low Risk Tests

| Test | Risk Coverage | Type |
|------|---------------|------|
| Long session memory usage | TECH-003 | Manual observation |
| Plugin unload cleans all requests | TECH-003 | Manual |

---

## Risk Acceptance Criteria

### Must Fix Before Production

1. **OPS-001**: Create automated unit tests (Definition of Done requirement)
2. **OPS-002**: Complete manual testing verification

### Can Deploy with Mitigation

1. **TECH-001**: Document race condition edge case, add TODO for explicit cancel flag
2. **TECH-002**: Document dual-controller pattern, create follow-up story to consolidate

### Accepted Risks

| Risk | Reason | Sign-off |
|------|--------|----------|
| TECH-003 | `finally` block provides adequate cleanup | Dev |
| PERF-001 | Idempotent abort handles naturally | Dev |
| SEC-001 | Local plugin, no network exposure | QA |
| BUS-001 | Current messages are adequate | PO |

---

## Monitoring Requirements

Post-deployment monitoring for:

1. **Console Logs**: Watch for `[Story 12.H.4]` tagged messages indicating cancel operations
2. **Error Rates**: Track `AbortError` frequency in ErrorHistoryManager
3. **User Feedback**: Monitor for "cancel didn't work" reports

---

## ADR Compliance Check

| ADR | Requirement | Status |
|-----|-------------|--------|
| ADR-009 | User cancel should not trigger retry | **COMPLIANT** - Returns null, no retry |
| ADR-009 | Clear user feedback (Notice) | **COMPLIANT** - `new Notice('已取消: ...')` |
| ADR-009 | Cancel not logged as error | **COMPLIANT** - `console.log`, not `console.error` |

---

## Gate YAML Block

```yaml
# risk_summary (paste into gate file):
risk_summary:
  totals:
    critical: 0
    high: 3
    medium: 1
    low: 5
  highest:
    id: TECH-001
    score: 6
    title: 'Race condition in cancel vs complete timing'
  recommendations:
    must_fix:
      - 'Create automated unit tests for ApiClient AbortController methods (OPS-001)'
      - 'Complete manual testing verification Task 5 (OPS-002)'
    monitor:
      - 'Console logs for [Story 12.H.4] cancel operations'
      - 'User reports of cancel failures'
```

---

## Risk Review Triggers

Review and update this risk profile when:

- [ ] Unit tests are implemented
- [ ] Manual testing reveals new issues
- [ ] Dual AbortController pattern is refactored
- [ ] Additional Agent handlers are added
- [ ] Timeout configuration changes

---

**Risk Profile Location**: `docs/qa/assessments/12.H.4-risk-20251217.md`
