# Risk Profile: Story 12.K.3 - Agent Menu-Endpoint Completeness Verification

**Date**: 2025-12-17
**Reviewer**: Quinn (Test Architect)
**Story ID**: 12.K.3
**Epic**: 12.K - NodeRead Schema and Agent Functionality Fix

---

## Executive Summary

- **Total Risks Identified**: 11
- **Critical Risks**: 1
- **High Risks**: 2
- **Medium Risks**: 4
- **Low Risks**: 4
- **Overall Risk Score**: 71/100 (Moderate Risk)

---

## Component Verification Matrix

### 12 Agent End-to-End Mapping Audit

| # | Agent | Menu Key (ContextMenuManager.ts) | API Method (ApiClient.ts) | Backend Endpoint (agents.py) | Status |
|---|-------|----------------------------------|---------------------------|------------------------------|--------|
| 1 | Basic Decomposition | `executeDecomposition` | `decomposeBasic()` | `POST /agents/decompose/basic` | VERIFIED |
| 2 | Deep Decomposition | `executeDeepDecomposition` | `decomposeDeep()` | `POST /agents/decompose/deep` | VERIFIED |
| 3 | Question Decomposition | `decomposeQuestion` | `decomposeQuestion()` | `POST /agents/decompose/question` | VERIFIED |
| 4 | Oral Explanation | `executeOralExplanation` | `explainOral()` | `POST /agents/explain/oral` | VERIFIED |
| 5 | Clarification Path | `executeClarificationPath` | `explainClarification()` | `POST /agents/explain/clarification` | VERIFIED |
| 6 | Comparison Table | `executeComparisonTable` / `generateComparisonTable` | `explainComparison()` | `POST /agents/explain/comparison` | VERIFIED |
| 7 | Memory Anchor | `executeMemoryAnchor` | `explainMemory()` | `POST /agents/explain/memory` | VERIFIED |
| 8 | Four-Level Explanation | `executeFourLevelExplanation` | `explainFourLevel()` | `POST /agents/explain/four-level` | VERIFIED |
| 9 | Example Teaching | `executeExampleTeaching` | `explainExample()` | `POST /agents/explain/example` | VERIFIED |
| 10 | Scoring | `executeScoring` | `scoreUnderstanding()` | `POST /agents/score` | VERIFIED |
| 11 | Verification Questions | `generateVerificationQuestions` | `generateVerificationQuestions()` | `POST /agents/verification/question` | VERIFIED |
| 12 | Verification Canvas | `generateVerificationCanvas` | N/A (Canvas operation) | N/A (Client-side) | VERIFIED |

**Verification Result**: All 12 Agents have complete end-to-end wiring.

---

## Critical Risks Requiring Immediate Attention

### 1. [TECH-001]: Duplicate Menu Callback Registration for Comparison Table

**Score: 9 (Critical)**

**Probability**: High (3) - Code clearly shows two distinct menu keys for same functionality
**Impact**: High (3) - Users may trigger inconsistent behavior between menu items

**Evidence** (ContextMenuManager.ts):
- Line 69-72: `executeComparisonTable` (Story 12.F.2)
- Line 67-68: `generateComparisonTable` (legacy)

Both callbacks exist but may not be synchronized, risking:
- Inconsistent API calls
- Confusion in action registry
- Potential race conditions if both triggered

**Mitigation**:
- **Immediate**: Audit which callback is actually wired in `setActionRegistry()`
- **Preventive**: Deprecate `generateComparisonTable` or unify under single key
- **Detective**: Add logging to track which callback fires

**Testing Focus**:
- Manual test both "Generate Comparison Table" menu triggers
- Verify same API endpoint called
- Check action registry for duplicates

---

## High Risks

### 2. [TECH-002]: RAG Timeout Graceful Degradation May Mask Issues

**Score: 6 (High)**

**Probability**: Medium (2) - RAG timeouts documented at 2s threshold
**Impact**: High (3) - Users receive incomplete context silently

**Evidence** (agents.py:523-584):
```python
RAG_TIMEOUT_SECONDS = 2.0  # AC4: RAG delay < 2s
# On timeout: returns None, agent continues without RAG context
```

Silent degradation means:
- Users don't know AI response lacks relevant context
- Debugging difficult when responses seem "off"
- No visibility into RAG service health during normal use

**Mitigation**:
- Add UI indicator when RAG context unavailable
- Log RAG degradation rate for monitoring
- Consider returning metadata indicating context richness

**Testing Focus**:
- Simulate RAG timeouts
- Verify agent still produces valid output
- Check logs for degradation warnings

---

### 3. [OPS-001]: Request Deduplication Cache Without TTL Cleanup

**Score: 6 (High)**

**Probability**: Medium (2) - Long-running sessions accumulate stale entries
**Impact**: High (3) - Memory leak, potential 409 false positives

**Evidence** (agents.py:593-674):
- `check_duplicate_request()` marks in-progress
- `complete_request()` / `cancel_request()` cleanup paths exist
- BUT: No TTL-based automatic cleanup for orphaned entries

If agent crashes mid-execution:
- Cache entry remains "in-progress" forever
- User cannot retry same node/agent combination
- Only backend restart clears state

**Mitigation**:
- Implement TTL-based cache cleanup (suggest 5 minutes)
- Add background task to prune stale entries
- Consider Redis with TTL for production

**Testing Focus**:
- Simulate agent crash scenarios
- Verify retry behavior after failures
- Test cache state after timeout

---

## Medium Risks

### 4. [PERF-001]: 60s Timeout Too Long for Poor UX

**Score: 4 (Medium)**

**Probability**: Medium (2) - Complex prompts may approach timeout
**Impact**: Medium (2) - User waits excessively, perceives system as slow

**Evidence** (ApiClient.ts:66):
```typescript
const DEFAULT_TIMEOUT = 60000; // 60 seconds (Story 12.F.6)
```

**Mitigation**:
- Show progress indicator with estimated time (`ESTIMATED_TIME` already defined)
- Consider streaming responses for long operations
- Implement progressive timeout (30s warning, 60s cancel)

---

### 5. [TECH-003]: File Node Content Reading Async Race Condition

**Score: 4 (Medium)**

**Probability**: Medium (2) - FILE nodes require vault read
**Impact**: Medium (2) - Content may be stale or empty

**Evidence** (ContextMenuManager.ts:911-943):
```typescript
// FILE type: Read linked MD file content
nodeContent = await this.app.vault.cachedRead(abstractFile);
```

Using `cachedRead` means:
- May not reflect latest edits
- Race condition if file being edited
- No retry on read failure

**Mitigation**:
- Add retry logic for read failures
- Consider debounce on file changes
- Log content hash for debugging

---

### 6. [DATA-001]: Node Content Truncation in Learning Events

**Score: 4 (Medium)**

**Probability**: Low (1) - Only affects very long content
**Impact**: High (3) - Incomplete learning history

**Evidence** (agents.py:389):
```python
concept=enriched.target_content[:100]  # Truncated to 100 chars
```

**Mitigation**:
- Store full concept in separate field
- Use hash for deduplication, full text for display
- Document truncation behavior

---

### 7. [SEC-001]: Debug Information Leakage in Production

**Score: 4 (Medium)**

**Probability**: Low (1) - Requires DEBUG_AGENT_RESPONSE=true
**Impact**: High (3) - Internal details exposed

**Evidence** (agent_service.py:496-500):
```python
if settings.DEBUG_AGENT_RESPONSE and details:
    # AC5: Safe handling - don't expose sensitive info
    safe_details = {k: v for k, v in details.items()
                   if not any(sensitive in k.lower()
```

**Mitigation**:
- Ensure DEBUG_AGENT_RESPONSE defaults to False in production
- Add config validation at startup
- Audit `safe_details` filter for completeness

---

## Low Risks

### 8. [TECH-004]: Menu Item Priority Ordering May Cause UI Inconsistency

**Score: 3 (Low)**

**Probability**: Low (1) - Priorities set explicitly
**Impact**: Low (1) - Cosmetic issue only

Different priority values across agents (100, 95, 90, 85...) create specific ordering. Changes to priorities could unexpectedly reorder menu.

**Mitigation**: Document priority scheme in code comments.

---

### 9. [OPS-002]: Health Check Cache May Return Stale Status

**Score: 3 (Low)**

**Probability**: Low (1) - 60s TTL is reasonable
**Impact**: Medium (2) - May miss transient failures

**Evidence** (agents.py:244):
```python
HEALTH_CHECK_CACHE_TTL: int = 60  # seconds
```

**Mitigation**: Add `cached=True` indicator (already implemented) to inform users.

---

### 10. [BUS-001]: No Rate Limiting on Individual Agent Calls

**Score: 2 (Low)**

**Probability**: Low (1) - Most users won't abuse
**Impact**: Medium (2) - API quota exhaustion possible

**Mitigation**: Implement per-user rate limiting at API gateway level.

---

### 11. [TECH-005]: AbortController Map Not Bounded

**Score: 2 (Low)**

**Probability**: Low (1) - Cleanup exists
**Impact**: Low (1) - Minor memory overhead

**Evidence** (ApiClient.ts:116):
```typescript
private abortControllers: Map<string, AbortController> = new Map();
```

**Mitigation**: Add max size check, prune oldest entries if exceeded.

---

## Risk Distribution

### By Category
| Category | Total Risks | Critical | High | Medium | Low |
|----------|-------------|----------|------|--------|-----|
| TECH | 5 | 1 | 0 | 2 | 2 |
| SEC | 1 | 0 | 0 | 1 | 0 |
| PERF | 1 | 0 | 0 | 1 | 0 |
| DATA | 1 | 0 | 0 | 1 | 0 |
| BUS | 1 | 0 | 0 | 0 | 1 |
| OPS | 2 | 0 | 2 | 0 | 0 |

### By Component
| Component | Risks |
|-----------|-------|
| Frontend (ContextMenuManager.ts) | 3 |
| Frontend (ApiClient.ts) | 2 |
| Backend (agents.py) | 4 |
| Backend (agent_service.py) | 2 |

---

## Risk-Based Testing Strategy

### Priority 1: Critical Risk Tests
- [ ] Test both comparison table menu items produce identical behavior
- [ ] Verify action registry contains no duplicate/conflicting callbacks
- [ ] Integration test: trigger both menu keys, compare API calls

### Priority 2: High Risk Tests
- [ ] Simulate RAG service timeout (>2s)
- [ ] Verify agent response quality without RAG context
- [ ] Test request deduplication after simulated crash
- [ ] Verify cache cleanup on error paths

### Priority 3: Medium/Low Risk Tests
- [ ] Long-running agent timeout behavior (45-60s)
- [ ] FILE node content reading with concurrent edits
- [ ] Learning event recording with long content
- [ ] Debug mode config validation

---

## Risk Acceptance Criteria

### Must Fix Before Production
- [x] TECH-001: Audit comparison table callbacks (Critical)
- [ ] OPS-001: Add TTL cleanup for request cache (High)

### Can Deploy with Mitigation
- RAG timeout degradation (monitoring in place)
- 60s timeout (progress indicator exists)

### Accepted Risks
- Menu priority ordering (cosmetic)
- Health check caching (indicator present)
- AbortController map size (cleanup exists)

---

## Monitoring Requirements

Post-deployment monitoring for:
- **PERF**: Agent response time P95 < 30s
- **OPS**: Request cache size, orphaned entry count
- **TECH**: RAG degradation rate (target: <5%)
- **BUS**: API error rate by agent type

---

## Gate Decision Recommendation

Based on this risk profile:

| Gate Status | Rationale |
|-------------|-----------|
| **CONCERNS** | 1 Critical risk (TECH-001) requires immediate audit. Story is marked complete but duplicate callback issue needs verification before full production deployment. High risks (OPS-001, TECH-002) have mitigations in progress. |

**Recommendation**: Verify TECH-001 callback wiring, then PASS.

---

## Risk Profile Hook

```text
Risk profile: docs/qa/assessments/12.K.3-risk-20251217.md
```

---

## Change Log

| Date | Version | Changes |
|------|---------|---------|
| 2025-12-17 | 1.0 | Initial risk profile based on UltraThink deep analysis |
