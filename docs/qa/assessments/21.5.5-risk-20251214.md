# Risk Profile Assessment: Story 21.5.5

**Story**: 21.5.5 - æ’ä»¶é”™è¯¯æ˜¾ç¤ºå¢å¼º (Plugin Error Display Enhancement)
**Epic**: 21.5 - Agentç«¯ç‚¹å¯é æ€§ä¿®å¤
**Date**: 2025-12-14
**Assessor**: Quinn (QA Agent)
**Mode**: UltraThink (Deep Analysis)

---

## Executive Summary

Story 21.5.5 presents a **MEDIUM RISK** profile with an overall score of 4.0/9. The primary finding is that **most implementation already exists** in the codebase, significantly reducing technical risk. However, there are concerns around dependency status and integration completeness.

**Key Finding**: Implementation files `ErrorNotificationService.ts` (325 lines) and `ErrorHistoryManager.ts` (366 lines) are already complete and match the story's technical requirements.

---

## 1. Risk Matrix

| ID | Category | Risk Title | P | I | Score | Priority |
|----|----------|------------|---|---|-------|----------|
| R1 | TECH | Dependency on unimplemented Stories | 3 | 3 | **9** | ğŸ”´ HIGH |
| R2 | TECH | Integration gaps in main.ts | 2 | 2 | **4** | ğŸŸ¡ MEDIUM |
| R7 | BUS | Existing implementation AC mismatch | 2 | 2 | **4** | ğŸŸ¡ MEDIUM |
| R3 | DATA | Error history persistence corruption | 1 | 2 | 2 | ğŸŸ¢ LOW |
| R5 | SEC | Bug ID information leakage | 1 | 2 | 2 | ğŸŸ¢ LOW |
| R6 | OPS | CSS styling conflicts | 2 | 1 | 2 | ğŸŸ¢ LOW |
| R4 | PERF | Notice DOM performance | 1 | 1 | 1 | ğŸŸ¢ LOW |

**Scoring**: Probability (1-3) Ã— Impact (1-3) = Score (1-9)
- ğŸ”´ HIGH: 6-9, ğŸŸ¡ MEDIUM: 3-5, ğŸŸ¢ LOW: 1-2

---

## 2. Detailed Risk Analysis

### R1: Dependency on Unimplemented Stories 21.5.1-21.5.4 ğŸ”´ HIGH

**Category**: Technical (TECH)
**Score**: 9 (P=3 Ã— I=3)

**Description**:
Story 21.5.5 explicitly depends on:
- **21.5.1**: CORSå¤´ä¿®å¤ - Backend sends CORS headers on 500 responses
- **21.5.3**: Bugè¿½è¸ªæ—¥å¿—ç³»ç»Ÿ - Backend generates `bug_id` (BUG-XXXXXXXX format)
- **21.5.4**: ç»Ÿä¸€é”™è¯¯å“åº”æ ¼å¼ - Backend returns `error_type` field

Without these dependencies, the plugin receives empty `bug_id` and `error_type` fields, making AC1 and AC2 impossible to verify.

**Evidence**:
```typescript
// From ErrorNotificationService.ts:223-249
if (error.bugId) {  // Will never be true if 21.5.3 not implemented
  fragment.createEl('br');
  const bugContainer = fragment.createEl('span', {...});
  // ... bug_id display logic
}
```

**Mitigation Strategy**:
1. **Immediate**: Check backend `/api/v1/agents/*` responses for `bug_id` field
2. **Design**: Implement graceful degradation when `bug_id` is undefined
3. **Test**: Mock backend responses for integration testing

**Verification Checkpoint**:
```bash
# Test backend error response format
curl -X POST http://localhost:8000/api/v1/agents/decompose_basic \
  -H "Content-Type: application/json" \
  -d '{"invalid": "data"}' | jq '.bug_id, .error_type'
```

---

### R2: Integration Gaps in main.ts Error Handlers ğŸŸ¡ MEDIUM

**Category**: Technical (TECH)
**Score**: 4 (P=2 Ã— I=2)

**Description**:
`ErrorNotificationService` and `ErrorHistoryManager` classes exist and are fully implemented, but they may not be connected to the actual error handling flow in `main.ts`. The plugin's catch blocks might still use basic `new Notice()` calls instead of the new services.

**Evidence Needed**:
- Audit `main.ts` for all `catch (error)` blocks
- Verify `this.errorHistoryManager.addError()` is called
- Verify `this.errorNotificationService.showAgentError()` replaces `new Notice()`

**Mitigation Strategy**:
1. Create traceability matrix: API call â†’ catch block â†’ service call
2. Add integration tests that verify error flow
3. Standardize error handling pattern across all agent calls

---

### R7: Existing Implementation AC Mismatch ğŸŸ¡ MEDIUM

**Category**: Business (BUS)
**Score**: 4 (P=2 Ã— I=2)

**Description**:
Code exists but may not exactly match the 5 Acceptance Criteria. The implementation was likely created before the story was formally drafted, so there could be subtle differences.

**AC Verification Status**:

| AC | Description | Implementation | Status |
|----|-------------|----------------|--------|
| AC1 | bug_idæ˜¾ç¤º | ErrorNotificationService.ts:223-249 | âš ï¸ NEEDS VERIFY |
| AC2 | é”™è¯¯ç±»å‹æ ·å¼ | ErrorNotificationService.ts:175-183 | âš ï¸ NEEDS VERIFY |
| AC3 | é‡è¯•æŒ‰é’® | ErrorNotificationService.ts:254-306 | âš ï¸ NEEDS VERIFY |
| AC4 | è®¾ç½®é¢æ¿å†å² | ErrorHistoryManager.ts + PluginSettingsTab.ts | âš ï¸ NEEDS VERIFY |
| AC5 | 7å¤©è‡ªåŠ¨æ¸…ç† | ErrorHistoryManager.ts:264-279 | âœ… VERIFIED |

**AC5 Verification Evidence**:
```typescript
// From ErrorHistoryManager.ts:264-279
async cleanup(): Promise<number> {
  const expiryTime = Date.now() - EXPIRY_DAYS * MS_PER_DAY;  // EXPIRY_DAYS = 7
  this.records = this.records.filter((r) => r.timestamp > expiryTime);
  // ...
}
```

**Mitigation Strategy**:
1. Create test case per AC
2. Manual verification in Obsidian
3. Update implementation if gaps found

---

### R3-R6: Low Risk Items ğŸŸ¢ LOW

| Risk | Mitigation | Status |
|------|------------|--------|
| R3: Data Corruption | Debouncing via `isSaving` flag already implemented | âœ… Mitigated |
| R4: DOM Performance | Error notifications are infrequent; simple DOM | âœ… Acceptable |
| R5: Bug ID Leakage | Local-only; by design for support purposes | âœ… Acceptable |
| R6: CSS Conflicts | Use namespaced classes; test popular themes | âš ï¸ Minor |

---

## 3. Implementation Status Analysis

### Files Already Implemented

| File | Lines | Status | Notes |
|------|-------|--------|-------|
| `src/api/types.ts` | 32-108 | âœ… Complete | ApiError with bugId, backendErrorType, isRetryable |
| `src/services/ErrorNotificationService.ts` | 325 | âœ… Complete | Full showAgentError, retry, bug_id copy |
| `src/managers/ErrorHistoryManager.ts` | 366 | âœ… Complete | save/load, cleanup(7 days), getRecent(20) |
| `src/settings/PluginSettingsTab.ts` | 1434-1593 | âš ï¸ Partial | displayErrorHistorySettings() exists |
| `main.ts` | - | â“ Unknown | Service integration unclear |

### Code Quality Observations

**Positive**:
- Clean TypeScript with JSDoc comments
- Follows ADR-009 NotificationManager pattern
- Thread-safe save operations (debouncing)
- Comprehensive error record structure

**Concerns**:
- No unit tests for new services
- CSS classes not namespaced (`notice-warning` vs `canvas-notice-warning`)
- No schema versioning for error history data

---

## 4. Test Strategy Recommendations

### Unit Tests (Priority: HIGH)

```typescript
// tests/unit/ErrorHistoryManager.test.ts
describe('ErrorHistoryManager', () => {
  it('addError creates valid record with all fields', () => {...});
  it('getRecent(20) returns max 20 records', () => {...});
  it('cleanup removes records older than 7 days', () => {...});
  it('MAX_RECORDS limit enforced at 100', () => {...});
  it('debouncing prevents concurrent saves', () => {...});
});

// tests/unit/ApiError.test.ts
describe('ApiError.isRetryable', () => {
  it('returns true for NetworkError', () => {...});
  it('returns true for TimeoutError', () => {...});
  it('returns true for HttpError5xx', () => {...});
  it('returns false for HttpError4xx', () => {...});
  it('returns false for ValidationError', () => {...});
});
```

### Integration Tests (Priority: MEDIUM)

```typescript
// tests/integration/ErrorNotificationService.test.ts
describe('ErrorNotificationService', () => {
  it('shows bug_id when present in error', () => {...});
  it('shows retry button for retryable errors', () => {...});
  it('calls onRetry callback when button clicked', () => {...});
  it('copies bug_id to clipboard on click', () => {...});
});
```

### Manual Tests (Priority: HIGH)

| Test | Steps | Expected Result |
|------|-------|-----------------|
| Bug ID Display | Trigger 500 error | Notice shows "Bug ID: BUG-XXXXXXXX" |
| Copy Bug ID | Click bug_id | Clipboard contains ID, success toast |
| Warning Style | Trigger NetworkError | Orange/yellow notice styling |
| Error Style | Trigger 500 error | Red notice styling |
| Retry Button | Trigger retryable error | "é‡è¯•" button visible, functional |
| Settings History | Open settings â†’ Error History | Shows recent errors |
| 7-Day Cleanup | Set old timestamp | Record removed after plugin reload |

---

## 5. Recommendations

### Immediate Actions (Before Development)

1. **Verify Dependencies** (R1 - Critical)
   ```bash
   # Check if backend returns bug_id
   curl http://localhost:8000/api/v1/agents/decompose_basic \
     -d '{"bad":"data"}' -H "Content-Type: application/json"
   ```

2. **Audit main.ts** (R2)
   - Search for `catch (error)` blocks
   - Verify service integration

### During Development

3. **AC-by-AC Verification** (R7)
   - Test each AC against existing code
   - Document any gaps

4. **Create Unit Tests**
   - ErrorHistoryManager tests
   - ApiError.isRetryable tests

### Post-Development

5. **Theme Compatibility Testing** (R6)
   - Test with Minimal, Things, Blue Topaz themes

6. **Documentation**
   - Update error handling patterns in coding-standards.md

---

## 6. Gate Recommendation

**Decision**: âš ï¸ **CONCERNS**

**Rationale**:
Most implementation is already complete, reducing technical risk significantly. However, proceeding requires:

1. âœ… **Dependency verification** - Confirm Stories 21.5.1-21.5.4 status
2. âœ… **Integration audit** - Verify services wired into main.ts
3. âœ… **AC verification** - Test each AC against existing code
4. âœ… **Unit tests** - Create tests for new services

**Blocking Issues**: None

**Non-Blocking Issues**:
- CSS class naming (cosmetic)
- Missing unit tests (can be added post-implementation)

---

## Appendix: Key Code References

### ApiError Class (types.ts:32-108)
```typescript
export class ApiError extends Error {
  public bugId?: string;
  public backendErrorType?: string;

  get isRetryable(): boolean {
    return ['NetworkError', 'TimeoutError', 'HttpError5xx'].includes(this.type);
  }
}
```

### Error Type Styling (ErrorNotificationService.ts:47-54)
```typescript
const ERROR_LEVEL_MAP: Record<ErrorType, NotificationLevel> = {
  NetworkError: NotificationLevel.WARNING,
  TimeoutError: NotificationLevel.WARNING,
  HttpError5xx: NotificationLevel.ERROR,
  HttpError4xx: NotificationLevel.ERROR,
  ValidationError: NotificationLevel.ERROR,
  UnknownError: NotificationLevel.ERROR,
};
```

### 7-Day Cleanup (ErrorHistoryManager.ts:60-64)
```typescript
const MAX_RECORDS = 100;
const EXPIRY_DAYS = 7;
const MS_PER_DAY = 24 * 60 * 60 * 1000;
```

---

**Assessment Completed**: 2025-12-14
**Next Review**: After dependency verification
**Report Location**: `docs/qa/assessments/21.5.5-risk-20251214.md`
