# NFR Assessment: 31.10

Date: 2026-02-05
Reviewer: Quinn
Story: 推荐降级模式 UI 指示器

## Summary

- Security: PASS - DOM 操作使用安全的 Obsidian createEl() API，无 innerHTML；重试按钮有 debounce 保护
- Performance: PASS - 仅增加 3-4 个 DOM 节点，无额外 API 调用（重试为用户显式触发）
- Reliability: PASS - 错误处理完备，isRetrying 标志始终重置，降级展示即为本 story 核心目标
- Maintainability: PASS - 13 个单元测试覆盖全部 AC，代码结构清晰，新方法职责单一

## Detailed Analysis

### Security (PASS)

| 检查项 | 状态 | 说明 |
|--------|------|------|
| XSS 防护 | ✅ | 全部使用 `contentEl.createEl()` 构建 DOM，无 innerHTML (ADR-001) |
| 用户输入处理 | ✅ | 重试按钮无用户输入，仅重触发已有 API 调用 |
| 凭证/密钥 | ✅ | 无硬编码凭证，API 认证由 ApiClient 统一处理 |
| 速率保护 | ✅ | 重试 debounce 2s + 失败后禁用 5s (ScoringResultPanel.ts:528, 548) |

### Performance (PASS)

| 检查项 | 状态 | 说明 |
|--------|------|------|
| DOM 开销 | ✅ | renderRecommendationStatus() 最多创建 4 个元素，可忽略 |
| 网络开销 | ✅ | 初始渲染零额外 API 调用；重试仅在用户点击时触发 |
| 缓存策略 | ✅ | 重试仅删除当前 nodeId 的缓存条目 (line 538)，不清全局缓存 |
| CSS 开销 | ✅ | 新增约 60 行 CSS，样式解析影响可忽略 |

### Reliability (PASS)

| 检查项 | 状态 | 说明 |
|--------|------|------|
| 错误处理 | ✅ | fetchRecommendation() try/catch 返回 undefined；handleRetry() try/catch 包裹 |
| 状态重置 | ✅ | isRetrying 标志在 line 340 始终重置 (finally-equivalent 位置) |
| 优雅降级 | ✅ | 本 story 核心即为降级 UI 指示，设计目标契合 |
| Notice 通知 | ✅ | 重试失败使用 WARNING 级 Notice，符合 ADR-009 |

**Advisory:** handleRetry() catch 块 (line 548-551) 中 `btn` 引用的是已被 `contentEl.empty()` 移除的 DOM 元素。setTimeout 操作的是孤立节点，不会崩溃但属于死代码。非阻塞性问题。

### Maintainability (PASS)

| 检查项 | 状态 | 说明 |
|--------|------|------|
| 测试覆盖 | ✅ | 13 个测试覆盖 AC-31.10.1~8 (online label, offline indicator, retry, debounce, integration) |
| 代码结构 | ✅ | 新增 renderRecommendationStatus() + handleRetry() 职责清晰，与现有代码解耦 |
| 文档 | ✅ | JSDoc + Story/ADR 引用完备 |
| 可回退性 | ✅ | 删除一行调用 + 两个方法即可完全回退 |

**Advisory:** ScoringResultPanel.test.ts 和 ScoringResultPanel.fallback.test.ts 共享约 100 行相同的 helper 代码 (addObsidianMethods, mock 工厂)。建议未来提取到共享测试工具模块。

## Quick Wins

- 清理 handleRetry() catch 块中的孤立 DOM 引用（可选）
- 提取测试 helper 到 `tests/helpers/obsidian-test-utils.ts`（可选，跨 story 改进）

## Quality Score

100 / 100 (4x PASS, 0x CONCERNS, 0x FAIL)
