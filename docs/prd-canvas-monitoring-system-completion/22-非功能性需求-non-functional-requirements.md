# 2.2 非功能性需求 (Non-Functional Requirements)

## NFR1: 性能要求

**响应时间要求**：

| 操作 | 目标时间 | 测量方法 |
|------|---------|---------|
| 文件系统检测 | < 50ms | OS级别，不可控 |
| 防抖等待 | 500ms | 固定延迟 |
| 异步队列传递 | < 10ms | asyncio内存队列 |
| Canvas JSON解析 | < 150ms (50节点)<br>< 300ms (100节点) | 性能测试脚本 |
| 学习分析 | < 50ms | 单次回调执行时间 |
| JSON写入 | < 20ms | 异步文件IO |
| SQLite批量提交 | 后台执行 | 不影响主流程 |
| **总响应时间** | **< 800ms** | 从保存到数据记录完成 |

**用户感知延迟**：编辑Canvas → 保存文件 → 500ms防抖 → 150ms处理 = **650ms**

**并发能力**：

- 支持同时监控 ≥ 10个Canvas文件
- 4个worker线程并发处理
- 异步队列容量：1000条任务

**资源使用限制**：

- CPU使用率：
  - 平均 < 5%
  - 峰值 < 15%（短时间高峰可接受）
- 内存占用：
  - 监控进程 < 100MB
  - 增长率 < 10MB/天（检测内存泄漏）
- 磁盘IO：
  - JSON写入 < 1MB/小时（热数据）
  - SQLite写入 < 10MB/天（冷数据）

**性能测试要求**：

- P50响应时间 < 800ms
- P95响应时间 < 1200ms
- P99响应时间 < 2000ms

**验收标准**：

- ✅ 性能基准测试通过（100次Canvas修改）
- ✅ CPU/内存使用在限制范围内
- ✅ 长期运行测试（72小时）无性能劣化

---

## NFR2: 可靠性要求

**可用性目标**：

- 监控进程正常运行时间 > 99%（排除主动停止）
- 崩溃后30秒内自动重启（通过系统服务管理）

**错误处理**：

1. **回调执行失败**：
   - 捕获异常，记录到错误日志
   - 不影响监控主流程
   - 其他回调继续执行

2. **Canvas解析失败**：
   - 记录JSON格式错误
   - 跳过该文件，继续监控其他文件
   - 提供手动修复提示

3. **数据写入失败**：
   - 自动重试（最多3次）
   - 重试间隔：100ms, 500ms, 2000ms
   - 失败后记录到错误日志，等待下次同步

4. **监控进程崩溃**：
   - 保存未写入的数据到临时文件
   - 记录崩溃堆栈到crash.log
   - 自动重启（通过系统服务）

**超时控制**：

- 单个回调执行超时：2秒
- Canvas解析超时：5秒（超大文件）
- 数据库查询超时：10秒
- 优雅关闭超时：30秒（等待队列处理完成）

**数据完整性**：

- JSON文件原子写入（写入临时文件 → 重命名）
- SQLite事务一致性（批量插入作为单一事务）
- 数据校验（插入后验证记录数）

**验收标准**：

- ✅ 故障注入测试通过（模拟回调异常、文件损坏、数据库锁）
- ✅ 72小时soak测试无崩溃
- ✅ 数据完整性验证（同步前后记录数一致）

---

## NFR3: 可扩展性要求

**模块化设计**：

- 新的分析算法通过回调添加（无需修改核心引擎）
- 新的存储后端通过接口实现（支持PostgreSQL/MongoDB扩展）
- 新的报告类型通过模板添加（无需修改报告生成器）

**配置灵活性**：

- 所有关键参数可配置（防抖延迟、同步间隔、保留天数）
- 配置文件：`.canvas_monitor_config.yaml`
- 支持热加载配置（部分参数无需重启）

**API开放性**：

- 提供REST API（HTTP端点）供外部系统集成
- 提供Python API（回调注册）供自定义扩展
- 预留ML分析接口（未来支持机器学习模型）

**数据格式版本化**：

- JSON schema包含版本号
- SQLite schema支持迁移脚本
- 向后兼容承诺（v2.x可读v1.x数据）

**验收标准**：

- ✅ 成功添加一个自定义回调（无需修改核心代码）
- ✅ 配置文件修改后生效
- ✅ 数据格式升级测试（v1.0 → v2.0迁移）

---

## NFR4: 可用性要求

**易用性目标**：用户无需阅读文档即可启动和使用

**一键启动**：

- Windows批处理：双击`start_monitoring.bat`
- Python脚本：`python start_canvas_monitoring.py`
- 自动环境检查（Python版本、依赖库、目录权限）

**状态可见性**：

- 启动后显示实时状态（监控文件数、CPU/内存使用）
- 斜杠命令：`/monitoring-status`查看详细状态
- HTTP端点：`http://localhost:5678/status`（JSON格式）

**日志与诊断**：

- 日志文件：`logs/monitor.log`（所有级别）
- 错误日志：`logs/errors.log`（仅ERROR）
- 性能日志：`logs/performance.log`（响应时间统计）
- 日志轮转：每个文件最大10MB，保留5个备份

**错误消息可读性**：

- 使用中文错误消息
- 提供解决方案提示
- 示例：
  ```
  ❌ 错误：找不到笔记库目录

  可能原因：
  1. 目录路径配置错误
  2. 目录已被移动或删除

  解决方案：
  1. 检查配置文件：.canvas_monitor_config.yaml
  2. 确认笔记库路径是否正确：C:\Users\ROG\托福\笔记库
  3. 如需帮助，查看文档：docs/troubleshooting.md
  ```

**文档完整性**：

- 用户手册：如何启动、如何使用、常见问题
- 故障排除指南：常见错误和解决方案
- API文档：回调接口规格
- 开发指南：如何添加自定义分析器

**验收标准**：

- ✅ 新用户能在5分钟内启动监控系统
- ✅ 错误消息提供明确的解决方案
- ✅ 文档覆盖所有主要功能
- ✅ 用户满意度 > 4/5

---

## NFR5: 兼容性要求

**平台兼容性**：

- **主要平台**：Windows 10/11（开发和测试重点）
- **次要平台**：macOS, Linux（基础支持）
- Python版本：3.9+（建议3.12.7）

**Obsidian兼容性**：

- Canvas文件格式：兼容当前所有版本（v1.0+）
- 非侵入式监控：不修改Canvas文件格式
- 不干扰Obsidian操作：监控时Obsidian编辑流畅

**依赖库版本**：

| 库名 | 最低版本 | 推荐版本 | 用途 |
|------|---------|---------|------|
| watchdog | 4.0.0 | 最新 | 文件系统监控 |
| psutil | 5.9.0 | 最新 | 性能监控 |
| pytest | 7.0.0 | 最新 | 单元测试 |
| pytest-asyncio | 0.21.0 | 最新 | 异步测试 |

**向后兼容性**：

- 配置文件格式向后兼容（v2.0可读v1.0配置）
- 数据格式向后兼容（v2.0可读v1.0数据）
- API接口向后兼容（弃用但保留旧接口）

**验收标准**：

- ✅ 在Windows 10/11上测试通过
- ✅ 在macOS上基础功能测试通过（可选）
- ✅ 兼容Obsidian最新版本
- ✅ 现有420个测试继续通过

---
