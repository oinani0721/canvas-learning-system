# Canvas Learning System - ObsidianåŸç”Ÿæ’ä»¶è¿ç§»PRD

**æ–‡æ¡£ç‰ˆæœ¬**: v1.1.4 (è‰¾å®¾æµ©æ–¯å¤ä¹ ç³»ç»Ÿè®¾è®¡è¡¥å…¨ç‰ˆ)
**åˆ›å»ºæ—¥æœŸ**: 2025-01-15
**æœ€åæ›´æ–°**: 2025-11-11 (**NEW**: è‰¾å®¾æµ©æ–¯å¤ä¹ ç³»ç»Ÿè®¾è®¡è¡¥å…¨ - FR3æ‰©å±•+Epic 14è°ƒæ•´)


## âš ï¸ v1.1.4 è‰¾å®¾æµ©æ–¯å¤ä¹ ç³»ç»Ÿè®¾è®¡è¡¥å…¨ (2025-11-11) **å¿…è¯»**

**æ ¸å¿ƒå˜æ›´**: FR3è‰¾å®¾æµ©æ–¯å¤ä¹ ç³»ç»Ÿè®¾è®¡è¡¥å…¨ï¼Œæ–°å¢5ä¸ªå…³é”®è®¾è®¡å…ƒç´ ï¼ŒEpic 14è°ƒæ•´ä¸º"è¿ç§»+UIé›†æˆ"æ–¹æ¡ˆ

**è¡¥å…¨å†…å®¹**:
1. **FR3.1 æ•°æ®é‡‡é›†è§¦å‘æœºåˆ¶**: æ˜ç¡®ä½•æ—¶ã€ç”±è°è§¦å‘add_concept_for_review()ï¼Œé”™è¯¯å¤„ç†æœºåˆ¶
2. **FR3.2 å¤ä¹ æ¨é€èšåˆé€»è¾‘**: ä»æ¦‚å¿µçº§åˆ«â†’Canvasçº§åˆ«çš„èšåˆç®—æ³•ï¼Œä¼˜å…ˆçº§æ’åº
3. **FR3.3 Obsidian UIè®¾è®¡Mockup**: ä¾§è¾¹æ å¤ä¹ é¢æ¿å®Œæ•´è®¾è®¡ï¼ˆå¸ƒå±€ã€äº¤äº’ã€æ ·å¼ï¼‰
4. **FR3.4 Py-FSRSé›†æˆç»†èŠ‚**: Card schemaã€17å‚æ•°é…ç½®ã€è°ƒç”¨æ—¶æœºã€æ€§èƒ½é¢„æœŸ
5. **FR3.5 æ•°æ®ä¸€è‡´æ€§ä¿è¯**: Canvasè¯„åˆ† â†” å¤ä¹ æ•°æ®åŒå‘åŒæ­¥æœºåˆ¶ï¼Œå†²çªè§£å†³ç­–ç•¥

**ç®—æ³•å‡çº§**: é‡‡ç”¨**Py-FSRSç®—æ³•**ï¼ˆç›¸æ¯”ç»å…¸è‰¾å®¾æµ©æ–¯é—å¿˜æ›²çº¿å‡†ç¡®æ€§æå‡20-30%ï¼‰

**Epic 14è°ƒæ•´**: ä»"æ–°å¼€å‘"æ”¹ä¸º"è¿ç§»+UIé›†æˆ"ï¼ˆåŸºäºå·²æœ‰ebbinghaus_review.py 870è¡Œä»£ç ï¼Œ2025-01-22å®ç°ï¼‰

---

## âš ï¸ v1.1.3 LangGraphè®°å¿†ç³»ç»Ÿé›†æˆ (2025-11-11)

**æ ¸å¿ƒå˜æ›´**: æ–°å¢Section 3.6 "LangGraphè®°å¿†ç³»ç»Ÿé›†æˆè®¾è®¡"ï¼Œæ˜ç¡®LangGraph Checkpointerä¸3å±‚ä¸šåŠ¡è®°å¿†ç³»ç»Ÿçš„èŒè´£è¾¹ç•Œã€è§¦å‘æ—¶æœºã€ä¸€è‡´æ€§ä¿è¯å’Œæ•…éšœå¤„ç†æœºåˆ¶

**å¼ºåˆ¶è¦æ±‚** (Quality Gate):
- ğŸš« **æœªéªŒè¯çš„APIä¸èƒ½è¿›å…¥Storyå®æ–½**
- ğŸš« **æ‰€æœ‰æŠ€æœ¯ç»†èŠ‚å¿…é¡»æœ‰å®˜æ–¹æ–‡æ¡£æ”¯æ’‘**
- âœ… **æ¯ä¸ªå…³é”®APIå¿…é¡»æ ‡æ³¨æ–‡æ¡£æ¥æº**

**SM/Dev Agentå¿…è¯»**:
- ğŸ“– **Section 3.5** (æœ¬PRDç¬¬1541è¡Œèµ·): æŠ€æœ¯æ ˆæ˜ å°„å’ŒéªŒè¯åè®®
- ğŸ“– **CLAUDE.md**: æŠ€æœ¯éªŒè¯æµç¨‹ç« èŠ‚ï¼ˆè‡ªåŠ¨åŠ è½½ï¼‰
- ğŸ“– **create-next-story.md Step 3.5**: æŠ€æœ¯éªŒè¯å¼ºåˆ¶æ­¥éª¤
- ğŸ“– **Checklist**: `.bmad-core/checklists/technical-verification-checklist.md`

**Quick Start** (åœ¨Storyå¼€å‘å‰):
```bash
# 1. è¯†åˆ«Epicæ¶‰åŠçš„æŠ€æœ¯æ ˆï¼ˆæŸ¥çœ‹Section 3.5è¡¨æ ¼ï¼‰
# 2. æ¿€æ´»ç›¸å…³Skillsï¼ˆå¦‚æœæ˜¯Skillç±»å‹ï¼‰
@langgraph      # Epic 12
@graphiti       # Epic 12
@obsidian-canvas # Epic 13

# 3. æŸ¥è¯¢Context7ï¼ˆå¦‚æœæ˜¯Context7ç±»å‹ï¼‰
mcp__context7-mcp__get-library-docs(
    context7CompatibleLibraryID="/websites/fastapi_tiangolo",  # Epic 11
    topic="your-topic"
)

# 4. éªŒè¯æ¯ä¸ªAPIï¼ˆå‚è§technical-verification-checklist.mdï¼‰
```

**ä¸ºä»€ä¹ˆé‡è¦**:
- âŒ **ä¹‹å‰**: Storyå¼€å‘æ—¶å‡è®¾APIå­˜åœ¨ â†’ å®æ–½åå‘ç°ä¸å­˜åœ¨ â†’ è¿”å·¥é‡æ„
- âœ… **ç°åœ¨**: Storyå¼€å‘å‰éªŒè¯API â†’ ç¡®è®¤å­˜åœ¨ä¸”å‚æ•°æ­£ç¡® â†’ ç›´æ¥å®æ–½

**ç¤ºä¾‹**: å‚è§ `docs/examples/story-12-1-verification-demo.md` (Epic 12å®ä¾‹)

---

**æ–‡æ¡£ç±»å‹**: Brownfield Enhancement PRD
**é¡¹ç›®ç±»å‹**: æ¶æ„è¿ç§» + åŠŸèƒ½å¢å¼º

---

## ğŸ”§ v1.1.1 æŠ€æœ¯ç»†èŠ‚å®Œå–„æ‘˜è¦

**ä¿®å¤åŸå› **: ç”¨æˆ·åé¦ˆPRDç¼ºå¤±3ä¸ªå…³é”®æŠ€æœ¯å®ç°ç»†èŠ‚

**ä¿®å¤å†…å®¹**:
1. âœ… **éœ€æ±‚1: Obsidianæ–‡ä»¶å¼•ç”¨è·¯å¾„é—®é¢˜ä¿®å¤**
   - å°†`create_md_file`æ”¹ä¸º`create_md_file_for_canvas`ï¼Œæ–°å¢`canvas_path`å‚æ•°
   - ä½¿ç”¨Vaultç›¸å¯¹è·¯å¾„è€Œé`./ç›¸å¯¹è·¯å¾„`ï¼Œè§£å†³å†å²ä¸Šåå¤å‡ºç°çš„æ–‡ä»¶å¼•ç”¨å¤±è´¥é—®é¢˜
   - è¿”å›åŒ…å«`vault_path`çš„å®Œæ•´å­—å…¸ï¼Œç¡®ä¿Canvas FILEèŠ‚ç‚¹å¯æ­£ç¡®å¼•ç”¨

2. âœ… **éœ€æ±‚2: 3å±‚è®°å¿†ç³»ç»Ÿè°ƒåº¦æ—¶æœºæ˜ç¡®**
   - æ–°å¢4ä¸ªè®°å¿†å­˜å‚¨å·¥å…·ï¼š`store_to_graphiti_memory`, `store_to_temporal_memory`, `store_to_semantic_memory`, `query_graphiti_for_verification`
   - åœ¨Story 12.2ä¸­æ–°å¢"è®°å¿†ç³»ç»Ÿè°ƒåº¦æ—¶æœºçŸ©é˜µ"ï¼Œæ˜ç¡®ä½•æ—¶è°ƒåº¦å“ªäº›è®°å¿†å±‚
   - æä¾›å®Œæ•´ä»£ç é›†æˆç¤ºä¾‹

3. âœ… **éœ€æ±‚3: æ™ºèƒ½æ£€éªŒç™½æ¿ç”Ÿæˆæœºåˆ¶å¢å¼º**
   - æ–°å¢`query_graphiti_for_verification`å·¥å…·ï¼Œåœ¨ç”Ÿæˆæ£€éªŒç™½æ¿å‰æŸ¥è¯¢Graphitiè·å–ä¸Šä¸‹æ–‡
   - æŸ¥è¯¢å†…å®¹åŒ…æ‹¬ï¼šç›¸å…³æ¦‚å¿µã€å†å²ç›²åŒºã€æ¦‚å¿µå…³ç³»
   - ç”Ÿæˆçš„æ£€éªŒé—®é¢˜åŸºäºGraphitiä¸Šä¸‹æ–‡ï¼Œå…³è”åº¦é«˜ï¼Œèƒ½åˆ‡åˆ°é‡ç‚¹ï¼ˆå¦‚æ•™æˆå®¡é—®ï¼‰

**å˜æ›´èŒƒå›´**:
- å·¥å…·å®šä¹‰: Lines 696-1011 (ä¿®æ”¹`create_md_file` + æ–°å¢4ä¸ªå·¥å…·)
- shared_toolsåˆ—è¡¨: Lines 1030-1042 (æ–°å¢4ä¸ªå·¥å…·)
- Story 12.2: Lines 1545-1611 (æ‰©å±•è®°å¿†ç³»ç»Ÿè°ƒåº¦çŸ©é˜µ + ä»£ç ç¤ºä¾‹)

**éªŒæ”¶æ ‡å‡†**:
- âœ… Obsidianå¯æ­£å¸¸æ‰“å¼€æ‰€æœ‰Agentç”Ÿæˆçš„.mdæ–‡ä»¶ï¼ˆæ— å¼•ç”¨å¤±è´¥ï¼‰
- âœ… æ‰€æœ‰Canvasæ“ä½œæ­£ç¡®è§¦å‘è®°å¿†ç³»ç»Ÿå­˜å‚¨ï¼ˆæŒ‰è°ƒåº¦çŸ©é˜µï¼‰
- âœ… æ£€éªŒç™½æ¿ç”Ÿæˆçš„é—®é¢˜å…·æœ‰é«˜å…³è”åº¦ï¼ˆåŸºäºGraphitiä¸Šä¸‹æ–‡ï¼‰

è¯¦è§: **æœ¬PRD Lines 696-1011ï¼ˆå·¥å…·å®šä¹‰ï¼‰å’ŒLines 1545-1611ï¼ˆStory 12.2ï¼‰**

---

## ğŸ”„ v1.1 æ¶æ„è°ƒæ•´æ‘˜è¦

**è°ƒæ•´åŸå› **: ç”¨æˆ·åé¦ˆè¦æ±‚å¿«é€ŸèŠ‚ç‚¹ç”Ÿæˆå’Œå®æ—¶åé¦ˆ

**å…³é”®å˜æ›´**:
1. **ä¿ç•™canvas-orchestratorä½œä¸ºLayer 3æ™ºèƒ½è·¯ç”±å±‚** (åŸæœ‰æ ¸å¿ƒä¼˜åŠ¿)
2. **æ–°å¢LangGraph Supervisorä½œä¸ºLayer 4æ‰§è¡Œå¼•æ“** (å¹¶å‘è°ƒåº¦)
3. **æ‰€æœ‰Agenté…å¤‡write_to_canvasç­‰å·¥å…·** (åˆ†å¸ƒå¼å†™å…¥,0.5-1ç§’å“åº”)
4. **FileLockå¹¶å‘å®‰å…¨æœºåˆ¶** (è·¨å¹³å°æ–‡ä»¶é”)
5. **WriteHistoryå›æ»šæœºåˆ¶** (æ“ä½œå†å²è¿½æº¯å’Œæ¢å¤)

**æ€§èƒ½æå‡**: é¦–ä¸ªèŠ‚ç‚¹å‡ºç°æ—¶é—´ä»8-10ç§’é™è‡³0.5-1ç§’ (8-16å€æå‡ âš¡)

è¯¦è§: **é™„å½•C - æ¶æ„è°ƒæ•´è¯´æ˜**

---

## ğŸ“‹ æ–‡æ¡£æ‘˜è¦

### é¡¹ç›®æ¦‚è¿°

**é¡¹ç›®åç§°**: Canvas Learning System - Obsidian Native Plugin Migration
**é¡¹ç›®ä»£å·**: CLSV2-OB-NATIVE
**é¡¹ç›®ç±»å‹**: Brownfieldæ¶æ„è¿ç§» + æ–°åŠŸèƒ½å¢å¼º

**æ ¸å¿ƒç›®æ ‡**:
å°†ç°æœ‰çš„Canvaså­¦ä¹ ç³»ç»Ÿä»**Python CLI + Claude Code Taskè°ƒç”¨**æ¶æ„è¿ç§»åˆ°**ObsidianåŸç”Ÿæ’ä»¶ + FastAPIåç«¯ + LangGraphå¤šAgentç¼–æ’**æ¶æ„,åŒæ—¶æ–°å¢è‰¾å®¾æµ©æ–¯å¤ä¹ æé†’ã€æ£€éªŒç™½æ¿è¿›åº¦è¿½è¸ªã€è·¨Canvaså…³è”å­¦ä¹ ä¸‰å¤§æ ¸å¿ƒåŠŸèƒ½ã€‚

**æ ¸å¿ƒåŸåˆ™**: **åŠŸèƒ½å®Œæ•´æ€§ä¼˜å…ˆ** - 100%ä¿ç•™ç°æœ‰åŠŸèƒ½,0%åŠŸèƒ½å›é€€

---

## ğŸ¯ Section 1: é¡¹ç›®åˆ†æ

### 1.1 ç°æœ‰é¡¹ç›®æ¦‚è§ˆ

#### ç³»ç»Ÿæ¶æ„ (å½“å‰)

```
ç”¨æˆ·åœ¨Obsidianä¸­æ‰“å¼€Canvas
    â†“
åˆ‡æ¢åˆ°Claude Codeçª—å£
    â†“
æ‰‹åŠ¨è¾“å…¥å‘½ä»¤: "@ç¦»æ•£æ•°å­¦.canvas åŸºç¡€æ‹†è§£'é€†å¦å‘½é¢˜'"
    â†“
Claude Codeè°ƒç”¨Task tool â†’ è°ƒç”¨12ä¸ªSub-agent
    â†“
Sub-agentè¿”å›JSONç»“æœ
    â†“
canvas_utils.pyå†™å…¥Canvasæ–‡ä»¶
    â†“
ç”¨æˆ·åˆ‡å›ObsidianæŸ¥çœ‹ç»“æœ
```

**ç—›ç‚¹**:
- âŒ éœ€è¦é¢‘ç¹åˆ‡æ¢çª—å£ (Obsidian â†” Claude Code)
- âŒ å‘½ä»¤è¡Œè¾“å…¥é—¨æ§›é«˜,éœ€è¦è®°å¿†è¯­æ³•
- âŒ æ— æ³•å®æ—¶çœ‹åˆ°Agentæ‰§è¡Œè¿›åº¦
- âŒ ç¼ºå°‘ä»Šæ—¥å¤ä¹ æé†’åŠŸèƒ½
- âŒ æ£€éªŒç™½æ¿æ— æ³•è¿½è¸ªåŸç™½æ¿èŠ‚ç‚¹è¿˜åŸè¿›åº¦
- âŒ è·¨Canvaså­¦ä¹ éœ€æ‰‹åŠ¨è®°å¿†å…³è”å…³ç³»

#### æ ¸å¿ƒèµ„äº§

| ç»„ä»¶ | è§„æ¨¡ | çŠ¶æ€ | ä»·å€¼ |
|------|------|------|------|
| canvas_utils.py | ~150KB, 3å±‚æ¶æ„ | âœ… ç¨³å®š | æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ |
| 12ä¸ªSub-agent | `.claude/agents/*.md` | âœ… éªŒè¯å¯ç”¨ | Agentå®šä¹‰ |
| Epic 10.2å¼‚æ­¥å¼•æ“ | 8å€æ€§èƒ½æå‡ | âœ… å®Œæˆ | æ€§èƒ½ä¼˜åŠ¿ |
| æµ‹è¯•å¥—ä»¶ | 360+æµ‹è¯•, 99.2%é€šè¿‡ç‡ | âœ… é«˜è´¨é‡ | è´¨é‡ä¿è¯ |
| Graphitié›†æˆ | Neo4j + KnowledgeGraphLayer | âœ… å®Œæˆ | çŸ¥è¯†å›¾è°±åŸºç¡€ |
| EbbinghausReviewSystem | Py-FSRSç®—æ³• | âœ… å·²å®ç° | å¤ä¹ ç®—æ³• |

**ä¿ç•™ç­–ç•¥**: æ‰€æœ‰æ ¸å¿ƒèµ„äº§100%ä¿ç•™,ä»…è¿ç§»æ¥å£å±‚

---

### 1.2 è¿ç§»èŒƒå›´è¯„ä¼°

#### éœ€è¦è¿ç§»çš„éƒ¨åˆ†

```
âŒ CLIå‘½ä»¤æ¥å£               â†’ âœ… Obsidian Pluginå‘½ä»¤
âŒ Claude Code Taskè°ƒç”¨      â†’ âœ… LangGraph Supervisorè°ƒåº¦
âŒ æ‰‹åŠ¨åˆ‡æ¢çª—å£              â†’ âœ… Obsidianå†…åŸç”Ÿæ“ä½œ
```

#### éœ€è¦ä¿ç•™çš„éƒ¨åˆ†

```
âœ… canvas_utils.py (3å±‚æ¶æ„)    â†’ FastAPIåç«¯ç»§ç»­ä½¿ç”¨
âœ… 12ä¸ªAgentå®šä¹‰               â†’ LangGraphèŠ‚ç‚¹å°è£…
âœ… Epic 10.2å¼‚æ­¥æ‰§è¡Œå¼•æ“       â†’ æ€§èƒ½ä¼˜åŠ¿ä¿ç•™
âœ… GraphitiçŸ¥è¯†å›¾è°±            â†’ è·¨Canvaså…³è”åŸºç¡€
âœ… EbbinghausReviewSystem      â†’ å¤ä¹ ç³»ç»Ÿæ ¸å¿ƒ
```

#### éœ€è¦æ–°å¢çš„åŠŸèƒ½

```
ğŸ†• è‰¾å®¾æµ©æ–¯å¤ä¹ é¢æ¿            â†’ ä»Šæ—¥å¤ä¹ æé†’
ğŸ†• æ£€éªŒç™½æ¿è¿›åº¦è¿½è¸ª            â†’ åŸç™½æ¿èŠ‚ç‚¹è¿˜åŸçŠ¶æ€
ğŸ†• è·¨Canvaså…³è”UI              â†’ æ‰‹åŠ¨é…ç½®æ•™æ-ä¹ é¢˜å…³è”
ğŸ†• å®æ—¶è¿›åº¦æ˜¾ç¤º                â†’ WebSocketæ¨é€AgentçŠ¶æ€
```

---

## ğŸ“ Section 2: éœ€æ±‚å®šä¹‰

### 2.1 åŠŸèƒ½éœ€æ±‚ (Functional Requirements)

#### FR1: ObsidianåŸç”ŸCanvasæ“ä½œ (Must Have - P0)

**æè¿°**: ç”¨æˆ·åœ¨Obsidianå†…å®Œæˆæ‰€æœ‰Canvaså­¦ä¹ æ“ä½œ,æ— éœ€åˆ‡æ¢åˆ°Claude Code

**ç”¨æˆ·æ•…äº‹**:
```
ä½œä¸ºå­¦ä¹ è€…
æˆ‘å¸Œæœ›åœ¨Obsidianå†…å®Œæˆæ‹†è§£ã€è¯„åˆ†ã€ç”Ÿæˆè§£é‡Šç­‰æ‰€æœ‰æ“ä½œ
è¿™æ ·æˆ‘å¯ä»¥ä¿æŒä¸“æ³¨,ä¸è¢«çª—å£åˆ‡æ¢æ‰“æ–­æ€è·¯
```

**éªŒæ”¶æ ‡å‡†**:
- âœ… å³é”®CanvasèŠ‚ç‚¹ â†’ æ˜¾ç¤º"åŸºç¡€æ‹†è§£"ã€"æ·±åº¦æ‹†è§£"ã€"è¯„åˆ†"ç­‰èœå•
- âœ… å¿«æ·é”®æ”¯æŒ (å¦‚ Ctrl+Shift+D æ‹†è§£)
- âœ… å‘½ä»¤é¢æ¿æ”¯æŒ (Ctrl+P â†’ "Canvaså­¦ä¹ : åŸºç¡€æ‹†è§£")
- âœ… æ“ä½œç»“æœå®æ—¶æ˜¾ç¤º,æ— éœ€åˆ·æ–°
- âœ… é”™è¯¯æç¤ºå‹å¥½,æœ‰é‡è¯•æœºåˆ¶

---

#### FR2: 12ä¸ªAgentåŠŸèƒ½100%ä¿ç•™ (Must Have - P0)

**æè¿°**: æ‰€æœ‰ç°æœ‰AgentåŠŸèƒ½å®Œæ•´è¿ç§»,0%åŠŸèƒ½å›é€€

**éªŒæ”¶æ ‡å‡†**:

| Agent | ç°æœ‰åŠŸèƒ½ | è¿ç§»åå®ç° |
|-------|---------|-----------|
| basic-decomposition | ç”Ÿæˆ3-7ä¸ªå¼•å¯¼é—®é¢˜ | âœ… é…å¤‡write_to_canvaså·¥å…· |
| deep-decomposition | ç”Ÿæˆæ·±åº¦æ£€éªŒé—®é¢˜ | âœ… é…å¤‡write_to_canvaså·¥å…· |
| scoring-agent | 4ç»´è¯„åˆ†,é¢œè‰²æµè½¬ | âœ… é…å¤‡write_to_canvaså·¥å…· |
| oral-explanation | ç”Ÿæˆ800-1200è¯å£è¯­åŒ–è§£é‡Š | âœ… é…å¤‡create_md_fileå·¥å…· |
| clarification-path | ç”Ÿæˆ1500+è¯æ¾„æ¸…æ–‡æ¡£ | âœ… é…å¤‡create_md_fileå·¥å…· |
| comparison-table | ç”Ÿæˆå¯¹æ¯”è¡¨ | âœ… é…å¤‡create_md_fileå·¥å…· |
| memory-anchor | ç”Ÿæˆè®°å¿†é”šç‚¹ | âœ… é…å¤‡create_md_fileå·¥å…· |
| four-level-explanation | ç”Ÿæˆ4å±‚æ¬¡è§£é‡Š | âœ… é…å¤‡create_md_fileå·¥å…· |
| example-teaching | ç”Ÿæˆä¾‹é¢˜æ•™ç¨‹ | âœ… é…å¤‡create_md_fileå·¥å…· |
| verification-question | ç”Ÿæˆæ£€éªŒé—®é¢˜ | âœ… é…å¤‡write_to_canvaså·¥å…· |
| canvas-orchestrator | ä¸»æ§Agent,è‡ªç„¶è¯­è¨€ç†è§£ | âœ… **ä¿ç•™ä¸ºLayer 3æ™ºèƒ½è·¯ç”±å±‚** |
| (æ–°å¢) LangGraph Supervisor | N/A | âœ… Layer 4æ‰§è¡Œå¼•æ“,å¹¶å‘è°ƒåº¦ |

**æ€§èƒ½è¦æ±‚**:
- âœ… å“åº”æ—¶é—´ä¸ä½äºç°æœ‰ç³»ç»Ÿ
- âœ… Epic 10.2çš„8å€æ€§èƒ½æå‡å¿…é¡»ä¿ç•™
- âœ… å¹¶å‘æ‰§è¡Œèƒ½åŠ›ä¸é€€åŒ–

---

#### FR3: è‰¾å®¾æµ©æ–¯å¤ä¹ æé†’ç³»ç»Ÿ (Must Have - P0)

**æè¿°**: æ¯æ—¥æ‰“å¼€Obsidianè‡ªåŠ¨æ˜¾ç¤ºä»Šæ—¥åº”å¤ä¹ çš„Canvasç™½æ¿

**ç”¨æˆ·æ•…äº‹**:
```
ä½œä¸ºå­¦ä¹ è€…
æˆ‘å¸Œæœ›æ¯å¤©æ‰“å¼€Obsidianæ—¶çœ‹åˆ°"ä»Šæ—¥åº”å¤ä¹ :ç¦»æ•£æ•°å­¦ã€çº¿æ€§ä»£æ•°"
è¿™æ ·æˆ‘å¯ä»¥åŠæ—¶å¤ä¹ ,é¿å…é—å¿˜
```

**æ•°æ®æµå‘**:
```
CanvasèŠ‚ç‚¹è¯„åˆ† (â‰¥60åˆ†) â†’ EbbinghausReviewSystem.add_concept_for_review()
                        â†“
              ebbinghaus_review_data.json (Py-FSRS Cardå¯¹è±¡)
                        â†“
              Py-FSRSç®—æ³•è®¡ç®—ä¸‹æ¬¡å¤ä¹ æ—¶é—´
                        â†“
              Obsidianä¾§è¾¹æ "ä»Šæ—¥å¤ä¹ é¢æ¿"
```

**éªŒæ”¶æ ‡å‡†**:
- âœ… æ¯æ—¥æ‰“å¼€Obsidianè‡ªåŠ¨æ˜¾ç¤ºå¤ä¹ é¢æ¿
- âœ… æ˜¾ç¤ºåº”å¤ä¹ çš„Canvasåç§°å’Œåˆ°æœŸæ¦‚å¿µæ•°é‡
- âœ… ä¸€é”®ç”Ÿæˆæ£€éªŒç™½æ¿
- âœ… å¤ä¹ å†å²å¯æŸ¥çœ‹ (æœ€è¿‘7å¤©/30å¤©)
- âœ… å¤ä¹ æé†’é€šçŸ¥ (å¯é…ç½®å¼€å¯/å…³é—­)

---

#### FR3.1: æ•°æ®é‡‡é›†è§¦å‘æœºåˆ¶

**è§¦å‘æ—¶æœºå’Œè°ƒç”¨è€…**:

```python
# è§¦å‘ç‚¹1: scoring-agentè¯„åˆ†åè‡ªåŠ¨è§¦å‘
# è°ƒç”¨è€…: ScoringAgentHandler (command_handlers/scoring_handler.py)
def handle_scoring_completion(canvas_file: str, node_id: str, score: int, concept: str):
    """è¯„åˆ†å®Œæˆåçš„å›è°ƒ"""
    if score >= 60:  # è¾¾åˆ°å¤ä¹ é˜ˆå€¼
        try:
            # è°ƒç”¨è‰¾å®¾æµ©æ–¯ç³»ç»Ÿæ·»åŠ æ¦‚å¿µ
            review_system = EbbinghausReviewSystem()
            review_system.add_concept_for_review(
                canvas_file=canvas_file,
                node_id=node_id,
                concept=concept,
                initial_mastery=score / 100.0  # å°†è¯„åˆ†è½¬æ¢ä¸ºæŒæ¡åº¦
            )
            logger.info(f"âœ… å·²æ·»åŠ æ¦‚å¿µåˆ°å¤ä¹ ç³»ç»Ÿ: {concept} (è¯„åˆ†: {score})")
        except Exception as e:
            logger.error(f"âŒ æ·»åŠ æ¦‚å¿µå¤±è´¥: {concept}, é”™è¯¯: {e}")
            # é™çº§ç­–ç•¥: è®°å½•å¤±è´¥æ—¥å¿—,ä½†ä¸é˜»å¡ä¸»æµç¨‹
            log_review_system_error(canvas_file, node_id, concept, e)
```

**é”™è¯¯å¤„ç†ç­–ç•¥**:
1. **éé˜»å¡åŸåˆ™**: å¤ä¹ ç³»ç»Ÿæ•…éšœä¸å½±å“è¯„åˆ†ä¸»æµç¨‹
2. **é‡è¯•æœºåˆ¶**: å¤±è´¥æ¦‚å¿µè®°å½•åˆ°`review_system_errors.json`,åå°å®šæ—¶é‡è¯•
3. **é™çº§æ–¹æ¡ˆ**: SQLiteä¸å¯ç”¨æ—¶è‡ªåŠ¨åˆ‡æ¢åˆ°JSONæ–‡ä»¶å­˜å‚¨
4. **å‘Šè­¦æœºåˆ¶**: è¿ç»­å¤±è´¥>5æ¬¡æ—¶é€šçŸ¥ç”¨æˆ·æ£€æŸ¥æ•°æ®åº“è¿æ¥

**è§¦å‘ç‚¹æ±‡æ€»**:
- âœ… **è§¦å‘ç‚¹1**: scoring-agentè¯„åˆ†â‰¥60åˆ†åè‡ªåŠ¨è§¦å‘
- âœ… **è§¦å‘ç‚¹2**: ç”¨æˆ·æ‰‹åŠ¨æ ‡è®°æ¦‚å¿µä¸º"éœ€è¦å¤ä¹ " (å³é”®èœå•)
- âœ… **è§¦å‘ç‚¹3**: æ‰¹é‡å¯¼å…¥å†å²CanvasèŠ‚ç‚¹ (æ•°æ®è¿ç§»åœºæ™¯)

---

#### FR3.2: å¤ä¹ æ¨é€èšåˆé€»è¾‘

**ä»æ¦‚å¿µçº§åˆ«åˆ°Canvasçº§åˆ«çš„èšåˆç®—æ³•**:

```python
def get_today_review_summary() -> List[Dict]:
    """
    èšåˆä»Šæ—¥å¤ä¹ ä»»åŠ¡åˆ°Canvasçº§åˆ«

    Returns:
        [
            {
                "canvas_file": "ç¬”è®°åº“/ç¦»æ•£æ•°å­¦.canvas",
                "canvas_name": "ç¦»æ•£æ•°å­¦",
                "due_concepts_count": 5,
                "priority_score": 8.5,  # 0-10åˆ†
                "due_concepts": ["é€†å¦å‘½é¢˜", "å¾·æ‘©æ ¹å®šå¾‹", ...],
                "urgency_level": "high"  # low/medium/high/urgent
            },
            ...
        ]
    """
    # Step 1: æŸ¥è¯¢æ‰€æœ‰åˆ°æœŸæ¦‚å¿µ (Py-FSRSè®¡ç®—åˆ°æœŸæ—¶é—´)
    due_concepts = query_due_concepts(today=datetime.now())

    # Step 2: æŒ‰Canvasæ–‡ä»¶åˆ†ç»„
    canvas_groups = defaultdict(list)
    for concept in due_concepts:
        canvas_groups[concept['canvas_file']].append(concept)

    # Step 3: è®¡ç®—æ¯ä¸ªCanvasçš„ä¼˜å…ˆçº§åˆ†æ•°
    canvas_summary = []
    for canvas_file, concepts in canvas_groups.items():
        # ä¼˜å…ˆçº§è®¡ç®—å…¬å¼ (0-10åˆ†):
        # priority = (æ¦‚å¿µæ•°é‡æƒé‡ * 0.3) + (å¹³å‡é—å¿˜é£é™© * 0.5) + (æœ€é•¿é€¾æœŸå¤©æ•° * 0.2)
        concept_count_score = min(len(concepts) / 5.0 * 10, 10)  # 5ä¸ªæ¦‚å¿µ=10åˆ†
        avg_forgetting_risk = sum(c['forgetting_risk'] for c in concepts) / len(concepts)
        max_overdue_days = max(c['overdue_days'] for c in concepts)
        overdue_score = min(max_overdue_days / 3.0 * 10, 10)  # 3å¤©é€¾æœŸ=10åˆ†

        priority_score = (
            concept_count_score * 0.3 +
            avg_forgetting_risk * 10 * 0.5 +
            overdue_score * 0.2
        )

        # ç´§æ€¥ç¨‹åº¦åˆ†çº§
        if priority_score >= 8.0:
            urgency_level = "urgent"
        elif priority_score >= 6.0:
            urgency_level = "high"
        elif priority_score >= 4.0:
            urgency_level = "medium"
        else:
            urgency_level = "low"

        canvas_summary.append({
            "canvas_file": canvas_file,
            "canvas_name": Path(canvas_file).stem,
            "due_concepts_count": len(concepts),
            "priority_score": round(priority_score, 2),
            "due_concepts": [c['concept'] for c in concepts],
            "urgency_level": urgency_level
        })

    # Step 4: æŒ‰ä¼˜å…ˆçº§æ’åºè¿”å›
    return sorted(canvas_summary, key=lambda x: x['priority_score'], reverse=True)
```

**æ¨é€å±•ç¤ºè§„åˆ™**:
- **Urgentçº§åˆ« (çº¢è‰²å¾½ç« )**: ä¼˜å…ˆçº§â‰¥8.0,é¡¶éƒ¨å±•ç¤º,é—ªçƒåŠ¨ç”»
- **Highçº§åˆ« (æ©™è‰²å¾½ç« )**: ä¼˜å…ˆçº§6.0-7.9,æ­£å¸¸å±•ç¤º
- **Medium/Lowçº§åˆ« (ç°è‰²å¾½ç« )**: ä¼˜å…ˆçº§<6.0,æŠ˜å å±•ç¤º,ç‚¹å‡»å±•å¼€

---

#### FR3.3: Obsidian UIè®¾è®¡Mockup

**ä¾§è¾¹æ å¤ä¹ é¢æ¿è®¾è®¡**:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ“š ä»Šæ—¥å¤ä¹  (3ä¸ªç™½æ¿, 12ä¸ªæ¦‚å¿µ)     â”‚ â† æ ‡é¢˜æ 
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸ”´ ç¦»æ•£æ•°å­¦ (5ä¸ªæ¦‚å¿µ) [!urgent]     â”‚ â† Canvaså¡ç‰‡1
â”‚     é€†å¦å‘½é¢˜ã€å¾·æ‘©æ ¹å®šå¾‹ã€å‘½é¢˜é€»è¾‘... â”‚
â”‚     [ğŸ“ å¼€å§‹å¤ä¹ ] [â° æ¨è¿Ÿ1å¤©]       â”‚ â† æ“ä½œæŒ‰é’®
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸŸ  çº¿æ€§ä»£æ•° (4ä¸ªæ¦‚å¿µ) [!high]       â”‚ â† Canvaså¡ç‰‡2
â”‚     ç‰¹å¾å‘é‡ã€æ­£äº¤çŸ©é˜µã€è¡Œåˆ—å¼...     â”‚
â”‚     [ğŸ“ å¼€å§‹å¤ä¹ ] [â° æ¨è¿Ÿ1å¤©]       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  âšª æ¦‚ç‡è®º (3ä¸ªæ¦‚å¿µ) [medium]        â”‚ â† Canvaså¡ç‰‡3 (æŠ˜å )
â”‚     [å±•å¼€æŸ¥çœ‹]                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸ“Š å¤ä¹ ç»Ÿè®¡ (æœ¬å‘¨)                  â”‚ â† ç»Ÿè®¡é¢æ¿
â”‚     âœ… å·²å¤ä¹ : 28ä¸ªæ¦‚å¿µ               â”‚
â”‚     ğŸ“ˆ å¹³å‡è¯„åˆ†: 82åˆ†                â”‚
â”‚     ğŸ”¥ è¿ç»­å¤ä¹ : 7å¤©                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  âš™ï¸ è®¾ç½®  ğŸ“œ å†å²è®°å½•                â”‚ â† åº•éƒ¨å·¥å…·æ 
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**äº¤äº’é€»è¾‘**:
1. **ç‚¹å‡»"å¼€å§‹å¤ä¹ "**: è‡ªåŠ¨è°ƒç”¨`generate_review_canvas_file()`ç”Ÿæˆæ£€éªŒç™½æ¿å¹¶æ‰“å¼€
2. **ç‚¹å‡»"æ¨è¿Ÿ1å¤©"**: è°ƒæ•´Py-FSRSçš„next_review_date +1å¤©,é‡æ–°è®¡ç®—é—å¿˜é£é™©
3. **ç‚¹å‡»Canvaså¡ç‰‡**: ç›´æ¥æ‰“å¼€åŸç™½æ¿æ–‡ä»¶
4. **å³é”®èœå•**: "æ ‡è®°ä¸ºå·²æŒæ¡"(ç›´æ¥è®¾ä¸ºç»¿è‰²,ä¸å†æ¨é€) / "é‡ç½®å¤ä¹ è¿›åº¦"

**æ ·å¼è§„èŒƒ**:
- **å­—ä½“**: Obsidiané»˜è®¤å­—ä½“,14px
- **é¢œè‰²**: ä½¿ç”¨Obsidianä¸»é¢˜å˜é‡ (`--text-accent`, `--background-secondary`)
- **åŠ¨ç”»**: urgentçº§åˆ«å¡ç‰‡ä½¿ç”¨`pulse`åŠ¨ç”»,period=2s
- **å“åº”å¼**: å®½åº¦<600pxæ—¶è‡ªåŠ¨è°ƒæ•´ä¸ºå•åˆ—å¸ƒå±€

---

#### FR3.4: Py-FSRSé›†æˆç»†èŠ‚

**Py-FSRS Card Schema**:

```python
from dataclasses import dataclass
from datetime import datetime
from typing import Optional

@dataclass
class FSRSCard:
    """Py-FSRSè®°å¿†å¡ç‰‡ (åŸºäºFSRS v5ç®—æ³•)"""

    # æ ¸å¿ƒå­—æ®µ
    due: datetime  # ä¸‹æ¬¡å¤ä¹ æ—¶é—´
    stability: float  # è®°å¿†ç¨³å®šæ€§ (å¤©æ•°)
    difficulty: float  # éš¾åº¦ç³»æ•° (0.0-10.0)
    elapsed_days: int  # è·ç¦»ä¸Šæ¬¡å¤ä¹ çš„å¤©æ•°
    scheduled_days: int  # é¢„å®šå¤ä¹ é—´éš”å¤©æ•°
    reps: int  # å¤ä¹ æ¬¡æ•°
    lapses: int  # é—å¿˜æ¬¡æ•°
    state: str  # çŠ¶æ€: "New"/"Learning"/"Review"/"Relearning"
    last_review: Optional[datetime]  # ä¸Šæ¬¡å¤ä¹ æ—¶é—´

    # Canvasæ‰©å±•å­—æ®µ
    concept: str  # æ¦‚å¿µåç§°
    canvas_file: str  # æ‰€å±Canvasæ–‡ä»¶
    node_id: str  # CanvasèŠ‚ç‚¹ID
    mastery_level: float  # æŒæ¡åº¦ (0.0-1.0)

# åˆå§‹åŒ–Card (ç”¨æˆ·é¦–æ¬¡è¯„åˆ†â‰¥60åˆ†æ—¶)
def create_initial_card(concept: str, initial_score: int) -> FSRSCard:
    """
    ä»Canvasè¯„åˆ†åˆ›å»ºåˆå§‹Card

    Args:
        concept: æ¦‚å¿µåç§°
        initial_score: è¯„åˆ† (60-100)

    Returns:
        åˆå§‹åŒ–çš„FSRSCard,ä½¿ç”¨FSRSé»˜è®¤å‚æ•°
    """
    fsrs = FSRS()  # ä½¿ç”¨é»˜è®¤17å‚æ•°
    card = fsrs.new_card()  # åˆ›å»ºæ–°å¡ç‰‡

    # æ ¹æ®è¯„åˆ†è°ƒæ•´åˆå§‹éš¾åº¦
    # è¯„åˆ†è¶Šé«˜,éš¾åº¦è¶Šä½ (æ›´å®¹æ˜“è®°ä½)
    difficulty_adjustment = (100 - initial_score) / 40.0  # 60åˆ†â†’1.0, 100åˆ†â†’0.0
    card.difficulty = max(1.0, min(10.0, card.difficulty + difficulty_adjustment))

    # è‡ªå®šä¹‰å­—æ®µ
    card.concept = concept
    card.mastery_level = initial_score / 100.0

    return card
```

**Py-FSRS 17å‚æ•°é…ç½®** (ä½¿ç”¨é»˜è®¤å€¼,å¾…åæœŸè°ƒä¼˜):

```python
FSRS_PARAMETERS = {
    "w": [  # 17ä¸ªæƒé‡å‚æ•° (FSRS v5é»˜è®¤å€¼)
        0.4072, 1.1829, 3.1262, 15.4722, 7.2102,
        0.5316, 1.0651, 0.0234, 1.616, 0.1544,
        1.0824, 1.9813, 0.0953, 0.2975, 2.2042,
        0.2407, 2.9466
    ],
    "request_retention": 0.9,  # ç›®æ ‡ä¿ç•™ç‡ 90%
    "maximum_interval": 36500,  # æœ€å¤§é—´éš”100å¹´
    "enable_fuzz": True  # å¯ç”¨æ¨¡ç³ŠåŒ–é¿å…å¤ä¹ é›†ä¸­
}

# åˆ›å»ºFSRSå®ä¾‹
fsrs = FSRS(
    w=FSRS_PARAMETERS["w"],
    request_retention=FSRS_PARAMETERS["request_retention"],
    maximum_interval=FSRS_PARAMETERS["maximum_interval"],
    enable_fuzz=FSRS_PARAMETERS["enable_fuzz"]
)
```

**Py-FSRSè°ƒç”¨æ—¶æœº**:

| æ—¶æœº | è°ƒç”¨æ–¹æ³• | è¯´æ˜ |
|------|---------|------|
| é¦–æ¬¡æ·»åŠ æ¦‚å¿µ | `fsrs.new_card()` | åˆ›å»ºåˆå§‹Card,state="New" |
| å¤ä¹ åæ›´æ–° | `fsrs.review_card(card, rating)` | rating: 1(Again)/2(Hard)/3(Good)/4(Easy) |
| æŸ¥è¯¢åˆ°æœŸæ¦‚å¿µ | `card.due <= datetime.now()` | ç›´æ¥æ¯”è¾ƒdueæ—¶é—´ |
| è®¡ç®—é—å¿˜é£é™© | `fsrs.current_retrievability(card)` | è¿”å›0.0-1.0,è¶Šä½è¶Šå®¹æ˜“å¿˜ |

**æ€§èƒ½é¢„æœŸ**:
- **å•æ¬¡review_card()**: <5ms (çº¯è®¡ç®—,æ— IO)
- **æ‰¹é‡æŸ¥è¯¢1000ä¸ªCardçš„åˆ°æœŸçŠ¶æ€**: <50ms (å†…å­˜éå†)
- **å¹¶å‘å®‰å…¨**: ä½¿ç”¨FileLocké”å®šSQLiteæ•°æ®åº“,æ”¯æŒå¤šè¿›ç¨‹è®¿é—®

**ä¾èµ–å®‰è£…**:
```bash
pip install py-fsrs==1.0.0  # å›ºå®šç‰ˆæœ¬,é¿å…APIå˜æ›´
```

---

#### FR3.5: æ•°æ®ä¸€è‡´æ€§ä¿è¯æœºåˆ¶

**åŒå‘åŒæ­¥åœºæ™¯**:

```
åœºæ™¯1: Canvasè¯„åˆ† â†’ å¤ä¹ ç³»ç»Ÿ
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ScoringAgentâ”‚ â”€è¯„åˆ†â”€â†’ â”‚ EbbinghausSystem â”‚
â”‚  (è¯„åˆ†80åˆ†) â”‚         â”‚  (åˆ›å»º/æ›´æ–°Card) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

åœºæ™¯2: å¤ä¹ ç³»ç»Ÿ â†’ Canvasè¯„åˆ† (ç”¨æˆ·åœ¨æ£€éªŒç™½æ¿å¤ä¹ å)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ EbbinghausSystem â”‚ â†å¤ä¹ â”€  â”‚ æ£€éªŒç™½æ¿è¯„åˆ† â”‚
â”‚  (æ›´æ–°Cardéš¾åº¦)  â”‚         â”‚  (è¯„åˆ†75åˆ†)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**åŒæ­¥ç­–ç•¥**:

```python
class DataConsistencyManager:
    """Canvasè¯„åˆ† â†” å¤ä¹ æ•°æ®åŒå‘åŒæ­¥ç®¡ç†å™¨"""

    def sync_score_to_review(self, canvas_file: str, node_id: str, new_score: int):
        """
        Canvasè¯„åˆ†æ›´æ–° â†’ å¤ä¹ ç³»ç»ŸåŒæ­¥

        è§¦å‘æ—¶æœº: scoring-agentè¯„åˆ†å®Œæˆå
        """
        # Step 1: æŸ¥æ‰¾å¯¹åº”çš„Card
        card_id = f"{canvas_file}_{node_id}"
        card = self.review_db.get_card(card_id)

        if card is None:
            # é¦–æ¬¡è¯„åˆ†ä¸”â‰¥60åˆ†,åˆ›å»ºæ–°Card
            if new_score >= 60:
                card = create_initial_card(concept, new_score)
                self.review_db.save_card(card)
                logger.info(f"âœ… åˆ›å»ºæ–°Card: {card_id}, åˆå§‹è¯„åˆ†: {new_score}")
        else:
            # å·²æœ‰Card,æ›´æ–°æŒæ¡åº¦
            card.mastery_level = new_score / 100.0

            # å¦‚æœè¯„åˆ†æ˜¾è‘—æå‡(+15åˆ†ä»¥ä¸Š),è°ƒæ•´Cardéš¾åº¦
            if new_score - card.mastery_level * 100 >= 15:
                card.difficulty = max(1.0, card.difficulty - 0.5)  # é™ä½éš¾åº¦
                logger.info(f"âœ… è¯„åˆ†æå‡,é™ä½Cardéš¾åº¦: {card_id}, æ–°éš¾åº¦: {card.difficulty}")

            self.review_db.update_card(card)

    def sync_review_to_score(self, canvas_file: str, node_id: str, review_rating: int):
        """
        æ£€éªŒç™½æ¿å¤ä¹  â†’ åŸCanvasè¯„åˆ†åŒæ­¥

        è§¦å‘æ—¶æœº: ç”¨æˆ·åœ¨æ£€éªŒç™½æ¿ä¸Šå®Œæˆå¤ä¹ å¹¶è¯„åˆ†å
        """
        # Step 1: æ›´æ–°Py-FSRS Card
        card_id = f"{canvas_file}_{node_id}"
        card = self.review_db.get_card(card_id)
        card, review_log = self.fsrs.review_card(card, review_rating)
        self.review_db.update_card(card)

        # Step 2: åŒæ­¥æ›´æ–°åŸCanvasèŠ‚ç‚¹é¢œè‰²
        # rating=4(Easy)æˆ–rating=3(Good)ä¸”repsâ‰¥3 â†’ ç»¿è‰²
        if review_rating == 4 or (review_rating == 3 and card.reps >= 3):
            self.canvas_operator.update_node_color(canvas_file, node_id, COLOR_GREEN)
            logger.info(f"âœ… å¤ä¹ è¾¾æ ‡,åŸCanvasèŠ‚ç‚¹å˜ç»¿: {node_id}")

        # rating=1(Again) â†’ ä¿æŒçº¢è‰²/ç´«è‰²
        elif review_rating == 1:
            logger.info(f"âš ï¸ å¤ä¹ å¤±è´¥,åŸCanvasèŠ‚ç‚¹ä¿æŒåŸè‰²: {node_id}")

    def resolve_conflict(self, canvas_file: str, node_id: str):
        """
        å†²çªè§£å†³ç­–ç•¥

        å†²çªåœºæ™¯: CanvasèŠ‚ç‚¹è¢«æ‰‹åŠ¨ä¿®æ”¹ä¸ºç»¿è‰²,ä½†Cardæ˜¾ç¤ºéœ€è¦å¤ä¹ 
        """
        canvas_color = self.canvas_operator.get_node_color(canvas_file, node_id)
        card = self.review_db.get_card(f"{canvas_file}_{node_id}")

        if canvas_color == COLOR_GREEN and card.due <= datetime.now():
            # ç­–ç•¥: ä»¥Canvasä¸ºå‡† (ç”¨æˆ·æ‰‹åŠ¨æ ‡è®°ä¸ºå·²æŒæ¡)
            # å°†Cardçš„dueæ—¶é—´å»¶å7å¤©,é¿å…æ¨é€
            card.due = datetime.now() + timedelta(days=7)
            self.review_db.update_card(card)
            logger.warning(f"âš ï¸ å†²çªè§£å†³: Canvaså·²æ ‡ç»¿ä½†Cardåˆ°æœŸ,å»¶åå¤ä¹ : {node_id}")
```

**å†²çªè§£å†³ä¼˜å…ˆçº§**:
1. **ç”¨æˆ·æ‰‹åŠ¨æ“ä½œ > è‡ªåŠ¨åŒæ­¥**: ç”¨æˆ·æ‰‹åŠ¨æ ‡è®°ä¸ºç»¿è‰²,åˆ™å»¶åå¤ä¹ æ¨é€
2. **æœ€æ–°è¯„åˆ†ä¸ºå‡†**: åŒä¸€æ¦‚å¿µåœ¨1å°æ—¶å†…å¤šæ¬¡è¯„åˆ†,ä»¥æœ€æ–°è¯„åˆ†ä¸ºå‡†
3. **æ£€éªŒç™½æ¿è¯„åˆ† > åŸç™½æ¿è¯„åˆ†**: æ£€éªŒç™½æ¿çš„å¤ä¹ è¯„åˆ†æ›´èƒ½åæ˜ çœŸå®æŒæ¡æƒ…å†µ

**ä¸€è‡´æ€§æ£€æŸ¥å·¥å…·**:
```bash
# å®šæœŸè¿è¡Œä¸€è‡´æ€§æ£€æŸ¥ (æ¯å‘¨æ—¥æ™šä¸Š)
python -m canvas_utils.consistency_checker --canvas-dir "ç¬”è®°åº“" --review-db "ebbinghaus_review.db"

# è¾“å‡ºæŠ¥å‘Š:
# âœ… ä¸€è‡´æ€§æ£€æŸ¥é€šè¿‡: æ£€æŸ¥äº†150ä¸ªæ¦‚å¿µ, 0ä¸ªå†²çª
# âš ï¸ å‘ç°3ä¸ªå†²çª:
#    1. ç¦»æ•£æ•°å­¦.canvas node123 (Canvasç»¿è‰², Cardåˆ°æœŸ3å¤©) â†’ å·²è‡ªåŠ¨ä¿®å¤
#    2. çº¿æ€§ä»£æ•°.canvas node456 (Canvasçº¢è‰², Cardå·²æŒæ¡) â†’ éœ€è¦æ‰‹åŠ¨ç¡®è®¤
```

---

**æ•°æ®æº**:
```json
// ebbinghaus_review_data.json
{
  "concepts": {
    "ç¬”è®°åº“/ç¦»æ•£æ•°å­¦.canvas_node123_é€†å¦å‘½é¢˜": {
      "concept": "é€†å¦å‘½é¢˜",
      "canvas_file": "ç¬”è®°åº“/ç¦»æ•£æ•°å­¦.canvas",
      "node_id": "node123",
      "card": { /* Py-FSRS Cardå¯¹è±¡ */ },
      "mastery_level": 0.85,
      "review_count": 5,
      "last_reviewed": "2025-01-15T14:30:00Z",
      "created_at": "2025-01-10T10:00:00Z"
    }
  }
}
```

---

#### FR4: æ£€éªŒç™½æ¿è¿›åº¦è¿½è¸ªç³»ç»Ÿ (Should Have - P1)

**æè¿°**: åœ¨æ£€éªŒç™½æ¿ä¸­å®æ—¶æ˜¾ç¤ºå·²è¿˜åŸçš„åŸç™½æ¿èŠ‚ç‚¹æ•°é‡å’Œé¢œè‰²åˆ†å¸ƒ

**ç”¨æˆ·æ•…äº‹**:
```
ä½œä¸ºå­¦ä¹ è€…
æˆ‘å¸Œæœ›åœ¨æ£€éªŒç™½æ¿ä¸­çœ‹åˆ°"å·²è¿˜åŸ12/15ä¸ªåŸç™½æ¿èŠ‚ç‚¹,çº¢è‰²2ä¸ªé€šè¿‡,ç´«è‰²10ä¸ªé€šè¿‡"
è¿™æ ·æˆ‘å¯ä»¥çŸ¥é“è¿˜æœ‰å“ªäº›çŸ¥è¯†ç‚¹æ²¡æœ‰å¤ç°
```

**æŠ€æœ¯æ–¹æ¡ˆ**:

**åŒå‘æ˜ å°„è®¾è®¡**:
```json
// æ£€éªŒç™½æ¿èŠ‚ç‚¹ (ç¦»æ•£æ•°å­¦-æ£€éªŒç™½æ¿-20250115.canvas)
{
  "id": "question-abc123",
  "type": "text",
  "text": "ä»€ä¹ˆæ˜¯é€†å¦å‘½é¢˜ï¼Ÿ",
  "color": "2",  // ç”¨æˆ·å›ç­”åå˜ç»¿
  "sourceNodeId": "original-node-xyz789"  // â­ æŒ‡å‘åŸç™½æ¿èŠ‚ç‚¹
}
```

**è¿›åº¦è¿½è¸ªç®—æ³•**:
```python
def analyze_review_progress(review_canvas_path, original_canvas_path):
    # 1. è¯»å–æ£€éªŒç™½æ¿,æå–æ‰€æœ‰é—®é¢˜èŠ‚ç‚¹çš„sourceNodeIdå’Œé¢œè‰²
    restored_nodes = {
        node['sourceNodeId']: node['color']
        for node in review_data['nodes']
        if 'sourceNodeId' in node
    }

    # 2. ç»Ÿè®¡é€šè¿‡çš„èŠ‚ç‚¹
    red_passed = [nid for nid, color in restored_nodes.items() if color == "2"]
    purple_passed = [nid for nid, color in restored_nodes.items() if color == "2"]

    # 3. è¿”å›è¿›åº¦æŠ¥å‘Š
    return {
        "total_concepts": len(restored_nodes),
        "red_nodes_passed": len(red_passed),
        "purple_nodes_passed": len(purple_passed),
        "coverage_rate": len(red_passed + purple_passed) / len(restored_nodes)
    }
```

**UIæ˜¾ç¤º**:
```markdown
## æ£€éªŒç™½æ¿è¿›åº¦ - ç¦»æ•£æ•°å­¦

ğŸ“Š çŸ¥è¯†è¿˜åŸè¿›åº¦: 12/15 (80%)

ğŸ”´ çº¢è‰²èŠ‚ç‚¹ (åŸºç¡€æ¦‚å¿µ):
  âœ… é€†å¦å‘½é¢˜å®šä¹‰ (åŸç™½æ¿ node-123)
  âœ… å……è¦æ¡ä»¶ (åŸç™½æ¿ node-456)
  âŒ å¾·æ‘©æ ¹å¾‹ (åŸç™½æ¿ node-789) - æœªé€šè¿‡

ğŸŸ£ ç´«è‰²èŠ‚ç‚¹ (è¿›é˜¶é—®é¢˜):
  âœ… é€†å¦å‘½é¢˜åº”ç”¨ (åŸç™½æ¿ node-234)
  âŒ å‘½é¢˜ç­‰ä»·è¯æ˜ (åŸç™½æ¿ node-567) - æœªé€šè¿‡
```

**éªŒæ”¶æ ‡å‡†**:
- âœ… å®æ—¶æ˜¾ç¤ºå·²è¿˜åŸèŠ‚ç‚¹æ•°é‡
- âœ… çº¢è‰²/ç´«è‰²/ç»¿è‰²èŠ‚ç‚¹ç»Ÿè®¡å‡†ç¡®
- âœ… å¯ç‚¹å‡»è·³è½¬åˆ°åŸç™½æ¿å¯¹åº”èŠ‚ç‚¹
- âœ… è¿›åº¦ç™¾åˆ†æ¯”è®¡ç®—æ­£ç¡®

---

#### FR5: è·¨Canvaså…³è”å­¦ä¹ ç³»ç»Ÿ (Should Have - P1)

**æè¿°**: ç”¨æˆ·æ‰‹åŠ¨é…ç½®ä¹ é¢˜Canvaså…³è”åˆ°æ•™æCanvas,Agentè‡ªåŠ¨å¼•ç”¨æ•™æå†…å®¹

**ç”¨æˆ·æ•…äº‹**:
```
ä½œä¸ºå­¦ä¹ è€…
æˆ‘å¸Œæœ›åœ¨"çº¿æ€§ä»£æ•°ä¹ é¢˜é›†3.canvas"ä¸­è®¾ç½®å…³è”åˆ°"ç¬¬3ç« -å‘é‡ç©ºé—´.canvas"
è¿™æ ·Agentç”Ÿæˆè§£é‡Šæ—¶ä¼šè‡ªåŠ¨å¼•ç”¨æ•™æå®šä¹‰å’Œæ–‡æ¡£
```

**UIè®¾è®¡ - Canvaså·¥å…·æ æŒ‰é’® + æ¨¡æ€æ¡†**:

```
Canvaså·¥å…·æ :
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [ğŸ”] [â•] [ğŸ—‘ï¸] [âš™ï¸]  ...  [ğŸ”—å…³è”]      â”‚  â† æ–°å¢æŒ‰é’®
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç‚¹å‡» [ğŸ”—å…³è”] åå¼¹å‡ºæ¨¡æ€æ¡†:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ”— è®¾ç½®Canvaså…³è”                        â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â”‚
â”‚                                           â”‚
â”‚  å½“å‰Canvas:                              â”‚
â”‚  ğŸ“„ çº¿æ€§ä»£æ•°ä¹ é¢˜é›†3.canvas                â”‚
â”‚                                           â”‚
â”‚  â˜‘ï¸ å¯ç”¨å…³è”å­¦ä¹ æ¨¡å¼                      â”‚
â”‚                                           â”‚
â”‚  é€‰æ‹©å…³è”çš„æ•™æCanvas:                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ ğŸ” æœç´¢Canvas...                    â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                           â”‚
â”‚  æœ€è¿‘ä½¿ç”¨:                                â”‚
â”‚  â€¢ ç¬¬3ç« -å‘é‡ç©ºé—´.canvas                  â”‚
â”‚  â€¢ ç¬¬2ç« -çŸ©é˜µ.canvas                      â”‚
â”‚                                           â”‚
â”‚  æˆ–ä»æ‰€æœ‰Canvasä¸­é€‰æ‹©:                    â”‚
â”‚  â€¢ ç¬¬1ç« -è¡Œåˆ—å¼.canvas                    â”‚
â”‚  â€¢ ç¬¬3ç« -å‘é‡ç©ºé—´.canvas âœ“ å·²é€‰æ‹©         â”‚
â”‚  â€¢ ç¬¬4ç« -çº¿æ€§æ–¹ç¨‹ç»„.canvas                â”‚
â”‚                                           â”‚
â”‚  [ å–æ¶ˆ ]              [ ä¿å­˜å¹¶å¯ç”¨ ]     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æ•°æ®å­˜å‚¨**:
```json
// .canvas-links.json (Vaultæ ¹ç›®å½•)
{
  "version": "1.0",
  "links": {
    "çº¿æ€§ä»£æ•°ä¹ é¢˜é›†3.canvas": {
      "linked_canvas": "ç¬¬3ç« -å‘é‡ç©ºé—´.canvas",
      "enabled": true,
      "created_at": "2025-01-15T14:30:00Z",
      "settings": {
        "citation_depth": 2,
        "auto_reference": true,
        "priority": "high"
      }
    }
  }
}
```

**GraphitiçŸ¥è¯†å›¾è°±åŒæ­¥**:
```cypher
// æ¯æ¬¡ä¿å­˜å…³è”æ—¶,åŒæ­¥å†™å…¥Graphiti
CREATE (exercise:Canvas {path: "çº¿æ€§ä»£æ•°ä¹ é¢˜é›†3.canvas"})
CREATE (textbook:Canvas {path: "ç¬¬3ç« -å‘é‡ç©ºé—´.canvas"})
CREATE (exercise)-[:LINKED_TO {enabled: true, depth: 2}]->(textbook)
```

**Agentå¼•ç”¨æœºåˆ¶**:
```python
# è°ƒç”¨Agentæ—¶,ä¼ å…¥æ•™æå…³è”ä¸Šä¸‹æ–‡
agent_input = {
  "concept": "å‘é‡ç©ºé—´çš„åŸº",
  "linked_learning_mode": True,
  "textbook_context": [
    {
      "canvas": "ç¬¬3ç« -å‘é‡ç©ºé—´.canvas",
      "node_id": "concept-basis",
      "content": "åŸºåº•çš„å®šä¹‰: å‘é‡ç©ºé—´Vçš„ä¸€ç»„åŸºæ˜¯...",
      "file": "ç¬¬3ç« -å‘é‡ç©ºé—´-åŸºåº•-clarification-20250110.md"
    }
  ]
}

# Agentç”Ÿæˆçš„è§£é‡Šæ–‡æ¡£ä¼šåŒ…å«å¼•ç”¨
"""
# å‘é‡ç©ºé—´çš„åŸº - æ¾„æ¸…è·¯å¾„

## æ•™æå¼•ç”¨ ğŸ“š
> æ¥æº: ç¬¬3ç« -å‘é‡ç©ºé—´.canvas - åŸºåº•èŠ‚ç‚¹
> æ–‡æ¡£: [åŸºåº•-clarification-20250110.md](...)

åŸºåº•çš„å®šä¹‰: å‘é‡ç©ºé—´Vçš„ä¸€ç»„åŸºæ˜¯...
"""
```

**éªŒæ”¶æ ‡å‡†**:
- âœ… ç”¨æˆ·å¯é€šè¿‡UIé€‰æ‹©å…³è”Canvas
- âœ… å…³è”é…ç½®æŒä¹…åŒ–å­˜å‚¨
- âœ… å…³è”æ¨¡å¼å¯éšæ—¶å¼€å¯/å…³é—­ (Toggle)
- âœ… Agentç”Ÿæˆçš„è§£é‡Šè‡ªåŠ¨åŒ…å«æ•™æå¼•ç”¨
- âœ… æ•™æå¼•ç”¨æ¥æºæ¸…æ™°æ ‡æ³¨ (Canvasåç§°ã€èŠ‚ç‚¹IDã€æ–‡æ¡£é“¾æ¥)
- âœ… GraphitiçŸ¥è¯†å›¾è°±åŒæ­¥å…³è”å…³ç³»

---

#### FR6-FR10: å…¶ä»–æ ¸å¿ƒåŠŸèƒ½

**FR6**: LangGraphå¤šAgentç¼–æ’ (Must Have - P0)
**FR7**: FastAPI RESTful API (Must Have - P0)
**FR8**: å®æ—¶è¿›åº¦æ¨é€ (Should Have - P1)
**FR9**: é”™è¯¯æ¢å¤å’Œå›æ»šæœºåˆ¶ (Must Have - P0)
**FR10**: è®¾ç½®é¢æ¿å’Œé…ç½®ç®¡ç† (Should Have - P1)

---

### 2.2 éåŠŸèƒ½éœ€æ±‚ (Non-Functional Requirements)

#### NFR1: æ€§èƒ½è¦æ±‚ (Critical)

| æŒ‡æ ‡ | ç›®æ ‡ | å½“å‰ç³»ç»Ÿ | éªŒè¯æ–¹æ³• |
|------|------|---------|---------|
| APIå“åº”æ—¶é—´ (P95) | <2ç§’ | ~1.5ç§’ | æ€§èƒ½åŸºå‡†æµ‹è¯• |
| Canvasæ–‡ä»¶æ“ä½œ | <500ms | ~200ms | å•å…ƒæµ‹è¯• |
| Neo4jæŸ¥è¯¢å“åº” | <500ms | ~80ms | é›†æˆæµ‹è¯• |
| Agentæ‰§è¡Œæ—¶é—´ | ä¿æŒç°æœ‰æ°´å¹³ | 8å€æ€§èƒ½æå‡ | E2Eæµ‹è¯• |
| å¹¶å‘ç”¨æˆ·æ”¯æŒ | â‰¥50ç”¨æˆ· | æœªæµ‹è¯• | è´Ÿè½½æµ‹è¯• |

**å…³é”®çº¦æŸ**: Epic 10.2çš„å¼‚æ­¥å¹¶è¡Œæ‰§è¡Œå¼•æ“(8å€æ€§èƒ½æå‡)å¿…é¡»ä¿ç•™

---

#### NFR2: å¯é æ€§è¦æ±‚ (Critical)

- âœ… æ•°æ®é›¶ä¸¢å¤±: æ‰€æœ‰Canvasæ“ä½œå‰è‡ªåŠ¨å¤‡ä»½
- âœ… æ•…éšœæ¢å¤: APIæ•…éšœæ—¶è‡ªåŠ¨é‡è¯•3æ¬¡
- âœ… å›æ»šæœºåˆ¶: é”™è¯¯æ“ä½œå¯åœ¨10ç§’å†…å›æ»š
- âœ… æœåŠ¡å¯ç”¨æ€§: â‰¥99% (æ¯æœˆåœæœºæ—¶é—´ <7å°æ—¶)

---

#### NFR3: å¯ç»´æŠ¤æ€§è¦æ±‚

- âœ… ä»£ç æµ‹è¯•è¦†ç›–ç‡: â‰¥85%
- âœ… æ–‡æ¡£å®Œæ•´æ€§: 100% (APIæ–‡æ¡£ã€ç”¨æˆ·æŒ‡å—ã€æ¶æ„æ–‡æ¡£)
- âœ… æ—¥å¿—å®Œæ•´æ€§: æ‰€æœ‰APIè°ƒç”¨å’ŒAgentæ‰§è¡Œæœ‰å®Œæ•´æ—¥å¿—
- âœ… ç›‘æ§å‘Šè­¦: é”™è¯¯ç‡>5%è‡ªåŠ¨å‘Šè­¦

---

#### NFR4: å…¼å®¹æ€§è¦æ±‚

| å¹³å°/è½¯ä»¶ | ç‰ˆæœ¬è¦æ±‚ | ä¼˜å…ˆçº§ |
|----------|---------|-------|
| Obsidian | â‰¥1.4.0 | Must Have |
| Windows | 10/11 | Must Have |
| macOS | â‰¥12.0 | Should Have |
| Linux | Ubuntu 20.04+ | Could Have |
| Python | 3.11+ | Must Have |
| Node.js | â‰¥18.0 | Must Have |
| Neo4j | 5.x | Must Have |
| Docker | â‰¥20.10 | Should Have |

---

#### NFR5: å®‰å…¨æ€§è¦æ±‚

- âœ… APIè®¤è¯: Bearer Tokenæˆ–API Key
- âœ… æ•æ„Ÿæ•°æ®åŠ å¯†: OpenAI API KeyåŠ å¯†å­˜å‚¨
- âœ… CORSé…ç½®: ä»…å…è®¸ `app://obsidian.md` è®¿é—®
- âœ… è¾“å…¥éªŒè¯: æ‰€æœ‰APIè¯·æ±‚å‚æ•°éªŒè¯,é˜²æ­¢æ³¨å…¥æ”»å‡»

---

#### NFR6: ç”¨æˆ·ä½“éªŒè¦æ±‚

- âœ… æ“ä½œå“åº”: UIæ“ä½œåé¦ˆ <500ms
- âœ… é”™è¯¯æç¤º: æ¸…æ™°ã€å‹å¥½ã€å¯æ“ä½œ (ä¸æ˜¾ç¤ºæŠ€æœ¯æ ˆé”™è¯¯)
- âœ… åŠ è½½çŠ¶æ€: é•¿æ“ä½œæ˜¾ç¤ºè¿›åº¦æ¡å’Œç™¾åˆ†æ¯”
- âœ… å¸®åŠ©æ–‡æ¡£: å†…ç½®å¸®åŠ©,å¿«æ·é”®Ctrl+? å‘¼å‡º

---

## ğŸ—ï¸ Section 3: æŠ€æœ¯æ¶æ„

### 3.1 æ•´ä½“æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Obsidian Desktop                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚         Canvas Learning Plugin (TypeScript)           â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚
â”‚  â”‚  â”‚ UI Layerâ”‚  â”‚ Commands â”‚  â”‚ Views (Review Panel) â”‚ â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚
â”‚  â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚  â”‚
â”‚  â”‚                    â”‚ HTTP/WebSocket                   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   FastAPI Backend (Python)                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚       ã€Layer 3ã€‘canvas-orchestrator (æ™ºèƒ½è·¯ç”±å±‚)     â”‚  â”‚
â”‚  â”‚  â€¢ è‡ªç„¶è¯­è¨€æ„å›¾è¯†åˆ«                                   â”‚  â”‚
â”‚  â”‚  â€¢ æ‰§è¡Œè®¡åˆ’ç”Ÿæˆ                                       â”‚  â”‚
â”‚  â”‚  â€¢ è°ƒç”¨LangGraphæ‰§è¡Œå¼•æ“                              â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                       â†“                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚     ã€Layer 4ã€‘LangGraph StateGraph (æ‰§è¡Œå¼•æ“)        â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚
â”‚  â”‚  â”‚        LangGraph Supervisor (å¹¶å‘è°ƒåº¦)           â”‚ â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â”‚  â”‚
â”‚  â”‚       â”‚          â”‚          â”‚          â”‚      â”‚      â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â” â”Œâ–¼â”€â”€â”€â”€â” â”‚  â”‚
â”‚  â”‚  â”‚basic-   â”‚â”‚deep-   â”‚â”‚scoring â”‚â”‚oral-   â”‚ â”‚...  â”‚ â”‚  â”‚
â”‚  â”‚  â”‚decomp   â”‚â”‚decomp  â”‚â”‚agent   â”‚â”‚explain â”‚ â”‚x12  â”‚ â”‚  â”‚
â”‚  â”‚  â”‚âœ… Tools â”‚â”‚âœ… Toolsâ”‚â”‚âœ… Toolsâ”‚â”‚âœ… Toolsâ”‚ â”‚     â”‚ â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜ â”‚  â”‚
â”‚  â”‚      â†“           â†“          â†“          â†“      â†“     â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚  â”‚
â”‚  â”‚  â”‚  å…±äº«Tools (æ‰€æœ‰Agentå¯ç›´æ¥è°ƒç”¨)              â”‚   â”‚  â”‚
â”‚  â”‚  â”‚  â€¢ write_to_canvas (FileLock)               â”‚   â”‚  â”‚
â”‚  â”‚  â”‚  â€¢ create_md_file                           â”‚   â”‚  â”‚
â”‚  â”‚  â”‚  â€¢ add_edge_to_canvas                       â”‚   â”‚  â”‚
â”‚  â”‚  â”‚  â€¢ update_ebbinghaus                        â”‚   â”‚  â”‚
â”‚  â”‚  â”‚  â€¢ query_graphiti_context                   â”‚   â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ Canvas   â”‚  â”‚ Ebbinghaus     â”‚  â”‚ .canvas-links    â”‚    â”‚
â”‚  â”‚ Utils    â”‚  â”‚ review_data    â”‚  â”‚ .json            â”‚    â”‚
â”‚  â”‚ (Python) â”‚  â”‚ .json          â”‚  â”‚                  â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Neo4j Knowledge Graph                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Graphiti Temporal Knowledge Graph                    â”‚  â”‚
â”‚  â”‚  â€¢ Canvas entities                                    â”‚  â”‚
â”‚  â”‚  â€¢ Node concepts                                      â”‚  â”‚
â”‚  â”‚  â€¢ Cross-canvas links (LINKED_TO, REQUIRES)          â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æ¶æ„è®¾è®¡è¯´æ˜ (åŒå±‚Supervisoræ¨¡å¼)**:

**æ ¸å¿ƒç†å¿µ**: ä¿ç•™canvas-orchestratorçš„æ™ºèƒ½è·¯ç”±èƒ½åŠ›,åŒæ—¶å¼•å…¥LangGraphçš„å¹¶å‘æ‰§è¡Œå¼•æ“

**Layer 3 - canvas-orchestrator (æ™ºèƒ½è·¯ç”±å±‚)**:
- **ä½œç”¨**: è‡ªç„¶è¯­è¨€æ„å›¾è¯†åˆ«ã€æ‰§è¡Œè®¡åˆ’ç”Ÿæˆã€è°ƒç”¨LangGraphæ‰§è¡Œ
- **ä¿ç•™åŸå› **: è¿™æ˜¯ç°æœ‰ç³»ç»Ÿçš„æ ¸å¿ƒä¼˜åŠ¿,èƒ½å‡†ç¡®ç†è§£ç”¨æˆ·æ„å›¾
- **ä½ç½®**: FastAPI Backendçš„å‰ç½®å¤„ç†å±‚

**Layer 4 - LangGraph StateGraph (æ‰§è¡Œå¼•æ“)**:
- **ä½œç”¨**: å¹¶å‘è°ƒåº¦ã€çŠ¶æ€ç®¡ç†ã€Agentç”Ÿå‘½å‘¨æœŸç®¡ç†
- **ä¼˜åŠ¿**: ä¿ç•™Epic 10.2çš„8å€æ€§èƒ½æå‡,å®ç°çœŸæ­£çš„å¼‚æ­¥å¹¶è¡Œæ‰§è¡Œ
- **åˆ›æ–°**: æ¯ä¸ªAgenté…å¤‡å·¥å…·,ç›´æ¥å†™å…¥Canvas,å®ç°0.5-1så¿«é€Ÿå“åº”

**å·¥å…·é…å¤‡ç­–ç•¥**:
- **åˆ†å¸ƒå¼å†™å…¥**: æ¯ä¸ªAgentç›´æ¥è°ƒç”¨write_to_canvaså·¥å…·,é¿å…é›†ä¸­å¼å†™å…¥çš„å»¶è¿Ÿ
- **FileLockä¿æŠ¤**: è·¨å¹³å°æ–‡ä»¶é”æœºåˆ¶,ç¡®ä¿å¤šä¸ªAgentå¹¶å‘å†™å…¥æ—¶çš„æ•°æ®ä¸€è‡´æ€§
- **å†™å…¥å†å²**: è®°å½•æ‰€æœ‰å†™å…¥æ“ä½œ,æ”¯æŒé”™è¯¯å›æ»š

**æ€§èƒ½å¯¹æ¯”**:

| æ–¹æ¡ˆ | é¦–ä¸ªèŠ‚ç‚¹å‡ºç°æ—¶é—´ | ç”¨æˆ·ä½“éªŒ | å®ç°å¤æ‚åº¦ |
|------|-----------------|---------|-----------|
| é›†ä¸­å¼å†™å…¥ (canvas_finalizer) | 8-10ç§’ | âŒ æ— å®æ—¶åé¦ˆ | ä½ |
| å·¥å…·é…å¤‡Agent (åˆ†å¸ƒå¼å†™å…¥) | 0.5-1ç§’ | âœ… å®æ—¶å¯è§ | ä¸­ (éœ€FileLock) |

### 3.2 LangGraphå¤šAgentæ¶æ„ (å·¥å…·é…å¤‡æ¨¡å¼)

#### 3.2.1 Stateå®šä¹‰

```python
from typing import TypedDict, Annotated, Literal
from langgraph.graph import MessagesState, add_messages

class CanvasLearningState(MessagesState):
    # åŸºç¡€ä¿¡æ¯
    canvas_path: str
    operation: str  # decompose/explain/score/review

    # Canvasæ•°æ®
    canvas_data: dict
    target_nodes: list[dict]

    # å…³è”å­¦ä¹ 
    linked_mode: bool
    linked_canvas_path: str | None
    textbook_context: list[dict]

    # Agentç»“æœ
    agent_results: dict
    generated_files: list[str]

    # è‰¾å®¾æµ©æ–¯å¤ä¹ 
    review_updates: list[dict]

    # è¿›åº¦è¿½è¸ª
    progress_data: dict | None

    # å†™å…¥å†å² (ç”¨äºå›æ»š)
    write_history: list[dict]

    # æœ€ç»ˆè¾“å‡º
    output_message: str
```

#### 3.2.2 åŒå±‚Supervisorè®¾è®¡

**Layer 3: canvas-orchestrator (æ™ºèƒ½è·¯ç”±å±‚)**

```python
class CanvasOrchestrator:
    """Layer 3: æ™ºèƒ½è·¯ç”±å±‚ - ä¿ç•™åŸæœ‰çš„è‡ªç„¶è¯­è¨€ç†è§£èƒ½åŠ›"""

    def process_command(self, user_input: str, canvas_path: str) -> dict:
        """å¤„ç†ç”¨æˆ·å‘½ä»¤,ç”Ÿæˆæ‰§è¡Œè®¡åˆ’"""
        # Step 1: æ„å›¾è¯†åˆ«
        intent = self.parse_intent(user_input)
        # intent = {
        #     "operation": "basic_decompose",
        #     "target_nodes": ["node-123", "node-456"],
        #     "linked_mode": True,
        #     "textbook_canvas": "ç¬¬3ç« -å‘é‡ç©ºé—´.canvas"
        # }

        # Step 2: ç”Ÿæˆæ‰§è¡Œè®¡åˆ’
        plan = self.create_execution_plan(intent, canvas_path)

        # Step 3: è°ƒç”¨LangGraphæ‰§è¡Œå¼•æ“
        result = await self.execute_with_langgraph(plan, canvas_path)

        return result

    def parse_intent(self, user_input: str) -> dict:
        """è‡ªç„¶è¯­è¨€æ„å›¾è¯†åˆ« (ä¿ç•™åŸæœ‰é€»è¾‘)"""
        # ç°æœ‰çš„canvas-orchestratoré€»è¾‘
        pass

    def create_execution_plan(self, intent: dict, canvas_path: str) -> dict:
        """ç”Ÿæˆæ‰§è¡Œè®¡åˆ’"""
        return {
            "operation": intent["operation"],
            "canvas_path": canvas_path,
            "target_nodes": self.load_target_nodes(canvas_path, intent["target_nodes"]),
            "linked_mode": intent.get("linked_mode", False),
            "textbook_context": self.load_textbook_context(intent) if intent.get("linked_mode") else []
        }
```

**Layer 4: LangGraph StateGraph (æ‰§è¡Œå¼•æ“)**

```python
from langgraph.graph import StateGraph, START, END
from langgraph.prebuilt import create_react_agent
from langgraph.types import Command
from langchain_openai import ChatOpenAI

# Step 1: å®šä¹‰å…±äº«Tools
@tool
def write_to_canvas(canvas_path: str, node_data: dict, config: RunnableConfig) -> str:
    """ç›´æ¥å†™å…¥CanvasèŠ‚ç‚¹ (å¸¦FileLockä¿æŠ¤)"""
    lock_file = f"{canvas_path}.lock"

    with FileLock(lock_file, timeout=10):
        # è¯»å–Canvas
        canvas_data = read_canvas(canvas_path)

        # æ·»åŠ èŠ‚ç‚¹
        canvas_data["nodes"].append(node_data)

        # å†™å…¥Canvas
        write_canvas(canvas_path, canvas_data)

        # è®°å½•å†™å…¥å†å² (ç”¨äºå›æ»š)
        state = config.configurable.get("state")
        if state:
            state["write_history"].append({
                "timestamp": datetime.now().isoformat(),
                "operation": "add_node",
                "node_id": node_data["id"],
                "canvas_path": canvas_path
            })

    return f"âœ… å·²æ·»åŠ èŠ‚ç‚¹ {node_data['id']} åˆ° {canvas_path}"

@tool
def create_md_file_for_canvas(
    concept: str,
    content: str,
    file_type: str,
    canvas_path: str,  # âœ… æ–°å¢å‚æ•°ï¼šCanvasæ–‡ä»¶è·¯å¾„
    config: RunnableConfig
) -> Dict[str, Any]:  # âœ… ä¿®æ”¹è¿”å›ç±»å‹
    """
    ä¸ºCanvasç”Ÿæˆè§£é‡Šæ–‡æ¡£ï¼ˆMarkdownæ–‡ä»¶ï¼‰

    âš ï¸ ä¿®å¤éœ€æ±‚1: è§£å†³Obsidianæ–‡ä»¶å¼•ç”¨è·¯å¾„é—®é¢˜

    Args:
        concept: æ¦‚å¿µåç§°
        content: æ–‡æ¡£å†…å®¹
        file_type: æ–‡æ¡£ç±»å‹ï¼ˆoral-explanation, clarification-path, etc.ï¼‰
        canvas_path: Canvasæ–‡ä»¶è·¯å¾„ï¼ˆç”¨äºè®¡ç®—Vaultç›¸å¯¹è·¯å¾„ï¼‰
        config: Runnableé…ç½®

    Returns:
        åŒ…å«vault_path, timestamp, filenameçš„å­—å…¸
        - vault_path: Vaultç›¸å¯¹è·¯å¾„ï¼ˆç”¨äºCanvas FILEèŠ‚ç‚¹å¼•ç”¨ï¼‰
        - timestamp: æ—¶é—´æˆ³ï¼ˆç¡®ä¿Canvaså¼•ç”¨ä¸å®é™…æ–‡ä»¶ä¸€è‡´ï¼‰
        - filename: æ–‡ä»¶å
        - full_path: å®Œæ•´æ–‡ä»¶ç³»ç»Ÿè·¯å¾„
        - success: æ˜¯å¦æˆåŠŸ

    Example:
        canvas_path = "Canvas/Math53/ç¦»æ•£æ•°å­¦.canvas"
        result = create_md_file_for_canvas("é€†å¦å‘½é¢˜", content, "å£è¯­åŒ–è§£é‡Š", canvas_path, config)
        # result["vault_path"] = "Canvas/Math53/é€†å¦å‘½é¢˜-å£è¯­åŒ–è§£é‡Š-20250115143025.md"
        # ç”¨äºCanvas FILEèŠ‚ç‚¹: {"type": "file", "file": result["vault_path"]}
    """
    # âœ… è®¡ç®—Canvasæ‰€åœ¨ç›®å½•ï¼ˆVaultç›¸å¯¹è·¯å¾„ï¼‰
    canvas_dir = os.path.dirname(canvas_path)  # "Canvas/Math53"

    timestamp = datetime.now().strftime("%Y%m%d%H%M%S")
    filename = f"{concept}-{file_type}-{timestamp}.md"
    vault_relative_path = os.path.join(canvas_dir, filename)
    # ç»“æœ: "Canvas/Math53/é€†å¦å‘½é¢˜-å£è¯­åŒ–è§£é‡Š-20250115143025.md"

    # âœ… è·å–Vaultæ ¹ç›®å½•
    vault_root = config.configurable.get("vault_root") or os.getenv("OBSIDIAN_VAULT_ROOT")
    if not vault_root:
        raise ValueError("Vault root not configured in config.configurable['vault_root'] or OBSIDIAN_VAULT_ROOT env var")

    full_path = os.path.join(vault_root, vault_relative_path)

    # âœ… å†™å…¥æ–‡ä»¶
    os.makedirs(os.path.dirname(full_path), exist_ok=True)
    with open(full_path, 'w', encoding='utf-8') as f:
        f.write(content)

    # è®°å½•åˆ°state
    state = config.configurable.get("state")
    if state:
        state["generated_files"].append(vault_relative_path)

    return {
        "vault_path": vault_relative_path,  # âœ… Vaultç›¸å¯¹è·¯å¾„ï¼ˆç”¨äºCanvas FILEèŠ‚ç‚¹ï¼‰
        "timestamp": timestamp,              # âœ… æ—¶é—´æˆ³ä¸€è‡´æ€§
        "filename": filename,
        "full_path": full_path,
        "success": True
    }

# ========================================
# âœ… æ–°å¢å·¥å…·ç»„: 3å±‚è®°å¿†ç³»ç»Ÿè°ƒåº¦å·¥å…·
# ä¿®å¤éœ€æ±‚2: æ˜ç¡®è®°å¿†ç³»ç»Ÿè°ƒåº¦æ—¶æœº
# ä¿®å¤éœ€æ±‚3: æ£€éªŒç™½æ¿ç”Ÿæˆæ—¶è°ƒç”¨Graphitiè·å–ä¸Šä¸‹æ–‡
# ========================================

@tool
def store_to_graphiti_memory(
    session_id: str,
    operation_type: str,  # "decomposition", "scoring", "explanation", "verification_board", etc.
    canvas_path: str,
    node_data: Dict[str, Any],
    config: RunnableConfig
) -> str:
    """
    å­˜å‚¨Canvasæ“ä½œåˆ°GraphitiçŸ¥è¯†å›¾è°±

    âš ï¸ ä¿®å¤éœ€æ±‚2: è®°å¿†ç³»ç»Ÿè°ƒåº¦æ—¶æœº

    è°ƒåº¦æ—¶æœº:
    1. é—®é¢˜æ‹†è§£å: operation_type="decomposition"
    2. è¯„åˆ†å®Œæˆå: operation_type="scoring"
    3. ç”Ÿæˆè§£é‡Šæ–‡æ¡£å: operation_type="explanation"
    4. ç”Ÿæˆæ£€éªŒç™½æ¿å: operation_type="verification_board"
    5. è·¨Canvaså…³è”æ—¶: operation_type="cross_canvas_link"

    Args:
        session_id: å­¦ä¹ ä¼šè¯ID
        operation_type: æ“ä½œç±»å‹
        canvas_path: Canvasæ–‡ä»¶è·¯å¾„
        node_data: èŠ‚ç‚¹æ•°æ®ï¼ˆåŒ…å«èŠ‚ç‚¹IDã€å†…å®¹ã€é¢œè‰²ç­‰ï¼‰
        config: Runnableé…ç½®

    Returns:
        Graphitiå­˜å‚¨ç»“æœæ¶ˆæ¯
    """
    episode_content = f"""
Canvaså­¦ä¹ æ“ä½œè®°å½•:
- ä¼šè¯ID: {session_id}
- æ“ä½œç±»å‹: {operation_type}
- Canvas: {canvas_path}
- èŠ‚ç‚¹æ•°æ®: {json.dumps(node_data, ensure_ascii=False, indent=2)}
- æ—¶é—´æˆ³: {datetime.now().isoformat()}
"""

    # è°ƒç”¨MCP Graphitiå·¥å…·
    result = mcp__graphiti_memory__add_episode(content=episode_content)

    # è®°å½•åˆ°state
    state = config.configurable.get("state")
    if state and "memory_records" in state:
        state["memory_records"].append({
            "type": "graphiti",
            "operation": operation_type,
            "timestamp": datetime.now().isoformat()
        })

    return f"âœ… å·²å­˜å‚¨åˆ°GraphitiçŸ¥è¯†å›¾è°±: {result}"

@tool
def store_to_temporal_memory(
    session_id: str,
    event_type: str,
    timestamp: datetime,
    metadata: Dict[str, Any],
    config: RunnableConfig
) -> str:
    """
    å­˜å‚¨Canvasæ“ä½œåˆ°æ—¶åºè®°å¿†

    âš ï¸ ä¿®å¤éœ€æ±‚2: æ—¶åºè®°å¿†è°ƒåº¦

    è°ƒåº¦æ—¶æœº: ä¸GraphitiåŒæ­¥è°ƒåº¦ï¼ˆæ‰€æœ‰Canvasæ“ä½œï¼‰

    Args:
        session_id: å­¦ä¹ ä¼šè¯ID
        event_type: äº‹ä»¶ç±»å‹
        timestamp: äº‹ä»¶æ—¶é—´æˆ³
        metadata: å…ƒæ•°æ®ï¼ˆCanvasè·¯å¾„ã€èŠ‚ç‚¹ä¿¡æ¯ç­‰ï¼‰
        config: Runnableé…ç½®

    Returns:
        Temporalå­˜å‚¨ç»“æœæ¶ˆæ¯
    """
    from memory_system.unified_memory_interface import UnifiedMemoryInterface

    memory = UnifiedMemoryInterface()
    memory.temporal_manager.store_event(
        session_id=session_id,
        event_type=event_type,
        timestamp=timestamp,
        metadata=metadata
    )

    # è®°å½•åˆ°state
    state = config.configurable.get("state")
    if state and "memory_records" in state:
        state["memory_records"].append({
            "type": "temporal",
            "event_type": event_type,
            "timestamp": timestamp.isoformat()
        })

    return f"âœ… å·²å­˜å‚¨åˆ°Temporalæ—¶åºè®°å¿†"

@tool
def store_to_semantic_memory(
    session_id: str,
    document_path: str,
    content: str,
    metadata: Dict[str, Any],
    config: RunnableConfig
) -> str:
    """
    å­˜å‚¨æ–‡æ¡£å‘é‡åˆ°è¯­ä¹‰è®°å¿†

    âš ï¸ ä¿®å¤éœ€æ±‚2: è¯­ä¹‰è®°å¿†è°ƒåº¦

    è°ƒåº¦æ—¶æœº: ä»…åœ¨ç”Ÿæˆè§£é‡Šæ–‡æ¡£åè°ƒç”¨ï¼ˆoperation_type="explanation"ï¼‰

    Args:
        session_id: å­¦ä¹ ä¼šè¯ID
        document_path: æ–‡æ¡£è·¯å¾„ï¼ˆVaultç›¸å¯¹è·¯å¾„ï¼‰
        content: æ–‡æ¡£å†…å®¹
        metadata: å…ƒæ•°æ®
        config: Runnableé…ç½®

    Returns:
        Semanticå­˜å‚¨ç»“æœæ¶ˆæ¯
    """
    from memory_system.unified_memory_interface import UnifiedMemoryInterface

    memory = UnifiedMemoryInterface()
    memory.semantic_manager.store_document_vector(
        session_id=session_id,
        document_path=document_path,
        content=content,
        metadata=metadata
    )

    # è®°å½•åˆ°state
    state = config.configurable.get("state")
    if state and "memory_records" in state:
        state["memory_records"].append({
            "type": "semantic",
            "document_path": document_path,
            "timestamp": datetime.now().isoformat()
        })

    return f"âœ… å·²å­˜å‚¨åˆ°Semanticè¯­ä¹‰è®°å¿†: {document_path}"

@tool
def query_graphiti_for_verification(
    concept: str,
    user_understanding: str,
    canvas_path: str,
    config: RunnableConfig
) -> Dict[str, Any]:
    """
    æŸ¥è¯¢Graphitiä»¥ç”Ÿæˆé«˜å…³è”åº¦æ£€éªŒé—®é¢˜

    âš ï¸ ä¿®å¤éœ€æ±‚3: æ™ºèƒ½æ£€éªŒç™½æ¿ç”Ÿæˆæœºåˆ¶

    ç”¨é€”: åœ¨ç”Ÿæˆæ£€éªŒç™½æ¿æ—¶ï¼Œå…ˆæŸ¥è¯¢Graphitiè·å–ä¸Šä¸‹æ–‡ï¼Œå†ä¼ é€’ç»™verification-question-agent

    æŸ¥è¯¢å†…å®¹:
    1. ç›¸å…³æ¦‚å¿µ: æŸ¥æ‰¾ä¸ç›®æ ‡æ¦‚å¿µç›¸å…³çš„å…¶ä»–æ¦‚å¿µ
    2. å†å²ç›²åŒº: æŸ¥è¯¢ç”¨æˆ·åœ¨æ­¤æ¦‚å¿µä¸Šçš„å†å²ç†è§£ç›²åŒº
    3. æ¦‚å¿µå…³ç³»: æŸ¥è¯¢æ¦‚å¿µä¹‹é—´çš„å…³ç³»ï¼ˆå‰ç½®çŸ¥è¯†ã€ç­‰ä»·å…³ç³»ç­‰ï¼‰

    è¿”å›çš„ä¸Šä¸‹æ–‡å°†ä½œä¸ºverification-question-agentçš„graphiti_contextå­—æ®µè¾“å…¥

    Args:
        concept: æ¦‚å¿µåç§°
        user_understanding: ç”¨æˆ·å½“å‰ç†è§£ï¼ˆé»„è‰²èŠ‚ç‚¹å†…å®¹ï¼‰
        canvas_path: Canvasæ–‡ä»¶è·¯å¾„
        config: Runnableé…ç½®

    Returns:
        åŒ…å«related_concepts, historical_blind_spots, concept_relationshipsçš„å­—å…¸

    Example:
        context = query_graphiti_for_verification("é€†å¦å‘½é¢˜", user_understanding, canvas_path, config)
        # context = {
        #   "related_concepts": [{"name": "å‘½é¢˜é€»è¾‘", "relationship": "prerequisite_of", "score": 0.9}],
        #   "historical_blind_spots": [{"concept": "å¦å‘½é¢˜ vs é€†å¦å‘½é¢˜", "frequency": 3}],
        #   "concept_relationships": [{"from": "é€†å¦å‘½é¢˜", "to": "ç­‰ä»·å‘½é¢˜", "type": "is_a"}]
        # }
        #
        # ç„¶åä¼ é€’ç»™verification-question-agent:
        # agent_input = {"nodes": [...], "graphiti_context": context}
    """
    session_id = config.configurable.get("session_id")

    # 1. æŸ¥è¯¢ç›¸å…³æ¦‚å¿µ
    related_concepts_raw = mcp__graphiti_memory__search_memories(
        query=f"concept:{concept} related prerequisite"
    )

    # 2. æŸ¥è¯¢å†å²ç›²åŒº
    blind_spots_raw = mcp__graphiti_memory__search_memories(
        query=f"user:{session_id} blind_spot error misconception {concept}"
    )

    # 3. æŸ¥è¯¢æ¦‚å¿µå…³ç³»
    relationships_raw = mcp__graphiti_memory__search_memories(
        query=f"relationship {concept} equivalent prerequisite contrast"
    )

    # è§£æå¹¶ç»“æ„åŒ–ç»“æœ
    related_concepts = [
        {
            "name": item.get("concept", ""),
            "relationship": item.get("relationship_type", "related_to"),
            "score": item.get("relevance_score", 0.5)
        }
        for item in related_concepts_raw[:5]  # å–Top 5
    ]

    historical_blind_spots = [
        {
            "concept": item.get("blind_spot_concept", ""),
            "frequency": item.get("occurrence_count", 1),
            "last_occurrence": item.get("last_seen", "")
        }
        for item in blind_spots_raw[:3]  # å–Top 3
    ]

    concept_relationships = [
        {
            "from": item.get("source_concept", concept),
            "to": item.get("target_concept", ""),
            "type": item.get("relationship_type", "related_to"),
            "strength": item.get("strength", 0.5)
        }
        for item in relationships_raw[:5]  # å–Top 5
    ]

    return {
        "related_concepts": related_concepts,
        "historical_blind_spots": historical_blind_spots,
        "concept_relationships": concept_relationships,
        "suggested_question_types": ["definition", "contrast", "application", "reasoning"],
        "query_metadata": {
            "concept": concept,
            "session_id": session_id,
            "canvas_path": canvas_path,
            "query_timestamp": datetime.now().isoformat()
        }
    }

@tool
def add_edge_to_canvas(canvas_path: str, from_id: str, to_id: str, config: RunnableConfig) -> str:
    """æ·»åŠ Canvasè¾¹è¿æ¥"""
    lock_file = f"{canvas_path}.lock"

    with FileLock(lock_file, timeout=10):
        canvas_data = read_canvas(canvas_path)
        canvas_data["edges"].append({
            "id": f"edge-{from_id}-{to_id}",
            "fromNode": from_id,
            "toNode": to_id
        })
        write_canvas(canvas_path, canvas_data)

    return f"âœ… å·²è¿æ¥èŠ‚ç‚¹ {from_id} â†’ {to_id}"

# æ‰€æœ‰Agentå…±äº«çš„å·¥å…·é›†
# âœ… ä¿®å¤åçš„å…±äº«å·¥å…·åˆ—è¡¨ï¼ˆåŒ…å«3ä¸ªéœ€æ±‚çš„æ‰€æœ‰ä¿®å¤ï¼‰
shared_tools = [
    write_to_canvas,
    create_md_file_for_canvas,  # âœ… ä¿®å¤éœ€æ±‚1: æ”¯æŒVaultç›¸å¯¹è·¯å¾„
    add_edge_to_canvas,
    update_ebbinghaus,
    query_graphiti_context,
    # âœ… ä¿®å¤éœ€æ±‚2&3: 3å±‚è®°å¿†ç³»ç»Ÿè°ƒåº¦å·¥å…·
    store_to_graphiti_memory,
    store_to_temporal_memory,
    store_to_semantic_memory,
    query_graphiti_for_verification  # âœ… ä¿®å¤éœ€æ±‚3: æ£€éªŒç™½æ¿Graphitiä¸Šä¸‹æ–‡æŸ¥è¯¢
]

# ========================================
# å·¥å…·é—´åè°ƒæœºåˆ¶ä¸èŒè´£è¾¹ç•Œ (æ–°å¢ - v1.1.3)
# ========================================

**èƒŒæ™¯**: Canvaså­¦ä¹ ç³»ç»Ÿé‡‡ç”¨åŒé‡è®°å¿†æ¶æ„ï¼š
1. **LangGraph Checkpointer** (æ¡†æ¶è‡ªå¸¦): æŒä¹…åŒ–Agentæ‰§è¡ŒçŠ¶æ€å’Œå¯¹è¯ä¸Šä¸‹æ–‡
2. **3å±‚è®°å¿†ç³»ç»Ÿ** (ä¸šåŠ¡å®šåˆ¶): GraphitiçŸ¥è¯†å›¾è°± + Temporalæ—¶åºè®°å¿† + Semanticè¯­ä¹‰è®°å¿†

**è®¾è®¡åŸåˆ™**: èŒè´£æ˜ç¡®ï¼Œé¿å…æ•°æ®å†—ä½™ï¼Œç¡®ä¿ä¸€è‡´æ€§

---

## LangGraph Checkpointer (æ¡†æ¶å±‚è®°å¿†)

**èŒè´£èŒƒå›´**:
- âœ… å­˜å‚¨CanvasLearningStateå¯¹è±¡ï¼ˆAgentæ‰§è¡Œçš„ä¸­é—´çŠ¶æ€ï¼‰
- âœ… æ”¯æŒå¤šè½®å¯¹è¯ä¸Šä¸‹æ–‡æŒä¹…åŒ–ï¼ˆthread_idç»´åº¦ï¼‰
- âœ… æä¾›å›æ»šèƒ½åŠ›ï¼ˆé€šè¿‡checkpoint IDå’Œtimestampï¼‰
- âœ… è‡ªåŠ¨ç®¡ç†ï¼ˆLangGraphæ¡†æ¶è‡ªåŠ¨è°ƒç”¨ï¼Œå¼€å‘è€…æ— éœ€æ‰‹åŠ¨è§¦å‘ï¼‰

**ä¸å­˜å‚¨**:
- âŒ Canvasæ–‡ä»¶å†…å®¹ï¼ˆç”±write_to_canvasç›´æ¥å†™å…¥æ–‡ä»¶ç³»ç»Ÿï¼‰
- âŒ çŸ¥è¯†å›¾è°±æ•°æ®ï¼ˆç”±Graphitiç®¡ç†ï¼‰
- âŒ å­¦ä¹ äº‹ä»¶æ—¶é—´çº¿ï¼ˆç”±Temporalè®°å¿†ç®¡ç†ï¼‰
- âŒ æ–‡æ¡£å‘é‡ï¼ˆç”±Semanticè®°å¿†ç®¡ç†ï¼‰

**æ•°æ®ç¤ºä¾‹**:
```json
{
  "checkpoint_id": "1ef4f797-8335-6428-8001-8a1503f9b875",
  "thread_id": "canvas_ç¦»æ•£æ•°å­¦_session_20250115_143025",
  "timestamp": "2025-01-15T14:30:25Z",
  "state": {
    "session_id": "session_20250115_143025",
    "canvas_path": "Canvas/Math53/ç¦»æ•£æ•°å­¦.canvas",
    "current_concept": "é€†å¦å‘½é¢˜",
    "last_operation": "decomposition",
    "decomposition_results": ["ä»€ä¹ˆæ˜¯é€†å¦å‘½é¢˜ï¼Ÿ", "å®ƒä¸åŸå‘½é¢˜æœ‰ä½•å…³ç³»ï¼Ÿ"],
    "write_history": [...]
  }
}
```

**ä½•æ—¶ä½¿ç”¨**:
- AgentèŠ‚ç‚¹æ‰§è¡Œå®Œæ¯•è‡ªåŠ¨è§¦å‘ï¼ˆLangGraphæ¡†æ¶è¡Œä¸ºï¼‰
- å¤šè½®å¯¹è¯éœ€è¦æ¢å¤ä¸Šä¸‹æ–‡æ—¶è¯»å–ï¼ˆé€šè¿‡thread_idï¼‰
- å›æ»šæ“ä½œæ—¶æŸ¥è¯¢å†å²checkpoint

---

## GraphitiçŸ¥è¯†å›¾è°± (ä¸šåŠ¡å±‚è®°å¿† - è¯­ä¹‰å…³ç³»)

**èŒè´£èŒƒå›´**:
- âœ… å­˜å‚¨CanvasèŠ‚ç‚¹çš„è¯­ä¹‰å…³ç³»ï¼ˆæ¦‚å¿µå…³è”ã€å‰ç½®çŸ¥è¯†ã€ç›¸ä¼¼æ¦‚å¿µï¼‰
- âœ… æ”¯æŒè·¨CanvasçŸ¥è¯†å›¾è°±æŸ¥è¯¢ï¼ˆEpic 16æ ¸å¿ƒåŠŸèƒ½ï¼‰
- âœ… æ”¯æŒæ™ºèƒ½æ¨èï¼ˆç›¸å…³æ¦‚å¿µã€å‰ç½®çŸ¥è¯†æ¨èï¼‰
- âœ… æ”¯æŒæ£€éªŒç™½æ¿ç”Ÿæˆæ—¶çš„ä¸Šä¸‹æ–‡æŸ¥è¯¢

**ä¸å­˜å‚¨**:
- âŒ Agentæ‰§è¡ŒçŠ¶æ€ï¼ˆç”±LangGraph checkpointerç®¡ç†ï¼‰
- âŒ æ–‡æ¡£å®Œæ•´å†…å®¹ï¼ˆä»…å­˜å‚¨å…³è”å…³ç³»ï¼Œå†…å®¹ç”±Semanticç®¡ç†ï¼‰

**æ•°æ®ç¤ºä¾‹**:
```cypher
// èŠ‚ç‚¹
(n1:Concept {name: "é€†å¦å‘½é¢˜", canvas: "ç¦»æ•£æ•°å­¦.canvas"})
(n2:Concept {name: "åŸå‘½é¢˜", canvas: "ç¦»æ•£æ•°å­¦.canvas"})
(n3:Concept {name: "é€†å¦å‘½é¢˜", canvas: "æ•°ç†é€»è¾‘.canvas"})

// å…³ç³»
(n1)-[:RELATED_TO {relation_type: "é€»è¾‘ç­‰ä»·"}]->(n2)
(n1)-[:SIMILAR_TO {similarity: 0.95}]->(n3)
```

**ä½•æ—¶è°ƒç”¨**:
- `store_to_graphiti_memory()`: æ¯æ¬¡Canvasæ“ä½œåï¼ˆæ‹†è§£ã€è¯„åˆ†ã€ç”Ÿæˆè§£é‡Šã€è·¨Canvaså…³è”ï¼‰
- `query_graphiti_for_verification()`: ç”Ÿæˆæ£€éªŒç™½æ¿å‰æŸ¥è¯¢ç›¸å…³æ¦‚å¿µ
- `query_graphiti_context()`: Agentéœ€è¦ä¸Šä¸‹æ–‡æ—¶æŸ¥è¯¢

---

## Temporalæ—¶åºè®°å¿† (ä¸šåŠ¡å±‚è®°å¿† - å­¦ä¹ å†ç¨‹)

**èŒè´£èŒƒå›´**:
- âœ… å­˜å‚¨å­¦ä¹ äº‹ä»¶æ—¶é—´çº¿ï¼ˆæ‹†è§£æ—¶é—´ã€è¯„åˆ†æ—¶é—´ã€å¤ä¹ æ—¶é—´ï¼‰
- âœ… æ”¯æŒå­¦ä¹ è¿›åº¦åˆ†æå’Œç»Ÿè®¡ï¼ˆEpic 14å¤ä¹ ç³»ç»Ÿä¾èµ–ï¼‰
- âœ… æ”¯æŒå­¦ä¹ ä¹ æƒ¯åˆ†æï¼ˆå­¦ä¹ æ—¶æ®µã€å­¦ä¹ é¢‘ç‡ï¼‰

**ä¸å­˜å‚¨**:
- âŒ äº‹ä»¶çš„è¯¦ç»†å†…å®¹ï¼ˆä»…å­˜å‚¨å…ƒæ•°æ®å’Œæ—¶é—´æˆ³ï¼‰
- âŒ çŸ¥è¯†å›¾è°±å…³ç³»ï¼ˆç”±Graphitiç®¡ç†ï¼‰

**æ•°æ®ç¤ºä¾‹**:
```json
{
  "event_id": "evt_20250115_143025_001",
  "session_id": "session_20250115_143025",
  "event_type": "decomposition_completed",
  "timestamp": "2025-01-15T14:30:25Z",
  "metadata": {
    "canvas_path": "ç¦»æ•£æ•°å­¦.canvas",
    "concept": "é€†å¦å‘½é¢˜",
    "question_count": 5
  }
}
```

**ä½•æ—¶è°ƒç”¨**:
- `store_to_temporal_memory()`: æ¯æ¬¡Canvasæ“ä½œåè®°å½•äº‹ä»¶

---

## Semanticè¯­ä¹‰è®°å¿† (ä¸šåŠ¡å±‚è®°å¿† - æ–‡æ¡£å‘é‡)

**èŒè´£èŒƒå›´**:
- âœ… å­˜å‚¨AIç”Ÿæˆæ–‡æ¡£çš„å‘é‡è¡¨ç¤ºï¼ˆè§£é‡Šæ–‡æ¡£embeddingsï¼‰
- âœ… æ”¯æŒè¯­ä¹‰ç›¸ä¼¼åº¦æ£€ç´¢ï¼ˆæ‰¾ç›¸ä¼¼è§£é‡Šï¼‰
- âœ… æ”¯æŒæ–‡æ¡£æ¨èï¼ˆ"è¿™ä¸ªè§£é‡Šå¯èƒ½å¯¹ä½ æœ‰å¸®åŠ©"ï¼‰

**ä¸å­˜å‚¨**:
- âŒ CanvasèŠ‚ç‚¹å†…å®¹ï¼ˆèŠ‚ç‚¹å†…å®¹åœ¨Canvasæ–‡ä»¶ä¸­ï¼‰
- âŒ çŸ¥è¯†å›¾è°±ï¼ˆç”±Graphitiç®¡ç†ï¼‰

**æ•°æ®ç¤ºä¾‹**:
```json
{
  "document_id": "doc_é€†å¦å‘½é¢˜_å£è¯­åŒ–è§£é‡Š_20250115143025",
  "file_path": "Canvas/Math53/é€†å¦å‘½é¢˜-å£è¯­åŒ–è§£é‡Š-20250115143025.md",
  "embedding": [0.123, -0.456, ...],  // 1536ç»´å‘é‡
  "metadata": {
    "concept": "é€†å¦å‘½é¢˜",
    "agent": "oral-explanation",
    "word_count": 950
  }
}
```

**ä½•æ—¶è°ƒç”¨**:
- `store_to_semantic_memory()`: ä»…åœ¨ç”Ÿæˆè§£é‡Šæ–‡æ¡£å

---

## è°ƒç”¨æ—¶åºå›¾

```
Agent Nodeæ‰§è¡Œ
    â†“
1. Canvasæ“ä½œ (write_to_canvas, create_md_file_for_canvas)
    â†“ â† å…³é”®è·¯å¾„ï¼Œå¤±è´¥åˆ™æ•´ä¸ªæ“ä½œå¤±è´¥
2. ä¸šåŠ¡å±‚è®°å¿†å­˜å‚¨ (éå…³é”®è·¯å¾„ï¼Œæœ€ç»ˆä¸€è‡´æ€§)
    â”œâ”€â†’ store_to_graphiti_memory()
    â”œâ”€â†’ store_to_temporal_memory()
    â””â”€â†’ store_to_semantic_memory() [ä»…è§£é‡Šæ–‡æ¡£]
    â†“ â† å¤±è´¥ä»…è®°å½•æ—¥å¿—ï¼Œä¸é˜»å¡
3. Agentè¿”å›new_state
    â†“
LangGraphæ¡†æ¶è‡ªåŠ¨æŒä¹…åŒ–Stateåˆ°Checkpointer
    â†“
æ“ä½œå®Œæˆ
```

---

## ä¸€è‡´æ€§ä¿è¯

**å¼ºä¸€è‡´æ€§**:
- Canvasæ–‡ä»¶å†™å…¥ â†” LangGraph Checkpointer State
  - æœºåˆ¶: åœ¨äº‹åŠ¡å†…å®Œæˆï¼Œwrite_to_canvaså¤±è´¥åˆ™LangGraphè‡ªåŠ¨å›æ»šState

**æœ€ç»ˆä¸€è‡´æ€§**:
- Canvasæ–‡ä»¶ â†” Graphiti/Temporal/Semantic
  - æœºåˆ¶: å¼‚æ­¥å­˜å‚¨ + é‡è¯•æœºåˆ¶ + å®šæœŸå¯¹è´¦ä»»åŠ¡

**å†²çªè§£å†³**:
- å¦‚æœGraphiti/Temporal/Semanticå­˜å‚¨å¤±è´¥ï¼Œç³»ç»Ÿè¡Œä¸ºï¼š
  1. è®°å½•é”™è¯¯æ—¥å¿—ï¼ˆåŒ…å«session_id, operation_type, error_messageï¼‰
  2. ä¸é˜»å¡Canvasæ“ä½œå’Œç”¨æˆ·ä½“éªŒ
  3. åå°å¼‚æ­¥é‡è¯•ï¼ˆæŒ‡æ•°é€€é¿ç­–ç•¥ï¼‰
  4. ç®¡ç†å‘˜å¯æŸ¥çœ‹å¤±è´¥é˜Ÿåˆ—ï¼Œæ‰‹åŠ¨è§¦å‘é‡è¯•

---

# Step 2: åˆ›å»ºå·¥å…·é…å¤‡çš„AgentèŠ‚ç‚¹
model = ChatOpenAI(model="gpt-4")

# Agent 1: basic-decomposition (é…å¤‡å·¥å…·)
basic_decomposition_agent = create_react_agent(
    model=model,
    tools=shared_tools,
    state_modifier="""ä½ æ˜¯åŸºç¡€æ‹†è§£Agentã€‚

    ä»»åŠ¡: ä¸ºçº¢è‰²èŠ‚ç‚¹ç”Ÿæˆ3-7ä¸ªåŸºç¡€å¼•å¯¼é—®é¢˜ã€‚

    âš ï¸ é‡è¦: ç”Ÿæˆé—®é¢˜å,ç«‹å³è°ƒç”¨write_to_canvaså·¥å…·å°†é—®é¢˜èŠ‚ç‚¹å†™å…¥Canvas!

    å·¥å…·ä½¿ç”¨ç¤ºä¾‹:
    1. ç”Ÿæˆé—®é¢˜åˆ—è¡¨
    2. å¯¹æ¯ä¸ªé—®é¢˜è°ƒç”¨ write_to_canvas(canvas_path, {
        "id": "question-abc123",
        "type": "text",
        "text": "ä»€ä¹ˆæ˜¯é€†å¦å‘½é¢˜?",
        "color": "1",
        "x": 100, "y": 200,
        "width": 300, "height": 80
    })
    3. è°ƒç”¨ add_edge_to_canvas è¿æ¥åŸèŠ‚ç‚¹å’Œé—®é¢˜èŠ‚ç‚¹

    è¿”å›: ç”Ÿæˆçš„é—®é¢˜åˆ—è¡¨
    """
)

# Agent 2: deep-decomposition (é…å¤‡å·¥å…·)
deep_decomposition_agent = create_react_agent(
    model=model,
    tools=shared_tools,
    state_modifier="""ä½ æ˜¯æ·±åº¦æ‹†è§£Agentã€‚

    ä»»åŠ¡: ä¸ºç´«è‰²èŠ‚ç‚¹ç”Ÿæˆæ·±åº¦æ£€éªŒé—®é¢˜,æš´éœ²ç†è§£ç›²åŒºã€‚

    âš ï¸ é‡è¦: ç«‹å³è°ƒç”¨write_to_canvaså†™å…¥é—®é¢˜èŠ‚ç‚¹!
    """
)

# Agent 3: oral-explanation (é…å¤‡å·¥å…·)
oral_explanation_agent = create_react_agent(
    model=model,
    tools=shared_tools,
    state_modifier="""ä½ æ˜¯å£è¯­åŒ–è§£é‡ŠAgentã€‚

    ä»»åŠ¡: ç”Ÿæˆ800-1200è¯çš„å£è¯­åŒ–è§£é‡Šæ–‡æ¡£ã€‚

    âš ï¸ é‡è¦æ­¥éª¤:
    1. ç”Ÿæˆè§£é‡Šå†…å®¹
    2. è°ƒç”¨ create_md_file åˆ›å»ºæ–‡æ¡£
    3. è°ƒç”¨ write_to_canvas åˆ›å»ºè“è‰²FILEèŠ‚ç‚¹
    4. è°ƒç”¨ add_edge_to_canvas è¿æ¥åŸèŠ‚ç‚¹å’ŒFILEèŠ‚ç‚¹

    è¿”å›: ç”Ÿæˆçš„æ–‡æ¡£è·¯å¾„
    """
)

# Agent 4: scoring-agent (é…å¤‡å·¥å…·)
scoring_agent = create_react_agent(
    model=model,
    tools=shared_tools,
    state_modifier="""ä½ æ˜¯è¯„åˆ†Agentã€‚

    ä»»åŠ¡: å¯¹é»„è‰²èŠ‚ç‚¹è¿›è¡Œ4ç»´è¯„åˆ† (å‡†ç¡®æ€§ã€å…·è±¡æ€§ã€å®Œæ•´æ€§ã€åŸåˆ›æ€§)ã€‚

    âš ï¸ é‡è¦: è¯„åˆ†åç«‹å³è°ƒç”¨write_to_canvasæ›´æ–°èŠ‚ç‚¹é¢œè‰²!

    é¢œè‰²è§„åˆ™:
    - â‰¥80åˆ† â†’ color="2" (ç»¿è‰²)
    - 60-79åˆ† â†’ color="3" (ç´«è‰²)
    - <60åˆ† â†’ color="1" (çº¢è‰²)

    è¿”å›: è¯„åˆ†ç»“æœå’Œå»ºè®®
    """
)

# ... å…¶ä»–8ä¸ªAgent (åŒæ ·é…å¤‡å·¥å…·)

# Step 3: æ„å»ºLangGraph StateGraph
builder = StateGraph(CanvasLearningState)

# æ·»åŠ AgentèŠ‚ç‚¹
builder.add_node("basic_decomposition", basic_decomposition_agent)
builder.add_node("deep_decomposition", deep_decomposition_agent)
builder.add_node("oral_explanation", oral_explanation_agent)
builder.add_node("scoring_agent", scoring_agent)
# ... æ·»åŠ å…¶ä»–8ä¸ªAgentèŠ‚ç‚¹

# Supervisorè·¯ç”±é€»è¾‘ (ç”±canvas-orchestratorçš„planå†³å®š)
def supervisor_router(state: CanvasLearningState) -> Command[Literal[
    "basic_decomposition",
    "deep_decomposition",
    "scoring_agent",
    "oral_explanation",
    # ... å…¶ä»–Agent
    END
]]:
    """LangGraph Supervisor - æ ¹æ®canvas-orchestratorçš„è®¡åˆ’è·¯ç”±åˆ°å¯¹åº”Agent"""
    operation = state["operation"]

    routing_map = {
        "basic_decompose": "basic_decomposition",
        "deep_decompose": "deep_decomposition",
        "score": "scoring_agent",
        "oral_explain": "oral_explanation",
        # ... å…¶ä»–æ˜ å°„
    }

    next_node = routing_map.get(operation, END)

    # å¦‚æœæ˜¯å¹¶è¡Œæ“ä½œ,åŒæ—¶è°ƒåº¦å¤šä¸ªAgent
    if state.get("parallel_mode"):
        return Command(
            goto=[routing_map[op] for op in state["parallel_operations"]]
        )

    return Command(goto=next_node)

builder.add_conditional_edges(START, supervisor_router)

# ç¼–è¯‘å›¾
canvas_learning_graph = builder.compile()
```

#### 3.2.3 å…³é”®è®¾è®¡ä¼˜åŠ¿

**1. å®æ—¶èŠ‚ç‚¹ç”Ÿæˆ (0.5-1ç§’å“åº”)**:
```python
# ç”¨æˆ·è°ƒç”¨: "åŸºç¡€æ‹†è§£'é€†å¦å‘½é¢˜'"
# 0.5ç§’å: ç¬¬ä¸€ä¸ªé—®é¢˜èŠ‚ç‚¹å‡ºç°åœ¨Canvas
# 1.0ç§’å: ç¬¬äºŒä¸ªé—®é¢˜èŠ‚ç‚¹å‡ºç°
# ...
# ç”¨æˆ·å¯ä»¥ç«‹å³çœ‹åˆ°Agentåœ¨å·¥ä½œ,ä¸éœ€è¦ç­‰å¾…8-10ç§’
```

**2. FileLockå¹¶å‘å®‰å…¨** (è¯¦è§Section 3.2.4):
```python
with FileLock(f"{canvas_path}.lock", timeout=10):
    # å¤šä¸ªAgentåŒæ—¶å†™å…¥æ—¶,è‡ªåŠ¨æ’é˜Ÿ,é¿å…æ•°æ®å†²çª
    canvas_data = read_canvas(canvas_path)
    canvas_data["nodes"].append(new_node)
    write_canvas(canvas_path, canvas_data)
```

**3. å†™å…¥å†å²å’Œå›æ»š** (è¯¦è§Section 3.2.5):
```python
state["write_history"] = [
    {"timestamp": "2025-01-15T14:30:01", "operation": "add_node", "node_id": "q1"},
    {"timestamp": "2025-01-15T14:30:02", "operation": "add_node", "node_id": "q2"},
    # ... å¯ä»¥æŒ‰æ—¶é—´å›æ»šåˆ°ä»»æ„ç‰ˆæœ¬
]
```

**4. ä¿ç•™Epic 10.2æ€§èƒ½ä¼˜åŠ¿**:
- LangGraphçš„å¼‚æ­¥å¹¶å‘è°ƒåº¦ä¸Epic 10.2çš„AsyncExecutionEngineå…¼å®¹
- æœ€å¤š12ä¸ªAgentåŒæ—¶è¿è¡Œ
- 8å€æ€§èƒ½æå‡å®Œå…¨ä¿ç•™

#### 3.2.4 FileLockå¹¶å‘å†™å…¥å®‰å…¨æœºåˆ¶

**é—®é¢˜èƒŒæ™¯**: å¤šä¸ªAgentåŒæ—¶å†™å…¥åŒä¸€ä¸ªCanvasæ–‡ä»¶æ—¶,å¯èƒ½é€ æˆæ•°æ®å†²çªå’Œä¸¢å¤±

**è§£å†³æ–¹æ¡ˆ**: è·¨å¹³å°æ–‡ä»¶é”æœºåˆ¶

```python
import fcntl  # Unix/Linux/macOS
import msvcrt  # Windows
import platform
from contextlib import contextmanager

class FileLock:
    """è·¨å¹³å°æ–‡ä»¶é”å®ç°"""

    def __init__(self, lock_file: str, timeout: int = 10):
        self.lock_file = lock_file
        self.timeout = timeout
        self.fd = None

    def __enter__(self):
        """è·å–é”"""
        import time
        start_time = time.time()

        # åˆ›å»ºé”æ–‡ä»¶
        self.fd = open(self.lock_file, 'w')

        # æ ¹æ®å¹³å°é€‰æ‹©é”æœºåˆ¶
        if platform.system() == 'Windows':
            # Windows: msvcrt.locking
            while True:
                try:
                    msvcrt.locking(self.fd.fileno(), msvcrt.LK_NBLCK, 1)
                    break
                except IOError:
                    if time.time() - start_time > self.timeout:
                        raise TimeoutError(f"æ— æ³•è·å–æ–‡ä»¶é”: {self.lock_file}")
                    time.sleep(0.1)
        else:
            # Unix/Linux/macOS: fcntl.flock
            while True:
                try:
                    fcntl.flock(self.fd, fcntl.LOCK_EX | fcntl.LOCK_NB)
                    break
                except IOError:
                    if time.time() - start_time > self.timeout:
                        raise TimeoutError(f"æ— æ³•è·å–æ–‡ä»¶é”: {self.lock_file}")
                    time.sleep(0.1)

        return self

    def __exit__(self, exc_type, exc_val, exc_tb):
        """é‡Šæ”¾é”"""
        if self.fd:
            if platform.system() == 'Windows':
                msvcrt.locking(self.fd.fileno(), msvcrt.LK_UNLCK, 1)
            else:
                fcntl.flock(self.fd, fcntl.LOCK_UN)

            self.fd.close()

            # åˆ é™¤é”æ–‡ä»¶
            try:
                os.remove(self.lock_file)
            except:
                pass
```

**ä½¿ç”¨ç¤ºä¾‹**:

```python
# Scenario: 3ä¸ªAgentåŒæ—¶å‘Canvaså†™å…¥èŠ‚ç‚¹

# Agent 1 (basic-decomposition)
with FileLock("ç¦»æ•£æ•°å­¦.canvas.lock", timeout=10):
    canvas_data = read_canvas("ç¦»æ•£æ•°å­¦.canvas")
    canvas_data["nodes"].append(question_node_1)
    write_canvas("ç¦»æ•£æ•°å­¦.canvas", canvas_data)
# é‡Šæ”¾é”

# Agent 2 (scoring-agent) - ç­‰å¾…é”é‡Šæ”¾
with FileLock("ç¦»æ•£æ•°å­¦.canvas.lock", timeout=10):  # ç­‰å¾…0.1ç§’åè·å¾—é”
    canvas_data = read_canvas("ç¦»æ•£æ•°å­¦.canvas")
    canvas_data["nodes"][0]["color"] = "2"  # æ›´æ–°é¢œè‰²
    write_canvas("ç¦»æ•£æ•°å­¦.canvas", canvas_data)

# Agent 3 (oral-explanation) - ç­‰å¾…é”é‡Šæ”¾
with FileLock("ç¦»æ•£æ•°å­¦.canvas.lock", timeout=10):
    canvas_data = read_canvas("ç¦»æ•£æ•°å­¦.canvas")
    canvas_data["nodes"].append(file_node)
    write_canvas("ç¦»æ•£æ•°å­¦.canvas", canvas_data)
```

**æ€§èƒ½å½±å“**:
- é”ç­‰å¾…æ—¶é—´: å¹³å‡ 50-100ms (å½“å…¶ä»–Agentæ­£åœ¨å†™å…¥æ—¶)
- é”å¼€é”€: <10ms (æ— ç«äº‰æ—¶)
- **æ€»å½±å“**: å¯æ¥å—,ä»èƒ½ä¿æŒ0.5-1ç§’çš„é¦–æ¬¡èŠ‚ç‚¹å‡ºç°æ—¶é—´

**é”™è¯¯å¤„ç†**:
```python
try:
    with FileLock(lock_file, timeout=10):
        # ... å†™å…¥æ“ä½œ
except TimeoutError:
    # è¶…æ—¶åçš„fallbackç­–ç•¥
    logger.error("æ–‡ä»¶é”è¶…æ—¶,å¯èƒ½æœ‰å…¶ä»–æ“ä½œæ­£åœ¨è¿›è¡Œ")
    # é€‰é¡¹1: é‡è¯•
    # é€‰é¡¹2: é€šçŸ¥ç”¨æˆ·ç¨åé‡è¯•
    # é€‰é¡¹3: ä½¿ç”¨ä¸´æ—¶ç¼“å†²åŒº,ç¨ååˆå¹¶
```

---

#### 3.2.5 å†™å…¥å†å²å’Œå›æ»šæœºåˆ¶

**ç›®çš„**: å½“Agentæ“ä½œå‡ºé”™æ—¶,èƒ½å¿«é€Ÿå›æ»šåˆ°ä¹‹å‰çš„çŠ¶æ€

**æ•°æ®ç»“æ„**:

```python
class WriteHistory:
    """å†™å…¥å†å²è®°å½•"""

    def __init__(self):
        self.history: list[dict] = []
        self.snapshots: dict[str, dict] = {}

    def record(self, operation: str, canvas_path: str, node_id: str = None, **metadata):
        """è®°å½•å†™å…¥æ“ä½œ"""
        entry = {
            "timestamp": datetime.now().isoformat(),
            "operation": operation,  # add_node, update_node, add_edge, create_file
            "canvas_path": canvas_path,
            "node_id": node_id,
            "metadata": metadata
        }
        self.history.append(entry)

    def snapshot(self, canvas_path: str, canvas_data: dict):
        """åˆ›å»ºCanvaså¿«ç…§ (æ¯æ¬¡æ“ä½œå‰)"""
        snapshot_key = f"{canvas_path}_{len(self.history)}"
        self.snapshots[snapshot_key] = {
            "timestamp": datetime.now().isoformat(),
            "canvas_data": copy.deepcopy(canvas_data)
        }

    def rollback_to_timestamp(self, target_timestamp: str):
        """å›æ»šåˆ°æŒ‡å®šæ—¶é—´ç‚¹"""
        # æ‰¾åˆ°ç›®æ ‡æ—¶é—´ç‚¹ä¹‹å‰çš„æœ€åä¸€ä¸ªå¿«ç…§
        target_snapshot = None
        for snapshot_key, snapshot in self.snapshots.items():
            if snapshot["timestamp"] <= target_timestamp:
                target_snapshot = snapshot
            else:
                break

        if target_snapshot:
            return target_snapshot["canvas_data"]
        else:
            raise ValueError(f"æ— æ³•æ‰¾åˆ°æ—¶é—´ç‚¹ {target_timestamp} çš„å¿«ç…§")

    def rollback_n_steps(self, n: int):
        """å›æ»šnæ­¥"""
        if n > len(self.history):
            raise ValueError(f"æ— æ³•å›æ»š{n}æ­¥,æ€»å…±åªæœ‰{len(self.history)}æ­¥æ“ä½œ")

        target_index = len(self.history) - n
        target_entry = self.history[target_index]
        return self.rollback_to_timestamp(target_entry["timestamp"])
```

**é›†æˆåˆ°Agentå·¥å…·ä¸­**:

```python
@tool
def write_to_canvas(canvas_path: str, node_data: dict, config: RunnableConfig) -> str:
    """å¸¦å†å²è®°å½•çš„Canvaså†™å…¥"""
    lock_file = f"{canvas_path}.lock"
    state = config.configurable.get("state")

    with FileLock(lock_file, timeout=10):
        # 1. è¯»å–å½“å‰Canvas
        canvas_data = read_canvas(canvas_path)

        # 2. åˆ›å»ºå¿«ç…§ (æ“ä½œå‰)
        if state and "write_history_manager" in state:
            state["write_history_manager"].snapshot(canvas_path, canvas_data)

        # 3. æ‰§è¡Œå†™å…¥
        canvas_data["nodes"].append(node_data)
        write_canvas(canvas_path, canvas_data)

        # 4. è®°å½•æ“ä½œ
        if state and "write_history_manager" in state:
            state["write_history_manager"].record(
                operation="add_node",
                canvas_path=canvas_path,
                node_id=node_data["id"],
                node_type=node_data["type"],
                node_color=node_data.get("color")
            )

    return f"âœ… å·²æ·»åŠ èŠ‚ç‚¹ {node_data['id']}"
```

**å›æ»šAPI**:

```python
# FastAPIç«¯ç‚¹
@app.post("/api/canvas/rollback")
async def rollback_canvas(
    canvas_path: str,
    rollback_steps: int = 1,
    rollback_to_timestamp: str = None
):
    """å›æ»šCanvasæ“ä½œ"""
    # ä»sessionä¸­è·å–write_history_manager
    session = get_session(canvas_path)
    history_manager = session["write_history_manager"]

    if rollback_to_timestamp:
        restored_data = history_manager.rollback_to_timestamp(rollback_to_timestamp)
    else:
        restored_data = history_manager.rollback_n_steps(rollback_steps)

    # å†™å…¥æ¢å¤çš„æ•°æ®
    write_canvas(canvas_path, restored_data)

    return {
        "success": True,
        "message": f"å·²å›æ»šåˆ° {rollback_steps} æ­¥å‰",
        "restored_timestamp": history_manager.history[-rollback_steps]["timestamp"]
    }
```

**ç”¨æˆ·ä½“éªŒ**:

```
Obsidian Plugin UI:

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  âš ï¸ Agentæ“ä½œå‡ºé”™                          â”‚
â”‚                                            â”‚
â”‚  é”™è¯¯ä¿¡æ¯: scoring-agentè¯„åˆ†å¤±è´¥           â”‚
â”‚                                            â”‚
â”‚  [ é‡è¯• ]  [ å›æ»šåˆ°é”™è¯¯å‰ ]  [ å–æ¶ˆ ]     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç”¨æˆ·ç‚¹å‡» [å›æ»šåˆ°é”™è¯¯å‰]:
â†’ è°ƒç”¨ /api/canvas/rollback?rollback_steps=3
â†’ Canvasæ¢å¤åˆ°3æ­¥æ“ä½œä¹‹å‰çš„çŠ¶æ€
â†’ ç”¨æˆ·å¯ä»¥é‡æ–°å°è¯•æˆ–ä¿®æ”¹æ“ä½œ
```

**æ€§èƒ½å¼€é”€**:
- å¿«ç…§å­˜å‚¨: æ¯ä¸ªCanvas ~50KB,æ¯æ¬¡æ“ä½œå‰åˆ›å»ºå¿«ç…§
- å†…å­˜å ç”¨: ä¸€ä¸ªsession ~10MB (å‡è®¾20æ¬¡æ“ä½œ)
- **ä¼˜åŒ–ç­–ç•¥**: åªä¿ç•™æœ€è¿‘50æ¬¡æ“ä½œçš„å¿«ç…§,è¶…è¿‡åè‡ªåŠ¨æ¸…ç†

---

### 3.3 æ•°æ®è¿ç§»ç­–ç•¥

**Phase 1: åŒç³»ç»Ÿå¹¶è¡Œ** (MVP)
```
CLIç³»ç»Ÿ â†â”€â”€â”€â”€å…±äº«â”€â”€â”€â”€â†’ FastAPI Backend
   â†“                        â†“
Vaultæ–‡ä»¶              Obsidian Plugin
```

**Phase 2: LangGraphé›†æˆ**
- ç”¨LangGraph Supervisoræ›¿æ¢ç›´æ¥å‡½æ•°è°ƒç”¨
- ä¿ç•™Epic 10.2å¼‚æ­¥å¹¶è¡Œæ€§èƒ½

**Phase 3: å®Œæ•´è¿ç§»**
- æ‰€æœ‰åŠŸèƒ½è¿ç§»åˆ°Plugin
- å¼ƒç”¨CLIæ¥å£

### 3.4 éƒ¨ç½²æ¶æ„ (Docker Compose)

```yaml
services:
  canvas-api:
    build: ./backend
    ports: ["8000:8000"]
    environment:
      - NEO4J_URI=bolt://neo4j:7687
      - VAULT_PATH=/vault
    volumes:
      - ${VAULT_PATH}:/vault
      - ./data:/data
    depends_on: [neo4j]

  neo4j:
    image: neo4j:5.15-community
    ports: ["7474:7474", "7687:7687"]
    environment:
      - NEO4J_AUTH=neo4j/${NEO4J_PASSWORD}
    volumes:
      - neo4j_data:/data
```

### 3.5 Required Skills & Documentation Sources

#### Purpose
æœ¬ç« èŠ‚åˆ—å‡ºé¡¹ç›®æ‰€æœ‰æŠ€æœ¯æ ˆçš„å®˜æ–¹æ–‡æ¡£æŸ¥è¯¢æ–¹å¼ï¼Œç¡®ä¿Storyå¼€å‘æ—¶æœ‰å‡†ç¡®çš„æŠ€æœ¯å‚è€ƒï¼Œ**é¿å…æŠ€æœ¯"å¹»è§‰"**ï¼ˆå‡è®¾APIå­˜åœ¨ä½†å®é™…ä¸å­˜åœ¨çš„æƒ…å†µï¼‰ã€‚

#### Technology Stack Documentation Matrix

| Epic | æŠ€æœ¯æ ˆ | ç‰ˆæœ¬ | æŸ¥è¯¢æ–¹å¼ | Library ID / Skill Path | Snippets/Pages |
|------|--------|------|---------|------------------------|----------------|
| **Epic 11: FastAPI Backend** |
| 11 | FastAPI | Latest | Context7 | `/websites/fastapi_tiangolo` | 22,734 snippets |
| 11 | Python | 3.11+ | Context7 | `/python/cpython` | (TBD) |
| 11 | Pydantic | 2.x | Context7 | `/pydantic/pydantic` | (TBD) |
| **Epic 12: LangGraph Agent System** |
| 12 | LangGraph | Latest | **Skill** | `.claude/skills/langgraph/` | 952 pages |
| 12 | Graphiti | Latest | **Skill** | `.claude/skills/graphiti/` | Complete docs |
| 12 | LangChain | Latest | Context7 | `/langchain-ai/langchain` | (TBD) |
| **Epic 13: Obsidian Plugin** |
| 13 | Obsidian Canvas API | Latest | **Skill** | `.claude/skills/obsidian-canvas/` | Complete docs |
| 13 | TypeScript | 5.x | Context7 | `/microsoft/typescript` | (TBD) |
| 13 | Obsidian Plugin API | Latest | **Skill** | `.claude/skills/obsidian-canvas/` | Included |
| **Epic 14: è‰¾å®¾æµ©æ–¯å¤ä¹ ç³»ç»Ÿè¿ç§»+UIé›†æˆ** |
| 14 | Py-FSRS | 1.0.0 | PyPI | `pip install py-fsrs==1.0.0` | [GitHub](https://github.com/open-spaced-repetition/py-fsrs) |
| 14 | SQLite3 | Pythonå†…ç½® | Python Docs | `import sqlite3` | Built-in |
| 14 | Chart.js | 4.x | Context7 | `/chartjs/Chart.js` | (TBD) |
| **Epic 15-16: Neo4j Data Layer (Graphiti Backend)** |
| 15-16 | Neo4j Cypher | 2.5 | Context7 | `/websites/neo4j_cypher-manual_25` | 2,032 snippets |
| 15-16 | Neo4j Operations | Current | Context7 | `/websites/neo4j_operations-manual-current` | 4,940 snippets |
| 15-16 | Neo4j Python Driver | Latest | Context7 | `/neo4j/neo4j-python-driver` | 148 snippets |

#### Story Development Protocol

**Step 1: Identify Required Documentation**
æ ¹æ®Storyæ¶‰åŠçš„Epicï¼Œä»ä¸Šè¡¨æ‰¾åˆ°å¯¹åº”çš„æŠ€æœ¯æ ˆã€‚

**Step 2: Activate Skills or Query Context7**

**For Epic 11 (FastAPI Backend)**:
```bash
# ä½¿ç”¨Context7 MCPæŸ¥è¯¢FastAPIæ–‡æ¡£
mcp__context7-mcp__get-library-docs(
    context7CompatibleLibraryID="/websites/fastapi_tiangolo",
    topic="dependency injection"  # æ ¹æ®Storyå†…å®¹è°ƒæ•´
)
```

**For Epic 12 (LangGraph Agent System)**:
```bash
# æ¿€æ´»ç›¸å…³Skills
@langgraph
@graphiti

# Skillsä¼šè‡ªåŠ¨åŠ è½½ï¼Œå¯ç›´æ¥æŸ¥è¯¢SKILL.mdå’Œreferences/
```

**For Epic 13 (Obsidian Plugin)**:
```bash
# æ¿€æ´»Obsidian Canvas Skill
@obsidian-canvas
```

**For Epic 14 (è‰¾å®¾æµ©æ–¯å¤ä¹ ç³»ç»Ÿè¿ç§»+UIé›†æˆ)**:
```bash
# Py-FSRSä½¿ç”¨GitHub READMEå’Œæºç 
# GitHub: https://github.com/open-spaced-repetition/py-fsrs
# æœ¬åœ°ä»£ç å‚è€ƒ: ebbinghaus_review.py (870è¡Œ, å·²æœ‰å®ç°)

# å¦‚éœ€æŸ¥è¯¢Chart.jsæ–‡æ¡£ (ç”¨äºç»Ÿè®¡å›¾è¡¨)
mcp__context7-mcp__get-library-docs(
    context7CompatibleLibraryID="/chartjs/Chart.js",
    topic="line charts"
)
```

**For Epic 15-16 (Neo4j Data Layer / Graphiti Backend)**:
```bash
# æŸ¥è¯¢Neo4jæ–‡æ¡£
mcp__context7-mcp__get-library-docs(
    context7CompatibleLibraryID="/websites/neo4j_cypher-manual_25",
    topic="pattern matching"
)
```

**Step 3: Verify API and Parameters**
å‚è€ƒ `.bmad-core/checklists/technical-verification-checklist.md` è¿›è¡Œå®Œæ•´éªŒè¯ã€‚

#### Documentation Quality Standards

æ¯ä¸ªStoryå¿…é¡»åŒ…å«ï¼š
- âœ… **Required Skills**: åˆ—å‡ºéœ€è¦æ¿€æ´»çš„Skills
- âœ… **Context7 Queries**: åˆ—å‡ºå·²æŸ¥è¯¢çš„Library IDs
- âœ… **API Verification**: å…³é”®APIéƒ½æœ‰æ–‡æ¡£æ¥æºæ ‡æ³¨
- âœ… **Code Examples**: å¤åˆ¶å®˜æ–¹ç¤ºä¾‹å¹¶æ ‡æ³¨æ¥æº

**ç¤ºä¾‹æ ‡æ³¨æ ¼å¼**:
```python
# Verified from LangGraph Skill (SKILL.md:226-230)
from langgraph.prebuilt import create_react_agent

agent = create_react_agent(
    model,
    tools=[search_tool, calculator_tool],
    state_modifier="You are a helpful assistant."  # âœ… Parameter verified
)
```

#### Known Technical Limitations

**LangGraph Agent System (Epic 12)**:
- âš ï¸ **Memory System Complexity**: ä¸‰å±‚è®°å¿†ç³»ç»Ÿé›†æˆéœ€è¦é¢å¤–éªŒè¯
- âš ï¸ **Streaming Support**: ç¡®è®¤LangGraph Streaming APIä¸Obsidiané›†æˆå¯è¡Œæ€§
- ğŸ“– **Reference**: See LangGraph Skill references/llms-full.md

**è‰¾å®¾æµ©æ–¯å¤ä¹ ç³»ç»Ÿ (Epic 14)**:
- âš ï¸ **ç®—æ³•è¿ç§»**: ä»ç»å…¸è‰¾å®¾æµ©æ–¯å…¬å¼è¿ç§»åˆ°Py-FSRSéœ€è¦æ•°æ®è¿ç§»è„šæœ¬
- âš ï¸ **å‘åå…¼å®¹**: ä¿ç•™åŒç®—æ³•æ”¯æŒ,é¿å…å†å²æ•°æ®å¤±æ•ˆ
- ğŸ“– **Reference**: ebbinghaus_review.py (870è¡Œ, å·²æœ‰å®ç°), Py-FSRS GitHub

**Neo4j Integration (Epic 15-16)**:
- âš ï¸ **Performance**: å¤§è§„æ¨¡çŸ¥è¯†å›¾è°±æŸ¥è¯¢æ€§èƒ½éœ€è¦åŸºå‡†æµ‹è¯•
- âš ï¸ **Cypher Version**: ç¡®è®¤ä½¿ç”¨Cypher 2.5è¯­æ³•
- ğŸ“– **Reference**: Context7 `/websites/neo4j_cypher-manual_25`

#### Updates and Maintenance

æœ¬ç« èŠ‚åº”éšé¡¹ç›®è¿›å±•æ›´æ–°ï¼š
- ğŸ”„ **æ–°å¢æŠ€æœ¯æ ˆ**: æ·»åŠ åˆ°ä¸Šè¡¨å¹¶ç¡®å®šæŸ¥è¯¢æ–¹å¼
- ğŸ”„ **ç‰ˆæœ¬å‡çº§**: æ›´æ–°ç‰ˆæœ¬å·å’ŒLibrary ID
- ğŸ”„ **Skillsè¡¥å……**: æ–°ç”Ÿæˆçš„SkillsåŠæ—¶è¡¥å……åˆ°è¡¨ä¸­

**è¯¦ç»†éªŒè¯æµç¨‹**: å‚è§ `.bmad-core/checklists/technical-verification-checklist.md`

---

### 3.6 LangGraphè®°å¿†ç³»ç»Ÿé›†æˆè®¾è®¡

#### Purpose
æœ¬ç« èŠ‚è¯¦ç»†å®šä¹‰LangGraphæ¡†æ¶å±‚è®°å¿†ç³»ç»Ÿï¼ˆCheckpointerï¼‰ä¸Canvaså­¦ä¹ ç³»ç»Ÿ3å±‚ä¸šåŠ¡è®°å¿†ç³»ç»Ÿï¼ˆGraphiti + Temporal + Semanticï¼‰çš„é›†æˆæ¶æ„ï¼Œæ˜ç¡®èŒè´£è¾¹ç•Œã€è§¦å‘æ—¶æœºã€ä¸€è‡´æ€§ä¿è¯å’Œæ•…éšœå¤„ç†æœºåˆ¶ã€‚

> **å…³é”®é—®é¢˜è§£å†³**:
> - â“ **ä½•æ—¶è§¦å‘è®°å¿†å­˜å‚¨**: æ¯ä¸ªCanvasæ“ä½œçš„6æ­¥ç²¾ç¡®æ—¶åº
> - â“ **å¦‚ä½•é¿å…å†²çª**: LangGraph Checkpointer vs 3å±‚ä¸šåŠ¡è®°å¿†çš„èŒè´£è¾¹ç•Œ
> - â“ **å¦‚ä½•ä¿è¯ä¸€è‡´æ€§**: å¼ºä¸€è‡´æ€§ vs æœ€ç»ˆä¸€è‡´æ€§æ¨¡å‹
> - â“ **å¦‚ä½•å¤„ç†å¤±è´¥**: å…³é”®è·¯å¾„ vs éå…³é”®è·¯å¾„çš„é”™è¯¯å¤„ç†ç­–ç•¥

---

#### 3.6.1 Checkpointeré€‰å‹å’Œé…ç½®

**ç”Ÿäº§ç¯å¢ƒæ¨è**: PostgresSaverï¼ˆæŒä¹…åŒ–åˆ°PostgreSQLæ•°æ®åº“ï¼‰

```python
# Epic 12: LangGraph checkpointeré…ç½®
from langgraph.checkpoint.postgres import PostgresSaver

# æ•°æ®åº“è¿æ¥é…ç½®
DB_URI = "postgresql://user:pass@localhost:5432/canvas_learning"
checkpointer = PostgresSaver.from_conn_string(DB_URI)

# StateGraphç¼–è¯‘æ—¶æ³¨å…¥checkpointer
graph = builder.compile(checkpointer=checkpointer)
```

**å¼€å‘/æµ‹è¯•ç¯å¢ƒ**: InMemorySaverï¼ˆå†…å­˜å­˜å‚¨ï¼Œå¿«é€Ÿä½†ä¸æŒä¹…åŒ–ï¼‰

```python
from langgraph.checkpoint.memory import InMemorySaver

checkpointer = InMemorySaver()
graph = builder.compile(checkpointer=checkpointer)
```

**æŒä¹…åŒ–å†…å®¹**:
- Agent Stateå®Œæ•´å¿«ç…§ï¼ˆåŒ…æ‹¬CanvasLearningStateæ‰€æœ‰å­—æ®µï¼‰
- ä¼šè¯ä¸Šä¸‹æ–‡ï¼ˆmulti-turn dialogue contextï¼‰
- ä¸­é—´æ­¥éª¤å’Œå†³ç­–å†å²
- å·¥å…·è°ƒç”¨è®°å½•

**ä¸æŒä¹…åŒ–**:
- Canvasæ–‡ä»¶å†…å®¹ï¼ˆç”±Obsidianè´Ÿè´£ï¼‰
- GraphitiçŸ¥è¯†å›¾è°±æ•°æ®ï¼ˆç”±Neo4jè´Ÿè´£ï¼‰
- å‘é‡åµŒå…¥ï¼ˆç”±Semantic Memoryè´Ÿè´£ï¼‰

---

#### 3.6.2 thread_idè®¾è®¡ç­–ç•¥

**thread_idæ ¼å¼**: `canvas_{canvas_name}_{session_id}`

**ç»„æˆéƒ¨åˆ†**:
- `canvas_name`: Canvasæ–‡ä»¶åï¼ˆå»é™¤`.canvas`æ‰©å±•åï¼‰
- `session_id`: å”¯ä¸€ä¼šè¯æ ‡è¯†ç¬¦ï¼ˆUUID v4ï¼‰

**ç¤ºä¾‹**:
```python
# Canvasæ–‡ä»¶: ç¬”è®°åº“/ç¦»æ•£æ•°å­¦/ç¦»æ•£æ•°å­¦.canvas
# Session ID: a1b2c3d4-e5f6-7890-abcd-ef1234567890
thread_id = "canvas_ç¦»æ•£æ•°å­¦_a1b2c3d4-e5f6-7890-abcd-ef1234567890"
```

**è®¾è®¡åŸåˆ™**:
1. **å”¯ä¸€æ€§**: æ¯ä¸ªå­¦ä¹ ä¼šè¯ç‹¬ç«‹thread_idï¼Œé¿å…çŠ¶æ€æ··æ·†
2. **å¯è¿½æº¯æ€§**: ä»thread_idå¯ç›´æ¥å®šä½Canvasæ–‡ä»¶å’Œä¼šè¯
3. **éš”ç¦»æ€§**: åŒä¸€Canvasçš„ä¸åŒä¼šè¯äº’ä¸å¹²æ‰°
4. **è·¨ä¼šè¯æŸ¥è¯¢**: Temporal Memoryå¯é€šè¿‡canvas_nameæŸ¥è¯¢å†å²æ‰€æœ‰ä¼šè¯

**ç”Ÿå‘½å‘¨æœŸ**:
- **åˆ›å»ºæ—¶æœº**: ç”¨æˆ·é¦–æ¬¡è°ƒç”¨Agentæ“ä½œCanvasæ—¶
- **æŒç»­æ—¶é—´**: æ•´ä¸ªå­¦ä¹ ä¼šè¯ï¼ˆå¯èƒ½è·¨è¶Šå¤šå¤©ï¼‰
- **ç»ˆæ­¢æ—¶æœº**: ç”¨æˆ·æ˜ç¡®å…³é—­ä¼šè¯æˆ–è¶…æ—¶ï¼ˆé»˜è®¤30å¤©æ— æ´»åŠ¨ï¼‰
- **å¤ç”¨ç­–ç•¥**: åŒä¸€Canvasçš„æ–°ä¼šè¯åˆ›å»ºæ–°thread_id

---

#### 3.6.3 configå‚æ•°ç»“æ„å®šä¹‰

**å®Œæ•´configç»“æ„**:

```python
from typing import TypedDict
from pathlib import Path

class LangGraphConfig(TypedDict):
    """LangGraphè°ƒç”¨é…ç½®å‚æ•°"""
    configurable: dict  # LangGraphæ ‡å‡†é…ç½®å­—æ®µ

# å…·ä½“å®ç°
def create_langgraph_config(
    canvas_path: str,
    user_id: str,
    session_id: str
) -> LangGraphConfig:
    """ç”ŸæˆLangGraph graph.invoke()æ‰€éœ€çš„configå‚æ•°

    Args:
        canvas_path: Canvasæ–‡ä»¶ç»å¯¹è·¯å¾„
        user_id: ç”¨æˆ·å”¯ä¸€æ ‡è¯†ç¬¦
        session_id: ä¼šè¯å”¯ä¸€æ ‡è¯†ç¬¦ï¼ˆUUID v4ï¼‰

    Returns:
        ç¬¦åˆLangGraphæ ‡å‡†çš„configå­—å…¸
    """
    canvas_name = Path(canvas_path).stem
    thread_id = f"canvas_{canvas_name}_{session_id}"

    return {
        "configurable": {
            # LangGraphæ ¸å¿ƒå‚æ•°
            "thread_id": thread_id,  # ä¼šè¯æ ‡è¯†ç¬¦

            # Canvaså­¦ä¹ ç³»ç»Ÿä¸šåŠ¡å‚æ•°
            "canvas_path": canvas_path,  # Canvasæ–‡ä»¶è·¯å¾„
            "user_id": user_id,          # ç”¨æˆ·ID
            "session_id": session_id,    # ä¼šè¯ID

            # å¯é€‰æ‰©å±•å‚æ•°
            "checkpoint_ns": "canvas_learning",  # å‘½åç©ºé—´éš”ç¦»
            "checkpoint_id": None,  # æŒ‡å®šæ¢å¤çš„checkpoint IDï¼ˆé»˜è®¤æœ€æ–°ï¼‰
        }
    }
```

**ä½¿ç”¨ç¤ºä¾‹**:

```python
# åˆ›å»ºæ–°ä¼šè¯
config = create_langgraph_config(
    canvas_path="C:/Users/ROG/æ‰˜ç¦/ç¬”è®°åº“/ç¦»æ•£æ•°å­¦/ç¦»æ•£æ•°å­¦.canvas",
    user_id="user_12345",
    session_id="a1b2c3d4-e5f6-7890-abcd-ef1234567890"
)

# è°ƒç”¨Agent
result = graph.invoke(
    {
        "canvas_path": config["configurable"]["canvas_path"],
        "operation": "decomposition",
        "concept": "é€†å¦å‘½é¢˜"
    },
    config=config  # æ³¨å…¥config
)
```

---

#### 3.6.4 graphç¼–è¯‘ç¤ºä¾‹ï¼ˆå®Œæ•´å¯è¿è¡Œä»£ç ï¼‰

**å®Œæ•´StateGraphå®šä¹‰**:

```python
from typing import Annotated
from typing_extensions import TypedDict
from langgraph.graph import StateGraph, START, END
from langgraph.graph.message import add_messages
from langgraph.checkpoint.postgres import PostgresSaver

# Step 1: å®šä¹‰State Schema
class CanvasLearningState(TypedDict):
    """Canvaså­¦ä¹ ç³»ç»ŸStateå®šä¹‰"""
    # ä¼šè¯å…ƒä¿¡æ¯
    canvas_path: str
    user_id: str
    session_id: str

    # æ“ä½œä¸Šä¸‹æ–‡
    operation: str  # "decomposition" | "explanation" | "scoring" | "verification"
    concept: str

    # Agentè¾“å‡ºç»“æœ
    decomposition_results: list[str]  # basic-decompositionè¾“å‡º
    explanation_doc_path: str | None  # explanation agentè¾“å‡º
    scoring_result: dict | None       # scoring-agentè¾“å‡º

    # LangChain messagesï¼ˆç”¨äºå¯¹è¯å†å²ï¼‰
    messages: Annotated[list, add_messages]

    # æœ€åæ“ä½œè®°å½•
    last_operation: str
    last_timestamp: str

# Step 2: å®šä¹‰AgentèŠ‚ç‚¹å‡½æ•°
def basic_decomposition_node(state: CanvasLearningState):
    """åŸºç¡€æ‹†è§£AgentèŠ‚ç‚¹"""
    # ç”Ÿæˆæ‹†è§£é—®é¢˜
    questions = generate_decomposition_questions(state["concept"])

    # å†™å…¥Canvasï¼ˆå…³é”®è·¯å¾„ - å¿…é¡»æˆåŠŸï¼‰
    write_questions_to_canvas(
        state["canvas_path"],
        questions,
        config={"thread_id": f"canvas_{Path(state['canvas_path']).stem}_{state['session_id']}"}
    )

    # å­˜å‚¨åˆ°ä¸šåŠ¡è®°å¿†ç³»ç»Ÿï¼ˆéå…³é”®è·¯å¾„ - å…è®¸å¤±è´¥ï¼‰
    try:
        store_to_graphiti(state["session_id"], "decomposition", questions)
        store_to_temporal(state["session_id"], "decomposition_completed", datetime.now())
    except Exception as e:
        logger.error(f"Memory storage failed: {e}")  # ä»…è®°å½•ï¼Œä¸ä¸­æ–­æµç¨‹

    # è¿”å›æ›´æ–°çš„Stateï¼ˆLangGraphè‡ªåŠ¨æŒä¹…åŒ–ï¼‰
    return {
        **state,
        "decomposition_results": questions,
        "last_operation": "decomposition",
        "last_timestamp": datetime.now().isoformat()
    }

def scoring_node(state: CanvasLearningState):
    """è¯„åˆ†AgentèŠ‚ç‚¹"""
    # è¯»å–é»„è‰²èŠ‚ç‚¹å†…å®¹
    yellow_nodes = read_yellow_nodes_from_canvas(state["canvas_path"])

    # è°ƒç”¨scoring-agentè¯„åˆ†
    scoring_results = score_understanding(yellow_nodes)

    # æ›´æ–°CanvasèŠ‚ç‚¹é¢œè‰²ï¼ˆå…³é”®è·¯å¾„ï¼‰
    update_node_colors_based_on_score(
        state["canvas_path"],
        scoring_results,
        config={"thread_id": f"canvas_{Path(state['canvas_path']).stem}_{state['session_id']}"}
    )

    # å­˜å‚¨è¯„åˆ†ç»“æœåˆ°ä¸šåŠ¡è®°å¿†ï¼ˆéå…³é”®è·¯å¾„ï¼‰
    try:
        store_to_temporal(state["session_id"], "scoring_completed", datetime.now(), scoring_results)
    except Exception as e:
        logger.error(f"Scoring storage failed: {e}")

    return {
        **state,
        "scoring_result": scoring_results,
        "last_operation": "scoring",
        "last_timestamp": datetime.now().isoformat()
    }

# Step 3: æ„å»ºStateGraph
builder = StateGraph(CanvasLearningState)

# æ·»åŠ èŠ‚ç‚¹
builder.add_node("decomposition", basic_decomposition_node)
builder.add_node("scoring", scoring_node)
builder.add_node("explanation", explanation_node)
builder.add_node("verification", verification_node)

# å®šä¹‰è·¯ç”±é€»è¾‘
def route_operation(state: CanvasLearningState):
    """æ ¹æ®operationå­—æ®µè·¯ç”±åˆ°å¯¹åº”Agent"""
    operation = state.get("operation")
    if operation == "decomposition":
        return "decomposition"
    elif operation == "scoring":
        return "scoring"
    elif operation == "explanation":
        return "explanation"
    elif operation == "verification":
        return "verification"
    else:
        return END

# æ·»åŠ è¾¹
builder.add_conditional_edges(START, route_operation)
builder.add_edge("decomposition", END)
builder.add_edge("scoring", END)
builder.add_edge("explanation", END)
builder.add_edge("verification", END)

# Step 4: ç¼–è¯‘graphå¹¶æ³¨å…¥checkpointer
DB_URI = "postgresql://user:pass@localhost:5432/canvas_learning"
checkpointer = PostgresSaver.from_conn_string(DB_URI)

graph = builder.compile(checkpointer=checkpointer)

# Step 5: è°ƒç”¨ç¤ºä¾‹
config = create_langgraph_config(
    canvas_path="C:/Users/ROG/æ‰˜ç¦/ç¬”è®°åº“/ç¦»æ•£æ•°å­¦/ç¦»æ•£æ•°å­¦.canvas",
    user_id="user_12345",
    session_id=str(uuid.uuid4())
)

result = graph.invoke(
    {
        "canvas_path": config["configurable"]["canvas_path"],
        "user_id": config["configurable"]["user_id"],
        "session_id": config["configurable"]["session_id"],
        "operation": "decomposition",
        "concept": "é€†å¦å‘½é¢˜",
        "messages": []
    },
    config=config
)

# LangGraphè‡ªåŠ¨å°†StateæŒä¹…åŒ–åˆ°PostgreSQL
```

**å…³é”®è¦ç‚¹**:
1. âœ… Stateæ›´æ–°è‡ªåŠ¨è§¦å‘checkpointeræŒä¹…åŒ–
2. âœ… æ¯æ¬¡`graph.invoke()`è°ƒç”¨éƒ½ä¼šåˆ›å»ºæ–°çš„checkpoint
3. âœ… å¯é€šè¿‡`graph.get_state(config)`æ¢å¤å†å²State
4. âœ… Canvasæ“ä½œåœ¨Nodeå†…éƒ¨å®Œæˆï¼Œç¡®ä¿åŸå­æ€§

---

#### 3.6.5 å¤šè½®å¯¹è¯æ”¯æŒ

**åœºæ™¯æè¿°**: ç”¨æˆ·ä¸Canvaså­¦ä¹ ç³»ç»Ÿè¿›è¡Œå¤šè½®äº¤äº’ï¼ˆä¾‹å¦‚ï¼šæ‹†è§£ â†’ å¡«å†™ç†è§£ â†’ è¯„åˆ† â†’ è¡¥å……è§£é‡Š â†’ å†è¯„åˆ†ï¼‰

**å®ç°æœºåˆ¶**:

```python
# ç¬¬1è½®ï¼šåŸºç¡€æ‹†è§£
config_round1 = create_langgraph_config(
    canvas_path="ç¦»æ•£æ•°å­¦.canvas",
    user_id="user_12345",
    session_id="session_abc"  # åŒä¸€session_id
)
result1 = graph.invoke({"operation": "decomposition", "concept": "é€†å¦å‘½é¢˜", ...}, config=config_round1)

# ç¬¬2è½®ï¼šè¯„åˆ†ï¼ˆå¤ç”¨ç›¸åŒthread_idï¼‰
config_round2 = create_langgraph_config(
    canvas_path="ç¦»æ•£æ•°å­¦.canvas",
    user_id="user_12345",
    session_id="session_abc"  # ç›¸åŒsession_id â†’ ç›¸åŒthread_id
)
result2 = graph.invoke({"operation": "scoring", ...}, config=config_round2)

# ç¬¬3è½®ï¼šè¡¥å……è§£é‡Šï¼ˆç»§ç»­å¤ç”¨ï¼‰
config_round3 = create_langgraph_config(
    canvas_path="ç¦»æ•£æ•°å­¦.canvas",
    user_id="user_12345",
    session_id="session_abc"
)
result3 = graph.invoke({"operation": "explanation", "concept": "é€†å¦å‘½é¢˜", ...}, config=config_round3)

# æ¢å¤å†å²State
historical_state = graph.get_state(config_round3)
print(historical_state.values)  # åŒ…å«æ‰€æœ‰å†å²æ“ä½œç»“æœ
```

**å…³é”®ä¼˜åŠ¿**:
- âœ… **ä¸Šä¸‹æ–‡ä¿æŒ**: æ¯è½®å¯¹è¯éƒ½èƒ½è®¿é—®ä¹‹å‰çš„æ“ä½œç»“æœ
- âœ… **çŠ¶æ€ç´¯ç§¯**: `messages`å­—æ®µè®°å½•å®Œæ•´å¯¹è¯å†å²
- âœ… **å¯å›æº¯**: å¯æŸ¥è¯¢ä»»æ„å†å²checkpoint
- âœ… **æ— ç¼è¡”æ¥**: Agentå¯æ ¹æ®å†å²ç»“æœåšæ›´æ™ºèƒ½çš„å†³ç­–

**ä¸3å±‚ä¸šåŠ¡è®°å¿†é…åˆ**:
- **Checkpointer**: çŸ­æœŸä¼šè¯ä¸Šä¸‹æ–‡ï¼ˆå½“å‰å­¦ä¹ ä¼šè¯ï¼‰
- **Temporal Memory**: é•¿æœŸå­¦ä¹ å†å²ï¼ˆè·¨ä¼šè¯æ—¶é—´çº¿ï¼‰
- **Graphiti**: çŸ¥è¯†å…³è”ç½‘ç»œï¼ˆè·¨Canvasæ¦‚å¿µå…³ç³»ï¼‰
- **Semantic Memory**: æ–‡æ¡£è¯­ä¹‰æ£€ç´¢ï¼ˆè·¨ä¼šè¯æ–‡æ¡£æŸ¥è¯¢ï¼‰

---

#### 3.6.6 å›æ»šæœºåˆ¶å¢å¼º

**ä¼ ç»ŸCanvasæ“ä½œå›æ»š**ï¼ˆå·²å®ç°ï¼‰:
- æ“ä½œå‰å¤‡ä»½Canvas JSON
- å¤±è´¥æ—¶æ¢å¤å¤‡ä»½
- è¦†ç›–èŒƒå›´ï¼šå•æ¬¡æ“ä½œ

**LangGraph Checkpointerå›æ»š**ï¼ˆæ–°å¢ï¼‰:
- å›æ»šåˆ°ä»»æ„å†å²checkpoint
- æ¢å¤å®Œæ•´Agent State
- è¦†ç›–èŒƒå›´ï¼šæ•´ä¸ªå­¦ä¹ ä¼šè¯

**å®Œæ•´å›æ»šç­–ç•¥**:

```python
def rollback_to_checkpoint(
    canvas_path: str,
    session_id: str,
    checkpoint_id: str
):
    """å›æ»šåˆ°æŒ‡å®šcheckpoint

    Args:
        canvas_path: Canvasæ–‡ä»¶è·¯å¾„
        session_id: ä¼šè¯ID
        checkpoint_id: ç›®æ ‡checkpoint IDï¼ˆä»get_state_historyè·å–ï¼‰
    """
    config = create_langgraph_config(canvas_path, "user_id", session_id)
    config["configurable"]["checkpoint_id"] = checkpoint_id

    # Step 1: æ¢å¤Agent State
    state = graph.get_state(config)

    # Step 2: å›æ»šCanvasæ–‡ä»¶ï¼ˆä»å¤‡ä»½ï¼‰
    backup_path = f".canvas_backups/{Path(canvas_path).stem}_{checkpoint_id}.canvas"
    shutil.copy(backup_path, canvas_path)

    # Step 3: å›æ»šä¸šåŠ¡è®°å¿†ï¼ˆæ ‡è®°ä¸ºå·²æ’¤é”€ï¼‰
    mark_memory_operations_as_reverted(
        session_id,
        after_timestamp=state.values["last_timestamp"]
    )

    return state.values

# ä½¿ç”¨ç¤ºä¾‹
# æŸ¥è¯¢å†å²checkpoints
config = create_langgraph_config("ç¦»æ•£æ•°å­¦.canvas", "user_12345", "session_abc")
history = graph.get_state_history(config)

for h in history:
    print(f"Checkpoint ID: {h.config['configurable']['checkpoint_id']}")
    print(f"Timestamp: {h.values['last_timestamp']}")
    print(f"Operation: {h.values['last_operation']}")

# å›æ»šåˆ°ç¬¬2ä¸ªcheckpoint
rollback_to_checkpoint("ç¦»æ•£æ•°å­¦.canvas", "session_abc", history[1].config["configurable"]["checkpoint_id"])
```

**å¢å¼ºçš„ä¸€è‡´æ€§ä¿è¯**:
- âœ… Canvasæ–‡ä»¶çŠ¶æ€ â†” LangGraph State: å¼ºä¸€è‡´æ€§
- âœ… Canvasæ–‡ä»¶çŠ¶æ€ â†” Graphiti/Temporal: æœ€ç»ˆä¸€è‡´æ€§ï¼ˆå…è®¸å»¶è¿Ÿï¼‰
- âœ… å›æ»šæ“ä½œ: Canvas + StateåŒæ­¥å›æ»šï¼Œä¸šåŠ¡è®°å¿†æ ‡è®°æ’¤é”€

---

#### 3.6.7 æ€§èƒ½è€ƒè™‘

**Checkpointerå†™å…¥æ€§èƒ½**:
- PostgresSaver: ~50ms per checkpointï¼ˆåŒ…å«åºåˆ—åŒ– + æ•°æ®åº“å†™å…¥ï¼‰
- InMemorySaver: ~5ms per checkpointï¼ˆçº¯å†…å­˜æ“ä½œï¼‰

**ä¼˜åŒ–ç­–ç•¥**:

**1. æ‰¹é‡æ“ä½œä¼˜åŒ–**
```python
# âŒ ä½æ•ˆï¼šæ¯ä¸ªèŠ‚ç‚¹å•ç‹¬invoke
for node_id in node_ids:
    graph.invoke({"operation": "scoring", "node_id": node_id}, config)
    # æ¯æ¬¡éƒ½åˆ›å»ºæ–°checkpointï¼ˆå‡è®¾100ä¸ªèŠ‚ç‚¹ = 100æ¬¡æ•°æ®åº“å†™å…¥ï¼‰

# âœ… é«˜æ•ˆï¼šæ‰¹é‡å¤„ç†
graph.invoke({
    "operation": "batch_scoring",
    "node_ids": node_ids  # ä¸€æ¬¡æ€§ä¼ å…¥æ‰€æœ‰èŠ‚ç‚¹
}, config)
# ä»…1æ¬¡checkpointå†™å…¥
```

**2. å¼‚æ­¥æŒä¹…åŒ–**
```python
# LangGraphå†…éƒ¨å·²å®ç°å¼‚æ­¥å†™å…¥ï¼Œæ— éœ€é¢å¤–é…ç½®
# checkpointer.put()æ˜¯éé˜»å¡çš„
```

**3. Checkpointæ¸…ç†ç­–ç•¥**
```python
# å®šæœŸæ¸…ç†æ—§checkpointsï¼ˆä¿ç•™æœ€è¿‘30å¤©ï¼‰
def cleanup_old_checkpoints(session_id: str, days=30):
    cutoff_date = datetime.now() - timedelta(days=days)
    # PostgresSaveræä¾›TTLæœºåˆ¶
    checkpointer.delete_checkpoints_before(session_id, cutoff_date)
```

**æ€§èƒ½åŸºå‡†**ï¼ˆå•æ¬¡æ“ä½œï¼‰:
- Canvasè¯»å–: ~10ms
- AgentèŠ‚ç‚¹æ‰§è¡Œ: ~200msï¼ˆä¸å«LLMè°ƒç”¨ï¼‰
- Canvaså†™å…¥: ~15ms
- CheckpointeræŒä¹…åŒ–: ~50msï¼ˆPostgresSaverï¼‰
- Graphitiå­˜å‚¨: ~100msï¼ˆå¼‚æ­¥ï¼Œä¸é˜»å¡ï¼‰
- **æ€»å»¶è¿Ÿ**: ~275msï¼ˆç”¨æˆ·æ„ŸçŸ¥ï¼‰

---

#### 3.6.8 ä¸Epic 16è·¨Canvaså…³è”çš„é…åˆ

**Epic 16éœ€æ±‚**: è·¨CanvasçŸ¥è¯†å…³è”æŸ¥è¯¢ï¼ˆä¾‹å¦‚ï¼šæŸ¥è¯¢"çº¿æ€§ä»£æ•°"å’Œ"ç¦»æ•£æ•°å­¦"ä¸­å…³äº"çŸ©é˜µ"çš„æ‰€æœ‰èŠ‚ç‚¹ï¼‰

**LangGraph CheckpointerèŒè´£**:
- âŒ **ä¸è´Ÿè´£**è·¨CanvasæŸ¥è¯¢ï¼ˆè¿™æ˜¯Graphitiçš„èŒè´£ï¼‰
- âœ… **è´Ÿè´£**å•ä¸ªCanvasä¼šè¯çš„Stateç®¡ç†
- âœ… **è´Ÿè´£**æä¾›å½“å‰Canvasçš„ä¸Šä¸‹æ–‡ç»™Graphiti

**åä½œæœºåˆ¶**:

```python
# Epic 16 Story: è·¨Canvaså…³è”æŸ¥è¯¢
def cross_canvas_query_node(state: CanvasLearningState):
    """è·¨CanvasæŸ¥è¯¢AgentèŠ‚ç‚¹"""
    query = state["query"]  # "æŸ¥è¯¢æ‰€æœ‰Canvasä¸­å…³äº'çŸ©é˜µ'çš„èŠ‚ç‚¹"

    # Step 1: ä»å½“å‰Stateè·å–ä¸Šä¸‹æ–‡
    current_canvas = state["canvas_path"]
    current_concept = state["concept"]

    # Step 2: è°ƒç”¨Graphitiè¿›è¡Œè·¨CanvasæŸ¥è¯¢
    related_nodes = graphiti_client.search_nodes(
        query=query,
        filters={
            "concept": current_concept,
            "exclude_canvas": current_canvas  # æ’é™¤å½“å‰Canvas
        },
        limit=10
    )

    # Step 3: å°†ç»“æœæ•´åˆåˆ°å½“å‰Canvas
    for node in related_nodes:
        add_reference_node_to_canvas(
            current_canvas,
            node,
            link_type="cross_canvas_reference"
        )

    # Step 4: æ›´æ–°Stateï¼ˆLangGraphæŒä¹…åŒ–ï¼‰
    return {
        **state,
        "cross_canvas_results": related_nodes,
        "last_operation": "cross_canvas_query"
    }
```

**æ•°æ®æµ**:
```
LangGraph State (å½“å‰Canvasä¸Šä¸‹æ–‡)
    â†“
Graphiti Knowledge Graph (è·¨Canvasè¯­ä¹‰æŸ¥è¯¢)
    â†“
LangGraph State (æŸ¥è¯¢ç»“æœå†™å›)
    â†“
LangGraph Checkpointer (æŒä¹…åŒ–æŸ¥è¯¢å†å²)
```

**å…³é”®è®¾è®¡**:
- âœ… Checkpointerè®°å½•"åœ¨å“ªä¸ªCanvasã€ä»€ä¹ˆæ—¶å€™ã€æŸ¥è¯¢äº†ä»€ä¹ˆ"
- âœ… Graphitiæä¾›è·¨Canvasçš„è¯­ä¹‰å…³è”èƒ½åŠ›
- âœ… ä¸¤è€…é€šè¿‡Stateä¼ é€’æ•°æ®ï¼ŒèŒè´£æ¸…æ™°

---

#### 3.6.9 éªŒæ”¶æ ‡å‡†

**åŠŸèƒ½éªŒæ”¶**:
- âœ… **AC 1**: PostgresSaverå’ŒInMemorySaverå‡å¯æ­£å¸¸å·¥ä½œ
- âœ… **AC 2**: thread_idæ ¼å¼ç¬¦åˆ`canvas_{name}_{session_id}`è§„èŒƒ
- âœ… **AC 3**: configå‚æ•°åŒ…å«æ‰€æœ‰å¿…éœ€å­—æ®µï¼ˆthread_id, canvas_path, user_id, session_idï¼‰
- âœ… **AC 4**: graph.compile(checkpointer=checkpointer)æˆåŠŸç¼–è¯‘
- âœ… **AC 5**: å¤šè½®å¯¹è¯å¯å¤ç”¨ç›¸åŒthread_idå¹¶ç´¯ç§¯State
- âœ… **AC 6**: graph.get_state()å¯æ¢å¤å†å²State
- âœ… **AC 7**: å›æ»šæ“ä½œåŒæ­¥æ¢å¤Canvasæ–‡ä»¶å’ŒLangGraph State

**æ€§èƒ½éªŒæ”¶**:
- âœ… **AC 8**: å•æ¬¡checkpointå†™å…¥ < 100msï¼ˆPostgresSaverï¼‰
- âœ… **AC 9**: æ‰¹é‡æ“ä½œï¼ˆ10ä¸ªèŠ‚ç‚¹ï¼‰æ€»è€—æ—¶ < 3ç§’
- âœ… **AC 10**: checkpointæ¸…ç†è„šæœ¬å¯æ­£å¸¸è¿è¡Œ

**ä¸€è‡´æ€§éªŒæ”¶**:
- âœ… **AC 11**: Canvasæ“ä½œå¤±è´¥æ—¶ï¼Œcheckpointerä¸åˆ›å»ºæ–°checkpoint
- âœ… **AC 12**: ä¸šåŠ¡è®°å¿†å­˜å‚¨å¤±è´¥æ—¶ï¼Œä¸å½±å“Canvasæ“ä½œæˆåŠŸ
- âœ… **AC 13**: å›æ»šåCanvasæ–‡ä»¶ã€LangGraph Stateã€ä¸šåŠ¡è®°å¿†ä¸‰è€…ä¸€è‡´

**æ–‡æ¡£éªŒæ”¶**:
- âœ… **AC 14**: ä»£ç ç¤ºä¾‹å¯ç›´æ¥è¿è¡Œ
- âœ… **AC 15**: èŒè´£è¾¹ç•Œè¡¨æ ¼å®Œæ•´æ¸…æ™°
- âœ… **AC 16**: æ‰€æœ‰APIè°ƒç”¨å·²é€šè¿‡Context7/SkillséªŒè¯

**é›†æˆéªŒæ”¶**ï¼ˆä¸Epic 12 Storiesé…åˆï¼‰:
- âœ… **AC 17**: Story 12.1 checkpointeré…ç½®å¯è¢«Story 12.2è°ƒç”¨
- âœ… **AC 18**: Story 12.5å¯ä½¿ç”¨æœ¬ç« èŠ‚å®šä¹‰çš„configç»“æ„
- âœ… **AC 19**: Story 12.7æµ‹è¯•ç”¨ä¾‹è¦†ç›–checkpointeræ‰€æœ‰åœºæ™¯

---

## ğŸ“Š Section 4: Epicå’ŒStoryç»“æ„

### Epicæ¦‚è§ˆ

| Epic | åç§° | Storyæ•° | ä¼˜å…ˆçº§ | ä¼°ç®—æ—¶é—´ |
|------|------|---------|--------|---------|
| Epic 11 | FastAPIåç«¯åŸºç¡€æ¶æ„ | 6 | P0 | 2-3å‘¨ |
| Epic 12 | LangGraphå¤šAgentç¼–æ’ | 7 | P0 | 3-4å‘¨ |
| Epic 13 | Obsidian Pluginæ ¸å¿ƒåŠŸèƒ½ | 7 | P0 | 3-4å‘¨ |
| Epic 14 | è‰¾å®¾æµ©æ–¯å¤ä¹ ç³»ç»Ÿè¿ç§»+UIé›†æˆ | 8 | P0 | 2-4å‘¨ (è¿ç§») |
| Epic 15 | æ£€éªŒç™½æ¿è¿›åº¦è¿½è¸ª | 5 | P1 | 2å‘¨ |
| Epic 16 | è·¨Canvaså…³è”å­¦ä¹  | 7 | P1 | 3å‘¨ |
| Epic 17 | æ€§èƒ½ä¼˜åŒ–å’Œç›‘æ§ | 6 | P2 | 2å‘¨ |
| Epic 18 | æ•°æ®è¿ç§»å’Œå›æ»š | 5 | P1 | 1-2å‘¨ |

**æ€»æ—¶é—´ä¼°ç®—**: 18-22å‘¨ (4.5-5.5ä¸ªæœˆ)
**MVPæ—¶é—´**: 8-11å‘¨ (2-2.5ä¸ªæœˆ)

### Epic 11: FastAPIåç«¯åŸºç¡€æ¶æ„æ­å»º

**Storyåºåˆ—**:
- Story 11.1: FastAPIé¡¹ç›®åˆå§‹åŒ–å’ŒåŸºç¡€é…ç½®
- Story 11.2: canvas_utils.pyé›†æˆåˆ°FastAPI
- Story 11.3: æ ¸å¿ƒAPI endpoints (æ‹†è§£ã€è¯„åˆ†ã€è§£é‡Š)
- Story 11.4: è‰¾å®¾æµ©æ–¯å¤ä¹ ç³»ç»ŸAPI
- Story 11.5: è·¨Canvaså…³è”API
- Story 11.6: Docker Composeç¯å¢ƒé…ç½®

### Epic 12: LangGraphå¤šAgentç¼–æ’ç³»ç»Ÿ (å·¥å…·é…å¤‡æ¨¡å¼)

**Storyåºåˆ—**:
- **Story 12.1**: LangGraph StateGraphå®šä¹‰å’Œå†™å…¥å†å²æœºåˆ¶ + **LangGraph Checkpointeré›†æˆ**
  - å®šä¹‰CanvasLearningState (å«write_historyå­—æ®µ)
  - å®ç°WriteHistoryç±»
  - **[æ–°å¢] å®šä¹‰LangGraph checkpointeré…ç½®**:
    - checkpointerç±»å‹é€‰å‹: PostgresSaver (ç”Ÿäº§) / InMemorySaver (å¼€å‘)
    - thread_idç”Ÿæˆç­–ç•¥: `canvas_{canvas_name}_{session_id}`
    - configå‚æ•°ç»“æ„å®šä¹‰ (åŒ…å«thread_id, canvas_path, user_id, session_id)
  - **[æ–°å¢] graphç¼–è¯‘é…ç½®**:
    ```python
    from langgraph.checkpoint.postgres import PostgresSaver

    DB_URI = "postgresql://user:pass@localhost:5432/canvas_learning"
    checkpointer = PostgresSaver.from_conn_string(DB_URI)

    graph = builder.compile(checkpointer=checkpointer)
    ```
  - éªŒæ”¶:
    - Stateå¯æ­£ç¡®ä¼ é€’
    - å†™å…¥å†å²æ­£å¸¸è®°å½•
    - **[æ–°å¢] checkpointeræˆåŠŸæŒä¹…åŒ–å¯¹è¯çŠ¶æ€**
    - **[æ–°å¢] å¯é€šè¿‡thread_idæ¢å¤ä¹‹å‰çš„å¯¹è¯ä¸Šä¸‹æ–‡**

- **Story 12.2**: å…±äº«Toolså®ç° (FileLock + å†™å…¥å†å² + 3å±‚è®°å¿†ç³»ç»Ÿé›†æˆ + **LangGraphè®°å¿†ç³»ç»Ÿåè°ƒ**)
  - âœ… å®ç°write_to_canvaså·¥å…· (å¸¦FileLockå’Œå¿«ç…§)
  - âœ… å®ç°create_md_file_for_canvaså·¥å…· (æ”¯æŒVaultç›¸å¯¹è·¯å¾„) - **ä¿®å¤éœ€æ±‚1**
  - å®ç°add_edge_to_canvaså·¥å…·
  - å®ç°update_ebbinghauså·¥å…·
  - å®ç°query_graphiti_contextå·¥å…·
  - âœ… å®ç°store_to_graphiti_memoryå·¥å…· - **ä¿®å¤éœ€æ±‚2**
  - âœ… å®ç°store_to_temporal_memoryå·¥å…· - **ä¿®å¤éœ€æ±‚2**
  - âœ… å®ç°store_to_semantic_memoryå·¥å…· - **ä¿®å¤éœ€æ±‚2**
  - âœ… å®ç°query_graphiti_for_verificationå·¥å…· - **ä¿®å¤éœ€æ±‚3**
  - è·¨å¹³å°FileLockæµ‹è¯• (Windows/macOS/Linux)
  - âœ… æ–‡ä»¶è·¯å¾„å¯ç”¨æ€§æµ‹è¯•ï¼ˆéªŒè¯Obsidianå¯æ­£å¸¸æ‰“å¼€ç”Ÿæˆçš„.mdæ–‡ä»¶ï¼‰
  - âœ… è®°å¿†ç³»ç»Ÿè°ƒåº¦æµ‹è¯•ï¼ˆéªŒè¯åœ¨æ­£ç¡®æ—¶æœºè§¦å‘è®°å¿†å­˜å‚¨ï¼‰
  - éªŒæ”¶: æ‰€æœ‰å·¥å…·å¯å¹¶å‘è°ƒç”¨,æ•°æ®ä¸€è‡´æ€§100%

  **âš ï¸ è®°å¿†ç³»ç»Ÿè°ƒåº¦æ—¶æœºçŸ©é˜µ** (ä¿®å¤éœ€æ±‚2 + **ç²¾ç¡®åŒ–æ—¶åº**):

  | Canvasæ“ä½œ | Graphiti | Temporal | Semantic | LangGraph Checkpointer | ç²¾ç¡®æ—¶åº |
  |-----------|----------|----------|----------|----------------------|---------|
  | é—®é¢˜æ‹†è§£ | âœ… | âœ… | âŒ | âœ… (è‡ªåŠ¨) | 1. write_to_canvaså®Œæˆ â†’ Canvasæ–‡ä»¶ä¿®æ”¹<br>2. store_to_graphiti_memory â†’ çŸ¥è¯†å›¾è°±æ›´æ–°<br>3. store_to_temporal_memory â†’ æ—¶åºäº‹ä»¶è®°å½•<br>4. Agentè¿”å›new_state â†’ LangGraphè‡ªåŠ¨æŒä¹…åŒ–åˆ°checkpointer |
  | è¯„åˆ† | âœ… | âœ… | âŒ | âœ… (è‡ªåŠ¨) | 1. è®¡ç®—è¯„åˆ†<br>2. write_to_canvasæ›´æ–°é¢œè‰² â†’ Canvasæ–‡ä»¶ä¿®æ”¹<br>3. store_to_graphiti_memory(scoring_result) â†’ è¯„åˆ†å­˜å…¥çŸ¥è¯†å›¾è°±<br>4. store_to_temporal_memory(score_event) â†’ æ—¶åºè®°å½•<br>5. Agentè¿”å›new_state â†’ LangGraphæŒä¹…åŒ– |
  | ç”Ÿæˆè§£é‡Šæ–‡æ¡£ | âœ… | âœ… | âœ… | âœ… (è‡ªåŠ¨) | 1. create_md_file_for_canvas â†’ ç”Ÿæˆ.mdæ–‡ä»¶<br>2. write_to_canvasåˆ›å»ºFILEèŠ‚ç‚¹ â†’ Canvaså¼•ç”¨æ–‡ä»¶<br>3. store_to_graphiti_memory â†’ æ–‡æ¡£å…³è”å­˜å…¥å›¾è°±<br>4. store_to_semantic_memory â†’ æ–‡æ¡£å‘é‡åŒ–<br>5. store_to_temporal_memory â†’ æ—¶åºè®°å½•<br>6. Agentè¿”å›new_state â†’ LangGraphæŒä¹…åŒ– |
  | ç”Ÿæˆæ£€éªŒç™½æ¿ | âœ… (æŸ¥è¯¢+å­˜å‚¨) | âœ… | âŒ | âœ… (è‡ªåŠ¨) | 1. query_graphiti_for_verification â†’ æŸ¥è¯¢ä¸Šä¸‹æ–‡<br>2. ä¼ é€’ç»™verification-question-agent<br>3. write_to_canvasåˆ›å»ºæ£€éªŒç™½æ¿<br>4. store_to_graphiti_memory â†’ å­˜å‚¨<br>5. Agentè¿”å›new_state â†’ LangGraphæŒä¹…åŒ– |
  | è·¨Canvaså…³è” | âœ… | âœ… | âŒ | âœ… (è‡ªåŠ¨) | 1. åˆ›å»ºå…³è”å…³ç³»<br>2. store_to_graphiti_memory â†’ è·¨Canvaså…³ç³»å­˜å…¥å›¾è°±<br>3. store_to_temporal_memory â†’ å…³è”äº‹ä»¶è®°å½•<br>4. Agentè¿”å›new_state â†’ LangGraphæŒä¹…åŒ– |

  **[æ–°å¢] å·¥å…·é—´åè°ƒæœºåˆ¶**:

  **LangGraph CheckpointerèŒè´£**:
  - âœ… å­˜å‚¨Agentæ‰§è¡Œçš„ä¸­é—´çŠ¶æ€ï¼ˆCanvasLearningStateå¯¹è±¡ï¼‰
  - âœ… æ”¯æŒå¤šè½®å¯¹è¯ä¸Šä¸‹æ–‡æŒä¹…åŒ–ï¼ˆthread_idï¼‰
  - âœ… æä¾›å›æ»šèƒ½åŠ›ï¼ˆé€šè¿‡checkpoint IDå’Œtimestampï¼‰
  - âš ï¸ **ä¸å­˜å‚¨**ï¼šCanvasæ–‡ä»¶å†…å®¹ã€çŸ¥è¯†å›¾è°±ã€å­¦ä¹ äº‹ä»¶

  **GraphitiçŸ¥è¯†å›¾è°±èŒè´£**:
  - âœ… å­˜å‚¨CanvasèŠ‚ç‚¹è¯­ä¹‰å…³ç³»ï¼ˆæ¦‚å¿µå…³è”ã€å‰ç½®çŸ¥è¯†ï¼‰
  - âœ… æ”¯æŒè·¨CanvasæŸ¥è¯¢å’Œæ¨è
  - âš ï¸ **ä¸å­˜å‚¨**ï¼šAgentæ‰§è¡ŒçŠ¶æ€ã€æ–‡æ¡£å‘é‡

  **Temporalæ—¶åºè®°å¿†èŒè´£**:
  - âœ… å­˜å‚¨å­¦ä¹ äº‹ä»¶æ—¶é—´çº¿ï¼ˆæ‹†è§£æ—¶é—´ã€è¯„åˆ†æ—¶é—´ï¼‰
  - âœ… æ”¯æŒå­¦ä¹ è¿›åº¦åˆ†æå’Œç»Ÿè®¡
  - âš ï¸ **ä¸å­˜å‚¨**ï¼šæ–‡æ¡£å†…å®¹ã€çŸ¥è¯†å›¾è°±

  **Semanticè¯­ä¹‰è®°å¿†èŒè´£**:
  - âœ… å­˜å‚¨AIç”Ÿæˆæ–‡æ¡£çš„å‘é‡è¡¨ç¤º
  - âœ… æ”¯æŒè¯­ä¹‰ç›¸ä¼¼åº¦æ£€ç´¢
  - âš ï¸ **ä¸å­˜å‚¨**ï¼šCanvasèŠ‚ç‚¹ã€çŸ¥è¯†å›¾è°±

  **[æ–°å¢] é”™è¯¯å¤„ç†ç­–ç•¥**:
  ```python
  def agent_node(state: CanvasLearningState):
      try:
          # Step 1: Canvasæ“ä½œï¼ˆå…³é”®è·¯å¾„ï¼‰
          write_to_canvas(...)  # å¤±è´¥ â†’ æŠ›å‡ºå¼‚å¸¸ï¼ŒLangGraphå›æ»š

          # Step 2: è®°å¿†å­˜å‚¨ï¼ˆéå…³é”®è·¯å¾„ï¼Œæœ€ç»ˆä¸€è‡´æ€§ï¼‰
          try:
              store_to_graphiti_memory(...)
              store_to_temporal_memory(...)
          except MemoryStorageError as e:
              # è®°å½•æ—¥å¿—ï¼Œä¸é˜»å¡Canvasæ“ä½œ
              logger.error(f"Memory storage failed: {e}")
              # å¯é€‰ï¼šå¼‚æ­¥é‡è¯•æœºåˆ¶

          return new_state  # LangGraphè‡ªåŠ¨æŒä¹…åŒ–åˆ°checkpointer
      except CanvasOperationError as e:
          # Canvasæ“ä½œå¤±è´¥ â†’ æ•´ä¸ªæ“ä½œå¤±è´¥
          raise
  ```

  **è°ƒåº¦è§„åˆ™è¯´æ˜**:
  1. **Graphiti (çŸ¥è¯†å›¾è°±)**: æ‰€æœ‰Canvasæ“ä½œéƒ½åº”å­˜å‚¨ï¼Œç”¨äºæ„å»ºå­¦ä¹ çŸ¥è¯†ç½‘ç»œ
  2. **Temporal (æ—¶åºè®°å¿†)**: æ‰€æœ‰Canvasæ“ä½œéƒ½åº”å­˜å‚¨ï¼Œç”¨äºè¿½è¸ªå­¦ä¹ å†ç¨‹
  3. **Semantic (è¯­ä¹‰è®°å¿†)**: ä»…å­˜å‚¨è§£é‡Šæ–‡æ¡£ï¼Œç”¨äºæ–‡æ¡£å‘é‡æ£€ç´¢
  4. **[æ–°å¢] LangGraph Checkpointer**: æ¡†æ¶è‡ªåŠ¨æŒä¹…åŒ–Agent Stateï¼Œæ— éœ€æ‰‹åŠ¨è°ƒç”¨

  **[æ–°å¢] ä»£ç é›†æˆç¤ºä¾‹** (basic-decomposition Agentå®Œæ•´å®ç°):
  ```python
  def basic_decomposition_agent_node(state: CanvasLearningState):
      session_id = state.session_id
      canvas_path = state.canvas_path
      config = state.config  # åŒ…å«thread_id

      # Step 1: ç”Ÿæˆé—®é¢˜
      questions = generate_questions(state.concept)

      # Step 2: å†™å…¥Canvasï¼ˆå…³é”®è·¯å¾„ï¼‰
      for q in questions:
          write_to_canvas(canvas_path, {
              "id": generate_id(),
              "type": "text",
              "text": q,
              "color": "1",  # çº¢è‰²é—®é¢˜èŠ‚ç‚¹
              "x": calc_x(), "y": calc_y()
          }, config)

      # Step 3: å­˜å‚¨åˆ°è®°å¿†ç³»ç»Ÿï¼ˆéå…³é”®è·¯å¾„ï¼‰
      try:
          store_to_graphiti_memory(session_id, "decomposition", canvas_path, {
              "concept": state.concept,
              "questions": questions,
              "agent": "basic-decomposition"
          }, config)

          store_to_temporal_memory(session_id, "decomposition_completed",
              datetime.now(), {
                  "concept": state.concept,
                  "question_count": len(questions)
              }, config)
      except Exception as e:
          logger.error(f"Memory storage failed: {e}")

      # Step 4: è¿”å›æ–°Stateï¼ˆLangGraphè‡ªåŠ¨æŒä¹…åŒ–åˆ°checkpointerï¼‰
      return CanvasLearningState(
          ...state,
          last_operation="decomposition",
          decomposition_results=questions
      )
  ```

- **Story 12.3**: 12ä¸ªå·¥å…·é…å¤‡AgentèŠ‚ç‚¹åˆ›å»º
  - ä½¿ç”¨create_react_agentåˆ›å»º12ä¸ªAgent
  - æ¯ä¸ªAgenté…å¤‡shared_tools
  - é…ç½®state_modifier (æ˜ç¡®æŒ‡ç¤ºç«‹å³è°ƒç”¨å†™å…¥å·¥å…·)
  - éªŒæ”¶: æ¯ä¸ªAgentèƒ½ç‹¬ç«‹è°ƒç”¨å·¥å…·,é¦–ä¸ªèŠ‚ç‚¹<1ç§’å‡ºç°

- **Story 12.4**: canvas-orchestrator (Layer 3) é›†æˆ
  - ä¿ç•™åŸæœ‰è‡ªç„¶è¯­è¨€æ„å›¾è¯†åˆ«é€»è¾‘
  - å®ç°execute_with_langgraphæ–¹æ³•
  - å°†canvas-orchestratorçš„è®¡åˆ’è½¬æ¢ä¸ºLangGraph State
  - éªŒæ”¶: ç”¨æˆ·å‘½ä»¤æ­£ç¡®è·¯ç”±åˆ°å¯¹åº”Agent

- **Story 12.5**: LangGraph Supervisorè·¯ç”±é€»è¾‘ (Layer 4) + **Checkpointeré›†æˆ**
  - å®ç°supervisor_routerå‡½æ•°
  - æ”¯æŒå•Agentå’Œå¹¶è¡ŒAgentè°ƒåº¦
  - å®ç°æ¡ä»¶è·¯ç”± (æ ¹æ®operationç±»å‹)
  - **[æ–°å¢] graphç¼–è¯‘æ—¶é…ç½®checkpointer**:
    ```python
    from langgraph.checkpoint.postgres import PostgresSaver

    checkpointer = PostgresSaver.from_conn_string(DB_URI)
    supervisor_graph = builder.compile(checkpointer=checkpointer)
    ```
  - **[æ–°å¢] configå‚æ•°ç”Ÿæˆ**:
    ```python
    def create_langgraph_config(canvas_path: str, user_id: str, session_id: str):
        canvas_name = Path(canvas_path).stem
        thread_id = f"canvas_{canvas_name}_{session_id}"

        return {
            "configurable": {
                "thread_id": thread_id,
                "canvas_path": canvas_path,
                "user_id": user_id,
                "session_id": session_id
            }
        }
    ```
  - **[æ–°å¢] å¤šè½®å¯¹è¯æ”¯æŒ**:
    ```python
    # ç¬¬ä¸€è½®ï¼šæ‹†è§£é—®é¢˜
    config1 = create_langgraph_config("ç¦»æ•£æ•°å­¦.canvas", "user123", "session_001")
    supervisor_graph.invoke({"operation": "decomposition", ...}, config1)

    # ç¬¬äºŒè½®ï¼šè¯„åˆ†ï¼ˆç»§æ‰¿ç¬¬ä¸€è½®ä¸Šä¸‹æ–‡ï¼‰
    config2 = create_langgraph_config("ç¦»æ•£æ•°å­¦.canvas", "user123", "session_001")  # ç›¸åŒthread_id
    supervisor_graph.invoke({"operation": "scoring", ...}, config2)
    # â†‘ LangGraphè‡ªåŠ¨åŠ è½½ç¬¬ä¸€è½®çš„checkpointï¼Œæ¢å¤ä¸Šä¸‹æ–‡
    ```
  - éªŒæ”¶:
    - è·¯ç”±å‡†ç¡®ç‡100%
    - å¹¶è¡Œè°ƒåº¦æ— å†²çª
    - **[æ–°å¢] å¤šè½®å¯¹è¯ä¸Šä¸‹æ–‡æ­£ç¡®æ¢å¤**

- **Story 12.6**: å›æ»šæœºåˆ¶å’Œé”™è¯¯æ¢å¤
  - å®ç°rollback_to_timestampå’Œrollback_n_steps
  - FastAPI /api/canvas/rollbackç«¯ç‚¹
  - Obsidian Pluginå›æ»šUI
  - éªŒæ”¶: å›æ»šå‡†ç¡®ç‡100%,<2ç§’å®Œæˆ

- **Story 12.7**: ç«¯åˆ°ç«¯é›†æˆæµ‹è¯•å’Œæ€§èƒ½éªŒè¯ + **è®°å¿†ç³»ç»Ÿä¸€è‡´æ€§æµ‹è¯•**
  - æµ‹è¯•12ä¸ªAgentåœ¨çœŸå®Canvasä¸Šçš„å®Œæ•´æµç¨‹
  - éªŒè¯Epic 10.2çš„8å€æ€§èƒ½æå‡ä¿ç•™
  - æµ‹è¯•å¹¶å‘åœºæ™¯ (æœ€å¤š12ä¸ªAgentåŒæ—¶è¿è¡Œ)
  - FileLockå‹åŠ›æµ‹è¯• (æ¨¡æ‹Ÿ100æ¬¡å¹¶å‘å†™å…¥)
  - **[æ–°å¢] è®°å¿†ç³»ç»Ÿä¸€è‡´æ€§æµ‹è¯•**:
    - **æµ‹è¯•1**: CheckpointerçŠ¶æ€ä¸Canvasæ–‡ä»¶ä¸€è‡´æ€§
    - **æµ‹è¯•2**: GraphitiçŸ¥è¯†å›¾è°±ä¸CanvasèŠ‚ç‚¹å…³ç³»ä¸€è‡´æ€§
    - **æµ‹è¯•3**: Temporaläº‹ä»¶æ—¶é—´çº¿å®Œæ•´æ€§
    - **æµ‹è¯•4**: Semanticå‘é‡ä¸æ–‡æ¡£å†…å®¹ä¸€è‡´æ€§
    - **æµ‹è¯•5**: å¤šè½®å¯¹è¯ä¸Šä¸‹æ–‡æ¢å¤å‡†ç¡®æ€§
  - **[æ–°å¢] è®°å¿†å­˜å‚¨å¤±è´¥å®¹é”™æµ‹è¯•**:
    - æ¨¡æ‹ŸGraphitiè¿æ¥å¤±è´¥ â†’ Canvasæ“ä½œåº”æˆåŠŸï¼Œè®°å½•é”™è¯¯æ—¥å¿—
    - æ¨¡æ‹Ÿcheckpointerå†™å…¥å»¶è¿Ÿ â†’ ä¸å½±å“ç”¨æˆ·ä½“éªŒ
  - éªŒæ”¶:
    - æ‰€æœ‰åŠŸèƒ½å¯ç”¨
    - æ€§èƒ½ä¸é€€åŒ–
    - å¹¶å‘å®‰å…¨100%
    - **[æ–°å¢] è®°å¿†ç³»ç»Ÿä¸€è‡´æ€§100%ï¼Œå®¹é”™æœºåˆ¶æœ‰æ•ˆ**

### Epic 13: Obsidian Pluginæ ¸å¿ƒåŠŸèƒ½

**Storyåºåˆ—**:
- Story 13.1: Pluginé¡¹ç›®åˆå§‹åŒ–
- Story 13.2: Canvas APIé›†æˆ
- Story 13.3: APIå®¢æˆ·ç«¯å®ç°
- Story 13.4: æ ¸å¿ƒå‘½ä»¤ (æ‹†è§£ã€è¯„åˆ†ã€è§£é‡Š)
- Story 13.5: å³é”®èœå•å’Œå¿«æ·é”®
- Story 13.6: è®¾ç½®é¢æ¿
- Story 13.7: é”™è¯¯å¤„ç†

### Epic 14: è‰¾å®¾æµ©æ–¯å¤ä¹ ç³»ç»Ÿè¿ç§»+UIé›†æˆ

**Epicæ€§è´¨**: ğŸ”„ **è¿ç§»+é›†æˆ** (åŸºäºå·²æœ‰ebbinghaus_review.py 870è¡Œä»£ç )

**èƒŒæ™¯è¯´æ˜**:
- **å·²æœ‰å®ç°**: `ebbinghaus_review.py` (870è¡Œ, 2025-01-22å®Œæˆ)
  - âœ… SQLiteæ•°æ®åº“ (3è¡¨: review_schedules, review_history, user_review_stats)
  - âœ… ç»å…¸è‰¾å®¾æµ©æ–¯é—å¿˜æ›²çº¿ç®—æ³• R(t)=e^(-t/S)
  - âœ… åŸºç¡€CRUDæ“ä½œ (æ·»åŠ æ¦‚å¿µã€æŸ¥è¯¢åˆ°æœŸã€æ›´æ–°å¤ä¹ è®°å½•)
- **æœ¬Epicç›®æ ‡**:
  1. **ç®—æ³•å‡çº§**: ä»ç»å…¸å…¬å¼è¿ç§»åˆ°Py-FSRS (å‡†ç¡®æ€§æå‡20-30%)
  2. **Obsidian UIé›†æˆ**: åˆ›å»ºä¾§è¾¹æ å¤ä¹ é¢æ¿ (åŸºäºFR3.3 Mockup)
  3. **FastAPIæ¥å£å°è£…**: å°†Pythonå‡½æ•°å°è£…ä¸ºREST API
  4. **LangGraphé›†æˆ**: å¤ä¹ æ¨é€æ¥å…¥LangGraph Supervisorè·¯ç”±

**è¿ç§»ç­–ç•¥**:
```python
# é˜¶æ®µ1: ä¿ç•™ç°æœ‰SQLite schema,æ–°å¢Py-FSRSå­—æ®µ (å‘åå…¼å®¹)
ALTER TABLE review_schedules ADD COLUMN fsrs_card_json TEXT;  # å­˜å‚¨FSRSCardåºåˆ—åŒ–

# é˜¶æ®µ2: åŒç®—æ³•å¹¶è¡Œè¿è¡Œ (1å‘¨è§‚å¯ŸæœŸ)
if USE_FSRS_ALGORITHM:
    card = fsrs.review_card(card, rating)  # ä½¿ç”¨Py-FSRS
else:
    retention_rate = calculate_retention_rate(time_elapsed, memory_strength)  # ç»å…¸å…¬å¼

# é˜¶æ®µ3: å®Œå…¨åˆ‡æ¢åˆ°Py-FSRS (ä¿ç•™ç»å…¸ç®—æ³•ä½œä¸ºfallback)
```

**å·¥ä½œé‡ä¼°ç®—è°ƒæ•´**:
- **åŸä¼°ç®— (æ–°å¼€å‘)**: 6-8å‘¨
- **æ–°ä¼°ç®— (è¿ç§»+UI)**: 2-4å‘¨ (ä»£ç å¤ç”¨ç‡~70%)

**Storyåºåˆ—**:
- Story 14.1: Py-FSRSç®—æ³•è¿ç§» (2-3å¤©)
  - æ•°æ®åº“schemaæ‰©å±• (æ–°å¢fsrs_card_jsonåˆ—)
  - FSRSCard <-> SQLiteåºåˆ—åŒ–/ååºåˆ—åŒ–
  - åŒç®—æ³•A/Bæµ‹è¯•æ¡†æ¶
  - æ•°æ®è¿ç§»è„šæœ¬ (å†å²å¤ä¹ è®°å½•è½¬æ¢)

- Story 14.2: FastAPIæ¥å£å°è£… (1-2å¤©)
  - POST /api/review/add-concept
  - GET /api/review/today-summary
  - POST /api/review/complete
  - GET /api/review/history

- Story 14.3: å¤ä¹ é¢æ¿è§†å›¾ (Obsidian Plugin) (3-4å¤©)
  - ä¾§è¾¹æ Viewæ³¨å†Œ
  - Canvaså¡ç‰‡åˆ—è¡¨æ¸²æŸ“ (åŸºäºFR3.3 Mockup)
  - ç´§æ€¥ç¨‹åº¦æ ·å¼ (urgent/high/medium/low)
  - å“åº”å¼å¸ƒå±€

- Story 14.4: ä»Šæ—¥å¤ä¹ åˆ—è¡¨ä¸äº¤äº’ (2-3å¤©)
  - "å¼€å§‹å¤ä¹ "æŒ‰é’® â†’ è°ƒç”¨generate_review_canvas_file()
  - "æ¨è¿Ÿ1å¤©"æŒ‰é’® â†’ è°ƒæ•´Card.dueæ—¶é—´
  - å³é”®èœå• ("æ ‡è®°ä¸ºå·²æŒæ¡" / "é‡ç½®è¿›åº¦")
  - Canvaså¡ç‰‡ç‚¹å‡» â†’ æ‰“å¼€åŸç™½æ¿

- Story 14.5: ä¸€é”®ç”Ÿæˆæ£€éªŒç™½æ¿é›†æˆ (1å¤©)
  - å¤ç”¨Epic 4å·²æœ‰generate_review_canvas_file()
  - ä¼ å…¥Canvasæ–‡ä»¶è·¯å¾„å’Œåˆ°æœŸæ¦‚å¿µåˆ—è¡¨
  - æ£€éªŒç™½æ¿ç”Ÿæˆåè‡ªåŠ¨æ‰“å¼€

- Story 14.6: å¤ä¹ å†å²æŸ¥çœ‹ (1-2å¤©)
  - å†å²è®°å½•åˆ—è¡¨ (æœ€è¿‘7å¤©/30å¤©åˆ‡æ¢)
  - æ¯æ—¥å¤ä¹ ç»Ÿè®¡å›¾è¡¨ (å¤ä¹ æ¦‚å¿µæ•°ã€å¹³å‡è¯„åˆ†)
  - å•ä¸ªæ¦‚å¿µçš„å¤ä¹ è½¨è¿¹æŸ¥çœ‹

- Story 14.7: å¤ä¹ æé†’é€šçŸ¥ (1å¤©)
  - Obsidian Notice APIé›†æˆ
  - æ¯æ—¥é¦–æ¬¡æ‰“å¼€è§¦å‘æé†’
  - æé†’å¼€å…³é…ç½® (æ’ä»¶è®¾ç½®é¡µ)

- Story 14.8: å¤ä¹ ç»Ÿè®¡å›¾è¡¨ (2å¤©)
  - æœ¬å‘¨/æœ¬æœˆå¤ä¹ æ¦‚å¿µæ•°è¶‹åŠ¿å›¾ (Chart.js)
  - å¹³å‡è¯„åˆ†è¶‹åŠ¿
  - è¿ç»­å¤ä¹ å¤©æ•°å¾½ç« 
  - å„Canvaså¤ä¹ è¦†ç›–ç‡é¥¼å›¾

### Epic 15: æ£€éªŒç™½æ¿è¿›åº¦è¿½è¸ªç³»ç»Ÿ

**Storyåºåˆ—**:
- Story 15.1: sourceNodeIdå…ƒæ•°æ®å†™å…¥
- Story 15.2: è¿›åº¦åˆ†æç®—æ³•
- Story 15.3: è¿›åº¦è¿½è¸ªUIç»„ä»¶
- Story 15.4: å®æ—¶è¿›åº¦æ›´æ–° (WebSocket)
- Story 15.5: è¿›åº¦å¯è§†åŒ–

### Epic 16: è·¨Canvaså…³è”å­¦ä¹ ç³»ç»Ÿ

**Storyåºåˆ—**:
- Story 16.1: Canvaså…³è”UI (å·¥å…·æ æŒ‰é’® + æ¨¡æ€æ¡†)
- Story 16.2: .canvas-links.jsoné…ç½®ç®¡ç†
- Story 16.3: Graphitiè·¨Canvaså…³ç³»å­˜å‚¨
- Story 16.4: å…³è”æ¨¡å¼Toggleæ§åˆ¶
- Story 16.5: Agentå¼•ç”¨æ•™æä¸Šä¸‹æ–‡
- Story 16.6: æ•™æå¼•ç”¨æ˜¾ç¤º
- Story 16.7: å…³è”çŠ¶æ€æŒ‡ç¤ºå™¨

---

## âš ï¸ Section 5: é£é™©è¯„ä¼°

### æŠ€æœ¯é£é™©

| é£é™© | å½±å“ | å¯èƒ½æ€§ | ç¼“è§£ç­–ç•¥ |
|------|------|--------|---------|
| LangGraphæ€§èƒ½ä¸å¦‚ç›´æ¥è°ƒç”¨ | é«˜ | ä¸­ | æ€§èƒ½åŸºå‡†æµ‹è¯•,ä¿ç•™Epic 10.2ä¼˜åŒ– |
| Obsidian APIé™åˆ¶ | é«˜ | ä½ | POCéªŒè¯,å¤‡ç”¨Vaultæ–‡ä»¶æ“ä½œ |
| Dockeré…ç½®å¤æ‚ | ä¸­ | ä¸­ | è¯¦ç»†æ–‡æ¡£,è‡ªåŠ¨åŒ–è„šæœ¬ |
| è·¨å¹³å°å…¼å®¹æ€§ | ä¸­ | ä¸­ | CI/CDå¤šå¹³å°æµ‹è¯• |

### è¿ç§»é£é™©

| é£é™© | å½±å“ | å¯èƒ½æ€§ | ç¼“è§£ç­–ç•¥ |
|------|------|--------|---------|
| ç”¨æˆ·æ•°æ®ä¸¢å¤± | æé«˜ | ä½ | Epic 18å¤‡ä»½æœºåˆ¶,åŒç³»ç»ŸéªŒè¯ |
| åŠŸèƒ½å›é€€ | é«˜ | ä¸­ | å®Œæ•´æµ‹è¯•,ä¿ç•™CLI fallback |
| ç”¨æˆ·å­¦ä¹ æˆæœ¬é«˜ | ä¸­ | é«˜ | è¯¦ç»†æ–‡æ¡£,è§†é¢‘æ•™ç¨‹ |

### å›æ»šè®¡åˆ’

**è§¦å‘æ¡ä»¶**:
- æ•°æ®ä¸¢å¤±æˆ–æŸå
- ä¸¥é‡æ€§èƒ½é€€åŒ– (>50%)
- å…³é”®åŠŸèƒ½å¤±æ•ˆ

**å›æ»šæ­¥éª¤**:
1. åœæ­¢FastAPIå’ŒNeo4jæœåŠ¡
2. æ¢å¤å¤‡ä»½æ•°æ®
3. åˆ‡æ¢å›CLIå‘½ä»¤
4. é€šçŸ¥ç”¨æˆ·

---

## ğŸ“ˆ Section 6: æˆåŠŸæŒ‡æ ‡

### å…³é”®æŒ‡æ ‡ (KPI)

| æŒ‡æ ‡ | ç›®æ ‡ | æµ‹é‡æ–¹æ³• |
|------|------|---------|
| åŠŸèƒ½è¿ç§»å®Œæ•´æ€§ | 100% (12ä¸ªAgentå…¨éƒ¨å¯ç”¨) | åŠŸèƒ½æ¸…å•éªŒè¯ |
| æ€§èƒ½ä¸é€€åŒ– | â‰¥ç°æœ‰ç³»ç»Ÿ | æ€§èƒ½åŸºå‡†æµ‹è¯• |
| ç”¨æˆ·æ»¡æ„åº¦ | â‰¥80% | ç”¨æˆ·è°ƒç ” |
| çª—å£åˆ‡æ¢æ¬¡æ•° | 0 (å®Œå…¨åœ¨Obsidianå†…æ“ä½œ) | ç”¨æˆ·è§‚å¯Ÿ |
| æ•°æ®é›¶ä¸¢å¤± | 100% | è¿ç§»éªŒè¯ |

---

## ğŸ“… Section 7: äº¤ä»˜è®¡åˆ’

### Phase 1: MVP (8-11å‘¨)

**äº¤ä»˜å†…å®¹**:
- âœ… Epic 11: FastAPIåç«¯
- âœ… Epic 12: LangGraphç¼–æ’
- âœ… Epic 13: Pluginæ ¸å¿ƒåŠŸèƒ½
- âœ… Story 14.1-14.3: å¤ä¹ é¢æ¿æ ¸å¿ƒ

**éªŒæ”¶æ ‡å‡†**:
- ç”¨æˆ·å¯åœ¨Obsidianå†…å®Œæˆæ‰€æœ‰12ä¸ªAgentæ“ä½œ
- æ€§èƒ½ä¸ä½äºç°æœ‰ç³»ç»Ÿ
- ä»Šæ—¥å¤ä¹ åŠŸèƒ½å¯ç”¨

### Phase 2: å®Œæ•´åŠŸèƒ½ (18-22å‘¨)

**äº¤ä»˜å†…å®¹**:
- âœ… Epic 14: è‰¾å®¾æµ©æ–¯å¤ä¹ ç³»ç»Ÿè¿ç§»+UIé›†æˆå®Œæ•´åŠŸèƒ½
- âœ… Epic 15: è¿›åº¦è¿½è¸ª
- âœ… Epic 16: è·¨Canvaså…³è”
- âœ… Epic 18: æ•°æ®è¿ç§»

---

## âœ… Section 8: éªŒæ”¶æ ‡å‡†

### æœ€ç»ˆéªŒæ”¶æ¸…å•

- [ ] æ‰€æœ‰12ä¸ªAgentåŠŸèƒ½100%å¯ç”¨
- [ ] Epic 10.2æ€§èƒ½ä¼˜åŠ¿ä¿ç•™ (8å€æå‡)
- [ ] è‰¾å®¾æµ©æ–¯å¤ä¹ é¢æ¿æ­£å¸¸å·¥ä½œ
- [ ] æ£€éªŒç™½æ¿è¿›åº¦è¿½è¸ªå‡†ç¡®æ˜¾ç¤º
- [ ] è·¨Canvaså…³è”UIå¯é…ç½®
- [ ] æµ‹è¯•è¦†ç›–ç‡ â‰¥85%
- [ ] æ–‡æ¡£å®Œæ•´æ€§ 100%
- [ ] ç”¨æˆ·æ»¡æ„åº¦ â‰¥80%
- [ ] æ•°æ®è¿ç§»é›¶ä¸¢å¤±
- [ ] å›æ»šæœºåˆ¶éªŒè¯é€šè¿‡

---

## ğŸ“š é™„å½•

### A. å‚è€ƒæ–‡æ¡£

- Canvas Learning System CLAUDE.md
- Epic 10.2 Completion Report
- Story 4.9 (sourceNodeIdå…ƒæ•°æ®)
- Story 6.1 (GraphitiçŸ¥è¯†å›¾è°±)
- LangGraphå®˜æ–¹æ–‡æ¡£ (Context7)

### B. æœ¯è¯­è¡¨

- **LangGraph**: LangChainçš„å›¾ç¼–æ’æ¡†æ¶,ç”¨äºæ„å»ºå¤šAgentç³»ç»Ÿ
- **Supervisor Pattern**: ä¸­å¤®è·¯ç”±å™¨æ¨¡å¼,ä¸€ä¸ªSupervisorè°ƒåº¦å¤šä¸ªWorker Agent
- **Graphiti**: æ—¶é—´æ„ŸçŸ¥çŸ¥è¯†å›¾è°±æ¡†æ¶
- **Py-FSRS**: Pythonå®ç°çš„FSRSé—´éš”é‡å¤ç®—æ³•
- **FileLock**: è·¨å¹³å°æ–‡ä»¶é”æœºåˆ¶,é˜²æ­¢å¹¶å‘å†™å…¥å†²çª
- **create_react_agent**: LangGraphçš„å·¥å…·é…å¤‡Agentåˆ›å»ºå‡½æ•°
- **Tool-Equipped Agent**: é…å¤‡å·¥å…·çš„Agent,å¯ç›´æ¥è°ƒç”¨å‡½æ•°å®Œæˆä»»åŠ¡
- **WriteHistory**: å†™å…¥å†å²è®°å½•ç³»ç»Ÿ,æ”¯æŒå›æ»šæ“ä½œ

### C. æ¶æ„è°ƒæ•´è¯´æ˜ (v1.0 â†’ v1.1)

#### è°ƒæ•´åŠ¨æœº

**ç”¨æˆ·æ ¸å¿ƒéœ€æ±‚**: "æˆ‘éœ€è¦èƒ½åœ¨Canvasç™½æ¿è¿›è¡Œå¿«é€Ÿçš„èŠ‚ç‚¹ç”Ÿæˆ,é‚£ä¹ˆæˆ‘æ˜¯å¦ç»™å„ä¸ªè§£é‡Šagentä¸­ç›´æ¥é…å¤‡å†™å…¥å·¥å…·"

**åŸå§‹è®¾è®¡ (v1.0)** çš„é—®é¢˜:
- âŒ é›†ä¸­å¼å†™å…¥ (canvas_finalizer): æ‰€æœ‰Agentå®Œæˆåç»Ÿä¸€å†™å…¥
- âŒ é¦–ä¸ªèŠ‚ç‚¹å‡ºç°æ—¶é—´: 8-10ç§’ (ç”¨æˆ·éœ€è¦ç­‰å¾…æ‰€æœ‰Agentå®Œæˆ)
- âŒ æ— å®æ—¶åé¦ˆ: ç”¨æˆ·ä¸çŸ¥é“Agentæ˜¯å¦åœ¨å·¥ä½œ

#### æ¶æ„å˜æ›´è¯¦æƒ…

**å˜æ›´1: åŒå±‚Supervisorè®¾è®¡**

| å±‚çº§ | ç»„ä»¶ | ä½œç”¨ | å˜æ›´ç±»å‹ |
|------|------|------|---------|
| Layer 3 | canvas-orchestrator | è‡ªç„¶è¯­è¨€æ„å›¾è¯†åˆ«ã€è®¡åˆ’ç”Ÿæˆ | âœ… **ä¿ç•™** |
| Layer 4 | LangGraph Supervisor | å¹¶å‘è°ƒåº¦ã€çŠ¶æ€ç®¡ç† | ğŸ†• **æ–°å¢** |

**ç†ç”±**: ä¿ç•™canvas-orchestratorçš„æ™ºèƒ½è·¯ç”±ä¼˜åŠ¿,åŒæ—¶å¼•å…¥LangGraphçš„å¹¶å‘æ‰§è¡Œå¼•æ“

**å˜æ›´2: å·¥å…·é…å¤‡Agent**

| v1.0 è®¾è®¡ | v1.1 è®¾è®¡ (æœ€ç»ˆ) |
|----------|-----------------|
| Agentè¿”å›JSON â†’ canvas_finalizerå†™å…¥ | Agentç›´æ¥è°ƒç”¨write_to_canvaså·¥å…· |
| é›†ä¸­å¼å†™å…¥,é¡ºåºæ‰§è¡Œ | åˆ†å¸ƒå¼å†™å…¥,å¹¶å‘æ‰§è¡Œ |
| 8-10ç§’é¦–ä¸ªèŠ‚ç‚¹å‡ºç° | **0.5-1ç§’é¦–ä¸ªèŠ‚ç‚¹å‡ºç°** âš¡ |

**ç†ç”±**: å®æ—¶åé¦ˆ,ç”¨æˆ·ä½“éªŒæ˜¾è‘—æå‡

**å˜æ›´3: FileLockå¹¶å‘å®‰å…¨**

- **æ–°å¢ç»„ä»¶**: FileLockç±» (è·¨å¹³å°æ–‡ä»¶é”)
- **ä½œç”¨**: å¤šä¸ªAgentåŒæ—¶å†™å…¥Canvasæ—¶,è‡ªåŠ¨æ’é˜Ÿ,é¿å…æ•°æ®å†²çª
- **æ€§èƒ½å¼€é”€**: <100msé”ç­‰å¾…æ—¶é—´ (å¯æ¥å—)

**å˜æ›´4: å†™å…¥å†å²å’Œå›æ»š**

- **æ–°å¢ç»„ä»¶**: WriteHistoryç±»
- **ä½œç”¨**: è®°å½•æ‰€æœ‰å†™å…¥æ“ä½œ,æ”¯æŒæŒ‰æ—¶é—´ç‚¹æˆ–æ­¥æ•°å›æ»š
- **ç”¨æˆ·ä»·å€¼**: Agentæ“ä½œå‡ºé”™æ—¶,å¯å¿«é€Ÿæ¢å¤åˆ°ä¹‹å‰çŠ¶æ€

#### æ€§èƒ½å¯¹æ¯”

| æŒ‡æ ‡ | v1.0 (é›†ä¸­å¼) | v1.1 (å·¥å…·é…å¤‡) | æå‡ |
|------|--------------|----------------|------|
| é¦–ä¸ªèŠ‚ç‚¹å‡ºç°æ—¶é—´ | 8-10ç§’ | 0.5-1ç§’ | **8-16å€** âš¡ |
| ç”¨æˆ·å¯è§åé¦ˆ | æ“ä½œç»“æŸå | å®æ—¶ (æ¯0.5ç§’) | âœ… æ˜¾è‘—æ”¹å–„ |
| Epic 10.2æ€§èƒ½ | 8å€å¹¶å‘æå‡ | 8å€å¹¶å‘æå‡ | âœ… å®Œå…¨ä¿ç•™ |
| å¹¶å‘å®‰å…¨ | N/A (é¡ºåºæ‰§è¡Œ) | FileLockä¿æŠ¤ | âœ… æ–°å¢ |
| é”™è¯¯æ¢å¤ | æ—  | WriteHistoryå›æ»š | âœ… æ–°å¢ |

#### å…¼å®¹æ€§å½±å“

**100%å‘åå…¼å®¹**:
- âœ… æ‰€æœ‰12ä¸ªAgentåŠŸèƒ½å®Œå…¨ä¿ç•™
- âœ… canvas_utils.py 3å±‚æ¶æ„æ— å˜åŒ–
- âœ… Epic 10.2å¼‚æ­¥æ‰§è¡Œå¼•æ“ä¿ç•™
- âœ… GraphitiçŸ¥è¯†å›¾è°±é›†æˆä¿ç•™

**æ–°å¢èƒ½åŠ›**:
- âœ… å®æ—¶èŠ‚ç‚¹ç”Ÿæˆ
- âœ… å¹¶å‘å†™å…¥å®‰å…¨
- âœ… æ“ä½œå›æ»š
- âœ… å†™å…¥å†å²è¿½æº¯

#### é£é™©ç¼“è§£

| é£é™© | ç¼“è§£æªæ–½ | çŠ¶æ€ |
|------|---------|------|
| FileLockæ€§èƒ½å¼€é”€ | åŸºå‡†æµ‹è¯•,<100mså¼€é”€ | âœ… å¯æ¥å— |
| è·¨å¹³å°å…¼å®¹æ€§ | Windows/macOS/Linuxæµ‹è¯• | ğŸ“‹ Story 12.2 |
| å¹¶å‘å†™å…¥å†²çª | FileLock + å‹åŠ›æµ‹è¯• | ğŸ“‹ Story 12.7 |
| å›æ»šæ•°æ®ä¸¢å¤± | å¿«ç…§éªŒè¯æµ‹è¯• | ğŸ“‹ Story 12.6 |

---

**æ–‡æ¡£ç»“æŸ**

**æ–‡æ¡£ç‰ˆæœ¬**: v1.1 (æ¶æ„è°ƒæ•´ç‰ˆ)
**åŸå§‹ç‰ˆæœ¬**: v1.0 (2025-01-15)
**è°ƒæ•´æ—¥æœŸ**: 2025-01-15
**è°ƒæ•´åŸå› **: ç”¨æˆ·åé¦ˆè¦æ±‚å¿«é€ŸèŠ‚ç‚¹ç”Ÿæˆå’Œå®æ—¶åé¦ˆ

**ä¸‹ä¸€æ­¥**: å¼€å§‹Epic 11 Story 11.1å®æ–½

**æ‰¹å‡†ç­¾å**: ___________
**æ—¥æœŸ**: 2025-01-15
