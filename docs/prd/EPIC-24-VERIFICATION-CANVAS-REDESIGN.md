# Epic 24: æ£€éªŒç™½æ¿é‡æ–°è®¾è®¡ (æ™ºèƒ½å¼•å¯¼æ¨¡å¼)

---
epic_id: EPIC-24
title: "æ£€éªŒç™½æ¿é‡æ–°è®¾è®¡ - æ™ºèƒ½å¼•å¯¼æ¨¡å¼"
status: planned
priority: P1
created: 2025-12-11
estimated_stories: 5
related_bugs: [Bug-4]
dependencies: [EPIC-21, EPIC-23]
---

## 1. é—®é¢˜æ¦‚è¿°

### 1.1 Bugæè¿°

**Bug 4: æ£€éªŒç™½æ¿è®¾è®¡å¤±è´¥ (éœ€é‡æ–°è®¾è®¡)**

å½“å‰æ£€éªŒç™½æ¿ç”ŸæˆåŠŸèƒ½å­˜åœ¨æ ¹æœ¬æ€§è®¾è®¡é—®é¢˜ï¼š
- ç”Ÿæˆçš„éªŒè¯é—®é¢˜ä¸åŸCanvaså†…å®¹è„±èŠ‚
- ç¼ºå°‘RAGä¸Šä¸‹æ–‡æ³¨å…¥
- æ— æ™ºèƒ½å¼•å¯¼ï¼Œåªæ˜¯æœºæ¢°åœ°åˆ›å»ºç©ºç™½èŠ‚ç‚¹
- ç”¨æˆ·æ— æ³•è·å¾—æœ‰æ•ˆçš„çŸ¥è¯†æ£€éªŒä½“éªŒ

### 1.2 ç”¨æˆ·éœ€æ±‚

æ ¹æ®ç”¨æˆ·ç¡®è®¤ï¼Œæ£€éªŒç™½æ¿éœ€è¦ï¼š

| éœ€æ±‚ | æè¿° | ä¼˜å…ˆçº§ |
|------|------|--------|
| **æ™ºèƒ½å¼•å¯¼æ¨¡å¼** | Socraticå¼å¼•å¯¼ï¼Œé€æ­¥å¼•å¯¼ç”¨æˆ·å›å¿† | P0 |
| **åŠ¨æ€Agenté€‰æ‹©** | æ ¹æ®ç”¨æˆ·å›ç­”è´¨é‡å®æ—¶å†³å®šä¸‹ä¸€æ­¥Agent | P0 |
| **å®æ—¶è¿›åº¦æ˜¾ç¤º** | æ˜¾ç¤ºè¿˜åŸè¿›åº¦ï¼Œè®©ç”¨æˆ·çŸ¥é“å®Œæˆåº¦ | P1 |
| **RAGä¸Šä¸‹æ–‡** | éªŒè¯é—®é¢˜åŸºäºå­¦ä¹ å†å²å’ŒçŸ¥è¯†å›¾è°±ç”Ÿæˆ | P1 |

### 1.3 å½“å‰å®ç°é—®é¢˜

```python
# backend/app/services/review_service.py
async def generate_verification_canvas(self, source_canvas_name: str):
    """
    å½“å‰å®ç°:
    1. è¯»å–æºCanvas
    2. åˆ›å»ºç©ºç™½é»„è‰²èŠ‚ç‚¹
    3. ä¿å­˜æ–°Canvas

    é—®é¢˜:
    - æ— RAGä¸Šä¸‹æ–‡
    - æ— æ™ºèƒ½é—®é¢˜ç”Ÿæˆ
    - æ— å¼•å¯¼å¼æµç¨‹
    - éªŒè¯é—®é¢˜è´¨é‡ä½
    """
```

---

## 2. é‡æ–°è®¾è®¡æ–¹æ¡ˆ

### 2.1 æ™ºèƒ½å¼•å¯¼æ¨¡å¼æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Verification Canvas 2.0                           â”‚
â”‚                     (æ™ºèƒ½å¼•å¯¼æ¨¡å¼)                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚                  LangGraph StateGraph                        â”‚    â”‚
â”‚  â”‚                    (Socratic Loop)                           â”‚    â”‚
â”‚  â”‚                                                              â”‚    â”‚
â”‚  â”‚   START                                                      â”‚    â”‚
â”‚  â”‚     â”‚                                                        â”‚    â”‚
â”‚  â”‚     â–¼                                                        â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                            â”‚    â”‚
â”‚  â”‚  â”‚ ç”Ÿæˆå¼•å¯¼é—®é¢˜  â”‚ â† RAGä¸Šä¸‹æ–‡ (Epic 23)                      â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                                            â”‚    â”‚
â”‚  â”‚         â”‚                                                    â”‚    â”‚
â”‚  â”‚         â–¼                                                    â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                            â”‚    â”‚
â”‚  â”‚  â”‚ ç­‰å¾…ç”¨æˆ·å›ç­”  â”‚ â† åˆ›å»ºé»„è‰²èŠ‚ç‚¹                             â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                                            â”‚    â”‚
â”‚  â”‚         â”‚                                                    â”‚    â”‚
â”‚  â”‚         â–¼                                                    â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                            â”‚    â”‚
â”‚  â”‚  â”‚ è¯„ä¼°å›ç­”è´¨é‡  â”‚ â† scoring-agent                           â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                                            â”‚    â”‚
â”‚  â”‚         â”‚                                                    â”‚    â”‚
â”‚  â”‚    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”                                               â”‚    â”‚
â”‚  â”‚    â–¼         â–¼                                               â”‚    â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                        â”‚    â”‚
â”‚  â”‚ â”‚ é«˜åˆ† â”‚ â”‚ ä½åˆ†     â”‚                                        â”‚    â”‚
â”‚  â”‚ â”‚â†’ç»¿è‰² â”‚ â”‚â†’æç¤ºå¼•å¯¼ â”‚ â† åŠ¨æ€é€‰æ‹©æç¤ºAgent                     â”‚    â”‚
â”‚  â”‚ â””â”€â”€â”¬â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                                        â”‚    â”‚
â”‚  â”‚    â”‚          â”‚                                              â”‚    â”‚
â”‚  â”‚    â”‚    â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”                                        â”‚    â”‚
â”‚  â”‚    â”‚    â–¼           â–¼                                        â”‚    â”‚
â”‚  â”‚    â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”                                   â”‚    â”‚
â”‚  â”‚    â”‚ â”‚å†æ¬¡å°è¯•â”‚ â”‚æ”¾å¼ƒ    â”‚                                   â”‚    â”‚
â”‚  â”‚    â”‚ â”‚(å¾ªç¯)  â”‚ â”‚â†’ç´«è‰²   â”‚                                   â”‚    â”‚
â”‚  â”‚    â”‚ â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                                   â”‚    â”‚
â”‚  â”‚    â”‚     â”‚          â”‚                                        â”‚    â”‚
â”‚  â”‚    â””â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                        â”‚    â”‚
â”‚  â”‚          â”‚                                                   â”‚    â”‚
â”‚  â”‚          â–¼                                                   â”‚    â”‚
â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                           â”‚    â”‚
â”‚  â”‚   â”‚ ä¸‹ä¸€ä¸ªæ¦‚å¿µï¼Ÿ  â”‚                                           â”‚    â”‚
â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                                           â”‚    â”‚
â”‚  â”‚          â”‚                                                   â”‚    â”‚
â”‚  â”‚     â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”                                              â”‚    â”‚
â”‚  â”‚     â–¼         â–¼                                              â”‚    â”‚
â”‚  â”‚   è¿˜æœ‰      å…¨éƒ¨å®Œæˆ                                         â”‚    â”‚
â”‚  â”‚   â†“            â†“                                             â”‚    â”‚
â”‚  â”‚ å¾ªç¯START    END                                             â”‚    â”‚
â”‚  â”‚                                                              â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 Socraticå¼•å¯¼ç­–ç•¥

| å›ç­”è´¨é‡ | è¯„åˆ† | é¢œè‰² | ä¸‹ä¸€æ­¥åŠ¨ä½œ |
|----------|------|------|-----------|
| **å®Œå…¨æ­£ç¡®** | 85-100 | ğŸŸ¢ ç»¿è‰² | è¿›å…¥ä¸‹ä¸€ä¸ªæ¦‚å¿µ |
| **éƒ¨åˆ†æ­£ç¡®** | 60-84 | ğŸŸ¡ é»„è‰² | æä¾›æç¤ºï¼Œå†æ¬¡å°è¯• |
| **åŸºæœ¬é”™è¯¯** | 30-59 | ğŸŸ  æ©™è‰² | æä¾›æ›´å¤šæç¤º/ä¾‹å­ |
| **å®Œå…¨é”™è¯¯** | 0-29 | ğŸ”´ çº¢è‰² | æ˜¾ç¤ºç­”æ¡ˆï¼Œæ ‡è®°éœ€å¤ä¹  |
| **æ”¾å¼ƒ/è·³è¿‡** | - | ğŸŸ£ ç´«è‰² | è®°å½•ï¼Œåç»­é‡ç‚¹å¤ä¹  |

### 2.3 åŠ¨æ€Agenté€‰æ‹©

æ ¹æ®ç”¨æˆ·å›ç­”è´¨é‡ï¼Œç³»ç»ŸåŠ¨æ€é€‰æ‹©æœ€åˆé€‚çš„å¼•å¯¼Agentï¼š

```python
def select_guidance_agent(answer_quality: str, concept_type: str) -> str:
    """
    æ ¹æ®å›ç­”è´¨é‡å’Œæ¦‚å¿µç±»å‹é€‰æ‹©å¼•å¯¼Agent
    """
    if answer_quality == "partial":
        # éƒ¨åˆ†æ­£ç¡® â†’ ä½¿ç”¨memory-anchorå¸®åŠ©å›å¿†
        return "memory-anchor"
    elif answer_quality == "wrong":
        # é”™è¯¯ â†’ ä½¿ç”¨example-teachingæä¾›ä¾‹å­
        return "example-teaching"
    elif answer_quality == "confused":
        # æ··æ·† â†’ ä½¿ç”¨comparison-tableåŒºåˆ†
        return "comparison-table"
    else:
        # å®Œå…¨ä¸ä¼š â†’ ä½¿ç”¨basic-decompositionæ‹†è§£
        return "basic-decomposition"
```

---

## 3. Stories

### Story 24.1: æ™ºèƒ½å¼•å¯¼æ¨¡å¼æ¶æ„è®¾è®¡

**ä¼˜å…ˆçº§**: P0 (Critical)
**ä¼°è®¡**: 4 Story Points

#### æè¿°

è®¾è®¡å¹¶å®ç°æ£€éªŒç™½æ¿2.0çš„æ ¸å¿ƒæ¶æ„ï¼ŒåŸºäºLangGraph StateGraphæ„å»ºSocraticå¼•å¯¼å¾ªç¯ã€‚

#### éªŒæ”¶æ ‡å‡† (AC)

- [ ] AC 1: å®šä¹‰ `VerificationState` TypedDict
- [ ] AC 2: å®ç° LangGraph StateGraph éª¨æ¶
- [ ] AC 3: æ”¯æŒæ¦‚å¿µé˜Ÿåˆ—ç®¡ç†
- [ ] AC 4: æ”¯æŒè¿›åº¦çŠ¶æ€è·Ÿè¸ª
- [ ] AC 5: åˆ›å»º `verification_service.py`

#### æŠ€æœ¯ä»»åŠ¡

1. è®¾è®¡ `VerificationState` åŒ…å«æ‰€æœ‰å¿…è¦å­—æ®µ
2. å®ç°StateGraphèŠ‚ç‚¹å®šä¹‰
3. å®ç°æ¡ä»¶è¾¹è·¯ç”±é€»è¾‘
4. åˆ›å»º `VerificationService` ç±»
5. ç¼–å†™æ¶æ„æµ‹è¯•

#### å…³é”®æ–‡ä»¶

- æ–°å»º: `backend/app/services/verification_service.py`
- æ–°å»º: `src/verification_graph/state.py`
- æ–°å»º: `src/verification_graph/graph.py`

#### Stateè®¾è®¡

```python
class VerificationState(TypedDict):
    """æ£€éªŒç™½æ¿State"""
    # æºCanvasä¿¡æ¯
    source_canvas: str
    source_nodes: List[Dict]

    # æ¦‚å¿µé˜Ÿåˆ—
    concept_queue: List[str]
    current_concept: str
    current_concept_idx: int

    # ç”¨æˆ·å›ç­”
    user_answer: str
    answer_quality: str  # excellent/good/partial/wrong
    answer_score: float

    # è¿›åº¦è·Ÿè¸ª
    total_concepts: int
    completed_concepts: int
    green_count: int
    purple_count: int
    red_count: int

    # å¼•å¯¼çŠ¶æ€
    hints_given: int
    max_hints: int
    selected_agent: str

    # ç»“æœCanvas
    verification_canvas: Dict
```

---

### Story 24.2: Socraticå¼é—®ç­”æµç¨‹

**ä¼˜å…ˆçº§**: P0 (Critical)
**ä¼°è®¡**: 5 Story Points

#### æè¿°

å®ç°å®Œæ•´çš„Socraticå¼é—®ç­”å¾ªç¯ï¼ŒåŒ…æ‹¬é—®é¢˜ç”Ÿæˆã€å›ç­”è¯„ä¼°ã€æç¤ºå¼•å¯¼ã€‚

#### éªŒæ”¶æ ‡å‡† (AC)

- [ ] AC 1: åŸºäºæºèŠ‚ç‚¹ç”Ÿæˆå¼•å¯¼é—®é¢˜
- [ ] AC 2: é—®é¢˜åŒ…å«RAGä¸Šä¸‹æ–‡ (Epic 23ä¾èµ–)
- [ ] AC 3: æ”¯æŒå¤šè½®æç¤º (æœ€å¤š3æ¬¡)
- [ ] AC 4: æ­£ç¡®è·¯ç”±åˆ°ä¸åŒç»“æœèŠ‚ç‚¹
- [ ] AC 5: è®°å½•æ¯æ¬¡å°è¯•å†å²

#### æŠ€æœ¯ä»»åŠ¡

1. å®ç° `generate_question` èŠ‚ç‚¹
2. å®ç° `evaluate_answer` èŠ‚ç‚¹
3. å®ç° `provide_hint` èŠ‚ç‚¹
4. å®ç°è´¨é‡è·¯ç”±å‡½æ•°
5. é›†æˆRAGä¸Šä¸‹æ–‡
6. ç¼–å†™æµç¨‹æµ‹è¯•

#### å…³é”®æ–‡ä»¶

- `src/verification_graph/nodes.py`
- `src/verification_graph/graph.py`
- `backend/app/services/verification_service.py`

#### é—®é¢˜ç”Ÿæˆæ¨¡æ¿

```python
QUESTION_TEMPLATES = {
    "definition": "è¯·è§£é‡Šä»€ä¹ˆæ˜¯ã€Œ{concept}ã€ï¼Ÿ",
    "application": "ã€Œ{concept}ã€åœ¨ä»€ä¹ˆåœºæ™¯ä¸‹ä½¿ç”¨ï¼Ÿ",
    "comparison": "ã€Œ{concept}ã€å’Œã€Œ{related}ã€æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ",
    "example": "è¯·ä¸¾ä¸€ä¸ªã€Œ{concept}ã€çš„ä¾‹å­",
    "derivation": "è¯·æ¨å¯¼ã€Œ{concept}ã€çš„è¯æ˜è¿‡ç¨‹",
}
```

---

### Story 24.3: å®æ—¶è¿›åº¦æ˜¾ç¤º

**ä¼˜å…ˆçº§**: P1 (High)
**ä¼°è®¡**: 3 Story Points

#### æè¿°

å®ç°å‰ç«¯å®æ—¶è¿›åº¦æ˜¾ç¤ºModalï¼Œè®©ç”¨æˆ·æ¸…æ¥šçŸ¥é“æ£€éªŒè¿›åº¦å’Œå®Œæˆæƒ…å†µã€‚

#### éªŒæ”¶æ ‡å‡† (AC)

- [ ] AC 1: æ˜¾ç¤ºæ€»æ¦‚å¿µæ•°/å·²å®Œæˆæ•°
- [ ] AC 2: æ˜¾ç¤ºå½“å‰æ¦‚å¿µåç§°
- [ ] AC 3: æ˜¾ç¤ºé¢œè‰²åˆ†å¸ƒ (ç»¿/ç´«/çº¢)
- [ ] AC 4: æ˜¾ç¤ºæŒæ¡ç‡ç™¾åˆ†æ¯”
- [ ] AC 5: æ”¯æŒæš‚åœ/ç»§ç»­/æ”¾å¼ƒ

#### æŠ€æœ¯ä»»åŠ¡

1. è®¾è®¡è¿›åº¦Modal UI
2. å®ç°WebSocketå®æ—¶æ›´æ–° (æˆ–è½®è¯¢)
3. å®ç°è¿›åº¦APIç«¯ç‚¹
4. å‰ç«¯Modalç»„ä»¶å¼€å‘
5. ç¼–å†™UIæµ‹è¯•

#### å…³é”®æ–‡ä»¶

- `backend/app/api/v1/endpoints/review.py` (è¿›åº¦API)
- æ–°å»º: `canvas-progress-tracker/obsidian-plugin/src/modals/VerificationProgressModal.ts`
- `canvas-progress-tracker/obsidian-plugin/styles.css`

#### UIè®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         æ£€éªŒç™½æ¿ - ç¦»æ•£æ•°å­¦                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                             â”‚
â”‚  å½“å‰æ¦‚å¿µ: é€†å¦å‘½é¢˜                          â”‚
â”‚                                             â”‚
â”‚  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘  60% (6/10)           â”‚
â”‚                                             â”‚
â”‚  ğŸŸ¢ 4 ä¸ªæ¦‚å¿µæŒæ¡                             â”‚
â”‚  ğŸŸ£ 2 ä¸ªæ¦‚å¿µéœ€å¤ä¹                            â”‚
â”‚  ğŸ”´ 0 ä¸ªæ¦‚å¿µæœªæŒæ¡                           â”‚
â”‚                                             â”‚
â”‚  æŒæ¡ç‡: 40%                                â”‚
â”‚                                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  [ æš‚åœ ]  [ è·³è¿‡æ­¤æ¦‚å¿µ ]  [ ç»“æŸæ£€éªŒ ]      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### Story 24.4: åŠ¨æ€Agenté€‰æ‹© (æ ¹æ®å›ç­”è´¨é‡)

**ä¼˜å…ˆçº§**: P1 (High)
**ä¼°è®¡**: 3 Story Points

#### æè¿°

å®ç°æ ¹æ®ç”¨æˆ·å›ç­”è´¨é‡åŠ¨æ€é€‰æ‹©æœ€åˆé€‚çš„å¼•å¯¼Agentã€‚

#### Agenté€‰æ‹©çŸ©é˜µ

| å›ç­”æƒ…å†µ | æ¦‚å¿µç±»å‹ | é€‰æ‹©Agent | å¼•å¯¼ç­–ç•¥ |
|----------|----------|-----------|----------|
| éƒ¨åˆ†æ­£ç¡® | ä»»æ„ | memory-anchor | æä¾›è®°å¿†é”šç‚¹ |
| é”™è¯¯ | æŠ½è±¡æ¦‚å¿µ | example-teaching | å…·ä½“ä¾‹å­ |
| æ··æ·† | ç›¸ä¼¼æ¦‚å¿µ | comparison-table | å¯¹æ¯”è¡¨æ ¼ |
| å®Œå…¨ä¸ä¼š | å¤æ‚æ¦‚å¿µ | basic-decomposition | æ‹†è§£ç®€åŒ– |
| æ¨ç†é”™è¯¯ | è¯æ˜/æ¨å¯¼ | clarification-path | æ¾„æ¸…è·¯å¾„ |

#### éªŒæ”¶æ ‡å‡† (AC)

- [ ] AC 1: å®ç°Agenté€‰æ‹©å™¨
- [ ] AC 2: æ”¯æŒ5ç§ä»¥ä¸ŠAgentç±»å‹
- [ ] AC 3: é€‰æ‹©é€»è¾‘å¯é…ç½®
- [ ] AC 4: è®°å½•é€‰æ‹©å†å²ç”¨äºåˆ†æ
- [ ] AC 5: æ”¯æŒæ‰‹åŠ¨è¦†ç›–é€‰æ‹©

#### æŠ€æœ¯ä»»åŠ¡

1. å®ç° `AgentSelector` ç±»
2. å®šä¹‰é€‰æ‹©è§„åˆ™é…ç½®
3. é›†æˆåˆ°Verification StateGraph
4. æ·»åŠ é€‰æ‹©æ—¥å¿—
5. ç¼–å†™é€‰æ‹©é€»è¾‘æµ‹è¯•

#### å…³é”®æ–‡ä»¶

- æ–°å»º: `backend/app/services/agent_selector.py`
- `src/verification_graph/nodes.py`
- `backend/app/config.py` (é€‰æ‹©è§„åˆ™é…ç½®)

#### é€‰æ‹©å™¨å®ç°

```python
class AgentSelector:
    """åŠ¨æ€Agenté€‰æ‹©å™¨"""

    SELECTION_RULES = {
        ("partial", "definition"): "memory-anchor",
        ("partial", "example"): "example-teaching",
        ("wrong", "abstract"): "example-teaching",
        ("wrong", "proof"): "clarification-path",
        ("confused", "similar"): "comparison-table",
        ("no_idea", "complex"): "basic-decomposition",
    }

    async def select(
        self,
        answer_quality: str,
        concept_type: str,
        history: List[str]
    ) -> str:
        """é€‰æ‹©æœ€åˆé€‚çš„å¼•å¯¼Agent"""
        key = (answer_quality, concept_type)
        if key in self.SELECTION_RULES:
            return self.SELECTION_RULES[key]

        # é»˜è®¤fallback
        return "basic-decomposition"
```

---

### Story 24.5: RAGä¸Šä¸‹æ–‡æ³¨å…¥

**ä¼˜å…ˆçº§**: P1 (High)
**ä¼°è®¡**: 3 Story Points

#### æè¿°

å°†Epic 23çš„RAGç³»ç»Ÿé›†æˆåˆ°æ£€éªŒç™½æ¿ï¼Œä½¿éªŒè¯é—®é¢˜åŸºäºå­¦ä¹ å†å²å’ŒçŸ¥è¯†å›¾è°±ç”Ÿæˆã€‚

#### éªŒæ”¶æ ‡å‡† (AC)

- [ ] AC 1: é—®é¢˜ç”Ÿæˆä½¿ç”¨RAGä¸Šä¸‹æ–‡
- [ ] AC 2: æç¤ºå†…å®¹åŸºäºå­¦ä¹ å†å²
- [ ] AC 3: æ”¯æŒè·¨Canvaså…³è”æç¤º
- [ ] AC 4: æ”¯æŒæ•™æä¸Šä¸‹æ–‡å¼•ç”¨
- [ ] AC 5: RAGå¤±è´¥æ—¶ä¼˜é›…é™çº§

#### æŠ€æœ¯ä»»åŠ¡

1. é›†æˆ `RAGService` åˆ° `VerificationService`
2. å®ç°ä¸Šä¸‹æ–‡æ³¨å…¥åˆ°é—®é¢˜æ¨¡æ¿
3. å®ç°æç¤ºå¢å¼º
4. æ·»åŠ RAGè°ƒç”¨ç¼“å­˜
5. å®ç°é™çº§é€»è¾‘
6. ç¼–å†™é›†æˆæµ‹è¯•

#### å…³é”®æ–‡ä»¶

- `backend/app/services/verification_service.py`
- `backend/app/services/rag_service.py`
- `src/verification_graph/nodes.py`

#### ä¸Šä¸‹æ–‡æ³¨å…¥ç¤ºä¾‹

```python
async def generate_question_with_rag(
    concept: str,
    rag_service: RAGService
) -> str:
    """ä½¿ç”¨RAGä¸Šä¸‹æ–‡ç”Ÿæˆé—®é¢˜"""

    # 1. æ£€ç´¢ç›¸å…³ä¸Šä¸‹æ–‡
    rag_result = await rag_service.query(
        query=f"å…³äº{concept}çš„å­¦ä¹ å†å²å’Œç›¸å…³çŸ¥è¯†",
        canvas_file=source_canvas
    )

    # 2. æ„å»ºå¢å¼ºé—®é¢˜
    if rag_result.results:
        context = "\n".join([r.content for r in rag_result.results[:3]])
        question = f"""
        åŸºäºä½ ä¹‹å‰å­¦ä¹ çš„å†…å®¹:
        {context}

        è¯·è§£é‡Šä»€ä¹ˆæ˜¯ã€Œ{concept}ã€ï¼Ÿ
        """
    else:
        # é™çº§ï¼šæ— RAGä¸Šä¸‹æ–‡
        question = f"è¯·è§£é‡Šä»€ä¹ˆæ˜¯ã€Œ{concept}ã€ï¼Ÿ"

    return question
```

---

## 4. ä¾èµ–å…³ç³»

### 4.1 Epicä¾èµ–

```
Epic 21 (Agentæµç¨‹) â”€â”€â†’ Epic 24 (æ£€éªŒç™½æ¿)
    â”‚                       â”‚
    â”‚  Agentæ­£ç¡®è¿”å›ç»“æœ     â”‚  éœ€è¦scoring-agentç­‰
    â”‚                       â”‚
Epic 23 (RAG) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚                       â”‚
    â”‚  RAGä¸Šä¸‹æ–‡æ£€ç´¢         â”‚  éœ€è¦RAGService
    â”‚                       â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.2 Storyä¾èµ–

```
Story 24.1 â”€â”€â†’ Story 24.2 â”€â”€â†’ Story 24.3
(æ¶æ„)        (é—®ç­”æµç¨‹)      (è¿›åº¦æ˜¾ç¤º)
                  â”‚
                  â”œâ”€â”€â†’ Story 24.4 (Agenté€‰æ‹©)
                  â”‚
                  â””â”€â”€â†’ Story 24.5 (RAGæ³¨å…¥)
```

---

## 5. é£é™©è¯„ä¼°

| é£é™© | å¯èƒ½æ€§ | å½±å“ | ç¼“è§£æªæ–½ |
|------|--------|------|----------|
| StateGraphå¤æ‚åº¦é«˜ | é«˜ | é«˜ | åˆ†é˜¶æ®µå®ç°ï¼Œå…ˆç®€å•åå¤æ‚ |
| ç”¨æˆ·ä½“éªŒä¸ä½³ | ä¸­ | é«˜ | æ—©æœŸç”¨æˆ·æµ‹è¯•ï¼Œå¿«é€Ÿè¿­ä»£ |
| RAGå»¶è¿Ÿå½±å“æµç•…åº¦ | ä¸­ | ä¸­ | æ·»åŠ ç¼“å­˜ï¼Œé¢„åŠ è½½ |
| Agenté€‰æ‹©ä¸å‡†ç¡® | ä¸­ | ä¸­ | æ”¶é›†åé¦ˆï¼ŒæŒç»­ä¼˜åŒ–è§„åˆ™ |

---

## 6. æµ‹è¯•ç­–ç•¥

### 6.1 å•å…ƒæµ‹è¯•

- `test_verification_state.py` - Stateå®šä¹‰æµ‹è¯•
- `test_agent_selector.py` - Agenté€‰æ‹©é€»è¾‘æµ‹è¯•
- `test_question_generation.py` - é—®é¢˜ç”Ÿæˆæµ‹è¯•

### 6.2 é›†æˆæµ‹è¯•

- `test_verification_flow.py` - å®Œæ•´æµç¨‹æµ‹è¯•
- `test_rag_integration.py` - RAGé›†æˆæµ‹è¯•

### 6.3 ç”¨æˆ·ä½“éªŒæµ‹è¯•

- å®Œæˆä¸€æ¬¡å®Œæ•´æ£€éªŒæµç¨‹ < 10åˆ†é’Ÿ
- å¼•å¯¼æç¤ºæœ‰æ•ˆæ€§ > 70%
- ç”¨æˆ·æ»¡æ„åº¦è¯„åˆ† > 4/5

---

## 7. å®Œæˆæ ‡å‡†

- [ ] æ‰€æœ‰5ä¸ªStorieså®Œæˆ
- [ ] StateGraphç¼–è¯‘è¿è¡ŒæˆåŠŸ
- [ ] Socraticå¾ªç¯æ­£å¸¸å·¥ä½œ
- [ ] å®æ—¶è¿›åº¦æ˜¾ç¤ºæ­£å¸¸
- [ ] AgentåŠ¨æ€é€‰æ‹©æ­£å¸¸
- [ ] RAGä¸Šä¸‹æ–‡æ³¨å…¥æ­£å¸¸
- [ ] ç«¯åˆ°ç«¯ç”¨æˆ·æµ‹è¯•é€šè¿‡
- [ ] æµ‹è¯•è¦†ç›–ç‡ > 80%

---

## 8. å‚è€ƒèµ„æ–™

- [LangGraph Skill](/.claude/skills/langgraph/SKILL.md) - StateGraphæ¨¡å¼
- [Epic 21](./EPIC-21-AGENT-E2E-FLOW-FIX.md) - Agentæµç¨‹ä¾èµ–
- [Epic 23](./EPIC-23-RAG-INTELLIGENT-INFERENCE.md) - RAGä¾èµ–
- [helpers.md#14-agents](../helpers.md) - Agentè¯¦ç»†è§„æ ¼
