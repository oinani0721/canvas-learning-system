# SCP-006: 多模态文件关联需求提案

**版本**: 1.0
**创建日期**: 2025-11-21
**状态**: 📝 Draft
**优先级**: P2
**影响Epic**: Epic 12 (Agentic RAG), Epic 15 (进度追踪)

---

## 背景与动机

### 问题陈述

当前Canvas学习系统仅支持文本类型的节点内容。用户在学习过程中经常需要：
1. **关联图片**: 数学公式截图、电路图、流程图
2. **关联PDF**: 教材章节、论文、笔记
3. **关联音频**: 讲座录音、口语练习
4. **关联视频**: 课程录像片段

缺乏多模态支持导致：
- 用户需要在多个工具间切换
- 知识关联分散，难以形成完整学习图谱
- 无法利用多模态AI能力（如Gemini 2.0 Flash的视觉理解）

### 用户场景

**场景1: 数学学习**
> 用户学习"傅里叶变换"，需要关联：
> - 公式推导的手写笔记图片
> - 3Blue1Brown的可视化视频
> - 教材PDF的特定页面

**场景2: 编程学习**
> 用户学习"数据结构"，需要关联：
> - 算法动画GIF
> - 代码截图
> - LeetCode题目PDF

---

## 提议的解决方案

### 核心功能

#### FR6.1: 多模态节点支持
- **图片节点**: 支持PNG/JPG/GIF/SVG格式
- **PDF节点**: 支持PDF文件链接，显示缩略图
- **音频节点**: 支持MP3/WAV格式，内嵌播放器
- **视频节点**: 支持MP4/WebM格式，内嵌播放器

#### FR6.2: 智能多模态分析
- **图片OCR**: 提取图片中的文字（公式、代码）
- **图片描述**: AI生成图片内容摘要
- **PDF解析**: 提取PDF文本和结构
- **音频转写**: 语音转文字（可选，需要额外API）

#### FR6.3: 多模态关联
- **自动关联**: 基于内容相似性自动关联多模态节点
- **手动关联**: 用户可手动建立多模态节点间的关系
- **Graphiti存储**: 多模态关系存储到知识图谱

### 技术架构

```
┌─────────────────────────────────────────────────┐
│  Multimodal Processing Layer                     │
├─────────────────────────────────────────────────┤
│  ┌───────────┐  ┌───────────┐  ┌───────────┐   │
│  │ Image     │  │ PDF       │  │ Audio/    │   │
│  │ Processor │  │ Processor │  │ Video     │   │
│  └─────┬─────┘  └─────┬─────┘  └─────┬─────┘   │
│        │              │              │          │
│        └──────────────┼──────────────┘          │
│                       ▼                          │
│            ┌─────────────────┐                   │
│            │ Gemini 2.0 Flash│                   │
│            │ (Multimodal AI) │                   │
│            └────────┬────────┘                   │
│                     ▼                            │
│            ┌─────────────────┐                   │
│            │ Vector Store    │                   │
│            │ (LanceDB)       │                   │
│            └────────┬────────┘                   │
│                     ▼                            │
│            ┌─────────────────┐                   │
│            │ Knowledge Graph │                   │
│            │ (Graphiti/Neo4j)│                   │
│            └─────────────────┘                   │
└─────────────────────────────────────────────────┘
```

### 与现有系统集成

#### ADR-001关联
本SCP利用ADR-001中已选定的**Gemini 2.0 Flash**作为多模态AI：
- 支持图片理解（Vision API）
- 支持PDF解析
- 中文支持优秀
- 成本低廉（$0.01/次）

#### Epic 12关联
多模态内容将集成到3层记忆系统：
- **Temporal Memory**: 记录多模态内容访问时间
- **Semantic Memory**: 存储多模态内容向量
- **Graphiti**: 存储多模态节点关系

---

## Story列表

### Phase 1: 基础多模态支持 (P1)

| Story ID | Story名称 | 预计时间 |
|----------|----------|---------|
| 6.1 | 图片节点类型支持 | 2天 |
| 6.2 | PDF节点类型支持 | 2天 |
| 6.3 | 多模态内容存储架构 | 3天 |

### Phase 2: 智能分析 (P2)

| Story ID | Story名称 | 预计时间 |
|----------|----------|---------|
| 6.4 | 图片OCR与描述生成 | 3天 |
| 6.5 | PDF文本提取与结构化 | 2天 |
| 6.6 | 多模态向量化存储 | 2天 |

### Phase 3: 关联与检索 (P2)

| Story ID | Story名称 | 预计时间 |
|----------|----------|---------|
| 6.7 | 多模态自动关联算法 | 3天 |
| 6.8 | 多模态Agentic RAG检索 | 3天 |
| 6.9 | UI集成（预览、播放器） | 4天 |

---

## 成本估算

### API成本
- **Gemini 2.0 Flash Vision**: $0.075/1M input tokens
- **预估月度图片处理**: 500张 × 平均1000 tokens = 0.5M tokens
- **月度成本**: ~$0.04

### 存储成本
- **图片向量**: 500张 × 768维 × 4字节 = 1.5MB/月
- **PDF向量**: 100个 × 50页 × 768维 × 4字节 = 15MB/月

**结论**: 成本可忽略，完全在现有预算内

---

## 风险与缓解

### 风险1: 大文件处理性能
- **概率**: 中
- **缓解**: 异步处理、分块上传、缩略图预览

### 风险2: 多模态AI质量
- **概率**: 低
- **缓解**: Gemini 2.0 Flash视觉能力已验证，中文支持良好

### 风险3: 存储空间
- **概率**: 低
- **缓解**: 原始文件存储在Obsidian Vault，只存储向量和元数据

---

## 实施建议

1. **优先级**: P2，在Epic 11-14完成后再实施
2. **依赖**: 需要Epic 12 Agentic RAG基础设施
3. **建议**: 先实现图片支持（最常用），再扩展到PDF和音视频

---

## 审批

| 角色 | 状态 | 日期 |
|------|------|------|
| PM Agent | ⏳ 待审批 | - |
| Architect Agent | ⏳ 待审批 | - |
| PO Agent | ⏳ 待审批 | - |

---

**文档结束**

**提取来源**: PRD v1.1.8 扩展需求
**创建日期**: 2025-11-21
