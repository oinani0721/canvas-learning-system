# ğŸ—ï¸ Section 3: æŠ€æœ¯æ¶æ„

### 3.1 æ•´ä½“æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Obsidian Desktop                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚         Canvas Learning Plugin (TypeScript)           â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚
â”‚  â”‚  â”‚ UI Layerâ”‚  â”‚ Commands â”‚  â”‚ Views (Review Panel) â”‚ â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚
â”‚  â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚  â”‚
â”‚  â”‚                    â”‚ HTTP/WebSocket                   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   FastAPI Backend (Python)                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚       ã€Layer 3ã€‘canvas-orchestrator (æ™ºèƒ½è·¯ç”±å±‚)     â”‚  â”‚
â”‚  â”‚  â€¢ è‡ªç„¶è¯­è¨€æ„å›¾è¯†åˆ«                                   â”‚  â”‚
â”‚  â”‚  â€¢ æ‰§è¡Œè®¡åˆ’ç”Ÿæˆ                                       â”‚  â”‚
â”‚  â”‚  â€¢ è°ƒç”¨LangGraphæ‰§è¡Œå¼•æ“                              â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                       â†“                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚     ã€Layer 4ã€‘LangGraph StateGraph (æ‰§è¡Œå¼•æ“)        â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚
â”‚  â”‚  â”‚        LangGraph Supervisor (å¹¶å‘è°ƒåº¦)           â”‚ â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â”‚  â”‚
â”‚  â”‚       â”‚          â”‚          â”‚          â”‚      â”‚      â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â” â”Œâ–¼â”€â”€â”€â”€â” â”‚  â”‚
â”‚  â”‚  â”‚basic-   â”‚â”‚deep-   â”‚â”‚scoring â”‚â”‚oral-   â”‚ â”‚...  â”‚ â”‚  â”‚
â”‚  â”‚  â”‚decomp   â”‚â”‚decomp  â”‚â”‚agent   â”‚â”‚explain â”‚ â”‚x12  â”‚ â”‚  â”‚
â”‚  â”‚  â”‚âœ… Tools â”‚â”‚âœ… Toolsâ”‚â”‚âœ… Toolsâ”‚â”‚âœ… Toolsâ”‚ â”‚     â”‚ â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜ â”‚  â”‚
â”‚  â”‚      â†“           â†“          â†“          â†“      â†“     â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚  â”‚
â”‚  â”‚  â”‚  å…±äº«Tools (æ‰€æœ‰Agentå¯ç›´æ¥è°ƒç”¨)              â”‚   â”‚  â”‚
â”‚  â”‚  â”‚  â€¢ write_to_canvas (FileLock)               â”‚   â”‚  â”‚
â”‚  â”‚  â”‚  â€¢ create_md_file                           â”‚   â”‚  â”‚
â”‚  â”‚  â”‚  â€¢ add_edge_to_canvas                       â”‚   â”‚  â”‚
â”‚  â”‚  â”‚  â€¢ update_ebbinghaus                        â”‚   â”‚  â”‚
â”‚  â”‚  â”‚  â€¢ query_graphiti_context                   â”‚   â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ Canvas   â”‚  â”‚ Ebbinghaus     â”‚  â”‚ .canvas-links    â”‚    â”‚
â”‚  â”‚ Utils    â”‚  â”‚ review_data    â”‚  â”‚ .json            â”‚    â”‚
â”‚  â”‚ (Python) â”‚  â”‚ .json          â”‚  â”‚                  â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Neo4j Knowledge Graph                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Graphiti Temporal Knowledge Graph                    â”‚  â”‚
â”‚  â”‚  â€¢ Canvas entities                                    â”‚  â”‚
â”‚  â”‚  â€¢ Node concepts                                      â”‚  â”‚
â”‚  â”‚  â€¢ Cross-canvas links (LINKED_TO, REQUIRES)          â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æ¶æ„è®¾è®¡è¯´æ˜ (åŒå±‚Supervisoræ¨¡å¼)**:

**æ ¸å¿ƒç†å¿µ**: ä¿ç•™canvas-orchestratorçš„æ™ºèƒ½è·¯ç”±èƒ½åŠ›,åŒæ—¶å¼•å…¥LangGraphçš„å¹¶å‘æ‰§è¡Œå¼•æ“

**Layer 3 - canvas-orchestrator (æ™ºèƒ½è·¯ç”±å±‚)**:
- **ä½œç”¨**: è‡ªç„¶è¯­è¨€æ„å›¾è¯†åˆ«ã€æ‰§è¡Œè®¡åˆ’ç”Ÿæˆã€è°ƒç”¨LangGraphæ‰§è¡Œ
- **ä¿ç•™åŸå› **: è¿™æ˜¯ç°æœ‰ç³»ç»Ÿçš„æ ¸å¿ƒä¼˜åŠ¿,èƒ½å‡†ç¡®ç†è§£ç”¨æˆ·æ„å›¾
- **ä½ç½®**: FastAPI Backendçš„å‰ç½®å¤„ç†å±‚

**Layer 4 - LangGraph StateGraph (æ‰§è¡Œå¼•æ“)**:
- **ä½œç”¨**: å¹¶å‘è°ƒåº¦ã€çŠ¶æ€ç®¡ç†ã€Agentç”Ÿå‘½å‘¨æœŸç®¡ç†
- **ä¼˜åŠ¿**: ä¿ç•™Epic 10.2çš„8å€æ€§èƒ½æå‡,å®ç°çœŸæ­£çš„å¼‚æ­¥å¹¶è¡Œæ‰§è¡Œ
- **åˆ›æ–°**: æ¯ä¸ªAgenté…å¤‡å·¥å…·,ç›´æ¥å†™å…¥Canvas,å®ç°0.5-1så¿«é€Ÿå“åº”

**å·¥å…·é…å¤‡ç­–ç•¥**:
- **åˆ†å¸ƒå¼å†™å…¥**: æ¯ä¸ªAgentç›´æ¥è°ƒç”¨write_to_canvaså·¥å…·,é¿å…é›†ä¸­å¼å†™å…¥çš„å»¶è¿Ÿ
- **FileLockä¿æŠ¤**: è·¨å¹³å°æ–‡ä»¶é”æœºåˆ¶,ç¡®ä¿å¤šä¸ªAgentå¹¶å‘å†™å…¥æ—¶çš„æ•°æ®ä¸€è‡´æ€§
- **å†™å…¥å†å²**: è®°å½•æ‰€æœ‰å†™å…¥æ“ä½œ,æ”¯æŒé”™è¯¯å›æ»š

**æ€§èƒ½å¯¹æ¯”**:

| æ–¹æ¡ˆ | é¦–ä¸ªèŠ‚ç‚¹å‡ºç°æ—¶é—´ | ç”¨æˆ·ä½“éªŒ | å®ç°å¤æ‚åº¦ |
|------|-----------------|---------|-----------|
| é›†ä¸­å¼å†™å…¥ (canvas_finalizer) | 8-10ç§’ | âŒ æ— å®æ—¶åé¦ˆ | ä½ |
| å·¥å…·é…å¤‡Agent (åˆ†å¸ƒå¼å†™å…¥) | 0.5-1ç§’ | âœ… å®æ—¶å¯è§ | ä¸­ (éœ€FileLock) |

### 3.2 LangGraphå¤šAgentæ¶æ„ (å·¥å…·é…å¤‡æ¨¡å¼)

#### 3.2.1 Stateå®šä¹‰

```python
from typing import TypedDict, Annotated, Literal
from langgraph.graph import MessagesState, add_messages

class CanvasLearningState(MessagesState):
    # åŸºç¡€ä¿¡æ¯
    canvas_path: str
    operation: str  # decompose/explain/score/review

    # Canvasæ•°æ®
    canvas_data: dict
    target_nodes: list[dict]

    # å…³è”å­¦ä¹ 
    linked_mode: bool
    linked_canvas_path: str | None
    textbook_context: list[dict]

    # Agentç»“æœ
    agent_results: dict
    generated_files: list[str]

    # è‰¾å®¾æµ©æ–¯å¤ä¹ 
    review_updates: list[dict]

    # è¿›åº¦è¿½è¸ª
    progress_data: dict | None

    # å†™å…¥å†å² (ç”¨äºå›æ»š)
    write_history: list[dict]

    # æœ€ç»ˆè¾“å‡º
    output_message: str
```

#### 3.2.2 åŒå±‚Supervisorè®¾è®¡

**Layer 3: canvas-orchestrator (æ™ºèƒ½è·¯ç”±å±‚)**

```python
class CanvasOrchestrator:
    """Layer 3: æ™ºèƒ½è·¯ç”±å±‚ - ä¿ç•™åŸæœ‰çš„è‡ªç„¶è¯­è¨€ç†è§£èƒ½åŠ›"""

    def process_command(self, user_input: str, canvas_path: str) -> dict:
        """å¤„ç†ç”¨æˆ·å‘½ä»¤,ç”Ÿæˆæ‰§è¡Œè®¡åˆ’"""
        # Step 1: æ„å›¾è¯†åˆ«
        intent = self.parse_intent(user_input)
        # intent = {
        #     "operation": "basic_decompose",
        #     "target_nodes": ["node-123", "node-456"],
        #     "linked_mode": True,
        #     "textbook_canvas": "ç¬¬3ç« -å‘é‡ç©ºé—´.canvas"
        # }

        # Step 2: ç”Ÿæˆæ‰§è¡Œè®¡åˆ’
        plan = self.create_execution_plan(intent, canvas_path)

        # Step 3: è°ƒç”¨LangGraphæ‰§è¡Œå¼•æ“
        result = await self.execute_with_langgraph(plan, canvas_path)

        return result

    def parse_intent(self, user_input: str) -> dict:
        """è‡ªç„¶è¯­è¨€æ„å›¾è¯†åˆ« (ä¿ç•™åŸæœ‰é€»è¾‘)"""
        # ç°æœ‰çš„canvas-orchestratoré€»è¾‘
        pass

    def create_execution_plan(self, intent: dict, canvas_path: str) -> dict:
        """ç”Ÿæˆæ‰§è¡Œè®¡åˆ’"""
        return {
            "operation": intent["operation"],
            "canvas_path": canvas_path,
            "target_nodes": self.load_target_nodes(canvas_path, intent["target_nodes"]),
            "linked_mode": intent.get("linked_mode", False),
            "textbook_context": self.load_textbook_context(intent) if intent.get("linked_mode") else []
        }
```

**Layer 4: LangGraph StateGraph (æ‰§è¡Œå¼•æ“)**

```python
from langgraph.graph import StateGraph, START, END
from langgraph.prebuilt import create_react_agent
from langgraph.types import Command
from langchain_openai import ChatOpenAI
