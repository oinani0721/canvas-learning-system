# 📐 Section 2: 需求定义

### 2.1 功能需求 (Functional Requirements)

#### FR1: Obsidian原生Canvas操作 (Must Have - P0)

**描述**: 用户在Obsidian内完成所有Canvas学习操作,无需切换到Claude Code

**用户故事**:
```
作为学习者
我希望在Obsidian内完成拆解、评分、生成解释等所有操作
这样我可以保持专注,不被窗口切换打断思路
```

**验收标准**:
- ✅ 右键Canvas节点 → 显示"基础拆解"、"深度拆解"、"评分"等菜单
- ✅ 快捷键支持 (如 Ctrl+Shift+D 拆解)
- ✅ 命令面板支持 (Ctrl+P → "Canvas学习: 基础拆解")
- ✅ 操作结果实时显示,无需刷新
- ✅ 错误提示友好,有重试机制

---

#### FR2: 12个Agent功能100%保留 (Must Have - P0)

**描述**: 所有现有Agent功能完整迁移,0%功能回退

**验收标准**:

| Agent | 现有功能 | 迁移后实现 |
|-------|---------|-----------|
| basic-decomposition | 生成3-7个引导问题 | ✅ 配备write_to_canvas工具 |
| deep-decomposition | 生成深度检验问题 | ✅ 配备write_to_canvas工具 |
| scoring-agent | 4维评分,颜色流转 | ✅ 配备write_to_canvas工具 |
| oral-explanation | 生成800-1200词口语化解释 | ✅ 配备create_md_file工具 |
| clarification-path | 生成1500+词澄清文档 | ✅ 配备create_md_file工具 |
| comparison-table | 生成对比表 | ✅ 配备create_md_file工具 |
| memory-anchor | 生成记忆锚点 | ✅ 配备create_md_file工具 |
| four-level-explanation | 生成4层次解释 | ✅ 配备create_md_file工具 |
| example-teaching | 生成例题教程 | ✅ 配备create_md_file工具 |
| verification-question | 生成检验问题 | ✅ 配备write_to_canvas工具 |
| canvas-orchestrator | 主控Agent,自然语言理解 | ✅ **保留为Layer 3智能路由层** |
| (新增) LangGraph Supervisor | N/A | ✅ Layer 4执行引擎,并发调度 |

**性能要求**:
- ✅ 响应时间不低于现有系统
- ✅ Epic 10.2的8倍性能提升必须保留
- ✅ 并发执行能力不退化

---
#### FR2.1: 智能并行处理UI (Must Have - P0)

**背景**: Epic 10智能并行处理系统的完整后端实现已完成（IntelligentParallelCommandHandler + AsyncExecutionEngine + IntelligentParallelScheduler），但缺少Obsidian Plugin的UI暴露。当前仅能通过CLI命令`/intelligent-parallel`使用。

**描述**: 在Obsidian Canvas工具栏添加"智能批量处理"按钮，用户可一键触发对当前Canvas的所有黄色节点进行智能分组和Agent批量调用。

**核心能力**:
- ✅ **智能分组**: TF-IDF向量化 + K-Means聚类，自动将语义相近的黄色节点分组
- ✅ **Agent推荐**: 基于节点内容关键词，自动推荐最合适的6个解释Agent
- ✅ **异步并发** (迁移后): AsyncExecutionEngine支持最多50个节点组并行，每组最多100个Agent（相比迁移前性能提升3-7倍，具体取决于系统资源）
- ✅ **资源感知调度**: ResourceAwareScheduler基于内存和CPU动态调整并发数
- ✅ **实时进度**: WebSocket推送任务进度、完成状态和错误信息
- ✅ **3层Canvas结构**: 黄色节点 → 蓝色TEXT节点（说明） → File节点（.md文档）

**UI交互流程**:

**Step 1: 工具栏按钮**
```
┌─────────────────────────────────────────┐
│ Canvas工具栏                             │
│ [🎯 拆解] [📊 评分] [📝 解释] [⚡ 智能批量处理] │
└─────────────────────────────────────────┘
```

**Step 2: 智能分组预览模态框**
```
┌────────────────────────────────────────────┐
│ 智能并行处理 - 分组预览                       │
├────────────────────────────────────────────┤
│ 检测到 12 个黄色节点，智能分组为 4 组:        │
│                                            │
│ 📊 Group 1: 对比类概念 (3节点)              │
│   推荐Agent: comparison-table              │
│   • 逆否命题 vs 否命题                      │
│   • 充分条件 vs 必要条件                    │
│   优先级: High                             │
│                                            │
│ 🔍 Group 2: 复杂概念澄清 (4节点)            │
│   推荐Agent: clarification-path            │
│   优先级: High                             │
│                                            │
│ [ 修改分组 ] [ 取消 ] [ 开始处理 (预计2分钟) ] │
└────────────────────────────────────────────┘
```

**Step 3: 实时进度显示**
```
┌────────────────────────────────────────────┐
│ 智能并行处理 - 执行中                        │
├────────────────────────────────────────────┤
│ 总进度: ████████░░░░░░░░ 8/12 (67%)        │
│                                            │
│ ✅ Group 1 (comparison-table): 已完成       │
│    ├─ 逆否命题 vs 否命题.md (3.2KB)         │
│    └─ 充分条件 vs 必要条件.md (2.8KB)       │
│                                            │
│ ⏳ Group 2 (clarification-path): 进行中 (2/4)│
│                                            │
│ [ 暂停 ] [ 取消 ] [ 最小化 ]                │
└────────────────────────────────────────────┘
```

**Step 4: 完成结果预览**
```
┌────────────────────────────────────────────┐
│ 智能并行处理 - 完成                          │
├────────────────────────────────────────────┤
│ ✅ 成功处理 11/12 个节点                     │
│ ❌ 1个节点失败                               │
│ ⏱️ 总耗时: 2分15秒                          │
│                                            │
│ 生成文档:                                   │
│ • 3个对比表 (📊)                            │
│ • 4个澄清路径 (🔍)                          │
│                                            │
│ [ 查看错误日志 ] [ 关闭 ]                   │
└────────────────────────────────────────────┘
```

**并发限制矩阵（迁移后）** [Source: SCP-005]:

| 并发层级 | 迁移前限制 | 迁移后限制 | 控制对象 | 配置方式 | 说明 |
|---------|-----------|----------|----------|----------|------|
| **Agent级** | 20 | **100** | 单节点的Agent数量 | 系统资源限制 | 基于内存、CPU，移除API限制 |
| **节点级** | 12 | **50** | 并行处理的节点组 | --max参数 | 批量处理，效率提升 |
| **任务级** | 5 | **20** | 有依赖的任务组 | 调度器内置 | 复杂工作流，有序执行 |
| **系统最大** | 100 | **500** | 总并发Agent实例 | ResourceAwareScheduler | 资源感知动态调整 |

**性能提升对比** [Source: Story 10.15]:

| 场景 | 迁移前限制 | 迁移后限制 | 性能提升 |
|------|-----------|----------|---------|
| 轻量任务（CPU<30%） | 20 agents | 100 agents | **5倍** |
| 标准任务（CPU 50-70%） | 20 agents | 60 agents | **3倍** |
| 重度任务（CPU>80%） | 20 agents | 10-20 agents | **持平（保护）** |
| 100节点批处理 | 12组 × 3agent = 36并发 | 50组 × 5agent = 250并发 | **7倍** |

**关键变化**:
- ✅ 移除API并发限制（迁移到LangGraph后，Agent API调用无限制）
- ✅ 引入ResourceAwareScheduler资源感知调度器
- ✅ 基于系统资源（内存、CPU）动态调整并发数
- ✅ 防止资源过载的保护机制
- ✅ 相关Story: Story 10.15 ResourceAwareScheduler实现

**验收标准**:
- ✅ Canvas工具栏显示"智能批量处理"按钮（图标：⚡）
- ✅ 点击按钮触发智能分组分析（<3秒完成）
- ✅ 分组预览模态框正确显示分组结果
- ✅ 实时进度显示（WebSocket推送，延迟<500ms）
- ✅ 完成结果预览（成功/失败统计）
- ✅ Canvas自动更新（3层结构正确）
- ✅ 错误处理完善（无黄色节点提示、Agent失败不中断其他）

**关联Epic/Story**:
- Epic 11: Story 11.6（4个REST API + 1个WebSocket）
- Epic 13: Story 13.8（UI实现，7天）

**优先级**: Must Have - P0（已有完整后端实现，只缺UI暴露）

**时间估算**: +1周（UI开发 + API集成 + E2E测试



#### FR3: 艾宾浩斯复习提醒系统 (Must Have - P0)

**描述**: 每日打开Obsidian自动显示今日应复习的Canvas白板

**用户故事**:
```
作为学习者
我希望每天打开Obsidian时看到"今日应复习:离散数学、线性代数"
这样我可以及时复习,避免遗忘
```

**数据流向** (v1.1.6更新 - 3层记忆系统数据整合):
```
┌──────────────────────────────────────────────────────────────────┐
│ 数据源 (Data Sources)                                            │
├──────────────────────────────────────────────────────────────────┤
│ 1. Canvas节点评分 (≥60分) → 触发添加概念到复习队列              │
│ 2. Temporal Memory (Neo4j) → 学习行为数据                        │
│    - 复习频率、间隔时间、正确率趋势                             │
│ 3. Graphiti Knowledge Graph (Neo4j) → 概念关系网络              │
│    - 前置概念掌握度、关联概念难度、知识图谱路径                 │
│ 4. Semantic Memory (LanceDB + CUDA) → 文档交互数据 + 混合检索  │
│    - 查阅频率、停留时间、相关文档访问模式、BM25关键词匹配       │
│ 5. Neo4j GDS (Graph Data Science) → 社区检测与图算法           │
│    - 概念社区检测(Leiden算法)、中心性分析、薄弱点聚类           │
└──────────────────────────────────────────────────────────────────┘
                        ↓
        ┌───────────────────────────────────┐
        │ EbbinghausReviewSystem            │
        │ - add_concept_for_review()        │
        │ - optimize_fsrs_parameters()      │ ← 新增: 参数优化
        └───────────────────────────────────┘
                        ↓
        ┌───────────────────────────────────┐
        │ ebbinghaus_review_data.json       │
        │ (Py-FSRS Card对象)                │
        └───────────────────────────────────┘
                        ↓
        ┌───────────────────────────────────┐
        │ Py-FSRS算法                       │
        │ - 使用从真实行为优化的17参数      │ ← 新增: 真实参数
        │ - 计算下次复习时间                │
        └───────────────────────────────────┘
                        ↓
        ┌───────────────────────────────────┐
        │ Obsidian侧边栏"今日复习面板"     │
        └───────────────────────────────────┘
```

**v1.1.6关键变更**:
- ✅ **100%真实数据源**: 所有数据来自实际学习行为，无模拟数据
- ✅ **3层记忆系统整合**: Temporal/Graphiti/Semantic全面接入
- ✅ **动态参数优化**: FSRS 17参数从真实行为数据中计算，非默认值
- ✅ **多维度评估**: 不仅基于评分，还考虑行为模式、概念关系、文档交互

**验收标准**:
- ✅ 每日打开Obsidian自动显示复习面板
- ✅ 显示应复习的Canvas名称和到期概念数量
- ✅ 一键生成检验白板
- ✅ 复习历史可查看 (最近7天/30天)
- ✅ 复习提醒通知 (可配置开启/关闭)

---

#### FR3.1: 数据采集触发机制

**触发时机和调用者**:

```python