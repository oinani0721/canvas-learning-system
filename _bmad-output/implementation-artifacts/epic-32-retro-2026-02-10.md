# EPIC-32 回顾 (Retrospective) — Final

**日期**: 2026-02-10
**工作流**: /bmad-bmm-retrospective (Bob)
**EPIC**: EPIC-32 Ebbinghaus Review System Enhancement
**Stories**: 32.1, 32.2, 32.3, 32.4, 32.6, 32.7, 32.8, 32.10, 32.11 (32.5 已删除)
**版本**: v2 (Final — 含 Story 32.10/32.11 完成后更新)

---

## EPIC 概况

| 指标 | 值 |
|------|------|
| Stories 总数 | 9 (含 32.10, 32.11 审核后追加) |
| Stories 完成 | 9/9 ✅ |
| 预估工时 | 38 小时 (原 44h, 删除 32.5 后 38h) |
| 后端测试 (实际运行) | 153 passed, 0 failed |
| 全 EPIC 测试估算 | ~415 (含插件 Jest) |
| 幻觉数 | 0 |
| DI 断裂数 | 0 |
| 死代码数 | 0 |
| P0 修复 (跨 EPIC) | 3 (Story 38.9 patch 目标) |
| P1 修复 (审核后) | 3 (Story 32.10) |
| P1 新增测试 | 8 (Story 32.11) |
| 最终 Murat 评分 | 91/100 (A-) |
| NFR 综合评分 | 91/100 (PASS) |
| 覆盖率门控 | ✅ PASS (P0:100%, P1:100%, P2:40%) |

---

## What Went Well

### 1. FSRS 集成质量高
- py-fsrs 真实库集成 (非 mock), FSRSManager 397 行有效代码
- Score→Rating 映射边界清晰 (40/60/85), 12 个参数化测试覆盖
- 动态间隔算法真实可用, 递增/重置行为测试完整

### 2. 降级路径设计完善
- USE_FSRS=False 回滚开关一键切换
- Ebbinghaus fallback 有 WARNING 日志 (非静默降级)
- algorithm 字段让调用方知道使用了哪个算法
- Health endpoint 实时反映 FSRS 运行状态
- **32.11 新增 5 个 E2E 降级测试验证完整 HTTP 路径**

### 3. DI 架构正确
- ReviewService 4 个构造参数全部正确传入
- 与 Story 38.9 singleton 迁移对齐
- `_get_review_service_singleton` 统一入口

### 4. 对抗性审核流程有效
- 独立审核发现了 3 个 P1 + 4 个 P2 问题 (全部有效)
- Story 32.10 + 32.11 在 24h 内完成修复
- Murat 评分从 83 (B) 提升到 91 (A-)

### 5. 并发安全已验证 (32.11 新增)
- asyncio.Lock + atomic write 设计合理
- 10 并发 task 测试无异常、JSON 不损坏

---

## What Went Wrong

### 1. BMad 自动化报告测试数量严重失准
- BMad 声称 ~347 个测试, 实际后端运行 188 (pre-32.10/32.11)
- 85% 夸大, 原因: BMad 可能混入了插件 Jest 测试但未标注
- **教训**: 不能信任 BMad 自动报告的测试数, 必须 `pytest -v` 实际运行

### 2. Story 38.9 跨 EPIC 影响未预见
- 38.9 singleton 迁移修改了 review.py 的 DI 入口
- 导致 3 个 EPIC-32 测试文件的 patch 目标断裂
- 修复: test_fsrs_state_api.py, test_fsrs_state_query.py 更新 patch 目标
- **教训**: 跨 EPIC 架构变更需要发布"影响公告"

### 3. 审核前的测试可靠性问题 (32.10 已修复)
- `datetime.now(timezone.utc)` 单点比较有跨日 flaky 风险 → **已修复: before/after bracket**
- `yield` fixture 无 `try/finally` 保护 → **已修复: 两个文件添加 try/finally**
- `clear()` 过度清理 → **已修复: 改为 pop()**

### 4. E2E 降级测试延迟到审核后 (32.11 已修复)
- EPIC 最初没有 E2E 降级测试, 仅 unit 级
- AC-32.3.5 降级覆盖率 89% < 90% 阈值 → **已修复: 5 个 E2E 测试**
- **教训**: 降级路径是 D5 (基础设施 AC), 应在 Story 创建时就包含 E2E 测试

---

## Key Lessons Learned

### L1: 对抗性审核是质量的守门人
- 同一 LLM 创建 + 验证确实有自我确认偏差
- 独立审核发现了 7 个问题 (3 P1 + 4 P2), 全部有效
- **行动**: 保持 EPIC 完成时的对抗性审核流程

### L2: 基础设施 AC (D1-D6) 必须在 Story 创建时检查
- D5 (降级) E2E 测试延迟到审核后才补充
- D6 (集成) 并发安全测试也延迟了
- **行动**: PM Agent 创建 Story 时必须对照 D1-D6 检查清单

### L3: 跨 EPIC 变更需要"影响地图"
- Story 38.9 改了一个 import 路径, 影响了 3 个 EPIC-32 测试文件
- 没有机制通知 EPIC-32 的测试维护者
- **行动**: 架构变更 PR 必须包含"受影响测试文件列表"

### L4: 测试基础设施需要统一模板
- fixture 清理模式 (try/finally + pop vs clear) 不统一
- 时间比较模式 (datetime.now vs freeze vs bracket) 不统一
- **行动**: 创建测试 fixture 标准模式文档

---

## Action Items (最终状态)

| # | 行动 | 优先级 | 状态 |
|---|------|--------|------|
| 1 | 修复 3 个测试 patch 目标 (38.9 影响) | P0 | ✅ 完成 |
| 2 | datetime.now() → before/after bracket | P1 | ✅ 完成 (32.10) |
| 3 | yield fixture 添加 try/finally + pop() | P1 | ✅ 完成 (32.10) |
| 4 | 补充 E2E 降级测试 | P1 | ✅ 完成 (32.11) |
| 5 | 补充并发写入安全测试 | P2 | ✅ 完成 (32.11) |
| 6 | Story 32.6 UI 组件测试 | P2 | ⏳ Backlog |
| 7 | Card states JSON → SQLite 评估 | P3 | ⏳ 长期 |

---

## Story 交付时间线

```
Week 1: Story 32.1 (P0) → Story 32.2 (P0)
Week 2: Story 32.3 (P1) + Story 32.4 (P1) 并行
Week 3: Story 32.6 (P2) + Story 32.7 (P2) + Story 32.8 (Fix)
Week 4: 对抗性审核 → Story 32.10 (P1 修复) → Story 32.11 (P2 补充)
Week 4: 最终验证 — 153 passed, 0 failed ✅
```

---

## EPIC 最终状态: ✅ 完成

| 门控 | 状态 |
|------|------|
| 所有 Story 完成 | ✅ 9/9 |
| P0 覆盖率 100% | ✅ |
| P1 覆盖率 ≥90% | ✅ 100% |
| 测试全部通过 | ✅ 153 passed, 0 failed |
| Murat 评分 ≥80 | ✅ 91/100 (A-) |
| NFR 评估通过 | ✅ 91/100 |
| 0 幻觉 / 0 DI 断裂 | ✅ |
| 对抗性审核残留 P1 = 0 | ✅ |

---

*Generated: 2026-02-10 | Workflow: /bmad-bmm-retrospective (Bob) v2 Final*
