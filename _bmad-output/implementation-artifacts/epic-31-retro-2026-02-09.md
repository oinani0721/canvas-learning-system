# Epic 31 回顾报告
# 检验白板智能引导系统完整激活

**回顾日期**: 2026-02-09
**Epic**: EPIC-31 Verification Canvas Intelligent Guidance
**前序回顾**: epic-30-retro-2026-02-09.md
**参与者**: Bob (SM), Alice (PO), Charlie (Senior Dev), Dana (QA), Elena (Junior Dev), ROG (Project Lead)
**类型**: 交互式回顾 (Interactive Mode)

---

## 1. 交付指标

| 指标 | 值 |
|------|-----|
| 总 Stories | 16 (31.1-31.10 + 31.A.1-31.A.6) |
| 完成 | **16/16 (100%)** — 含 31.8 合并至 31.10 |
| 总测试用例 | **500+** |
| QA Gate 通过 | 9/10 正式评审通过 |
| 对抗性审查 | 31.3, 31.4, 31.10 多轮审查 |
| 阻塞问题修复 | 6+ 个 P0/P1 在 QA 中发现并修复 |

### Story 完成明细

| Story | 标题 | 状态 | 测试 |
|-------|------|------|------|
| 31.1 | VerificationService 核心逻辑激活 | ✅ Complete | 22/22 |
| 31.2 | 检验白板生成端到端对接 | ✅ Complete | 17 pass |
| 31.3 | Agent 决策推荐端点 | ✅ PASS | 34 tests |
| 31.4 | 检验问题去重与历史查询 | ✅ PASS | 40/40 |
| 31.5 | 难度自适应算法 | ✅ Complete | 54 tests |
| 31.6 | 实时检验进度追踪 | ✅ Complete | — |
| 31.7 | 检验历史视图 UI | ✅ Complete | 24 tests (31.9 重写) |
| 31.8 | ~~会话持久化~~ → 推荐降级UI (合并至31.10) | ✅ Merged → 31.10 | — |
| 31.9 | 测试重写 | ✅ Complete | 70/70 |
| 31.10 | 推荐降级 UI 指示器 | ✅ Complete | 13 tests |
| 31.A.1 | MemoryService 管道修复 | ✅ Implemented | 9/9 |
| 31.A.2 | 学习历史读取修复 | ✅ Implemented | Neo4j 查询完整 |
| 31.A.3 | 检验超时值修复 (500ms→15s) | ✅ Complete | — |
| 31.A.4 | dependencies.py DI 完整性修复 | ✅ Complete | 134 pass |
| 31.A.5 | 集成测试补全 | ✅ Complete | 748 行 E2E 测试 |
| 31.A.6 | TodayReviewListService 集成 | ✅ Complete | 202 pass |

### 业务成果

- ✅ 用户可一键生成检验白板
- ✅ 检验问题由 Gemini API 真实生成（替换 Mock）
- ✅ 回答质量由 scoring-agent 评估（0-100 分）
- ✅ 智能推荐下一步动作（分解/解释/继续）
- ✅ 难度自适应（基于历史得分）
- ✅ 问题去重（Graphiti 时序查询）
- ⚠️ 会话使用内存 TTLCache（1h TTL, maxsize=500），**非**跨进程持久化。服务重启会丢失所有会话。[对抗性审核 2026-02-10 修正: 原声明"✅ Neo4j 直接"为幻觉，代码 verification_service.py:L456-459 使用 cachetools.TTLCache]
- ✅ 检验历史视图 UI
- ✅ 暂停/恢复检验会话
- ✅ 推荐降级指示器（后端 + 重试逻辑）

---

## 2. What Went Well

### 2.1 核心 Mock 替换成功

三个核心 Mock 方法全部替换为真实 Gemini API 调用：

| 方法 | 替换前 | 替换后 |
|------|--------|--------|
| `start_session()` | 硬编码 `["概念1", "概念2"]` | 从 Canvas 读取红/紫节点 |
| `generate_question_with_rag()` | 返回 `f"请解释{concept}？"` | Gemini API + RAG 上下文生成 |
| `process_answer()` | 基于字符长度评分 | scoring-agent 真实评估 (0-100) |

检验白板从"演示品"变为"真正可用的产品功能"。

### 2.2 QA Gate 对抗性审查价值极高

| Story | 审查轮数 | 发现问题数 | 关键发现 |
|-------|---------|-----------|---------|
| 31.3 | 3 轮 | 6 HIGH/MEDIUM | consecutive_low 计数逻辑错误、前端刻度不匹配、JSON Schema 缺失 |
| 31.4 | 2 轮 | 6 HIGH/MEDIUM | resume_session 硬编码、Graphiti 超时独立化、分页 offset 修复 |
| 31.10 | 1 轮 | CSS 缺失 | fallback-indicator 样式未添加 |

### 2.3 EPIC 30 回顾教训被成功应用

| EPIC 30 行动项 | 应用情况 |
|----------------|---------|
| A1: esbuild → vault | ✅ 插件代码正确部署 |
| A2: CLAUDE.md 部署规则 | ✅ 项目/全局规则已生效 |
| A3: 审查目标规则 | ✅ 使用 vault main.js 验证 |
| A6: DI 修复 | ✅ 31.A.4 完成 |

**部署同步验证 (2026-02-09):**
```
源码 main.ts:  2026/2/9 21:39
Vault main.js: 2026/2/9 23:58  ← 比源码新 139 分钟
自编译后源码 commit: 0 个
结论: ✅ 同步
```

### 2.4 代码现实检查拯救了 31.A.4

Story 31.A.4 原始设计基于幻觉 → v2.0 完全重写 → 修复了真正的问题。

| 版本 | 问题描述 | 结果 |
|------|---------|------|
| v1.0 | "TodayReviewListService 初始化" | 🔴 幻觉 — 服务从未被创建 |
| v2.0 | "FSRS 硬编码 null 修复" | ✅ 正确 — 修复 40% 权重失效 |

### 2.5 测试质量从"假"到"真"

- 31.7 原始 17 个测试是**自引用测试**（只测辅助函数，不测实际类）
- 31.9 重写为 24 个真实测试，覆盖 `ReviewDashboardView` 实际行为
- 31.A.5 补充 748 行集成测试（从 0 到完整覆盖）

---

## 3. What Went Wrong

### 3.1 🟡 Story 文档状态滞后

**5/16 Story 的文档状态与代码实现不一致：**

| Story | 文档状态 | 实际代码状态 | 差距 |
|-------|---------|------------|------|
| 31.A.2 | Draft | ✅ 已实现 (memory_service.py:552-693) | 严重 |
| 31.A.5 | Pending | ✅ 748 行 E2E 测试 | 严重 |
| 31.10 | Ready for Review | ⚠️ 基本完成（缺 CSS） | 轻微 |
| 31.A.4 | Review | ✅ 全部 DI 完成 | 中等 |
| 31.A.6 | Review | ✅ 已集成至 main.ts | 中等 |

**根因**: 开发者完成代码后未回更新 Story 文档。31.A 系列是对抗性审查后紧急添加的，更注重修复问题而忽略了文档维护。

### 3.2 🟡 AI Story 幻觉风险

Story 31.A.4 v1.0 基于错误假设，代码现实检查发现：
- 原 Story 声称 `TodayReviewListService` 被 main.ts 实例化 → **❌ 幻觉**（从未创建）
- 原 Story 声称调用 `setMemoryQueryService()` → **❌ 无效**（目标服务不存在）
- **真实问题**: `ReviewDashboardView` 硬编码 `null` 作为 FSRS 状态

**教训**: AI 生成的 Story 必须经过代码现实检查才能进入开发。

### 3.3 🟡 分制混乱 (0-40 vs 0-100)

- `scoring-response.schema.json` 定义 0-100
- `ScoringResultPanel` 硬编码 `SCORE_THRESHOLDS = {low: 15, high: 30}`（0-40 制）
- 31.A.6 统一修复，但暴露了缺乏集中阈值管理的问题

### 3.4 🟡 Mock 过度依赖 (已修复)

- 发现时: 1193 个 Mock，0 个集成测试
- 4 个断点在 Mock 环境下全部"通过"
- 修复后: 31.A.5 补充 748 行真实集成测试

### 3.5 🟢 死代码 (已修复)

- TodayReviewListService: 901 行 + 35 个测试 → 从未被调用
- 31.A.6 将其集成到 main.ts，消除死代码

---

## 4. 代码现实检查

### 后端 API 状态

| 端点 | 代码位置 | 状态 |
|------|---------|------|
| POST /review/generate | review.py | ✅ 存在 |
| POST /agents/recommend-action | agents.py:1761 | ✅ 存在 |
| GET /verification/history/{concept} | review.py:851 | ✅ 存在 |
| GET/POST session progress/pause/resume | review.py | ✅ 存在 |

### 依赖注入完整性

| Service | 依赖 | dependencies.py 传入 | 状态 |
|---------|------|---------------------|------|
| VerificationService | memory_service | ✅ L649 | ✅ |
| VerificationService | agent_service | ✅ L650 | ✅ |
| VerificationService | graphiti_client | ✅ L586 | ✅ |
| AgentService | memory_client | ✅ L634 | ✅ |
| AgentService | neo4j_client | ✅ L633 | ✅ |

### 插件部署同步

```
源码 main.ts:  166,745 bytes  (2026-02-09 21:39)
Vault main.js: 882,800 bytes  (2026-02-09 23:58)
自编译后源码变更: 0 个
结论: ✅ 同步
```

---

## 5. 上次回顾 (EPIC 30) 行动项跟进

| # | 行动项 | 状态 | 在 EPIC 31 中的证据 |
|---|--------|------|-------------------|
| A1 | esbuild outfile → vault | ✅ 已完成 | 插件部署同步验证通过 |
| A2 | CLAUDE.md 部署同步规则 | ✅ 已完成 | 项目/全局 CLAUDE.md 规则生效 |
| A3 | 审查目标规则 (vault main.js) | ✅ 已完成 | EPIC 31 审查使用正确目标 |
| A5 | 30.10-30.16 QA 评分 | ⏳ 未执行 | 不影响 EPIC 31 |
| A6 | dependencies.py DI 修复 | ✅ 已完成 | Story 31.A.4 |

**跟进率**: 4/5 (80%)

---

## 6. 行动项

### 流程改进

| # | 优先级 | 行动项 | 负责人 | 成功标准 |
|---|--------|--------|--------|---------|
| A1 | 🔴 P0 | Story 完成时强制更新文档状态 | Dev Agent | 0 个文档状态滞后 |
| A2 | 🔴 P0 | Story 创建前强制代码现实检查 | PM/Dev Agent | 0 个幻觉 Story |
| A3 | 🟡 P1 | 统一评分阈值管理 — Schema 为唯一来源 | Dev | 消除硬编码阈值 |

### 技术债务

| # | 优先级 | 项目 | 负责人 | 说明 |
|---|--------|------|--------|------|
| T1 | 🟡 P1 | 31.10 CSS `.fallback-indicator` 样式 | Dev | 后端完成，缺 UI 样式 |
| T2 | 🟢 P2 | verification_service.py 拆分 (2852 行) | Dev | 未来模块化 |
| T3 | 🟢 P2 | EPIC 31 Story 文档状态批量更新 | Dev | 5 个 Story 状态修正 |

### EPIC 32 准备任务

| # | 优先级 | 任务 | 负责人 |
|---|--------|------|--------|
| P1 | 🔴 关键 | EPIC 32 Story 代码现实检查 | Dev |
| P2 | 🔴 关键 | 更新 Story 行号引用 (review_service.py 已大改) | Dev |
| P3 | 🟡 并行 | 确认 py-fsrs 库安装兼容性 | Dev |
| P4 | 🟡 并行 | 评估 EPIC 31 对 review_service.py 改动范围 | Dev |

### 团队约定

- 代码实现完成 → 同步更新 Story 文档状态
- 新 Story 创建 → 先 Grep 代码验证假设
- 评分/阈值 → 从 Schema 读取，不硬编码

---

## 7. EPIC 32 就绪度评估

| 依赖项 | 来源 | 状态 |
|--------|------|------|
| FSRSStateQueryService 初始化 | 31.A.4 | ✅ 就绪 |
| TodayReviewListService 集成 | 31.A.6 | ✅ 就绪 |
| Neo4j 连接 | EPIC 30 | ✅ 就绪 |
| 记忆服务初始化 | EPIC 30 30.7 | ✅ 就绪 |
| 多学科隔离后端 | EPIC 30 30.8 | ✅ 就绪 |
| EPIC 32 Story 代码现实检查 | — | ⚠️ 待执行 |
| review_service.py 行号更新 | — | ⚠️ 待执行 |

```
EPIC 32 就绪度: ⚠️ 需要代码现实检查后才能开始
阻塞项: 0 (代码依赖全满足，仅文档需更新)
```

---

## 8. 关键教训

### 教训 1: 代码现实检查不是可选的

31.A.4 的幻觉案例证明：AI 生成的 Story 必须经过代码验证。文档说的 ≠ 代码做的。

### 教训 2: QA Gate 对抗性审查回报极高

31.3 和 31.4 总计 12+ 问题在生产前发现。对抗性审查的投入远低于生产 Bug 修复成本。

### 教训 3: Mock 掩盖真实问题

1193 个 Mock 让 4 个断点"通过"测试。集成测试是发现端到端问题的唯一可靠手段。

### 教训 4: 文档状态是滞后指标

代码是领先指标，文档是滞后指标。依赖文档状态判断项目进度会产生误判。

### 教训 5: EPIC 30 教训的应用是可测量的

插件部署同步验证通过 — 证明回顾行动项的跟进是有效的。

---

## 9. 回顾闭幕

**Bob (SM)**: EPIC 31 交付了检验白板从 Mock 到真实 AI 的质变。16 个 Story 全部完成，500+ 测试覆盖。

**Charlie (Dev)**: 对抗性审查 + 代码现实检查，这两个机制在 EPIC 31 中证明了自己的价值。

**Dana (QA)**: 测试质量从'自引用测试'到'真实集成测试'的进步，是这个 Epic 最重要的技术成果之一。

**Elena (Junior Dev)**: 31.A.4 的幻觉教训会让我以后写 Story 时先读代码再动笔。

**Alice (PO)**: EPIC 31 正式关闭。EPIC 32 在代码现实检查后绿灯。

**ROG (Project Lead)**: 确认。

---

*文档版本: 1.0 | 回顾类型: 交互式 | 基于: 16 个 Story 深度分析 + EPIC 30 回顾跟进*
