import esbuild from "esbuild";
import process from "process";
import builtins from "builtin-modules";
import path from "path";
import fs from "fs";
import { fileURLToPath } from "url";

const __dirname = path.dirname(fileURLToPath(import.meta.url));

const banner = `/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
Canvas Review System - Obsidian Plugin
if you want to view the source, please visit the github repository of this plugin
*/
`;

const prod = (process.argv[2] === 'production');

// ========== è¾“å‡ºè·¯å¾„å†³ç­– ==========
// ä¼˜å…ˆçº§: OBSIDIAN_VAULT ç¯å¢ƒå˜é‡ > é»˜è®¤ vault è·¯å¾„ > æºç ç›®å½•(CI/å‘å¸ƒç”¨)
const PLUGIN_ID = "canvas-review-system";

function resolveOutDir() {
	// 1. ç¯å¢ƒå˜é‡ (å…¶ä»–å¼€å‘è€… / CI)
	if (process.env.OBSIDIAN_VAULT) {
		const dir = path.join(process.env.OBSIDIAN_VAULT, ".obsidian", "plugins", PLUGIN_ID);
		console.log(`[vault] Using OBSIDIAN_VAULT env: ${dir}`);
		return dir;
	}
	// 2. é»˜è®¤ vault è·¯å¾„ (æœ¬åœ°å¼€å‘)
	const defaultVault = path.resolve(__dirname, "../../ç¬”è®°åº“/.obsidian/plugins", PLUGIN_ID);
	if (fs.existsSync(path.resolve(__dirname, "../../ç¬”è®°åº“/.obsidian/plugins"))) {
		console.log(`[vault] Using default vault: ${defaultVault}`);
		return defaultVault;
	}
	// 3. å›é€€åˆ°æºç ç›®å½• (CI æ„å»º / GitHub Release æ‰“åŒ…)
	console.warn("âš ï¸  Vault not found, outputting to source directory (for CI/release only)");
	return __dirname;
}

const outDir = resolveOutDir();
const outfile = path.join(outDir, "main.js");

// ç¡®ä¿è¾“å‡ºç›®å½•å­˜åœ¨
if (!fs.existsSync(outDir)) {
	fs.mkdirSync(outDir, { recursive: true });
}

// ========== åŒæ­¥ manifest.json + styles.css åˆ° vault ==========
function syncAssetsToVault() {
	if (outDir === __dirname) return; // æºç ç›®å½•ä¸éœ€è¦åŒæ­¥
	const assets = ["manifest.json", "styles.css"];
	for (const asset of assets) {
		const src = path.join(__dirname, asset);
		const dest = path.join(outDir, asset);
		if (fs.existsSync(src)) {
			fs.copyFileSync(src, dest);
		}
	}
}

// ========== esbuild é…ç½® ==========
const context = await esbuild.context({
	banner: {
		js: banner,
	},
	entryPoints: ['main.ts'],
	bundle: true,
	external: [
		'obsidian',
		'electron',
		'@codemirror/autocomplete',
		'@codemirror/collab',
		'@codemirror/commands',
		'@codemirror/language',
		'@codemirror/lint',
		'@codemirror/search',
		'@codemirror/state',
		'@codemirror/view',
		'@lezer/common',
		'@lezer/highlight',
		'@lezer/lr',
		...builtins
	],
	format: 'cjs',
	target: 'es2018',
	logLevel: "info",
	sourcemap: prod ? false : 'inline',
	treeShaking: true,
	outfile,
});

if (prod) {
	await context.rebuild();
	syncAssetsToVault();
	// ç”Ÿäº§æ¨¡å¼: åŒæ—¶åœ¨æºç ç›®å½•ä¿ç•™ä¸€ä»½ (ç”¨äº GitHub Release ä¸Šä¼ )
	if (outDir !== __dirname) {
		fs.copyFileSync(outfile, path.join(__dirname, "main.js"));
		console.log("ğŸ“‹ Copied main.js to source dir (for GitHub Release)");
	}
	console.log("âœ… Production build complete");
	console.log(`   Output: ${outfile}`);
	process.exit(0);
} else {
	// å¼€å‘æ¨¡å¼: åˆ›å»º .hotreload æ ‡è®°æ–‡ä»¶
	if (outDir !== __dirname) {
		const hotreloadPath = path.join(outDir, ".hotreload");
		if (!fs.existsSync(hotreloadPath)) {
			fs.writeFileSync(hotreloadPath, "");
			console.log("ğŸ”¥ Created .hotreload marker (hot-reload plugin will watch this dir)");
		}
	}
	syncAssetsToVault();
	await context.watch();
	console.log(`ğŸ‘€ Watching for changes... Output: ${outfile}`);
}
