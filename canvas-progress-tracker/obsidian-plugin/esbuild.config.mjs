// âœ… Verified from Context7: /obsidianmd/obsidian-sample-plugin (esbuild configuration)
// âœ… Verified from Story 13.1 Dev Notes: canvas-progress-tracker/docs/obsidian-plugin-architecture.md#æ„å»ºè„šæœ¬
import esbuild from "esbuild";
import process from "process";
import path from "path";
import { fileURLToPath } from "url";
import builtins from "builtin-modules";
import fs from "fs";

const __dirname = path.dirname(fileURLToPath(import.meta.url));

const banner = `/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
Canvas Review System - Obsidian Plugin
if you want to view the source, please visit the github repository of this plugin
*/
`;

const prod = (process.argv[2] === 'production');

// ğŸ”´ P0: outfile å¿…é¡»æŒ‡å‘ vault æ’ä»¶ç›®å½•
// æºç ç¼–è¯‘ â†’ vault éƒ¨ç½² æ˜¯ä¸€æ­¥å®Œæˆçš„ï¼Œä¸éœ€è¦æ‰‹åŠ¨å¤åˆ¶
// è¡€æ³ªæ•™è®­: outfile: 'main.js' å¯¼è‡´ vault å’Œæºç é•¿æœŸä¸åŒæ­¥
//
// CI-safe: åœ¨ GitHub Actions ä¸­ vault è·¯å¾„ä¸å­˜åœ¨ï¼Œ
// é€šè¿‡ VAULT_PLUGIN_DIR ç¯å¢ƒå˜é‡æˆ– CI æ£€æµ‹è‡ªåŠ¨å›é€€åˆ°æœ¬åœ°è¾“å‡º
const defaultVaultDir = path.join(__dirname, '..', '..', 'ç¬”è®°åº“', '.obsidian', 'plugins', 'canvas-review-system');
const isCI = process.env.CI === 'true' || process.env.GITHUB_ACTIONS === 'true';
const vaultPluginDir = process.env.VAULT_PLUGIN_DIR || defaultVaultDir;

const vaultExists = fs.existsSync(vaultPluginDir);
const outfile = vaultExists
  ? path.join(vaultPluginDir, 'main.js')
  : path.join(__dirname, 'main.js');

if (!vaultExists && !isCI) {
  console.warn(`\nâš ï¸  Vault path not found: ${vaultPluginDir}`);
  console.warn(`    Output will go to: ${outfile}`);
  console.warn(`    Run 'npm run deploy:sync' after vault is available.\n`);
}

const context = await esbuild.context({
	banner: {
		js: banner,
	},
	entryPoints: ['main.ts'],
	bundle: true,
	external: [
		'obsidian',
		'electron',
		'@codemirror/autocomplete',
		'@codemirror/collab',
		'@codemirror/commands',
		'@codemirror/language',
		'@codemirror/lint',
		'@codemirror/search',
		'@codemirror/state',
		'@codemirror/view',
		'@lezer/common',
		'@lezer/highlight',
		'@lezer/lr',
		...builtins
	],
	format: 'cjs',
	target: 'es2018',
	logLevel: "info",
	sourcemap: prod ? false : 'inline',
	treeShaking: true,
	outfile: outfile,
});

if (prod) {
	await context.rebuild();
	console.log(`\nâœ… Built to vault: ${outfile}`);
	process.exit(0);
} else {
	await context.watch();
	console.log(`Canvas Review System: Watching for changes â†’ ${outfile}`);
}
