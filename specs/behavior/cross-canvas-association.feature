# specs/behavior/cross-canvas-association.feature
# Generated by: PM Agent *create-behavior-spec
# Date: 2025-11-25
# Related: Epic 16, Story 16.1-16.7

@epic-16 @priority-p1
Feature: Cross-Canvas Association Learning System
  As a learner
  I want to establish relationships between concepts across different Canvas files
  So that I can build a unified knowledge graph and discover hidden connections

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # BACKGROUND
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  Background:
    Given the Canvas Learning System Obsidian plugin is loaded
    And Graphiti knowledge graph service is running
    And Neo4j database is accessible

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # SECTION 1: CANVAS ASSOCIATION UI
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  @story-16.1 @smoke @ui
  Scenario: Open Canvas association modal
    Given user has Canvas "ç¦»æ•£æ•°å­¦.canvas" open
    When user clicks the ribbon icon "Link Canvas"
    Then a Modal dialog "Canvas å…³è”ç®¡ç†" is displayed
    And Modal shows current associations (if any)
    And Modal shows available Canvas files to link
    # UI Implementation: this.addRibbonIcon('link', 'Link Canvas', callback)

  @story-16.1 @ui
  Scenario: Create new Canvas association
    Given the Canvas association Modal is open
    And Canvas "ç¦»æ•£æ•°å­¦.canvas" is the source
    When user selects "çº¿æ€§ä»£æ•°.canvas" as target
    And user selects relationship type "RELATED_TO"
    And user clicks "åˆ›å»ºå…³è”" button
    Then association is stored in Graphiti knowledge graph
    And confirmation Notice "å·²å…³è”: ç¦»æ•£æ•°å­¦ â†” çº¿æ€§ä»£æ•°" is displayed
    And Modal updates to show new association

  @story-16.1 @ui
  Scenario: View existing Canvas associations
    Given Canvas "ç¦»æ•£æ•°å­¦.canvas" has associations with:
      | target_canvas   | relationship_type | created_at |
      | çº¿æ€§ä»£æ•°.canvas | RELATED_TO        | 2025-01-10 |
      | æ¦‚ç‡è®º.canvas   | REQUIRES          | 2025-01-12 |
    When user opens Canvas association Modal
    Then Modal displays 2 existing associations
    And each association shows target Canvas name and relationship type
    And user can click to navigate to linked Canvas

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # SECTION 2: CONFIGURATION MANAGEMENT
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  @story-16.2
  Scenario: Auto-generate .canvas-links.json configuration
    Given user creates association between "ç¦»æ•£æ•°å­¦.canvas" and "çº¿æ€§ä»£æ•°.canvas"
    When association is saved
    Then ".canvas-links.json" file is created in vault root (if not exists)
    And file contains association entry:
      """json
      {
        "associations": [
          {
            "source": "ç¦»æ•£æ•°å­¦.canvas",
            "target": "çº¿æ€§ä»£æ•°.canvas",
            "type": "RELATED_TO",
            "created_at": "2025-11-25T10:30:00Z"
          }
        ]
      }
      """

  @story-16.2
  Scenario: Load associations from config on plugin startup
    Given ".canvas-links.json" contains 5 Canvas associations
    When Obsidian starts and plugin loads
    Then all 5 associations are loaded into Graphiti
    And associations are available for cross-Canvas queries
    And status bar shows "5 Canvas å·²å…³è”"

  @story-16.2 @error-handling
  Scenario: Handle corrupted config file
    Given ".canvas-links.json" contains invalid JSON
    When plugin attempts to load associations
    Then plugin logs warning "canvas-links.json è§£æå¤±è´¥"
    And plugin creates backup ".canvas-links.json.bak"
    And plugin initializes with empty associations
    And Notice warns user "å…³è”é…ç½®å·²æŸåï¼Œå·²åˆ›å»ºå¤‡ä»½"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # SECTION 3: GRAPHITI CROSS-CANVAS STORAGE
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  @story-16.3
  Scenario: Store cross-Canvas relationship in Graphiti
    Given Canvas "ç¦»æ•£æ•°å­¦.canvas" and "çº¿æ€§ä»£æ•°.canvas" exist
    And node "node-001" in "ç¦»æ•£æ•°å­¦" concept is "çŸ©é˜µä¹˜æ³•"
    And node "node-101" in "çº¿æ€§ä»£æ•°" concept is "çŸ©é˜µè¿ç®—"
    When user creates cross-Canvas link between these nodes
    Then Graphiti stores relationship:
      | source_entity | target_entity | relationship_type | properties |
      | çŸ©é˜µä¹˜æ³•      | çŸ©é˜µè¿ç®—      | LINKED_TO         | cross_canvas=true |
    And relationship is queryable via Cypher

  @story-16.3
  Scenario: Query related concepts across Canvas files
    Given Graphiti contains cross-Canvas relationships for "çŸ©é˜µ" concept
    And "çŸ©é˜µ" appears in "ç¦»æ•£æ•°å­¦.canvas", "çº¿æ€§ä»£æ•°.canvas", "æ¦‚ç‡è®º.canvas"
    When user queries "æŸ¥æ‰¾æ‰€æœ‰å…³äº'çŸ©é˜µ'çš„èŠ‚ç‚¹"
    Then system returns nodes from all 3 Canvas files
    And results include:
      | canvas_name    | node_concept | mastery_level |
      | ç¦»æ•£æ•°å­¦       | çŸ©é˜µä¹˜æ³•     | green         |
      | çº¿æ€§ä»£æ•°       | çŸ©é˜µè¿ç®—     | purple        |
      | æ¦‚ç‡è®º         | çŸ©é˜µå˜æ¢     | red           |

  @story-16.3 @performance
  Scenario: Cross-Canvas query performance
    Given Graphiti contains 1000+ node entities across 20 Canvas files
    When user executes cross-Canvas concept query
    Then query completes within 2 seconds
    And results are paginated (max 50 per page)

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # SECTION 4: ASSOCIATION MODE TOGGLE
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  @story-16.4 @ui
  Scenario: Toggle association mode on
    Given association mode is currently OFF
    When user clicks "å…³è”æ¨¡å¼" toggle in settings
    Then association mode is enabled
    And Canvas nodes show association indicators (small link icon)
    And clicking a node shows "å…³è”åˆ°å…¶ä»–Canvas" option

  @story-16.4 @ui
  Scenario: Toggle association mode off
    Given association mode is currently ON
    When user clicks "å…³è”æ¨¡å¼" toggle in settings
    Then association mode is disabled
    And association indicators are hidden
    And normal Canvas editing behavior resumes

  @story-16.4
  Scenario: Association mode persists across sessions
    Given user enabled association mode
    When user restarts Obsidian
    Then association mode remains enabled
    And setting is stored in plugin data

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # SECTION 5: AGENT TEXTBOOK CONTEXT
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  @story-16.5
  Scenario: Agent references textbook Canvas context
    Given "ç¦»æ•£æ•°å­¦.canvas" is associated with "æ•™æ-ç¦»æ•£æ•°å­¦å¯¼è®º.canvas"
    And user asks basic-decomposition to decompose "é€†å¦å‘½é¢˜"
    When Agent processes the request
    Then Agent queries Graphiti for related concepts in textbook Canvas
    And Agent's response includes reference: "å‚è§æ•™æç¬¬3ç« "
    And generated question nodes include textbook references

  @story-16.5
  Scenario: Agent discovers prerequisite concepts
    Given "é«˜ç­‰æ•°å­¦.canvas" REQUIRES "çº¿æ€§ä»£æ•°.canvas"
    And user asks to decompose "ç‰¹å¾å€¼åˆ†è§£" in "é«˜ç­‰æ•°å­¦.canvas"
    When Agent processes the request
    Then Agent identifies prerequisite concepts from "çº¿æ€§ä»£æ•°.canvas"
    And Agent's response suggests: "å»ºè®®å…ˆå¤ä¹ 'çŸ©é˜µå¯¹è§’åŒ–'(çº¿æ€§ä»£æ•°)"
    And prerequisite nodes are highlighted in yellow

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # SECTION 6: TEXTBOOK REFERENCE DISPLAY
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  @story-16.6 @ui
  Scenario: Display textbook reference in node
    Given node "node-001" has cross-Canvas reference to textbook
    When user hovers over the node
    Then tooltip shows "ç›¸å…³æ•™æ: æ•™æ-ç¦»æ•£æ•°å­¦å¯¼è®º > ç¬¬3ç«  å‘½é¢˜é€»è¾‘"
    And tooltip includes "ç‚¹å‡»è·³è½¬" link

  @story-16.6 @ui
  Scenario: Navigate to referenced textbook node
    Given node "node-001" references textbook node "textbook-node-055"
    When user clicks "ç‚¹å‡»è·³è½¬" link
    Then Obsidian opens "æ•™æ-ç¦»æ•£æ•°å­¦å¯¼è®º.canvas"
    And Canvas scrolls to and highlights "textbook-node-055"
    And navigation breadcrumb shows "ç¦»æ•£æ•°å­¦ > æ•™æ-ç¦»æ•£æ•°å­¦å¯¼è®º"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # SECTION 7: ASSOCIATION STATUS INDICATOR
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  @story-16.7 @ui
  Scenario: Show association status indicator on Canvas
    Given Canvas "ç¦»æ•£æ•°å­¦.canvas" has 3 cross-Canvas associations
    When user opens the Canvas
    Then status bar shows indicator "ğŸ”— 3 å…³è”"
    And indicator tooltip shows linked Canvas names

  @story-16.7 @ui
  Scenario: Association indicator shows sync status
    Given Canvas has associations but Graphiti sync is pending
    When user opens the Canvas
    Then status indicator shows "ğŸ”— 3 å…³è” (åŒæ­¥ä¸­...)"
    And after sync completes, indicator shows "ğŸ”— 3 å…³è” âœ“"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # SECTION 8: EDGE CASES AND ERROR HANDLING
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  @story-16.3 @error-handling
  Scenario: Handle deleted Canvas in association
    Given "ç¦»æ•£æ•°å­¦.canvas" is associated with "å·²åˆ é™¤.canvas"
    And user deleted "å·²åˆ é™¤.canvas"
    When plugin loads associations
    Then association to deleted Canvas is marked as "orphaned"
    And plugin suggests "æ£€æµ‹åˆ°å¤±æ•ˆå…³è”ï¼Œæ˜¯å¦æ¸…ç†ï¼Ÿ"
    And user can confirm to remove orphaned association

  @story-16.3 @error-handling
  Scenario: Handle Graphiti service unavailable
    Given Graphiti service is not running
    When user attempts cross-Canvas query
    Then system shows Notice "çŸ¥è¯†å›¾è°±æœåŠ¡ä¸å¯ç”¨"
    And fallback to local .canvas-links.json for basic queries
    And feature-limited mode is indicated

  @story-16.1 @boundary
  Scenario: Maximum Canvas associations limit
    Given Canvas already has 50 associations (soft limit)
    When user attempts to create 51st association
    Then system shows warning "å…³è”æ•°é‡è¾ƒå¤šï¼Œå¯èƒ½å½±å“æ€§èƒ½"
    And user can confirm to proceed or cancel
    And hard limit is 100 associations per Canvas

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # SECTION 9: RELATIONSHIP TYPES
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  @story-16.3
  Scenario Outline: Different relationship types
    Given source Canvas "<source>" and target Canvas "<target>"
    When user creates relationship of type "<type>"
    Then Graphiti stores relationship with correct semantics
    And relationship is displayed with appropriate icon "<icon>"

    Examples:
      | source        | target        | type       | icon |
      | ç¦»æ•£æ•°å­¦      | çº¿æ€§ä»£æ•°      | RELATED_TO | ğŸ”—   |
      | é«˜ç­‰æ•°å­¦      | çº¿æ€§ä»£æ•°      | REQUIRES   | â¬…ï¸   |
      | æ¦‚ç‡è®º        | ç»Ÿè®¡å­¦        | SIMILAR_TO | â‰ˆ    |
      | å­¦ä¹ ç¬”è®°      | æ•™æ          | REFERENCES | ğŸ“–   |
