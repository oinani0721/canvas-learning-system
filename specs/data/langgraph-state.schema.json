{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://canvas-learning.com/schemas/langgraph-state.schema.json",
  "x-source-verification": {
    "verified_at": "2025-11-28T15:38:00Z",
    "sources": [
      {"type": "context7", "library_id": "/json-schema-org/json-schema-spec", "topic": "draft-07 schema validation"},
      {"type": "context7", "library_id": "/langchain-ai/langgraph", "topic": "StateGraph state definition"},
      {"type": "prd", "section": "FR2", "epic": "Epic 12"},
      {"type": "story", "id": "12.5", "title": "LangGraph StateGraph构建", "fields_added": ["graphiti_results", "lancedb_results", "fused_results", "reranked_results", "quality_score", "retry_count"]},
      {"type": "story", "id": "12.6", "title": "并行检索实现", "fields_added": ["query"], "conflict_resolution": "2025-11-28 PO验证时发现遗漏，用户决策C:同时修改两者"},
      {"type": "story", "id": "12.9", "title": "质量控制循环", "fields_added": ["quality_grade", "quality_issues", "original_queries"], "conflict_resolution": "2025-11-28 PO验证Story 12.9时发现Schema缺失字段，用户决策C:同时修改两者"}
    ]
  },
  "title": "LangGraph Canvas学习状态",
  "description": "LangGraph StateGraph的状态定义 (Epic 12). Context7 Verified: /json-schema-org/json-schema-spec (draft-07)",
  "type": "object",
  "properties": {
    "session_id": {
      "type": "string",
      "description": "会话ID"
    },
    "query": {
      "type": "string",
      "description": "检索查询字符串，用于Agentic RAG并行检索 (Story 12.6冲突解决: 2025-11-28)"
    },
    "canvas_path": {
      "type": "string",
      "description": "当前Canvas文件路径"
    },
    "user_id": {
      "type": "string",
      "description": "用户ID"
    },
    "operation": {
      "type": "string",
      "enum": [
        "decomposition",
        "scoring",
        "explanation",
        "verification",
        "review"
      ],
      "description": "当前操作类型"
    },
    "target_nodes": {
      "type": "array",
      "items": {
        "type": "string"
      },
      "description": "目标节点ID列表"
    },
    "agent_type": {
      "type": "string",
      "description": "当前执行的Agent类型"
    },
    "messages": {
      "type": "array",
      "items": {
        "type": "object",
        "properties": {
          "role": {
            "type": "string",
            "enum": ["user", "assistant", "system"]
          },
          "content": {
            "type": "string"
          }
        }
      },
      "description": "消息历史"
    },
    "write_history": {
      "type": "array",
      "items": {
        "type": "object",
        "properties": {
          "timestamp": {
            "type": "string",
            "format": "date-time"
          },
          "operation": {
            "type": "string"
          },
          "node_id": {
            "type": "string"
          },
          "changes": {
            "type": "object"
          }
        }
      },
      "description": "Canvas写入历史"
    },
    "last_operation": {
      "type": "string",
      "description": "上次操作"
    },
    "decomposition_results": {
      "type": "array",
      "items": {
        "type": "string"
      },
      "description": "拆解结果"
    },
    "scoring_results": {
      "type": "object",
      "description": "评分结果"
    },
    "error": {
      "type": "string",
      "description": "错误信息（如有）"
    },
    "config": {
      "type": "object",
      "properties": {
        "thread_id": {
          "type": "string",
          "description": "LangGraph线程ID"
        }
      },
      "description": "LangGraph配置"
    },
    "graphiti_results": {
      "type": "array",
      "items": {
        "type": "object",
        "properties": {
          "entity_id": {"type": "string"},
          "entity_name": {"type": "string"},
          "entity_type": {"type": "string"},
          "relevance_score": {"type": "number"},
          "relationships": {"type": "array", "items": {"type": "object"}}
        }
      },
      "default": [],
      "description": "Graphiti知识图谱检索结果 (Story 12.5)"
    },
    "lancedb_results": {
      "type": "array",
      "items": {
        "type": "object",
        "properties": {
          "doc_id": {"type": "string"},
          "content": {"type": "string"},
          "embedding_score": {"type": "number"},
          "metadata": {"type": "object"}
        }
      },
      "default": [],
      "description": "LanceDB向量检索结果 (Story 12.5)"
    },
    "fused_results": {
      "type": "array",
      "items": {
        "type": "object",
        "properties": {
          "source": {"type": "string", "enum": ["graphiti", "lancedb", "fused"]},
          "content": {"type": "string"},
          "score": {"type": "number"},
          "rank": {"type": "integer"}
        }
      },
      "default": [],
      "description": "多源融合后的检索结果 (Story 12.5)"
    },
    "reranked_results": {
      "type": "array",
      "items": {
        "type": "object",
        "properties": {
          "content": {"type": "string"},
          "rerank_score": {"type": "number"},
          "original_rank": {"type": "integer"},
          "final_rank": {"type": "integer"}
        }
      },
      "default": [],
      "description": "重排序后的最终结果 (Story 12.5)"
    },
    "quality_score": {
      "type": "number",
      "minimum": 0,
      "maximum": 1,
      "default": 0,
      "description": "检索结果质量评分 (0-1), 低于阈值触发重试 (Story 12.5)"
    },
    "retry_count": {
      "type": "integer",
      "minimum": 0,
      "default": 0,
      "description": "当前重试次数, 达到max_retries后返回best effort结果 (Story 12.5, 12.9)"
    },
    "quality_grade": {
      "type": "string",
      "enum": ["high", "medium", "low"],
      "description": "检索结果质量分级: high(>=0.7), medium(0.5-0.7), low(<0.5) (Story 12.9)"
    },
    "quality_issues": {
      "type": "array",
      "items": {
        "type": "string"
      },
      "default": [],
      "description": "质量问题列表，用于指导Query重写策略 (Story 12.9)"
    },
    "original_queries": {
      "type": "array",
      "items": {
        "type": "string"
      },
      "default": [],
      "description": "原始查询历史，记录重写前的所有查询 (Story 12.9)"
    }
  },
  "required": ["session_id", "canvas_path", "operation"]
}
