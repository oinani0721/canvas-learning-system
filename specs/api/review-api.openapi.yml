openapi: 3.0.3
info:
  title: Canvas Learning System - Review API
  version: 1.0.0
  description: |
    艾宾浩斯复习系统API，提供复习概念管理、复习进度追踪、检验白板生成和复习历史分析功能。

    **核心功能**:
    - **复习概念管理**: 添加、查询、完成复习概念
    - **智能调度**: 基于Py-FSRS算法的复习时间调度
    - **检验白板生成**: 支持"全新检验"和"针对性复习"两种模式
    - **检验进度追踪**: 实时显示已还原节点和颜色分布 (PRD L5780, FR4)
    - **检验结果同步**: Canvas评分与复习数据双向同步 (PRD L5781, FR3.5)
    - **历史分析**: 多次检验趋势分析、薄弱概念追踪
    - **3层记忆整合**: 整合Temporal/Graphiti/Semantic数据源

    **API端点汇总** (13个):
    - POST /review/add-concept - 添加复习概念
    - GET /review/today-summary - 今日复习摘要
    - POST /review/complete - 完成复习
    - GET /review/history - 复习历史
    - POST /review/generate-canvas - 生成检验白板
    - GET /review/{canvas_name}/progress - 获取检验进度
    - POST /review/sync - 同步检验结果
    - GET /review/progress/multi/{original_canvas_path} - 多次检验趋势
    - GET /verification/history/{concept} - 获取概念检验历史 ⭐Story 31.4
    - GET /review/fsrs-state/{concept_id} - 获取FSRS状态 ⭐Story 32.3
    - GET /review/session/{session_id}/progress - 获取会话进度 ⭐Story 31.6
    - POST /review/session/{session_id}/pause - 暂停会话 ⭐Story 31.6
    - POST /review/session/{session_id}/resume - 恢复会话 ⭐Story 31.6

    **数据源**:
    1. Canvas节点评分 (≥60分触发)
    2. Temporal Memory - 学习行为数据
    3. Graphiti Knowledge Graph - 概念关系网络
    4. Semantic Memory - 文档交互数据

    **关联文档**:
    - PRD FR3: 艾宾浩斯复习提醒系统 (L1573-1877)
    - PRD FR3.5: 数据一致性保证机制 (L2021-2128)
    - PRD FR4: 检验白板进度追踪系统 (L2636-2704)
    - Epic 14: 艾宾浩斯复习系统迁移+UI集成
    - Epic 15: 检验白板进度追踪 (Story 15.2, 15.3)
    - Story 14.1-14.12: 完整复习系统实现
  x-source-verification:
    verified_at: "2025-11-25T19:00:00Z"
    format_source:
      type: context7
      library_id: "/oai/openapi-specification"
      topic: "info object, paths, components, specification extensions"
    business_source:
      prd_version: "v1.1.9"
      epic: "Epic 14, Epic 15"
      story_refs: ["14.1", "14.2", "14.3", "14.4", "14.5", "14.6", "14.7", "14.8", "14.9", "14.10", "14.11", "14.12", "15.2", "15.3", "34.4"]
      prd_line_refs:
        - "L5780: GET /review/{canvas_name}/progress"
        - "L5781: POST /review/sync"
        - "L2636-2704: FR4 检验白板进度追踪系统"
        - "L2021-2128: FR3.5 数据一致性保证机制"

  contact:
    name: Canvas Learning System
  license:
    name: MIT

servers:
  - url: http://localhost:8000/api/v1
    description: Local development server

tags:
  - name: concepts
    description: 复习概念管理
  - name: schedule
    description: 复习调度
  - name: review-canvas
    description: 检验白板生成
  - name: history
    description: 复习历史和分析
  - name: verification
    description: 检验问题管理和历史 (Story 31.4)
  - name: fsrs
    description: FSRS算法状态查询 (Story 32.3)

paths:
  /review/add-concept:
    post:
      tags: [concepts]
      summary: 添加复习概念
      description: |
        将概念添加到复习队列。通常在评分≥60分时自动触发。

        **触发时机**:
        - 手动添加
        - 评分Agent自动触发 (score ≥ 60)
        - 3层记忆系统行为监控触发
      operationId: addConcept
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AddConceptRequest'
      responses:
        '201':
          description: 概念已添加
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ConceptResponse'
        '400':
          description: 请求参数错误
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '409':
          description: 概念已存在
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /review/today-summary:
    get:
      tags: [schedule]
      summary: 今日复习摘要
      description: |
        获取今日应复习的Canvas白板列表和概念统计。

        **聚合算法**:
        1. 查询所有到期概念
        2. 按Canvas分组
        3. 计算优先级（基于4维度综合评分）
        4. 整合3层记忆系统数据
      operationId: getTodaySummary
      parameters:
        - name: include_details
          in: query
          description: 是否包含详细概念列表
          schema:
            type: boolean
            default: false
        - name: sort_by
          in: query
          description: 排序方式
          schema:
            type: string
            enum: [priority, due_date, canvas_name]
            default: priority
      responses:
        '200':
          description: 今日复习摘要
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TodaySummaryResponse'

  /review/complete:
    post:
      tags: [concepts]
      summary: 完成复习
      description: |
        标记概念复习完成，更新Py-FSRS卡片状态。

        **评分等级** (FSRS Rating):
        - 1: Again - 完全忘记
        - 2: Hard - 困难回忆
        - 3: Good - 正常回忆
        - 4: Easy - 轻松回忆
      operationId: completeReview
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CompleteReviewRequest'
      responses:
        '200':
          description: 复习完成
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CompleteReviewResponse'
        '404':
          description: 概念不存在
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /review/history:
    get:
      tags: [history]
      summary: 复习历史
      description: |
        获取复习历史记录，支持时间范围过滤和统计分析。

        **Story 34.4 分页功能**:
        - 默认返回最近5条记录 (limit=5)
        - 设置 show_all=true 返回全部记录
      operationId: getHistory
      parameters:
        - name: days
          in: query
          description: 查询天数
          schema:
            type: integer
            enum: [7, 30, 90]
            default: 7
        - name: canvas_path
          in: query
          description: 按Canvas过滤
          schema:
            type: string
        - name: concept_name
          in: query
          description: 按概念名过滤
          schema:
            type: string
        - name: limit
          in: query
          description: |
            返回记录数量限制 (Story 34.4 AC1)
            默认5条，设为-1或配合show_all=true返回全部
          schema:
            type: integer
            default: 5
            minimum: -1
            maximum: 100
        - name: show_all
          in: query
          description: |
            是否返回全部记录 (Story 34.4 AC2)
            设为true时忽略limit参数
          schema:
            type: boolean
            default: false
      responses:
        '200':
          description: 复习历史
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HistoryResponse'

  /review/generate-canvas:
    post:
      tags: [review-canvas]
      summary: 生成检验白板
      description: |
        为指定Canvas生成检验白板，支持两种模式。

        **模式选择**:
        - `fresh`: 全新检验 - 不使用历史数据，盲测式检验
        - `targeted`: 针对性复习 - 基于历史薄弱概念调整权重

        **生成流程**:
        1. 查询到期概念
        2. (targeted模式) 查询Graphiti历史薄弱概念
        3. 调用verification-question-agent
        4. 创建检验白板文件
        5. 存储(review)-[:GENERATED_FROM]->(original)到Graphiti
      operationId: generateReviewCanvas
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/GenerateCanvasRequest'
      responses:
        '201':
          description: 检验白板已生成
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GenerateCanvasResponse'
        '400':
          description: 请求参数错误
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Canvas不存在
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /review/{canvas_name}/progress:
    get:
      tags: [review-canvas]
      summary: 获取检验进度
      description: |
        获取检验白板的实时进度，包括已还原节点数量和颜色分布。

        **PRD来源**: Line 5780, FR4 (检验白板进度追踪系统)

        **返回数据**:
        - 已还原节点数量
        - 红色/紫色/绿色节点统计
        - 覆盖率百分比
        - 原白板节点映射关系
      operationId: getReviewProgress
      parameters:
        - name: canvas_name
          in: path
          required: true
          description: 检验白板名称
          schema:
            type: string
            example: "离散数学-检验白板-20250118.canvas"
      responses:
        '200':
          description: 检验进度
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ReviewProgressResponse'
        '404':
          description: 检验白板不存在
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /review/sync:
    post:
      tags: [concepts]
      summary: 同步检验结果
      description: |
        将检验白板结果同步到复习系统，实现Canvas评分与复习数据的双向同步。

        **PRD来源**: Line 5781, FR3.5 (数据一致性保证机制)

        **同步内容**:
        - 检验白板通过/失败状态 → 更新FSRS卡片
        - 薄弱概念识别 → 更新Graphiti知识图谱
        - 复习时间记录 → 更新Temporal Memory

        **冲突解决策略**:
        - 检验白板评分 > 原白板评分: 使用检验白板结果
        - 检验白板评分 < 原白板评分: 保持原白板评分，记录回退
      operationId: syncReviewResults
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SyncReviewRequest'
      responses:
        '200':
          description: 同步成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SyncReviewResponse'
        '400':
          description: 请求参数错误
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: 检验白板不存在
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '409':
          description: 同步冲突
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /review/progress/multi/{original_canvas_path}:
    get:
      tags: [history]
      summary: 多次检验趋势分析
      description: |
        获取同一原白板的多次检验进度趋势。

        **返回数据**:
        - 每次检验的通过率曲线
        - 薄弱概念的改善趋势
        - 整体进步率
      operationId: getMultiReviewProgress
      parameters:
        - name: original_canvas_path
          in: path
          required: true
          description: 原Canvas文件路径
          schema:
            type: string
            example: "离散数学.canvas"
      responses:
        '200':
          description: 多次检验趋势
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MultiReviewProgressResponse'
        '404':
          description: 无检验历史
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  # Story 31.4: 检验问题去重与历史查询
  /verification/history/{concept}:
    get:
      tags: [verification]
      summary: 获取概念检验历史
      description: |
        查询指定概念的检验历史记录。

        **Story 31.4 AC-31.4.3**: 新增端点查询概念检验历史

        **返回数据包含** (AC-31.4.4):
        - 检验问题内容
        - 用户回答 (如有)
        - 得分 (如有)
        - 时间戳

        **用途**:
        - 问题生成前检查是否已存在相同问题 (AC-31.4.1)
        - 支持生成新角度问题 (AC-31.4.2)
        - 追踪概念掌握进度

        支持按Canvas过滤和分页。
      operationId: getVerificationHistory
      parameters:
        - name: concept
          in: path
          required: true
          description: 概念名称 (URL encoded)
          schema:
            type: string
            example: "逆否命题"
        - name: canvas_name
          in: query
          description: 按Canvas名称过滤
          schema:
            type: string
            example: "离散数学.canvas"
        - name: limit
          in: query
          description: 返回数量限制
          schema:
            type: integer
            default: 10
            maximum: 100
        - name: offset
          in: query
          description: 分页偏移量
          schema:
            type: integer
            default: 0
      responses:
        '200':
          description: 检验历史记录
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/VerificationHistoryResponse'
        '404':
          description: 概念不存在
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  # Story 32.3: FSRS状态查询端点
  /review/fsrs-state/{concept_id}:
    get:
      tags: [fsrs]
      summary: 获取FSRS状态
      description: |
        获取指定概念的FSRS算法状态。

        **Story 32.3**: 插件查询后端获取FSRS状态用于优先级计算

        **返回数据**:
        - stability: 记忆稳定性（天数）
        - difficulty: 难度系数（1-10）
        - state: 卡片状态（0=New, 1=Learning, 2=Review, 3=Relearning）
        - reps: 成功复习次数
        - lapses: 遗忘次数
        - retrievability: 当前可提取性概率（0-1）
        - due: 下次复习时间
        - card_state: 完整FSRS卡片JSON（供插件缓存）

        **用途**:
        - 插件端优先级计算使用FSRS状态
        - 支持插件端缓存FSRS卡片数据
        - 优雅降级：无卡片时返回found=false
      operationId: getFSRSState
      parameters:
        - name: concept_id
          in: path
          required: true
          description: 概念ID（节点ID）
          schema:
            type: string
            example: "node-abc123"
      responses:
        '200':
          description: FSRS状态
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FSRSStateQueryResponse'
        '404':
          description: 概念不存在
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  # Story 31.6: 实时检验进度追踪
  /review/session/{session_id}/progress:
    get:
      tags: [verification-session]
      summary: 获取会话进度
      description: |
        获取验证会话的实时进度。

        **Story 31.6**: 实时检验进度追踪
        - AC-31.6.1: 前端显示"已验证 X/Y 个概念"进度条
        - AC-31.6.2: 颜色分布实时更新（绿/黄/紫/红）
        - AC-31.6.3: 掌握率 = 绿色 / 总数 * 100%

        **返回数据**:
        - session_id: 会话ID
        - canvas_name: Canvas名称
        - total_concepts: 总概念数
        - completed_concepts: 已完成数
        - current_concept: 当前验证概念
        - green/yellow/purple/red_count: 各颜色计数
        - progress_percentage: 完成百分比
        - mastery_percentage: 掌握率
        - status: 会话状态
      operationId: getSessionProgress
      parameters:
        - name: session_id
          in: path
          required: true
          description: 会话ID
          schema:
            type: string
            example: "sess_abc123"
      responses:
        '200':
          description: 会话进度
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SessionProgressResponse'
        '404':
          description: 会话不存在
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /review/session/{session_id}/pause:
    post:
      tags: [verification-session]
      summary: 暂停会话
      description: |
        暂停一个活跃的验证会话。

        **Story 31.6 AC-31.6.4**: 支持暂停/恢复会话功能
      operationId: pauseSession
      parameters:
        - name: session_id
          in: path
          required: true
          description: 会话ID
          schema:
            type: string
            example: "sess_abc123"
      responses:
        '200':
          description: 会话已暂停
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SessionPauseResumeResponse'
        '400':
          description: 会话无法暂停
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: 会话不存在
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /review/session/{session_id}/resume:
    post:
      tags: [verification-session]
      summary: 恢复会话
      description: |
        恢复一个已暂停的验证会话。

        **Story 31.6 AC-31.6.4**: 支持暂停/恢复会话功能
      operationId: resumeSession
      parameters:
        - name: session_id
          in: path
          required: true
          description: 会话ID
          schema:
            type: string
            example: "sess_abc123"
      responses:
        '200':
          description: 会话已恢复
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SessionPauseResumeResponse'
        '400':
          description: 会话无法恢复
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: 会话不存在
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

components:
  schemas:
    AddConceptRequest:
      type: object
      required: [canvas_path, concept_name]
      properties:
        canvas_path:
          type: string
          description: Canvas文件路径
          example: "离散数学.canvas"
        concept_name:
          type: string
          description: 概念名称
          example: "逆否命题"
        node_id:
          type: string
          description: 节点ID（可选）
          example: "node-001"
        initial_score:
          type: integer
          description: 初始评分（触发此次添加的评分）
          minimum: 0
          maximum: 100
          example: 75
        source:
          type: string
          description: 添加来源
          enum: [manual, scoring_agent, behavior_monitoring]
          default: manual

    ConceptResponse:
      type: object
      required: [concept_id, canvas_path, concept_name, created_at]
      properties:
        concept_id:
          type: string
          example: "concept-001"
        canvas_path:
          type: string
          example: "离散数学.canvas"
        concept_name:
          type: string
          example: "逆否命题"
        node_id:
          type: string
          example: "node-001"
        created_at:
          type: string
          format: date-time
          example: "2025-01-18T10:30:00Z"
        next_review:
          type: string
          format: date-time
          description: 下次复习时间
          example: "2025-01-19T10:30:00Z"
        fsrs_state:
          type: object
          description: Py-FSRS卡片状态
          properties:
            stability:
              type: number
              example: 4.5
            difficulty:
              type: number
              example: 5.2
            elapsed_days:
              type: integer
              example: 0
            scheduled_days:
              type: integer
              example: 1
            reps:
              type: integer
              example: 0
            lapses:
              type: integer
              example: 0
            state:
              type: string
              enum: [New, Learning, Review, Relearning]
              example: "New"

    TodaySummaryResponse:
      type: object
      required: [date, total_concepts, total_canvases, canvases]
      properties:
        date:
          type: string
          format: date
          example: "2025-01-18"
        total_concepts:
          type: integer
          description: 今日应复习概念总数
          example: 15
        total_canvases:
          type: integer
          description: 涉及的Canvas数量
          example: 3
        canvases:
          type: array
          description: Canvas级别的复习任务
          items:
            type: object
            properties:
              canvas_path:
                type: string
                example: "离散数学.canvas"
              canvas_name:
                type: string
                example: "离散数学"
              concept_count:
                type: integer
                description: 该Canvas待复习概念数
                example: 5
              priority:
                type: string
                enum: [urgent, high, medium, low]
                example: "high"
              urgency_score:
                type: number
                description: 紧急度评分（0-100）
                example: 85.5
              last_review:
                type: string
                format: date-time
                description: 上次复习时间
                example: "2025-01-11T14:30:00Z"
              concepts:
                type: array
                description: 概念列表（include_details=true时返回）
                items:
                  type: object
                  properties:
                    concept_name:
                      type: string
                      example: "逆否命题"
                    due_date:
                      type: string
                      format: date-time
                    overdue_days:
                      type: integer
                      example: 2
                    priority:
                      type: string
                      enum: [urgent, high, medium, low]
        statistics:
          type: object
          description: 统计信息
          properties:
            overdue_count:
              type: integer
              description: 逾期概念数
              example: 3
            new_count:
              type: integer
              description: 新概念数
              example: 5
            review_count:
              type: integer
              description: 复习概念数
              example: 7

    CompleteReviewRequest:
      type: object
      required: [concept_id, rating]
      properties:
        concept_id:
          type: string
          description: 概念ID
          example: "concept-001"
        rating:
          type: integer
          description: FSRS评分（1-4）
          minimum: 1
          maximum: 4
          example: 3
        review_duration:
          type: integer
          description: 复习耗时（秒）
          example: 120
        notes:
          type: string
          description: 复习备注
          example: "需要加强理解条件和结论的关系"

    CompleteReviewResponse:
      type: object
      required: [concept_id, next_review, fsrs_state]
      properties:
        concept_id:
          type: string
          example: "concept-001"
        next_review:
          type: string
          format: date-time
          description: 下次复习时间
          example: "2025-01-21T10:30:00Z"
        interval_days:
          type: integer
          description: 下次复习间隔天数
          example: 3
        fsrs_state:
          type: object
          description: 更新后的FSRS状态
          properties:
            stability:
              type: number
              example: 8.2
            difficulty:
              type: number
              example: 4.8
            state:
              type: string
              enum: [New, Learning, Review, Relearning]
              example: "Review"

    HistoryResponse:
      type: object
      description: |
        复习历史响应

        Story 34.4: 支持分页，默认limit=5，has_more指示是否有更多记录
      required: [period, total_reviews, records]
      properties:
        period:
          type: object
          properties:
            start:
              type: string
              format: date
              example: "2025-01-11"
            end:
              type: string
              format: date
              example: "2025-01-18"
        total_reviews:
          type: integer
          description: 总复习次数
          example: 45
        records:
          type: array
          items:
            type: object
            properties:
              date:
                type: string
                format: date
                example: "2025-01-18"
              reviews:
                type: array
                items:
                  type: object
                  properties:
                    concept_id:
                      type: string
                    concept_name:
                      type: string
                    canvas_path:
                      type: string
                    rating:
                      type: integer
                    review_time:
                      type: string
                      format: date-time
        statistics:
          type: object
          properties:
            average_rating:
              type: number
              description: 平均评分
              example: 3.2
            retention_rate:
              type: number
              description: 记忆保持率
              example: 0.85
            streak_days:
              type: integer
              description: 连续复习天数
              example: 7
            by_canvas:
              type: object
              additionalProperties:
                type: integer
              description: 按Canvas统计
              example:
                "离散数学.canvas": 15
                "线性代数.canvas": 10
        pagination:
          type: object
          description: |
            分页信息 (Story 34.4)
          properties:
            limit:
              type: integer
              description: 当前限制数量
              example: 5
            total_count:
              type: integer
              description: 总记录数
              example: 45
            has_more:
              type: boolean
              description: 是否有更多记录
              example: true
            show_all:
              type: boolean
              description: 是否显示全部
              example: false

    GenerateCanvasRequest:
      type: object
      required: [source_canvas]
      description: |
        检验白板生成请求

        **字段同步**: 与后端 schemas.py:645-700 对齐
      properties:
        source_canvas:
          type: string
          description: 原Canvas文件名（不含路径）
          example: "离散数学.canvas"
        mode:
          type: string
          description: 检验模式
          enum: [fresh, targeted]
          default: fresh
        node_ids:
          type: array
          description: 指定节点ID（可选，默认所有红色+紫色节点）
          items:
            type: string
          example: ["node-001", "node-002"]
        weak_weight:
          type: number
          description: 薄弱节点权重（targeted模式）
          minimum: 0
          maximum: 1
          default: 0.7
          example: 0.7
        mastered_weight:
          type: number
          description: 已掌握节点权重（targeted模式）
          minimum: 0
          maximum: 1
          default: 0.3
          example: 0.3

    GenerateCanvasResponse:
      type: object
      required: [verification_canvas_name, node_count]
      description: |
        检验白板生成响应

        **字段同步**: 与后端 schemas.py:700-718 对齐
      properties:
        verification_canvas_name:
          type: string
          description: 生成的检验白板名称
          example: "离散数学_验证_20250118.canvas"
        node_count:
          type: integer
          description: 验证节点数量
          example: 5
        mode_used:
          type: string
          description: 使用的模式
          enum: [fresh, targeted]
          example: "fresh"
        weak_concepts:
          type: array
          description: 薄弱概念（targeted模式时返回）
          items:
            type: object
            properties:
              concept_name:
                type: string
                example: "逆否命题"
              weakness_score:
                type: number
                description: 薄弱程度评分
                example: 0.75
              failure_count:
                type: integer
                description: 历史失败次数
                example: 3
        graphiti_relationship_id:
          type: string
          description: Graphiti关系ID
          example: "rel-001"

    MultiReviewProgressResponse:
      type: object
      required: [original_canvas_path, review_count, reviews]
      properties:
        original_canvas_path:
          type: string
          example: "离散数学.canvas"
        review_count:
          type: integer
          description: 检验次数
          example: 5
        reviews:
          type: array
          description: 各次检验记录
          items:
            type: object
            properties:
              review_canvas_path:
                type: string
                example: "离散数学-检验白板-20250118.canvas"
              date:
                type: string
                format: date-time
                example: "2025-01-18T10:30:00Z"
              mode:
                type: string
                enum: [fresh, targeted]
                example: "fresh"
              pass_rate:
                type: number
                description: 通过率
                example: 0.8
              total_concepts:
                type: integer
                example: 10
              passed_concepts:
                type: integer
                example: 8
        trends:
          type: object
          description: 趋势分析
          properties:
            pass_rate_trend:
              type: array
              description: 通过率趋势（折线图数据）
              items:
                type: object
                properties:
                  date:
                    type: string
                    format: date
                  pass_rate:
                    type: number
            weak_concepts_improvement:
              type: array
              description: 薄弱概念改善趋势
              items:
                type: object
                properties:
                  concept_name:
                    type: string
                    example: "逆否命题"
                  improvement_rate:
                    type: number
                    description: 改善率
                    example: 0.25
                  current_status:
                    type: string
                    enum: [weak, improving, mastered]
                    example: "improving"
            overall_progress:
              type: object
              properties:
                progress_rate:
                  type: number
                  description: 整体进步率
                  example: 0.35
                trend_direction:
                  type: string
                  enum: [up, stable, down]
                  example: "up"

    ReviewProgressResponse:
      type: object
      required: [review_canvas_path, original_canvas_path, total_concepts, progress]
      properties:
        review_canvas_path:
          type: string
          description: 检验白板路径
          example: "离散数学-检验白板-20250118.canvas"
        original_canvas_path:
          type: string
          description: 原Canvas路径
          example: "离散数学.canvas"
        total_concepts:
          type: integer
          description: 总概念数
          example: 15
        progress:
          type: object
          description: 进度统计
          properties:
            restored_count:
              type: integer
              description: 已还原节点数
              example: 12
            coverage_rate:
              type: number
              description: 覆盖率
              example: 0.8
            by_color:
              type: object
              description: 按颜色分类
              properties:
                red:
                  type: object
                  properties:
                    total:
                      type: integer
                      example: 5
                    passed:
                      type: integer
                      example: 3
                    failed:
                      type: integer
                      example: 2
                purple:
                  type: object
                  properties:
                    total:
                      type: integer
                      example: 8
                    passed:
                      type: integer
                      example: 7
                    failed:
                      type: integer
                      example: 1
                green:
                  type: object
                  properties:
                    total:
                      type: integer
                      example: 2
                    passed:
                      type: integer
                      example: 2
                    failed:
                      type: integer
                      example: 0
        nodes:
          type: array
          description: 节点详情
          items:
            type: object
            properties:
              node_id:
                type: string
                example: "question-abc123"
              source_node_id:
                type: string
                description: 原白板节点ID
                example: "original-node-xyz789"
              concept_name:
                type: string
                example: "逆否命题"
              status:
                type: string
                enum: [pending, passed, failed]
                example: "passed"
              color:
                type: string
                # Story 12.B.4: 1=灰, 2=绿, 3=紫, 4=红, 5=蓝, 6=黄
                enum: ["1", "2", "3", "4", "5", "6"]
                example: "2"
        updated_at:
          type: string
          format: date-time
          example: "2025-01-18T10:45:00Z"

    SyncReviewRequest:
      type: object
      required: [review_canvas_path]
      properties:
        review_canvas_path:
          type: string
          description: 检验白板路径
          example: "离散数学-检验白板-20250118.canvas"
        force_overwrite:
          type: boolean
          description: 强制覆盖（忽略冲突）
          default: false
        sync_options:
          type: object
          description: 同步选项
          properties:
            update_fsrs:
              type: boolean
              description: 更新FSRS卡片状态
              default: true
            update_graphiti:
              type: boolean
              description: 更新Graphiti知识图谱
              default: true
            update_temporal:
              type: boolean
              description: 更新Temporal Memory
              default: true

    SyncReviewResponse:
      type: object
      required: [success, synced_count]
      properties:
        success:
          type: boolean
          example: true
        synced_count:
          type: integer
          description: 已同步概念数
          example: 12
        skipped_count:
          type: integer
          description: 跳过的概念数（无变化）
          example: 3
        conflict_count:
          type: integer
          description: 冲突数（需要手动解决）
          example: 0
        details:
          type: object
          properties:
            fsrs_updates:
              type: integer
              description: FSRS卡片更新数
              example: 10
            graphiti_updates:
              type: integer
              description: Graphiti关系更新数
              example: 8
            temporal_records:
              type: integer
              description: Temporal记录创建数
              example: 12
        conflicts:
          type: array
          description: 冲突详情（如有）
          items:
            type: object
            properties:
              concept_id:
                type: string
              concept_name:
                type: string
              conflict_type:
                type: string
                enum: [score_mismatch, state_conflict, missing_source]
              review_value:
                type: string
              original_value:
                type: string
        synced_at:
          type: string
          format: date-time
          example: "2025-01-18T10:50:00Z"

    Error:
      type: object
      required: [error, message]
      properties:
        error:
          type: string
          example: "ConceptNotFoundError"
        message:
          type: string
          example: "Concept 'concept-001' not found"
        details:
          type: object
          additionalProperties: true

    # Story 31.4: 检验历史响应
    VerificationHistoryResponse:
      type: object
      description: |
        检验历史查询响应

        Story 31.4 AC-31.4.3, AC-31.4.4: 概念检验历史数据
      required: [concept, total_count, items]
      properties:
        concept:
          type: string
          description: 查询的概念名称
          example: "逆否命题"
        total_count:
          type: integer
          description: 总记录数
          example: 15
        items:
          type: array
          description: 检验历史记录列表
          items:
            $ref: '#/components/schemas/VerificationHistoryItem'
        pagination:
          type: object
          description: 分页信息
          properties:
            limit:
              type: integer
              example: 10
            offset:
              type: integer
              example: 0
            has_more:
              type: boolean
              example: true

    VerificationHistoryItem:
      type: object
      description: |
        单条检验历史记录

        Story 31.4 AC-31.4.4: 历史数据包含问题内容、用户回答、得分、时间戳
      required: [question_id, question_text, asked_at]
      properties:
        question_id:
          type: string
          description: 问题唯一ID
          example: "vq-001-abc123"
        question_text:
          type: string
          description: 问题内容
          example: "请解释什么是逆否命题？"
        question_type:
          type: string
          description: 问题类型/角度
          enum: [standard, application, comparison, counterexample, synthesis]
          example: "standard"
        user_answer:
          type: string
          nullable: true
          description: 用户回答 (如有)
          example: "逆否命题是将原命题的条件和结论同时取反并交换位置..."
        score:
          type: integer
          nullable: true
          description: 评分 (0-100, 如有)
          minimum: 0
          maximum: 100
          example: 85
        canvas_name:
          type: string
          description: 来源Canvas
          example: "离散数学.canvas"
        asked_at:
          type: string
          format: date-time
          description: 提问时间
          example: "2026-01-18T10:30:00Z"

    # Story 32.3: FSRS状态查询响应
    FSRSStateQueryResponse:
      type: object
      description: |
        FSRS状态查询响应

        Story 32.3: 插件查询FSRS状态用于优先级计算
      required: [concept_id, found]
      properties:
        concept_id:
          type: string
          description: 概念ID
          example: "node-abc123"
        fsrs_state:
          type: object
          nullable: true
          description: FSRS算法状态（无卡片时为null）
          properties:
            stability:
              type: number
              description: 记忆稳定性（天数）
              example: 8.5
            difficulty:
              type: number
              description: 难度系数（1-10）
              minimum: 1
              maximum: 10
              example: 5.2
            state:
              type: integer
              description: 卡片状态 (0=New, 1=Learning, 2=Review, 3=Relearning)
              enum: [0, 1, 2, 3]
              example: 2
            reps:
              type: integer
              description: 成功复习次数
              example: 5
            lapses:
              type: integer
              description: 遗忘次数（rating=1的次数）
              example: 1
            retrievability:
              type: number
              nullable: true
              description: 当前可提取性概率（0-1）
              minimum: 0
              maximum: 1
              example: 0.85
            due:
              type: string
              format: date-time
              nullable: true
              description: 下次复习时间
              example: "2026-01-20T10:00:00Z"
        card_state:
          type: string
          nullable: true
          description: 完整FSRS卡片JSON（供插件缓存/反序列化）
          example: '{"stability":8.5,"difficulty":5.2,"state":2,...}'
        found:
          type: boolean
          description: 是否找到该概念的FSRS卡片
          example: true

    # Story 31.6: 会话进度响应
    SessionProgressResponse:
      type: object
      description: |
        实时验证会话进度响应

        Story 31.6: 实时检验进度追踪
        - AC-31.6.1: 前端显示"已验证 X/Y 个概念"进度条
        - AC-31.6.2: 颜色分布实时更新
        - AC-31.6.3: 掌握率计算
      required:
        - session_id
        - canvas_name
        - total_concepts
        - completed_concepts
        - current_concept
        - current_concept_idx
        - status
        - progress_percentage
        - mastery_percentage
        - started_at
        - updated_at
      properties:
        session_id:
          type: string
          description: 会话唯一标识符
          example: "sess_abc123"
        canvas_name:
          type: string
          description: Canvas名称
          example: "离散数学"
        total_concepts:
          type: integer
          minimum: 0
          description: 总概念数
          example: 10
        completed_concepts:
          type: integer
          minimum: 0
          description: 已完成验证的概念数
          example: 5
        current_concept:
          type: string
          description: 当前正在验证的概念
          example: "逆否命题"
        current_concept_idx:
          type: integer
          minimum: 0
          description: 当前概念索引（从0开始）
          example: 5
        green_count:
          type: integer
          minimum: 0
          default: 0
          description: 已掌握的概念数（绿色）
          example: 3
        yellow_count:
          type: integer
          minimum: 0
          default: 0
          description: 部分理解的概念数（黄色）
          example: 1
        purple_count:
          type: integer
          minimum: 0
          default: 0
          description: 需要分解的概念数（紫色）
          example: 1
        red_count:
          type: integer
          minimum: 0
          default: 0
          description: 未掌握的概念数（红色）
          example: 0
        status:
          type: string
          enum: [pending, in_progress, paused, completed, cancelled]
          description: 会话状态
          example: "in_progress"
        progress_percentage:
          type: number
          minimum: 0
          maximum: 100
          description: 完成百分比（completed/total * 100）
          example: 50.0
        mastery_percentage:
          type: number
          minimum: 0
          maximum: 100
          description: 掌握率（green/completed * 100）
          example: 60.0
        hints_given:
          type: integer
          minimum: 0
          default: 0
          description: 当前概念已给出的提示数
          example: 1
        max_hints:
          type: integer
          minimum: 0
          default: 3
          description: 每个概念最大提示数
          example: 3
        started_at:
          type: string
          format: date-time
          description: 会话开始时间
          example: "2026-01-20T10:00:00Z"
        updated_at:
          type: string
          format: date-time
          description: 最后更新时间
          example: "2026-01-20T10:15:30Z"

    # Story 31.6: 会话暂停/恢复响应
    SessionPauseResumeResponse:
      type: object
      description: |
        会话暂停/恢复操作响应

        Story 31.6 AC-31.6.4: 支持暂停/恢复会话功能
      required:
        - session_id
        - status
        - message
      properties:
        session_id:
          type: string
          description: 会话标识符
          example: "sess_abc123"
        status:
          type: string
          enum: [pending, in_progress, paused, completed, cancelled]
          description: 操作后的会话状态
          example: "paused"
        message:
          type: string
          description: 操作结果消息
          example: "Session paused successfully"
