openapi: 3.1.0
info:
  title: Canvas Learning System - Multimodal API
  description: |
    API endpoints for multimodal content upload, management, query, and search.

    Story 35.1: Multimodal Upload/Management API Endpoints
    - AC-35.1.1: POST /upload - File upload with validation
    - AC-35.1.2: POST /upload-url - URL content fetch
    - AC-35.1.3: DELETE /{content_id} - Delete content
    - AC-35.1.4: PUT /{content_id} - Update metadata
    - AC-35.1.5: GET /{content_id} - Retrieve content

    Story 35.2: Multimodal Query/Search API Endpoints
    - AC-35.2.1: GET /by-concept/{concept_id} - Query by concept
    - AC-35.2.2: POST /search - Vector similarity search
    - AC-35.2.3: GET /list - Paginated list with filters
    - AC-35.2.4: Response format matches frontend MediaItem interface

    [Source: docs/stories/35.1.story.md]
    [Source: docs/stories/35.2.story.md]
  version: 1.1.0
  contact:
    name: Canvas Learning System
    url: https://github.com/canvas-learning-system

servers:
  - url: http://localhost:8000/api/v1/multimodal
    description: Local development server

tags:
  - name: Multimodal
    description: Multimodal content management endpoints

paths:
  /upload:
    post:
      operationId: uploadFile
      summary: Upload a file
      description: |
        Upload a multimodal file (image, PDF, audio, video) and associate it with a Canvas concept.
        Maximum file size: 50MB.
      tags:
        - Multimodal
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              required:
                - file
                - related_concept_id
                - canvas_path
              properties:
                file:
                  type: string
                  format: binary
                  description: File to upload
                related_concept_id:
                  type: string
                  description: Canvas node ID to associate with
                canvas_path:
                  type: string
                  description: Canvas file path
                description:
                  type: string
                  description: Optional description
      responses:
        '201':
          description: File uploaded successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MultimodalUploadResponse'
        '413':
          description: File too large (max 50MB)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '415':
          description: Unsupported media type
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /upload-url:
    post:
      operationId: uploadFromUrl
      summary: Upload from URL
      description: Fetch content from a URL and upload it as multimodal content.
      tags:
        - Multimodal
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/MultimodalUploadUrlRequest'
      responses:
        '201':
          description: Content uploaded from URL successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MultimodalUploadResponse'
        '415':
          description: Unsupported media type
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: URL fetch failed or internal error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /{content_id}:
    get:
      operationId: getContent
      summary: Get content by ID
      description: Retrieve multimodal content details by its unique ID.
      tags:
        - Multimodal
      parameters:
        - name: content_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: Content UUID
      responses:
        '200':
          description: Content details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MultimodalResponse'
        '404':
          description: Content not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    put:
      operationId: updateContent
      summary: Update content metadata
      description: Update metadata for existing multimodal content.
      tags:
        - Multimodal
      parameters:
        - name: content_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: Content UUID
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/MultimodalUpdateRequest'
      responses:
        '200':
          description: Content updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MultimodalResponse'
        '404':
          description: Content not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    delete:
      operationId: deleteContent
      summary: Delete content
      description: Delete multimodal content and its associated files.
      tags:
        - Multimodal
      parameters:
        - name: content_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: Content UUID
      responses:
        '200':
          description: Content deleted successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MultimodalDeleteResponse'
        '404':
          description: Content not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /:
    get:
      operationId: listContent
      summary: List content
      description: List multimodal content with optional filters.
      tags:
        - Multimodal
      parameters:
        - name: concept_id
          in: query
          schema:
            type: string
          description: Filter by concept ID
        - name: media_type
          in: query
          schema:
            $ref: '#/components/schemas/MultimodalMediaType'
          description: Filter by media type
        - name: limit
          in: query
          schema:
            type: integer
            minimum: 1
            maximum: 1000
            default: 100
          description: Maximum items to return
      responses:
        '200':
          description: List of content items
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MultimodalListResponse'

  /health:
    get:
      operationId: healthCheck
      summary: Health check
      description: Check the health status of the multimodal service.
      tags:
        - Multimodal
      responses:
        '200':
          description: Health status
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MultimodalHealthResponse'

  # ═══════════════════════════════════════════════════════════════════════════════
  # Story 35.2: Query/Search Endpoints
  # [Source: docs/stories/35.2.story.md]
  # ═══════════════════════════════════════════════════════════════════════════════

  /by-concept/{concept_id}:
    get:
      operationId: getByConceptId
      summary: Get content by concept
      description: |
        Retrieve all multimodal content associated with a Canvas concept node.
        Returns a list of media items that are linked to the specified concept.
      tags:
        - Multimodal
      parameters:
        - name: concept_id
          in: path
          required: true
          schema:
            type: string
          description: Canvas concept node ID
        - name: media_type
          in: query
          schema:
            $ref: '#/components/schemas/MultimodalMediaType'
          description: Filter by media type
        - name: limit
          in: query
          schema:
            type: integer
            minimum: 1
            maximum: 200
            default: 100
          description: Maximum items to return
        - name: include_thumbnail
          in: query
          schema:
            type: boolean
            default: false
          description: Include base64 encoded thumbnails in response
      responses:
        '200':
          description: List of media items for concept
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MultimodalByConceptResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /search:
    post:
      operationId: searchMultimodal
      summary: Search content
      description: |
        Search multimodal content using vector similarity.
        Performs semantic search using embeddings to find relevant content.
        Falls back to text search if embedding service is unavailable.
      tags:
        - Multimodal
      parameters:
        - name: include_thumbnail
          in: query
          schema:
            type: boolean
            default: false
          description: Include base64 encoded thumbnails in response
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/MultimodalSearchRequest'
      responses:
        '200':
          description: Search results sorted by relevance
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MultimodalSearchResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /list:
    get:
      operationId: listMultimodal
      summary: List all content with pagination
      description: |
        List all multimodal content with pagination and filtering.
        Supports sorting by creation or update time.
      tags:
        - Multimodal
      parameters:
        - name: page
          in: query
          schema:
            type: integer
            minimum: 1
            default: 1
          description: Page number (1-indexed)
        - name: page_size
          in: query
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
          description: Items per page
        - name: media_type
          in: query
          schema:
            $ref: '#/components/schemas/MultimodalMediaType'
          description: Filter by media type
        - name: sort_by
          in: query
          schema:
            type: string
            enum:
              - created_at
              - updated_at
            default: created_at
          description: Field to sort by
        - name: sort_order
          in: query
          schema:
            type: string
            enum:
              - asc
              - desc
            default: desc
          description: Sort direction
        - name: include_thumbnail
          in: query
          schema:
            type: boolean
            default: false
          description: Include base64 encoded thumbnails in response
      responses:
        '200':
          description: Paginated list of content
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MultimodalPaginatedListResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

components:
  schemas:
    MultimodalMediaType:
      type: string
      enum:
        - image
        - pdf
        - audio
        - video
      description: Supported media types

    MultimodalMetadataSchema:
      type: object
      properties:
        file_size:
          type: integer
          minimum: 0
          description: File size in bytes
        width:
          type: integer
          minimum: 0
          description: Width in pixels (image/video)
        height:
          type: integer
          minimum: 0
          description: Height in pixels (image/video)
        duration:
          type: number
          minimum: 0
          description: Duration in seconds (audio/video)
        page_count:
          type: integer
          minimum: 0
          description: Page count (PDF)
        mime_type:
          type: string
          description: MIME type
        author:
          type: string
          description: Content author
        title:
          type: string
          description: Content title
        language:
          type: string
          description: Content language

    MultimodalUploadUrlRequest:
      type: object
      required:
        - url
        - related_concept_id
        - canvas_path
      properties:
        url:
          type: string
          format: uri
          minLength: 1
          description: URL to fetch content from
        related_concept_id:
          type: string
          minLength: 1
          description: Canvas node ID to associate with
        canvas_path:
          type: string
          minLength: 1
          description: Canvas file path
        description:
          type: string
          maxLength: 1000
          description: Optional description

    MultimodalUpdateRequest:
      type: object
      properties:
        description:
          type: string
          maxLength: 1000
          description: Updated description
        related_concept_id:
          type: string
          minLength: 1
          description: New related concept ID
        source_location:
          type: string
          maxLength: 255
          description: Page number (PDF) or timestamp (audio/video)

    MultimodalResponse:
      type: object
      required:
        - id
        - media_type
        - file_path
        - related_concept_id
        - created_at
      properties:
        id:
          type: string
          format: uuid
          description: Unique content identifier
        media_type:
          $ref: '#/components/schemas/MultimodalMediaType'
        file_path:
          type: string
          description: Path to the media file
        related_concept_id:
          type: string
          description: Associated Canvas concept node ID
        created_at:
          type: string
          format: date-time
          description: Creation timestamp
        thumbnail_path:
          type: string
          nullable: true
          description: Path to thumbnail image
        extracted_text:
          type: string
          nullable: true
          description: OCR-extracted text
        description:
          type: string
          nullable: true
          description: Content description
        source_location:
          type: string
          nullable: true
          description: Page number or timestamp
        updated_at:
          type: string
          format: date-time
          nullable: true
          description: Last update timestamp
        metadata:
          $ref: '#/components/schemas/MultimodalMetadataSchema'

    MultimodalUploadResponse:
      type: object
      required:
        - content
        - message
      properties:
        content:
          $ref: '#/components/schemas/MultimodalResponse'
        message:
          type: string
          description: Status message
        thumbnail_generated:
          type: boolean
          default: false
          description: Whether thumbnail was generated

    MultimodalDeleteResponse:
      type: object
      required:
        - deleted_id
        - message
      properties:
        deleted_id:
          type: string
          format: uuid
          description: ID of deleted content
        message:
          type: string
          description: Status message
        file_deleted:
          type: boolean
          default: true
          description: Whether physical file was deleted
        thumbnail_deleted:
          type: boolean
          default: false
          description: Whether thumbnail was also deleted

    MultimodalListResponse:
      type: object
      required:
        - items
        - total
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/MultimodalResponse'
          description: List of multimodal content items
        total:
          type: integer
          minimum: 0
          description: Total item count
        concept_id:
          type: string
          nullable: true
          description: Filter concept ID if applied
        media_type:
          $ref: '#/components/schemas/MultimodalMediaType'
          nullable: true
          description: Filter media type if applied

    MultimodalHealthResponse:
      type: object
      required:
        - status
        - lancedb_connected
        - neo4j_connected
        - storage_path_writable
      properties:
        status:
          type: string
          enum:
            - healthy
            - degraded
            - unhealthy
          description: Service status
        lancedb_connected:
          type: boolean
          description: LanceDB connection status
        neo4j_connected:
          type: boolean
          description: Neo4j connection status
        storage_path_writable:
          type: boolean
          description: Storage path write access
        total_items:
          type: integer
          minimum: 0
          default: 0
          description: Total stored items count

    ErrorResponse:
      type: object
      required:
        - detail
      properties:
        detail:
          type: string
          description: Error message

    # ═══════════════════════════════════════════════════════════════════════════════
    # Story 35.2: Query/Search Response Schemas
    # [Source: docs/stories/35.2.story.md]
    # ═══════════════════════════════════════════════════════════════════════════════

    MediaItemResponse:
      type: object
      description: |
        Response model matching frontend MediaItem interface.
        [Source: canvas-progress-tracker/obsidian-plugin/src/components/MediaPanel.ts:30-45]
      required:
        - id
        - type
        - path
        - relevanceScore
      properties:
        id:
          type: string
          format: uuid
          description: Unique content identifier
        type:
          type: string
          enum:
            - image
            - pdf
            - audio
            - video
          description: Media type
        path:
          type: string
          description: File path
        title:
          type: string
          maxLength: 50
          nullable: true
          description: Title (truncated to 50 chars)
        relevanceScore:
          type: number
          format: float
          minimum: 0.0
          maximum: 1.0
          description: Relevance score (0-1)
        conceptId:
          type: string
          nullable: true
          description: Related concept node ID
        metadata:
          type: object
          nullable: true
          additionalProperties: true
          description: Additional metadata
        thumbnail:
          type: string
          nullable: true
          description: Base64 encoded thumbnail image

    PaginationMeta:
      type: object
      description: Pagination metadata for paginated responses.
      required:
        - total
        - page
        - page_size
        - total_pages
        - has_next
        - has_prev
      properties:
        total:
          type: integer
          minimum: 0
          description: Total number of items
        page:
          type: integer
          minimum: 1
          description: Current page number (1-indexed)
        page_size:
          type: integer
          minimum: 1
          maximum: 100
          description: Items per page
        total_pages:
          type: integer
          minimum: 0
          description: Total number of pages
        has_next:
          type: boolean
          description: Whether there is a next page
        has_prev:
          type: boolean
          description: Whether there is a previous page

    MultimodalByConceptResponse:
      type: object
      description: Response model for GET /by-concept/{concept_id}.
      required:
        - items
        - total
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/MediaItemResponse'
          description: List of media items associated with the concept
        total:
          type: integer
          minimum: 0
          description: Total number of items

    MultimodalSearchRequest:
      type: object
      description: Request model for POST /search.
      required:
        - query
      properties:
        query:
          type: string
          minLength: 1
          maxLength: 1000
          description: Search query text for semantic search
        media_types:
          type: array
          items:
            $ref: '#/components/schemas/MultimodalMediaType'
          nullable: true
          description: Optional filter by media types
        top_k:
          type: integer
          minimum: 1
          maximum: 100
          default: 10
          description: Maximum number of results
        min_score:
          type: number
          format: float
          minimum: 0.0
          maximum: 1.0
          default: 0.5
          description: Minimum similarity score threshold

    MultimodalSearchResponse:
      type: object
      description: Response model for POST /search.
      required:
        - items
        - total
        - query_processed
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/MediaItemResponse'
          description: List of search results sorted by relevance
        total:
          type: integer
          minimum: 0
          description: Number of results returned
        query_processed:
          type: boolean
          default: true
          description: |
            Whether the query was successfully processed.
            true = vector search used, false = fallback text search used.

    MultimodalPaginatedListResponse:
      type: object
      description: Response model for GET /list with pagination.
      required:
        - items
        - pagination
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/MediaItemResponse'
          description: List of media items for current page
        pagination:
          $ref: '#/components/schemas/PaginationMeta'
          description: Pagination metadata
