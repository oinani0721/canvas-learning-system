openapi: 3.0.3
info:
  title: Canvas Learning System API
  description: |
    Canvas学习系统 - Obsidian Canvas学习系统API

    本API覆盖Canvas Learning System的四层架构：
    - Layer 1: CanvasJSONOperator - 基础JSON CRUD操作
    - Layer 2: CanvasBusinessLogic - 业务逻辑层
    - Layer 3: CanvasOrchestrator - 编排层，调度Sub-agents
    - Layer 4: KnowledgeGraphLayer - 知识图谱层

    **核心规范**:
    - 所有Canvas操作必须保持文件完整性
    - 颜色代码: "1"(红), "2"(橙), "3"(黄), "5"(绿), "6"(紫)
    - UTF-8编码，支持中文

    **版本**: 2.0.0
    **更新日期**: 2025-11-19
  version: 2.0.0
  contact:
    name: Canvas Learning System Team
  license:
    name: MIT

servers:
  - url: http://localhost:8000/api/v2
    description: Local development server

tags:
  - name: Layer1-JSON
    description: Layer 1 - 基础Canvas JSON操作 (CanvasJSONOperator)
  - name: Layer2-Business
    description: Layer 2 - 业务逻辑层 (CanvasBusinessLogic)
  - name: Layer3-Orchestrator
    description: Layer 3 - 编排API和Agent调度 (CanvasOrchestrator)
  - name: Layer4-Knowledge
    description: Layer 4 - 知识图谱和记忆层 (KnowledgeGraphLayer)
  - name: Utilities
    description: 工具类API (颜色、评分等)

paths:
  # Layer 1: CanvasJSONOperator
  /canvas/{canvas_path}:
    get:
      summary: 读取Canvas文件
      operationId: readCanvas
      tags: [Layer1-JSON]
      parameters:
        - name: canvas_path
          in: path
          required: true
          description: Canvas文件路径
          schema:
            type: string
      responses:
        '200':
          description: 成功返回Canvas数据
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CanvasData'
    put:
      summary: 写入Canvas文件
      operationId: writeCanvas
      tags: [Layer1-JSON]
      parameters:
        - name: canvas_path
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CanvasData'
      responses:
        '200':
          description: 成功写入Canvas文件

  /canvas/{canvas_path}/nodes:
    post:
      summary: 添加节点到Canvas
      operationId: addNode
      tags: [Layer1-JSON]
      parameters:
        - name: canvas_path
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/NodeInput'
      responses:
        '201':
          description: 成功添加节点
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CanvasNode'

  /canvas/{canvas_path}/nodes/{node_id}:
    get:
      summary: 获取单个节点
      operationId: getNode
      tags: [Layer1-JSON]
      parameters:
        - name: canvas_path
          in: path
          required: true
          schema:
            type: string
        - name: node_id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: 成功返回节点
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CanvasNode'
    put:
      summary: 更新节点
      operationId: updateNode
      tags: [Layer1-JSON]
      parameters:
        - name: canvas_path
          in: path
          required: true
          schema:
            type: string
        - name: node_id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/NodeInput'
      responses:
        '200':
          description: 成功更新节点
    delete:
      summary: 删除节点
      operationId: deleteNode
      tags: [Layer1-JSON]
      parameters:
        - name: canvas_path
          in: path
          required: true
          schema:
            type: string
        - name: node_id
          in: path
          required: true
          schema:
            type: string
      responses:
        '204':
          description: 成功删除节点

  # Layer 2: CanvasBusinessLogic
  /canvas/{canvas_path}/nodes/by-color/{color}:
    get:
      summary: 按颜色获取节点
      operationId: getNodesByColor
      tags: [Layer2-Business]
      parameters:
        - name: canvas_path
          in: path
          required: true
          schema:
            type: string
        - name: color
          in: path
          required: true
          schema:
            type: string
            enum: ["1", "2", "3", "4", "5", "6"]  # Story 12.B.4
      responses:
        '200':
          description: 返回指定颜色的节点列表
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/CanvasNode'

  /canvas/{canvas_path}/nodes/{node_id}/color:
    put:
      summary: 更新节点颜色
      operationId: updateNodeColor
      tags: [Layer2-Business]
      parameters:
        - name: canvas_path
          in: path
          required: true
          schema:
            type: string
        - name: node_id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                color:
                  type: string
                  enum: ["1", "2", "3", "4", "5", "6"]  # Story 12.B.4
              required: [color]
      responses:
        '200':
          description: 成功更新颜色

  # Layer 3: CanvasOrchestrator - Agent调用
  /agents/invoke:
    post:
      summary: 调用Agent
      operationId: invokeAgent
      tags: [Layer3-Orchestrator]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AgentInvocationRequest'
      responses:
        '200':
          description: Agent响应
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AgentResponse'

  /agents/batch:
    post:
      summary: 批量调用Agents
      operationId: batchInvokeAgents
      tags: [Layer3-Orchestrator]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                invocations:
                  type: array
                  items:
                    $ref: '#/components/schemas/AgentInvocationRequest'
              required: [invocations]
      responses:
        '200':
          description: 批量Agent响应
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/AgentResponse'

  # Layer 4: KnowledgeGraphLayer
  /knowledge/search:
    post:
      summary: 知识图谱搜索
      operationId: searchKnowledge
      tags: [Layer4-Knowledge]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                query:
                  type: string
                  description: 搜索查询
                top_k:
                  type: integer
                  default: 10
                  description: 返回结果数量
              required: [query]
      responses:
        '200':
          description: 搜索结果
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  properties:
                    content:
                      type: string
                    score:
                      type: number
                    metadata:
                      type: object

  /knowledge/add:
    post:
      summary: 添加知识到图谱
      operationId: addKnowledge
      tags: [Layer4-Knowledge]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                content:
                  type: string
                metadata:
                  type: object
              required: [content]
      responses:
        '201':
          description: 成功添加知识

components:
  schemas:
    CanvasData:
      type: object
      description: Canvas文件数据结构
      properties:
        nodes:
          type: array
          items:
            $ref: '#/components/schemas/CanvasNode'
        edges:
          type: array
          items:
            $ref: '#/components/schemas/CanvasEdge'
      required: [nodes, edges]

    CanvasNode:
      type: object
      description: Canvas节点
      properties:
        id:
          type: string
          description: 节点唯一标识
        type:
          type: string
          enum: [text, file, group, link]
          description: 节点类型
        text:
          type: string
          description: 文本内容（type=text时）
        file:
          type: string
          description: 文件路径（type=file时）
        url:
          type: string
          description: URL（type=link时）
        x:
          type: integer
          description: X坐标
        y:
          type: integer
          description: Y坐标
        width:
          type: integer
          description: 宽度
        height:
          type: integer
          description: 高度
        color:
          type: string
          enum: ["1", "2", "3", "4", "5", "6"]  # Story 12.B.4
          description: "颜色代码: 1=红, 2=橙, 3=黄, 5=绿, 6=紫"
      required: [id, type, x, y]

    CanvasEdge:
      type: object
      description: Canvas边（连接）
      properties:
        id:
          type: string
          description: 边唯一标识
        fromNode:
          type: string
          description: 起始节点ID
        toNode:
          type: string
          description: 目标节点ID
        fromSide:
          type: string
          enum: [top, bottom, left, right]
        toSide:
          type: string
          enum: [top, bottom, left, right]
      required: [id, fromNode, toNode]

    NodeInput:
      type: object
      description: 节点输入数据
      properties:
        type:
          type: string
          enum: [text, file, group, link]
        text:
          type: string
        file:
          type: string
        url:
          type: string
        x:
          type: integer
        y:
          type: integer
        width:
          type: integer
        height:
          type: integer
        color:
          type: string
          enum: ["1", "2", "3", "4", "5", "6"]  # Story 12.B.4
      required: [type]

    AgentInvocationRequest:
      type: object
      description: Agent调用请求
      properties:
        agent_type:
          type: string
          description: Agent类型
          enum:
            - basic-decomposition
            - oral-explanation
            - four-level-explanation
            - clarification-path
            - comparison-table
            - example-teaching
            - memory-anchor
            - question-decomposition
            - deep-decomposition
            - scoring-agent
            - verification-question-agent
            - canvas-orchestrator
        canvas_path:
          type: string
          description: Canvas文件路径
        target_node_id:
          type: string
          description: 目标节点ID
        parameters:
          type: object
          description: Agent特定参数
      required: [agent_type, canvas_path]

    AgentResponse:
      type: object
      description: Agent响应
      properties:
        success:
          type: boolean
        agent_type:
          type: string
        result:
          type: object
          description: Agent输出结果
        error:
          type: string
          description: 错误信息（如果失败）
        execution_time_ms:
          type: number
          description: 执行时间（毫秒）
      required: [success, agent_type]
