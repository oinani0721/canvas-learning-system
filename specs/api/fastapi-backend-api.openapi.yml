# FastAPI Backend API Specification
# ✅ Verified from Context7:/oai/openapi-specification
# Generated: 2025-11-24, Updated: 2026-01-17 (Story 30.8 Task 6.3)
# All 23+ endpoints for Canvas Learning System FastAPI Backend

openapi: 3.0.3
info:
  title: Canvas Learning System - FastAPI Backend API
  description: |
    Canvas Learning System后端API规范，提供Canvas操作、Agent调用和复习系统功能。

    ## 验证来源
    - OpenAPI格式: Context7 /oai/openapi-specification (3.0.0 - 3.1.1)
    - 业务需求: PRD Epic 15
    - 架构设计: docs/architecture/EPIC-11-BACKEND-ARCHITECTURE.md
  version: 1.0.0
  x-source-verification:
    verified_at: "2026-01-17T05:00:00Z"
    format_source:
      type: context7
      library_id: "/oai/openapi-specification"
      topic: "info object, paths, components, specification extensions"
    business_source:
      prd_version: "v1.1.9"
      epic: "Epic 15, Epic 22, Epic 30"
      story_refs: ["15.1", "15.2", "15.3", "22.4", "30.3", "30.8"]
  contact:
    name: Canvas Learning System
    url: https://github.com/canvas-learning-system

servers:
  - url: http://localhost:8000
    description: Local development server

tags:
  - name: System
    description: 系统健康检查
  - name: Canvas
    description: Canvas文件和节点操作
  - name: Agents
    description: AI Agent调用接口
  - name: Review
    description: 艾宾浩斯复习系统
  - name: Memory
    description: 学习记忆系统API (Story 22.4, 30.8)
  - name: Textbook
    description: 教材挂载与同步API (Story 34.3)
  - name: RAG
    description: 智能检索增强生成 (Story 35.8)

paths:
  # ══════════════════════════════════════════════════════════════════
  # System Endpoints (1)
  # ══════════════════════════════════════════════════════════════════
  /api/v1/health:
    get:
      summary: 健康检查
      description: 返回应用状态、名称、版本和时间戳
      operationId: health_check
      tags:
        - System
      responses:
        '200':
          description: 应用健康
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthCheckResponse'
              example:
                status: "healthy"
                app_name: "Canvas Learning System"
                version: "1.0.0"
                timestamp: "2025-11-24T10:30:00Z"
        '500':
          description: 应用异常
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  # ══════════════════════════════════════════════════════════════════
  # Memory Health Endpoints (Story 30.3)
  # ══════════════════════════════════════════════════════════════════
  /api/v1/memory/health:
    get:
      summary: Memory系统健康检查
      description: 返回3层Memory系统(Temporal/Graphiti/Semantic)整体健康状态
      operationId: memory_health_check
      tags:
        - System
        - Memory
      responses:
        '200':
          description: Memory系统健康状态
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MemoryHealthResponse'
              example:
                status: "healthy"
                layers:
                  temporal:
                    status: "ok"
                    backend: "sqlite"
                  graphiti:
                    status: "ok"
                    backend: "neo4j"
                    node_count: 1234
                  semantic:
                    status: "ok"
                    backend: "lancedb"
                    vector_count: 5678
                timestamp: "2026-01-16T10:00:00Z"

  /api/v1/memory/episodes/batch:
    post:
      summary: 批量记录学习事件
      description: 支持单次请求提交多个学习事件 (Story 30.3 AC-30.3.10)
      operationId: batch_create_learning_episodes
      tags:
        - Memory
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/BatchEpisodesRequest'
            example:
              events:
                - event_type: "color_changed"
                  timestamp: "2026-01-16T12:00:00Z"
                  canvas_path: "离散数学/命题逻辑.canvas"
                  node_id: "b33c50660173e5d3"
                  metadata:
                    old_color: "1"
                    new_color: "2"
                    old_level: "not_understood"
                    new_level: "mastered"
      responses:
        '201':
          description: 批量处理成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BatchEpisodesResponse'
              example:
                processed: 5
                failed: 0
                episode_ids: ["ep-001", "ep-002", "ep-003", "ep-004", "ep-005"]
        '400':
          description: 请求格式错误
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/v1/health/neo4j:
    get:
      summary: Neo4j健康检查
      description: 测试Neo4j Bolt连接状态
      operationId: neo4j_health_check
      tags:
        - System
      responses:
        '200':
          description: Neo4j连接正常
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Neo4jHealthResponse'
        '503':
          description: Neo4j连接失败
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Neo4jHealthResponse'

  /api/v1/health/graphiti:
    get:
      summary: Graphiti健康检查
      description: 测试Graphiti客户端初始化状态和图统计
      operationId: graphiti_health_check
      tags:
        - System
      responses:
        '200':
          description: Graphiti正常
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GraphitiHealthResponse'
              example:
                status: "ok"
                graph_stats:
                  node_count: 1234
                  edge_count: 5678
                  episode_count: 890
                last_episode_timestamp: "2026-01-15T15:30:00Z"
        '503':
          description: Graphiti不可用
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GraphitiHealthResponse'

  /api/v1/health/lancedb:
    get:
      summary: LanceDB健康检查
      description: 测试LanceDB向量库连接状态
      operationId: lancedb_health_check
      tags:
        - System
      responses:
        '200':
          description: LanceDB正常
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LanceDBHealthResponse'
              example:
                status: "ok"
                table_count: 3
                total_vectors: 50000
                embedding_model: "text-embedding-3-small"
        '503':
          description: LanceDB不可用
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LanceDBHealthResponse'

  /api/v1/health/storage:
    get:
      summary: 统一存储健康检查
      description: |
        检查所有存储后端(Neo4j/MCP/JSON)的健康状态。
        返回连接池指标、P95延迟统计和状态聚合结果。
        Story 36.10 实现。
      operationId: check_storage_health
      tags:
        - System
      responses:
        '200':
          description: 存储健康检查结果
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StorageHealthResponse'
              examples:
                healthy:
                  summary: 所有存储正常
                  value:
                    status: "healthy"
                    storage_backends:
                      - name: "neo4j"
                        status: "ok"
                        latency_ms: 45
                      - name: "mcp"
                        status: "ok"
                        latency_ms: 120
                      - name: "json"
                        status: "ok"
                        latency_ms: 5
                    connection_pool:
                      neo4j:
                        active: 3
                        idle: 7
                        max_size: 50
                        utilization_percent: 6.0
                    latency_metrics:
                      p95_ms: 85
                      p50_ms: 42
                      sample_count: 150
                      window_seconds: 300
                    cached: false
                    cache_ttl_remaining_seconds: 0
                    timestamp: "2026-01-20T10:30:00Z"
                degraded:
                  summary: 部分存储异常
                  value:
                    status: "degraded"
                    storage_backends:
                      - name: "neo4j"
                        status: "ok"
                        latency_ms: 50
                      - name: "mcp"
                        status: "error"
                        error: "MCP server timeout"
                      - name: "json"
                        status: "ok"
                        latency_ms: 3
                    connection_pool:
                      neo4j:
                        active: 5
                        idle: 5
                        max_size: 50
                        utilization_percent: 10.0
                    latency_metrics:
                      p95_ms: 120
                      p50_ms: 55
                      sample_count: 100
                      window_seconds: 300
                    cached: true
                    cache_ttl_remaining_seconds: 15
                    timestamp: "2026-01-20T10:29:45Z"
                unhealthy:
                  summary: 关键存储不可用
                  value:
                    status: "unhealthy"
                    storage_backends:
                      - name: "neo4j"
                        status: "error"
                        error: "Connection refused"
                      - name: "mcp"
                        status: "ok"
                        latency_ms: 80
                      - name: "json"
                        status: "ok"
                        latency_ms: 2
                    connection_pool: {}
                    latency_metrics:
                      p95_ms: 0
                      p50_ms: 0
                      sample_count: 0
                      window_seconds: 300
                    cached: false
                    cache_ttl_remaining_seconds: 0
                    timestamp: "2026-01-20T10:30:00Z"

  # ══════════════════════════════════════════════════════════════════
  # Memory API Endpoints (Story 22.4, 30.8)
  # ══════════════════════════════════════════════════════════════════
  /api/v1/memory/episodes:
    post:
      summary: 记录学习事件
      description: |
        记录用户的学习事件，存储到Neo4j和Graphiti。
        Story 22.4 AC-22.4.1 实现。
      operationId: create_learning_episode
      tags:
        - Memory
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LearningEpisodeCreate'
            example:
              user_id: "user-123"
              canvas_path: "离散数学.canvas"
              node_id: "node-abc123"
              concept: "逆否命题"
              agent_type: "basic-decomposition"
              score: 85
              duration_seconds: 300
      responses:
        '201':
          description: 学习事件已创建
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LearningEpisodeResponse'
              example:
                episode_id: "episode-a1b2c3d4e5f67890"
                status: "created"
        '400':
          description: 请求格式错误
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: 服务器内部错误
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
    get:
      summary: 查询学习历史
      description: |
        查询用户的学习历史，支持分页和过滤。
        Story 22.4 AC-22.4.2, AC-22.4.5 实现。
        Story 30.8 AC-30.8.3: 支持subject学科过滤。
      operationId: get_learning_history
      tags:
        - Memory
      parameters:
        - name: user_id
          in: query
          required: true
          schema:
            type: string
          description: 用户ID
        - name: start_date
          in: query
          required: false
          schema:
            type: string
            format: date-time
          description: 开始日期
        - name: end_date
          in: query
          required: false
          schema:
            type: string
            format: date-time
          description: 结束日期
        - name: concept
          in: query
          required: false
          schema:
            type: string
          description: 概念过滤
        - name: subject
          in: query
          required: false
          schema:
            type: string
          description: 学科过滤 (AC-30.8.3，支持Unicode如"数学")
          example: "数学"
        - name: page
          in: query
          required: false
          schema:
            type: integer
            minimum: 1
            default: 1
          description: 页码
        - name: page_size
          in: query
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 50
          description: 每页大小
      responses:
        '200':
          description: 学习历史列表
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LearningHistoryResponse'
        '400':
          description: 请求参数错误
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: 服务器内部错误
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/v1/memory/concepts/{concept_id}/history:
    get:
      summary: 查询概念学习历史
      description: |
        查询特定概念的学习历史，包含时间线和得分变化。
        Story 22.4 AC-22.4.3 实现。
      operationId: get_concept_history
      tags:
        - Memory
      parameters:
        - name: concept_id
          in: path
          required: true
          schema:
            type: string
          description: 概念ID
        - name: user_id
          in: query
          required: false
          schema:
            type: string
          description: 用户ID (可选)
        - name: limit
          in: query
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 200
            default: 50
          description: 最大返回数量
      responses:
        '200':
          description: 概念学习历史
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ConceptHistoryResponse'
              example:
                concept_id: "concept-123"
                timeline:
                  - timestamp: "2026-01-12T10:30:00Z"
                    score: 85
                    user_id: "user-123"
                    concept: "逆否命题"
                    review_count: 3
                score_trend:
                  first: 60
                  last: 85
                  average: 72.5
                  improvement: 25
                total_reviews: 5
        '404':
          description: 概念不存在
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: 服务器内部错误
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/v1/memory/review-suggestions:
    get:
      summary: 获取复习建议
      description: |
        获取基于艾宾浩斯遗忘曲线的复习建议。
        Story 22.4 AC-22.4.4 实现。
        Story 30.8 AC-30.8.3: 支持subject学科过滤。
      operationId: get_review_suggestions
      tags:
        - Memory
      parameters:
        - name: user_id
          in: query
          required: true
          schema:
            type: string
          description: 用户ID
        - name: limit
          in: query
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 50
            default: 10
          description: 返回数量
        - name: subject
          in: query
          required: false
          schema:
            type: string
          description: 学科过滤 (AC-30.8.3，支持Unicode如"数学")
          example: "数学"
      responses:
        '200':
          description: 复习建议列表
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/ReviewSuggestionResponse'
              example:
                - concept: "逆否命题"
                  concept_id: "concept-123"
                  last_score: 75
                  review_count: 2
                  due_date: "2026-01-17T00:00:00Z"
                  priority: "high"
        '400':
          description: 请求参数错误
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: 服务器内部错误
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  # ══════════════════════════════════════════════════════════════════
  # Canvas Endpoints (6)
  # ══════════════════════════════════════════════════════════════════
  /api/v1/canvas/{canvas_name}:
    get:
      summary: 读取Canvas文件
      operationId: read_canvas
      tags:
        - Canvas
      parameters:
        - name: canvas_name
          in: path
          required: true
          schema:
            type: string
          description: Canvas文件名(不含.canvas后缀)
      responses:
        '200':
          description: Canvas数据
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CanvasResponse'
        '404':
          description: Canvas文件不存在
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/v1/canvas/{canvas_name}/nodes:
    post:
      summary: 创建节点
      operationId: create_node
      tags:
        - Canvas
      parameters:
        - name: canvas_name
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/NodeCreate'
      responses:
        '201':
          description: 节点已创建
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/NodeRead'
        '400':
          description: 验证错误
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Canvas不存在
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/v1/canvas/{canvas_name}/nodes/{node_id}:
    put:
      summary: 更新节点
      operationId: update_node
      tags:
        - Canvas
      parameters:
        - name: canvas_name
          in: path
          required: true
          schema:
            type: string
        - name: node_id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/NodeUpdate'
      responses:
        '200':
          description: 节点已更新
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/NodeRead'
        '404':
          description: Canvas或节点不存在
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
    delete:
      summary: 删除节点
      operationId: delete_node
      tags:
        - Canvas
      parameters:
        - name: canvas_name
          in: path
          required: true
          schema:
            type: string
        - name: node_id
          in: path
          required: true
          schema:
            type: string
      responses:
        '204':
          description: 节点已删除
        '404':
          description: Canvas或节点不存在
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/v1/canvas/{canvas_name}/edges:
    post:
      summary: 创建边
      operationId: create_edge
      tags:
        - Canvas
      parameters:
        - name: canvas_name
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/EdgeCreate'
      responses:
        '201':
          description: 边已创建
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EdgeRead'
        '400':
          description: 验证错误
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/v1/canvas/{canvas_name}/edges/{edge_id}:
    delete:
      summary: 删除边
      operationId: delete_edge
      tags:
        - Canvas
      parameters:
        - name: canvas_name
          in: path
          required: true
          schema:
            type: string
        - name: edge_id
          in: path
          required: true
          schema:
            type: string
      responses:
        '204':
          description: 边已删除
        '404':
          description: Canvas或边不存在
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  # ══════════════════════════════════════════════════════════════════
  # Agent Endpoints (9)
  # ══════════════════════════════════════════════════════════════════
  /api/v1/agents/decompose/basic:
    post:
      summary: 基础概念拆解
      operationId: decompose_basic
      tags:
        - Agents
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/DecomposeRequest'
      responses:
        '200':
          description: 拆解结果
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DecomposeResponse'
        '400':
          description: 验证错误
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/v1/agents/decompose/deep:
    post:
      summary: 深度概念拆解
      operationId: decompose_deep
      tags:
        - Agents
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/DecomposeRequest'
      responses:
        '200':
          description: 深度拆解结果
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DecomposeResponse'

  /api/v1/agents/score:
    post:
      summary: 评分用户理解
      operationId: score_understanding
      tags:
        - Agents
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ScoreRequest'
      responses:
        '200':
          description: 评分结果
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ScoreResponse'

  /api/v1/agents/explain/oral:
    post:
      summary: 口语化解释
      operationId: explain_oral
      tags:
        - Agents
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ExplainRequest'
      responses:
        '200':
          description: 口语化解释结果
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ExplainResponse'

  /api/v1/agents/explain/clarification:
    post:
      summary: 澄清路径生成
      operationId: explain_clarification
      tags:
        - Agents
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ExplainRequest'
      responses:
        '200':
          description: 澄清路径结果
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ExplainResponse'

  /api/v1/agents/explain/comparison:
    post:
      summary: 对比表格生成
      operationId: explain_comparison
      tags:
        - Agents
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ExplainRequest'
      responses:
        '200':
          description: 对比表格结果
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ExplainResponse'

  /api/v1/agents/explain/memory:
    post:
      summary: 记忆锚点生成
      operationId: explain_memory
      tags:
        - Agents
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ExplainRequest'
      responses:
        '200':
          description: 记忆锚点结果
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ExplainResponse'

  /api/v1/agents/explain/four-level:
    post:
      summary: 四层次解释
      operationId: explain_four_level
      tags:
        - Agents
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ExplainRequest'
      responses:
        '200':
          description: 四层次解释结果
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ExplainResponse'

  /api/v1/agents/explain/example:
    post:
      summary: 例题教学
      operationId: explain_example
      tags:
        - Agents
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ExplainRequest'
      responses:
        '200':
          description: 例题教学结果
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ExplainResponse'

  # ══════════════════════════════════════════════════════════════════
  # Review Endpoints (4) - Story 32.7: Added fsrs-state endpoint
  # ══════════════════════════════════════════════════════════════════
  /api/v1/review/schedule:
    get:
      summary: 获取复习计划
      description: 基于艾宾浩斯遗忘曲线返回待复习项目
      operationId: get_review_schedule
      tags:
        - Review
      parameters:
        - name: days
          in: query
          schema:
            type: integer
            default: 7
          description: 查询未来N天的复习计划
      responses:
        '200':
          description: 复习计划列表
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ReviewScheduleResponse'

  /api/v1/review/generate:
    post:
      summary: 生成检验白板
      description: 为指定Canvas生成检验白板用于复习
      operationId: generate_verification_canvas
      tags:
        - Review
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/GenerateReviewRequest'
      responses:
        '201':
          description: 检验白板已生成
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GenerateReviewResponse'
        '404':
          description: 源Canvas不存在
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/v1/review/record:
    put:
      summary: 记录复习结果
      description: |
        记录用户复习完成情况，更新下次复习时间。
        使用FSRS算法计算最优复习间隔。
        评分说明: 1=Again(忘记), 2=Hard(困难), 3=Good(正常), 4=Easy(轻松)
      operationId: record_review_result
      tags:
        - Review
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RecordReviewRequest'
      responses:
        '200':
          description: 复习结果已记录
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RecordReviewResponse'

  /api/v1/review/fsrs-state/{concept_id}:
    get:
      summary: 获取概念的FSRS卡片状态
      description: |
        返回指定概念的Py-FSRS卡片状态，包括记忆稳定性、难度和下次复习时间。
        Story 32.3 AC-32.3.2 实现。
      operationId: get_fsrs_state
      tags:
        - Review
      parameters:
        - name: concept_id
          in: path
          required: true
          schema:
            type: string
          description: 概念ID
      responses:
        '200':
          description: FSRS卡片状态
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FSRSCardState'
        '404':
          description: 概念不存在
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  # ══════════════════════════════════════════════════════════════════
  # Textbook Endpoints (3) - Story 34.3
  # ══════════════════════════════════════════════════════════════════
  /api/v1/textbook/sync-mount:
    post:
      summary: 同步挂载的教材到后端
      description: |
        将前端挂载的教材同步到后端 .canvas-links.json 文件。
        桥接前端 localStorage 与后端文件系统，使 Agent 服务能获取教材上下文。

        [Source: Story 34.3 - 教材挂载前后端完整同步]
      operationId: sync_mount_textbook
      tags:
        - Textbook
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SyncMountRequest'
            example:
              canvas_path: "离散数学/命题逻辑.canvas"
              textbook:
                id: "tb-1705123456789-abc123"
                path: "教材/离散数学讲义.pdf"
                name: "离散数学讲义"
                type: "pdf"
                sections:
                  - id: "section-1"
                    title: "第一章 命题逻辑"
                    level: 1
                    preview: "命题逻辑是数理逻辑的基础..."
                    start_offset: 0
                    end_offset: 5000
                    page_number: 1
      responses:
        '200':
          description: 教材同步成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SyncMountResponse'
              example:
                success: true
                config_path: "离散数学/.canvas-links.json"
                message: "Textbook '离散数学讲义' synced successfully"
                association_id: "mount-tb-1705123456789-abc123"
        '500':
          description: 同步失败
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/v1/textbook/unmount:
    post:
      summary: 取消教材挂载
      description: 从 .canvas-links.json 中移除教材关联
      operationId: unmount_textbook
      tags:
        - Textbook
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UnmountRequest'
            example:
              canvas_path: "离散数学/命题逻辑.canvas"
              textbook_id: "tb-1705123456789-abc123"
      responses:
        '200':
          description: 教材卸载成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UnmountResponse'
              example:
                success: true
                message: "Textbook unmounted successfully"
        '500':
          description: 卸载失败
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/v1/textbook/mounted/{canvas_path}:
    get:
      summary: 列出Canvas已挂载的教材
      description: 返回指定Canvas关联的所有教材（从 .canvas-links.json 读取）
      operationId: list_mounted_textbooks
      tags:
        - Textbook
      parameters:
        - name: canvas_path
          in: path
          required: true
          schema:
            type: string
          description: Canvas文件路径
          example: "离散数学/命题逻辑.canvas"
      responses:
        '200':
          description: 已挂载的教材列表
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ListMountedResponse'
              example:
                canvas_path: "离散数学/命题逻辑.canvas"
                associations:
                  - association_id: "mount-tb-1705123456789-abc123"
                    association_type: "references"
                    target_canvas: "教材/离散数学讲义.pdf"
                    description: "离散数学讲义 (pdf)"
                    file_type: "pdf"
                    sections: []
                config_path: "离散数学/.canvas-links.json"
        '500':
          description: 查询失败
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  # ══════════════════════════════════════════════════════════════════
  # RAG Endpoints (Story 35.8)
  # ══════════════════════════════════════════════════════════════════
  /api/v1/rag/query:
    post:
      summary: RAG智能检索
      description: |
        执行智能检索查询，支持多源检索、融合和质量控制。
        - 多源并行检索 (Graphiti + LanceDB + 多模态)
        - 3种融合算法 (RRF, Weighted, Cascade)
        - 混合Reranking (Local + Cohere)
        - 质量控制与Query重写

        [Source: Story 35.8 - RAG多模态搜索集成]
      operationId: rag_query
      tags:
        - RAG
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RAGQueryRequest'
            example:
              query: "什么是逆否命题？"
              canvas_file: "离散数学.canvas"
              is_review_canvas: false
      responses:
        '200':
          description: 查询成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RAGQueryResponse'
              example:
                results:
                  - doc_id: "node-123"
                    content: "逆否命题是将原命题的条件和结论同时取否定..."
                    score: 0.95
                    metadata:
                      source: "graphiti"
                      canvas: "离散数学.canvas"
                multimodal_results:
                  - id: "mm-001"
                    media_type: "image"
                    path: "笔记库/images/逆否命题图解.png"
                    thumbnail: "data:image/png;base64,..."
                    relevance_score: 0.87
                    metadata:
                      width: 800
                      height: 600
                quality_grade: "high"
                result_count: 1
                latency_ms:
                  graphiti: 45.2
                  lancedb: 32.1
                  multimodal: 58.5
                  fusion: 5.3
                  reranking: 12.8
                total_latency_ms: 153.9
                metadata:
                  query_rewritten: false
                  rewrite_count: 0
                  fusion_strategy: "rrf"
                  reranking_strategy: "hybrid_auto"
        '503':
          description: RAG服务不可用
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: 查询执行失败
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/v1/rag/status:
    get:
      summary: RAG服务状态
      description: 获取RAG服务状态信息，包括LangGraph可用性
      operationId: get_rag_status
      tags:
        - RAG
      responses:
        '200':
          description: 服务状态
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RAGStatusResponse'
              example:
                available: true
                initialized: true
                langgraph_available: true
                import_error: null
                timestamp: "2026-01-20T10:30:00Z"

  /api/v1/rag/weak-concepts/{canvas_file}:
    get:
      summary: 获取薄弱概念
      description: 从Temporal Memory获取指定Canvas的薄弱概念列表
      operationId: get_weak_concepts
      tags:
        - RAG
      parameters:
        - name: canvas_file
          in: path
          required: true
          schema:
            type: string
          description: Canvas文件路径
          example: "离散数学.canvas"
        - name: limit
          in: query
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 50
            default: 10
          description: 返回数量限制
      responses:
        '200':
          description: 薄弱概念列表
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WeakConceptsResponse'
              example:
                concepts:
                  - concept: "逆否命题"
                    stability: 0.35
                    last_review: "2026-01-15T10:00:00Z"
                    review_count: 2
                total_count: 1
                canvas_file: "离散数学.canvas"
        '503':
          description: RAG服务不可用
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

# ══════════════════════════════════════════════════════════════════
# Components
# ══════════════════════════════════════════════════════════════════
components:
  schemas:
    # ─────────────────────────────────────────────────────────────────
    # Common Schemas
    # ─────────────────────────────────────────────────────────────────
    HealthCheckResponse:
      type: object
      required:
        - status
        - app_name
        - version
        - timestamp
      properties:
        status:
          type: string
          enum: ["healthy", "unhealthy"]
          description: 应用健康状态
        app_name:
          type: string
          description: 应用名称
        version:
          type: string
          description: 应用版本
        timestamp:
          type: string
          format: date-time
          description: 检查时间戳

    ErrorResponse:
      type: object
      required:
        - code
        - message
      properties:
        code:
          type: integer
          format: int32
          description: 错误码
        message:
          type: string
          description: 错误信息
        details:
          type: object
          description: 额外错误详情

    # ─────────────────────────────────────────────────────────────────
    # Storage Health Schema (Story 36.10)
    # ─────────────────────────────────────────────────────────────────
    StorageBackendStatus:
      type: object
      required:
        - name
        - status
      properties:
        name:
          type: string
          enum: ["neo4j", "mcp", "json"]
          description: 存储后端名称
        status:
          type: string
          enum: ["ok", "error"]
          description: 存储状态
        latency_ms:
          type: number
          minimum: 0
          description: 健康检查响应延迟(毫秒)
        error:
          type: string
          description: 错误信息(仅status=error时存在)
        details:
          type: object
          description: 存储特定的详细信息

    Neo4jConnectionPool:
      type: object
      properties:
        active:
          type: integer
          minimum: 0
          description: 当前活跃连接数
        idle:
          type: integer
          minimum: 0
          description: 空闲连接数
        max_size:
          type: integer
          minimum: 1
          description: 连接池最大容量
        utilization_percent:
          type: number
          minimum: 0
          maximum: 100
          description: 连接池使用率百分比

    LatencyMetrics:
      type: object
      required:
        - p95_ms
        - window_seconds
      properties:
        p95_ms:
          type: number
          minimum: 0
          description: P95延迟(毫秒) - 95%的请求在此时间内完成
        p50_ms:
          type: number
          minimum: 0
          description: P50延迟(中位数，毫秒)
        sample_count:
          type: integer
          minimum: 0
          description: 窗口内样本数量
        window_seconds:
          type: integer
          minimum: 1
          description: 统计窗口时长(秒)

    StorageHealthResponse:
      type: object
      description: 统一存储健康检查响应 (Story 36.10)
      required:
        - status
        - storage_backends
        - connection_pool
        - latency_metrics
        - cached
        - timestamp
      properties:
        status:
          type: string
          enum: ["healthy", "degraded", "unhealthy"]
          description: "整体存储状态: healthy=所有存储正常, degraded=部分存储异常, unhealthy=关键存储(Neo4j)不可用"
        storage_backends:
          type: array
          items:
            $ref: '#/components/schemas/StorageBackendStatus'
          description: 各存储后端状态列表
        connection_pool:
          type: object
          additionalProperties:
            $ref: '#/components/schemas/Neo4jConnectionPool'
          description: 连接池状态信息
        latency_metrics:
          $ref: '#/components/schemas/LatencyMetrics'
        cached:
          type: boolean
          description: 是否为缓存结果
        cache_ttl_remaining_seconds:
          type: integer
          minimum: 0
          description: 缓存剩余有效时间(秒)
        timestamp:
          type: string
          format: date-time
          description: 健康检查时间戳 (ISO 8601格式)

    # ─────────────────────────────────────────────────────────────────
    # Memory Batch Schemas (Story 30.3 AC-30.3.10)
    # ─────────────────────────────────────────────────────────────────
    BatchEventItem:
      type: object
      required:
        - event_type
        - timestamp
        - canvas_path
        - node_id
      properties:
        event_type:
          type: string
          description: 事件类型
        timestamp:
          type: string
          format: date-time
          description: 事件时间戳
        canvas_path:
          type: string
          description: Canvas文件路径
        node_id:
          type: string
          description: 节点ID
        metadata:
          type: object
          description: 事件元数据(可包含old_color, new_color, old_level, new_level)

    BatchEpisodesRequest:
      type: object
      required:
        - events
      properties:
        events:
          type: array
          items:
            $ref: '#/components/schemas/BatchEventItem'
          maxItems: 50
          description: 批量事件列表(最多50个)

    BatchEpisodesResponse:
      type: object
      required:
        - processed
        - failed
        - episode_ids
      properties:
        processed:
          type: integer
          minimum: 0
          description: 成功处理的事件数
        failed:
          type: integer
          minimum: 0
          description: 处理失败的事件数
        episode_ids:
          type: array
          items:
            type: string
          description: 生成的Episode ID列表

    # ─────────────────────────────────────────────────────────────────
    # Memory Episode Schemas (Story 22.4, 30.8)
    # ─────────────────────────────────────────────────────────────────
    LearningEpisodeCreate:
      type: object
      required:
        - user_id
        - canvas_path
        - node_id
        - concept
        - agent_type
      properties:
        user_id:
          type: string
          description: 用户ID
        canvas_path:
          type: string
          description: Canvas文件路径
        node_id:
          type: string
          description: Canvas节点ID
        concept:
          type: string
          description: 学习概念
        agent_type:
          type: string
          description: 使用的Agent类型
        score:
          type: integer
          minimum: 0
          maximum: 100
          description: 得分 (0-100)
        duration_seconds:
          type: integer
          minimum: 0
          description: 学习时长 (秒)

    LearningEpisodeResponse:
      type: object
      required:
        - episode_id
        - status
      properties:
        episode_id:
          type: string
          description: Episode唯一标识
        status:
          type: string
          description: 状态

    LearningHistoryItem:
      type: object
      required:
        - episode_id
        - user_id
        - canvas_path
        - node_id
        - concept
        - agent_type
        - timestamp
      properties:
        episode_id:
          type: string
          description: Episode ID
        user_id:
          type: string
          description: 用户ID
        canvas_path:
          type: string
          description: Canvas文件路径
        node_id:
          type: string
          description: Canvas节点ID
        concept:
          type: string
          description: 学习概念
        agent_type:
          type: string
          description: 使用的Agent类型
        score:
          type: integer
          description: 得分
        duration_seconds:
          type: integer
          description: 学习时长
        timestamp:
          type: string
          format: date-time
          description: 时间戳

    LearningHistoryResponse:
      type: object
      required:
        - items
        - total
        - page
        - page_size
        - pages
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/LearningHistoryItem'
          description: 学习历史列表
        total:
          type: integer
          description: 总记录数
        page:
          type: integer
          description: 当前页码
        page_size:
          type: integer
          description: 每页大小
        pages:
          type: integer
          description: 总页数

    ConceptHistoryTimeline:
      type: object
      properties:
        timestamp:
          type: string
          format: date-time
          description: 时间戳
        score:
          type: integer
          description: 得分
        user_id:
          type: string
          description: 用户ID
        concept:
          type: string
          description: 概念名称
        review_count:
          type: integer
          default: 0
          description: 复习次数

    ScoreTrend:
      type: object
      properties:
        first:
          type: integer
          description: 首次得分
        last:
          type: integer
          description: 最近得分
        average:
          type: number
          description: 平均得分
        improvement:
          type: integer
          description: 分数提升

    ConceptHistoryResponse:
      type: object
      required:
        - concept_id
        - timeline
        - score_trend
        - total_reviews
      properties:
        concept_id:
          type: string
          description: 概念ID
        timeline:
          type: array
          items:
            $ref: '#/components/schemas/ConceptHistoryTimeline'
          description: 时间线数据
        score_trend:
          $ref: '#/components/schemas/ScoreTrend'
        total_reviews:
          type: integer
          description: 总复习次数

    ReviewSuggestionResponse:
      type: object
      required:
        - concept
        - concept_id
        - review_count
        - due_date
        - priority
      properties:
        concept:
          type: string
          description: 概念名称
        concept_id:
          type: string
          description: 概念ID
        last_score:
          type: integer
          description: 最近得分
        review_count:
          type: integer
          description: 复习次数
        due_date:
          type: string
          format: date-time
          description: 到期日期
        priority:
          type: string
          enum: ["high", "medium", "low"]
          description: 优先级

    # ─────────────────────────────────────────────────────────────────
    # Canvas Schemas
    # ─────────────────────────────────────────────────────────────────
    CanvasResponse:
      type: object
      required:
        - name
        - nodes
        - edges
      properties:
        name:
          type: string
          description: Canvas文件名
        nodes:
          type: array
          items:
            $ref: '#/components/schemas/NodeRead'
        edges:
          type: array
          items:
            $ref: '#/components/schemas/EdgeRead'

    NodeCreate:
      type: object
      required:
        - type
        - x
        - y
      properties:
        type:
          type: string
          enum: ["text", "file", "group", "link"]
        text:
          type: string
          description: 文本内容(type=text时必填)
        file:
          type: string
          description: 文件路径(type=file时必填)
        url:
          type: string
          format: uri
          description: 链接URL(type=link时必填)
        x:
          type: integer
        y:
          type: integer
        width:
          type: integer
          default: 250
        height:
          type: integer
          default: 60
        color:
          type: string
          enum: ["1", "2", "3", "4", "5", "6"]
          description: "颜色代码: 1=红, 2=橙, 3=黄, 4=绿, 5=青, 6=紫"

    NodeUpdate:
      type: object
      properties:
        text:
          type: string
        x:
          type: integer
        y:
          type: integer
        width:
          type: integer
        height:
          type: integer
        color:
          type: string
          enum: ["1", "2", "3", "4", "5", "6"]

    NodeRead:
      type: object
      required:
        - id
        - type
        - x
        - y
        - width
        - height
      properties:
        id:
          type: string
          pattern: "^[a-f0-9]+$"
        type:
          type: string
          enum: ["text", "file", "group", "link"]
        text:
          type: string
        file:
          type: string
        url:
          type: string
          format: uri
        x:
          type: integer
        y:
          type: integer
        width:
          type: integer
        height:
          type: integer
        color:
          type: string
          enum: ["1", "2", "3", "4", "5", "6"]

    EdgeCreate:
      type: object
      required:
        - fromNode
        - toNode
      properties:
        fromNode:
          type: string
          description: 源节点ID
        toNode:
          type: string
          description: 目标节点ID
        fromSide:
          type: string
          enum: ["top", "bottom", "left", "right"]
        toSide:
          type: string
          enum: ["top", "bottom", "left", "right"]
        label:
          type: string
          description: 边标签

    EdgeRead:
      type: object
      required:
        - id
        - fromNode
        - toNode
      properties:
        id:
          type: string
        fromNode:
          type: string
        toNode:
          type: string
        fromSide:
          type: string
        toSide:
          type: string
        label:
          type: string

    # ─────────────────────────────────────────────────────────────────
    # Agent Schemas
    # ─────────────────────────────────────────────────────────────────
    DecomposeRequest:
      type: object
      required:
        - canvas_name
        - node_id
      properties:
        canvas_name:
          type: string
          description: Canvas文件名
        node_id:
          type: string
          description: 目标节点ID

    DecomposeResponse:
      type: object
      required:
        - questions
        - created_nodes
      properties:
        questions:
          type: array
          items:
            type: string
          description: 生成的引导问题
        created_nodes:
          type: array
          items:
            $ref: '#/components/schemas/NodeRead'
          description: 创建的新节点

    ScoreRequest:
      type: object
      required:
        - canvas_name
        - node_ids
      properties:
        canvas_name:
          type: string
        node_ids:
          type: array
          items:
            type: string
          description: 要评分的节点ID列表

    ScoreResponse:
      type: object
      required:
        - scores
      properties:
        scores:
          type: array
          items:
            $ref: '#/components/schemas/NodeScore'

    NodeScore:
      type: object
      required:
        - node_id
        - accuracy
        - imagery
        - completeness
        - originality
        - total
        - new_color
      properties:
        node_id:
          type: string
        accuracy:
          type: number
          minimum: 0
          maximum: 10
          description: 准确性得分
        imagery:
          type: number
          minimum: 0
          maximum: 10
          description: 形象性得分
        completeness:
          type: number
          minimum: 0
          maximum: 10
          description: 完整性得分
        originality:
          type: number
          minimum: 0
          maximum: 10
          description: 原创性得分
        total:
          type: number
          minimum: 0
          maximum: 40
          description: 总分
        new_color:
          type: string
          enum: ["2", "3", "4"]
          description: "评分后节点颜色: 2=绿(>=32), 3=黄(24-31), 4=红(<24)"

    ExplainRequest:
      type: object
      required:
        - canvas_name
        - node_id
      properties:
        canvas_name:
          type: string
        node_id:
          type: string

    ExplainResponse:
      type: object
      required:
        - explanation
        - created_node_id
      properties:
        explanation:
          type: string
          description: 生成的解释内容
        created_node_id:
          type: string
          description: 创建的解释节点ID

    # ─────────────────────────────────────────────────────────────────
    # Review Schemas
    # ─────────────────────────────────────────────────────────────────
    ReviewScheduleResponse:
      type: object
      required:
        - items
        - total_count
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/ReviewItem'
        total_count:
          type: integer

    ReviewItem:
      type: object
      required:
        - canvas_name
        - node_id
        - concept
        - due_date
        - interval_days
      properties:
        canvas_name:
          type: string
        node_id:
          type: string
        concept:
          type: string
          description: 概念名称
        due_date:
          type: string
          format: date
        interval_days:
          type: integer
          description: 当前复习间隔(1/7/30天)

    GenerateReviewRequest:
      type: object
      required:
        - source_canvas
      properties:
        source_canvas:
          type: string
          description: 源Canvas文件名
        node_ids:
          type: array
          items:
            type: string
          description: 指定节点ID(可选，默认全部绿色节点)

    GenerateReviewResponse:
      type: object
      required:
        - verification_canvas_name
        - node_count
      properties:
        verification_canvas_name:
          type: string
          description: 生成的检验白板文件名
        node_count:
          type: integer
          description: 包含的检验节点数量

    RecordReviewRequest:
      type: object
      required:
        - canvas_name
        - node_id
        - score
      properties:
        canvas_name:
          type: string
        node_id:
          type: string
        score:
          type: number
          minimum: 0
          maximum: 40
          description: 复习得分(0-40)

    RecordReviewResponse:
      type: object
      required:
        - next_review_date
        - new_interval
      properties:
        next_review_date:
          type: string
          format: date
          description: 下次复习日期 (FSRS算法计算)
        new_interval:
          type: integer
          description: 新的复习间隔天数 (FSRS动态计算)
        fsrs_state:
          $ref: '#/components/schemas/FSRSCardState'
          description: 更新后的FSRS卡片状态 (Story 32.2新增)

    # ─────────────────────────────────────────────────────────────────
    # FSRS Schemas (Story 32.7)
    # ─────────────────────────────────────────────────────────────────
    FSRSCardState:
      type: object
      description: FSRS卡片状态 (Source: specs/data/fsrs-card.schema.json)
      required:
        - concept_id
        - due
        - stability
        - difficulty
        - state
      properties:
        concept_id:
          type: string
          description: 概念ID
        due:
          type: string
          format: date-time
          description: 下次复习时间
        stability:
          type: number
          minimum: 0
          description: 记忆稳定性
        difficulty:
          type: number
          minimum: 1
          maximum: 10
          description: 难度 (1-10)
        elapsed_days:
          type: integer
          minimum: 0
          description: 距上次复习天数
        scheduled_days:
          type: integer
          minimum: 0
          description: 计划间隔天数
        reps:
          type: integer
          minimum: 0
          description: 复习次数
        lapses:
          type: integer
          minimum: 0
          description: 遗忘次数
        state:
          type: integer
          enum: [1, 2, 3]
          description: "卡片状态 (py-fsrs State: 1=Learning, 2=Review, 3=Relearning)"

    FSRSRating:
      type: integer
      enum: [1, 2, 3, 4]
      description: |
        FSRS评分等级 (py-fsrs Rating enum):
        - 1: Again - 完全忘记
        - 2: Hard - 困难回忆
        - 3: Good - 正常回忆
        - 4: Easy - 轻松回忆

    # ─────────────────────────────────────────────────────────────────
    # Textbook Schemas (Story 34.3)
    # ─────────────────────────────────────────────────────────────────
    TextbookSection:
      type: object
      required:
        - id
        - title
      properties:
        id:
          type: string
          description: 章节唯一ID
        title:
          type: string
          description: 章节标题
        level:
          type: integer
          minimum: 1
          maximum: 6
          default: 1
          description: 标题级别 (1-6)
        preview:
          type: string
          default: ""
          description: 内容预览
        start_offset:
          type: integer
          default: 0
          description: 文件起始偏移
        end_offset:
          type: integer
          default: 0
          description: 文件结束偏移
        page_number:
          type: integer
          nullable: true
          description: PDF页码 (仅PDF类型)

    MountedTextbook:
      type: object
      required:
        - id
        - path
        - name
        - type
      properties:
        id:
          type: string
          description: 教材唯一ID
        path:
          type: string
          description: Vault中的文件路径
        name:
          type: string
          description: 显示名称
        type:
          type: string
          enum: ["markdown", "pdf", "canvas"]
          description: 教材类型
        sections:
          type: array
          items:
            $ref: '#/components/schemas/TextbookSection'
          default: []
          description: 章节列表

    SyncMountRequest:
      type: object
      required:
        - canvas_path
        - textbook
      properties:
        canvas_path:
          type: string
          description: 当前Canvas文件路径
        textbook:
          $ref: '#/components/schemas/MountedTextbook'

    SyncMountResponse:
      type: object
      required:
        - success
        - config_path
      properties:
        success:
          type: boolean
          description: 同步是否成功
        config_path:
          type: string
          description: .canvas-links.json 文件路径
        message:
          type: string
          default: ""
          description: 状态消息
        association_id:
          type: string
          default: ""
          description: 创建的关联ID

    UnmountRequest:
      type: object
      required:
        - canvas_path
        - textbook_id
      properties:
        canvas_path:
          type: string
          description: Canvas文件路径
        textbook_id:
          type: string
          description: 要卸载的教材ID

    UnmountResponse:
      type: object
      required:
        - success
        - message
      properties:
        success:
          type: boolean
          description: 卸载是否成功
        message:
          type: string
          description: 状态消息

    TextbookAssociation:
      type: object
      properties:
        association_id:
          type: string
          description: 关联ID
        association_type:
          type: string
          description: 关联类型 (references)
        target_canvas:
          type: string
          description: 目标文件路径
        description:
          type: string
          description: 关联描述
        file_type:
          type: string
          enum: ["markdown", "pdf", "canvas"]
          description: 文件类型
        sections:
          type: array
          items:
            type: object
            properties:
              id:
                type: string
              title:
                type: string
              page_number:
                type: integer
                nullable: true

    ListMountedResponse:
      type: object
      required:
        - canvas_path
        - associations
        - config_path
      properties:
        canvas_path:
          type: string
          description: Canvas文件路径
        associations:
          type: array
          items:
            $ref: '#/components/schemas/TextbookAssociation'
          description: 教材关联列表
        config_path:
          type: string
          description: 配置文件路径

    # ─────────────────────────────────────────────────────────────────
    # RAG Schemas (Story 35.8)
    # ─────────────────────────────────────────────────────────────────
    RAGQueryRequest:
      type: object
      required:
        - query
      properties:
        query:
          type: string
          minLength: 1
          maxLength: 2000
          description: 查询字符串
        canvas_file:
          type: string
          nullable: true
          description: Canvas文件路径 (用于上下文过滤)
        is_review_canvas:
          type: boolean
          default: false
          description: 是否为检验白板场景
        fusion_strategy:
          type: string
          enum: ["rrf", "weighted", "cascade"]
          nullable: true
          description: "融合策略 (默认: rrf, 检验白板: weighted)"
        reranking_strategy:
          type: string
          enum: ["local", "cohere", "hybrid_auto"]
          nullable: true
          description: "Reranking策略 (默认: hybrid_auto)"

    SearchResultItem:
      type: object
      required:
        - doc_id
        - content
        - score
      properties:
        doc_id:
          type: string
          description: 文档ID
        content:
          type: string
          description: 内容
        score:
          type: number
          format: float
          description: 相关度分数
        metadata:
          type: object
          additionalProperties: true
          default: {}
          description: 元数据

    MultimodalResultItem:
      type: object
      description: 多模态检索结果项 (Story 35.8 AC-35.8.1)
      required:
        - id
        - media_type
        - path
        - relevance_score
      properties:
        id:
          type: string
          description: 内容ID
        media_type:
          type: string
          enum: ["image", "pdf", "audio", "video"]
          description: 媒体类型
        path:
          type: string
          description: 文件路径
        thumbnail:
          type: string
          nullable: true
          description: 缩略图Base64或URL
        relevance_score:
          type: number
          format: float
          minimum: 0.0
          maximum: 1.0
          description: 相关度分数 (0-1)
        metadata:
          type: object
          additionalProperties: true
          default: {}
          description: 额外元数据

    LatencyInfo:
      type: object
      description: 延迟信息
      properties:
        graphiti:
          type: number
          format: float
          nullable: true
          description: Graphiti检索延迟 (ms)
        lancedb:
          type: number
          format: float
          nullable: true
          description: LanceDB检索延迟 (ms)
        multimodal:
          type: number
          format: float
          nullable: true
          description: 多模态检索延迟 (ms)
        fusion:
          type: number
          format: float
          nullable: true
          description: 融合延迟 (ms)
        reranking:
          type: number
          format: float
          nullable: true
          description: Reranking延迟 (ms)

    RAGQueryMetadata:
      type: object
      description: RAG查询元数据
      properties:
        query_rewritten:
          type: boolean
          default: false
          description: Query是否被重写
        rewrite_count:
          type: integer
          default: 0
          description: 重写次数
        fusion_strategy:
          type: string
          nullable: true
          description: 使用的融合策略
        reranking_strategy:
          type: string
          nullable: true
          description: 使用的Reranking策略

    RAGQueryResponse:
      type: object
      description: RAG查询响应 (Story 35.8 - 含multimodal_results)
      required:
        - results
        - quality_grade
        - result_count
        - total_latency_ms
      properties:
        results:
          type: array
          items:
            $ref: '#/components/schemas/SearchResultItem'
          default: []
          description: 检索结果列表
        multimodal_results:
          type: array
          items:
            $ref: '#/components/schemas/MultimodalResultItem'
          default: []
          description: 多模态检索结果 (Story 35.8 AC-35.8.1)
        quality_grade:
          type: string
          enum: ["high", "medium", "low"]
          default: "low"
          description: 质量评级
        result_count:
          type: integer
          default: 0
          description: 结果数量
        latency_ms:
          $ref: '#/components/schemas/LatencyInfo'
        total_latency_ms:
          type: number
          format: float
          default: 0.0
          description: 总延迟 (ms)
        metadata:
          $ref: '#/components/schemas/RAGQueryMetadata'

    RAGStatusResponse:
      type: object
      description: RAG服务状态响应
      required:
        - available
        - initialized
        - langgraph_available
        - timestamp
      properties:
        available:
          type: boolean
          description: 服务是否可用
        initialized:
          type: boolean
          description: 是否已初始化
        langgraph_available:
          type: boolean
          description: LangGraph是否可用
        import_error:
          type: string
          nullable: true
          description: 导入错误信息
        timestamp:
          type: string
          format: date-time
          description: 时间戳

    WeakConceptItem:
      type: object
      description: 薄弱概念项
      required:
        - concept
        - stability
        - review_count
      properties:
        concept:
          type: string
          description: 概念名称
        stability:
          type: number
          format: float
          minimum: 0.0
          maximum: 1.0
          description: 稳定性分数 (0-1)
        last_review:
          type: string
          format: date-time
          nullable: true
          description: 上次复习时间
        review_count:
          type: integer
          default: 0
          description: 复习次数

    WeakConceptsResponse:
      type: object
      description: 薄弱概念响应
      required:
        - concepts
        - total_count
        - canvas_file
      properties:
        concepts:
          type: array
          items:
            $ref: '#/components/schemas/WeakConceptItem'
          default: []
          description: 薄弱概念列表
        total_count:
          type: integer
          default: 0
          description: 总数量
        canvas_file:
          type: string
          description: Canvas文件
