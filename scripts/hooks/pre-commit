#!/bin/bash
# Canvas Learning System - Unified Pre-commit Hook (v2.0)
#
# 功能:
#   1. [Spec Sync] API 变更 → OpenAPI + JSON Schema 导出 + 一致性验证 + 破坏性变更检测
#   2. [Plugin Build] 插件变更 → 编译到 vault + 新鲜度验证 (编译失败则阻塞 commit)
#   3. [Ghost Files] 检测未追踪的 docs/stories/ 和 docs/epics/ 文件 (警告)
#
# 源文件: scripts/hooks/pre-commit
# 安装: cp scripts/hooks/pre-commit .git/hooks/pre-commit
#
# 历史:
#   v1.0 (2026-02-06): 基础 OpenAPI 导出 + 插件编译
#   v2.0 (2026-02-11): 完整规范同步 + 幽灵文件检测

set -e

# 颜色
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

REPO_ROOT=$(git rev-parse --show-toplevel)
ISSUES_FOUND=0

# ============================================================
# Section 1: Full Spec Sync (OpenAPI + JSON Schema + Validation)
# ============================================================
echo -e "${CYAN}[Spec Sync]${NC} Checking for API changes..."

API_CHANGES=$(git diff --cached --name-only | grep -E "^backend/app/(api|models|schemas)/" || true)

if [ -z "$API_CHANGES" ]; then
    echo -e "${GREEN}[Spec Sync]${NC} No API changes detected, skipping."
else
    echo -e "${YELLOW}[Spec Sync]${NC} API changes detected:"
    echo "$API_CHANGES"

    if command -v python &> /dev/null; then
        # Step 1/4: 保存旧 OpenAPI 用于破坏性变更检测
        OLD_OPENAPI="/tmp/old-openapi-$(date +%s).json"
        if [ -f "$REPO_ROOT/openapi.json" ]; then
            cp "$REPO_ROOT/openapi.json" "$OLD_OPENAPI"
        fi

        # Step 2/4: 导出 OpenAPI 规范
        echo -e "${YELLOW}[Spec Sync]${NC} Step 1/4: Exporting OpenAPI specification..."
        cd "$REPO_ROOT/backend" 2>/dev/null

        if python ../scripts/spec-tools/export-openapi.py 2>/dev/null; then
            echo -e "${GREEN}[Spec Sync]${NC} OpenAPI spec exported successfully."
        else
            echo -e "${YELLOW}[Spec Sync]${NC} OpenAPI export skipped (FastAPI app not available)."
        fi

        cd "$REPO_ROOT"

        # Step 2/4: 导出 JSON Schema (Pydantic → JSON Schema)
        echo -e "${YELLOW}[Spec Sync]${NC} Step 2/4: Exporting JSON Schemas from Pydantic..."

        if python scripts/spec-tools/export-json-schemas.py 2>/dev/null; then
            echo -e "${GREEN}[Spec Sync]${NC} JSON Schemas exported successfully."
        else
            echo -e "${YELLOW}[Spec Sync]${NC} JSON Schema export skipped."
        fi

        # Step 3/4: 验证规范一致性
        echo -e "${YELLOW}[Spec Sync]${NC} Step 3/4: Validating spec consistency..."

        CONSISTENCY_RESULT=$(python scripts/spec-tools/validate-spec-consistency.py --json 2>/dev/null || echo '{"summary":{"is_valid":true}}')
        IS_VALID=$(echo "$CONSISTENCY_RESULT" | python -c "import sys, json; print(json.load(sys.stdin).get('summary', {}).get('is_valid', True))" 2>/dev/null || echo "True")

        if [ "$IS_VALID" = "False" ]; then
            echo -e "${RED}[Spec Sync]${NC} ⚠️  Spec consistency validation FAILED!"
            echo -e "${RED}[Spec Sync]${NC} Run: python scripts/spec-tools/validate-spec-consistency.py"
            ISSUES_FOUND=$((ISSUES_FOUND + 1))
            # 不阻塞 commit，只警告
        else
            echo -e "${GREEN}[Spec Sync]${NC} Spec consistency OK."
        fi

        # Step 4/4: 检测破坏性变更
        echo -e "${YELLOW}[Spec Sync]${NC} Step 4/4: Checking for breaking changes..."

        if [ -f "$OLD_OPENAPI" ] && [ -f "$REPO_ROOT/openapi.json" ]; then
            BREAKING=$(python scripts/spec-tools/diff-openapi.py "$OLD_OPENAPI" "$REPO_ROOT/openapi.json" --json 2>/dev/null || echo '{"breaking_changes":[]}')
            BREAKING_COUNT=$(echo "$BREAKING" | python -c "import sys, json; print(len(json.load(sys.stdin).get('breaking_changes', [])))" 2>/dev/null || echo "0")

            if [ "$BREAKING_COUNT" != "0" ]; then
                echo -e "${RED}[Spec Sync]${NC} ⚠️  $BREAKING_COUNT breaking change(s) detected!"
                echo -e "${RED}[Spec Sync]${NC} Run: python scripts/spec-tools/diff-openapi.py $OLD_OPENAPI openapi.json"
                ISSUES_FOUND=$((ISSUES_FOUND + 1))
            else
                echo -e "${GREEN}[Spec Sync]${NC} No breaking changes detected."
            fi
            rm -f "$OLD_OPENAPI"
        fi

        # 添加规范文件到 commit
        echo -e "${YELLOW}[Spec Sync]${NC} Adding spec files to commit..."
        SPEC_ADDED=0

        # 添加 openapi.json
        if [ -f "$REPO_ROOT/openapi.json" ]; then
            if ! git diff --quiet "$REPO_ROOT/openapi.json" 2>/dev/null; then
                git add "$REPO_ROOT/openapi.json"
                echo -e "${GREEN}[Spec Sync]${NC}   + openapi.json"
                SPEC_ADDED=$((SPEC_ADDED + 1))
            fi
        fi

        # 添加生成的 JSON Schema
        if [ -d "$REPO_ROOT/specs/data/generated" ]; then
            for schema in "$REPO_ROOT/specs/data/generated"/*.schema.json; do
                if [ -f "$schema" ]; then
                    if ! git diff --quiet "$schema" 2>/dev/null; then
                        git add "$schema"
                        echo -e "${GREEN}[Spec Sync]${NC}   + $(basename "$schema")"
                        SPEC_ADDED=$((SPEC_ADDED + 1))
                    fi
                fi
            done
        fi

        if [ $SPEC_ADDED -eq 0 ]; then
            echo -e "${GREEN}[Spec Sync]${NC} No spec changes to add."
        else
            echo -e "${GREEN}[Spec Sync]${NC} Added $SPEC_ADDED spec file(s) to commit."
        fi
    else
        echo -e "${RED}[Spec Sync]${NC} Python not found, skipping spec export."
    fi
fi

# ============================================================
# Section 2: Obsidian Plugin Auto-Build
# ============================================================
echo -e "${CYAN}[Plugin Build]${NC} Checking for plugin changes..."

PLUGIN_CHANGES=$(git diff --cached --name-only | grep -E "^canvas-progress-tracker/obsidian-plugin/.*\.(ts|css|json)$" || true)

if [ -z "$PLUGIN_CHANGES" ]; then
    echo -e "${GREEN}[Plugin Build]${NC} No plugin changes detected, skipping."
else
    echo -e "${CYAN}[Plugin Build]${NC} Plugin source changes detected:"
    echo "$PLUGIN_CHANGES"

    PLUGIN_DIR="$REPO_ROOT/canvas-progress-tracker/obsidian-plugin"

    if [ ! -d "$PLUGIN_DIR/node_modules" ]; then
        echo -e "${RED}[Plugin Build]${NC} node_modules not found! Cannot build plugin."
        echo -e "${RED}[Plugin Build]${NC} Run: cd canvas-progress-tracker/obsidian-plugin && npm install"
        echo -e "${RED}[Plugin Build]${NC} Commit blocked — plugin changes require build."
        exit 1
    else
        echo -e "${CYAN}[Plugin Build]${NC} Building + deploying plugin to vault..."
        cd "$PLUGIN_DIR"

        if npm run deploy 2>&1; then
            echo -e "${GREEN}[Plugin Build]${NC} Plugin compiled + synced (main.js, manifest.json, styles.css)."

            # 运行 verify 检查同步状态
            if npm run verify 2>&1; then
                echo -e "${GREEN}[Plugin Build]${NC} Vault sync verified: FRESH"
            else
                echo -e "${RED}[Plugin Build]${NC} Vault sync verification FAILED!"
                echo -e "${RED}[Plugin Build]${NC} Commit blocked — vault main.js is stale."
                exit 1
            fi
        else
            echo -e "${RED}[Plugin Build]${NC} Build FAILED! Fix errors before committing."
            exit 1
        fi

        cd "$REPO_ROOT"
    fi
fi

# ============================================================
# Section 3: Ghost File Detection (expanded)
# ============================================================
echo -e "${CYAN}[Ghost Files]${NC} Checking for untracked project files..."

# 检测所有关键目录中的未跟踪文件
GHOST_DIRS=("docs/stories/" "docs/epics/" "backend/tests/" "backend/app/" "_bmad-output/" "specs/" "canvas-progress-tracker/obsidian-plugin/scripts/")
GHOST_FILES=""

for dir in "${GHOST_DIRS[@]}"; do
    if [ -d "$REPO_ROOT/$dir" ]; then
        FOUND=$(git ls-files --others --exclude-standard -- "$dir" 2>/dev/null || true)
        if [ -n "$FOUND" ]; then
            if [ -n "$GHOST_FILES" ]; then
                GHOST_FILES="$GHOST_FILES
$FOUND"
            else
                GHOST_FILES="$FOUND"
            fi
        fi
    fi
done

if [ -n "$GHOST_FILES" ]; then
    GHOST_COUNT=$(echo "$GHOST_FILES" | wc -l | tr -d ' ')
    echo -e "${RED}[Ghost Files]${NC} ⚠️  Found $GHOST_COUNT untracked project file(s):"
    echo "$GHOST_FILES" | head -20 | while read -r f; do
        echo -e "  ${YELLOW}??${NC} $f"
    done
    if [ "$GHOST_COUNT" -gt 20 ]; then
        echo -e "  ${YELLOW}...${NC} and $((GHOST_COUNT - 20)) more"
    fi
    echo -e "${YELLOW}[Ghost Files]${NC} These files exist on disk but are NOT in git!"
    echo -e "${YELLOW}[Ghost Files]${NC} To track: git add <file>"
    echo -e "${YELLOW}[Ghost Files]${NC} Scanned dirs: ${GHOST_DIRS[*]}"
    ISSUES_FOUND=$((ISSUES_FOUND + 1))
else
    echo -e "${GREEN}[Ghost Files]${NC} No untracked project files found."
fi

# ============================================================
# Summary
# ============================================================
echo ""
if [ $ISSUES_FOUND -gt 0 ]; then
    echo -e "${YELLOW}[Pre-commit]${NC} Completed with $ISSUES_FOUND warning(s). Commit proceeding."
else
    echo -e "${GREEN}[Pre-commit]${NC} All checks passed."
fi
exit 0
