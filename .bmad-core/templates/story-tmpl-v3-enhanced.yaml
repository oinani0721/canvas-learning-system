template:
  id: story-template-v3-enhanced
  name: Story Document (Enhanced with Anti-Hallucination Features)
  version: 3.0
  created: 2025-10-29
  changelog: |
    v3.0 (2025-10-29):
    - Added mandatory "Epic Context & Background" section
    - Added "Dependencies Verification" sub-section in Dev Notes
    - Added "Related Documentation" sub-section in Dev Notes
    - Enhanced AC instructions to require Epic linkage
    - Enhanced Task instructions to require Story dependency mapping
    - Added anti-hallucination guidelines throughout
    - Based on lessons from Story 10.9 UltraThink validation

  output:
    format: markdown
    filename: docs/stories/{{epic_num}}.{{story_num}}.{{story_title_short}}.md
    title: "Story {{epic_num}}.{{story_num}}: {{story_title_short}}"

workflow:
  mode: interactive
  elicitation: advanced-elicitation

agent_config:
  editable_sections:
    - Status
    - Epic Context & Background  # NEW
    - Story
    - Acceptance Criteria
    - Tasks / Subtasks
    - Dev Notes
    - Testing
    - Change Log

# ========== TEMPLATE SECTIONS ==========

sections:
  # ========== NEW SECTION: Epic Context (MANDATORY) ==========
  - id: epic-context
    title: Epic Context & Background
    type: structured-text
    required: true  # NEW: This section is mandatory
    instruction: |
      MANDATORY SECTION - Cannot skip. This section provides critical context about the parent Epic.

      Story writers MUST fill this section to:
      1. Link the story to its parent Epic
      2. Explain what problem this story solves in the Epic
      3. Clarify dependencies on other stories
      4. Prevent anti-hallucination by grounding the story in Epic requirements

      Include:
      - **æ‰€å±Epic**: EPIC-XXX - Epic Name
      - **Epicæ–‡æ¡£**: [link to epic file]
      - **æœ¬Storyåœ¨Epicä¸­çš„å®šä½**: Brief explanation of this story's role
      - **Epicæ ¸å¿ƒé—®é¢˜å›é¡¾**: What problems from the Epic does this story address?
      - **Storyä¾èµ–**: What other stories must complete before this one?

      Anti-Hallucination Check:
      âœ“ Epic document exists and is referenced
      âœ“ Problem numbers/names match Epic document
      âœ“ Story dependencies are verified to exist
    elicit: true
    owner: scrum-master
    editors: [scrum-master]
    template: |
      **æ‰€å±Epic**: EPIC-XXX - {{epic_name}}
      **Epicæ–‡æ¡£**: [{{epic_file}}](./{{epic_file}})

      **æœ¬Storyåœ¨Epicä¸­çš„å®šä½**:
      - {{story_position_in_epic}}
      - **ä¾èµ–**: {{dependent_stories}}

      **Epicæ ¸å¿ƒé—®é¢˜å›é¡¾**:

      ### ğŸ”´ Problem X: {{problem_name}}
      - **ç°è±¡**: {{problem_symptom}}
      - **æ ¹å› **: {{problem_root_cause}}
      - **ä¿®å¤**: {{this_story_fix}}
      - **æœ¬StoryéªŒè¯**: {{how_this_story_validates}}

  # ========== Status ==========
  - id: status
    title: Status
    type: choice
    choices: [Draft, Approved, InProgress, Review, Done]
    instruction: Select the current status of the story
    owner: scrum-master
    editors: [scrum-master, dev-agent]

  # ========== Story ==========
  - id: story
    title: Story
    type: template-text
    template: |
      **As a** {{role}},
      **I want** {{action}},
      **so that** {{benefit}}
    instruction: Define the user story using the standard format with role, action, and benefit
    elicit: true
    owner: scrum-master
    editors: [scrum-master]

  # ========== Acceptance Criteria (ENHANCED) ==========
  - id: acceptance-criteria
    title: Acceptance Criteria
    type: numbered-list
    instruction: |
      Copy the acceptance criteria numbered list from the epic file.

      ENHANCED REQUIREMENTS (v3.0):
      - Each AC MUST include Epic linkage (e.g., "éªŒè¯Problem 1ä¿®å¤")
      - Each AC MUST reference dependent stories if applicable
      - Each AC MUST be measurable and testable
      - Format: ### AC X: {{title}} (éªŒè¯Problem Yæˆ–Storyä¾èµ–Z)

      Example:
      ### AC 1: å®Œæ•´å­¦ä¹ æµç¨‹ç«¯åˆ°ç«¯æµ‹è¯• (éªŒè¯Problem 1+2ä¿®å¤)
      - æµ‹è¯•åœºæ™¯: ...
      - **Epicå…³è”**: ç›´æ¥éªŒè¯Problem 1å’ŒProblem 2çš„ä¿®å¤æ•ˆæœ

      ### AC 2: Canvasæ“ä½œå®Œæ•´æ€§éªŒè¯ (éªŒè¯Problem 1æ ¸å¿ƒ)
      - éªŒè¯Canvasæ–‡ä»¶æ­£ç¡®æ›´æ–°
      - **Story 10.7ä¾èµ–**: éªŒè¯CanvasIntegrationCoordinatoræ­£ç¡®å·¥ä½œ
    elicit: true
    owner: scrum-master
    editors: [scrum-master]

  # ========== Tasks / Subtasks (ENHANCED) ==========
  - id: tasks-subtasks
    title: Tasks / Subtasks
    type: bullet-list
    instruction: |
      Break down the story into specific tasks and subtasks needed for implementation.

      ENHANCED REQUIREMENTS (v3.0):
      - ALL tasks MUST reference AC numbers: (AC: X)
      - ALL tasks MUST indicate Story dependencies if applicable
      - Subtasks with test data MUST specify detailed content
      - Format: ### ä»»åŠ¡X: {{task_name}} (AC: Y, Storyä¾èµ–Z)

      Example:
      ### ä»»åŠ¡1: åˆ›å»ºç«¯åˆ°ç«¯æµ‹è¯•å¥—ä»¶ (AC: 1)
      - [ ] 1.1: åˆ›å»ºæµ‹è¯•æ–‡ä»¶ tests/test_epic10_e2e.py
      - [ ] 1.2: å®ç° test_complete_learning_workflow() æµ‹è¯•
            - Phase 1: å¯åŠ¨å­¦ä¹ ä¼šè¯ (æµ‹è¯•Story 10.8)
            - Phase 2: è¿è¡Œæ™ºèƒ½å¹¶è¡Œå¤„ç† (æµ‹è¯•Story 10.7)
      - [ ] 1.3: åˆ›å»ºæµ‹è¯•Canvasæ–‡ä»¶ (tests/fixtures/test.canvas)
            - **å†…å®¹è§„æ ¼**: åŒ…å«3ä¸ªçº¢è‰²èŠ‚ç‚¹ï¼ˆæ¨¡æ‹Ÿå¾…å­¦ä¹ é—®é¢˜ï¼‰
            - èŠ‚ç‚¹ç¤ºä¾‹: "ä»€ä¹ˆæ˜¯é€†å¦å‘½é¢˜?"ã€"å¦‚ä½•è¯æ˜å……è¦æ¡ä»¶?"
    template: |
      ### ä»»åŠ¡1: {{task_name}} (AC: X)
      - [ ] 1.1: {{subtask_description}}
      - [ ] 1.2: {{subtask_description}}

      ### ä»»åŠ¡2: {{task_name}} (AC: Y, Storyä¾èµ–Z)
      - [ ] 2.1: {{subtask_description}}
    elicit: true
    owner: scrum-master
    editors: [scrum-master, dev-agent]

  # ========== Dev Notes (ENHANCED WITH NEW SUBSECTIONS) ==========
  - id: dev-notes
    title: Dev Notes
    instruction: |
      Populate relevant information, only what was pulled from actual artifacts from docs folder, relevant to this story.

      CRITICAL ANTI-HALLUCINATION RULES (v3.0):
      - Do not invent information
      - ALL class/function references MUST be verified to exist
      - ALL file paths MUST be verified
      - ALL Story dependencies MUST be verified
      - Use [Source: file.md] annotations for all claims

      Put enough information in this section so that the dev agent should NEVER need to read the architecture documents.
    elicit: true
    owner: scrum-master
    editors: [scrum-master]
    sections:
      # NEW SUBSECTION: Dependencies Verification
      - id: dependencies-verification
        title: Dependencies Verification
        required: true  # NEW: Mandatory subsection
        instruction: |
          MANDATORY - List and verify all dependencies before implementation.

          This subsection prevents anti-hallucination by explicitly checking:
          1. All referenced classes exist
          2. All referenced functions exist
          3. All story dependencies are complete
          4. All external services are available or mocked

          Format:
          **å‰ç½®ä¾èµ–éªŒè¯** (å¿…é¡»å…ˆå®Œæˆ):
          - [ ] Story X.Yå·²å®Œæˆä¸”æµ‹è¯•é€šè¿‡ (file.py)
          - [ ] ç±»Aå·²éªŒè¯å­˜åœ¨: file_path
          - [ ] å‡½æ•°Bå·²éªŒè¯å­˜åœ¨: file_path
          - [ ] å¤–éƒ¨æœåŠ¡Cå·²é…ç½®æˆ–Mock

          Example:
          **å‰ç½®ä¾èµ–éªŒè¯**:
          - [ ] Story 10.7å•å…ƒæµ‹è¯•é€šè¿‡ (canvas_integration_coordinator.py)
          - [ ] Story 10.8å•å…ƒæµ‹è¯•é€šè¿‡ (real_service_launcher.py)
          - [ ] CanvasIntegrationCoordinatorç±»å­˜åœ¨: canvas_utils/canvas_integration_coordinator.py
          - [ ] LearningSessionWrapperç±»å­˜åœ¨: learning_session_wrapper.py
        elicit: true
        owner: scrum-master
        editors: [scrum-master]

      # EXISTING SUBSECTION: Testing Standards
      - id: testing-standards
        title: Testing Standards
        instruction: |
          List Relevant Testing Standards from Architecture the Developer needs to conform to:
          - Test file location
          - Test standards
          - Testing frameworks and patterns to use
          - Any specific testing requirements for this story

          v3.0 Enhancement:
          - Include module-level coverage targets
          - Include external service setup requirements
          - Include Mock strategy for CI environments
        elicit: true
        owner: scrum-master
        editors: [scrum-master]

      # NEW SUBSECTION: Related Documentation
      - id: related-documentation
        title: Related Documentation
        required: true  # NEW: Mandatory subsection
        instruction: |
          MANDATORY - Provide centralized documentation references.

          This subsection ensures all necessary documentation is accessible:
          1. Epic and Story documents
          2. Architecture documents
          3. Source code locations
          4. External API documentation

          Format:
          ### ğŸ”— ç›¸å…³æ–‡æ¡£å¼•ç”¨

          **Epicå’ŒStoryæ–‡æ¡£**:
          - [Epic Xæ–‡æ¡£](./epic-X.md) - EpicèƒŒæ™¯å’Œé—®é¢˜å®šä¹‰
          - [Story Yæ–‡æ¡£](./Y.story.md) - ä¾èµ–Story

          **æ¶æ„æ–‡æ¡£** [Source: docs/architecture/]:
          - [coding-standards.md](../architecture/coding-standards.md) - ç¼–ç æ ‡å‡†
          - [tech-stack.md](../architecture/tech-stack.md) - æŠ€æœ¯æ ˆ

          **æºä»£ç ä½ç½®**:
          - module_name.py - æ¨¡å—è¯´æ˜
          - class_name - ç±»ä½ç½®
        elicit: true
        owner: scrum-master
        editors: [scrum-master]

  # ========== Change Log ==========
  - id: change-log
    title: Change Log
    type: table
    columns: [Date, Version, Description, Author]
    instruction: |
      Track changes made to this story document.

      v3.0 Enhancement: Include fix type for major revisions
      - v1.0: Initial creation
      - v2.0: UltraThinkä¿®å¤ - Brief description of what was fixed
    owner: scrum-master
    editors: [scrum-master, dev-agent, qa-agent]

  # ========== Dev Agent Record ==========
  - id: dev-agent-record
    title: Dev Agent Record
    instruction: This section is populated by the development agent during implementation
    owner: dev-agent
    editors: [dev-agent]
    sections:
      - id: agent-model
        title: Agent Model Used
        template: "{{agent_model_name_version}}"
        instruction: Record the specific AI agent model and version used for development
        owner: dev-agent
        editors: [dev-agent]

      - id: debug-log-references
        title: Debug Log References
        instruction: Reference any debug logs or traces generated during development
        owner: dev-agent
        editors: [dev-agent]

      - id: completion-notes
        title: Completion Notes List
        instruction: Notes about the completion of tasks and any issues encountered
        owner: dev-agent
        editors: [dev-agent]

      - id: file-list
        title: File List
        instruction: List all files created, modified, or affected during story implementation
        owner: dev-agent
        editors: [dev-agent]

  # ========== QA Results ==========
  - id: qa-results
    title: QA Results
    instruction: Results from QA Agent QA review of the completed story implementation
    owner: qa-agent
    editors: [qa-agent]

# ========== VALIDATION RULES (NEW) ==========
validation:
  required_sections:
    - epic-context  # NEW: Mandatory section
    - status
    - story
    - acceptance-criteria
    - tasks-subtasks
    - dev-notes
    - change-log

  anti_hallucination_checks:
    - name: "Epic Document Exists"
      check: "Epic file referenced in epic-context section exists"
      severity: critical

    - name: "Story Dependencies Verified"
      check: "All dependent stories mentioned exist and are marked Done/InProgress"
      severity: critical

    - name: "Class References Verified"
      check: "All class names mentioned in Dev Notes exist in codebase"
      severity: critical

    - name: "File Paths Verified"
      check: "All file paths mentioned are valid"
      severity: high

    - name: "Source Annotations Present"
      check: "Dev Notes includes [Source: ...] annotations for technical claims"
      severity: medium

  quality_checks:
    - name: "AC-Epic Linkage"
      check: "All ACs reference Epic problems or Story dependencies"
      severity: high

    - name: "Task-AC Mapping"
      check: "All tasks reference AC numbers"
      severity: high

    - name: "Test Data Specification"
      check: "Tasks with test data include detailed content specifications"
      severity: medium

    - name: "External Dependencies Documented"
      check: "Dev Notes includes setup instructions for external services"
      severity: medium

# ========== USAGE GUIDELINES (NEW) ==========
usage_guidelines: |
  ## Story Template v3.0 - Usage Guidelines

  ### Key Enhancements from v2.0

  1. **Mandatory Epic Context Section**
     - ALWAYS start with Epic Context & Background
     - Link to parent Epic document
     - Explain this story's role in Epic
     - Review Epic problems addressed

  2. **Enhanced Anti-Hallucination Features**
     - Dependencies Verification subsection (mandatory)
     - All class/function references must be verified
     - All Story dependencies must be verified
     - Use [Source: file.md] annotations

  3. **Related Documentation Section**
     - Centralized documentation references
     - Epic, Story, and Architecture doc links
     - Source code location mapping

  4. **Enhanced AC and Task Requirements**
     - ACs must link to Epic problems
     - Tasks must reference AC numbers
     - Tasks must indicate Story dependencies
     - Test data must be detailed

  ### When to Use This Template

  - Use for ALL new stories going forward
  - Consider upgrading existing stories if:
    - Story validation fails
    - Story has anti-hallucination issues
    - Story lacks Epic context

  ### How to Validate Stories

  Run validation checklist:
  1. âœ“ Epic Context section exists and complete
  2. âœ“ Epic document referenced exists
  3. âœ“ All Story dependencies verified
  4. âœ“ All class references verified to exist
  5. âœ“ Dependencies Verification subsection complete
  6. âœ“ Related Documentation subsection complete
  7. âœ“ All ACs link to Epic problems
  8. âœ“ All tasks reference AC numbers

  ### Migration from v2.0 to v3.0

  If migrating existing story:
  1. Add "Epic Context & Background" section at top
  2. Add "Dependencies Verification" in Dev Notes
  3. Add "Related Documentation" in Dev Notes
  4. Enhance ACs with Epic linkage
  5. Enhance Tasks with AC and Story dependency references
  6. Update Change Log to v2.0 with migration note

# ========== BEST PRACTICES (NEW) ==========
best_practices:
  - title: "Epic-First Approach"
    description: "Always read and understand the Epic before writing the Story"

  - title: "Verify Before Write"
    description: "Search codebase to verify all class/function references exist"

  - title: "Dependencies First"
    description: "Complete Dependencies Verification subsection before writing tasks"

  - title: "Test Data Details"
    description: "Always specify exact content for test data, not just 'create test file'"

  - title: "Source Attribution"
    description: "Use [Source: file.md] for all technical claims in Dev Notes"

  - title: "Story Dependency Mapping"
    description: "Explicitly map task/AC dependencies to other stories"

  - title: "External Service Documentation"
    description: "Document external service setup and Mock strategies"

  - title: "Iterative Refinement"
    description: "Use Change Log v2.0+ for UltraThink fixes and major revisions"
