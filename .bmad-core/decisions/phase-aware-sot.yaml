# ══════════════════════════════════════════════════════════════════════════════
# Phase-Aware Source of Truth Configuration
# ══════════════════════════════════════════════════════════════════════════════
# Purpose: Define which Source of Truth has priority based on BMad phase
# Usage: Agents consult this file to determine SoT priority during conflicts
# Reference: docs/architecture/sot-hierarchy.md
# ══════════════════════════════════════════════════════════════════════════════

version: "1.0.0"
last_updated: "2025-11-25"

# ══════════════════════════════════════════════════════════════════════════════
# Phase Detection Rules
# ══════════════════════════════════════════════════════════════════════════════
phase_detection:
  rules:
    - condition: "src/ directory is empty OR has no .py/.ts files"
      result: "Phase 2 (Planning)"
      confidence: "High"

    - condition: "src/ has implementation code files with tests passing"
      result: "Phase 4 (Implementation)"
      confidence: "High"

    - condition: "OpenAPI spec exists but no FastAPI/backend code"
      result: "Phase 2/3 (Transition)"
      confidence: "Medium"

    - condition: "User explicitly states current phase"
      result: "Use user statement"
      confidence: "Explicit"

  fallback: "Phase 2"  # Default to PRD-first when uncertain

# ══════════════════════════════════════════════════════════════════════════════
# SoT Priority by Phase
# ══════════════════════════════════════════════════════════════════════════════
sot_priority:
  phase2_planning:
    name: "PRD-First"
    description: |
      During Planning phase, PRD captures business intent and requirements.
      Specifications are still being refined and may not be complete.
      PRD is the authoritative source for what the system should do.

    hierarchy:
      1: "PRD"
      2: "Architecture"
      3: "JSON Schema"
      4: "OpenAPI Spec"
      5: "Story"
      6: "Code"

    conflict_resolution:
      PRD_vs_Schema: "PRD wins, update Schema"
      PRD_vs_OpenAPI: "PRD wins, update OpenAPI"
      Architecture_vs_Schema: "Architecture wins, update Schema"
      Schema_vs_OpenAPI: "Schema wins, update OpenAPI"

  phase4_implementation:
    name: "Specs-First"
    description: |
      During Implementation phase, Specs are finalized contracts.
      Code must comply with OpenAPI and JSON Schema definitions.
      PRD may be outdated - specs represent finalized technical decisions.

    hierarchy:
      1: "OpenAPI Spec"
      2: "JSON Schema"
      3: "Architecture"
      4: "PRD"
      5: "Story"
      6: "Code"

    conflict_resolution:
      Story_vs_OpenAPI: "OpenAPI wins, Story may be outdated"
      Story_vs_Schema: "Schema wins, Story may be outdated"
      PRD_vs_OpenAPI: "OpenAPI wins, PRD outdated (may need ADR)"
      PRD_vs_Schema: "Schema wins, PRD outdated (may need ADR)"

# ══════════════════════════════════════════════════════════════════════════════
# Conflict Handling Options
# ══════════════════════════════════════════════════════════════════════════════
conflict_options:
  A:
    label: "Accept SoT hierarchy recommendation"
    action: "Update lower-level document to match higher-level"
    adr_required: false
    blocks_story: false

  B:
    label: "Override with justification"
    action: "Higher-level document is wrong, requires ADR creation"
    adr_required: true
    blocks_story: false

  C:
    label: "Modify both documents"
    action: "Both need changes, specify what changes in each"
    adr_required: false
    blocks_story: false

  D:
    label: "Defer decision"
    action: "Add to tech debt, Story remains DRAFT"
    adr_required: false
    blocks_story: true

# ══════════════════════════════════════════════════════════════════════════════
# ADR Fast Track for Phase 4
# ══════════════════════════════════════════════════════════════════════════════
adr_fast_track:
  description: |
    When Spec errors are found in Phase 4 (e.g., OpenAPI missing endpoint that PRD requires),
    use ADR Fast Track to continue development while documenting the deviation.

  trigger: "Option B selected OR Spec error blocking implementation"

  process:
    1: "Create ADR documenting the deviation"
    2: "ADR title format: ADR-NNN-SPEC-DEVIATION-[topic]"
    3: "Record in conflict-resolutions.yaml"
    4: "Continue development per higher-authority source"
    5: "Add to Planning iteration backlog for next cycle"

  adr_template: |
    # ADR-NNN: Specification Deviation - [Topic]

    ## Status
    Accepted (Fast Track)

    ## Context
    During Phase 4 implementation of [Story], a specification error was detected:
    - Spec document: [path]
    - Issue: [description]
    - PRD requirement: [reference]

    ## Decision
    Proceed with implementation per [higher authority source].
    Spec update deferred to next Planning iteration.

    ## Consequences
    - Development continues
    - Spec out of sync until next Planning iteration
    - Risk: [any risks]

    ## Sync Plan
    - Planning iteration: [next iteration number]
    - Update: [what to update]

# ══════════════════════════════════════════════════════════════════════════════
# Current Project Phase (Auto-detected or manually set)
# ══════════════════════════════════════════════════════════════════════════════
current_phase:
  detected: null  # Auto-filled by validation scripts
  override: null  # User can set explicitly
  effective: null  # Actual phase used (override > detected)
  last_check: null  # Timestamp of last detection
